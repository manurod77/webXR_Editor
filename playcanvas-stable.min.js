var e,t;e=this,t=function(e){let t,s,i,n,r,a,o,l,h,d,c,u,p,f,m,_,g,v;var y,S,x,T="undefined"!=typeof document?document.currentScript:null;function b(e,t,s){e.prototype[t]||Object.defineProperty(e.prototype,t,{value:s,configurable:true,enumerable:false,writable:true});}for(let e of(b(Array,"fill",function(e){if(this==null)throw TypeError("this is null or not defined");for(var t=Object(this),s=t.length>>>0,i=arguments[1],n=i>>0,r=n<0?Math.max(s+n,0):Math.min(n,s),a=arguments[2],o=void 0===a?s:a>>0,l=o<0?Math.max(s+o,0):Math.min(o,s);r<l;)t[r]=e,r++;return t}),b(Array,"find",function(e){if(this==null)throw TypeError('"this" is null or not defined');var t=Object(this),s=t.length>>>0;if("function"!=typeof e)throw TypeError("predicate must be a function");for(var i=arguments[1],n=0;n<s;){var r=t[n];if(e.call(i,r,n,t))return r;n++;}}),b(Array,"findIndex",function(e){if(this==null)throw TypeError('"this" is null or not defined');var t=Object(this),s=t.length>>>0;if("function"!=typeof e)throw TypeError("predicate must be a function");for(var i=arguments[1],n=0;n<s;){var r=t[n];if(e.call(i,r,n,t))return n;n++;}return -1}),Math.log2=Math.log2||function(e){return Math.log(e)*Math.LOG2E},Math.sign||(Math.sign=function(e){return (e>0)-(e<0)||+e}),void 0===Number.isFinite&&(Number.isFinite=function(e){return "number"==typeof e&&isFinite(e)}),"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(e,t){if(null==e)throw TypeError("Cannot convert undefined or null to object");for(var s=Object(e),i=1;i<arguments.length;i++){var n=arguments[i];if(null!=n)for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(s[r]=n[r]);}return s},writable:true,configurable:true}),Object.fromEntries=Object.fromEntries||function(e){if(!e||!e[Symbol.iterator])throw Error("Object.fromEntries() requires a single iterable argument");for(var t={},s=0;s<e.length;s++)t[e[s][0]]=e[s][1];return t},Object.entries=Object.entries||function(e){for(var t=Object.keys(e),s=t.length,i=Array(s);s--;)i[s]=[t[s],e[t[s]]];return i},Object.values=Object.values||function(e){return Object.keys(e).map(t=>e[t])},function(){if("undefined"!=typeof navigator&&"undefined"!=typeof document){navigator.pointer=navigator.pointer||navigator.webkitPointer||navigator.mozPointer;var e=function(){var e=document.createEvent("CustomEvent");e.initCustomEvent("pointerlockchange",true,false,null),document.dispatchEvent(e);},t=function(){var e=document.createEvent("CustomEvent");e.initCustomEvent("pointerlockerror",true,false,null),document.dispatchEvent(e);};document.addEventListener("webkitpointerlockchange",e,false),document.addEventListener("webkitpointerlocklost",e,false),document.addEventListener("mozpointerlockchange",e,false),document.addEventListener("mozpointerlocklost",e,false),document.addEventListener("webkitpointerlockerror",t,false),document.addEventListener("mozpointerlockerror",t,false),Element.prototype.mozRequestPointerLock?Element.prototype.requestPointerLock=function(){this.mozRequestPointerLock();}:Element.prototype.requestPointerLock=Element.prototype.requestPointerLock||Element.prototype.webkitRequestPointerLock||Element.prototype.mozRequestPointerLock,!Element.prototype.requestPointerLock&&navigator.pointer&&(Element.prototype.requestPointerLock=function(){document.pointerLockElement=this,navigator.pointer.lock(this,e,t);}),document.exitPointerLock=document.exitPointerLock||document.webkitExitPointerLock||document.mozExitPointerLock,document.exitPointerLock||(document.exitPointerLock=function(){navigator.pointer&&(document.pointerLockElement=null,navigator.pointer.unlock());});}}(),b(String,"endsWith",function(e,t){return (void 0===t||t>this.length)&&(t=this.length),this.substring(t-e.length,t)===e}),b(String,"includes",function(e,t){return "number"!=typeof t&&(t=0),!(t+e.length>this.length)&&-1!==this.indexOf(e,t)}),b(String,"startsWith",function(e,t){var s=t>0?0|t:0;return this.substring(s,s+e.length)===e}),b(String,"trimEnd",function(){return this.replace(RegExp(/[\x09\x0A\x0B\x0C\x0D\x20\xA0\u1680\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200A\u202F\u205F\u3000\u2028\u2029\uFEFF]+/.source+"$","g"),"")}),[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array]))b(e,"fill",Array.prototype.fill),b(e,"join",Array.prototype.join);let E="GpuTimings",A="2.7.3",w="03a9f12";function C(e,t){for(let s in t){let i=t[s];Array.isArray(i)?e[s]=C([],i):i&&"object"==typeof i?e[s]=C({},i):e[s]=i;}return e}let P={create:()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=16*Math.random()|0;return ("x"===e?t:3&t|8).toString(16)})},M={delimiter:"/",join(){for(var e=arguments.length,t=Array(e),s=0;s<e;s++)t[s]=arguments[s];let i=t[0];for(let e=0;e<t.length-1;e++){let s=t[e],n=t[e+1];if(n[0]===M.delimiter){i=n;continue}s&&n&&s[s.length-1]!==M.delimiter&&n[0]!==M.delimiter?i+=M.delimiter+n:i+=n;}return i},normalize(e){let t=e.startsWith(M.delimiter),s=e.endsWith(M.delimiter),i=e.split("/"),n="",r=[];for(let e=0;e<i.length;e++)if(""!==i[e]&&"."!==i[e]){if(".."===i[e]&&r.length>0){r=r.slice(0,r.length-2);continue}e>0&&r.push(M.delimiter),r.push(i[e]);}return n=r.join(""),t||n[0]!==M.delimiter||(n=n.slice(1)),s&&n[n.length-1]!==M.delimiter&&(n+=M.delimiter),n},split(e){let t=e.lastIndexOf(M.delimiter);return -1!==t?[e.substring(0,t),e.substring(t+1)]:["",e]},getBasename:e=>M.split(e)[1],getDirectory:e=>M.split(e)[0],getExtension(e){let t=e.split("?")[0].split(".").pop();return t!==e?"."+t:""},isRelativePath:e=>"/"!==e.charAt(0)&&null===e.match(/:\/\//),extractPath(e){let t="",s=e.split("/"),i=0;if(s.length>1){if(M.isRelativePath(e)){if("."===s[0])for(i=0;i<s.length-1;++i)t+=0===i?s[i]:"/"+s[i];else if(".."===s[0])for(i=0;i<s.length-1;++i)t+=0===i?s[i]:"/"+s[i];else for(i=0,t=".";i<s.length-1;++i)t+="/"+s[i];}else for(i=0;i<s.length-1;++i)t+=0===i?s[i]:"/"+s[i];}return t}},I="undefined"!=typeof navigator?navigator.userAgent:"",R="undefined"!=typeof window?"browser":"undefined"!=typeof global?"node":"worker",L=/android/i.test(I)?"android":/ip(?:[ao]d|hone)/i.test(I)?"ios":/windows/i.test(I)?"windows":/mac os/i.test(I)?"osx":/linux/i.test(I)?"linux":/cros/i.test(I)?"cros":null,D="browser"!==R?null:/Chrome\/|Chromium\/|Edg.*\//.test(I)?"chrome":/Safari\//.test(I)?"safari":/Firefox\//.test(I)?"firefox":"other",O=/xbox/i.test(I),F="browser"===R&&("ontouchstart"in window||"maxTouchPoints"in navigator&&navigator.maxTouchPoints>0),N="browser"===R&&(!!navigator.getGamepads||!!navigator.webkitGetGamepads),B="undefined"!=typeof Worker,U=(()=>{let e=false;try{let t=Object.defineProperty({},"passive",{get:function(){return e=!0,!1}});window.addEventListener("testpassive",null,t),window.removeEventListener("testpassive",null,t);}catch(e){}return e})(),k={name:L,environment:R,global:null!=(x=null!=(S=null!=(y="undefined"!=typeof globalThis&&globalThis)?y:"browser"===R&&window)?S:"node"===R&&global)?x:"worker"===R&&self,browser:"browser"===R,worker:"worker"===R,desktop:["windows","osx","linux","cros"].includes(L),mobile:["android","ios"].includes(L),ios:"ios"===L,android:"android"===L,xbox:O,gamepads:N,touch:F,workers:B,passiveEvents:U,browserName:D},z="abcdefghijklmnopqrstuvwxyz",V="ABCDEFGHIJKLMNOPQRSTUVWXYZ";function G(e,t){ void 0===t&&(t=0);let s=e.length;if(t<0||t>=s)return null;let i=e.charCodeAt(t);if(s>1&&i>=55296&&i<=56319){let s=e.charCodeAt(t+1);if(s>=56320&&s<=57343)return {code:(i-55296)*1024+s-56320+65536,long:true}}return {code:i,long:false}}function H(e,t,s){if(!e)return  false;let i=G(e);if(i){let e=i.code;return e>=t&&e<=s}return  false}let W={ASCII_LOWERCASE:z,ASCII_UPPERCASE:V,ASCII_LETTERS:z+V,format(e){for(var t=arguments.length,s=Array(t>1?t-1:0),i=1;i<t;i++)s[i-1]=arguments[i];for(let t=0;t<s.length;t++)e=e.replace("{"+t+"}",s[t]);return e},getCodePoint(e,t){let s=G(e,t);return s&&s.code},getCodePoints(e){let t;if("string"!=typeof e)throw TypeError("Not a string");let s=0,i=[];for(;t=G(e,s);)i.push(t.code),s+=t.long?2:1;return i},getSymbols(e){let t;if("string"!=typeof e)throw TypeError("Not a string");let s=0,i=e.length,n=[],r=0;for(;s<i;){if(r+=function(e,t){if(t===e.length-1)return 1;if(H(e[t],55296,56319)){let s=e.substring(t,t+2),i=e.substring(t+2,t+4);return H(i,127995,127999)||H(s,127462,127487)&&H(i,127462,127487)?4:H(i,65024,65039)?3:2}return H(e[t+1],65024,65039)?2:1}(e,s+r),H(t=e[s+r],8400,8447)&&(t=e[s+r++]),H(t,65024,65039)&&(t=e[s+r++]),t&&8205===t.charCodeAt(0)){t=e[s+r++];continue}let i=e.substring(s,s+r);n.push(i),s+=r,r=0;}return n},fromCodePoint(){let e,t,s;let i=[];for(let n=0;n<arguments.length;++n)e=Number(arguments[n]),t=e-65536,s=e>65535?[(t>>10)+55296,t%1024+56320]:[e],i.push(String.fromCharCode.apply(null,s));return i.join("")}};class X{off(){this._removed||this.handler.offByHandle(this);}on(e,t,s){return void 0===s&&(s=this),this.handler._addCallback(e,t,s,false)}once(e,t,s){return void 0===s&&(s=this),this.handler._addCallback(e,t,s,true)}set removed(e){e&&(this._removed=true);}get removed(){return this._removed}constructor(e,t,s,i,n=false){this._removed=false,this.handler=e,this.name=t,this.callback=s,this.scope=i,this._once=n;}}class Y{initEventHandler(){this._callbacks=new Map,this._callbackActive=new Map;}_addCallback(e,t,s,i){if(this._callbacks.has(e)||this._callbacks.set(e,[]),this._callbackActive.has(e)){let t=this._callbackActive.get(e);t&&t===this._callbacks.get(e)&&this._callbackActive.set(e,t.slice());}let n=new X(this,e,t,s,i);return this._callbacks.get(e).push(n),n}on(e,t,s){return void 0===s&&(s=this),this._addCallback(e,t,s,false)}once(e,t,s){return void 0===s&&(s=this),this._addCallback(e,t,s,true)}off(e,t,s){if(e)this._callbackActive.has(e)&&this._callbackActive.get(e)===this._callbacks.get(e)&&this._callbackActive.set(e,this._callbackActive.get(e).slice());else for(let[e,t]of this._callbackActive)this._callbacks.has(e)&&this._callbacks.get(e)===t&&this._callbackActive.set(e,t.slice());if(e){if(t){let i=this._callbacks.get(e);if(!i)return this;for(let e=0;e<i.length;e++)i[e].callback===t&&(!s||i[e].scope===s)&&(i[e].removed=true,i.splice(e,1),e--);0===i.length&&this._callbacks.delete(e);}else {let t=this._callbacks.get(e);if(t){for(let e=0;e<t.length;e++)t[e].removed=true;this._callbacks.delete(e);}}}else {for(let e of this._callbacks.values())for(let t=0;t<e.length;t++)e[t].removed=true;this._callbacks.clear();}return this}offByHandle(e){let t=e.name;e.removed=true,this._callbackActive.has(t)&&this._callbackActive.get(t)===this._callbacks.get(t)&&this._callbackActive.set(t,this._callbackActive.get(t).slice());let s=this._callbacks.get(t);if(!s)return this;let i=s.indexOf(e);return -1!==i&&(s.splice(i,1),0===s.length&&this._callbacks.delete(t)),this}fire(e,t,s,i,n,r,a,o,l){let h;if(!e)return this;let d=this._callbacks.get(e);if(!d)return this;this._callbackActive.has(e)?this._callbackActive.get(e)!==d&&(h=d.slice()):this._callbackActive.set(e,d);for(let d=0;(h||this._callbackActive.get(e))&&d<(h||this._callbackActive.get(e)).length;d++){let c=(h||this._callbackActive.get(e))[d];if(c.callback&&(c.callback.call(c.scope,t,s,i,n,r,a,o,l),c._once)){let t=this._callbacks.get(e),s=t?t.indexOf(c):-1;if(-1!==s){this._callbackActive.get(e)===t&&this._callbackActive.set(e,this._callbackActive.get(e).slice());let i=this._callbacks.get(e);if(!i)continue;i[s].removed=true,i.splice(s,1),0===i.length&&this._callbacks.delete(e);}}}return h||this._callbackActive.delete(e),this}hasEvent(e){var t;return !!(null==(t=this._callbacks.get(e))?void 0:t.length)}constructor(){this._callbacks=new Map,this._callbackActive=new Map;}}class j{push(e,t){if(this._index[e])throw Error("Key already in index "+e);let s=this._list.push(t)-1;this._index[e]=s;}has(e){return void 0!==this._index[e]}get(e){let t=this._index[e];return void 0!==t?this._list[t]:null}remove(e){let t=this._index[e];if(void 0!==t){for(e in this._list.splice(t,1),delete this._index[e],this._index){let s=this._index[e];s>t&&(this._index[e]=s-1);}return  true}return  false}list(){return this._list}clear(){for(let e in this._list.length=0,this._index)delete this._index[e];}constructor(){this._list=[],this._index={};}}class q{static loadScript(e,t){let s=document.createElement("script");s.setAttribute("src",e),s.onload=()=>{t(null);},s.onerror=()=>{t("Failed to load script='"+e+"'");},document.body.appendChild(s);}static loadWasm(e,t,s){let i=q.wasmSupported()&&t.glueUrl&&t.wasmUrl?t.glueUrl:t.fallbackUrl;i?q.loadScript(i,i=>{if(i)s(i,null);else {let i=window[e];window[e]=void 0,i({locateFile:()=>t.wasmUrl,onAbort:()=>{s("wasm module aborted.");}}).then(e=>{s(null,e);});}}):s("No supported wasm modules found.",null);}static getModule(e){return q.modules.hasOwnProperty(e)||(q.modules[e]={config:null,initializing:false,instance:null,callbacks:[]}),q.modules[e]}static initialize(e,t){if(t.initializing)return;let s=t.config;(s.glueUrl||s.wasmUrl||s.fallbackUrl)&&(t.initializing=true,q.loadWasm(e,s,(e,i)=>{e?s.errorHandler&&s.errorHandler(e):(t.instance=i,t.callbacks.forEach(e=>{e(i);}));}));}}q.modules={},q.wasmSupported=(e=>{let t={},s=t;return ()=>(s===t&&(s=e()),s)})(()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){let e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){}return  false});class K{static setConfig(e,t){let s=q.getModule(e);s.config=t,s.callbacks.length>0&&q.initialize(e,s);}static getConfig(e){var t,s;return null==(s=q.modules)?void 0:null==(t=s[e])?void 0:t.config}static getInstance(e,t){let s=q.getModule(e);s.instance?t(s.instance):(s.callbacks.push(t),s.config&&q.initialize(e,s));}}class Z{get remainingBytes(){return this.dataView.byteLength-this.offset}reset(e){ void 0===e&&(e=0),this.offset=e;}skip(e){this.offset+=e;}align(e){this.offset=this.offset+e-1&~(e-1);}_inc(e){return this.offset+=e,this.offset-e}readChar(){return String.fromCharCode(this.dataView.getUint8(this.offset++))}readChars(e){let t="";for(let s=0;s<e;++s)t+=this.readChar();return t}readU8(){return this.dataView.getUint8(this.offset++)}readU16(){return this.dataView.getUint16(this._inc(2),true)}readU32(){return this.dataView.getUint32(this._inc(4),true)}readU64(){return this.readU32()+0x100000000*this.readU32()}readU32be(){return this.dataView.getUint32(this._inc(4),false)}readArray(e){for(let t=0;t<e.length;++t)e[t]=this.readU8();}readLine(){let e=this.dataView,t="";for(;!(this.offset>=e.byteLength);){let e=String.fromCharCode(this.readU8());if("\n"===e)break;t+=e;}return t}constructor(e){this.offset=0,this.arraybuffer=e,this.dataView=new DataView(e);}}class Q{_binarySearch(e){let t,s,i=0,n=this.items.length-1,r=e[this._sortBy];for(;i<=n;)t=Math.floor((i+n)/2),(s=this.items[t][this._sortBy])<=r?i=t+1:s>r&&(n=t-1);return i}_doSort(e,t){let s=this._sortBy;return e[s]-t[s]}insert(e){let t=this._binarySearch(e);this.items.splice(t,0,e),this.length++,this.loopIndex>=t&&this.loopIndex++;}append(e){this.items.push(e),this.length++;}remove(e){let t=this.items.indexOf(e);!(t<0)&&(this.items.splice(t,1),this.length--,this.loopIndex>=t&&this.loopIndex--);}sort(){let e=this.loopIndex>=0?this.items[this.loopIndex]:null;this.items.sort(this._sortHandler),null!==e&&(this.loopIndex=this.items.indexOf(e));}constructor(e){this.items=[],this.length=0,this.loopIndex=-1,this._sortBy=e.sortBy,this._sortHandler=this._doSort.bind(this);}}class J extends Y{add(){for(var e=arguments.length,t=Array(e),s=0;s<e;s++)t[s]=arguments[s];let i=false,n=this._processArguments(t,true);if(!n.length)return i;for(let e=0;e<n.length;e++)!this._index[n[e]]&&(i=true,this._index[n[e]]=true,this._list.push(n[e]),this.fire("add",n[e],this._parent));return i&&this.fire("change",this._parent),i}remove(){for(var e=arguments.length,t=Array(e),s=0;s<e;s++)t[s]=arguments[s];let i=false;if(!this._list.length)return i;let n=this._processArguments(t,true);if(!n.length)return i;for(let e=0;e<n.length;e++)this._index[n[e]]&&(i=true,delete this._index[n[e]],this._list.splice(this._list.indexOf(n[e]),1),this.fire("remove",n[e],this._parent));return i&&this.fire("change",this._parent),i}clear(){if(!this._list.length)return;let e=this._list.slice(0);this._list=[],this._index={};for(let t=0;t<e.length;t++)this.fire("remove",e[t],this._parent);this.fire("change",this._parent);}has(){for(var e=arguments.length,t=Array(e),s=0;s<e;s++)t[s]=arguments[s];return !!this._list.length&&this._has(this._processArguments(t))}_has(e){if(!this._list.length||!e.length)return  false;for(let t=0;t<e.length;t++)if(1===e[t].length){if(this._index[e[t][0]])return  true}else {let s=true;for(let i=0;i<e[t].length;i++)if(!this._index[e[t][i]]){s=false;break}if(s)return  true}return  false}list(){return this._list.slice(0)}_processArguments(e,t){let s=[],i=[];if(!e||!e.length)return s;for(let n=0;n<e.length;n++)if(e[n]instanceof Array){t||(i=[]);for(let r=0;r<e[n].length;r++)"string"==typeof e[n][r]&&(t?s.push(e[n][r]):i.push(e[n][r]));!t&&i.length&&s.push(i);}else "string"==typeof e[n]&&(t?s.push(e[n]):s.push([e[n]]));return s}get size(){return this._list.length}constructor(e){super(),this._index={},this._list=[],this._parent=e;}}J.EVENT_ADD="add",J.EVENT_REMOVE="remove",J.EVENT_CHANGE="change";let $="undefined"!=typeof window&&window.performance&&window.performance.now?performance.now.bind(performance):Date.now,ee=/^(([^:/?#]+):)?(\/\/([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/;class et{toString(){let e="";return this.scheme&&(e+=""+this.scheme+":"),this.authority&&(e+="//"+this.authority),e+=this.path,this.query&&(e+="?"+this.query),this.fragment&&(e+="#"+this.fragment),e}getQuery(){let e={};if(this.query)for(let t of decodeURIComponent(this.query).split("&")){let s=t.split("=");e[s[0]]=s[1];}return e}setQuery(e){let t="";for(let s in e)e.hasOwnProperty(s)&&(""!==t&&(t+="&"),t+=encodeURIComponent(s)+"="+encodeURIComponent(e[s]));this.query=t;}constructor(e){let t=e.match(ee);this.scheme=t[2],this.authority=t[4],this.path=t[5],this.query=t[7],this.fragment=t[9];}}class es{static set(e,t){}static get(e){return es._traceChannels.has(e)}}es._traceChannels=new Set,es.stack=false;let ei={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,clamp:(e,t,s)=>e>=s?s:e<=t?t:e,intToBytes24:e=>[e>>16&255,e>>8&255,255&e],intToBytes32:e=>[e>>24&255,e>>16&255,e>>8&255,255&e],bytesToInt24:(e,t,s)=>(e.length&&(s=e[2],t=e[1],e=e[0]),e<<16|t<<8|s),bytesToInt32:(e,t,s,i)=>(e.length&&(i=e[3],s=e[2],t=e[1],e=e[0]),(e<<24|t<<16|s<<8|i)>>>0),lerp:(e,t,s)=>e+(t-e)*ei.clamp(s,0,1),lerpAngle:(e,t,s)=>(t-e>180&&(t-=360),t-e<-180&&(t+=360),ei.lerp(e,t,ei.clamp(s,0,1))),powerOfTwo:e=>0!==e&&!(e&e-1),nextPowerOfTwo:e=>(e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e),nearestPowerOfTwo:e=>Math.pow(2,Math.round(Math.log(e)/Math.log(2))),random:(e,t)=>Math.random()*(t-e)+e,smoothstep:(e,t,s)=>s<=e?0:s>=t?1:(s=(s-e)/(t-e))*s*(3-2*s),smootherstep:(e,t,s)=>s<=e?0:s>=t?1:(s=(s-e)/(t-e))*s*s*(s*(6*s-15)+10),roundUp:(e,t)=>0===t?e:Math.ceil(e/t)*t,between(e,t,s,i){let n=Math.min(t,s),r=Math.max(t,s);return i?e>=n&&e<=r:e>n&&e<r}};class en{clone(){return new this.constructor(this.r,this.g,this.b,this.a)}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this}equals(e){return this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}set(e,t,s,i){return void 0===i&&(i=1),this.r=e,this.g=t,this.b=s,this.a=i,this}lerp(e,t,s){return this.r=e.r+s*(t.r-e.r),this.g=e.g+s*(t.g-e.g),this.b=e.b+s*(t.b-e.b),this.a=e.a+s*(t.a-e.a),this}linear(e){return void 0===e&&(e=this),this.r=Math.pow(e.r,2.2),this.g=Math.pow(e.g,2.2),this.b=Math.pow(e.b,2.2),this.a=e.a,this}gamma(e){return void 0===e&&(e=this),this.r=Math.pow(e.r,1/2.2),this.g=Math.pow(e.g,1/2.2),this.b=Math.pow(e.b,1/2.2),this.a=e.a,this}mulScalar(e){return this.r*=e,this.g*=e,this.b*=e,this}fromString(e){let t;let s=parseInt(e.replace("#","0x"),16);return e.length>7?t=ei.intToBytes32(s):(t=ei.intToBytes24(s))[3]=255,this.set(t[0]/255,t[1]/255,t[2]/255,t[3]/255),this}fromArray(e,t){var s,i,n,r;return void 0===t&&(t=0),this.r=null!=(s=e[t])?s:this.r,this.g=null!=(i=e[t+1])?i:this.g,this.b=null!=(n=e[t+2])?n:this.b,this.a=null!=(r=e[t+3])?r:this.a,this}toString(e,t){let{r:s,g:i,b:n,a:r}=this;if(t||s>1||i>1||n>1)return s.toFixed(3)+", "+i.toFixed(3)+", "+n.toFixed(3)+", "+r.toFixed(3);let a="#"+(0x1000000+(Math.round(255*s)<<16)+(Math.round(255*i)<<8)+Math.round(255*n)).toString(16).slice(1);if(true===e){let e=Math.round(255*r).toString(16);this.a<16/255?a+="0"+e:a+=e;}return a}toArray(e,t,s){return void 0===e&&(e=[]),void 0===t&&(t=0),void 0===s&&(s=true),e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,s&&(e[t+3]=this.a),e}constructor(e=0,t=0,s=0,i=1){let n=e.length;if(3===n||4===n){var r;this.r=e[0],this.g=e[1],this.b=e[2],this.a=null!=(r=e[3])?r:1;}else this.r=e,this.g=t,this.b=s,this.a=i;}}en.BLACK=Object.freeze(new en(0,0,0,1)),en.BLUE=Object.freeze(new en(0,0,1,1)),en.CYAN=Object.freeze(new en(0,1,1,1)),en.GRAY=Object.freeze(new en(.5,.5,.5,1)),en.GREEN=Object.freeze(new en(0,1,0,1)),en.MAGENTA=Object.freeze(new en(1,0,1,1)),en.RED=Object.freeze(new en(1,0,0,1)),en.WHITE=Object.freeze(new en(1,1,1,1)),en.YELLOW=Object.freeze(new en(1,1,0,1));class er{evaluate(e,t){let s;void 0===t&&(t=false),(t||e<this._left||e>=this._right)&&this._reset(e);let i=this._curve.type;if(5===i)s=this._p0;else {let t=0===this._recip?0:(e-this._left)*this._recip;s=0===i?ei.lerp(this._p0,this._p1,t):1===i?ei.lerp(this._p0,this._p1,t*t*(3-2*t)):this._evaluateHermite(this._p0,this._p1,this._m0,this._m1,t);}return s}_reset(e){let t=this._curve.keys,s=t.length;if(s){if(e<t[0][0])this._left=-1/0,this._right=t[0][0],this._recip=0,this._p0=this._p1=t[0][1],this._m0=this._m1=0;else if(e>=t[s-1][0])this._left=t[s-1][0],this._right=1/0,this._recip=0,this._p0=this._p1=t[s-1][1],this._m0=this._m1=0;else {let s=0;for(;e>=t[s+1][0];)s++;this._left=t[s][0],this._right=t[s+1][0];let i=1/(this._right-this._left);this._recip=isFinite(i)?i:0,this._p0=t[s][1],this._p1=t[s+1][1],4===this._curve.type&&this._calcTangents(t,s);}}else this._left=-1/0,this._right=1/0,this._recip=0,this._p0=this._p1=this._m0=this._m1=0;}_calcTangents(e,t){let s,i;let n=e[t],r=e[t+1];if(s=0===t?[e[0][0]+(e[0][0]-e[1][0]),e[0][1]+(e[0][1]-e[1][1])]:e[t-1],i=t===e.length-2?[e[t+1][0]+(e[t+1][0]-e[t][0]),e[t+1][1]+(e[t+1][1]-e[t][1])]:e[t+2],4===this._curve.type){let e=2*(r[0]-n[0])/(r[0]-s[0]),t=2*(r[0]-n[0])/(i[0]-n[0]);this._m0=this._curve.tension*(isFinite(e)?e:0)*(r[1]-s[1]),this._m1=this._curve.tension*(isFinite(t)?t:0)*(i[1]-n[1]);}else {let e=(r[0]-n[0])/(n[0]-s[0]),t=(r[0]-n[0])/(i[0]-r[0]),a=n[1]+(s[1]-n[1])*(isFinite(e)?e:0),o=r[1]+(i[1]-r[1])*(isFinite(t)?t:0),l=this._curve.tension;this._m0=l*(r[1]-a),this._m1=l*(o-n[1]);}}_evaluateHermite(e,t,s,i,n){let r=n*n,a=n+n,o=1-n,l=o*o;return (1+a)*l*e+n*l*s+r*(3-a)*t+r*(n-1)*i}constructor(e,t=0){this._left=-1/0,this._right=1/0,this._recip=0,this._p0=0,this._p1=0,this._m0=0,this._m1=0,this._curve=e,this._reset(t);}}class ea{get length(){return this.keys.length}add(e,t){let s=this.keys,i=s.length,n=0;for(;n<i&&!(s[n][0]>e);n++);let r=[e,t];return this.keys.splice(n,0,r),r}get(e){return this.keys[e]}sort(){this.keys.sort((e,t)=>e[0]-t[0]);}value(e){return this._eval.evaluate(e,true)}closest(e){let t=this.keys,s=t.length,i=2,n=null;for(let r=0;r<s;r++){let s=Math.abs(e-t[r][0]);if(i>=s)i=s,n=t[r];else break}return n}clone(){let e=new this.constructor;return e.keys=this.keys.map(e=>[...e]),e.type=this.type,e.tension=this.tension,e}quantize(e){let t=new Float32Array(e=Math.max(e,2)),s=1/(e-1);t[0]=this._eval.evaluate(0,true);for(let i=1;i<e;i++)t[i]=this._eval.evaluate(s*i);return t}quantizeClamped(e,t,s){let i=this.quantize(e);for(let e=0;e<i.length;++e)i[e]=Math.min(s,Math.max(t,i[e]));return i}constructor(e){if(this.keys=[],this.type=1,this.tension=.5,this._eval=new er(this),e)for(let t=0;t<e.length-1;t+=2)this.keys.push([e[t],e[t+1]]);this.sort();}}class eo{get length(){return this.curves.length}set type(e){this._type=e;for(let t=0;t<this.curves.length;t++)this.curves[t].type=e;}get type(){return this._type}get(e){return this.curves[e]}value(e,t){ void 0===t&&(t=[]);let s=this.curves.length;t.length=s;for(let i=0;i<s;i++)t[i]=this.curves[i].value(e);return t}clone(){let e=new this.constructor;e.curves=[];for(let t=0;t<this.curves.length;t++)e.curves.push(this.curves[t].clone());return e._type=this._type,e}quantize(e){e=Math.max(e,2);let t=this.curves.length,s=new Float32Array(e*t),i=1/(e-1);for(let n=0;n<t;n++){let r=new er(this.curves[n]);for(let a=0;a<e;a++)s[a*t+n]=r.evaluate(i*a);}return s}quantizeClamped(e,t,s){let i=this.quantize(e);for(let e=0;e<i.length;++e)i[e]=Math.min(s,Math.max(t,i[e]));return i}constructor(...e){if(this.curves=[],this._type=1,e.length>1)for(let t=0;t<e.length;t++)this.curves.push(new ea(e[t]));else if(0===e.length)this.curves.push(new ea);else {let t=e[0];if("number"==typeof t)for(let e=0;e<t;e++)this.curves.push(new ea);else for(let e=0;e<t.length;e++)this.curves.push(new ea(t[e]));}}}let el=new Float32Array(1),eh=new Int32Array(el.buffer);class ed{static float2Half(e){el[0]=e;let t=eh[0],s=t>>16&32768,i=t>>12&2047,n=t>>23&255;return n<103?s:n>142?(s|=31744,s|=+(255!==n)&&8388607&t):n<113?(i|=2048,s|=(i>>114-n)+(i>>113-n&1)):(s|=n-112<<10|i>>1,s+=1&i)}static float2RGBA8(e,t){el[0]=e;let s=eh[0];t.r=(s>>24&255)/255,t.g=(s>>16&255)/255,t.b=(s>>8&255)/255,t.a=(255&s)/255;}}class ec{static concentric(e,t){let s=[];s.push(0,0);let i=2*Math.PI/e/t;for(let t=1;t<=e;t++){let n=t/e,r=Math.max(1,Math.floor(2*Math.PI*n/i)),a=2*Math.PI/r;for(let e=0;e<r;e++){let t=e*a,i=n*Math.cos(t),r=n*Math.sin(t);s.push(i,r);}}return s}}class eu{add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}add2(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addScaled(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}clone(){return new this.constructor(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}cross(e,t){let s=e.x,i=e.y,n=e.z,r=t.x,a=t.y,o=t.z;return this.x=i*o-a*n,this.y=n*r-o*s,this.z=s*a-r*i,this}distance(e){let t=this.x-e.x,s=this.y-e.y,i=this.z-e.z;return Math.sqrt(t*t+s*s+i*i)}div(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}div2(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this.z=e.z/t.z,this}divScalar(e){return this.x/=e,this.y/=e,this.z/=e,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}equals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z}equalsApprox(e,t){return void 0===t&&(t=1e-6),Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}lerp(e,t,s){return this.x=e.x+s*(t.x-e.x),this.y=e.y+s*(t.y-e.y),this.z=e.z+s*(t.z-e.z),this}mul(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}mul2(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}mulScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}normalize(e){ void 0===e&&(e=this);let t=e.x*e.x+e.y*e.y+e.z*e.z;if(t>0){let s=1/Math.sqrt(t);this.x=e.x*s,this.y=e.y*s,this.z=e.z*s;}return this}floor(e){return void 0===e&&(e=this),this.x=Math.floor(e.x),this.y=Math.floor(e.y),this.z=Math.floor(e.z),this}ceil(e){return void 0===e&&(e=this),this.x=Math.ceil(e.x),this.y=Math.ceil(e.y),this.z=Math.ceil(e.z),this}round(e){return void 0===e&&(e=this),this.x=Math.round(e.x),this.y=Math.round(e.y),this.z=Math.round(e.z),this}min(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),this}max(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),this}project(e){let t=(this.x*e.x+this.y*e.y+this.z*e.z)/(e.x*e.x+e.y*e.y+e.z*e.z);return this.x=e.x*t,this.y=e.y*t,this.z=e.z*t,this}set(e,t,s){return this.x=e,this.y=t,this.z=s,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}sub2(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}fromArray(e,t){var s,i,n;return void 0===t&&(t=0),this.x=null!=(s=e[t])?s:this.x,this.y=null!=(i=e[t+1])?i:this.y,this.z=null!=(n=e[t+2])?n:this.z,this}toString(){return "["+this.x+", "+this.y+", "+this.z+"]"}toArray(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e}constructor(e=0,t=0,s=0){3===e.length?(this.x=e[0],this.y=e[1],this.z=e[2]):(this.x=e,this.y=t,this.z=s);}}eu.ZERO=Object.freeze(new eu(0,0,0)),eu.HALF=Object.freeze(new eu(.5,.5,.5)),eu.ONE=Object.freeze(new eu(1,1,1)),eu.UP=Object.freeze(new eu(0,1,0)),eu.DOWN=Object.freeze(new eu(0,-1,0)),eu.RIGHT=Object.freeze(new eu(1,0,0)),eu.LEFT=Object.freeze(new eu(-1,0,0)),eu.FORWARD=Object.freeze(new eu(0,0,-1)),eu.BACK=Object.freeze(new eu(0,0,1));class ep{clone(){return new this.constructor().copy(this)}copy(e){let t=e.data,s=this.data;return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[4]=t[4],s[5]=t[5],s[6]=t[6],s[7]=t[7],s[8]=t[8],this}set(e){let t=this.data;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],this}getX(e){return void 0===e&&(e=new eu),e.set(this.data[0],this.data[1],this.data[2])}getY(e){return void 0===e&&(e=new eu),e.set(this.data[3],this.data[4],this.data[5])}getZ(e){return void 0===e&&(e=new eu),e.set(this.data[6],this.data[7],this.data[8])}equals(e){let t=this.data,s=e.data;return t[0]===s[0]&&t[1]===s[1]&&t[2]===s[2]&&t[3]===s[3]&&t[4]===s[4]&&t[5]===s[5]&&t[6]===s[6]&&t[7]===s[7]&&t[8]===s[8]}isIdentity(){let e=this.data;return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&1===e[4]&&0===e[5]&&0===e[6]&&0===e[7]&&1===e[8]}setIdentity(){let e=this.data;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,this}toString(){return "["+this.data.join(", ")+"]"}transpose(e){ void 0===e&&(e=this);let t=e.data,s=this.data;if(t===s){let e;e=t[1],s[1]=t[3],s[3]=e,e=t[2],s[2]=t[6],s[6]=e,e=t[5],s[5]=t[7],s[7]=e;}else s[0]=t[0],s[1]=t[3],s[2]=t[6],s[3]=t[1],s[4]=t[4],s[5]=t[7],s[6]=t[2],s[7]=t[5],s[8]=t[8];return this}setFromMat4(e){let t=e.data,s=this.data;return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[4],s[4]=t[5],s[5]=t[6],s[6]=t[8],s[7]=t[9],s[8]=t[10],this}setFromQuat(e){let t=e.x,s=e.y,i=e.z,n=e.w,r=t+t,a=s+s,o=i+i,l=t*r,h=t*a,d=t*o,c=s*a,u=s*o,p=i*o,f=n*r,m=n*a,_=n*o,g=this.data;return g[0]=1-(c+p),g[1]=h+_,g[2]=d-m,g[3]=h-_,g[4]=1-(l+p),g[5]=u+f,g[6]=d+m,g[7]=u-f,g[8]=1-(l+c),this}invertMat4(e){let t=e.data,s=t[0],i=t[1],n=t[2],r=t[4],a=t[5],o=t[6],l=t[8],h=t[9],d=t[10],c=d*a-o*h,u=-d*r+o*l,p=h*r-a*l,f=s*c+i*u+n*p;if(0===f)this.setIdentity();else {let e=1/f,t=this.data;t[0]=c*e,t[1]=(-d*i+n*h)*e,t[2]=(o*i-n*a)*e,t[3]=u*e,t[4]=(d*s-n*l)*e,t[5]=(-o*s+n*r)*e,t[6]=p*e,t[7]=(-h*s+i*l)*e,t[8]=(a*s-i*r)*e;}return this}transformVector(e,t){ void 0===t&&(t=new eu);let s=this.data,{x:i,y:n,z:r}=e;return t.x=i*s[0]+n*s[3]+r*s[6],t.y=i*s[1]+n*s[4]+r*s[7],t.z=i*s[2]+n*s[5]+r*s[8],t}constructor(){this.data=new Float32Array(9),this.data[0]=this.data[4]=this.data[8]=1;}}ep.IDENTITY=Object.freeze(new ep),ep.ZERO=Object.freeze(new ep().set([0,0,0,0,0,0,0,0,0]));class ef{add(e){return this.x+=e.x,this.y+=e.y,this}add2(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}addScalar(e){return this.x+=e,this.y+=e,this}addScaled(e,t){return this.x+=e.x*t,this.y+=e.y*t,this}clone(){return new this.constructor(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}cross(e){return this.x*e.y-this.y*e.x}distance(e){let t=this.x-e.x,s=this.y-e.y;return Math.sqrt(t*t+s*s)}div(e){return this.x/=e.x,this.y/=e.y,this}div2(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this}divScalar(e){return this.x/=e,this.y/=e,this}dot(e){return this.x*e.x+this.y*e.y}equals(e){return this.x===e.x&&this.y===e.y}equalsApprox(e,t){return void 0===t&&(t=1e-6),Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSq(){return this.x*this.x+this.y*this.y}lerp(e,t,s){return this.x=e.x+s*(t.x-e.x),this.y=e.y+s*(t.y-e.y),this}mul(e){return this.x*=e.x,this.y*=e.y,this}mul2(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this}mulScalar(e){return this.x*=e,this.y*=e,this}normalize(e){ void 0===e&&(e=this);let t=e.x*e.x+e.y*e.y;if(t>0){let s=1/Math.sqrt(t);this.x=e.x*s,this.y=e.y*s;}return this}rotate(e){let t=Math.atan2(this.x,this.y)+e*ei.DEG_TO_RAD,s=Math.sqrt(this.x*this.x+this.y*this.y);return this.x=Math.sin(t)*s,this.y=Math.cos(t)*s,this}angle(){return Math.atan2(this.x,this.y)*ei.RAD_TO_DEG}angleTo(e){return Math.atan2(this.x*e.y+this.y*e.x,this.x*e.x+this.y*e.y)*ei.RAD_TO_DEG}floor(e){return void 0===e&&(e=this),this.x=Math.floor(e.x),this.y=Math.floor(e.y),this}ceil(e){return void 0===e&&(e=this),this.x=Math.ceil(e.x),this.y=Math.ceil(e.y),this}round(e){return void 0===e&&(e=this),this.x=Math.round(e.x),this.y=Math.round(e.y),this}min(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),this}max(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),this}set(e,t){return this.x=e,this.y=t,this}sub(e){return this.x-=e.x,this.y-=e.y,this}sub2(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}subScalar(e){return this.x-=e,this.y-=e,this}fromArray(e,t){var s,i;return void 0===t&&(t=0),this.x=null!=(s=e[t])?s:this.x,this.y=null!=(i=e[t+1])?i:this.y,this}toString(){return "["+this.x+", "+this.y+"]"}toArray(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e}static angleRad(e,t){return Math.atan2(e.x*t.y-e.y*t.x,e.x*t.x+e.y*t.y)}constructor(e=0,t=0){2===e.length?(this.x=e[0],this.y=e[1]):(this.x=e,this.y=t);}}ef.ZERO=Object.freeze(new ef(0,0)),ef.HALF=Object.freeze(new ef(.5,.5)),ef.ONE=Object.freeze(new ef(1,1)),ef.UP=Object.freeze(new ef(0,1)),ef.DOWN=Object.freeze(new ef(0,-1)),ef.RIGHT=Object.freeze(new ef(1,0)),ef.LEFT=Object.freeze(new ef(-1,0));class em{add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}add2(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addScaled(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}div(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this}div2(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this.z=e.z/t.z,this.w=e.w/t.w,this}divScalar(e){return this.x/=e,this.y/=e,this.z/=e,this.w/=e,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}equals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}equalsApprox(e,t){return void 0===t&&(t=1e-6),Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t&&Math.abs(this.w-e.w)<t}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}lerp(e,t,s){return this.x=e.x+s*(t.x-e.x),this.y=e.y+s*(t.y-e.y),this.z=e.z+s*(t.z-e.z),this.w=e.w+s*(t.w-e.w),this}mul(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}mul2(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this.w=e.w*t.w,this}mulScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}normalize(e){ void 0===e&&(e=this);let t=e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w;if(t>0){let s=1/Math.sqrt(t);this.x=e.x*s,this.y=e.y*s,this.z=e.z*s,this.w=e.w*s;}return this}floor(e){return void 0===e&&(e=this),this.x=Math.floor(e.x),this.y=Math.floor(e.y),this.z=Math.floor(e.z),this.w=Math.floor(e.w),this}ceil(e){return void 0===e&&(e=this),this.x=Math.ceil(e.x),this.y=Math.ceil(e.y),this.z=Math.ceil(e.z),this.w=Math.ceil(e.w),this}round(e){return void 0===e&&(e=this),this.x=Math.round(e.x),this.y=Math.round(e.y),this.z=Math.round(e.z),this.w=Math.round(e.w),this}min(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),e.w<this.w&&(this.w=e.w),this}max(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),e.w>this.w&&(this.w=e.w),this}set(e,t,s,i){return this.x=e,this.y=t,this.z=s,this.w=i,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}sub2(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}fromArray(e,t){var s,i,n,r;return void 0===t&&(t=0),this.x=null!=(s=e[t])?s:this.x,this.y=null!=(i=e[t+1])?i:this.y,this.z=null!=(n=e[t+2])?n:this.z,this.w=null!=(r=e[t+3])?r:this.w,this}toString(){return "["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"}toArray(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e}constructor(e=0,t=0,s=0,i=0){4===e.length?(this.x=e[0],this.y=e[1],this.z=e[2],this.w=e[3]):(this.x=e,this.y=t,this.z=s,this.w=i);}}em.ZERO=Object.freeze(new em(0,0,0,0)),em.HALF=Object.freeze(new em(.5,.5,.5,.5)),em.ONE=Object.freeze(new em(1,1,1,1));let e_=new ef,eg=new eu,ev=new eu,ey=new eu,eS=new eu;class ex{static _getPerspectiveHalfSize(e,t,s,i,n){n?(e.x=i*Math.tan(t*Math.PI/360),e.y=e.x/s):(e.y=i*Math.tan(t*Math.PI/360),e.x=e.y*s);}add2(e,t){let s=e.data,i=t.data,n=this.data;return n[0]=s[0]+i[0],n[1]=s[1]+i[1],n[2]=s[2]+i[2],n[3]=s[3]+i[3],n[4]=s[4]+i[4],n[5]=s[5]+i[5],n[6]=s[6]+i[6],n[7]=s[7]+i[7],n[8]=s[8]+i[8],n[9]=s[9]+i[9],n[10]=s[10]+i[10],n[11]=s[11]+i[11],n[12]=s[12]+i[12],n[13]=s[13]+i[13],n[14]=s[14]+i[14],n[15]=s[15]+i[15],this}add(e){return this.add2(this,e)}clone(){return new this.constructor().copy(this)}copy(e){let t=e.data,s=this.data;return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[4]=t[4],s[5]=t[5],s[6]=t[6],s[7]=t[7],s[8]=t[8],s[9]=t[9],s[10]=t[10],s[11]=t[11],s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15],this}equals(e){let t=this.data,s=e.data;return t[0]===s[0]&&t[1]===s[1]&&t[2]===s[2]&&t[3]===s[3]&&t[4]===s[4]&&t[5]===s[5]&&t[6]===s[6]&&t[7]===s[7]&&t[8]===s[8]&&t[9]===s[9]&&t[10]===s[10]&&t[11]===s[11]&&t[12]===s[12]&&t[13]===s[13]&&t[14]===s[14]&&t[15]===s[15]}isIdentity(){let e=this.data;return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&1===e[10]&&0===e[11]&&0===e[12]&&0===e[13]&&0===e[14]&&1===e[15]}mul2(e,t){let s,i,n,r;let a=e.data,o=t.data,l=this.data,h=a[0],d=a[1],c=a[2],u=a[3],p=a[4],f=a[5],m=a[6],_=a[7],g=a[8],v=a[9],y=a[10],S=a[11],x=a[12],T=a[13],b=a[14],E=a[15];return s=o[0],i=o[1],n=o[2],r=o[3],l[0]=h*s+p*i+g*n+x*r,l[1]=d*s+f*i+v*n+T*r,l[2]=c*s+m*i+y*n+b*r,l[3]=u*s+_*i+S*n+E*r,s=o[4],i=o[5],n=o[6],r=o[7],l[4]=h*s+p*i+g*n+x*r,l[5]=d*s+f*i+v*n+T*r,l[6]=c*s+m*i+y*n+b*r,l[7]=u*s+_*i+S*n+E*r,s=o[8],i=o[9],n=o[10],r=o[11],l[8]=h*s+p*i+g*n+x*r,l[9]=d*s+f*i+v*n+T*r,l[10]=c*s+m*i+y*n+b*r,l[11]=u*s+_*i+S*n+E*r,s=o[12],i=o[13],n=o[14],r=o[15],l[12]=h*s+p*i+g*n+x*r,l[13]=d*s+f*i+v*n+T*r,l[14]=c*s+m*i+y*n+b*r,l[15]=u*s+_*i+S*n+E*r,this}mulAffine2(e,t){let s,i,n;let r=e.data,a=t.data,o=this.data,l=r[0],h=r[1],d=r[2],c=r[4],u=r[5],p=r[6],f=r[8],m=r[9],_=r[10],g=r[12],v=r[13],y=r[14];return s=a[0],i=a[1],n=a[2],o[0]=l*s+c*i+f*n,o[1]=h*s+u*i+m*n,o[2]=d*s+p*i+_*n,o[3]=0,s=a[4],i=a[5],n=a[6],o[4]=l*s+c*i+f*n,o[5]=h*s+u*i+m*n,o[6]=d*s+p*i+_*n,o[7]=0,s=a[8],i=a[9],n=a[10],o[8]=l*s+c*i+f*n,o[9]=h*s+u*i+m*n,o[10]=d*s+p*i+_*n,o[11]=0,s=a[12],i=a[13],n=a[14],o[12]=l*s+c*i+f*n+g,o[13]=h*s+u*i+m*n+v,o[14]=d*s+p*i+_*n+y,o[15]=1,this}mul(e){return this.mul2(this,e)}transformPoint(e,t){ void 0===t&&(t=new eu);let s=this.data,{x:i,y:n,z:r}=e;return t.x=i*s[0]+n*s[4]+r*s[8]+s[12],t.y=i*s[1]+n*s[5]+r*s[9]+s[13],t.z=i*s[2]+n*s[6]+r*s[10]+s[14],t}transformVector(e,t){ void 0===t&&(t=new eu);let s=this.data,{x:i,y:n,z:r}=e;return t.x=i*s[0]+n*s[4]+r*s[8],t.y=i*s[1]+n*s[5]+r*s[9],t.z=i*s[2]+n*s[6]+r*s[10],t}transformVec4(e,t){ void 0===t&&(t=new em);let s=this.data,{x:i,y:n,z:r,w:a}=e;return t.x=i*s[0]+n*s[4]+r*s[8]+a*s[12],t.y=i*s[1]+n*s[5]+r*s[9]+a*s[13],t.z=i*s[2]+n*s[6]+r*s[10]+a*s[14],t.w=i*s[3]+n*s[7]+r*s[11]+a*s[15],t}setLookAt(e,t,s){ey.sub2(e,t).normalize(),ev.copy(s).normalize(),eg.cross(ev,ey).normalize(),ev.cross(ey,eg);let i=this.data;return i[0]=eg.x,i[1]=eg.y,i[2]=eg.z,i[3]=0,i[4]=ev.x,i[5]=ev.y,i[6]=ev.z,i[7]=0,i[8]=ey.x,i[9]=ey.y,i[10]=ey.z,i[11]=0,i[12]=e.x,i[13]=e.y,i[14]=e.z,i[15]=1,this}setFrustum(e,t,s,i,n,r){let a=2*n,o=t-e,l=i-s,h=r-n,d=this.data;return d[0]=a/o,d[1]=0,d[2]=0,d[3]=0,d[4]=0,d[5]=a/l,d[6]=0,d[7]=0,d[8]=(t+e)/o,d[9]=(i+s)/l,d[10]=(-r-n)/h,d[11]=-1,d[12]=0,d[13]=0,d[14]=-a*r/h,d[15]=0,this}setPerspective(e,t,s,i,n){return ex._getPerspectiveHalfSize(e_,e,t,s,n),this.setFrustum(-e_.x,e_.x,-e_.y,e_.y,s,i)}setOrtho(e,t,s,i,n,r){let a=this.data;return a[0]=2/(t-e),a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/(i-s),a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=-2/(r-n),a[11]=0,a[12]=-(t+e)/(t-e),a[13]=-(i+s)/(i-s),a[14]=-(r+n)/(r-n),a[15]=1,this}setFromAxisAngle(e,t){t*=ei.DEG_TO_RAD;let{x:s,y:i,z:n}=e,r=Math.cos(t),a=Math.sin(t),o=1-r,l=o*s,h=o*i,d=this.data;return d[0]=l*s+r,d[1]=l*i+a*n,d[2]=l*n-a*i,d[3]=0,d[4]=l*i-a*n,d[5]=h*i+r,d[6]=h*n+a*s,d[7]=0,d[8]=l*n+a*i,d[9]=h*n-s*a,d[10]=o*n*n+r,d[11]=0,d[12]=0,d[13]=0,d[14]=0,d[15]=1,this}setTranslate(e,t,s){let i=this.data;return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=e,i[13]=t,i[14]=s,i[15]=1,this}setScale(e,t,s){let i=this.data;return i[0]=e,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=t,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=s,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,this}setViewport(e,t,s,i){let n=this.data;return n[0]=.5*s,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=.5*i,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=.5,n[11]=0,n[12]=e+.5*s,n[13]=t+.5*i,n[14]=.5,n[15]=1,this}setReflection(e,t){let s=e.x,i=e.y,n=e.z,r=this.data;return r[0]=1-2*s*s,r[1]=-2*s*i,r[2]=-2*s*n,r[3]=0,r[4]=-2*s*i,r[5]=1-2*i*i,r[6]=-2*i*n,r[7]=0,r[8]=-2*s*n,r[9]=-2*i*n,r[10]=1-2*n*n,r[11]=0,r[12]=-2*s*t,r[13]=-2*i*t,r[14]=-2*n*t,r[15]=1,this}invert(e){ void 0===e&&(e=this);let t=e.data,s=t[0],i=t[1],n=t[2],r=t[3],a=t[4],o=t[5],l=t[6],h=t[7],d=t[8],c=t[9],u=t[10],p=t[11],f=t[12],m=t[13],_=t[14],g=t[15],v=s*o-i*a,y=s*l-n*a,S=s*h-r*a,x=i*l-n*o,T=i*h-r*o,b=n*h-r*l,E=d*m-c*f,A=d*_-u*f,w=d*g-p*f,C=c*_-u*m,P=c*g-p*m,M=u*g-p*_,I=v*M-y*P+S*C+x*w-T*A+b*E;if(0===I)this.setIdentity();else {let e=1/I,t=this.data;t[0]=(o*M-l*P+h*C)*e,t[1]=(-i*M+n*P-r*C)*e,t[2]=(m*b-_*T+g*x)*e,t[3]=(-c*b+u*T-p*x)*e,t[4]=(-a*M+l*w-h*A)*e,t[5]=(s*M-n*w+r*A)*e,t[6]=(-f*b+_*S-g*y)*e,t[7]=(d*b-u*S+p*y)*e,t[8]=(a*P-o*w+h*E)*e,t[9]=(-s*P+i*w-r*E)*e,t[10]=(f*T-m*S+g*v)*e,t[11]=(-d*T+c*S-p*v)*e,t[12]=(-a*C+o*A-l*E)*e,t[13]=(s*C-i*A+n*E)*e,t[14]=(-f*x+m*y-_*v)*e,t[15]=(d*x-c*y+u*v)*e;}return this}set(e){let t=this.data;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],this}setIdentity(){let e=this.data;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}setTRS(e,t,s){let i=t.x,n=t.y,r=t.z,a=t.w,o=s.x,l=s.y,h=s.z,d=i+i,c=n+n,u=r+r,p=i*d,f=i*c,m=i*u,_=n*c,g=n*u,v=r*u,y=a*d,S=a*c,x=a*u,T=this.data;return T[0]=(1-(_+v))*o,T[1]=(f+x)*o,T[2]=(m-S)*o,T[3]=0,T[4]=(f-x)*l,T[5]=(1-(p+v))*l,T[6]=(g+y)*l,T[7]=0,T[8]=(m+S)*h,T[9]=(g-y)*h,T[10]=(1-(p+_))*h,T[11]=0,T[12]=e.x,T[13]=e.y,T[14]=e.z,T[15]=1,this}transpose(e){ void 0===e&&(e=this);let t=e.data,s=this.data;if(t===s){let e;e=t[1],s[1]=t[4],s[4]=e,e=t[2],s[2]=t[8],s[8]=e,e=t[3],s[3]=t[12],s[12]=e,e=t[6],s[6]=t[9],s[9]=e,e=t[7],s[7]=t[13],s[13]=e,e=t[11],s[11]=t[14],s[14]=e;}else s[0]=t[0],s[1]=t[4],s[2]=t[8],s[3]=t[12],s[4]=t[1],s[5]=t[5],s[6]=t[9],s[7]=t[13],s[8]=t[2],s[9]=t[6],s[10]=t[10],s[11]=t[14],s[12]=t[3],s[13]=t[7],s[14]=t[11],s[15]=t[15];return this}getTranslation(e){return void 0===e&&(e=new eu),e.set(this.data[12],this.data[13],this.data[14])}getX(e){return void 0===e&&(e=new eu),e.set(this.data[0],this.data[1],this.data[2])}getY(e){return void 0===e&&(e=new eu),e.set(this.data[4],this.data[5],this.data[6])}getZ(e){return void 0===e&&(e=new eu),e.set(this.data[8],this.data[9],this.data[10])}getScale(e){return void 0===e&&(e=new eu),this.getX(eg),this.getY(ev),this.getZ(ey),e.set(eg.length(),ev.length(),ey.length()),e}get scaleSign(){return this.getX(eg),this.getY(ev),this.getZ(ey),eg.cross(eg,ev),0>eg.dot(ey)?-1:1}setFromEulerAngles(e,t,s){e*=ei.DEG_TO_RAD,t*=ei.DEG_TO_RAD,s*=ei.DEG_TO_RAD;let i=Math.sin(-e),n=Math.cos(-e),r=Math.sin(-t),a=Math.cos(-t),o=Math.sin(-s),l=Math.cos(-s),h=this.data;return h[0]=a*l,h[1]=-a*o,h[2]=r,h[3]=0,h[4]=n*o+l*i*r,h[5]=n*l-i*r*o,h[6]=-a*i,h[7]=0,h[8]=i*o-n*l*r,h[9]=l*i+n*r*o,h[10]=n*a,h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,this}getEulerAngles(e){let t,s;void 0===e&&(e=new eu),this.getScale(eS);let i=eS.x,n=eS.y,r=eS.z;if(0===i||0===n||0===r)return e.set(0,0,0);let a=this.data,o=Math.asin(-a[2]/i),l=.5*Math.PI;return o<l?o>-l?(t=Math.atan2(a[6]/n,a[10]/r),s=Math.atan2(a[1]/i,a[0]/i)):(s=0,t=-Math.atan2(a[4]/n,a[5]/n)):(s=0,t=Math.atan2(a[4]/n,a[5]/n)),e.set(t,o,s).mulScalar(ei.RAD_TO_DEG)}toString(){return "["+this.data.join(", ")+"]"}constructor(){this.data=new Float32Array(16),this.data[0]=this.data[5]=this.data[10]=this.data[15]=1;}}ex.IDENTITY=Object.freeze(new ex),ex.ZERO=Object.freeze(new ex().set([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]));class eT{clone(){return new this.constructor(this.x,this.y,this.z,this.w)}conjugate(e){return void 0===e&&(e=this),this.x=-1*e.x,this.y=-1*e.y,this.z=-1*e.z,this.w=e.w,this}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}equals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}equalsApprox(e,t){return void 0===t&&(t=1e-6),Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t&&Math.abs(this.w-e.w)<t}getAxisAngle(e){let t=2*Math.acos(this.w),s=Math.sin(t/2);return 0!==s?(e.x=this.x/s,e.y=this.y/s,e.z=this.z/s,(e.x<0||e.y<0||e.z<0)&&(e.x*=-1,e.y*=-1,e.z*=-1,t*=-1)):(e.x=1,e.y=0,e.z=0),t*ei.RAD_TO_DEG}getEulerAngles(e){let t,s,i;void 0===e&&(e=new eu);let n=this.x,r=this.y,a=this.z,o=this.w,l=2*(o*r-n*a);return l<=-0.99999?(t=2*Math.atan2(n,o),s=-Math.PI/2,i=0):l>=.99999?(t=2*Math.atan2(n,o),s=Math.PI/2,i=0):(t=Math.atan2(2*(o*n+r*a),1-2*(n*n+r*r)),s=Math.asin(l),i=Math.atan2(2*(o*a+n*r),1-2*(r*r+a*a))),e.set(t,s,i).mulScalar(ei.RAD_TO_DEG)}invert(e){return void 0===e&&(e=this),this.conjugate(e).normalize()}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}mul(e){let t=this.x,s=this.y,i=this.z,n=this.w,r=e.x,a=e.y,o=e.z,l=e.w;return this.x=n*r+t*l+s*o-i*a,this.y=n*a+s*l+i*r-t*o,this.z=n*o+i*l+t*a-s*r,this.w=n*l-t*r-s*a-i*o,this}mulScalar(e,t){return void 0===t&&(t=this),this.x=t.x*e,this.y=t.y*e,this.z=t.z*e,this.w=t.w*e,this}mul2(e,t){let s=e.x,i=e.y,n=e.z,r=e.w,a=t.x,o=t.y,l=t.z,h=t.w;return this.x=r*a+s*h+i*l-n*o,this.y=r*o+i*h+n*a-s*l,this.z=r*l+n*h+s*o-i*a,this.w=r*h-s*a-i*o-n*l,this}normalize(e){ void 0===e&&(e=this);let t=e.length();return 0===t?(this.x=this.y=this.z=0,this.w=1):(t=1/t,this.x=e.x*t,this.y=e.y*t,this.z=e.z*t,this.w=e.w*t),this}set(e,t,s,i){return this.x=e,this.y=t,this.z=s,this.w=i,this}setFromAxisAngle(e,t){let s=Math.sin(t*=.5*ei.DEG_TO_RAD),i=Math.cos(t);return this.x=s*e.x,this.y=s*e.y,this.z=s*e.z,this.w=i,this}setFromEulerAngles(e,t,s){if(e instanceof eu){let i=e;e=i.x,t=i.y,s=i.z;}let i=.5*ei.DEG_TO_RAD;e*=i,t*=i,s*=i;let n=Math.sin(e),r=Math.cos(e),a=Math.sin(t),o=Math.cos(t),l=Math.sin(s),h=Math.cos(s);return this.x=n*o*h-r*a*l,this.y=r*a*h+n*o*l,this.z=r*o*l-n*a*h,this.w=r*o*h+n*a*l,this}setFromMat4(e){let t;let s=e.data,i=s[0],n=s[1],r=s[2],a=s[4],o=s[5],l=s[6],h=s[8],d=s[9],c=s[10];return 0==(t=i*i+n*n+r*r)?this.set(0,0,0,1):(i*=t=1/Math.sqrt(t),n*=t,r*=t,0==(t=a*a+o*o+l*l))?this.set(0,0,0,1):(a*=t=1/Math.sqrt(t),o*=t,l*=t,0==(t=h*h+d*d+c*c))?this.set(0,0,0,1):(h*=t=1/Math.sqrt(t),d*=t,(c*=t)<0?i>o?this.set(1+i-o-c,n+a,h+r,l-d):this.set(n+a,1-i+o-c,l+d,h-r):i<-o?this.set(h+r,l+d,1-i-o+c,n-a):this.set(l-d,h-r,n-a,1+i+o+c),this.mulScalar(1/this.length()))}setFromDirections(e,t){let s=1+e.dot(t);return s<Number.EPSILON?(Math.abs(e.x)>Math.abs(e.y)?(this.x=-e.z,this.y=0,this.z=e.x):(this.x=0,this.y=-e.z,this.z=e.y),this.w=0):(this.x=e.y*t.z-e.z*t.y,this.y=e.z*t.x-e.x*t.z,this.z=e.x*t.y-e.y*t.x,this.w=s),this.normalize()}slerp(e,t,s){let i=e.x,n=e.y,r=e.z,a=e.w,o=t.x,l=t.y,h=t.z,d=t.w,c=a*d+i*o+n*l+r*h;if(c<0&&(d=-d,o=-o,l=-l,h=-h,c=-c),Math.abs(c)>=1)return this.w=a,this.x=i,this.y=n,this.z=r,this;let u=Math.acos(c),p=Math.sqrt(1-c*c);if(.001>Math.abs(p))return this.w=.5*a+.5*d,this.x=.5*i+.5*o,this.y=.5*n+.5*l,this.z=.5*r+.5*h,this;let f=Math.sin((1-s)*u)/p,m=Math.sin(s*u)/p;return this.w=a*f+d*m,this.x=i*f+o*m,this.y=n*f+l*m,this.z=r*f+h*m,this}transformVector(e,t){ void 0===t&&(t=new eu);let s=e.x,i=e.y,n=e.z,r=this.x,a=this.y,o=this.z,l=this.w,h=l*s+a*n-o*i,d=l*i+o*s-r*n,c=l*n+r*i-a*s,u=-r*s-a*i-o*n;return t.x=h*l+-(u*r)+-(d*o)- -(c*a),t.y=d*l+-(u*a)+-(c*r)- -(h*o),t.z=c*l+-(u*o)+-(h*a)- -(d*r),t}toString(){return "["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"}constructor(e=0,t=0,s=0,i=1){4===e.length?(this.x=e[0],this.y=e[1],this.z=e[2],this.w=e[3]):(this.x=e,this.y=t,this.z=s,this.w=i);}}eT.IDENTITY=Object.freeze(new eT(0,0,0,1)),eT.ZERO=Object.freeze(new eT(0,0,0,0));let eb=new eu,eE=new eu,eA=new eu,ew=new eu,eC=new eu;class eP{add(e){let t=this.center,s=t.x,i=t.y,n=t.z,r=this.halfExtents,a=r.x,o=r.y,l=r.z,h=s-a,d=s+a,c=i-o,u=i+o,p=n-l,f=n+l,m=e.center,_=m.x,g=m.y,v=m.z,y=e.halfExtents,S=y.x,x=y.y,T=y.z,b=_-S,E=_+S,A=g-x,w=g+x,C=v-T,P=v+T;b<h&&(h=b),E>d&&(d=E),A<c&&(c=A),w>u&&(u=w),C<p&&(p=C),P>f&&(f=P),t.x=(h+d)*.5,t.y=(c+u)*.5,t.z=(p+f)*.5,r.x=(d-h)*.5,r.y=(u-c)*.5,r.z=(f-p)*.5;}copy(e){this.center.copy(e.center),this.halfExtents.copy(e.halfExtents);}clone(){return new eP(this.center,this.halfExtents)}intersects(e){let t=this.getMax(),s=this.getMin(),i=e.getMax(),n=e.getMin();return s.x<=i.x&&t.x>=n.x&&s.y<=i.y&&t.y>=n.y&&s.z<=i.z&&t.z>=n.z}_intersectsRay(e,t){let s=eb.copy(this.getMin()).sub(e.origin),i=eE.copy(this.getMax()).sub(e.origin),n=e.direction;0===n.x?(s.x=s.x<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.x=i.x<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.x/=n.x,i.x/=n.x),0===n.y?(s.y=s.y<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.y=i.y<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.y/=n.y,i.y/=n.y),0===n.z?(s.z=s.z<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.z=i.z<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.z/=n.z,i.z/=n.z);let r=eA.set(Math.min(s.x,i.x),Math.min(s.y,i.y),Math.min(s.z,i.z)),a=ew.set(Math.max(s.x,i.x),Math.max(s.y,i.y),Math.max(s.z,i.z)),o=Math.min(Math.min(a.x,a.y),a.z),l=Math.max(Math.max(r.x,r.y),r.z),h=o>=l&&l>=0;return h&&t.copy(e.direction).mulScalar(l).add(e.origin),h}_fastIntersectsRay(e){let t=e.direction;return eb.sub2(e.origin,this.center),ew.set(Math.abs(eb.x),Math.abs(eb.y),Math.abs(eb.z)),eA.mul2(eb,t),(!(ew.x>this.halfExtents.x)||!(eA.x>=0))&&(!(ew.y>this.halfExtents.y)||!(eA.y>=0))&&(!(ew.z>this.halfExtents.z)||!(eA.z>=0))&&(eC.set(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z)),eE.cross(t,eb),eE.set(Math.abs(eE.x),Math.abs(eE.y),Math.abs(eE.z)),!(eE.x>this.halfExtents.y*eC.z+this.halfExtents.z*eC.y)&&!(eE.y>this.halfExtents.x*eC.z+this.halfExtents.z*eC.x)&&!(eE.z>this.halfExtents.x*eC.y+this.halfExtents.y*eC.x))}intersectsRay(e,t){return t?this._intersectsRay(e,t):this._fastIntersectsRay(e)}setMinMax(e,t){this.center.add2(t,e).mulScalar(.5),this.halfExtents.sub2(t,e).mulScalar(.5);}getMin(){return this._min.copy(this.center).sub(this.halfExtents)}getMax(){return this._max.copy(this.center).add(this.halfExtents)}containsPoint(e){let t=this.getMin(),s=this.getMax();return !(e.x<t.x)&&!(e.x>s.x)&&!(e.y<t.y)&&!(e.y>s.y)&&!(e.z<t.z)&&!(e.z>s.z)}setFromTransformedAabb(e,t,s){ void 0===s&&(s=false);let i=e.center,n=e.halfExtents,r=t.data,a=r[0],o=r[4],l=r[8],h=r[1],d=r[5],c=r[9],u=r[2],p=r[6],f=r[10];if(s){let e=a*a+o*o+l*l;if(e>0){let t=1/Math.sqrt(e);a*=t,o*=t,l*=t;}if((e=h*h+d*d+c*c)>0){let t=1/Math.sqrt(e);h*=t,d*=t,c*=t;}if((e=u*u+p*p+f*f)>0){let t=1/Math.sqrt(e);u*=t,p*=t,f*=t;}}this.center.set(r[12]+a*i.x+o*i.y+l*i.z,r[13]+h*i.x+d*i.y+c*i.z,r[14]+u*i.x+p*i.y+f*i.z),this.halfExtents.set(Math.abs(a)*n.x+Math.abs(o)*n.y+Math.abs(l)*n.z,Math.abs(h)*n.x+Math.abs(d)*n.y+Math.abs(c)*n.z,Math.abs(u)*n.x+Math.abs(p)*n.y+Math.abs(f)*n.z);}static computeMinMax(e,t,s,i){if(void 0===i&&(i=e.length/3),i>0){let n=e[0],r=e[1],a=e[2],o=n,l=r,h=a,d=3*i;for(let t=3;t<d;t+=3){let s=e[t],i=e[t+1],d=e[t+2];s<n&&(n=s),i<r&&(r=i),d<a&&(a=d),s>o&&(o=s),i>l&&(l=i),d>h&&(h=d);}t.set(n,r,a),s.set(o,l,h);}}compute(e,t){eP.computeMinMax(e,eb,eE,t),this.setMinMax(eb,eE);}intersectsBoundingSphere(e){return this._distanceToBoundingSphereSq(e)<=e.radius*e.radius}_distanceToBoundingSphereSq(e){let t=this.getMin(),s=this.getMax(),i=0,n=["x","y","z"];for(let r=0;r<3;++r){let a=0,o=e.center[n[r]],l=t[n[r]],h=s[n[r]],d=0;o<l&&(a+=(d=l-o)*d),o>h&&(a+=(d=o-h)*d),i+=a;}return i}_expand(e,t){eb.add2(this.getMin(),e),eE.add2(this.getMax(),t),this.setMinMax(eb,eE);}constructor(e,t){this.center=new eu,this.halfExtents=new eu(.5,.5,.5),this._min=new eu,this._max=new eu,e&&this.center.copy(e),t&&this.halfExtents.copy(t);}}let eM=new eu,eI=new eu;class eR{containsPoint(e){let t=eM.sub2(e,this.center).lengthSq(),s=this.radius;return t<s*s}intersectsRay(e,t){let s=eM.copy(e.origin).sub(this.center),i=s.dot(eI.copy(e.direction).normalize()),n=s.dot(s)-this.radius*this.radius;if(n>0&&i>0)return  false;let r=i*i-n;if(r<0)return  false;let a=Math.abs(-i-Math.sqrt(r));return t&&t.copy(e.direction).mulScalar(a).add(e.origin),true}intersectsBoundingSphere(e){eM.sub2(e.center,this.center);let t=e.radius+this.radius;return eM.lengthSq()<=t*t}constructor(e=new eu,t=.5){this.center=e,this.radius=t;}}class eL{clone(){return new this.constructor().copy(this)}copy(e){return this.normal.copy(e.normal),this.distance=e.distance,this}intersectsLine(e,t,s){let i=this.distance,n=this.normal.dot(e)+i,r=n/(n-(this.normal.dot(t)+i)),a=r>=0&&r<=1;return a&&s&&s.lerp(e,t,r),a}intersectsRay(e,t){let s=this.normal.dot(e.direction);if(0===s)return  false;let i=-(this.normal.dot(e.origin)+this.distance)/s;return i>=0&&t&&t.copy(e.direction).mulScalar(i).add(e.origin),i>=0}normalize(){let e=1/this.normal.length();return this.normal.mulScalar(e),this.distance*=e,this}set(e,t,s,i){return this.normal.set(e,t,s),this.distance=i,this}setFromPointNormal(e,t){return this.normal.copy(t),this.distance=-this.normal.dot(e),this}constructor(e=eu.UP,t=0){this.normal=new eu,this.normal.copy(e),this.distance=t;}}class eD{clone(){return new this.constructor().copy(this)}copy(e){for(let t=0;t<6;t++)this.planes[t].copy(e.planes[t]);return this}setFromMat4(e){let[t,s,i,n,r,a,o,l,h,d,c,u,p,f,m,_]=e.data,g=this.planes;g[0].set(n-t,l-r,u-h,_-p).normalize(),g[1].set(n+t,l+r,u+h,_+p).normalize(),g[2].set(n+s,l+a,u+d,_+f).normalize(),g[3].set(n-s,l-a,u-d,_-f).normalize(),g[4].set(n-i,l-o,u-c,_-m).normalize(),g[5].set(n+i,l+o,u+c,_+m).normalize();}containsPoint(e){for(let t=0;t<6;t++){let{normal:s,distance:i}=this.planes[t];if(s.dot(e)+i<=0)return  false}return  true}containsSphere(e){let{center:t,radius:s}=e,i=0;for(let e=0;e<6;e++){let{normal:n,distance:r}=this.planes[e],a=n.dot(t)+r;if(a<=-s)return 0;a>s&&i++;}return 6===i?2:1}constructor(){this.planes=[];for(let e=0;e<6;e++)this.planes[e]=new eL;}}class eO{set(e,t){return this.origin.copy(e),this.direction.copy(t),this}copy(e){return this.set(e.origin,e.direction)}clone(){return new this.constructor(this.origin,this.direction)}constructor(e,t){this.origin=new eu,this.direction=eu.FORWARD.clone(),e&&this.origin.copy(e),t&&this.direction.copy(t);}}let eF=new eO,eN=new eu,eB=new eR,eU=new ex,ek=new eu,ez=new eu,eV=new eu,eG=new eu,eH=new eu;class eW{set(e,t,s){return this.v0.copy(e),this.v1.copy(t),this.v2.copy(s),this}intersectsRay(e,t){ek.sub2(this.v1,this.v0),ez.sub2(this.v2,this.v0),eV.cross(e.direction,ez);let s=ek.dot(eV);if(s>-1e-6&&s<1e-6)return  false;let i=1/s;eG.sub2(e.origin,this.v0);let n=i*eG.dot(eV);if(n<0||n>1)return  false;eH.cross(eG,ek);let r=i*e.direction.dot(eH);if(r<0||n+r>1)return  false;let a=i*ez.dot(eH);return a>1e-6&&(t instanceof eu&&t.copy(e.direction).mulScalar(a).add(e.origin),true)}toString(){return "["+this.v0.toString()+", "+this.v1.toString()+", "+this.v2.toString()+"]"}constructor(e=eu.ZERO,t=eu.ZERO,s=eu.ZERO){this.v0=new eu,this.v1=new eu,this.v2=new eu,this.set(e,t,s);}}let eX="linear",eY="inverse",ej="exponential",eq=new Map([[0,{name:"A8",size:1,ldr:true}],[52,{name:"R8",size:1,ldr:true}],[1,{name:"L8",size:1,ldr:true}],[2,{name:"LA8",size:2,ldr:true}],[53,{name:"RG8",size:2,ldr:true}],[3,{name:"RGB565",size:2,ldr:true}],[4,{name:"RGBA5551",size:2,ldr:true}],[5,{name:"RGBA4",size:2,ldr:true}],[6,{name:"RGB8",size:4,ldr:true}],[7,{name:"RGBA8",size:4,ldr:true,srgbFormat:20}],[50,{name:"R16F",size:2}],[51,{name:"RG16F",size:4}],[11,{name:"RGB16F",size:8}],[12,{name:"RGBA16F",size:8}],[13,{name:"RGB32F",size:16}],[14,{name:"RGBA32F",size:16}],[15,{name:"R32F",size:4}],[16,{name:"DEPTH",size:4}],[69,{name:"DEPTH16",size:2}],[17,{name:"DEPTHSTENCIL",size:4}],[18,{name:"111110F",size:4}],[19,{name:"SRGB8",size:4,ldr:true,srgb:true}],[20,{name:"SRGBA8",size:4,ldr:true,srgb:true}],[31,{name:"BGRA8",size:4,ldr:true}],[64,{name:"SBGRA8",size:4,ldr:true,srgb:true}],[8,{name:"DXT1",blockSize:8,ldr:true,srgbFormat:54}],[9,{name:"DXT3",blockSize:16,ldr:true,srgbFormat:55}],[10,{name:"DXT5",blockSize:16,ldr:true,srgbFormat:56}],[21,{name:"ETC1",blockSize:8,ldr:true}],[22,{name:"ETC2_RGB",blockSize:8,ldr:true,srgbFormat:61}],[23,{name:"ETC2_RGBA",blockSize:16,ldr:true,srgbFormat:62}],[24,{name:"PVRTC_2BPP_RGB_1",ldr:true,blockSize:8}],[25,{name:"PVRTC_2BPP_RGBA_1",ldr:true,blockSize:8}],[26,{name:"PVRTC_4BPP_RGB_1",ldr:true,blockSize:8}],[27,{name:"PVRTC_4BPP_RGBA_1",ldr:true,blockSize:8}],[28,{name:"ASTC_4x4",blockSize:16,ldr:true,srgbFormat:63}],[29,{name:"ATC_RGB",blockSize:8,ldr:true}],[30,{name:"ATC_RGBA",blockSize:16,ldr:true}],[65,{name:"BC6H_RGBF",blockSize:16}],[66,{name:"BC6H_RGBUF",blockSize:16}],[67,{name:"BC7_RGBA",blockSize:16,ldr:true,srgbFormat:68}],[54,{name:"DXT1_SRGB",blockSize:8,ldr:true,srgb:true}],[55,{name:"DXT3_SRGBA",blockSize:16,ldr:true,srgb:true}],[56,{name:"DXT5_SRGBA",blockSize:16,ldr:true,srgb:true}],[61,{name:"ETC2_SRGB",blockSize:8,ldr:true,srgb:true}],[62,{name:"ETC2_SRGBA",blockSize:16,ldr:true,srgb:true}],[63,{name:"ASTC_4x4_SRGB",blockSize:16,ldr:true,srgb:true}],[68,{name:"BC7_SRGBA",blockSize:16,ldr:true,srgb:true}],[32,{name:"R8I",size:1,isInt:true}],[33,{name:"R8U",size:1,isInt:true}],[34,{name:"R16I",size:2,isInt:true}],[35,{name:"R16U",size:2,isInt:true}],[36,{name:"R32I",size:4,isInt:true}],[37,{name:"R32U",size:4,isInt:true}],[38,{name:"RG8I",size:2,isInt:true}],[39,{name:"RG8U",size:2,isInt:true}],[40,{name:"RG16I",size:4,isInt:true}],[41,{name:"RG16U",size:4,isInt:true}],[42,{name:"RG32I",size:8,isInt:true}],[43,{name:"RG32U",size:8,isInt:true}],[44,{name:"RGBA8I",size:4,isInt:true}],[45,{name:"RGBA8U",size:4,isInt:true}],[46,{name:"RGBA16I",size:8,isInt:true}],[47,{name:"RGBA16U",size:8,isInt:true}],[48,{name:"RGBA32I",size:16,isInt:true}],[49,{name:"RGBA32U",size:16,isInt:true}]]),eK=e=>{var t;return (null==(t=eq.get(e))?void 0:t.blockSize)!==void 0},eZ=e=>{var t;return (null==(t=eq.get(e))?void 0:t.srgb)===true},eQ=e=>{var t;return (null==(t=eq.get(e))?void 0:t.isInt)===true},eJ=e=>{var t;return (null==(t=eq.get(e))?void 0:t.srgbFormat)||e},e$=e=>{for(let[t,s]of eq)if(s.srgbFormat===e)return t;return e},e0=e=>{let t=eq.get(e);return !!((null==t?void 0:t.ldr)&&!(null==t?void 0:t.srgb))},e1=e=>{switch(e){case 15:case 13:case 14:return Float32Array;case 36:case 42:case 48:return Int32Array;case 37:case 43:case 49:return Uint32Array;case 34:case 40:case 46:return Int16Array;case 53:case 35:case 41:case 47:case 3:case 4:case 5:case 50:case 51:case 11:case 12:return Uint16Array;case 32:case 38:case 44:return Int8Array;default:return Uint8Array}},e2="POSITION",e3="NORMAL",e4="TANGENT",e5="BLENDWEIGHT",e6="BLENDINDICES",e8="COLOR",e9="TEXCOORD",e7="TEXCOORD0",te="TEXCOORD1",tt="TEXCOORD2",ts="TEXCOORD3",ti="TEXCOORD4",tn="TEXCOORD5",tr="TEXCOORD6",ta="TEXCOORD7",to="ATTR0",tl="ATTR1",th="ATTR2",td="ATTR3",tc="ATTR4",tu="ATTR5",tp="ATTR6",tf="ATTR7",tm="ATTR8",t_="ATTR9",tg="ATTR10",tv="ATTR11",ty="ATTR12",tS="ATTR13",tx="ATTR14",tT="ATTR15",tb="default",tE="rgbm",tA="rgbe",tw="rgbp",tC="swizzleGGGR",tP="2d-array",tM="cube",tI="cube-array",tR="none",tL="cube",tD="equirect",tO="octahedral",tF="glsl",tN="wgsl",tB=["bool","int","float","vec2","vec3","vec4","ivec2","ivec3","ivec4","bvec2","bvec3","bvec4","mat2","mat3","mat4","sampler2D","samplerCube","","sampler2DShadow","samplerCubeShadow","sampler3D","","","","","sampler2DArray","uint","uvec2","uvec3","uvec4","","","","","","","","","","","","","isampler2D","usampler2D","isamplerCube","usamplerCube","isampler3D","usampler3D","isampler2DArray","usampler2DArray"],tU=[["bool"],["i32"],["f32"],["vec2f","vec2<f32>"],["vec3f","vec3<f32>"],["vec4f","vec4<f32>"],["vec2i","vec2<i32>"],["vec3i","vec3<i32>"],["vec4i","vec4<i32>"],["vec2<bool>"],["vec3<bool>"],["vec4<bool>"],["mat2x2f","mat2x2<f32>"],["mat3x3f","mat3x3<f32>"],["mat4x4f","mat4x4<f32>"],["texture_2d<f32>"],["texture_cube<f32>"],["array<f32>"],["texture_depth_2d"],["texture_depth_cube"],["texture_3d<f32>"],["array<vec2<f32>>"],["array<vec3<f32>>"],["array<vec4<f32>>"],["array<mat4x4<f32>>"],["texture_2d_array<f32>"],["u32"],["vec2u","vec2<u32>"],["vec3u","vec3<u32>"],["vec4u","vec4<u32>"],["array<i32>"],["array<u32>"],["array<bool>"],["array<vec2i>","array<vec2<i32>>"],["array<vec2u>","array<vec2<u32>>"],["array<vec2b>","array<vec2<bool>>"],["array<vec3i>","array<vec3<i32>>"],["array<vec3u>","array<vec3<u32>>"],["array<vec3b>","array<vec3<bool>>"],["array<vec4i>","array<vec4<i32>>"],["array<vec4u>","array<vec4<u32>>"],["array<vec4b>","array<vec4<bool>>"],["texture_2d<i32>"],["texture_2d<u32>"],["texture_cube<i32>"],["texture_cube<u32>"],["texture_3d<i32>"],["texture_3d<u32>"],["texture_2d_array<i32>"],["texture_2d_array<u32>"]],tk=new Map;tU.forEach((e,t)=>{e.forEach(e=>tk.set(e,t));});let tz=new Uint8Array([4,4,6,6,6,6,4,4,4,4,4,4,6,6,6,4,4,6,4,4,4,6,6,6,6,4,5,5,5,5,4,5,4,4,5,4,4,5,4,4,5,4,4,5,4,5,4,5,4,5]),tV="webgl2",tG="webgpu",tH="null",tW="ldr_srgb",tX=["view","mesh","mesh_ub"],tY="default",tj="_unused_float_uniform",tq=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Uint16Array],tK=[1,1,2,2,4,4,4,2],tZ=[Uint8Array,Uint16Array,Uint32Array],tQ=[1,2,4],tJ={};tJ[e2]=0,tJ[e3]=1,tJ[e5]=2,tJ[e6]=3,tJ[e8]=4,tJ[e7]=5,tJ[te]=6,tJ[tt]=7,tJ[ts]=8,tJ[ti]=9,tJ[tn]=10,tJ[tr]=11,tJ[ta]=12,tJ[e4]=13,tJ[to]=0,tJ[tl]=1,tJ[th]=2,tJ[td]=3,tJ[tc]=4,tJ[tu]=5,tJ[tp]=6,tJ[tf]=7,tJ[tm]=8,tJ[t_]=9,tJ[tg]=10,tJ[tv]=11,tJ[ty]=12,tJ[tS]=13,tJ[tx]=14,tJ[tT]=15;let t$="1.65",t0=0;class t1{constructor(e,t){this.slot=-1,this.scopeId=null,this.name=e,this.visibility=t;}}class t2 extends t1{}class t3 extends t1{constructor(e,t,s=false){super(e,t),this.format="",this.readOnly=s;}}class t4 extends t1{constructor(e,t,s="2d",i=0,n=true,r=null){super(e,t),this.textureDimension=s,this.sampleType=i,this.hasSampler=n,this.samplerName=null!=r?r:""+e+"_sampler";}}class t5 extends t1{constructor(e,t=7,s="2d",i=true,n=false){super(e,4),this.format=t,this.textureDimension=s,this.write=i,this.read=n;}}class t6{destroy(){this.impl.destroy();}getTexture(e){let t=this.textureFormatsMap.get(e);return void 0!==t?this.textureFormats[t]:null}getStorageTexture(e){let t=this.storageTextureFormatsMap.get(e);return void 0!==t?this.storageTextureFormats[t]:null}loseContext(){}constructor(e,t){this.uniformBufferFormats=[],this.textureFormats=[],this.storageTextureFormats=[],this.storageBufferFormats=[],this.id=t0++;let s=0;t.forEach(e=>{e.slot=s++,e instanceof t4&&e.hasSampler&&s++,e instanceof t2?this.uniformBufferFormats.push(e):e instanceof t4?this.textureFormats.push(e):e instanceof t5?this.storageTextureFormats.push(e):e instanceof t3&&this.storageBufferFormats.push(e);}),this.device=e;let i=e.scope;this.bufferFormatsMap=new Map,this.uniformBufferFormats.forEach((e,t)=>this.bufferFormatsMap.set(e.name,t)),this.textureFormatsMap=new Map,this.textureFormats.forEach((e,t)=>{this.textureFormatsMap.set(e.name,t),e.scopeId=i.resolve(e.name);}),this.storageTextureFormatsMap=new Map,this.storageTextureFormats.forEach((e,t)=>{this.storageTextureFormatsMap.set(e.name,t),e.scopeId=i.resolve(e.name);}),this.storageBufferFormatsMap=new Map,this.storageBufferFormats.forEach((e,t)=>{this.storageBufferFormatsMap.set(e.name,t),e.scopeId=i.resolve(e.name);}),this.impl=e.createBindGroupFormatImpl(this);}}class t8{get(e,t){return this._cache.has(e)||(this._cache.set(e,t()),e.on("destroy",()=>{this.remove(e);}),e.on("devicelost",()=>{var t,s;null==(s=this._cache.get(e))||null==(t=s.loseContext)||t.call(s,e);})),this._cache.get(e)}remove(e){var t,s;null==(s=this._cache.get(e))||null==(t=s.destroy)||t.call(s,e),this._cache.delete(e);}constructor(){this._cache=new Map;}}class t9{static calcLevelDimension(e,t){return Math.max(e>>t,1)}static calcMipLevelsCount(e,t,s){return void 0===s&&(s=1),1+Math.floor(Math.log2(Math.max(e,t,s)))}static calcLevelGpuSize(e,t,s,i){var n,r,a;let o=eq.get(i),l=null!=(r=null==(n=eq.get(i))?void 0:n.size)?r:0;if(l>0)return e*t*s*l;let h=null!=(a=o.blockSize)?a:0,d=Math.floor((e+3)/4),c=Math.floor((t+3)/4),u=Math.floor((s+3)/4);return (24===i||25===i)&&(d=Math.max(Math.floor(d/2),1)),d*c*u*h}static calcGpuSize(e,t,s,i,n,r){let a=0;for(;a+=t9.calcLevelGpuSize(e,t,s,i),n&&(1!==e||1!==t||1!==s);)e=Math.max(e>>1,1),t=Math.max(t>>1,1),s=Math.max(s>>1,1);return a*(r?6:1)}}let t7=0;class se{destroy(){let e=this.device;if(e){let t=e.textures.indexOf(this);-1!==t&&e.textures.splice(t,1),e.scope.removeValue(this),this.impl.destroy(e),this.adjustVramSizeTracking(e._vram,-this._gpuSize),this._levels=null,this.device=null;}}recreateImpl(e){var t;void 0===e&&(e=true);let{device:s}=this;null==(t=this.impl)||t.destroy(s),this.impl=null,this.impl=s.createTextureImpl(this),this.dirtyAll(),e&&this.upload();}resize(e,t,s){ void 0===s&&(s=1);let i=this.device;this.adjustVramSizeTracking(i._vram,-this._gpuSize),this.impl.destroy(i),this._width=Math.floor(e),this._height=Math.floor(t),this._depth=Math.floor(s),this._updateNumLevel(),this.impl=i.createTextureImpl(this),this.dirtyAll();}loseContext(){this.impl.loseContext(),this.dirtyAll();}adjustVramSizeTracking(e,t){e.tex+=t;}propertyChanged(e){this.impl.propertyChanged(e),this.renderVersionDirty=this.device.renderVersion;}_updateNumLevel(){let e=this.mipmaps?t9.calcMipLevelsCount(this.width,this.height):1,t=this._numLevelsRequested;this._numLevels=Math.min(null!=t?t:e,e),this._mipmaps=this._numLevels>1;}get lockedMode(){return this._lockedMode}set minFilter(e){this._minFilter!==e&&(eQ(this._format)||(this._minFilter=e,this.propertyChanged(1)));}get minFilter(){return this._minFilter}set magFilter(e){this._magFilter!==e&&(eQ(this._format)||(this._magFilter=e,this.propertyChanged(2)));}get magFilter(){return this._magFilter}set addressU(e){this._addressU!==e&&(this._addressU=e,this.propertyChanged(4));}get addressU(){return this._addressU}set addressV(e){this._addressV!==e&&(this._addressV=e,this.propertyChanged(8));}get addressV(){return this._addressV}set addressW(e){this._volume&&e!==this._addressW&&(this._addressW=e,this.propertyChanged(16));}get addressW(){return this._addressW}set compareOnRead(e){this._compareOnRead!==e&&(this._compareOnRead=e,this.propertyChanged(32));}get compareOnRead(){return this._compareOnRead}set compareFunc(e){this._compareFunc!==e&&(this._compareFunc=e,this.propertyChanged(64));}get compareFunc(){return this._compareFunc}set anisotropy(e){this._anisotropy!==e&&(this._anisotropy=e,this.propertyChanged(128));}get anisotropy(){return this._anisotropy}set mipmaps(e){this._mipmaps!==e&&(this.device.isWebGPU||eQ(this._format)||(this._mipmaps=e),e&&(this._needsMipmapsUpload=true));}get mipmaps(){return this._mipmaps}get numLevels(){return this._numLevels}get storage(){return this._storage}get width(){return this._width}get height(){return this._height}get depth(){return this._depth}get format(){return this._format}get cubemap(){return this._cubemap}get gpuSize(){let e=this.pot&&this._mipmaps&&!(this._compressed&&1===this._levels.length);return t9.calcGpuSize(this._width,this._height,this._depth,this._format,e,this._cubemap)}get array(){return this._arrayLength>0}get arrayLength(){return this._arrayLength}get volume(){return this._volume}set type(e){this._type!==e&&(this._type=e,this.device._shadersDirty=true);}get type(){return this._type}set srgb(e){if(e!==eZ(this.format)){if(e){let e=eJ(this.format);this._format!==e&&(this._format=e,this.recreateImpl(),this.device._shadersDirty=true);}else {let e=e$(this.format);this._format!==e&&(this._format=e,this.recreateImpl(),this.device._shadersDirty=true);}}}get srgb(){return eZ(this.format)}set flipY(e){this._flipY!==e&&(this._flipY=e,this._needsUpload=true);}get flipY(){return this._flipY}set premultiplyAlpha(e){this._premultiplyAlpha!==e&&(this._premultiplyAlpha=e,this._needsUpload=true);}get premultiplyAlpha(){return this._premultiplyAlpha}get pot(){return ei.powerOfTwo(this._width)&&ei.powerOfTwo(this._height)}get encoding(){switch(this.type){case tE:return "rgbm";case tA:return "rgbe";case tw:return "rgbp"}return e0(this.format)?"srgb":"linear"}dirtyAll(){this._levelsUpdated=this._cubemap?[[true,true,true,true,true,true]]:[true],this._needsUpload=true,this._needsMipmapsUpload=this._mipmaps,this._mipmapsUploaded=false,this.propertyChanged(255);}lock(e){var t,s,i;void 0===e&&(e={}),null!=(t=e).level||(t.level=0),null!=(s=e).face||(s.face=0),null!=(i=e).mode||(i.mode=2),this._lockedMode=e.mode,this._lockedLevel=e.level;let o=this.cubemap?this._levels[e.face]:this._levels;if(null===o[e.level]){let t=Math.max(1,this._width>>e.level),s=Math.max(1,this._height>>e.level),i=Math.max(1,this._depth>>e.level),n=new ArrayBuffer(t9.calcLevelGpuSize(t,s,i,this._format));o[e.level]=new(e1(this._format))(n);}return o[e.level]}setSource(e,t){let s,i;void 0===t&&(t=0);let n=false;if(this._cubemap){if(e[0]){s=e[0].width||0,i=e[0].height||0;for(let t=0;t<6;t++){let r=e[t];if(!r||r.width!==s||r.height!==i||!this.device._isBrowserInterface(r)){n=true;break}}}else n=true;if(!n)for(let s=0;s<6;s++)this._levels[t][s]!==e[s]&&(this._levelsUpdated[t][s]=true);}else this.device._isBrowserInterface(e)||(n=true),n||(e!==this._levels[t]&&(this._levelsUpdated[t]=true),e instanceof HTMLVideoElement?(s=e.videoWidth,i=e.videoHeight):(s=e.width,i=e.height));if(n){if(this._width=4,this._height=4,this._cubemap)for(let e=0;e<6;e++)this._levels[t][e]=null,this._levelsUpdated[t][e]=true;else this._levels[t]=null,this._levelsUpdated[t]=true;}else 0===t&&(this._width=s,this._height=i),this._levels[t]=e;this._invalid===n&&n||(this._invalid=n,this.upload());}getSource(e){return void 0===e&&(e=0),this._levels[e]}unlock(){this._lockedMode,2===this._lockedMode&&this.upload(),this._lockedLevel=-1,this._lockedMode=0;}upload(){this._needsUpload=true,this._needsMipmapsUpload=this._mipmaps,null==this.impl.uploadImmediate||this.impl.uploadImmediate.call(this.impl,this.device,this);}read(e,t,s,i,n){return void 0===n&&(n={}),null==this.impl.read?void 0:this.impl.read.call(this.impl,e,t,s,i,n)}constructor(e,t={}){var s,i,n,r,a,o,l,h,d,c,u,p,f,m,_,g,v,y,S,x;this._gpuSize=0,this.id=t7++,this._invalid=false,this._lockedLevel=-1,this._lockedMode=0,this.renderVersionDirty=0,this._storage=false,this._numLevels=0,this.device=e,this.name=null!=(s=t.name)?s:"",this._width=Math.floor(null!=(i=t.width)?i:4),this._height=Math.floor(null!=(n=t.height)?n:4),this._format=null!=(r=t.format)?r:7,this._compressed=eK(this._format),this._integerFormat=eQ(this._format),this._integerFormat&&(t.minFilter=0,t.magFilter=0),this._volume=null!=(a=t.volume)&&a,this._depth=Math.floor(null!=(o=t.depth)?o:1),this._arrayLength=Math.floor(null!=(l=t.arrayLength)?l:0),this._storage=null!=(h=t.storage)&&h,this._cubemap=null!=(d=t.cubemap)&&d,this._flipY=null!=(c=t.flipY)&&c,this._premultiplyAlpha=null!=(u=t.premultiplyAlpha)&&u,this._mipmaps=null==(p=t.mipmaps)||p,this._numLevelsRequested=t.numLevels,void 0!==t.numLevels&&(this._numLevels=t.numLevels),this._updateNumLevel(),this._minFilter=null!=(f=t.minFilter)?f:5,this._magFilter=null!=(m=t.magFilter)?m:1,this._anisotropy=null!=(_=t.anisotropy)?_:1,this._addressU=null!=(g=t.addressU)?g:0,this._addressV=null!=(v=t.addressV)?v:0,this._addressW=null!=(y=t.addressW)?y:0,this._compareOnRead=null!=(S=t.compareOnRead)&&S,this._compareFunc=null!=(x=t.compareFunc)?x:1,this._type=t.hasOwnProperty("type")?t.type:tb,this.projection=tR,this._cubemap?this.projection=tL:t.projection&&t.projection!==tL&&(this.projection=t.projection),this._levels=t.levels;let T=!!t.levels;this._levels||(this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null]),this.recreateImpl(T),e.textures.push(this);}}let st={white:[255,255,255,255],gray:[128,128,128,255],black:[0,0,0,255],normal:[128,128,255,255],pink:[255,128,255,255]};class ss{destroy(){this.map.forEach(e=>{e.destroy();});}constructor(){this.map=new Map;}}let si=new t8,sn=(e,t)=>{let s=si.get(e,()=>new ss);if(!s.map.has(t)){let i=new se(e,{name:"built-in-texture-"+t,width:1,height:1,format:7}),n=i.lock(),r=st[t];n.set(r),i.unlock(),s.map.set(t,i);}return s.map.get(t)},sr=0;class sa{constructor(){this.offsets=[];}}class so{destroy(){this.impl.destroy(),this.impl=null,this.format=null,this.defaultUniformBuffer=null;}setUniformBuffer(e,t){let s=this.format.bufferFormatsMap.get(e);this.uniformBuffers[s]!==t&&(this.uniformBuffers[s]=t,this.dirty=true);}setStorageBuffer(e,t){let s=this.format.storageBufferFormatsMap.get(e);this.storageBuffers[s]!==t&&(this.storageBuffers[s]=t,this.dirty=true);}setTexture(e,t){let s=this.format.textureFormatsMap.get(e);this.textures[s]!==t?(this.textures[s]=t,this.dirty=true):this.renderVersionUpdated<t.renderVersionDirty&&(this.dirty=true);}setStorageTexture(e,t){let s=this.format.storageTextureFormatsMap.get(e);this.storageTextures[s]!==t?(this.storageTextures[s]=t,this.dirty=true):this.renderVersionUpdated<t.renderVersionDirty&&(this.dirty=true);}updateUniformBuffers(){for(let e=0;e<this.uniformBuffers.length;e++)this.uniformBuffers[e].update();}update(){let{textureFormats:e,storageTextureFormats:t,storageBufferFormats:s}=this.format;for(let t=0;t<e.length;t++){let s=e[t],i=s.scopeId.value;i||("uSceneDepthMap"===s.name&&(i=sn(this.device,"white")),"uSceneColorMap"===s.name&&(i=sn(this.device,"pink")),i||(i=sn(this.device,"pink"))),this.setTexture(s.name,i);}for(let e=0;e<t.length;e++){let s=t[e],i=s.scopeId.value;this.setStorageTexture(s.name,i);}for(let e=0;e<s.length;e++){let t=s[e],i=t.scopeId.value;this.setStorageBuffer(t.name,i);}this.uniformBufferOffsets.length=this.uniformBuffers.length;for(let e=0;e<this.uniformBuffers.length;e++){let t=this.uniformBuffers[e];this.uniformBufferOffsets[e]=t.offset,this.renderVersionUpdated<t.renderVersionDirty&&(this.dirty=true);}this.dirty&&(this.dirty=false,this.renderVersionUpdated=this.device.renderVersion,this.impl.update(this));}constructor(e,t,s){this.renderVersionUpdated=-1,this.uniformBufferOffsets=[],this.id=sr++,this.device=e,this.format=t,this.dirty=true,this.impl=e.createBindGroupImpl(this),this.textures=[],this.storageTextures=[],this.storageBuffers=[],this.uniformBuffers=[],this.defaultUniformBuffer=s,s&&this.setUniformBuffer(tY,s);}}let sl={set:(e,t,s,i)=>(void 0===i&&(i=1),e&~(i<<s)|t<<s),get:(e,t,s)=>(void 0===s&&(s=1),e>>t&s),all(e,t,s){ void 0===s&&(s=1);let i=s<<t;return (e&i)===i},any:(e,t,s)=>(void 0===s&&(s=1),(e&s<<t)!=0)};class sh{set blend(e){this.target0=sl.set(this.target0,+!!e,26);}get blend(){return sl.all(this.target0,26)}setColorBlend(e,t,s){this.target0=sl.set(this.target0,e,0,7),this.target0=sl.set(this.target0,t,3,15),this.target0=sl.set(this.target0,s,7,15);}setAlphaBlend(e,t,s){this.target0=sl.set(this.target0,e,11,7),this.target0=sl.set(this.target0,t,14,15),this.target0=sl.set(this.target0,s,18,15);}setColorWrite(e,t,s,i){this.redWrite=e,this.greenWrite=t,this.blueWrite=s,this.alphaWrite=i;}get colorOp(){return sl.get(this.target0,0,7)}get colorSrcFactor(){return sl.get(this.target0,3,15)}get colorDstFactor(){return sl.get(this.target0,7,15)}get alphaOp(){return sl.get(this.target0,11,7)}get alphaSrcFactor(){return sl.get(this.target0,14,15)}get alphaDstFactor(){return sl.get(this.target0,18,15)}set redWrite(e){this.target0=sl.set(this.target0,+!!e,22);}get redWrite(){return sl.all(this.target0,22)}set greenWrite(e){this.target0=sl.set(this.target0,+!!e,23);}get greenWrite(){return sl.all(this.target0,23)}set blueWrite(e){this.target0=sl.set(this.target0,+!!e,24);}get blueWrite(){return sl.all(this.target0,24)}set alphaWrite(e){this.target0=sl.set(this.target0,+!!e,25);}get alphaWrite(){return sl.all(this.target0,25)}get allWrite(){return sl.get(this.target0,22,15)}copy(e){return this.target0=e.target0,this}clone(){return new this.constructor().copy(this)}get key(){return this.target0}equals(e){return this.target0===e.target0}constructor(e=false,t=0,s=1,i=0,n,r,a,o=true,l=true,h=true,d=true){this.target0=0,this.setColorBlend(t,s,i),this.setAlphaBlend(null!=n?n:t,null!=r?r:s,null!=a?a:i),this.setColorWrite(o,l,h,d),this.blend=e;}}sh.NOBLEND=Object.freeze(new sh),sh.NOWRITE=Object.freeze(new sh(void 0,void 0,void 0,void 0,void 0,void 0,void 0,false,false,false,false)),sh.ALPHABLEND=Object.freeze(new sh(true,0,6,8)),sh.ADDBLEND=Object.freeze(new sh(true,0,1,1));class sd{get(e){let t=this.map.get(e);return void 0===t&&(t=this.id++,this.map.set(e,t)),t}constructor(){this.map=new Map,this.id=0;}}let sc=new sd;class su{set test(e){this.func=e?3:7,this.updateKey();}get test(){return 7!==this.func}set write(e){this.data=sl.set(this.data,+!!e,3),this.updateKey();}get write(){return sl.all(this.data,3)}set func(e){this.data=sl.set(this.data,e,0,7),this.updateKey();}get func(){return sl.get(this.data,0,7)}set depthBias(e){this._depthBias=e,this.updateKey();}get depthBias(){return this._depthBias}set depthBiasSlope(e){this._depthBiasSlope=e,this.updateKey();}get depthBiasSlope(){return this._depthBiasSlope}copy(e){return this.data=e.data,this._depthBias=e._depthBias,this._depthBiasSlope=e._depthBiasSlope,this.key=e.key,this}clone(){return new this.constructor().copy(this)}updateKey(){let{data:e,_depthBias:t,_depthBiasSlope:s}=this;this.key=sc.get(e+"-"+t+"-"+s);}equals(e){return this.key===e.key}constructor(e=3,t=true){this.data=0,this._depthBias=0,this._depthBiasSlope=0,this.key=0,this.func=e,this.write=t;}}su.DEFAULT=Object.freeze(new su),su.NODEPTH=Object.freeze(new su(7,false)),su.WRITEDEPTH=Object.freeze(new su(7,true));class sp{equals(e){return this.globalId===e.globalId&&this.revision===e.revision}copy(e){this.globalId=e.globalId,this.revision=e.revision;}reset(){this.globalId=0,this.revision=0;}constructor(){this.globalId=0,this.revision=0;}}let sf=0;class sm{increment(){this.version.revision++;}constructor(){sf++,this.version=new sp,this.version.globalId=sf;}}class s_{toJSON(e){}setValue(e){this.value=e,this.versionObject.increment();}getValue(){return this.value}constructor(e){this.name=e,this.value=null,this.versionObject=new sm;}}class sg{resolve(e){return this.variables.has(e)||this.variables.set(e,new s_(e)),this.variables.get(e)}removeValue(e){for(let t in this.variables){let s=this.variables[t];s.value===e&&(s.value=null);}}constructor(e){this.name=e,this.variables=new Map;}}let sv=0;class sy{destroy(){let e=this.device,t=e.buffers.indexOf(this);-1!==t&&e.buffers.splice(t,1),this.impl.initialized&&(this.impl.destroy(e),this.adjustVramSizeTracking(e._vram,-this.storage.byteLength));}adjustVramSizeTracking(e,t){e.vb+=t;}loseContext(){this.impl.loseContext();}getFormat(){return this.format}getUsage(){return this.usage}getNumVertices(){return this.numVertices}lock(){return this.storage}unlock(){this.impl.unlock(this);}setData(e){return e.byteLength===this.numBytes&&(this.storage=e,this.unlock(),true)}constructor(e,t,s,i){var n;this.usage=0,this.usage=null!=(n=null==i?void 0:i.usage)?n:0,this.device=e,this.format=t,this.numVertices=s,this.id=sv++,this.impl=e.createVertexBufferImpl(this,t,i),this.numBytes=t.verticesByteSize?t.verticesByteSize:t.size*s,this.adjustVramSizeTracking(e._vram,this.numBytes);let r=null==i?void 0:i.data;r?this.setData(r):this.storage=new ArrayBuffer(this.numBytes),this.device.buffers.push(this);}}function sS(e){if(null==e)return 0;let t=0;for(let s=0,i=e.length;s<i;s++)t=(t<<5)-t+e.charCodeAt(s)|0;return t}function sx(e){let t=0x811c9dc5;for(let s=0;s<e.length;s++)t^=e[s],t*=0x1000193;return t>>>0}let sT=new sd,sb=[2,4,8,12,16],sE=new t8;class sA{get elements(){return this._elements}static getDefaultInstancingFormat(e){return sE.get(e,()=>new sA(e,[{semantic:ty,components:4,type:6},{semantic:tS,components:4,type:6},{semantic:tx,components:4,type:6},{semantic:tT,components:4,type:6}]))}static isElementValid(e,t){let s=t.components*tK[t.type];return !e.isWebGPU||!!sb.includes(s)}update(){this._evaluateHash();}_evaluateHash(){let e=[],t=[],s=this._elements.length;for(let i=0;i<s;i++){let{name:s,dataType:n,numComponents:r,normalize:a,offset:o,stride:l,size:h,asInt:d}=this._elements[i],c=s+n+r+a+d;e.push(c);let u=c+o+l+h;t.push(u);}e.sort();let i=e.join();this.batchingHash=sS(i),this.shaderProcessingHashString=i,this.renderingHashString=t.join("_"),this.renderingHash=sT.get(this.renderingHashString);}constructor(e,t,s){this.device=e,this._elements=[],this.hasUv0=false,this.hasUv1=false,this.hasColor=false,this.hasTangents=false,this.verticesByteSize=0,this.vertexCount=s,this.interleaved=void 0===s,this.instancing=false,this.size=t.reduce((e,t)=>e+4*Math.ceil(t.components*tK[t.type]/4),0);let i=0,n;for(let e=0,o=t.length;e<o;e++){var r,a;let o=t[e];n=o.components*tK[o.type],s&&(i=ei.roundUp(i,n));let l=null!=(r=o.asInt)&&r,h=!l&&null!=(a=o.normalize)&&a,d={name:o.semantic,offset:s?i:o.hasOwnProperty("offset")?o.offset:i,stride:s?n:o.hasOwnProperty("stride")?o.stride:this.size,dataType:o.type,numComponents:o.components,normalize:h,size:n,asInt:l};this._elements.push(d),s?i+=n*s:i+=4*Math.ceil(n/4),o.semantic===e7?this.hasUv0=true:o.semantic===te?this.hasUv1=true:o.semantic===e8?this.hasColor=true:o.semantic===e4&&(this.hasTangents=true);}s&&(this.verticesByteSize=i),this._evaluateHash();}}let sw=new sd;class sC{set func(e){this._func=e,this._dirty=true;}get func(){return this._func}set ref(e){this._ref=e,this._dirty=true;}get ref(){return this._ref}set fail(e){this._fail=e,this._dirty=true;}get fail(){return this._fail}set zfail(e){this._zfail=e,this._dirty=true;}get zfail(){return this._zfail}set zpass(e){this._zpass=e,this._dirty=true;}get zpass(){return this._zpass}set readMask(e){this._readMask=e,this._dirty=true;}get readMask(){return this._readMask}set writeMask(e){this._writeMask=e,this._dirty=true;}get writeMask(){return this._writeMask}_evalKey(){let{_func:e,_ref:t,_fail:s,_zfail:i,_zpass:n,_readMask:r,_writeMask:a}=this,o=e+","+t+","+s+","+i+","+n+","+r+","+a;this._key=sw.get(o),this._dirty=false;}get key(){return this._dirty&&this._evalKey(),this._key}copy(e){return this._func=e._func,this._ref=e._ref,this._readMask=e._readMask,this._writeMask=e._writeMask,this._fail=e._fail,this._zfail=e._zfail,this._zpass=e._zpass,this._dirty=e._dirty,this._key=e._key,this}clone(){return new this.constructor().copy(this)}constructor(e={}){var t,s,i,n,r,a,o;this._dirty=true,this._func=null!=(t=e.func)?t:7,this._ref=null!=(s=e.ref)?s:0,this._readMask=null!=(i=e.readMask)?i:255,this._writeMask=null!=(n=e.writeMask)?n:255,this._fail=null!=(r=e.fail)?r:0,this._zfail=null!=(a=e.zfail)?a:0,this._zpass=null!=(o=e.zpass)?o:0,this._evalKey();}}function sP(){return (sP=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i]);}return e}).apply(this,arguments)}sC.DEFAULT=Object.freeze(new sC);class sM extends Y{postInit(){let e=new sA(this,[{semantic:e2,components:2,type:6}]),t=new Float32Array([-1,-1,1,-1,-1,1,1,1]);this.quadVertexBuffer=new sy(this,e,4,{data:t});}initCapsDefines(){let{capsDefines:e}=this;e.clear(),this.textureFloatFilterable&&e.set("CAPS_TEXTURE_FLOAT_FILTERABLE",""),this.textureFloatRenderable&&e.set("CAPS_TEXTURE_FLOAT_RENDERABLE","");}destroy(){var e,t,s;this.fire("destroy"),null==(e=this.quadVertexBuffer)||e.destroy(),this.quadVertexBuffer=null,null==(t=this.dynamicBuffers)||t.destroy(),this.dynamicBuffers=null,null==(s=this.gpuProfiler)||s.destroy(),this.gpuProfiler=null;}onDestroyShader(e){this.fire("destroy:shader",e);let t=this.shaders.indexOf(e);-1!==t&&this.shaders.splice(t,1);}postDestroy(){this.scope=null,this.canvas=null;}loseContext(){var e;for(let e of(this.contextLost=true,this.backBufferSize.set(-1,-1),this.textures))e.loseContext();for(let e of this.buffers)e.loseContext();for(let e of this.targets)e.loseContext();null==(e=this.gpuProfiler)||e.loseContext();}restoreContext(){var e,t;for(let e of(this.contextLost=false,this.initializeRenderState(),this.initializeContextCaches(),this.buffers))e.unlock();null==(t=this.gpuProfiler)||null==(e=t.restoreContext)||e.call(t);}toJSON(e){}initializeContextCaches(){this.indexBuffer=null,this.vertexBuffers=[],this.shader=null,this.shaderValid=void 0,this.shaderAsyncCompile=false,this.renderTarget=null;}initializeRenderState(){this.blendState=new sh,this.depthState=new su,this.cullMode=1,this.vx=this.vy=this.vw=this.vh=0,this.sx=this.sy=this.sw=this.sh=0,this.blendColor=new en(0,0,0,0);}setStencilState(e,t){}setBlendState(e){}setBlendColor(e,t,s,i){}setDepthState(e){}setCullMode(e){}setRenderTarget(e){this.renderTarget=e;}setIndexBuffer(e){this.indexBuffer=e;}setVertexBuffer(e){e&&this.vertexBuffers.push(e);}clearVertexBuffer(){this.vertexBuffers.length=0;}clearIndexBuffer(){this.indexBuffer=null;}getRenderTarget(){return this.renderTarget}initRenderTarget(e){e.initialized||(e.init(),this.targets.add(e));}_isBrowserInterface(e){return this._isImageBrowserInterface(e)||this._isImageCanvasInterface(e)||this._isImageVideoInterface(e)}_isImageBrowserInterface(e){return "undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement}_isImageCanvasInterface(e){return "undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement}_isImageVideoInterface(e){return "undefined"!=typeof HTMLVideoElement&&e instanceof HTMLVideoElement}resizeCanvas(e,t){let s=Math.min(this._maxPixelRatio,k.browser?window.devicePixelRatio:1),i=Math.floor(e*s),n=Math.floor(t*s);(i!==this.canvas.width||n!==this.canvas.height)&&this.setResolution(i,n);}setResolution(e,t){this.canvas.width=e,this.canvas.height=t,this.fire(sM.EVENT_RESIZE,e,t);}updateClientRect(){if(k.worker)this.clientRect.width=this.canvas.width,this.clientRect.height=this.canvas.height;else {let e=this.canvas.getBoundingClientRect();this.clientRect.width=e.width,this.clientRect.height=e.height;}}get width(){return this.canvas.width}get height(){return this.canvas.height}set fullscreen(e){}get fullscreen(){return  false}set maxPixelRatio(e){this._maxPixelRatio=e;}get maxPixelRatio(){return this._maxPixelRatio}get deviceType(){return this._deviceType}startRenderPass(e){}endRenderPass(e){}startComputePass(e){}endComputePass(){}frameStart(){this.renderPassIndex=0,this.renderVersion++;}frameEnd(){}computeDispatch(e,t){}getRenderableHdrFormat(e,t,s){ void 0===e&&(e=[18,12,14]),void 0===t&&(t=true),void 0===s&&(s=1);for(let i=0;i<e.length;i++){let n=e[i];switch(n){case 18:if(this.textureRG11B10Renderable)return n;break;case 12:if(this.textureHalfFloatRenderable)return n;break;case 14:if(this.isWebGPU&&s>1)continue;if(this.textureFloatRenderable&&(!t||this.textureFloatFilterable))return n}}}validateAttributes(e,t,s){}constructor(e,t){var s,i,n,r,a,o;super(),this.backBuffer=null,this.backBufferSize=new ef,this.backBufferAntialias=false,this.isWebGPU=false,this.isWebGL2=false,this.isHdr=false,this.maxColorAttachments=1,this.maxSamples=1,this.supportsCompute=false,this.supportsStorageTextureRead=false,this.renderTarget=null,this.shaders=[],this.textures=[],this.targets=new Set,this.renderVersion=0,this.insideRenderPass=false,this.supportsUniformBuffers=false,this.supportsClipDistances=false,this.textureRG11B10Renderable=false,this.textureFloatFilterable=false,this.blendState=new sh,this.depthState=new su,this.stencilEnabled=false,this.stencilFront=new sC,this.stencilBack=new sC,this.defaultClearOptions={color:[0,0,0,1],depth:1,stencil:0,flags:3},this.clientRect={width:0,height:0},this._shadersDirty=false,this.capsDefines=new Map,this.canvas=e,"setAttribute"in e&&e.setAttribute("data-engine","PlayCanvas "+A),this.initOptions=sP({},t),null!=(s=this.initOptions).alpha||(s.alpha=true),null!=(i=this.initOptions).depth||(i.depth=true),null!=(n=this.initOptions).stencil||(n.stencil=true),null!=(r=this.initOptions).antialias||(r.antialias=true),null!=(a=this.initOptions).powerPreference||(a.powerPreference="high-performance"),null!=(o=this.initOptions).displayFormat||(o.displayFormat="ldr"),this._maxPixelRatio=k.browser?Math.min(1,window.devicePixelRatio):1,this.buffers=[],this._vram={tex:0,vb:0,ib:0,ub:0,sb:0},this._shaderStats={vsCompiled:0,fsCompiled:0,linked:0,materialShaders:0,compileTime:0},this.initializeContextCaches(),this._drawCallsPerFrame=0,this._shaderSwitchesPerFrame=0,this._primsPerFrame=[];for(let e=0;e<=6;e++)this._primsPerFrame[e]=0;this._renderTargetCreationTime=0,this.scope=new sg("Device"),this.textureBias=this.scope.resolve("textureBias"),this.textureBias.setValue(0);}}sM.EVENT_RESIZE="resizecanvas";let sI=0;class sR{destroy(){let e=this._device;e&&(e.targets.delete(this),e.renderTarget===this&&e.setRenderTarget(null),this.destroyFrameBuffers());}destroyFrameBuffers(){let e=this._device;e&&this.impl.destroy(e);}destroyTextureBuffers(){var e,t;null==(e=this._depthBuffer)||e.destroy(),this._depthBuffer=null,null==(t=this._colorBuffers)||t.forEach(e=>{e.destroy();}),this._colorBuffers=null,this._colorBuffer=null;}resize(e,t){if(this.width!==e||this.height!==t){var s,i;if(this.mipLevel>0)return;let n=this._device;this.destroyFrameBuffers(),n.renderTarget===this&&n.setRenderTarget(null),null==(s=this._depthBuffer)||s.resize(e,t),null==(i=this._colorBuffers)||i.forEach(s=>{s.resize(e,t);}),this.validateMrt(),this.impl=n.createRenderTargetImpl(this);}}validateMrt(){}init(){this.impl.init(this._device,this);}get initialized(){return this.impl.initialized}get device(){return this._device}loseContext(){this.impl.loseContext();}resolve(e,t){ void 0===e&&(e=true),void 0===t&&(t=!!this._depthBuffer),this._device&&this._samples>1&&this.impl.resolve(this._device,this,e,t);}copy(e,t,s){if(!this._device){if(!e._device)return  false;this._device=e._device;}return this._device.copyRenderTarget(e,this,t,s)}get samples(){return this._samples}get depth(){return this._depth}get stencil(){return this._stencil}get colorBuffer(){return this._colorBuffer}getColorBuffer(e){var t;return null==(t=this._colorBuffers)?void 0:t[e]}get depthBuffer(){return this._depthBuffer}get face(){return this._face}get mipLevel(){return this._mipLevel}get mipmaps(){return this._mipmaps}get width(){var e,t;let s=(null==(e=this._colorBuffer)?void 0:e.width)||(null==(t=this._depthBuffer)?void 0:t.width)||this._device.width;return this._mipLevel>0&&(s=t9.calcLevelDimension(s,this._mipLevel)),s}get height(){var e,t;let s=(null==(e=this._colorBuffer)?void 0:e.height)||(null==(t=this._depthBuffer)?void 0:t.height)||this._device.height;return this._mipLevel>0&&(s=t9.calcLevelDimension(s,this._mipLevel)),s}isColorBufferSrgb(e){if(void 0===e&&(e=0),this.device.backBuffer===this)return eZ(this.device.backBufferFormat);let t=this.getColorBuffer(e);return !!t&&eZ(t.format)}constructor(e={}){var t,s,i,n,r,a,o,l,h,d,c,u,p,f,m;this.id=sI++;let _=null!=(a=null!=(r=null!=(n=null==(t=e.colorBuffer)?void 0:t.device)?n:null==(s=e.colorBuffers)?void 0:s[0].device)?r:null==(i=e.depthBuffer)?void 0:i.device)?a:e.graphicsDevice;this._device=_;let{maxSamples:g}=this._device;if(this._samples=Math.min(null!=(o=e.samples)?o:1,g),_.isWebGPU&&(this._samples=this._samples>1?g:1),this._colorBuffer=e.colorBuffer,e.colorBuffer&&(this._colorBuffers=[e.colorBuffer]),this._depthBuffer=e.depthBuffer,this._face=null!=(l=e.face)?l:0,this._depthBuffer){let e=this._depthBuffer._format;16===e||69===e?(this._depth=true,this._stencil=false):17===e?(this._depth=true,this._stencil=true):(15===e&&this._depthBuffer.device.isWebGPU&&this._samples>1?this._depth=true:this._depth=false,this._stencil=false);}else this._depth=null==(h=e.depth)||h,this._stencil=null!=(d=e.stencil)&&d;e.colorBuffers&&!this._colorBuffers&&(this._colorBuffers=[...e.colorBuffers],this._colorBuffer=e.colorBuffers[0]),this.autoResolve=null==(c=e.autoResolve)||c,this.name=e.name,this.name||(this.name=null==(u=this._colorBuffer)?void 0:u.name),this.name||(this.name=null==(p=this._depthBuffer)?void 0:p.name),this.name||(this.name="Untitled"),this.flipY=null!=(f=e.flipY)&&f,this._mipLevel=null!=(m=e.mipLevel)?m:0,this._mipLevel>0&&this._depth&&(this._mipLevel=0),this._mipmaps=void 0===e.mipLevel,this.validateMrt(),this.impl=_.createRenderTargetImpl(this);}}class sL{update(e){this.destroy();let t=e.device,s=this.createDescriptor(t,e);this.bindGroup=t.wgpu.createBindGroup(s);}destroy(){this.bindGroup=null;}createDescriptor(e,t){let s=[],i=t.format,n=t.format.uniformBufferFormats;t.uniformBuffers.forEach((e,t)=>{let i=n[t].slot,r=e.persistent?e.impl.buffer:e.allocation.gpuBuffer.buffer;s.push({binding:i,resource:{buffer:r,offset:0,size:e.format.byteSize}});});let r=t.format.textureFormats;t.textures.forEach((t,n)=>{let a=t.impl,o=i.textureFormats[n],l=r[n].slot,h=a.getView(e);if(s.push({binding:l,resource:h}),o.hasSampler){let t=a.getSampler(e,o.sampleType);s.push({binding:l+1,resource:t});}});let a=t.format.storageTextureFormats;t.storageTextures.forEach((t,i)=>{let n=t.impl,r=a[i].slot,o=n.getView(e);s.push({binding:r,resource:o});});let o=t.format.storageBufferFormats;return t.storageBuffers.forEach((e,t)=>{let i=e.impl.buffer,n=o[t].slot;s.push({binding:n,resource:{buffer:i}});}),{layout:t.format.impl.bindGroupLayout,entries:s}}}class sD{static shaderStage(e){let t=0;return 1&e&&(t|=GPUShaderStage.VERTEX),2&e&&(t|=GPUShaderStage.FRAGMENT),4&e&&(t|=GPUShaderStage.COMPUTE),t}}let sO=[];sO[0]="",sO[1]="",sO[2]="",sO[52]="r8unorm",sO[53]="rg8unorm",sO[3]="",sO[4]="",sO[5]="",sO[6]="rgba8unorm",sO[7]="rgba8unorm",sO[8]="bc1-rgba-unorm",sO[9]="bc2-rgba-unorm",sO[10]="bc3-rgba-unorm",sO[11]="",sO[12]="rgba16float",sO[50]="r16float",sO[51]="rg16float",sO[13]="",sO[14]="rgba32float",sO[15]="r32float",sO[16]="depth32float",sO[69]="depth16unorm",sO[17]="depth24plus-stencil8",sO[18]="rg11b10ufloat",sO[19]="",sO[20]="rgba8unorm-srgb",sO[21]="",sO[22]="etc2-rgb8unorm",sO[23]="etc2-rgba8unorm",sO[24]="",sO[25]="",sO[26]="",sO[27]="",sO[28]="astc-4x4-unorm",sO[29]="",sO[30]="",sO[31]="bgra8unorm",sO[64]="bgra8unorm-srgb",sO[32]="r8sint",sO[33]="r8uint",sO[34]="r16sint",sO[35]="r16uint",sO[36]="r32sint",sO[37]="r32uint",sO[38]="rg8sint",sO[39]="rg8uint",sO[40]="rg16sint",sO[41]="rg16uint",sO[42]="rg32sint",sO[43]="rg32uint",sO[44]="rgba8sint",sO[45]="rgba8uint",sO[46]="rgba16sint",sO[47]="rgba16uint",sO[48]="rgba32sint",sO[49]="rgba32uint",sO[65]="bc6h-rgb-float",sO[66]="bc6h-rgb-ufloat",sO[67]="bc7-rgba-unorm",sO[54]="bc1-rgba-unorm-srgb",sO[55]="bc2-rgba-unorm-srgb",sO[56]="bc3-rgba-unorm-srgb",sO[61]="etc2-rgb8unorm-srgb",sO[62]="etc2-rgba8unorm-srgb",sO[68]="bc7-rgba-unorm-srgb",sO[63]="astc-4x4-unorm-srgb";let sF=[];sF[0]="filtering",sF[1]="non-filtering",sF[2]="comparison",sF[3]="comparison",sF[4]="comparison";let sN=[];sN[0]="float",sN[1]="unfilterable-float",sN[2]="depth",sN[3]="sint",sN[4]="uint";let sB=new sd;class sU{destroy(){this.bindGroupLayout=null;}loseContext(){}createDescriptor(e){let t=[],s="";return e.uniformBufferFormats.forEach(e=>{let i=sD.shaderStage(e.visibility);s+="#"+e.slot+"U:"+i,t.push({binding:e.slot,visibility:i,buffer:{type:"uniform",hasDynamicOffset:true}});}),e.textureFormats.forEach(e=>{let i=sD.shaderStage(e.visibility),n=e.sampleType,r=e.textureDimension,a=sN[n];if(s+="#"+e.slot+"T:"+i+"-"+a+"-"+r+"-false",t.push({binding:e.slot,visibility:i,texture:{sampleType:a,viewDimension:r,multisampled:false}}),e.hasSampler){let r=sF[n];s+="#"+(e.slot+1)+"S:"+i+"-"+r,t.push({binding:e.slot+1,visibility:i,sampler:{type:r}});}}),e.storageTextureFormats.forEach(e=>{let{format:i,textureDimension:n}=e,{read:r,write:a}=e;s+="#"+e.slot+"ST:"+i+"-"+n+"-"+(r?"r1":"r0")+"-"+(a?"w1":"w0"),t.push({binding:e.slot,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:r?a?"read-write":"read-only":"write-only",format:sO[i],viewDimension:n}});}),e.storageBufferFormats.forEach(e=>{let i=e.readOnly,n=sD.shaderStage(e.visibility);s+="#"+e.slot+"SB:"+n+"-"+(i?"ro":"rw"),t.push({binding:e.slot,visibility:n,buffer:{type:i?"read-only-storage":"storage"}});}),{key:s,desc:{entries:t}}}constructor(e){let t=e.device,{key:s,desc:i}=this.createDescriptor(e);this.key=sB.get(s),this.bindGroupLayout=t.wgpu.createBindGroupLayout(i);}}class sk{destroy(e){this.buffer&&(this.buffer.destroy(),this.buffer=null);}get initialized(){return !!this.buffer}loseContext(){}allocate(e,t){this.buffer=e.wgpu.createBuffer({size:t,usage:this.usageFlags});}unlock(e,t){var s,i;let n=e.wgpu;if(!this.buffer){let s=t.byteLength+3&-4;this.usageFlags|=GPUBufferUsage.COPY_DST,this.allocate(e,s);}let r=null!=(s=t.byteOffset)?s:0,a=new Uint8Array(null!=(i=t.buffer)?i:t,r,t.byteLength),o=new Uint8Array(this.buffer.size);o.set(a),n.queue.writeBuffer(this.buffer,0,o,0,o.length);}read(e,t,s,i){return e.readStorageBuffer(this,t,s,i)}write(e,t,s,i,n){e.writeStorageBuffer(this,t,s,i,n);}clear(e,t,s){e.clearStorageBuffer(this,t,s);}constructor(e=0){this.buffer=null,this.usageFlags=0,this.usageFlags=e;}}class sz extends sk{unlock(e){let t=e.device;super.unlock(t,e.storage);}constructor(e,t){super(16|128*(null!=t&&!!t.storage)),this.format=null,this.format=1===e.format?"uint16":"uint32";}}let sV={equals(e,t){if(e.length!==t.length)return  false;for(let s=0;s<e.length;s++)if(e[s]!==t[s])return  false;return  true}},sG=[];sG[0]="sint8",sG[1]="uint8",sG[2]="sint16",sG[3]="uint16",sG[4]="sint32",sG[5]="uint32",sG[6]="float32",sG[7]="float16";let sH=[];sH[0]="snorm8",sH[1]="unorm8",sH[2]="snorm16",sH[3]="unorm16",sH[4]="sint32",sH[5]="uint32",sH[6]="float32",sH[7]="float16";class sW{get(e,t){ void 0===t&&(t=null);let s=this.getKey(e,t),i=this.cache.get(s);return i||(i=this.create(e,t),this.cache.set(s,i)),i}getKey(e,t){return void 0===t&&(t=null),(null==e?void 0:e.renderingHashString)+"-"+(null==t?void 0:t.renderingHashString)}create(e,t){let s=[],i=e=>{let t=e.interleaved,i=e.instancing?"instance":"vertex",n=[],r=e.elements.length;for(let a=0;a<r;a++){let o=e.elements[a],l=tJ[o.name],h=o.normalize?sH:sG;n.push({shaderLocation:l,offset:t?o.offset:0,format:""+h[o.dataType]+(o.numComponents>1?"x"+o.numComponents:"")}),t&&a!==r-1||(s.push({attributes:n,arrayStride:o.stride,stepMode:i}),n=[]);}};return e&&i(e),t&&i(t),s}constructor(){this.cache=new Map;}}class sX{getPipelineLayout(e){let t=[];return e.forEach(e=>{t.push(e.bindGroupLayout);}),this.device.wgpu.createPipelineLayout({bindGroupLayouts:t})}constructor(e){this.device=e;}}let sY=["point-list","line-list",void 0,"line-strip","triangle-list","triangle-strip",void 0],sj=["add","subtract","reverse-subtract","min","max"],sq=["zero","one","src","one-minus-src","dst","one-minus-dst","src-alpha","src-alpha-saturated","one-minus-src-alpha","dst-alpha","one-minus-dst-alpha","constant","one-minus-constant"],sK=["never","less","equal","less-equal","greater","not-equal","greater-equal","always"],sZ=["none","back","front"],sQ=["keep","zero","replace","increment-clamp","increment-wrap","decrement-clamp","decrement-wrap","invert"],sJ=["","uint16","uint32"];class s${}class s0 extends sX{get(e,t,s,i,n,r,a,o,l,h,d,c,u){var p,f,m,_,g,v,y,S;let x=e.type;i&&3!==x&&5!==x&&(i=void 0);let T=this.lookupHashes;T[0]=x,T[1]=n.id,T[2]=h,T[3]=l.key,T[4]=o.key,T[5]=null!=(_=null==t?void 0:t.renderingHash)?_:0,T[6]=null!=(g=null==s?void 0:s.renderingHash)?g:0,T[7]=r.impl.key,T[8]=null!=(v=null==(p=a[0])?void 0:p.key)?v:0,T[9]=null!=(y=null==(f=a[1])?void 0:f.key)?y:0,T[10]=null!=(S=null==(m=a[2])?void 0:m.key)?S:0,T[11]=d?c.key:0,T[12]=d?u.key:0,T[13]=null!=i?i:0;let b=sx(T),E=this.cache.get(b);if(E)for(let e=0;e<E.length;e++){let t=E[e];if(sV.equals(t.hashes,T))return t.pipeline}let A=sY[x],w=this.getPipelineLayout(a),C=this.vertexBufferLayout.get(t,s),P=new s$;return P.hashes=new Uint32Array(T),P.pipeline=this.create(A,i,n,r,w,o,l,C,h,d,c,u),E?E.push(P):E=[P],this.cache.set(b,E),P.pipeline}getBlend(e){let t;return e.blend&&(t={color:{operation:sj[e.colorOp],srcFactor:sq[e.colorSrcFactor],dstFactor:sq[e.colorDstFactor]},alpha:{operation:sj[e.alphaOp],srcFactor:sq[e.alphaSrcFactor],dstFactor:sq[e.alphaDstFactor]}}),t}getDepthStencil(e,t,s,i,n){let r;let{depth:a,stencil:o}=t;return (a||o)&&(r={format:t.impl.depthAttachment.format},a?(r.depthWriteEnabled=e.write,r.depthCompare=sK[e.func],r.depthBias=e.depthBias,r.depthBiasSlopeScale=e.depthBiasSlope):(r.depthWriteEnabled=false,r.depthCompare="always"),o&&s&&(r.stencilReadMas=i.readMask,r.stencilWriteMask=i.writeMask,r.stencilFront={compare:sK[i.func],failOp:sQ[i.fail],passOp:sQ[i.zpass],depthFailOp:sQ[i.zfail]},r.stencilBack={compare:sK[n.func],failOp:sQ[n.fail],passOp:sQ[n.zpass],depthFailOp:sQ[n.zfail]})),r}create(e,t,s,i,n,r,a,o,l,h,d,c){let u=this.device.wgpu,p=s.impl,f={vertex:{module:p.getVertexShaderModule(),entryPoint:p.vertexEntryPoint,buffers:o},primitive:{topology:e,frontFace:"ccw",cullMode:sZ[l]},depthStencil:this.getDepthStencil(a,i,h,d,c),multisample:{count:i.samples},layout:n};t&&(f.primitive.stripIndexFormat=sJ[t]),f.fragment={module:p.getFragmentShaderModule(),entryPoint:p.fragmentEntryPoint,targets:[]};let m=i.impl.colorAttachments;if(m.length>0){let e=0;r.redWrite&&(e|=GPUColorWrite.RED),r.greenWrite&&(e|=GPUColorWrite.GREEN),r.blueWrite&&(e|=GPUColorWrite.BLUE),r.alphaWrite&&(e|=GPUColorWrite.ALPHA);let t=this.getBlend(r);m.forEach(s=>{f.fragment.targets.push({format:s.format,writeMask:e,blend:t});});}return u.createRenderPipeline(f)}constructor(e){super(e),this.lookupHashes=new Uint32Array(14),this.vertexBufferLayout=new sW,this.cache=new Map;}}class s1 extends sX{get(e,t){let s=this.getPipelineLayout([t.impl]);return this.create(e,s)}create(e,t){let s=this.device.wgpu,i=e.impl,n={compute:{module:i.getComputeShaderModule(),entryPoint:i.computeEntryPoint},layout:t};return s.createComputePipeline(n)}}class s2{incRefCount(){this._refCount++;}decRefCount(){this._refCount--;}get refCount(){return this._refCount}constructor(){this._refCount=0;}}class s3 extends s2{constructor(e){super(),this.object=e,this.incRefCount();}}class s4{destroy(){this.cache.forEach(e=>{var t;null==(t=e.object)||t.destroy();}),this.cache.clear();}clear(){this.cache.clear();}get(e){let t=this.cache.get(e);return t?(t.incRefCount(),t.object):null}set(e,t){this.cache.set(e,new s3(t));}release(e){let t=this.cache.get(e);if(t&&(t.decRefCount(),0===t.refCount)){var s;this.cache.delete(e),null==(s=t.object)||s.destroy();}}constructor(){this.cache=new Map;}}class s5 extends s4{loseContext(e){this.clear();}}let s6=new t8,s8=e=>s6.get(e,()=>new s5),s9=new sd;class s7{destroy(){var e;null==(e=this.multisampledBuffer)||e.destroy(),this.multisampledBuffer=null;}}class ie{destroy(e){if(this.depthTextureInternal){var t;null==(t=this.depthTexture)||t.destroy(),this.depthTexture=null;}this.multisampledDepthBuffer&&(this.multisampledDepthBuffer=null,s8(e).release(this.multisampledDepthBufferKey));}constructor(e){this.depthTexture=null,this.depthTextureInternal=false,this.multisampledDepthBuffer=null,this.format=e,this.hasStencil="depth24plus-stencil8"===e;}}class it{destroy(e){var t;this.initialized=false,this.assignedColorTexture=null,this.colorAttachments.forEach(e=>{e.destroy();}),this.colorAttachments.length=0,null==(t=this.depthAttachment)||t.destroy(e),this.depthAttachment=null;}updateKey(){let e=this.renderTarget.samples+":"+(this.depthAttachment?this.depthAttachment.format:"nodepth");this.colorAttachments.forEach(t=>{e+=":"+t.format;}),this.key=s9.get(e);}assignColorTexture(e,t){this.assignedColorTexture=t;let s=t.createView({format:e.backBufferViewFormat}),i=this.renderPassDescriptor.colorAttachments[0];this.renderTarget.samples>1?i.resolveTarget=s:i.view=s,this.setColorAttachment(0,void 0,e.backBufferViewFormat),this.updateKey();}setColorAttachment(e,t,s){this.colorAttachments[e]||(this.colorAttachments[e]=new s7),t&&(this.colorAttachments[e].multisampledBuffer=t),s&&(this.colorAttachments[e].format=s);}init(e,t){var s,i,n;let r=e.wgpu;this.initDepthStencil(e,r,t),t._colorBuffers&&t._colorBuffers.forEach((e,t)=>{this.setColorAttachment(t,void 0,e.impl.format);}),this.renderPassDescriptor.colorAttachments=[];let a=this.isBackbuffer?1:null!=(i=null==(s=t._colorBuffers)?void 0:s.length)?i:0;for(let s=0;s<a;++s){let i=this.initColor(e,r,t,s),a=0===s&&(null==(n=this.colorAttachments[0])?void 0:n.format);(i.view||a)&&this.renderPassDescriptor.colorAttachments.push(i);}this.updateKey(),this.initialized=true;}initDepthStencil(e,t,s){let{samples:i,width:n,height:r,depth:a,depthBuffer:o}=s;if(a||o){let s;if(o){if(this.depthAttachment=new ie(o.impl.format),i>1){let a="depth24plus-stencil8";this.depthAttachment.format=a,this.depthAttachment.hasStencil=true;let l=o.id+":"+n+":"+r+":"+i+":"+a,h=s8(e),d=h.get(l);if(!d){let e={size:[n,r,1],dimension:"2d",sampleCount:i,format:a,usage:GPUTextureUsage.RENDER_ATTACHMENT|(a!==o.impl.format?GPUTextureUsage.TEXTURE_BINDING:0)};d=t.createTexture(e),h.set(l,d);}this.depthAttachment.multisampledDepthBuffer=d,this.depthAttachment.multisampledDepthBufferKey=l,s=d.createView();}else {let e=o.impl.gpuTexture;this.depthAttachment.depthTexture=e,s=e.createView();}}else {this.depthAttachment=new ie("depth24plus-stencil8");let e={size:[n,r,1],dimension:"2d",sampleCount:i,format:this.depthAttachment.format,usage:GPUTextureUsage.RENDER_ATTACHMENT};i>1?e.usage|=GPUTextureUsage.TEXTURE_BINDING:e.usage|=GPUTextureUsage.COPY_SRC;let a=t.createTexture(e);this.depthAttachment.depthTexture=a,this.depthAttachment.depthTextureInternal=true,s=a.createView();}this.renderPassDescriptor.depthStencilAttachment={view:s};}}initColor(e,t,s,i){let n={},{samples:r,width:a,height:o,mipLevel:l}=s,h=s.getColorBuffer(i),d=null;if(h&&(d=h.cubemap?h.impl.createView({dimension:"2d",baseArrayLayer:s.face,arrayLayerCount:1,mipLevelCount:1,baseMipLevel:l}):h.impl.createView({mipLevelCount:1,baseMipLevel:l})),r>1){let s={size:[a,o,1],dimension:"2d",sampleCount:r,format:this.isBackbuffer?e.backBufferViewFormat:h.impl.format,usage:GPUTextureUsage.RENDER_ATTACHMENT},l=t.createTexture(s);this.setColorAttachment(i,l,s.format),n.view=l.createView(),n.resolveTarget=d;}else n.view=d;return n}setupForRenderPass(e,t){var s,i;let n=null!=(i=null==(s=this.renderPassDescriptor.colorAttachments)?void 0:s.length)?i:0;for(let s=0;s<n;++s){let i=this.renderPassDescriptor.colorAttachments[s],n=e.colorArrayOps[s];i.clearValue=t.isColorBufferSrgb(s)?n.clearValueLinear:n.clearValue,i.loadOp=n.clear?"clear":"load",i.storeOp=n.store?"store":"discard";}let r=this.renderPassDescriptor.depthStencilAttachment;r&&(r.depthClearValue=e.depthStencilOps.clearDepthValue,r.depthLoadOp=e.depthStencilOps.clearDepth?"clear":"load",r.depthStoreOp=e.depthStencilOps.storeDepth?"store":"discard",r.depthReadOnly=false,this.depthAttachment.hasStencil&&(r.stencilClearValue=e.depthStencilOps.clearStencilValue,r.stencilLoadOp=e.depthStencilOps.clearStencil?"clear":"load",r.stencilStoreOp=e.depthStencilOps.storeStencil?"store":"discard",r.stencilReadOnly=false));}loseContext(){this.initialized=false;}resolve(e,t,s,i){}constructor(e){this.initialized=false,this.colorAttachments=[],this.depthAttachment=null,this.assignedColorTexture=null,this.renderPassDescriptor={},this.isBackbuffer=false,this.renderTarget=e;}}let is=[];is[2]=1,is[3]=2,is[4]=3,is[5]=4,is[1]=1,is[6]=2,is[7]=3,is[8]=4,is[0]=1,is[9]=2,is[10]=3,is[11]=4,is[12]=8,is[13]=12,is[14]=16,is[26]=1,is[27]=2,is[28]=3,is[29]=4;class ii{get isArrayType(){return this.count>0}calculateOffset(e){let t=this.byteSize<=8?this.byteSize:16;this.count&&(t=16),e=ei.roundUp(e,t),this.offset=e/4;}constructor(e,t,s=0){if(this.shortName=e,this.name=s?""+e+"[0]":e,this.type=t,this.numComponents=is[t],this.updateType=t,s>0)switch(t){case 2:this.updateType=17;break;case 1:this.updateType=30;break;case 26:this.updateType=31;break;case 0:this.updateType=32;break;case 3:this.updateType=21;break;case 6:this.updateType=33;break;case 27:this.updateType=34;break;case 9:this.updateType=35;break;case 4:this.updateType=22;break;case 7:this.updateType=36;break;case 28:this.updateType=37;break;case 10:this.updateType=38;break;case 5:this.updateType=23;break;case 8:this.updateType=39;break;case 29:this.updateType=40;break;case 11:this.updateType=41;break;case 14:this.updateType=24;}this.count=s;let i=this.numComponents;s&&(i=ei.roundUp(i,4)),this.byteSize=4*i,s&&(this.byteSize*=s);}}class ir{get(e){return this.map.get(e)}constructor(e,t){this.byteSize=0,this.map=new Map,this.scope=e.scope,this.uniforms=t;let s=0;for(let e=0;e<t.length;e++){let i=t[e];i.calculateOffset(s),s=4*i.offset+i.byteSize,i.scopeId=this.scope.resolve(i.name),this.map.set(i.name,i);}this.byteSize=ei.roundUp(s,16);}}let ia=/[ \t]*(\battribute\b|\bvarying\b|\buniform\b)/g,io=/(\battribute\b|\bvarying\b|\bout\b|\buniform\b)[ \t]*([^;]+)(;+)/g,il=/([\w-]+)\[(.*?)\]/,ih=new Set(["highp","mediump","lowp"]),id=new Set(["sampler2DShadow","samplerCubeShadow","sampler2DArrayShadow"]),ic={sampler2D:"2d",sampler3D:"3d",samplerCube:tM,samplerCubeShadow:tM,sampler2DShadow:"2d",sampler2DArray:tP,sampler2DArrayShadow:tP,isampler2D:"2d",usampler2D:"2d",isampler3D:"3d",usampler3D:"3d",isamplerCube:tM,usamplerCube:tM,isampler2DArray:tP,usampler2DArray:tP},iu={"2d":"texture2D",[tM]:"textureCube","3d":"texture3D",[tP]:"texture2DArray"},ip=class{constructor(e,t){this.line=e;let s=e.trim().split(/\s+/);if(ih.has(s[0])&&(this.precision=s.shift()),this.type=s.shift(),e.includes(","),e.includes("[")){let e=s.join(" "),i=il.exec(e);this.name=i[1],this.arraySize=Number(i[2]),isNaN(this.arraySize)&&(t.failed=true);}else this.name=s.shift(),this.arraySize=0;this.isSampler=-1!==this.type.indexOf("sampler"),this.isSignedInt=-1!==this.type.indexOf("isampler"),this.isUnsignedInt=-1!==this.type.indexOf("usampler");}};class im{static run(e,t,s){let i=new Map,n=im.extract(t.vshader),r=im.extract(t.fshader),a=new Map,o=im.processAttributes(n.attributes,t.attributes,a,t.processingOptions),l=im.processVaryings(n.varyings,i,true),h=im.processVaryings(r.varyings,i,false),d=im.processOuts(r.outs),c=Array.from(new Set(n.uniforms.concat(r.uniforms))).map(e=>new ip(e,s)),u=im.processUniforms(e,c,t.processingOptions,s),p=o+"\n"+l+"\n"+u.code,f=n.src.replace("@@@",p),m=h+"\n"+d+"\n"+u.code;return {vshader:f,fshader:r.src.replace("@@@",m),attributes:a,meshUniformBufferFormat:u.meshUniformBufferFormat,meshBindGroupFormat:u.meshBindGroupFormat}}static extract(e){let t;let s=[],i=[],n=[],r=[],a="@@@\n";for(;null!==(t=ia.exec(e));){let o=t[1];switch(o){case "attribute":case "varying":case "uniform":case "out":{io.lastIndex=t.index;let l=io.exec(e);"attribute"===o?s.push(l[2]):"varying"===o?i.push(l[2]):"out"===o?n.push(l[2]):"uniform"===o&&r.push(l[2]),e=im.cutOut(e,t.index,io.lastIndex,a),ia.lastIndex=t.index+a.length,a="";}}}return {src:e,attributes:s,varyings:i,outs:n,uniforms:r}}static processUniforms(e,t,s,i){let n=[],r=[];t.forEach(e=>{e.isSampler?n.push(e):r.push(e);});let a=[];r.forEach(e=>{if(!s.hasUniform(e.name)){let t=tB.indexOf(e.type),s=new ii(e.name,t,e.arraySize);a.push(s);}}),0===a.length&&a.push(new ii(tj,2));let o=a.length?new ir(e,a):null,l=[];n.forEach(e=>{if(!s.hasTexture(e.name)){let t=0;e.isSignedInt?t=3:e.isUnsignedInt?t=4:("highp"===e.precision&&(t=1),id.has(e.type)&&(t=2));let s=ic[e.type];l.push(new t4(e.name,3,s,t));}});let h=new t6(e,l),d="";return s.uniformFormats.forEach((e,t)=>{e&&(d+=im.getUniformShaderDeclaration(e,t,0));}),o&&(d+=im.getUniformShaderDeclaration(o,2,0)),s.bindGroupFormats.forEach((e,t)=>{e&&(d+=im.getTexturesShaderDeclaration(e,t));}),{code:d+=im.getTexturesShaderDeclaration(h,1),meshUniformBufferFormat:o,meshBindGroupFormat:h}}static processVaryings(e,t,s){let i="",n=s?"out":"in";return e.forEach((e,r)=>{let a=im.splitToWords(e),o=a.slice(0,-1).join(" "),l=a[a.length-1];s?t.set(l,r):r=t.get(l),i+="layout(location = "+r+") "+n+" "+o+" "+l+";\n";}),i}static processOuts(e){let t="";return e.forEach((e,s)=>{t+="layout(location = "+s+") out "+e+";\n";}),t}static getTypeCount(e){let t=parseInt(e.substring(e.length-1),10);return isNaN(t)?1:t}static processAttributes(e,t,s,i){let n="";return e.forEach(e=>{let r=im.splitToWords(e),a=r[0],o=r[1];if(t.hasOwnProperty(o)){let e;let r=t[o],l=tJ[r];s.set(l,o);let h=i.getVertexElement(r);if(h){let t=h.dataType;if(6!==t&&7!==t&&!h.normalize&&!h.asInt){let s=im.getTypeCount(a),i="_private_"+o;e="vec"+s+" "+o+" = vec"+s+"("+i+");\n",o=i;let n=0===t||2===t||4===t;a=1===s?n?"int":"uint":n?"ivec"+s:"uvec"+s;}}n+="layout(location = "+l+") in "+a+" "+o+";\n",e&&(n+=e);}}),n}static splitToWords(e){return (e=e.replace(/\s+/g," ").trim()).split(" ")}static cutOut(e,t,s,i){return e.substring(0,t)+i+e.substring(s)}static getUniformShaderDeclaration(e,t,s){let i=tX[t],n="layout(set = "+t+", binding = "+s+", std140) uniform ub_"+i+" {\n";return e.uniforms.forEach(e=>{let t=tB[e.type];n+="    "+t+" "+e.shortName+(e.count?"["+e.count+"]":"")+";\n";}),""+n+"};\n"}static getTexturesShaderDeclaration(e,t){let s="";return e.textureFormats.forEach(e=>{let i=iu[e.textureDimension],n="texture2DArray"===i,r=4===e.sampleType?"u":3===e.sampleType?"i":"";i=""+r+i;let a="",o="";n&&(a="_texture",o="#define "+e.name+" "+r+"sampler2DArray("+e.name+a+", "+e.name+"_sampler)\n"),s+="layout(set = "+t+", binding = "+e.slot+") uniform "+i+" "+e.name+a+";\n",e.hasSampler&&(s+="layout(set = "+t+", binding = "+(e.slot+1)+") uniform sampler "+e.name+"_sampler;\n"),s+=o;}),s}}let i_=/^[ \t]*(attribute|varying|uniform)[\t ]+/gm,ig=/^[ \t]*(attribute|varying|uniform)[ \t]*([^;]+)(;+)/gm,iv=/^[ \t]*var\s*(<[^>]+>)?\s*[\w\d_]+\s*:\s*(texture_.*|storage_texture_.*|storage.*|external_texture|array<.*>|sampler|sampler_comparison).*;\s*$/gm,iy=/(?:@interpolate\([^)]*\)\s*)?([\w]+)\s*:/,iS=/(@vertex|@fragment)\s*fn\s+\w+\s*\(\s*(\w+)\s*:[\s\S]*?\{/,ix=(e,t)=>{if(t){if("2d"===e)return tP;if("cube"===e)return tI}else switch(e){case "1d":return "1d";case "2d":return "2d";case "3d":return "3d";case "cube":return tM}},iT=(e,t)=>{let s=0===t?"f32":3===t?"i32":"u32";switch(e){case "1d":return "texture_1d<"+s+">";case "2d":return "texture_2d<"+s+">";case "3d":return "texture_3d<"+s+">";case tM:return "texture_cube<"+s+">";case tP:return "texture_2d_array<"+s+">";case tI:return "texture_cube_array<"+s+">"}},ib={f32:0,i32:3,u32:4},iE={f32:"WrappedF32",i32:"WrappedI32",u32:"WrappedU32",vec2f:"WrappedVec2F",vec2i:"WrappedVec2I",vec2u:"WrappedVec2U"},iA=e=>(e=e.replace(/\s+/g," ").trim()).split(/[\s:]+/),iw=/array<([^,]+),\s*([^>]+)>/;class iC{constructor(e,t){this.ubName=null,this.arraySize=0,this.line=e;let s=iA(e);if(s.length<2){t.failed=true;return}if(this.name=s[0],this.type=s.slice(1).join(" "),this.type.includes("array<")){let e=iw.exec(this.type);this.type=e[1].trim(),this.arraySize=Number(e[2]),isNaN(this.arraySize)&&(t.failed=true);}}}let iP=/^\s*var\s+([\w\d_]+)\s*:\s*array<([\w\d_<>]+),\s*(\d+)>;\s*$/,iM=/^\s*var\s+([\w\d_]+)\s*:\s*texture_(\w+)<([a-zA-Z0-9_,<>]*)>;\s*$/,iI=/^\s*var\s+([\w\d_]+)\s*:\s*(texture_storage_2d|texture_storage_2d_array)<([\w\d_]+),\s*(\w+)>\s*;\s*$/,iR=/^\s*var\s*<storage,\s*(read|write)?>\s*([\w\d_]+)\s*:\s*(.*)\s*;\s*$/,iL=/^\s*var\s+([\w\d_]+)\s*:\s*texture_external;\s*$/,iD=/^\s*var\s+([\w\d_]+)\s*:\s*(sampler|sampler_comparison)\s*;\s*$/;class iO{constructor(e,t){this.originalLine=e,this.line=e,this.isTexture=false,this.isSampler=false,this.isStorageTexture=false,this.isStorageBuffer=false,this.isExternalTexture=false,this.arraySize=0,this.type="",this.matchedElements=[];let s=e.match(iP);s&&(this.name=s[1],this.arraySize=parseInt(s[3],10),this.line="var "+this.name+" : "+s[2]+";",this.matchedElements.push(...s),isNaN(this.arraySize)&&(t.failed=true));let i=this.line.match(iM);i&&(this.name=i[1],this.type=i[2],this.textureFormat=i[3],this.isTexture=true,this.matchedElements.push(...i),this.textureDimension=ix(this.type,this.arraySize>0),this.sampleType=ib[this.textureFormat]);let n=this.line.match(iI);n&&(this.isStorageTexture=true,this.name=n[1],this.textureType=n[2],this.format=n[3],this.access=n[4],this.matchedElements.push(...n));let r=this.line.match(iR);r&&(this.isStorageBuffer=true,this.accessMode=r[1]||"none",this.name=r[2],this.type=r[3],this.matchedElements.push(...r));let a=this.line.match(iL);a&&(this.name=a[1],this.isExternalTexture=true,this.matchedElements.push(...r));let o=this.line.match(iD);o&&(this.name=o[1],this.samplerType=o[2],this.isSampler=true,this.matchedElements.push(...o)),0===this.matchedElements.length&&(t.failed=true);}}class iF{static run(e,t,s){let i=new Map,n=iF.extract(t.vshader),r=iF.extract(t.fshader),a=new Map,o=iF.processAttributes(n.attributes,t.attributes,a,t.processingOptions),l=iF.processVaryings(n.varyings,i,true),h=iF.processVaryings(r.varyings,i,false),d=Array.from(new Set(n.uniforms.concat(r.uniforms))).map(e=>new iC(e,s)),c=iF.processUniforms(e,d,t.processingOptions,s);n.src=iF.renameUniformAccess(n.src,d),r.src=iF.renameUniformAccess(r.src,d);let u=Array.from(new Set(n.resources.concat(r.resources))).map(e=>new iO(e,s)),p=iF.processResources(e,u,t.processingOptions,s),f=iF.generateFragmentOutputStruct(r.src,e.maxColorAttachments);n.src=iF.copyInputs(n.src,s),r.src=iF.copyInputs(r.src,s);let m=o+"\n"+l+"\n"+c.code+"\n"+p.code+"\n",_=n.src.replace("@@@",m),g=h+"\n"+f+"\n"+c.code+"\n"+p.code+"\n";return {vshader:_,fshader:r.src.replace("@@@",g),attributes:a,meshUniformBufferFormat:c.meshUniformBufferFormat,meshBindGroupFormat:p.meshBindGroupFormat}}static extract(e){let t;let s=[],i=[],n=[],r=[],a="@@@\n";for(;null!==(t=i_.exec(e));){let r=t[1];ig.lastIndex=t.index;let o=ig.exec(e);"attribute"===r?s.push(o[2]):"varying"===r?i.push(o[2]):"uniform"===r&&n.push(o[2]),e=iF.cutOut(e,t.index,ig.lastIndex,a),i_.lastIndex=t.index+a.length,a="";}for(;null!==(t=iv.exec(e));)r.push(t[0]),e=iF.cutOut(e,t.index,iv.lastIndex,a),iv.lastIndex=t.index+a.length,a="";return {src:e,attributes:s,varyings:i,uniforms:n,resources:r}}static processUniforms(e,t,s,i){let n=[];t.forEach(e=>{if(s.hasUniform(e.name))e.ubName="ub_view";else {e.ubName="ub_mesh_ub";let t=tk.get(e.type),s=new ii(e.name,t,e.arraySize);n.push(s);}}),0===n.length&&n.push(new ii(tj,2));let r=new ir(e,n),a="";return s.uniformFormats.forEach((e,t)=>{e&&(a+=iF.getUniformShaderDeclaration(e,t,0));}),r&&(a+=iF.getUniformShaderDeclaration(r,2,0)),{code:a,meshUniformBufferFormat:r}}static renameUniformAccess(e,t){return t.forEach(t=>{let s="uniform."+t.name,i=t.ubName+"."+t.name,n=RegExp("\\b"+s+"\\b","g");e=e.replace(n,i);}),e}static processResources(e,t,s,i){let n=[];for(let e=0;e<t.length;e++){let s=t[e];if(s.isTexture){let i=t[e+1],r=null==i?void 0:i.isSampler,a=s.sampleType,o=s.textureDimension;n.push(new t4(s.name,3,o,a,r,r?i.name:null)),r&&e++;}if(s.isStorageBuffer){let e="read_write"!==s.accessMode,t=new t3(s.name,3,e);t.format=s.type,n.push(t);}}let r=new t6(e,n),a="";return s.bindGroupFormats.forEach((e,t)=>{e&&(a+=iF.getTextureShaderDeclaration(e,t,1));}),{code:a+=iF.getTextureShaderDeclaration(r,1,0),meshBindGroupFormat:r}}static getUniformShaderDeclaration(e,t,s){let i=tX[t],n="struct_ub_"+i,r="struct "+n+" {\n";return e.uniforms.forEach(e=>{let t=tU[e.type][0];e.count>0?(iE.hasOwnProperty(t)&&(t=iE[t]),r+="    "+e.shortName+": array<"+t+", "+e.count+">,\n"):r+="    "+e.shortName+": "+t+",\n";}),r+="};\n"+("@group("+t+") @binding("+s+") var<uniform> ub_"+i+" : "+n)+";\n\n"}static getTextureShaderDeclaration(e,t,s){let i="",n=s;return e.textureFormats.forEach(e=>{let s=iT(e.textureDimension,e.sampleType);i+="@group("+t+") @binding("+n+") var "+e.name+": "+s+";\n",n++,e.hasSampler&&(i+="@group("+t+") @binding("+n+") var "+e.samplerName+": sampler;\n",n++);}),e.storageBufferFormats.forEach(e=>{let s=e.readOnly?"read":"read_write";i+="@group("+t+") @binding("+n+") var<storage, "+s+"> "+e.name+" : "+e.format+";\n",n++;}),i}static processVaryings(e,t,s){let i="",n="",r="";e.forEach((e,a)=>{let o=e.match(iy);if(o){let l=o[1];s?t.set(l,a):a=t.get(l),i+="    @location("+a+") "+e+",\n",s||(n+="    var<private> "+e+";\n",r+="    "+l+" = input."+l+";\n");}}),s?i+="    @builtin(position) position : vec4f,\n":i+="    @builtin(position) position : vec4f,\n    @builtin(front_facing) frontFacing : bool,\n    @builtin(sample_index) sampleIndex : u32\n";let a=s?"":"\n            var<private> pcPosition: vec4f;\n            var<private> pcFrontFacing: bool;\n            var<private> pcSampleIndex: u32;\n            "+n+"\n            \n            // function to copy inputs (varyings) to private global variables\n            fn _pcCopyInputs(input: FragmentInput) {\n                "+r+"\n                pcPosition = input.position;\n                pcFrontFacing = input.frontFacing;\n                pcSampleIndex = input.sampleIndex;\n            }\n        ";return "\n            struct "+(s?"VertexOutput":"FragmentInput")+" {\n                "+i+"\n            };\n            "+a+"\n        "}static generateFragmentOutputStruct(e,t){let s="struct FragmentOutput {\n";for(let e=0;e<t;e++)s+="    @location("+e+") color"+(e>0?e:"")+" : vec4f,\n";return -1!==e.search(/\.fragDepth\s*=/)&&(s+="    @builtin(frag_depth) fragDepth : f32\n"),""+s+"};\n"}static floatAttributeToInt(e,t){return ({f32:t?"i32":"u32",vec2f:t?"vec2i":"vec2u",vec3f:t?"vec3i":"vec3u",vec4f:t?"vec4i":"vec4u"})[({f32:"f32","vec2<f32>":"vec2f","vec3<f32>":"vec3f","vec4<f32>":"vec4f"})[e]||e]||null}static processAttributes(e,t,s,i){ void 0===t&&(t={});let n="",r="",a="";return e.forEach(e=>{let o=iA(e),l=o[0],h=o[1],d=h;if(t.hasOwnProperty(l)){let o=t[l],c=tJ[o];s.set(c,l);let u=i.getVertexElement(o);if(u){let e=u.dataType;6===e||7===e||u.normalize||u.asInt||(h=iF.floatAttributeToInt(h,0===e||2===e||4===e));}n+="    @location("+c+") "+l+": "+h+",\n",r+="    var<private> "+e+";\n",a+="    "+l+" = "+d+"(input."+l+");\n";}}),"\n            struct VertexInput {\n                "+n+"\n                @builtin(vertex_index) vertexIndex : u32,       // built-in vertex index\n                @builtin(instance_index) instanceIndex : u32    // built-in instance index\n            };\n\n            "+r+"\n            var<private> pcVertexIndex: u32;\n            var<private> pcInstanceIndex: u32;\n\n            fn _pcCopyInputs(input: VertexInput) {\n                "+a+"\n                pcVertexIndex = input.vertexIndex;\n                pcInstanceIndex = input.instanceIndex;\n            }\n        "}static copyInputs(e,t){let s=e.match(iS);if(!s||!s[2])return e;let i=s[2],n=s.index+s[0].length-1,r=e.slice(0,n+1);return r+"\n    _pcCopyInputs("+i+");"+e.slice(n+1)}static cutOut(e,t,s,i){return e.substring(0,t)+i+e.substring(s)}}class iN{destroy(e){this._vertexCode=null,this._fragmentCode=null;}createShaderModule(e,t){return this.shader.device.wgpu.createShaderModule({code:e})}getVertexShaderModule(){return this.createShaderModule(this._vertexCode,"Vertex")}getFragmentShaderModule(){return this.createShaderModule(this._fragmentCode,"Fragment")}getComputeShaderModule(){return this.createShaderModule(this._computeCode,"Compute")}processGLSL(){let e=this.shader,t=im.run(e.device,e.definition,e);this._vertexCode=this.transpile(t.vshader,"vertex",e.definition.vshader),this._fragmentCode=this.transpile(t.fshader,"fragment",e.definition.fshader),this._vertexCode&&this._fragmentCode?e.ready=true:e.failed=true,e.meshUniformBufferFormat=t.meshUniformBufferFormat,e.meshBindGroupFormat=t.meshBindGroupFormat,e.attributes=t.attributes;}processWGSL(){let e=this.shader,t=iF.run(e.device,e.definition,e);this._vertexCode=t.vshader,this._fragmentCode=t.fshader,e.meshUniformBufferFormat=t.meshUniformBufferFormat,e.meshBindGroupFormat=t.meshBindGroupFormat,e.attributes=t.attributes;}transpile(e,t,s){try{let s=this.shader.device.glslang.compileGLSL(e,t);return this.shader.device.twgsl.convertSpirV2WGSL(s)}catch(e){}}get vertexCode(){return this._vertexCode}get fragmentCode(){return this._fragmentCode}loseContext(){}restoreContext(e,t){}constructor(e){this._vertexCode=null,this._fragmentCode=null,this._computeCode=null,this.vertexEntryPoint="main",this.fragmentEntryPoint="main",this.computeEntryPoint="main",this.shader=e;let t=e.definition;if(t.shaderLanguage===tN){var s,i,n;t.cshader?(this._computeCode=null!=(s=t.cshader)?s:null,this.computeUniformBufferFormats=t.computeUniformBufferFormats,this.computeBindGroupFormat=t.computeBindGroupFormat):(this.vertexEntryPoint="vertexMain",this.fragmentEntryPoint="fragmentMain",t.processingOptions?this.processWGSL():(this._vertexCode=null!=(i=t.vshader)?i:null,this._fragmentCode=null!=(n=t.fshader)?n:null,e.meshUniformBufferFormat=t.meshUniformBufferFormat,e.meshBindGroupFormat=t.meshBindGroupFormat)),e.ready=true;}else t.processingOptions&&this.processGLSL();}}let iB=[];iB[0]="repeat",iB[1]="clamp-to-edge",iB[2]="mirror-repeat";let iU=[];iU[0]={level:"nearest",mip:"nearest"},iU[1]={level:"linear",mip:"nearest"},iU[2]={level:"nearest",mip:"nearest"},iU[3]={level:"nearest",mip:"linear"},iU[4]={level:"linear",mip:"nearest"},iU[5]={level:"linear",mip:"linear"};let ik=e=>{};class iz{create(e){let t;let s=this.texture,i=e.wgpu,n=s.numLevels;this.desc={size:{width:s.width,height:s.height,depthOrArrayLayers:s.cubemap?6:s.array?s.arrayLength:1},format:this.format,mipLevelCount:n,sampleCount:1,dimension:s.volume?"3d":"2d",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC|(eK(s.format)?0:GPUTextureUsage.RENDER_ATTACHMENT)|(s.storage?GPUTextureUsage.STORAGE_BINDING:0)},this.gpuTexture=i.createTexture(this.desc),17===this.texture.format&&(t={format:"depth24plus",aspect:"depth-only"}),this.view=this.createView(t);}destroy(e){}propertyChanged(e){this.samplers.length=0;}getView(e){return this.uploadImmediate(e,this.texture),this.view}createView(e){var t,s,i,n,r,a,o;let l=null!=e?e:{},h=this.desc,d=this.texture,c={format:null!=(t=l.format)?t:h.format,dimension:null!=(s=l.dimension)?s:d.cubemap?"cube":d.volume?"3d":d.array?"2d-array":"2d",aspect:null!=(i=l.aspect)?i:"all",baseMipLevel:null!=(n=l.baseMipLevel)?n:0,mipLevelCount:null!=(r=l.mipLevelCount)?r:h.mipLevelCount,baseArrayLayer:null!=(a=l.baseArrayLayer)?a:0,arrayLayerCount:null!=(o=l.arrayLayerCount)?o:h.depthOrArrayLayers};return this.gpuTexture.createView(c)}getSampler(e,t){let s=this.samplers[t];if(!s){let i=this.texture,n={addressModeU:iB[i.addressU],addressModeV:iB[i.addressV],addressModeW:iB[i.addressW]};!t&&i.compareOnRead&&(t=2),2===t||3===t||4===t?(n.compare="less",n.magFilter="linear",n.minFilter="linear"):1===t?(n.magFilter="nearest",n.minFilter="nearest",n.mipmapFilter="nearest"):!e.textureFloatFilterable&&(14===i.format||12===i.format)||17===this.texture.format||eQ(this.texture.format)?(n.magFilter="nearest",n.minFilter="nearest",n.mipmapFilter="nearest"):(n.magFilter=iU[i.magFilter].level,n.minFilter=iU[i.minFilter].level,n.mipmapFilter=iU[i.minFilter].mip);let r="linear"===n.minFilter&&"linear"===n.magFilter&&"linear"===n.mipmapFilter;n.maxAnisotropy=r?ei.clamp(Math.round(i._anisotropy),1,e.maxTextureAnisotropy):1,s=e.wgpu.createSampler(n),this.samplers[t]=s;}return s}loseContext(){}uploadImmediate(e,t){(t._needsUpload||t._needsMipmapsUpload)&&(this.uploadData(e),t._needsUpload=false,t._needsMipmapsUpload=false);}uploadData(e){let t=this.texture;if(t._levels){let s=false,i=false,n=t.numLevels;for(let r=0;r<n;r++){let n=t._levels[r];if(n){if(t.cubemap)for(let t=0;t<6;t++){let a=n[t];a?this.isExternalImage(a)?(this.uploadExternalImage(e,a,r,t),s=true):ArrayBuffer.isView(a)&&(this.uploadTypedArrayData(e,a,r,t),s=true):i=true;}else if(t._volume);else if(t.array){if(t.arrayLength===n.length)for(let i=0;i<t._arrayLength;i++){let t=n[i];this.isExternalImage(t)?(this.uploadExternalImage(e,t,r,i),s=true):ArrayBuffer.isView(t)&&(this.uploadTypedArrayData(e,t,r,i),s=true);}else i=true;}else this.isExternalImage(n)?(this.uploadExternalImage(e,n,r,0),s=true):ArrayBuffer.isView(n)&&(this.uploadTypedArrayData(e,n,r,0),s=true);}else i=true;}s&&i&&t.mipmaps&&!eK(t.format)&&!eQ(t.format)&&e.mipmapRenderer.generate(this),t._gpuSize&&t.adjustVramSizeTracking(e._vram,-t._gpuSize),t._gpuSize=t.gpuSize,t.adjustVramSizeTracking(e._vram,t._gpuSize);}}isExternalImage(e){return e instanceof ImageBitmap||e instanceof HTMLVideoElement||e instanceof HTMLCanvasElement||e instanceof OffscreenCanvas}uploadExternalImage(e,t,s,i){let n={texture:this.gpuTexture,mipLevel:s,origin:[0,0,i],aspect:"all"},r={width:this.desc.size.width,height:this.desc.size.height,depthOrArrayLayers:1};e.submit(),ik(t instanceof HTMLCanvasElement&&t.getContext("2d")),e.wgpu.queue.copyExternalImageToTexture({source:t,origin:[0,0],flipY:false},n,r);}uploadTypedArrayData(e,t,s,i){let n,r;let a=this.texture,o=e.wgpu,l={texture:this.gpuTexture,origin:[0,0,i],mipLevel:s},h=t9.calcLevelDimension(a.width,s),d=t9.calcLevelDimension(a.height,s);t9.calcLevelGpuSize(h,d,1,a.format);let c=eq.get(a.format);if(c.size)n={offset:0,bytesPerRow:c.size*h,rowsPerImage:d},r={width:h,height:d};else if(c.blockSize){let e=e=>Math.floor((e+3)/4);n={offset:0,bytesPerRow:c.blockSize*e(h),rowsPerImage:e(d)},r={width:Math.max(4,h),height:Math.max(4,d)};}e.submit(),o.queue.writeTexture(l,t,n,r);}read(e,t,s,i,n){var r,a,o,l;let h=null!=(r=n.mipLevel)?r:0,d=null!=(a=n.face)?a:0,c=null!=(o=n.data)?o:null,u=null!=(l=n.immediate)&&l,p=this.texture,f=s*eq.get(p.format).size,m=ei.roundUp(f,256),_=m*i,g=p.device,v=g.createBufferImpl(9);v.allocate(g,_);let y={texture:this.gpuTexture,mipLevel:h,origin:[e,t,d]},S={buffer:v.buffer,offset:0,bytesPerRow:m};return g.getCommandEncoder().copyTextureToBuffer(y,S,{width:s,height:i,depthOrArrayLayers:1}),g.readBuffer(v,_,null,u).then(e=>{var t;let s=(null==c?void 0:c.constructor)===Uint8Array?c:new Uint8Array(null!=(t=null==c?void 0:c.buffer)?t:i*f);for(let t=0;t<i;t++){let i=t*m,n=t*f,r=e.subarray(i,i+f);s.set(r,n);}return null!=c?c:s})}constructor(e){this.samplers=[],this.texture=e,this.format=sO[e.format],this.create(e.device);}}class iV extends sk{unlock(e){let t=e.device;super.unlock(t,e.storageInt32.buffer);}constructor(e){super(64);}}class iG extends sk{unlock(e){let t=e.device;super.unlock(t,e.storage);}constructor(e,t,s){super(32|128*(null!=s&&!!s.storage));}}let iH=/[ \t]*#(ifn?def|if|endif|else|elif|define|undef|extension|include)/g,iW=/define[ \t]+([^\n]+)\r?(?:\n|$)/g,iX=/extension[ \t]+([\w-]+)[ \t]*:[ \t]*(enable|require)/g,iY=/undef[ \t]+([^\n]+)\r?(?:\n|$)/g,ij=/(ifdef|ifndef|if)[ \t]*([^\r\n]+)\r?\n/g,iq=/(endif|else|elif)(?:[ \t]+([^\r\n]*))?\r?\n?/g,iK=/\{?[\w-]+\}?/,iZ=/(!|\s)?defined\(([\w-]+)\)/,iQ=/([a-z_]\w*)\s*(==|!=|<|<=|>|>=)\s*([\w"']+)/i,iJ=/[+\-]/g,i$=/include[ \t]+"([\w-]+)(?:\s*,\s*([\w-]+))?"\r?(?:\n|$)/g,i0=/\{i\}/g,i1=/(pcFragColor[1-8])\b/g;class i2{static run(e,t,s){ void 0===t&&(t=new Map),void 0===s&&(s={}),i2.sourceName=s.sourceName,e=(e=this.stripComments(e)).split(/\r?\n/).map(e=>e.trimEnd()).join("\n");let i=new Map,n=new Map;if(null===(e=this._preprocess(e,i,n,t,s.stripDefines)))return null;let r=new Map;return i.forEach((e,t)=>{Number.isInteger(parseFloat(e))&&!e.includes(".")&&r.set(t,e);}),e=this.stripComments(e),e=this.stripUnusedColorAttachments(e,s),e=this.RemoveEmptyLines(e),e=this.processArraySize(e,r),e=this.injectDefines(e,n)}static stripUnusedColorAttachments(e,t){if(t.stripUnusedColorAttachments){let t=new Map,s=e.match(i1);if(null==s||s.forEach(e=>{var s;let i=parseInt(e.charAt(e.length-1),10);t.set(i,(null!=(s=t.get(i))?s:0)+1);}),Array.from(t.values()).some(e=>1===e)){let s=e.split("\n"),i=[];for(let e=0;e<s.length;e++){let n=s[e].match(i1);if(n){let e=parseInt(n[0].charAt(n[0].length-1),10);if(e>0&&1===t.get(e))continue}i.push(s[e]);}e=i.join("\n");}}return e}static stripComments(e){return e.replace(/\/\*[\s\S]*?\*\/|([^\\:]|^)\/\/.*$/gm,"$1")}static processArraySize(e,t){return null!==e&&t.forEach((t,s)=>{e=e.replace(RegExp("\\["+s+"\\]","g"),"["+t+"]");}),e}static injectDefines(e,t){if(null!==e&&t.size>0){let s=e.split("\n");t.forEach((e,t)=>{let i=RegExp(t,"g");for(let t=0;t<s.length;t++)s[t].includes("#")||(s[t]=s[t].replace(i,e));}),e=s.join("\n");}return e}static RemoveEmptyLines(e){return null!==e&&(e=(e=e.split(/\r?\n/).map(e=>""===e.trim()?"":e).join("\n")).replace(/(\n\n){3,}/g,"\n\n")),e}static _preprocess(e,t,s,i,n){let r;void 0===t&&(t=new Map);let a=[],o=false;for(;null!==(r=iH.exec(e))&&!o;){let h=r[1];switch(h){case "define":{iW.lastIndex=r.index;let i=iW.exec(e);o||(o=null===i);let l=i[1];iK.lastIndex=i.index;let h=iK.exec(l)[0],d=l.substring(h.length).trim();""===d&&(d="true");let c=i2._keep(a),u=n;if(c){let n=h.startsWith("{")&&h.endsWith("}");n&&(u=true),n?s.set(h,d):t.set(h,d),u&&(e=e.substring(0,i.index-1)+e.substring(iW.lastIndex),iH.lastIndex=i.index-1);}u||(iH.lastIndex=i.index+i[0].length);break}case "undef":{iY.lastIndex=r.index;let s=iY.exec(e),i=s[1].trim();i2._keep(a)&&(t.delete(i),n&&(e=e.substring(0,s.index-1)+e.substring(iY.lastIndex),iH.lastIndex=s.index-1)),n||(iH.lastIndex=s.index+s[0].length);break}case "extension":{iX.lastIndex=r.index;let s=iX.exec(e);if(o||(o=null===s),s){let e=s[1];i2._keep(a)&&t.set(e,"true");}iH.lastIndex=s.index+s[0].length;break}case "ifdef":case "ifndef":case "if":{ij.lastIndex=r.index;let s=ij.exec(e),i=s[2],n=i2.evaluate(i,t);o||(o=n.error);let l=n.result;"ifndef"===h&&(l=!l),a.push({anyKeep:l,keep:l,start:r.index,end:ij.lastIndex}),iH.lastIndex=s.index+s[0].length;break}case "endif":case "else":case "elif":{iq.lastIndex=r.index;let s=iq.exec(e),i=a.pop();if(!i){o=true;continue}let n=i.keep?e.substring(i.end,r.index):"";e=e.substring(0,i.start)+n+e.substring(iq.lastIndex),iH.lastIndex=i.start+n.length;let l=s[1];if("else"===l||"elif"===l){let e=false;if(!i.anyKeep){if("else"===l)e=!i.keep;else {let i=i2.evaluate(s[2],t);e=i.result,o||(o=i.error);}}a.push({anyKeep:i.anyKeep||e,keep:e,start:iH.lastIndex,end:iH.lastIndex});}break}case "include":{var l;i$.lastIndex=r.index;let s=i$.exec(e);if(o||(o=null===s),!s){o=true;continue}let n=s[1].trim(),h=null==(l=s[2])?void 0:l.trim();if(i2._keep(a)){let r=null==i?void 0:i.get(n);if(void 0!==r){if(r=this.stripComments(r),h){let e=parseFloat(t.get(h));if(Number.isInteger(e)){let t="";for(let s=0;s<e;s++)t+=r.replace(i0,String(s));r=t;}else o=true;}e=e.substring(0,s.index-1)+r+e.substring(i$.lastIndex),iH.lastIndex=s.index-1;}else {o=true;continue}}}}}return (a.length>0&&(o=true),o)?null:e}static _keep(e){for(let t=0;t<e.length;t++)if(!e[t].keep)return  false;return  true}static evaluateAtomicExpression(e,t){let s=false;e=e.trim();let i=false,n=iZ.exec(e);if(n){i="!"===n[1],e=n[2].trim();let r=t.has(e);return {result:i?!r:r,error:s}}let r=iQ.exec(e);if(r){var a,o;let e=null!=(a=t.get(r[1].trim()))?a:r[1].trim(),i=null!=(o=t.get(r[3].trim()))?o:r[3].trim(),n=r[2].trim(),l=false;switch(n){case "==":l=e===i;break;case "!=":l=e!==i;break;case "<":l=e<i;break;case "<=":l=e<=i;break;case ">":l=e>i;break;case ">=":l=e>=i;break;default:s=true;}return {result:l,error:s}}return {result:t.has(e),error:s}}static evaluate(e,t){let s=null===iJ.exec(e);for(let i of e.split("||")){let e=i.split("&&"),n=true;for(let s of e){let{result:e,error:i}=i2.evaluateAtomicExpression(s.trim(),t);if(!e||i){n=false;break}}if(n)return {result:true,error:!s}}return {result:false,error:!s}}}var i3="\n#ifndef outType_0\n#define outType_0 vec4\n#endif\nlayout(location = 0) out highp outType_0 pcFragColor0;\n#if COLOR_ATTACHMENT_1\nlayout(location = 1) out highp outType_1 pcFragColor1;\n#endif\n#if COLOR_ATTACHMENT_2\nlayout(location = 2) out highp outType_2 pcFragColor2;\n#endif\n#if COLOR_ATTACHMENT_3\nlayout(location = 3) out highp outType_3 pcFragColor3;\n#endif\n#if COLOR_ATTACHMENT_4\nlayout(location = 4) out highp outType_4 pcFragColor4;\n#endif\n#if COLOR_ATTACHMENT_5\nlayout(location = 5) out highp outType_5 pcFragColor5;\n#endif\n#if COLOR_ATTACHMENT_6\nlayout(location = 6) out highp outType_6 pcFragColor6;\n#endif\n#if COLOR_ATTACHMENT_7\nlayout(location = 7) out highp outType_7 pcFragColor7;\n#endif\n#define gl_FragColor pcFragColor0\n#define varying in\n#define texture2D texture\n#define texture2DBias texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLod textureLod\n#define texture2DProjLod textureProjLod\n#define textureCubeLod textureLod\n#define texture2DGrad textureGrad\n#define texture2DProjGrad textureProjGrad\n#define textureCubeGrad textureGrad\n#define utexture2D texture\n#define itexture2D texture\n#define texture2DLodEXT texture2DLodEXT_is_no_longer_supported_use_texture2DLod_instead\n#define texture2DProjLodEXT texture2DProjLodEXT_is_no_longer_supported_use_texture2DProjLod\n#define textureCubeLodEXT textureCubeLodEXT_is_no_longer_supported_use_textureCubeLod_instead\n#define texture2DGradEXT texture2DGradEXT_is_no_longer_supported_use_texture2DGrad_instead\n#define texture2DProjGradEXT texture2DProjGradEXT_is_no_longer_supported_use_texture2DProjGrad_instead\n#define textureCubeGradEXT textureCubeGradEXT_is_no_longer_supported_use_textureCubeGrad_instead\n#define textureShadow(res, uv) textureGrad(res, uv, vec2(1, 1), vec2(1, 1))\n#define SHADOWMAP_PASS(name) name\n#define SHADOWMAP_ACCEPT(name) sampler2DShadow name\n#define TEXTURE_PASS(name) name\n#define TEXTURE_ACCEPT(name) sampler2D name\n#define TEXTURE_ACCEPT_HIGHP(name) highp sampler2D name\n#define GL2\n",i4="\n#define attribute in\n#define varying out\n#define texture2D texture\n#define utexture2D texture\n#define itexture2D texture\n#define GL2\n#define VERTEXSHADER\n#define TEXTURE_PASS(name) name\n#define TEXTURE_ACCEPT(name) sampler2D name\n#define TEXTURE_ACCEPT_HIGHP(name) highp sampler2D name\n",i5="\n#extension GL_EXT_samplerless_texture_functions : require\n#ifndef outType_0\n#define outType_0 vec4\n#endif\n#ifndef outType_1\n#define outType_1 vec4\n#endif\n#ifndef outType_2\n#define outType_2 vec4\n#endif\n#ifndef outType_3\n#define outType_3 vec4\n#endif\n#ifndef outType_4\n#define outType_4 vec4\n#endif\n#ifndef outType_5\n#define outType_5 vec4\n#endif\n#ifndef outType_6\n#define outType_6 vec4\n#endif\n#ifndef outType_7\n#define outType_7 vec4\n#endif\nlayout(location = 0) out highp outType_0 pcFragColor0;\nlayout(location = 1) out highp outType_1 pcFragColor1;\nlayout(location = 2) out highp outType_2 pcFragColor2;\nlayout(location = 3) out highp outType_3 pcFragColor3;\nlayout(location = 4) out highp outType_4 pcFragColor4;\nlayout(location = 5) out highp outType_5 pcFragColor5;\nlayout(location = 6) out highp outType_6 pcFragColor6;\nlayout(location = 7) out highp outType_7 pcFragColor7;\n#define gl_FragColor pcFragColor0\n#define texture2D(res, uv) texture(sampler2D(res, res ## _sampler), uv)\n#define texture2DBias(res, uv, bias) texture(sampler2D(res, res ## _sampler), uv, bias)\n#define texture2DLod(res, uv, lod) textureLod(sampler2D(res, res ## _sampler), uv, lod)\n#define textureCube(res, uv) texture(samplerCube(res, res ## _sampler), uv)\n#define textureCubeLod(res, uv, lod) textureLod(samplerCube(res, res ## _sampler), uv, lod)\n#define textureShadow(res, uv) textureLod(sampler2DShadow(res, res ## _sampler), uv, 0.0)\n#define itexture2D(res, uv) texture(isampler2D(res, res ## _sampler), uv)\n#define utexture2D(res, uv) texture(usampler2D(res, res ## _sampler), uv)\n#define texture2DLodEXT texture2DLodEXT_is_no_longer_supported_use_texture2DLod_instead\n#define texture2DProjLodEXT texture2DProjLodEXT_is_no_longer_supported_use_texture2DProjLod\n#define textureCubeLodEXT textureCubeLodEXT_is_no_longer_supported_use_textureCubeLod_instead\n#define texture2DGradEXT texture2DGradEXT_is_no_longer_supported_use_texture2DGrad_instead\n#define texture2DProjGradEXT texture2DProjGradEXT_is_no_longer_supported_use_texture2DProjGrad_instead\n#define textureCubeGradEXT textureCubeGradEXT_is_no_longer_supported_use_textureCubeGrad_instead\n#define SHADOWMAP_PASS(name) name, name ## _sampler\n#define SHADOWMAP_ACCEPT(name) texture2D name, sampler name ## _sampler\n#define TEXTURE_PASS(name) name, name ## _sampler\n#define TEXTURE_ACCEPT(name) texture2D name, sampler name ## _sampler\n#define TEXTURE_ACCEPT_HIGHP TEXTURE_ACCEPT\n#define GL2\n#define WEBGPU\n",i6="\n#extension GL_EXT_samplerless_texture_functions : require\n#define texture2D(res, uv) texture(sampler2D(res, res ## _sampler), uv)\n#define itexture2D(res, uv) texture(isampler2D(res, res ## _sampler), uv)\n#define utexture2D(res, uv) texture(usampler2D(res, res ## _sampler), uv)\n#define TEXTURE_PASS(name) name, name ## _sampler\n#define TEXTURE_ACCEPT(name) texture2D name, sampler name ## _sampler\n#define TEXTURE_ACCEPT_HIGHP TEXTURE_ACCEPT\n#define GL2\n#define WEBGPU\n#define VERTEXSHADER\n#define gl_VertexID gl_VertexIndex\n#define gl_InstanceID gl_InstanceIndex\n",i8="\nvec2 getGrabScreenPos(vec4 clipPos) {\n	vec2 uv = (clipPos.xy / clipPos.w) * 0.5 + 0.5;\n	#ifdef WEBGPU\n		uv.y = 1.0 - uv.y;\n	#endif\n	return uv;\n}\nvec2 getImageEffectUV(vec2 uv) {\n	#ifdef WEBGPU\n		uv.y = 1.0 - uv.y;\n	#endif\n	return uv;\n}\n",i9="\nfn getGrabScreenPos(clipPos: vec4<f32>) -> vec2<f32> {\n	var uv: vec2<f32> = (clipPos.xy / clipPos.w) * 0.5 + vec2<f32>(0.5);\n	uv.y = 1.0 - uv.y;\n	return uv;\n}\nfn getImageEffectUV(uv: vec2<f32>) -> vec2<f32> {\n	var modifiedUV: vec2<f32> = uv;\n	modifiedUV.y = 1.0 - modifiedUV.y;\n	return modifiedUV;\n}\nstruct WrappedF32 { @size(16) element: f32 }\nstruct WrappedI32 { @size(16) element: i32 }\nstruct WrappedU32 { @size(16) element: u32 }\nstruct WrappedVec2F { @size(16) element: vec2f }\nstruct WrappedVec2I { @size(16) element: vec2i }\nstruct WrappedVec2U { @size(16) element: vec2u }\n";let i7={vertex_position:e2,vertex_normal:e3,vertex_tangent:e4,vertex_texCoord0:e7,vertex_texCoord1:te,vertex_texCoord2:tt,vertex_texCoord3:ts,vertex_texCoord4:ti,vertex_texCoord5:tn,vertex_texCoord6:tr,vertex_texCoord7:ta,vertex_color:e8,vertex_boneIndices:e6,vertex_boneWeights:e5};class ne{static createDefinition(e,t){var s,i;let n,r;let a=(t,s,i,n)=>{let r=e.isWebGPU?t:s,a="";if(!i){var o,l;let t=null!=(o=n.fragmentOutputTypes)?o:"vec4";Array.isArray(t)||(t=[t]);for(let s=0;s<e.maxColorAttachments;s++){a+="#define COLOR_ATTACHMENT_"+s+"\n";let e=null!=(l=t[s])?l:"vec4";a+="#define outType_"+s+" "+e+"\n";}}return a+r},o=null!=(s=t.name)?s:"Untitled",l=ne.getDefinesCode(e,t.vertexDefines),h=ne.getDefinesCode(e,t.fragmentDefines);return t.shaderLanguage===tN?(n="\n                \n#define VERTEXSHADER\n\n                "+i9+"\n                "+l+"\n                "+t.vertexCode+"\n            ",r="\n                \n\n                "+i9+"\n                "+h+"\n                "+t.fragmentCode+"\n            "):(n=ne.versionCode(e)+a(i6,i4,true,t)+l+ne.precisionCode(e)+"\n                "+i8+"\n                "+ne.getShaderNameCode(o)+"\n                "+t.vertexCode,r=(t.fragmentPreamble||"")+ne.versionCode(e)+a(i5,i3,false,t)+h+ne.precisionCode(e)+"\n                "+i8+"\n                "+ne.getShaderNameCode(o)+"\n                "+(t.fragmentCode||ne.dummyFragmentCode())),{name:o,shaderLanguage:null!=(i=t.shaderLanguage)?i:tF,attributes:t.attributes,vshader:n,vincludes:t.vertexIncludes,fincludes:t.fragmentIncludes,fshader:r,useTransformFeedback:t.useTransformFeedback,meshUniformBufferFormat:t.meshUniformBufferFormat,meshBindGroupFormat:t.meshBindGroupFormat}}static getDefinesCode(e,t){let s="";return e.capsDefines.forEach((e,t)=>{s+="#define "+t+" "+e+"\n";}),s+="\n",null==t||t.forEach((e,t)=>{s+="#define "+t+" "+e+"\n";}),s+="\n"}static getShaderNameCode(e){return "#define SHADER_NAME "+e+"\n"}static dummyFragmentCode(){return "void main(void) {gl_FragColor = vec4(0.0);}"}static versionCode(e){return e.isWebGPU?"#version 450\n":"#version 300 es\n"}static precisionCode(e,t){t&&"highp"!==t&&"mediump"!==t&&"lowp"!==t&&(t=null),t&&("highp"===t&&"highp"!==e.maxPrecision&&(t="mediump"),"mediump"===t&&"lowp"===e.maxPrecision&&(t="lowp"));let s=t||e.precision;return "\n            precision "+s+" float;\n            precision "+s+" int;\n            precision "+s+" usampler2D;\n            precision "+s+" isampler2D;\n            precision "+s+" sampler2DShadow;\n            precision "+s+" samplerCubeShadow;\n            precision "+s+" sampler2DArray;\n        "}static collectAttributes(e){let t={},s=0,i=e.indexOf("attribute");for(;i>=0&&(!(i>0)||"/"!==e[i-1]);){let n=false;if(i>0){let t=e.lastIndexOf("\n",i);t=-1!==t?t+1:0,e.substring(t,i).includes("#")&&(n=true);}if(!n){let n=e.indexOf(";",i),r=e.lastIndexOf(" ",n),a=e.substring(r+1,n);if(t[a]);else {let e=i7[a];void 0!==e?t[a]=e:(t[a]="ATTR"+s,s++);}}i=e.indexOf("attribute",i+1);}return t}}let nt=0;class ns{init(){this.ready=false,this.failed=false;}get label(){return "Shader Id "+this.id+" ("+(this.definition.shaderLanguage===tN?"WGSL":"GLSL")+") "+this.name}destroy(){this.device.onDestroyShader(this),this.impl.destroy(this);}loseContext(){this.init(),this.impl.loseContext();}restoreContext(){this.impl.restoreContext(this.device,this);}constructor(e,t){if(this.attributes=new Map,this.id=nt++,this.device=e,this.definition=t,this.name=t.name||"Untitled",this.init(),t.cshader);else {let i=t.shaderLanguage===tN;if(t.vshader=i2.run(t.vshader,t.vincludes,{sourceName:"vertex shader for "+this.label,stripDefines:i}),t.shaderLanguage===tF){null!=t.attributes||(t.attributes=ne.collectAttributes(t.vshader));}let n=e.isWebGL2&&("osx"===k.name||"ios"===k.name);if(t.fshader=i2.run(t.fshader,t.fincludes,{stripUnusedColorAttachments:n,stripDefines:i,sourceName:"fragment shader for "+this.label}),!t.vshader||!t.fshader){this.failed=true;return}}this.impl=e.createShaderImpl(this);}}class ni{}class nn{}class nr{destroy(){this.gpuBuffers.forEach(e=>{e.destroy(this.device);}),this.gpuBuffers=null,this.stagingBuffers.forEach(e=>{e.destroy(this.device);}),this.stagingBuffers=null,this.usedBuffers=null,this.activeBuffer=null;}alloc(e,t){if(this.activeBuffer){let e=ei.roundUp(this.activeBuffer.size,this.bufferAlignment);this.bufferSize-e<t&&this.scheduleSubmit();}if(!this.activeBuffer){let e=this.gpuBuffers.pop();e||(e=this.createBuffer(this.device,this.bufferSize,false));let t=this.stagingBuffers.pop();t||(t=this.createBuffer(this.device,this.bufferSize,true)),this.activeBuffer=new ni,this.activeBuffer.stagingBuffer=t,this.activeBuffer.gpuBuffer=e,this.activeBuffer.offset=0,this.activeBuffer.size=0;}let s=this.activeBuffer,i=ei.roundUp(s.size,this.bufferAlignment);e.gpuBuffer=s.gpuBuffer,e.offset=i,e.storage=s.stagingBuffer.alloc(i,t),s.size=i+t;}scheduleSubmit(){this.activeBuffer&&(this.usedBuffers.push(this.activeBuffer),this.activeBuffer=null);}submit(){this.scheduleSubmit();}constructor(e,t,s){this.gpuBuffers=[],this.stagingBuffers=[],this.usedBuffers=[],this.activeBuffer=null,this.device=e,this.bufferSize=t,this.bufferAlignment=s;}}let na=[];na[2]=function(e,t,s){e.storageFloat32[s]=t;},na[3]=(e,t,s)=>{let i=e.storageFloat32;i[s]=t[0],i[s+1]=t[1];},na[4]=(e,t,s)=>{let i=e.storageFloat32;i[s]=t[0],i[s+1]=t[1],i[s+2]=t[2];},na[5]=(e,t,s)=>{let i=e.storageFloat32;i[s]=t[0],i[s+1]=t[1],i[s+2]=t[2],i[s+3]=t[3];},na[1]=function(e,t,s){e.storageInt32[s]=t;},na[6]=function(e,t,s){let i=e.storageInt32;i[s]=t[0],i[s+1]=t[1];},na[7]=function(e,t,s){let i=e.storageInt32;i[s]=t[0],i[s+1]=t[1],i[s+2]=t[2];},na[8]=function(e,t,s){let i=e.storageInt32;i[s]=t[0],i[s+1]=t[1],i[s+2]=t[2],i[s+3]=t[3];},na[12]=(e,t,s)=>{let i=e.storageFloat32;i[s]=t[0],i[s+1]=t[1],i[s+4]=t[2],i[s+5]=t[3],i[s+8]=t[4],i[s+9]=t[5];},na[13]=(e,t,s)=>{let i=e.storageFloat32;i[s]=t[0],i[s+1]=t[1],i[s+2]=t[2],i[s+4]=t[3],i[s+5]=t[4],i[s+6]=t[5],i[s+8]=t[6],i[s+9]=t[7],i[s+10]=t[8];},na[17]=function(e,t,s,i){let n=e.storageFloat32;for(let e=0;e<i;e++)n[s+4*e]=t[e];},na[21]=(e,t,s,i)=>{let n=e.storageFloat32;for(let e=0;e<i;e++)n[s+4*e]=t[2*e],n[s+4*e+1]=t[2*e+1];},na[22]=(e,t,s,i)=>{let n=e.storageFloat32;for(let e=0;e<i;e++)n[s+4*e]=t[3*e],n[s+4*e+1]=t[3*e+1],n[s+4*e+2]=t[3*e+2];},na[26]=(e,t,s,i)=>{e.storageUint32[s]=t;},na[27]=(e,t,s,i)=>{let n=e.storageUint32;n[s]=t[0],n[s+1]=t[1];},na[28]=(e,t,s,i)=>{let n=e.storageUint32;n[s]=t[0],n[s+1]=t[1],n[s+2]=t[2];},na[29]=(e,t,s,i)=>{let n=e.storageUint32;n[s]=t[0],n[s+1]=t[1],n[s+2]=t[2],n[s+3]=t[3];},na[30]=function(e,t,s,i){let n=e.storageInt32;for(let e=0;e<i;e++)n[s+4*e]=t[e];},na[32]=na[30],na[31]=function(e,t,s,i){let n=e.storageUint32;for(let e=0;e<i;e++)n[s+4*e]=t[e];},na[33]=(e,t,s,i)=>{let n=e.storageInt32;for(let e=0;e<i;e++)n[s+4*e]=t[2*e],n[s+4*e+1]=t[2*e+1];},na[35]=na[33],na[34]=(e,t,s,i)=>{let n=e.storageUint32;for(let e=0;e<i;e++)n[s+4*e]=t[2*e],n[s+4*e+1]=t[2*e+1];},na[36]=(e,t,s,i)=>{let n=e.storageInt32;for(let e=0;e<i;e++)n[s+4*e]=t[3*e],n[s+4*e+1]=t[3*e+1],n[s+4*e+2]=t[3*e+2];},na[38]=na[36],na[37]=(e,t,s,i)=>{let n=e.storageUint32;for(let e=0;e<i;e++)n[s+4*e]=t[3*e],n[s+4*e+1]=t[3*e+1],n[s+4*e+2]=t[3*e+2];};class no{destroy(){if(this.persistent){let e=this.device;this.impl.destroy(e),e._vram.ub-=this.format.byteSize;}}get offset(){return this.persistent?0:this.allocation.offset}assignStorage(e){this.storageInt32=e,this.storageUint32=new Uint32Array(e.buffer,e.byteOffset,e.byteLength/4),this.storageFloat32=new Float32Array(e.buffer,e.byteOffset,e.byteLength/4);}loseContext(){var e;null==(e=this.impl)||e.loseContext();}setUniform(e,t){let s=e.offset;if(null!=t){let i=na[e.updateType];i?i(this,t,s,e.count):this.storageFloat32.set(t,s);}}set(e,t){let s=this.format.map.get(e);s&&this.setUniform(s,t);}startUpdate(e){if(!this.persistent){let t=this.allocation,s=t.gpuBuffer;this.device.dynamicBuffers.alloc(t,this.format.byteSize),this.assignStorage(t.storage),e&&(e.bindGroup=t.gpuBuffer.getBindGroup(this),e.offsets[0]=t.offset),s!==t.gpuBuffer&&(this.renderVersionDirty=this.device.renderVersion);}}endUpdate(){this.persistent?this.impl.unlock(this):(this.storageFloat32=null,this.storageInt32=null);}update(e){this.startUpdate(e);let t=this.format.uniforms;for(let e=0;e<t.length;e++){let s=t[e].scopeId.value;this.setUniform(t[e],s);}this.endUpdate();}constructor(e,t,s=true){if(this.renderVersionDirty=0,this.device=e,this.format=t,this.persistent=s,s){this.impl=e.createUniformBufferImpl(this);let s=new ArrayBuffer(t.byteSize);this.assignStorage(new Int32Array(s)),e._vram.ub+=this.format.byteSize;}else this.allocation=new nn;}}let nl={type:5,base:0,count:4,indexed:false};class nh{destroy(){this.shader.destroy(),this.shader=null,this.uniformBuffer.destroy(),this.uniformBuffer=null;}clear(e,t,s,i){var n,r,a;let o=null!=(n=(s=s||i).flags)?n:i.flags;if(0!==o){let{uniformBuffer:n,dynamicBindGroup:l}=this;if(n.startUpdate(l),e.setBindGroup(2,l.bindGroup,l.offsets),e.setBindGroup(1,e.emptyBindGroup),1&o&&(t.colorBuffer||t.impl.assignedColorTexture)){let t=null!=(r=s.color)?r:i.color;this.colorData.set(t),e.setBlendState(sh.NOBLEND);}else e.setBlendState(sh.NOWRITE);if(n.set("color",this.colorData),2&o&&t.depth){let t=null!=(a=s.depth)?a:i.depth;n.set("depth",t),e.setDepthState(su.WRITEDEPTH);}else n.set("depth",1),e.setDepthState(su.NODEPTH);4&o&&t.stencil,n.endUpdate(),e.setCullMode(0),e.setShader(this.shader),e.draw(nl);}}constructor(e){let t="\n\n            struct ub_mesh {\n                color : vec4f,\n                depth: f32\n            }\n\n            @group(2) @binding(0) var<uniform> ubMesh : ub_mesh;\n\n            var<private> pos : array<vec2f, 4> = array<vec2f, 4>(\n                vec2(-1.0, 1.0), vec2(1.0, 1.0),\n                vec2(-1.0, -1.0), vec2(1.0, -1.0)\n            );\n\n            struct VertexOutput {\n                @builtin(position) position : vec4f\n            }\n\n            @vertex\n            fn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {\n                var output : VertexOutput;\n                output.position = vec4(pos[vertexIndex], ubMesh.depth, 1.0);\n                return output;\n            }\n\n            @fragment\n            fn fragmentMain() -> @location(0) vec4f {\n                return ubMesh.color;\n            }\n        ";this.shader=new ns(e,{name:"WebGPUClearRendererShader",shaderLanguage:tN,vshader:t,fshader:t}),this.uniformBuffer=new no(e,new ir(e,[new ii("color",5),new ii("depth",2)]),false),this.dynamicBindGroup=new sa,this.colorData=new Float32Array(4);}}class nd{destroy(){this.shader.destroy(),this.shader=null;}generate(e){let t=e.desc;if(t.mipLevelCount<=1||e.texture.volume)return;let s=this.device,i=s.wgpu,n=this.shader.impl,r=i.createRenderPipeline({layout:"auto",vertex:{module:n.getVertexShaderModule(),entryPoint:n.vertexEntryPoint},fragment:{module:n.getFragmentShaderModule(),entryPoint:n.fragmentEntryPoint,targets:[{format:t.format}]},primitive:{topology:"triangle-strip"}}),a=e.texture,o=a.cubemap?6:a.array?a.arrayLength:1,l=[];for(let t=0;t<o;t++)l.push(e.createView({dimension:"2d",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:t}));let h=s.getCommandEncoder();for(let s=1;s<t.mipLevelCount;s++)for(let t=0;t<o;t++){let n=e.createView({dimension:"2d",baseMipLevel:s,mipLevelCount:1,baseArrayLayer:t}),a=h.beginRenderPass({colorAttachments:[{view:n,loadOp:"clear",storeOp:"store"}]}),o=i.createBindGroup({layout:r.getBindGroupLayout(0),entries:[{binding:0,resource:this.minSampler},{binding:1,resource:l[t]}]});a.setPipeline(r),a.setBindGroup(0,o),a.draw(4),a.end(),l[t]=n;}s.pipeline=null;}constructor(e){this.device=e;let t="\n \n            var<private> pos : array<vec2f, 4> = array<vec2f, 4>(\n                vec2(-1.0, 1.0), vec2(1.0, 1.0),\n                vec2(-1.0, -1.0), vec2(1.0, -1.0)\n            );\n\n            struct VertexOutput {\n                @builtin(position) position : vec4f,\n                @location(0) texCoord : vec2f\n            };\n\n            @vertex\n            fn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {\n              var output : VertexOutput;\n              output.texCoord = pos[vertexIndex] * vec2f(0.5, -0.5) + vec2f(0.5);\n              output.position = vec4f(pos[vertexIndex], 0, 1);\n              return output;\n            }\n\n            @group(0) @binding(0) var imgSampler : sampler;\n            @group(0) @binding(1) var img : texture_2d<f32>;\n\n            @fragment\n            fn fragmentMain(@location(0) texCoord : vec2f) -> @location(0) vec4f {\n              return textureSample(img, imgSampler, texCoord);\n            }\n        ";this.shader=new ns(e,{name:"WebGPUMipmapRendererShader",shaderLanguage:tN,vshader:t,fshader:t}),this.minSampler=e.wgpu.createSampler({minFilter:"linear"});}}class nc{getBindGroup(e){let t=e.format.byteSize,s=this.bindGroupCache.get(t);return s||((s=new so(this.device,this.bindGroupFormat,e)).update(),this.bindGroupCache.set(t,s)),s}constructor(e){this.bindGroupCache=new Map,this.device=e,this.bindGroupFormat=new t6(this.device,[new t2(tY,3)]);}}class nu extends nc{destroy(e){e._vram.ub-=this.buffer.size,this.buffer.destroy(),this.buffer=null;}onAvailable(){this.mappedRange=this.buffer.getMappedRange();}alloc(e,t){return new Int32Array(this.mappedRange,e,t/4)}constructor(e,t,s){super(e),this.buffer=null,this.mappedRange=null,this.buffer=e.wgpu.createBuffer({size:t,usage:s?GPUBufferUsage.MAP_WRITE|GPUBufferUsage.COPY_SRC:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:s}),s&&this.onAvailable(),e._vram.ub+=t;}}class np extends nr{createBuffer(e,t,s){return new nu(e,t,s)}submit(){super.submit();let e=this.usedBuffers.length;if(e){let t=this.device,s=this.gpuBuffers,i=t.wgpu.createCommandEncoder();for(let t=e-1;t>=0;t--){let{stagingBuffer:e,gpuBuffer:n,offset:r,size:a}=this.usedBuffers[t],o=e.buffer;o.unmap(),i.copyBufferToBuffer(o,r,n.buffer,r,a),s.push(n);}let n=i.finish();t.addCommandBuffer(n,true);for(let t=0;t<e;t++){let e=this.usedBuffers[t].stagingBuffer;this.pendingStagingBuffers.push(e);}this.usedBuffers.length=0;}}onCommandBuffersSubmitted(){let e=this.pendingStagingBuffers.length;if(e){for(let t=0;t<e;t++){let e=this.pendingStagingBuffers[t];e.buffer.mapAsync(GPUMapMode.WRITE).then(()=>{this.stagingBuffers&&(e.onAvailable(),this.stagingBuffers.push(e));});}this.pendingStagingBuffers.length=0;}}constructor(...e){super(...e),this.pendingStagingBuffers=[];}}class nf{loseContext(){this.pastFrameAllocations.clear();}set enabled(e){this._enableRequest=e;}get enabled(){return this._enableRequest}processEnableRequest(){this._enableRequest===this._enabled||(this._enabled=this._enableRequest,this._enabled||(this._frameTime=0));}request(e){this.pastFrameAllocations.set(e,this.frameAllocations),this.frameAllocations=[];}report(e,t){if(t){let s=this.pastFrameAllocations.get(e);if(t.length>0&&(this._frameTime=t[0]),es.get(E))for(let e=0;e<s.length;++e)s[e],t[e];}this.pastFrameAllocations.delete(e);}getSlot(e){let t=this.frameAllocations.length;return this.frameAllocations.push(e),t}get slotCount(){return this.frameAllocations.length}constructor(){this.frameAllocations=[],this.pastFrameAllocations=new Map,this._enabled=false,this._enableRequest=false,this._frameTime=0;}}class nm{destroy(){var e,t;null==(e=this.querySet)||e.destroy(),this.querySet=null,null==(t=this.queryBuffer)||t.destroy(),this.queryBuffer=null,this.activeStagingBuffer=null,this.stagingBuffers.forEach(e=>{e.destroy();}),this.stagingBuffers=null;}getStagingBuffer(){let e=this.stagingBuffers.pop();return e||(e=this.device.wgpu.createBuffer({size:this.queryBuffer.size,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ})),e}resolve(e){let t=this.device.getCommandEncoder();t.resolveQuerySet(this.querySet,0,e,this.queryBuffer,0);let s=this.getStagingBuffer();this.activeStagingBuffer=s,t.copyBufferToBuffer(this.queryBuffer,0,s,0,this.bytesPerSlot*e);}request(e,t){let s=this.activeStagingBuffer;return this.activeStagingBuffer=null,s.mapAsync(GPUMapMode.READ).then(()=>{var i;let n=new BigInt64Array(s.getMappedRange()),r=[];for(let t=0;t<e;t++)r.push(1e-6*Number(n[2*t+1]-n[2*t]));return s.unmap(),null==(i=this.stagingBuffers)||i.push(s),{renderVersion:t,timings:r}})}constructor(e,t,s){this.stagingBuffers=[],this.activeStagingBuffer=null,this.device=e,this.capacity=s,this.bytesPerSlot=t?8:4;let i=e.wgpu;this.querySet=i.createQuerySet({type:t?"timestamp":"occlusion",count:s}),this.queryBuffer=i.createBuffer({size:this.bytesPerSlot*s,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST});}}class n_ extends nf{destroy(){var e;null==(e=this.timestampQueriesSet)||e.destroy(),this.timestampQueriesSet=null;}frameStart(){this.processEnableRequest();}frameEnd(){if(this._enabled){var e;null==(e=this.timestampQueriesSet)||e.resolve(2*this.slotCount);}}request(){if(this._enabled){var e;let t=this.device.renderVersion;null==(e=this.timestampQueriesSet)||e.request(this.slotCount,t).then(e=>{this.report(e.renderVersion,e.timings);}),super.request(t);}}constructor(e){super(),this.device=e,this.timestampQueriesSet=e.supportsTimestampQuery?new nm(e,true,512):null;}}class ng{destroy(){this.shader.destroy(),this.shader=null,this.pipelineCache=null;}getPipeline(e){let t=this.pipelineCache.get(e);return t||(t=this.createPipeline(e),this.pipelineCache.set(e,t)),t}createPipeline(e){let t=this.shader.impl;return this.device.wgpu.createRenderPipeline({layout:"auto",vertex:{module:t.getVertexShaderModule(),entryPoint:t.vertexEntryPoint},fragment:{module:t.getFragmentShaderModule(),entryPoint:t.fragmentEntryPoint,targets:[{format:e}]},primitive:{topology:"triangle-strip"}})}resolveDepth(e,t,s){let i=this.device,n=i.wgpu,r=this.getPipeline(s.format),a=t.depthOrArrayLayers;for(let i=0;i<a;i++){let a=t.createView({dimension:"2d",aspect:"depth-only",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:i}),o=s.createView({dimension:"2d",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:i}),l=e.beginRenderPass({colorAttachments:[{view:o,loadOp:"clear",storeOp:"store"}]}),h=n.createBindGroup({layout:r.getBindGroupLayout(0),entries:[{binding:0,resource:a}]});l.setPipeline(r),l.setBindGroup(0,h),l.draw(4),l.end();}i.pipeline=null;}constructor(e){this.pipelineCache=new Map,this.device=e;let t="\n \n            var<private> pos : array<vec2f, 4> = array<vec2f, 4>(\n                vec2(-1.0, 1.0), vec2(1.0, 1.0), vec2(-1.0, -1.0), vec2(1.0, -1.0)\n            );\n\n            struct VertexOutput {\n                @builtin(position) position : vec4f,\n            };\n\n            @vertex\n            fn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {\n              var output : VertexOutput;\n              output.position = vec4f(pos[vertexIndex], 0, 1);\n              return output;\n            }\n\n            @group(0) @binding(0) var img : texture_depth_multisampled_2d;\n\n            @fragment\n            fn fragmentMain(@builtin(position) fragColor: vec4f) -> @location(0) vec4f {\n                // load th depth value from sample index 0\n                var depth = textureLoad(img, vec2i(fragColor.xy), 0u);\n                return vec4f(depth, 0.0, 0.0, 0.0);\n            }\n        ";this.shader=new ns(e,{name:"WebGPUResolverDepthShader",shaderLanguage:tN,vshader:t,fshader:t});}}class nv{destroy(){this.uniformBuffers.forEach(e=>e.destroy()),this.uniformBuffers.length=0,this.bindGroup.destroy(),this.bindGroup=null;}updateBindGroup(){let{bindGroup:e}=this;e.updateUniformBuffers(),e.update();}dispatch(e,t,s){let i=this.compute.device;i.setBindGroup(0,this.bindGroup);let n=i.passEncoder;n.setPipeline(this.pipeline),n.dispatchWorkgroups(e,t,s);}constructor(e){this.uniformBuffers=[],this.bindGroup=null,this.compute=e;let{device:t,shader:s}=e,{computeBindGroupFormat:i,computeUniformBufferFormats:n}=s.impl;if(this.bindGroup=new so(t,i),n){for(let e in n)if(n.hasOwnProperty(e)){let s=new no(t,n[e],true);this.uniformBuffers.push(s),this.bindGroup.setUniformBuffer(e,s);}}this.pipeline=t.computePipeline.get(s,i);}}let ny=new Map;class nS extends sM{destroy(){this.clearRenderer.destroy(),this.clearRenderer=null,this.mipmapRenderer.destroy(),this.mipmapRenderer=null,this.resolver.destroy(),this.resolver=null,super.destroy();}initDeviceCaps(){var e;let t=null==(e=this.wgpu)?void 0:e.limits;this.limits=t,this.precision="highp",this.maxPrecision="highp",this.maxSamples=4,this.maxTextures=16,this.maxTextureSize=t.maxTextureDimension2D,this.maxCubeMapSize=t.maxTextureDimension2D,this.maxVolumeSize=t.maxTextureDimension3D,this.maxColorAttachments=t.maxColorAttachments,this.maxPixelRatio=1,this.maxAnisotropy=16,this.fragmentUniformsCount=t.maxUniformBufferBindingSize/16,this.vertexUniformsCount=t.maxUniformBufferBindingSize/16,this.supportsUniformBuffers=true,this.supportsAreaLights=true,this.supportsGpuParticles=true,this.supportsCompute=true,this.textureFloatRenderable=true,this.textureHalfFloatRenderable=true,this.supportsImageBitmap=true,this.samples=this.backBufferAntialias?4:1;let s=navigator.gpu.wgslLanguageFeatures;this.supportsStorageTextureRead=null==s?void 0:s.has("readonly_and_readwrite_storage_textures"),this.initCapsDefines();}async initWebGpu(e,t){if(!window.navigator.gpu)throw Error("Unable to retrieve GPU. Ensure you are using a browser that supports WebGPU rendering.");let s=e=>new URL(e,window.location.href).toString(),i=await Promise.all([Function("modulePath","return import(modulePath)")(""+s(t)).then(e=>twgsl(t.replace(".js",".wasm"))),Function("modulePath","return import(modulePath)")(""+s(e)).then(e=>e.default())]);return this.twgsl=i[0],this.glslang=i[1],this.createDevice()}async createDevice(){var e,t;let s={powerPreference:"default"!==this.initOptions.powerPreference?this.initOptions.powerPreference:void 0};this.gpuAdapter=await window.navigator.gpu.requestAdapter(s);let i=[],n=e=>{let t=this.gpuAdapter.features.has(e);return t&&i.push(e),t};this.textureFloatFilterable=n("float32-filterable"),this.textureFloatBlendable=n("float32-blendable"),this.extCompressedTextureS3TC=n("texture-compression-bc"),this.extCompressedTextureETC=n("texture-compression-etc2"),this.extCompressedTextureASTC=n("texture-compression-astc"),this.supportsTimestampQuery=n("timestamp-query"),this.supportsDepthClip=n("depth-clip-control"),this.supportsDepth32Stencil=n("depth32float-stencil8"),this.supportsIndirectFirstInstance=n("indirect-first-instance"),this.supportsShaderF16=n("shader-f16"),this.supportsStorageRGBA8=n("bgra8unorm-storage"),this.textureRG11B10Renderable=n("rg11b10ufloat-renderable"),this.supportsClipDistances=n("clip-distances");let r=null==(e=this.gpuAdapter)?void 0:e.limits,a={};if(r)for(let e in r)"minSubgroupSize"!==e&&"maxSubgroupSize"!==e&&(a[e]=r[e]);this.wgpu=await this.gpuAdapter.requestDevice({requiredFeatures:i,requiredLimits:a,defaultQueue:{label:"Default Queue"}}),null==(t=this.wgpu.lost)||t.then(this.handleDeviceLost.bind(this)),this.initDeviceCaps(),this.gpuContext=this.canvas.getContext("webgpu");let o="standard",l=navigator.gpu.getPreferredCanvasFormat(),h=this.initOptions.displayFormat;if(this.backBufferFormat="rgba8unorm"===l?h===tW?20:7:h===tW?64:31,this.backBufferViewFormat=h===tW?""+l+"-srgb":l,"hdr"===h&&this.textureFloatFilterable){let e=window.matchMedia("(dynamic-range: high)");(null==e?void 0:e.matches)&&(this.backBufferFormat=12,this.backBufferViewFormat="rgba16float",l="rgba16float",this.isHdr=true,o="extended");}return this.canvasConfig={device:this.wgpu,colorSpace:"srgb",alphaMode:this.initOptions.alpha?"premultiplied":"opaque",format:l,toneMapping:{mode:o},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC|GPUTextureUsage.COPY_DST,viewFormats:h===tW?[this.backBufferViewFormat]:[]},this.gpuContext.configure(this.canvasConfig),this.createBackbuffer(),this.clearRenderer=new nh(this),this.mipmapRenderer=new nd(this),this.resolver=new ng(this),this.postInit(),this}async handleDeviceLost(e){"destroyed"!==e.reason&&(super.loseContext(),await this.createDevice(),super.restoreContext());}postInit(){super.postInit(),this.initializeRenderState(),this.setupPassEncoderDefaults(),this.gpuProfiler=new n_(this),this.dynamicBuffers=new np(this,102400,this.limits.minUniformBufferOffsetAlignment),this.emptyBindGroup=new so(this,new t6(this,[])),this.emptyBindGroup.update();}createBackbuffer(){this.supportsStencil=this.initOptions.stencil,this.backBuffer=new sR({name:"WebgpuFramebuffer",graphicsDevice:this,depth:this.initOptions.depth,stencil:this.supportsStencil,samples:this.samples}),this.backBuffer.impl.isBackbuffer=true;}frameStart(){super.frameStart(),this.gpuProfiler.frameStart(),this.submit();let e=this.gpuContext.getCurrentTexture();(this.backBufferSize.x!==e.width||this.backBufferSize.y!==e.height)&&(this.backBufferSize.set(e.width,e.height),this.backBuffer.destroy(),this.backBuffer=null,this.createBackbuffer());let t=this.backBuffer,s=t.impl;s.setColorAttachment(0,void 0,this.backBufferViewFormat),this.initRenderTarget(t),s.assignColorTexture(this,e);}frameEnd(){super.frameEnd(),this.gpuProfiler.frameEnd(),this.submit(),this.contextLost||this.gpuProfiler.request();}createBufferImpl(e){return new sk(e)}createUniformBufferImpl(e){return new iV(e)}createVertexBufferImpl(e,t,s){return new iG(e,t,s)}createIndexBufferImpl(e,t){return new sz(e,t)}createShaderImpl(e){return new iN(e)}createTextureImpl(e){return new iz(e)}createRenderTargetImpl(e){return new it(e)}createBindGroupFormatImpl(e){return new sU(e)}createBindGroupImpl(e){return new sL}createComputeImpl(e){return new nv(e)}setBindGroup(e,t,s){this.passEncoder&&(this.passEncoder.setBindGroup(e,t.impl.bindGroup,null!=s?s:t.uniformBufferOffsets),this.bindGroupFormats[e]=t.format.impl);}submitVertexBuffer(e,t){let{interleaved:s,elements:i}=e.format,n=i.length,r=e.impl.buffer;if(s)return this.passEncoder.setVertexBuffer(t,r),1;for(let e=0;e<n;e++)this.passEncoder.setVertexBuffer(t+e,r,i[e].offset);return n}validateVBLocations(e,t){let s=e=>{let{elements:t}=e.format;for(let e=0;e<t.length;e++){let s=t[e].name,i=tJ[s];ny.has(i),ny.set(i,s);}};s(e),s(t),ny.clear();}draw(e,t,s){if(void 0===t&&(t=1),this.shader.ready&&!this.shader.failed){let s=this.passEncoder,i=this.vertexBuffers[0],n=this.vertexBuffers[1];if(i){let e=this.submitVertexBuffer(i,0);n&&this.submitVertexBuffer(n,e);}let r=this.indexBuffer,a=this.renderPipeline.get(e,null==i?void 0:i.format,null==n?void 0:n.format,null==r?void 0:r.format,this.shader,this.renderTarget,this.bindGroupFormats,this.blendState,this.depthState,this.cullMode,this.stencilEnabled,this.stencilFront,this.stencilBack);this.pipeline!==a&&(this.pipeline=a,s.setPipeline(a)),r?(s.setIndexBuffer(r.impl.buffer,r.impl.format),s.drawIndexed(e.count,t,e.base,0,0)):s.draw(e.count,t,e.base,0);}this.vertexBuffers.length=0,this.indexBuffer=null;}setShader(e,t){e!==this.shader&&(this.shader=e);}setBlendState(e){this.blendState.copy(e);}setDepthState(e){this.depthState.copy(e);}setStencilState(e,t){if(e||t){this.stencilEnabled=true,this.stencilFront.copy(null!=e?e:sC.DEFAULT),this.stencilBack.copy(null!=t?t:sC.DEFAULT);let s=this.stencilFront.ref;this.stencilRef!==s&&(this.stencilRef=s,this.passEncoder.setStencilReference(s));}else this.stencilEnabled=false;}setBlendColor(e,t,s,i){let n=this.blendColor;(e!==n.r||t!==n.g||s!==n.b||i!==n.a)&&(n.set(e,t,s,i),this.passEncoder.setBlendConstant(n));}setCullMode(e){this.cullMode=e;}setAlphaToCoverage(e){}initializeContextCaches(){super.initializeContextCaches();}setupPassEncoderDefaults(){this.pipeline=null,this.stencilRef=0,this.blendColor.set(0,0,0,0);}_uploadDirtyTextures(){this.textures.forEach(e=>{(e._needsUpload||e._needsMipmaps)&&e.upload();});}setupTimeStampWrites(e,t){if(this.gpuProfiler._enabled&&this.gpuProfiler.timestampQueriesSet){let s=this.gpuProfiler.getSlot(t);(e=null!=e?e:{}).timestampWrites={querySet:this.gpuProfiler.timestampQueriesSet.querySet,beginningOfPassWriteIndex:2*s,endOfPassWriteIndex:2*s+1};}return e}startRenderPass(e){this._uploadDirtyTextures();let t=e.renderTarget||this.backBuffer;this.renderTarget=t;let s=t.impl;t!==this.backBuffer&&this.initRenderTarget(t),s.setupForRenderPass(e,t);let i=s.renderPassDescriptor;this.setupTimeStampWrites(i,e.name);let n=this.getCommandEncoder();this.passEncoder=n.beginRenderPass(i),this.passEncoder.label=e.name+"-PassEncoder RT:"+t.name,this.setupPassEncoderDefaults();let{width:r,height:a}=t;this.setViewport(0,0,r,a),this.setScissor(0,0,r,a),this.insideRenderPass=true;}endRenderPass(e){this.passEncoder.end(),this.passEncoder=null,this.insideRenderPass=false,this.bindGroupFormats.length=0;let t=this.renderTarget;if(t&&t.depthBuffer&&e.depthStencilOps.resolveDepth&&e.samples>1&&t.autoResolve){let e=t.impl.depthAttachment,s=t.depthBuffer.impl.gpuTexture;e&&s&&this.resolver.resolveDepth(this.commandEncoder,e.multisampledDepthBuffer,s);}for(let t=0;t<e.colorArrayOps.length;t++)e.colorArrayOps[t].genMipmaps&&this.mipmapRenderer.generate(e.renderTarget._colorBuffers[t].impl);}startComputePass(e){this.pipeline=null;let t=this.setupTimeStampWrites(void 0,e),s=this.getCommandEncoder();this.passEncoder=s.beginComputePass(t),this.insideRenderPass=true;}endComputePass(){this.passEncoder.end(),this.passEncoder=null,this.insideRenderPass=false,this.bindGroupFormats.length=0;}computeDispatch(e,t){ void 0===t&&(t="Unnamed"),this.startComputePass(t);for(let t=0;t<e.length;t++){let s=e[t];s.applyParameters(),s.impl.updateBindGroup();}for(let t=0;t<e.length;t++){let s=e[t];s.impl.dispatch(s.countX,s.countY,s.countZ);}this.endComputePass();}getCommandEncoder(){let e=this.commandEncoder;return e||(e=this.wgpu.createCommandEncoder(),this.commandEncoder=e),e}endCommandEncoder(){let{commandEncoder:e}=this;if(e){let t=e.finish();this.addCommandBuffer(t),this.commandEncoder=null;}}addCommandBuffer(e,t){ void 0===t&&(t=false),t?this.commandBuffers.unshift(e):this.commandBuffers.push(e);}submit(){this.endCommandEncoder(),this.commandBuffers.length>0&&(this.dynamicBuffers.submit(),this.wgpu.queue.submit(this.commandBuffers),this.commandBuffers.length=0,this.dynamicBuffers.onCommandBuffersSubmitted());}clear(e){e.flags&&this.clearRenderer.clear(this,this.renderTarget,e,this.defaultClearOptions);}setViewport(e,t,s,i){this.passEncoder&&(this.renderTarget.flipY||(t=this.renderTarget.height-t-i),this.vx=e,this.vy=t,this.vw=s,this.vh=i,this.passEncoder.setViewport(e,t,s,i,0,1));}setScissor(e,t,s,i){this.passEncoder&&(this.renderTarget.flipY||(t=this.renderTarget.height-t-i),this.sx=e,this.sy=t,this.sw=s,this.sh=i,this.passEncoder.setScissorRect(e,t,s,i));}clearStorageBuffer(e,t,s){ void 0===t&&(t=0),void 0===s&&(s=e.byteSize),this.getCommandEncoder().clearBuffer(e.buffer,t,s);}readStorageBuffer(e,t,s,i,n){ void 0===t&&(t=0),void 0===s&&(s=e.byteSize-t),void 0===i&&(i=null),void 0===n&&(n=false);let r=this.createBufferImpl(9);r.allocate(this,s);let a=r.buffer;return this.getCommandEncoder().copyBufferToBuffer(e.buffer,t,a,0,s),this.readBuffer(r,s,i,n)}readBuffer(e,t,s,i){ void 0===s&&(s=null),void 0===i&&(i=false);let n=e.buffer;return new Promise((r,a)=>{let o=()=>{null==n||n.mapAsync(GPUMapMode.READ).then(()=>{null!=s||(s=new Uint8Array(t));let i=n.getMappedRange(0,t),a=s.constructor;s.set(new a(i)),n.unmap(),e.destroy(this),r(s);});};i?(this.submit(),o()):setTimeout(()=>{o();});})}writeStorageBuffer(e,t,s,i,n){ void 0===t&&(t=0),void 0===i&&(i=0),this.wgpu.queue.writeBuffer(e.buffer,t,s,i,n);}copyRenderTarget(e,t,s,i){let n={width:e?e.width:t.width,height:e?e.height:t.height,depthOrArrayLayers:1},r=this.getCommandEncoder();if(s){let s={texture:e?e.colorBuffer.impl.gpuTexture:this.backBuffer.impl.assignedColorTexture,mipLevel:0},i={texture:t?t.colorBuffer.impl.gpuTexture:this.backBuffer.impl.assignedColorTexture,mipLevel:0};r.copyTextureToTexture(s,i,n);}if(i){let s=(e||this.renderTarget).impl.depthAttachment.depthTexture;if(e.samples>1){let e=t.colorBuffer.impl.gpuTexture;this.resolver.resolveDepth(r,s,e);}else {let e=t?t.depthBuffer.impl.gpuTexture:this.renderTarget.impl.depthAttachment.depthTexture;r.copyTextureToTexture({texture:s,mipLevel:0},{texture:e,mipLevel:0},n);}}return  true}constructor(e,t={}){var s,i;super(e,t),this.renderPipeline=new s0(this),this.computePipeline=new s1(this),this.bindGroupFormats=[],this.commandEncoder=null,this.commandBuffers=[],(t=this.initOptions).alpha=null==(s=t.alpha)||s,this.backBufferAntialias=null!=(i=t.antialias)&&i,this.isWebGPU=true,this._deviceType=tG,this.scope.resolve(tj).setValue(0);}}class nx{destroy(e){this.bufferId&&(e.gl.deleteBuffer(this.bufferId),this.bufferId=null);}get initialized(){return !!this.bufferId}loseContext(){this.bufferId=null;}unlock(e,t,s,i){let n=e.gl;if(this.bufferId)n.bindBuffer(s,this.bufferId),n.bufferSubData(s,0,i);else {let e;switch(t){case 0:e=n.STATIC_DRAW;break;case 1:e=n.DYNAMIC_DRAW;break;case 2:e=n.STREAM_DRAW;break;case 3:e=n.DYNAMIC_COPY;}this.bufferId=n.createBuffer(),n.bindBuffer(s,this.bufferId),n.bufferData(s,i,e);}}constructor(){this.bufferId=null;}}class nT extends nx{destroy(e){super.destroy(e),e.unbindVertexArray();}loseContext(){super.loseContext(),this.vao=null;}unlock(e){let t=e.device;super.unlock(t,e.usage,t.gl.ARRAY_BUFFER,e.storage);}constructor(...e){super(...e),this.vao=null;}}class nb extends nx{unlock(e){let t=e.device;super.unlock(t,e.usage,t.gl.ELEMENT_ARRAY_BUFFER,e.storage);}constructor(e){super();let t=e.device.gl,s=e.format;0===s?this.glFormat=t.UNSIGNED_BYTE:1===s?this.glFormat=t.UNSIGNED_SHORT:2===s&&(this.glFormat=t.UNSIGNED_INT);}}class nE{constructor(e,t,s,i){if(this.locationId=i,this.scopeId=e.scope.resolve(t),this.version=new sp,"[0]"===t.substring(t.length-3))switch(s){case 2:s=17;break;case 1:s=30;break;case 26:s=31;break;case 0:s=32;break;case 3:s=21;break;case 6:s=33;break;case 27:s=34;break;case 9:s=35;break;case 4:s=22;break;case 7:s=36;break;case 28:s=37;break;case 10:s=38;break;case 5:s=23;break;case 8:s=39;break;case 29:s=40;break;case 11:s=41;}this.dataType=s,this.value=[null,null,null,null],this.array=[];}}let nA=new Set(["gl_VertexID","gl_InstanceID","gl_DrawID","gl_BaseVertex","gl_BaseInstance"]);class nw{destroy(e){this.map.forEach(t=>{e.gl.deleteShader(t);});}loseContext(e){this.map.clear();}constructor(){this.map=new Map;}}let nC=new t8,nP=new t8;class nM{destroy(e){this.glProgram&&(e.device.gl.deleteProgram(this.glProgram),this.glProgram=null);}init(){this.uniforms=[],this.samplers=[],this.attributes=[],this.glProgram=null,this.glVertexShader=null,this.glFragmentShader=null;}loseContext(){this.init();}restoreContext(e,t){this.compile(e,t),this.link(e,t);}compile(e,t){let s=t.definition;this.glVertexShader=this._compileShaderSource(e,s.vshader,true),this.glFragmentShader=this._compileShaderSource(e,s.fshader,false);}link(e,t){if(this.glProgram)return;let s=e.gl;if(s.isContextLost())return;let i=s.createProgram();this.glProgram=i,s.attachShader(i,this.glVertexShader),s.attachShader(i,this.glFragmentShader);let n=t.definition,r=n.attributes;if(n.useTransformFeedback){let e=[];for(let t in r)r.hasOwnProperty(t)&&e.push("out_"+t);s.transformFeedbackVaryings(i,e,s.INTERLEAVED_ATTRIBS);}for(let e in r)if(r.hasOwnProperty(e)){let t=tJ[r[e]];s.bindAttribLocation(i,t,e);}s.linkProgram(i);}_compileShaderSource(e,t,s){let i=e.gl;if(i.isContextLost())return null;let n=(s?nC:nP).get(e,()=>new nw),r=n.map.get(t);return r||(r=i.createShader(s?i.VERTEX_SHADER:i.FRAGMENT_SHADER),i.shaderSource(r,t),i.compileShader(r),n.map.set(t,r)),r}finalize(e,t){let s=e.gl;if(s.isContextLost())return  true;let i=this.glProgram,n=t.definition;if(!s.getProgramParameter(i,s.LINK_STATUS))return !!(this._isCompiled(e,t,this.glVertexShader,n.vshader,"vertex")&&this._isCompiled(e,t,this.glFragmentShader,n.fshader,"fragment"))&&(s.getProgramInfoLog(i),false);let r=s.getProgramParameter(i,s.ACTIVE_ATTRIBUTES);t.attributes.clear();for(let e=0;e<r;e++){let r=s.getActiveAttrib(i,e),a=s.getAttribLocation(i,r.name);!nA.has(r.name)&&(void 0===n.attributes[r.name]?t.failed=true:t.attributes.set(a,r.name));}let a=e._samplerTypes,o=s.getProgramParameter(i,s.ACTIVE_UNIFORMS);for(let t=0;t<o;t++){let n=s.getActiveUniform(i,t),r=s.getUniformLocation(i,n.name),o=new nE(e,n.name,e.pcUniformType[n.type],r);a.has(n.type)?this.samplers.push(o):this.uniforms.push(o);}return t.ready=true,true}_isCompiled(e,t,s,i,n){let r=e.gl;if(!r.getShaderParameter(s,r.COMPILE_STATUS)){let e=r.getShaderInfoLog(s),[t,n]=this._processError(i,e);return  false}return  true}isLinked(e){let{extParallelShaderCompile:t}=e;return !t||e.gl.getProgramParameter(this.glProgram,t.COMPLETION_STATUS_KHR)}_processError(e,t){let s={},i="";if(e){let n=e.split("\n"),r=0,a=n.length;if(t&&t.startsWith("ERROR:")){let e=t.match(/^ERROR:\s(\d+):(\d+):\s*(.+)/);e&&(s.message=e[3],s.line=parseInt(e[2],10),r=Math.max(0,s.line-6),a=Math.min(n.length,s.line+5));}for(let e=r;e<a;e++)i+=(e+1===s.line?"> ":"  ")+(e+1)+":	"+n[e]+"\n";s.source=e;}return [i,s]}constructor(e){this.compileDuration=0,this.init(),this.compile(e.device,e),this.link(e.device,e),e.device.shaders.push(e);}}function nI(e,t){let s=e.width,i=e.height;if(s>t||i>t){let n=t/Math.max(s,i),r=Math.floor(s*n),a=Math.floor(i*n),o=document.createElement("canvas");return o.width=r,o.height=a,o.getContext("2d").drawImage(e,0,0,s,i,0,0,r,a),o}return e}class nR{destroy(e){if(this._glTexture){for(let t=0;t<e.textureUnits.length;t++){let s=e.textureUnits[t];for(let e=0;e<s.length;e++)s[e]===this._glTexture&&(s[e]=null);}e.gl.deleteTexture(this._glTexture),this._glTexture=null;}}loseContext(){this._glTexture=null;}propertyChanged(e){this.dirtyParameterFlags|=e;}initialize(e,t){let s=e.gl;switch(this._glTexture=s.createTexture(),this._glTarget=t._cubemap?s.TEXTURE_CUBE_MAP:t._volume?s.TEXTURE_3D:t.array?s.TEXTURE_2D_ARRAY:s.TEXTURE_2D,t._format){case 0:this._glFormat=s.ALPHA,this._glInternalFormat=s.ALPHA,this._glPixelType=s.UNSIGNED_BYTE;break;case 1:this._glFormat=s.LUMINANCE,this._glInternalFormat=s.LUMINANCE,this._glPixelType=s.UNSIGNED_BYTE;break;case 2:this._glFormat=s.LUMINANCE_ALPHA,this._glInternalFormat=s.LUMINANCE_ALPHA,this._glPixelType=s.UNSIGNED_BYTE;break;case 52:this._glFormat=s.RED,this._glInternalFormat=s.R8,this._glPixelType=s.UNSIGNED_BYTE;break;case 53:this._glFormat=s.RG,this._glInternalFormat=s.RG8,this._glPixelType=s.UNSIGNED_BYTE;break;case 3:this._glFormat=s.RGB,this._glInternalFormat=s.RGB565,this._glPixelType=s.UNSIGNED_SHORT_5_6_5;break;case 4:this._glFormat=s.RGBA,this._glInternalFormat=s.RGB5_A1,this._glPixelType=s.UNSIGNED_SHORT_5_5_5_1;break;case 5:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA4,this._glPixelType=s.UNSIGNED_SHORT_4_4_4_4;break;case 6:this._glFormat=s.RGB,this._glInternalFormat=s.RGB8,this._glPixelType=s.UNSIGNED_BYTE;break;case 7:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA8,this._glPixelType=s.UNSIGNED_BYTE;break;case 31:case 64:break;case 8:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTextureS3TC.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case 9:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case 10:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case 21:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTextureETC1.COMPRESSED_RGB_ETC1_WEBGL;break;case 24:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;break;case 25:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;break;case 26:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;break;case 27:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;break;case 22:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_RGB8_ETC2;break;case 23:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_RGBA8_ETC2_EAC;break;case 28:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureASTC.COMPRESSED_RGBA_ASTC_4x4_KHR;break;case 29:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTextureATC.COMPRESSED_RGB_ATC_WEBGL;break;case 30:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureATC.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL;break;case 65:this._glFormat=s.RGB,this._glInternalFormat=e.extTextureCompressionBPTC.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT;break;case 66:this._glFormat=s.RGB,this._glInternalFormat=e.extTextureCompressionBPTC.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT;break;case 67:this._glFormat=s.RGBA,this._glInternalFormat=e.extTextureCompressionBPTC.COMPRESSED_RGBA_BPTC_UNORM_EXT;break;case 54:this._glFormat=s.SRGB,this._glInternalFormat=e.extCompressedTextureS3TC_SRGB.COMPRESSED_SRGB_S3TC_DXT1_EXT;break;case 55:this._glFormat=s.SRGB_ALPHA,this._glInternalFormat=e.extCompressedTextureS3TC_SRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;break;case 56:this._glFormat=s.SRGB_ALPHA,this._glInternalFormat=e.extCompressedTextureS3TC_SRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;break;case 61:this._glFormat=s.SRGB,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_SRGB8_ETC2;break;case 62:this._glFormat=s.SRGB_ALPHA,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;break;case 63:this._glFormat=s.SRGB_ALPHA,this._glInternalFormat=e.extCompressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 68:this._glFormat=s.RGBA,this._glInternalFormat=e.extTextureCompressionBPTC.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 50:this._glFormat=s.RED,this._glInternalFormat=s.R16F,this._glPixelType=s.HALF_FLOAT;break;case 51:this._glFormat=s.RG,this._glInternalFormat=s.RG16F,this._glPixelType=s.HALF_FLOAT;break;case 11:this._glFormat=s.RGB,this._glInternalFormat=s.RGB16F,this._glPixelType=s.HALF_FLOAT;break;case 12:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA16F,this._glPixelType=s.HALF_FLOAT;break;case 13:this._glFormat=s.RGB,this._glInternalFormat=s.RGB32F,this._glPixelType=s.FLOAT;break;case 14:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA32F,this._glPixelType=s.FLOAT;break;case 15:this._glFormat=s.RED,this._glInternalFormat=s.R32F,this._glPixelType=s.FLOAT;break;case 16:this._glFormat=s.DEPTH_COMPONENT,this._glInternalFormat=s.DEPTH_COMPONENT32F,this._glPixelType=s.FLOAT;break;case 69:this._glFormat=s.DEPTH_COMPONENT,this._glInternalFormat=s.DEPTH_COMPONENT16,this._glPixelType=s.UNSIGNED_SHORT;break;case 17:this._glFormat=s.DEPTH_STENCIL,this._glInternalFormat=s.DEPTH24_STENCIL8,this._glPixelType=s.UNSIGNED_INT_24_8;break;case 18:this._glFormat=s.RGB,this._glInternalFormat=s.R11F_G11F_B10F,this._glPixelType=s.UNSIGNED_INT_10F_11F_11F_REV;break;case 19:this._glFormat=s.RGB,this._glInternalFormat=s.SRGB8,this._glPixelType=s.UNSIGNED_BYTE;break;case 20:this._glFormat=s.RGBA,this._glInternalFormat=s.SRGB8_ALPHA8,this._glPixelType=s.UNSIGNED_BYTE;break;case 32:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R8I,this._glPixelType=s.BYTE;break;case 33:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R8UI,this._glPixelType=s.UNSIGNED_BYTE;break;case 34:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R16I,this._glPixelType=s.SHORT;break;case 35:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R16UI,this._glPixelType=s.UNSIGNED_SHORT;break;case 36:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R32I,this._glPixelType=s.INT;break;case 37:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R32UI,this._glPixelType=s.UNSIGNED_INT;break;case 38:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG8I,this._glPixelType=s.BYTE;break;case 39:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG8UI,this._glPixelType=s.UNSIGNED_BYTE;break;case 40:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG16I,this._glPixelType=s.SHORT;break;case 41:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG16UI,this._glPixelType=s.UNSIGNED_SHORT;break;case 42:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG32I,this._glPixelType=s.INT;break;case 43:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG32UI,this._glPixelType=s.UNSIGNED_INT;break;case 44:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA8I,this._glPixelType=s.BYTE;break;case 45:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA8UI,this._glPixelType=s.UNSIGNED_BYTE;break;case 46:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA16I,this._glPixelType=s.SHORT;break;case 47:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA16UI,this._glPixelType=s.UNSIGNED_SHORT;break;case 48:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA32I,this._glPixelType=s.INT;break;case 49:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA32UI,this._glPixelType=s.UNSIGNED_INT;}this._glCreated=false;}upload(e,t){let s,i;let n=e.gl;if(!t._needsUpload&&(t._needsMipmapsUpload&&t._mipmapsUploaded||!t.pot))return;let r=0,a=t.numLevels;for(t.array&&n.texStorage3D(n.TEXTURE_2D_ARRAY,a,this._glInternalFormat,t._width,t._height,t._arrayLength);t._levels[r]||0===r;){if(t._needsUpload||0!==r){if(r&&(!t._needsMipmapsUpload||!t._mipmaps))break}else {r++;continue}if(s=t._levels[r],i=1/Math.pow(2,r),1!==r||t._compressed||t._integerFormat||!(t._levels.length<a)||(n.generateMipmap(this._glTarget),t._mipmapsUploaded=true),t._cubemap){let a;if(e._isBrowserInterface(s[0]))for(a=0;a<6;a++){if(!t._levelsUpdated[0][a])continue;let i=s[a];e._isImageBrowserInterface(i)&&(i.width>e.maxCubeMapSize||i.height>e.maxCubeMapSize)&&(i=nI(i,e.maxCubeMapSize),0===r&&(t._width=i.width,t._height=i.height)),e.setUnpackFlipY(false),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated?n.texSubImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+a,r,0,0,this._glFormat,this._glPixelType,i):n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+a,r,this._glInternalFormat,this._glFormat,this._glPixelType,i);}else for(a=0,i=1/Math.pow(2,r);a<6;a++){if(!t._levelsUpdated[0][a])continue;let o=s[a];t._compressed?this._glCreated&&o?n.compressedTexSubImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+a,r,0,0,Math.max(t._width*i,1),Math.max(t._height*i,1),this._glInternalFormat,o):n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+a,r,this._glInternalFormat,Math.max(t._width*i,1),Math.max(t._height*i,1),0,o):(e.setUnpackFlipY(false),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated&&o?n.texSubImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+a,r,0,0,Math.max(t._width*i,1),Math.max(t._height*i,1),this._glFormat,this._glPixelType,o):n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+a,r,this._glInternalFormat,Math.max(t._width*i,1),Math.max(t._height*i,1),0,this._glFormat,this._glPixelType,o));}}else if(t._volume)t._compressed?n.compressedTexImage3D(n.TEXTURE_3D,r,this._glInternalFormat,Math.max(t._width*i,1),Math.max(t._height*i,1),Math.max(t._depth*i,1),0,s):(e.setUnpackFlipY(false),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),n.texImage3D(n.TEXTURE_3D,r,this._glInternalFormat,Math.max(t._width*i,1),Math.max(t._height*i,1),Math.max(t._depth*i,1),0,this._glFormat,this._glPixelType,s));else if(t.array&&"object"==typeof s){if(t._arrayLength===s.length){if(t._compressed)for(let e=0;e<t._arrayLength;e++)n.compressedTexSubImage3D(n.TEXTURE_2D_ARRAY,r,0,0,e,Math.max(Math.floor(t._width*i),1),Math.max(Math.floor(t._height*i),1),1,this._glInternalFormat,s[e]);else for(let e=0;e<t._arrayLength;e++)n.texSubImage3D(n.TEXTURE_2D_ARRAY,r,0,0,e,Math.max(Math.floor(t._width*i),1),Math.max(Math.floor(t._height*i),1),1,this._glFormat,this._glPixelType,s[e]);}}else {if(e._isBrowserInterface(s)){e._isImageBrowserInterface(s)&&(s.width>e.maxTextureSize||s.height>e.maxTextureSize)&&(s=nI(s,e.maxTextureSize),0===r&&(t._width=s.width,t._height=s.height));let i=s.width||s.videoWidth,a=s.height||s.videoHeight;e.setUnpackFlipY(t._flipY),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated&&t._width===i&&t._height===a&&!e._isImageVideoInterface(s)?n.texSubImage2D(n.TEXTURE_2D,r,0,0,this._glFormat,this._glPixelType,s):(n.texImage2D(n.TEXTURE_2D,r,this._glInternalFormat,this._glFormat,this._glPixelType,s),0===r&&(t._width=i,t._height=a));}else i=1/Math.pow(2,r),t._compressed?this._glCreated&&s?n.compressedTexSubImage2D(n.TEXTURE_2D,r,0,0,Math.max(Math.floor(t._width*i),1),Math.max(Math.floor(t._height*i),1),this._glInternalFormat,s):n.compressedTexImage2D(n.TEXTURE_2D,r,this._glInternalFormat,Math.max(Math.floor(t._width*i),1),Math.max(Math.floor(t._height*i),1),0,s):(e.setUnpackFlipY(false),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated&&s?n.texSubImage2D(n.TEXTURE_2D,r,0,0,Math.max(t._width*i,1),Math.max(t._height*i,1),this._glFormat,this._glPixelType,s):n.texImage2D(n.TEXTURE_2D,r,this._glInternalFormat,Math.max(t._width*i,1),Math.max(t._height*i,1),0,this._glFormat,this._glPixelType,s));0===r?t._mipmapsUploaded=false:t._mipmapsUploaded=true;}r++;}if(t._needsUpload){if(t._cubemap)for(let e=0;e<6;e++)t._levelsUpdated[0][e]=false;else t._levelsUpdated[0]=false;}!t._compressed&&!t._integerFormat&&t._mipmaps&&t._needsMipmapsUpload&&1===t._levels.length&&(n.generateMipmap(this._glTarget),t._mipmapsUploaded=true),t._gpuSize&&t.adjustVramSizeTracking(e._vram,-t._gpuSize),t._gpuSize=t.gpuSize,t.adjustVramSizeTracking(e._vram,t._gpuSize),this._glCreated=true;}read(e,t,s,i,n){let r=this.texture;return r.device.readTextureAsync(r,e,t,s,i,n)}constructor(e){this._glTexture=null,this.dirtyParameterFlags=0,this.texture=e;}}class nL{destroy(e){this.msaaFB&&(e.deleteRenderbuffer(this.msaaFB),this.msaaFB=null),this.resolveFB&&(e.deleteRenderbuffer(this.resolveFB),this.resolveFB=null);}constructor(e,t){this.msaaFB=e,this.resolveFB=t;}}class nD{destroy(e){var t;let s=e.gl;this._isInitialized=false,this._glFrameBuffer&&(this._glFrameBuffer!==this.suppliedColorFramebuffer&&s.deleteFramebuffer(this._glFrameBuffer),this._glFrameBuffer=null),this._glDepthBuffer&&(s.deleteRenderbuffer(this._glDepthBuffer),this._glDepthBuffer=null),this._glResolveFrameBuffer&&(this._glResolveFrameBuffer!==this.suppliedColorFramebuffer&&s.deleteFramebuffer(this._glResolveFrameBuffer),this._glResolveFrameBuffer=null),this._glMsaaColorBuffers.forEach(e=>{s.deleteRenderbuffer(e);}),this._glMsaaColorBuffers.length=0,null==(t=this.colorMrtFramebuffers)||t.forEach(e=>{e.destroy(s);}),this.colorMrtFramebuffers=null,this._glMsaaDepthBuffer&&(this._glMsaaDepthBuffer=null,this.msaaDepthBufferKey&&s8(e).release(this.msaaDepthBufferKey)),this.suppliedColorFramebuffer=void 0;}get initialized(){return this._isInitialized}init(e,t){var s,i,n,r;let a=e.gl;this._isInitialized=true;let o=[];if(void 0!==this.suppliedColorFramebuffer)this._glFrameBuffer=this.suppliedColorFramebuffer;else {this._glFrameBuffer=a.createFramebuffer(),e.setFramebuffer(this._glFrameBuffer);let n=null!=(i=null==(s=t._colorBuffers)?void 0:s.length)?i:0,r=a.COLOR_ATTACHMENT0;for(let s=0;s<n;++s){let i=t.getColorBuffer(s);i&&(i.impl._glTexture||(i._width=Math.min(i.width,e.maxRenderBufferSize),i._height=Math.min(i.height,e.maxRenderBufferSize),e.setTexture(i,0)),a.framebufferTexture2D(a.FRAMEBUFFER,r+s,i._cubemap?a.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:a.TEXTURE_2D,i.impl._glTexture,t.mipLevel),o.push(r+s));}a.drawBuffers(o);let l=t._depthBuffer;if(l||t._depth){let s=t._stencil?a.DEPTH_STENCIL_ATTACHMENT:a.DEPTH_ATTACHMENT;if(l)l.impl._glTexture||(l._width=Math.min(l.width,e.maxRenderBufferSize),l._height=Math.min(l.height,e.maxRenderBufferSize),e.setTexture(l,0)),a.framebufferTexture2D(a.FRAMEBUFFER,s,l._cubemap?a.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:a.TEXTURE_2D,t._depthBuffer.impl._glTexture,t.mipLevel);else if(!(t._samples>1)){this._glDepthBuffer||(this._glDepthBuffer=a.createRenderbuffer());let e=t._stencil?a.DEPTH24_STENCIL8:a.DEPTH_COMPONENT32F;a.bindRenderbuffer(a.RENDERBUFFER,this._glDepthBuffer),a.renderbufferStorage(a.RENDERBUFFER,e,t.width,t.height),a.framebufferRenderbuffer(a.FRAMEBUFFER,s,a.RENDERBUFFER,this._glDepthBuffer),a.bindRenderbuffer(a.RENDERBUFFER,null);}}}if(t._samples>1){this._glResolveFrameBuffer=this._glFrameBuffer,this._glFrameBuffer=a.createFramebuffer(),e.setFramebuffer(this._glFrameBuffer);let s=null!=(r=null==(n=t._colorBuffers)?void 0:n.length)?r:0;if(void 0!==this.suppliedColorFramebuffer){let s=a.createRenderbuffer();this._glMsaaColorBuffers.push(s);let i=7===e.backBufferFormat?a.RGBA8:a.RGB8;a.bindRenderbuffer(a.RENDERBUFFER,s),a.renderbufferStorageMultisample(a.RENDERBUFFER,t._samples,i,t.width,t.height),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.RENDERBUFFER,s);}else for(let e=0;e<s;++e){let s=t.getColorBuffer(e);if(s){let i=a.createRenderbuffer();this._glMsaaColorBuffers.push(i),a.bindRenderbuffer(a.RENDERBUFFER,i),a.renderbufferStorageMultisample(a.RENDERBUFFER,t._samples,s.impl._glInternalFormat,t.width,t.height),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0+e,a.RENDERBUFFER,i);}}if(t._depth){let s;let i=t._stencil?a.DEPTH24_STENCIL8:a.DEPTH_COMPONENT32F,n=t._stencil?a.DEPTH_STENCIL_ATTACHMENT:a.DEPTH_ATTACHMENT,r=t._depthBuffer;r&&(s=r.id+":"+t.width+":"+t.height+":"+t._samples+":"+i+":"+n,this._glMsaaDepthBuffer=s8(e).get(s)),!this._glMsaaDepthBuffer&&(this._glMsaaDepthBuffer=a.createRenderbuffer(),a.bindRenderbuffer(a.RENDERBUFFER,this._glMsaaDepthBuffer),a.renderbufferStorageMultisample(a.RENDERBUFFER,t._samples,i,t.width,t.height),this._glMsaaDepthBuffer.destroy=function(){a.deleteRenderbuffer(this);},r&&s8(e).set(s,this._glMsaaDepthBuffer)),this.msaaDepthBufferKey=s,a.framebufferRenderbuffer(a.FRAMEBUFFER,n,a.RENDERBUFFER,this._glMsaaDepthBuffer);}s>1&&(this._createMsaaMrtFramebuffers(e,t,s),e.setFramebuffer(this._glFrameBuffer),a.drawBuffers(o));}}_createMsaaMrtFramebuffers(e,t,s){let i=e.gl;this.colorMrtFramebuffers=[];for(let n=0;n<s;++n){let s=t.getColorBuffer(n),r=i.createFramebuffer();e.setFramebuffer(r);let a=this._glMsaaColorBuffers[n];i.bindRenderbuffer(i.RENDERBUFFER,a),i.renderbufferStorageMultisample(i.RENDERBUFFER,t._samples,s.impl._glInternalFormat,t.width,t.height),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.RENDERBUFFER,a),i.drawBuffers([i.COLOR_ATTACHMENT0]);let o=i.createFramebuffer();e.setFramebuffer(o),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,s._cubemap?i.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:i.TEXTURE_2D,s.impl._glTexture,0),this.colorMrtFramebuffers[n]=new nL(r,o);}}_checkFbo(e,t,s){let i=e.gl;switch(i.checkFramebufferStatus(i.FRAMEBUFFER)){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:case i.FRAMEBUFFER_UNSUPPORTED:}}loseContext(){this._glFrameBuffer=null,this._glDepthBuffer=null,this._glResolveFrameBuffer=null,this._glMsaaColorBuffers.length=0,this._glMsaaDepthBuffer=null,this.msaaDepthBufferKey=void 0,this.colorMrtFramebuffers=null,this.suppliedColorFramebuffer=void 0,this._isInitialized=false;}internalResolve(e,t,s,i,n){e.setScissor(0,0,i.width,i.height);let r=e.gl;r.bindFramebuffer(r.READ_FRAMEBUFFER,t),r.bindFramebuffer(r.DRAW_FRAMEBUFFER,s),r.blitFramebuffer(0,0,i.width,i.height,0,0,i.width,i.height,n,r.NEAREST);}resolve(e,t,s,i){let n=e.gl;if(this.colorMrtFramebuffers){if(s)for(let s=0;s<this.colorMrtFramebuffers.length;s++){let i=this.colorMrtFramebuffers[s];this.internalResolve(e,i.msaaFB,i.resolveFB,t,n.COLOR_BUFFER_BIT);}i&&this.internalResolve(e,this._glFrameBuffer,this._glResolveFrameBuffer,t,n.DEPTH_BUFFER_BIT);}else this.internalResolve(e,this._glFrameBuffer,this._glResolveFrameBuffer,t,(s?n.COLOR_BUFFER_BIT:0)|(i?n.DEPTH_BUFFER_BIT:0));n.bindFramebuffer(n.FRAMEBUFFER,this._glFrameBuffer);}constructor(){this._glFrameBuffer=null,this._glDepthBuffer=null,this._glResolveFrameBuffer=null,this.colorMrtFramebuffers=null,this._glMsaaColorBuffers=[],this._glMsaaDepthBuffer=null,this._isInitialized=false;}}class nO{destroy(e){this.queries.forEach(t=>e.deleteQuery(t)),this.queries=null;}constructor(){this.queries=[];}}class nF extends nf{destroy(){this.freeQueries.forEach(e=>this.device.gl.deleteQuery(e)),this.frameQueries.forEach(e=>this.device.gl.deleteQuery(e)),this.previousFrameQueries.forEach(e=>e.destroy(this.device.gl)),this.freeQueries=null,this.frameQueries=null,this.previousFrameQueries=null;}loseContext(){super.loseContext(),this.freeQueries=[],this.frameQueries=[],this.previousFrameQueries=[];}restoreContext(){this.ext=this.device.extDisjointTimerQuery;}getQuery(){var e;return null!=(e=this.freeQueries.pop())?e:this.device.gl.createQuery()}start(e){if(this.ext){let t=this.getSlot(e),s=this.getQuery();return this.frameQueries[t]=s,this.device.gl.beginQuery(this.ext.TIME_ELAPSED_EXT,s),t}}end(e){ void 0!==e&&this.device.gl.endQuery(this.ext.TIME_ELAPSED_EXT);}frameStart(){this.processEnableRequest(),this._enabled&&(this.frameGPUMarkerSlot=this.start("GpuFrame"));}frameEnd(){this._enabled&&this.end(this.frameGPUMarkerSlot);}request(){if(this._enabled){let e=this.ext,t=this.device.gl,s=this.device.renderVersion,i=this.frameQueries;if(i.length>0){this.frameQueries=[];let e=new nO;e.queries=i,e.renderVersion=s,this.previousFrameQueries.push(e);}if(this.previousFrameQueries.length>0){let s=this.previousFrameQueries[0],i=s.queries,n=i[i.length-1],r=t.getQueryParameter(n,t.QUERY_RESULT_AVAILABLE),a=t.getParameter(e.GPU_DISJOINT_EXT);if(r&&!a){this.previousFrameQueries.shift();let e=this.timings;e.length=0;for(let s=0;s<i.length;s++){let n=i[s],r=t.getQueryParameter(n,t.QUERY_RESULT);e[s]=1e-6*r,this.freeQueries.push(n);}this.report(s.renderVersion,e);}a&&(this.previousFrameQueries.forEach(e=>{this.report(e.renderVersion,null),e.destroy(t);}),this.previousFrameQueries.length=0);}super.request(s);}}constructor(e){super(),this.freeQueries=[],this.frameQueries=[],this.previousFrameQueries=[],this.timings=[],this.device=e,this.ext=e.extDisjointTimerQuery;}}let nN=[];class nB extends sM{postInit(){super.postInit(),this.gpuProfiler=new nF(this);}destroy(){super.destroy();let e=this.gl;this.feedback&&e.deleteTransformFeedback(this.feedback),this.clearVertexArrayObjectCache(),this.canvas.removeEventListener("webglcontextlost",this._contextLostHandler,false),this.canvas.removeEventListener("webglcontextrestored",this._contextRestoredHandler,false),this._contextLostHandler=null,this._contextRestoredHandler=null,this.gl=null,super.postDestroy();}createBackbuffer(e){this.supportsStencil=this.initOptions.stencil,this.backBuffer=new sR({name:"WebglFramebuffer",graphicsDevice:this,depth:this.initOptions.depth,stencil:this.supportsStencil,samples:this.samples}),this.backBuffer.impl.suppliedColorFramebuffer=e;}updateBackbufferFormat(e){let t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,e);let s=this.gl.getParameter(this.gl.ALPHA_BITS);this.backBufferFormat=s?7:6;}updateBackbuffer(){let e=this.canvas.width!==this.backBufferSize.x||this.canvas.height!==this.backBufferSize.y;(this._defaultFramebufferChanged||e)&&(this._defaultFramebufferChanged&&this.updateBackbufferFormat(this._defaultFramebuffer),this._defaultFramebufferChanged=false,this.backBufferSize.set(this.canvas.width,this.canvas.height),this.backBuffer.destroy(),this.createBackbuffer(this._defaultFramebuffer));}createVertexBufferImpl(e,t){return new nT}createIndexBufferImpl(e){return new nb(e)}createShaderImpl(e){return new nM(e)}createTextureImpl(e){return new nR(e)}createRenderTargetImpl(e){return new nD}getPrecision(){let e=this.gl,t="highp";if(e.getShaderPrecisionFormat){let s=e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT),i=e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT),n=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT),r=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT);if(s&&i&&n&&r){let e=s.precision>0&&n.precision>0,a=i.precision>0&&r.precision>0;e||(t=a?"mediump":"lowp");}}return t}getExtension(){for(let e=0;e<arguments.length;e++)if(-1!==this.supportedExtensions.indexOf(arguments[e]))return this.gl.getExtension(arguments[e]);return null}get extDisjointTimerQuery(){return this._extDisjointTimerQuery||(this._extDisjointTimerQuery=this.getExtension("EXT_disjoint_timer_query_webgl2","EXT_disjoint_timer_query")),this._extDisjointTimerQuery}initializeExtensions(){var e;let t=this.gl;this.supportedExtensions=null!=(e=t.getSupportedExtensions())?e:[],this._extDisjointTimerQuery=null,this.textureRG11B10Renderable=true,this.extColorBufferFloat=this.getExtension("EXT_color_buffer_float"),this.textureFloatRenderable=!!this.extColorBufferFloat,this.extColorBufferHalfFloat=this.getExtension("EXT_color_buffer_half_float"),this.textureHalfFloatRenderable=!!this.extColorBufferHalfFloat||!!this.extColorBufferFloat,this.extDebugRendererInfo=this.getExtension("WEBGL_debug_renderer_info"),this.extTextureFloatLinear=this.getExtension("OES_texture_float_linear"),this.textureFloatFilterable=!!this.extTextureFloatLinear,this.extFloatBlend=this.getExtension("EXT_float_blend"),this.extTextureFilterAnisotropic=this.getExtension("EXT_texture_filter_anisotropic","WEBKIT_EXT_texture_filter_anisotropic"),this.extParallelShaderCompile=this.getExtension("KHR_parallel_shader_compile"),this.extCompressedTextureETC1=this.getExtension("WEBGL_compressed_texture_etc1"),this.extCompressedTextureETC=this.getExtension("WEBGL_compressed_texture_etc"),this.extCompressedTexturePVRTC=this.getExtension("WEBGL_compressed_texture_pvrtc","WEBKIT_WEBGL_compressed_texture_pvrtc"),this.extCompressedTextureS3TC=this.getExtension("WEBGL_compressed_texture_s3tc","WEBKIT_WEBGL_compressed_texture_s3tc"),this.extCompressedTextureS3TC_SRGB=this.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this.extCompressedTextureATC=this.getExtension("WEBGL_compressed_texture_atc"),this.extCompressedTextureASTC=this.getExtension("WEBGL_compressed_texture_astc"),this.extTextureCompressionBPTC=this.getExtension("EXT_texture_compression_bptc");}initializeCapabilities(){var e,t;let s;let i=this.gl,n="undefined"!=typeof navigator?navigator.userAgent:"";this.maxPrecision=this.precision=this.getPrecision();let r=i.getContextAttributes();this.supportsMsaa=null!=(e=null==r?void 0:r.antialias)&&e,this.supportsStencil=null!=(t=null==r?void 0:r.stencil)&&t,this.maxTextureSize=i.getParameter(i.MAX_TEXTURE_SIZE),this.maxCubeMapSize=i.getParameter(i.MAX_CUBE_MAP_TEXTURE_SIZE),this.maxRenderBufferSize=i.getParameter(i.MAX_RENDERBUFFER_SIZE),this.maxTextures=i.getParameter(i.MAX_TEXTURE_IMAGE_UNITS),this.maxCombinedTextures=i.getParameter(i.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this.maxVertexTextures=i.getParameter(i.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.vertexUniformsCount=i.getParameter(i.MAX_VERTEX_UNIFORM_VECTORS),this.fragmentUniformsCount=i.getParameter(i.MAX_FRAGMENT_UNIFORM_VECTORS),this.maxColorAttachments=i.getParameter(i.MAX_COLOR_ATTACHMENTS),this.maxVolumeSize=i.getParameter(i.MAX_3D_TEXTURE_SIZE),s=this.extDebugRendererInfo,this.unmaskedRenderer=s?i.getParameter(s.UNMASKED_RENDERER_WEBGL):"",this.unmaskedVendor=s?i.getParameter(s.UNMASKED_VENDOR_WEBGL):"",this.supportsGpuParticles=!("ARM"===this.unmaskedVendor&&n.match(/SM-[a-zA-Z0-9]+/))&&!this.unmaskedRenderer.match(/\bMali-G52+/),s=this.extTextureFilterAnisotropic,this.maxAnisotropy=s?i.getParameter(s.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1;let a=!this.forceDisableMultisampling;this.maxSamples=a?i.getParameter(i.MAX_SAMPLES):1,this.maxSamples=Math.min(this.maxSamples,4),this.samples=a&&this.backBufferAntialias?this.maxSamples:1,this.supportsAreaLights=!k.android,this.maxTextures<=8&&(this.supportsAreaLights=false),this.initCapsDefines();}initializeRenderState(){super.initializeRenderState();let e=this.gl;e.disable(e.BLEND),e.blendFunc(e.ONE,e.ZERO),e.blendEquation(e.FUNC_ADD),e.colorMask(true,true,true,true),e.blendColor(0,0,0,0),e.enable(e.CULL_FACE),this.cullFace=e.BACK,e.cullFace(e.BACK),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.depthMask(true),this.stencil=false,e.disable(e.STENCIL_TEST),this.stencilFuncFront=this.stencilFuncBack=7,this.stencilRefFront=this.stencilRefBack=0,this.stencilMaskFront=this.stencilMaskBack=255,e.stencilFunc(e.ALWAYS,0,255),this.stencilFailFront=this.stencilFailBack=0,this.stencilZfailFront=this.stencilZfailBack=0,this.stencilZpassFront=this.stencilZpassBack=0,this.stencilWriteMaskFront=255,this.stencilWriteMaskBack=255,e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.stencilMask(255),this.alphaToCoverage=false,this.raster=true,e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.RASTERIZER_DISCARD),this.depthBiasEnabled=false,e.disable(e.POLYGON_OFFSET_FILL),this.clearDepth=1,e.clearDepth(1),this.clearColor=new en(0,0,0,0),e.clearColor(0,0,0,0),this.clearStencil=0,e.clearStencil(0),e.hint(e.FRAGMENT_SHADER_DERIVATIVE_HINT,e.NICEST),e.enable(e.SCISSOR_TEST),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,e.NONE),this.unpackFlipY=false,e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,false),this.unpackPremultiplyAlpha=false,e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false),e.pixelStorei(e.UNPACK_ALIGNMENT,1);}initTextureUnits(e){ void 0===e&&(e=16),this.textureUnits=[];for(let t=0;t<e;t++)this.textureUnits.push([null,null,null]);}initializeContextCaches(){super.initializeContextCaches(),this._vaoMap=new Map,this.boundVao=null,this.activeFramebuffer=null,this.feedback=null,this.transformFeedbackBuffer=null,this.textureUnit=0,this.initTextureUnits(this.maxCombinedTextures);}loseContext(){for(let e of(super.loseContext(),this.shaders))e.loseContext();}restoreContext(){for(let e of(this.initializeExtensions(),this.initializeCapabilities(),super.restoreContext(),this.shaders))e.restoreContext();}setViewport(e,t,s,i){(this.vx!==e||this.vy!==t||this.vw!==s||this.vh!==i)&&(this.gl.viewport(e,t,s,i),this.vx=e,this.vy=t,this.vw=s,this.vh=i);}setScissor(e,t,s,i){(this.sx!==e||this.sy!==t||this.sw!==s||this.sh!==i)&&(this.gl.scissor(e,t,s,i),this.sx=e,this.sy=t,this.sw=s,this.sh=i);}setFramebuffer(e){if(this.activeFramebuffer!==e){let t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,e),this.activeFramebuffer=e;}}copyRenderTarget(e,t,s,i){var n,r;let a=this.gl;if(e===this.backBuffer&&(e=null),s){if(t){if(e&&(!e._colorBuffer||!t._colorBuffer||e._colorBuffer._format!==t._colorBuffer._format))return  false}else if(!e._colorBuffer)return  false}if(i&&e&&!e._depth&&(!e._depthBuffer||!t._depthBuffer||e._depthBuffer._format!==t._depthBuffer._format))return  false;let o=this.renderTarget;this.renderTarget=t,this.updateBegin();let l=e?e.impl._glFrameBuffer:null==(n=this.backBuffer)?void 0:n.impl._glFrameBuffer,h=t?t.impl._glFrameBuffer:null==(r=this.backBuffer)?void 0:r.impl._glFrameBuffer;a.bindFramebuffer(a.READ_FRAMEBUFFER,l),a.bindFramebuffer(a.DRAW_FRAMEBUFFER,h);let d=e?e.width:t?t.width:this.width,c=e?e.height:t?t.height:this.height;return a.blitFramebuffer(0,0,d,c,0,0,d,c,(s?a.COLOR_BUFFER_BIT:0)|(i?a.DEPTH_BUFFER_BIT:0),a.NEAREST),this.renderTarget=o,a.bindFramebuffer(a.FRAMEBUFFER,o?o.impl._glFrameBuffer:null),true}frameStart(){super.frameStart(),this.updateBackbuffer(),this.gpuProfiler.frameStart();}frameEnd(){super.frameEnd(),this.gpuProfiler.frameEnd(),this.gpuProfiler.request();}startRenderPass(e){var t;let s=null!=(t=e.renderTarget)?t:this.backBuffer;this.renderTarget=s,this.updateBegin();let{width:i,height:n}=s;this.setViewport(0,0,i,n),this.setScissor(0,0,i,n);let r=e.colorOps,a=e.depthStencilOps;if((null==r?void 0:r.clear)||a.clearDepth||a.clearStencil){let e=0,t={};(null==r?void 0:r.clear)&&(e|=1,t.color=[r.clearValue.r,r.clearValue.g,r.clearValue.b,r.clearValue.a]),a.clearDepth&&(e|=2,t.depth=a.clearDepthValue),a.clearStencil&&(e|=4,t.stencil=a.clearStencilValue),t.flags=e,this.clear(t);}this.insideRenderPass=true;}endRenderPass(e){this.unbindVertexArray();let t=this.renderTarget,s=e.colorArrayOps.length;if(t){var i;nN.length=0;let n=this.gl;for(let t=0;t<s;t++){let s=e.colorArrayOps[t];s.store||s.resolve||nN.push(n.COLOR_ATTACHMENT0+t);}t===this.backBuffer||(e.depthStencilOps.storeDepth||nN.push(n.DEPTH_ATTACHMENT),e.depthStencilOps.storeStencil||nN.push(n.STENCIL_ATTACHMENT)),nN.length>0&&e.fullSizeClearRect&&n.invalidateFramebuffer(n.DRAW_FRAMEBUFFER,nN),s&&(null==(i=e.colorOps)?void 0:i.resolve)&&e.samples>1&&t.autoResolve&&t.resolve(true,false),t.depthBuffer&&e.depthStencilOps.resolveDepth&&e.samples>1&&t.autoResolve&&t.resolve(false,true);for(let i=0;i<s;i++)if(e.colorArrayOps[i].genMipmaps){let e=t._colorBuffers[i];e&&e.impl._glTexture&&e.mipmaps&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(e),this.gl.generateMipmap(e.impl._glTarget));}}this.insideRenderPass=false;}set defaultFramebuffer(e){this._defaultFramebuffer!==e&&(this._defaultFramebuffer=e,this._defaultFramebufferChanged=true);}get defaultFramebuffer(){return this._defaultFramebuffer}updateBegin(){var e;if(this.boundVao=null,this._tempEnableSafariTextureUnitWorkaround)for(let e=0;e<this.textureUnits.length;++e)for(let t=0;t<3;++t)this.textureUnits[e][t]=null;let t=null!=(e=this.renderTarget)?e:this.backBuffer,s=t.impl;s.initialized||this.initRenderTarget(t),this.setFramebuffer(s._glFrameBuffer);}updateEnd(){this.unbindVertexArray();let e=this.renderTarget;if(e&&e!==this.backBuffer){e._samples>1&&e.autoResolve&&e.resolve();let t=e._colorBuffer;t&&t.impl._glTexture&&t.mipmaps&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(t),this.gl.generateMipmap(t.impl._glTarget));}}setUnpackFlipY(e){if(this.unpackFlipY!==e){this.unpackFlipY=e;let t=this.gl;t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,e);}}setUnpackPremultiplyAlpha(e){if(this.unpackPremultiplyAlpha!==e){this.unpackPremultiplyAlpha=e;let t=this.gl;t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e);}}activeTexture(e){this.textureUnit!==e&&(this.gl.activeTexture(this.gl.TEXTURE0+e),this.textureUnit=e);}bindTexture(e){let t=e.impl,s=t._glTarget,i=t._glTexture,n=this.textureUnit,r=this.targetToSlot[s];this.textureUnits[n][r]!==i&&(this.gl.bindTexture(s,i),this.textureUnits[n][r]=i);}bindTextureOnUnit(e,t){let s=e.impl,i=s._glTarget,n=s._glTexture,r=this.targetToSlot[i];this.textureUnits[t][r]!==n&&(this.activeTexture(t),this.gl.bindTexture(i,n),this.textureUnits[t][r]=n);}setTextureParameters(e){let t=this.gl,s=e.impl.dirtyParameterFlags,i=e.impl._glTarget;if(1&s){let s=e._minFilter;(!e._mipmaps||e._compressed&&1===e._levels.length)&&(2===s||3===s?s=0:(4===s||5===s)&&(s=1)),t.texParameteri(i,t.TEXTURE_MIN_FILTER,this.glFilter[s]);}if(2&s&&t.texParameteri(i,t.TEXTURE_MAG_FILTER,this.glFilter[e._magFilter]),4&s&&t.texParameteri(i,t.TEXTURE_WRAP_S,this.glAddress[e._addressU]),8&s&&t.texParameteri(i,t.TEXTURE_WRAP_T,this.glAddress[e._addressV]),16&s&&t.texParameteri(i,t.TEXTURE_WRAP_R,this.glAddress[e._addressW]),32&s&&t.texParameteri(i,t.TEXTURE_COMPARE_MODE,e._compareOnRead?t.COMPARE_REF_TO_TEXTURE:t.NONE),64&s&&t.texParameteri(i,t.TEXTURE_COMPARE_FUNC,this.glComparison[e._compareFunc]),128&s){let s=this.extTextureFilterAnisotropic;s&&t.texParameterf(i,s.TEXTURE_MAX_ANISOTROPY_EXT,ei.clamp(Math.round(e._anisotropy),1,this.maxAnisotropy));}}setTexture(e,t){let s=e.impl;s._glTexture||s.initialize(this,e),s.dirtyParameterFlags>0||e._needsUpload||e._needsMipmapsUpload?(this.activeTexture(t),this.bindTexture(e),s.dirtyParameterFlags&&(this.setTextureParameters(e),s.dirtyParameterFlags=0),(e._needsUpload||e._needsMipmapsUpload)&&(s.upload(this,e),e._needsUpload=false,e._needsMipmapsUpload=false)):this.bindTextureOnUnit(e,t);}createVertexArray(e){let t,s;let i=e.length>1;if(i){t="";for(let s=0;s<e.length;s++){let i=e[s];t+=i.id+i.format.renderingHash;}s=this._vaoMap.get(t);}if(!s){let n=this.gl;s=n.createVertexArray(),n.bindVertexArray(s),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null);for(let t=0;t<e.length;t++){let s=e[t];n.bindBuffer(n.ARRAY_BUFFER,s.impl.bufferId);let i=s.format.elements;for(let e=0;e<i.length;e++){let t=i[e],r=tJ[t.name];t.asInt?n.vertexAttribIPointer(r,t.numComponents,this.glType[t.dataType],t.stride,t.offset):n.vertexAttribPointer(r,t.numComponents,this.glType[t.dataType],t.normalize,t.stride,t.offset),n.enableVertexAttribArray(r),s.format.instancing&&n.vertexAttribDivisor(r,1);}}n.bindVertexArray(null),n.bindBuffer(n.ARRAY_BUFFER,null),i&&this._vaoMap.set(t,s);}return s}unbindVertexArray(){this.boundVao&&(this.boundVao=null,this.gl.bindVertexArray(null));}setBuffers(){let e;let t=this.gl;if(1===this.vertexBuffers.length){let t=this.vertexBuffers[0];t.impl.vao||(t.impl.vao=this.createVertexArray(this.vertexBuffers)),e=t.impl.vao;}else e=this.createVertexArray(this.vertexBuffers);this.boundVao!==e&&(this.boundVao=e,t.bindVertexArray(e)),this.clearVertexBuffer();let s=this.indexBuffer?this.indexBuffer.impl.bufferId:null;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,s);}draw(e,t,s){let i,n,r,a,o,l,h,d;let c=this.gl;if(this.activateShader(this),!this.shaderValid)return;let u=this.shader;if(!u)return;let p=u.impl.samplers,f=u.impl.uniforms;s||this.setBuffers();let m=0;for(let e=0,t=p.length;e<t;e++){if(!(n=(i=p[e]).scopeId.value)){let e=i.scopeId.name;"uSceneDepthMap"===e&&(n=sn(this,"white")),"uSceneColorMap"===e&&(n=sn(this,"pink")),n||(n=sn(this,"pink"));}if(n instanceof se)r=n,this.setTexture(r,m),i.slot!==m&&(c.uniform1i(i.locationId,m),i.slot=m),m++;else {i.array.length=0,a=n.length;for(let e=0;e<a;e++)r=n[e],this.setTexture(r,m),i.array[e]=m,m++;c.uniform1iv(i.locationId,i.array);}}for(let e=0,t=f.length;e<t;e++)l=(o=f[e]).scopeId,h=o.version,d=l.versionObject.version,(h.globalId!==d.globalId||h.revision!==d.revision)&&(h.globalId=d.globalId,h.revision=d.revision,null!==l.value&&this.commitFunction[o.dataType](o,l.value));this.transformFeedbackBuffer&&(c.bindBufferBase(c.TRANSFORM_FEEDBACK_BUFFER,0,this.transformFeedbackBuffer.impl.bufferId),c.beginTransformFeedback(c.POINTS));let _=this.glPrimitive[e.type],g=e.count;if(e.indexed){let s=this.indexBuffer,i=s.impl.glFormat,n=e.base*s.bytesPerIndex;t>0?c.drawElementsInstanced(_,g,i,n,t):c.drawElements(_,g,i,n);}else {let s=e.base;t>0?c.drawArraysInstanced(_,s,g,t):c.drawArrays(_,s,g);}this.transformFeedbackBuffer&&(c.endTransformFeedback(),c.bindBufferBase(c.TRANSFORM_FEEDBACK_BUFFER,0,null)),this._drawCallsPerFrame++;}clear(e){var t,s,i,n;let r=this.defaultClearOptions,a=null!=(t=(e=e||r).flags)?t:r.flags;if(0!==a){let t=this.gl;if(1&a){let t=null!=(s=e.color)?s:r.color,i=t[0],n=t[1],a=t[2],o=t[3],l=this.clearColor;(i!==l.r||n!==l.g||a!==l.b||o!==l.a)&&(this.gl.clearColor(i,n,a,o),this.clearColor.set(i,n,a,o)),this.setBlendState(sh.NOBLEND);}if(2&a){let t=null!=(i=e.depth)?i:r.depth;t!==this.clearDepth&&(this.gl.clearDepth(t),this.clearDepth=t),this.setDepthState(su.WRITEDEPTH);}if(4&a){let s=null!=(n=e.stencil)?n:r.stencil;s!==this.clearStencil&&(this.gl.clearStencil(s),this.clearStencil=s),t.stencilMask(255),this.stencilWriteMaskFront=255,this.stencilWriteMaskBack=255;}t.clear(this.glClearFlag[a]);}}submit(){this.gl.flush();}readPixels(e,t,s,i,n){let r=this.gl;r.readPixels(e,t,s,i,r.RGBA,r.UNSIGNED_BYTE,n);}async readPixelsAsync(e,t,s,i,n){var r,a,o;let l=this.gl,h=null==(r=this.renderTarget.colorBuffer)?void 0:r.impl,d=null!=(a=null==h?void 0:h._glFormat)?a:l.RGBA,c=null!=(o=null==h?void 0:h._glPixelType)?o:l.UNSIGNED_BYTE,u=l.createBuffer();return l.bindBuffer(l.PIXEL_PACK_BUFFER,u),l.bufferData(l.PIXEL_PACK_BUFFER,n.byteLength,l.STREAM_READ),l.readPixels(e,t,s,i,d,c,0),l.bindBuffer(l.PIXEL_PACK_BUFFER,null),await ((e,t)=>{let s=l.fenceSync(l.SYNC_GPU_COMMANDS_COMPLETE,0);return this.submit(),new Promise((i,n)=>{!function r(){let a=l.clientWaitSync(s,e,0);a===l.WAIT_FAILED?(l.deleteSync(s),n(Error("webgl clientWaitSync sync failed"))):a===l.TIMEOUT_EXPIRED?setTimeout(r,t):(l.deleteSync(s),i());}();})})(0,20),l.bindBuffer(l.PIXEL_PACK_BUFFER,u),l.getBufferSubData(l.PIXEL_PACK_BUFFER,0,n),l.bindBuffer(l.PIXEL_PACK_BUFFER,null),l.deleteBuffer(u),n}readTextureAsync(e,t,s,i,n,r){var a,o,l;let h=null!=(a=r.face)?a:0,d=null!=(o=r.renderTarget)?o:new sR({colorBuffer:e,depth:false,face:h}),c=new ArrayBuffer(t9.calcLevelGpuSize(i,n,1,e._format)),u=null!=(l=r.data)?l:new(e1(e._format))(c);return this.setRenderTarget(d),this.initRenderTarget(d),new Promise((e,a)=>{this.readPixelsAsync(t,s,i,n,u).then(t=>{r.renderTarget||d.destroy(),e(t);}).catch(a);})}setAlphaToCoverage(e){this.alphaToCoverage!==e&&(this.alphaToCoverage=e,e?this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE):this.gl.disable(this.gl.SAMPLE_ALPHA_TO_COVERAGE));}setTransformFeedbackBuffer(e){if(this.transformFeedbackBuffer!==e){this.transformFeedbackBuffer=e;let t=this.gl;e?(this.feedback||(this.feedback=t.createTransformFeedback()),t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,this.feedback)):t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,null);}}setRaster(e){this.raster!==e&&(this.raster=e,e?this.gl.disable(this.gl.RASTERIZER_DISCARD):this.gl.enable(this.gl.RASTERIZER_DISCARD));}setStencilTest(e){if(this.stencil!==e){let t=this.gl;e?t.enable(t.STENCIL_TEST):t.disable(t.STENCIL_TEST),this.stencil=e;}}setStencilFunc(e,t,s){(this.stencilFuncFront!==e||this.stencilRefFront!==t||this.stencilMaskFront!==s||this.stencilFuncBack!==e||this.stencilRefBack!==t||this.stencilMaskBack!==s)&&(this.gl.stencilFunc(this.glComparison[e],t,s),this.stencilFuncFront=this.stencilFuncBack=e,this.stencilRefFront=this.stencilRefBack=t,this.stencilMaskFront=this.stencilMaskBack=s);}setStencilFuncFront(e,t,s){if(this.stencilFuncFront!==e||this.stencilRefFront!==t||this.stencilMaskFront!==s){let i=this.gl;i.stencilFuncSeparate(i.FRONT,this.glComparison[e],t,s),this.stencilFuncFront=e,this.stencilRefFront=t,this.stencilMaskFront=s;}}setStencilFuncBack(e,t,s){if(this.stencilFuncBack!==e||this.stencilRefBack!==t||this.stencilMaskBack!==s){let i=this.gl;i.stencilFuncSeparate(i.BACK,this.glComparison[e],t,s),this.stencilFuncBack=e,this.stencilRefBack=t,this.stencilMaskBack=s;}}setStencilOperation(e,t,s,i){(this.stencilFailFront!==e||this.stencilZfailFront!==t||this.stencilZpassFront!==s||this.stencilFailBack!==e||this.stencilZfailBack!==t||this.stencilZpassBack!==s)&&(this.gl.stencilOp(this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[s]),this.stencilFailFront=this.stencilFailBack=e,this.stencilZfailFront=this.stencilZfailBack=t,this.stencilZpassFront=this.stencilZpassBack=s),(this.stencilWriteMaskFront!==i||this.stencilWriteMaskBack!==i)&&(this.gl.stencilMask(i),this.stencilWriteMaskFront=i,this.stencilWriteMaskBack=i);}setStencilOperationFront(e,t,s,i){(this.stencilFailFront!==e||this.stencilZfailFront!==t||this.stencilZpassFront!==s)&&(this.gl.stencilOpSeparate(this.gl.FRONT,this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[s]),this.stencilFailFront=e,this.stencilZfailFront=t,this.stencilZpassFront=s),this.stencilWriteMaskFront!==i&&(this.gl.stencilMaskSeparate(this.gl.FRONT,i),this.stencilWriteMaskFront=i);}setStencilOperationBack(e,t,s,i){(this.stencilFailBack!==e||this.stencilZfailBack!==t||this.stencilZpassBack!==s)&&(this.gl.stencilOpSeparate(this.gl.BACK,this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[s]),this.stencilFailBack=e,this.stencilZfailBack=t,this.stencilZpassBack=s),this.stencilWriteMaskBack!==i&&(this.gl.stencilMaskSeparate(this.gl.BACK,i),this.stencilWriteMaskBack=i);}setBlendState(e){let t=this.blendState;if(!t.equals(e)){let s=this.gl,{blend:i,colorOp:n,alphaOp:r,colorSrcFactor:a,colorDstFactor:o,alphaSrcFactor:l,alphaDstFactor:h}=e;if(t.blend!==i&&(i?s.enable(s.BLEND):s.disable(s.BLEND)),t.colorOp!==n||t.alphaOp!==r){let e=this.glBlendEquation;s.blendEquationSeparate(e[n],e[r]);}(t.colorSrcFactor!==a||t.colorDstFactor!==o||t.alphaSrcFactor!==l||t.alphaDstFactor!==h)&&s.blendFuncSeparate(this.glBlendFunctionColor[a],this.glBlendFunctionColor[o],this.glBlendFunctionAlpha[l],this.glBlendFunctionAlpha[h]),t.allWrite!==e.allWrite&&this.gl.colorMask(e.redWrite,e.greenWrite,e.blueWrite,e.alphaWrite),t.copy(e);}}setBlendColor(e,t,s,i){let n=this.blendColor;(e!==n.r||t!==n.g||s!==n.b||i!==n.a)&&(this.gl.blendColor(e,t,s,i),n.set(e,t,s,i));}setStencilState(e,t){e||t?(this.setStencilTest(true),e===t?(this.setStencilFunc(e.func,e.ref,e.readMask),this.setStencilOperation(e.fail,e.zfail,e.zpass,e.writeMask)):(null!=e||(e=sC.DEFAULT),this.setStencilFuncFront(e.func,e.ref,e.readMask),this.setStencilOperationFront(e.fail,e.zfail,e.zpass,e.writeMask),null!=t||(t=sC.DEFAULT),this.setStencilFuncBack(t.func,t.ref,t.readMask),this.setStencilOperationBack(t.fail,t.zfail,t.zpass,t.writeMask))):this.setStencilTest(false);}setDepthState(e){let t=this.depthState;if(!t.equals(e)){let s=this.gl,i=e.write;t.write!==i&&s.depthMask(i);let{func:n,test:r}=e;!r&&i&&(r=true,n=7),t.func!==n&&s.depthFunc(this.glComparison[n]),t.test!==r&&(r?s.enable(s.DEPTH_TEST):s.disable(s.DEPTH_TEST));let{depthBias:a,depthBiasSlope:o}=e;a||o?(this.depthBiasEnabled||(this.depthBiasEnabled=true,this.gl.enable(this.gl.POLYGON_OFFSET_FILL)),s.polygonOffset(o,a)):this.depthBiasEnabled&&(this.depthBiasEnabled=false,this.gl.disable(this.gl.POLYGON_OFFSET_FILL)),t.copy(e);}}setCullMode(e){if(this.cullMode!==e){if(0===e)this.gl.disable(this.gl.CULL_FACE);else {0===this.cullMode&&this.gl.enable(this.gl.CULL_FACE);let t=this.glCull[e];this.cullFace!==t&&(this.gl.cullFace(t),this.cullFace=t);}this.cullMode=e;}}setShader(e,t){ void 0===t&&(t=false),e!==this.shader&&(this.shader=e,this.shaderAsyncCompile=t,this.shaderValid=void 0);}activateShader(e){let{shader:t}=this,{impl:s}=t;void 0!==this.shaderValid||(t.failed?this.shaderValid=false:t.ready||(this.shaderAsyncCompile?s.isLinked(e)?s.finalize(this,t)||(t.failed=true,this.shaderValid=false):this.shaderValid=false:s.finalize(this,t)||(t.failed=true,this.shaderValid=false))),void 0===this.shaderValid&&(this.gl.useProgram(s.glProgram),this.shaderValid=true);}clearVertexArrayObjectCache(){let e=this.gl;this._vaoMap.forEach((t,s,i)=>{e.deleteVertexArray(t);}),this._vaoMap.clear();}set fullscreen(e){e?this.gl.canvas.requestFullscreen():document.exitFullscreen();}get fullscreen(){return !!document.fullscreenElement}constructor(e,t={}){var s,i;let n,r,a,o,l;super(e,t),this._defaultFramebuffer=null,this._defaultFramebufferChanged=false,t=this.initOptions,this.updateClientRect(),this.initTextureUnits(),this.contextLost=false,this._contextLostHandler=e=>{e.preventDefault(),this.loseContext(),this.fire("devicelost");},this._contextRestoredHandler=()=>{this.restoreContext(),this.fire("devicerestored");};let h="undefined"!=typeof navigator&&navigator.userAgent;if(this.forceDisableMultisampling=h&&h.includes("AppleWebKit")&&(h.includes("15.4")||h.includes("15_4")),this.forceDisableMultisampling&&(t.antialias=false),"firefox"===k.browserName){let e=("undefined"!=typeof navigator?navigator.userAgent:"").match(/Firefox\/(\d+(\.\d+)*)/),s=e?e[1]:null;if(s){let e=parseFloat(s);("windows"===k.name&&(e>=120||115===e)||"android"===k.name&&e>=132)&&(t.antialias=false);}}this.backBufferAntialias=null!=(s=t.antialias)&&s,t.antialias=false;let d=null!=(i=t.gl)?i:e.getContext("webgl2",t);if(!d)throw Error("WebGL not supported");this.gl=d,this.isWebGL2=true,this._deviceType=tV,this.updateBackbufferFormat(null);let c="chrome"===k.browserName,u="safari"===k.browserName,p=k.browser&&-1!==navigator.appVersion.indexOf("Mac");this._tempEnableSafariTextureUnitWorkaround=u,this._tempMacChromeBlitFramebufferWorkaround=p&&c&&!t.alpha,e.addEventListener("webglcontextlost",this._contextLostHandler,false),e.addEventListener("webglcontextrestored",this._contextRestoredHandler,false),this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),this.initializeContextCaches(),this.createBackbuffer(null),this.supportsImageBitmap=!u&&"undefined"!=typeof ImageBitmap,this._samplerTypes=new Set([d.SAMPLER_2D,d.SAMPLER_CUBE,d.UNSIGNED_INT_SAMPLER_2D,d.INT_SAMPLER_2D,d.SAMPLER_2D_SHADOW,d.SAMPLER_CUBE_SHADOW,d.SAMPLER_3D,d.INT_SAMPLER_3D,d.UNSIGNED_INT_SAMPLER_3D,d.SAMPLER_2D_ARRAY,d.INT_SAMPLER_2D_ARRAY,d.UNSIGNED_INT_SAMPLER_2D_ARRAY]),this.glAddress=[d.REPEAT,d.CLAMP_TO_EDGE,d.MIRRORED_REPEAT],this.glBlendEquation=[d.FUNC_ADD,d.FUNC_SUBTRACT,d.FUNC_REVERSE_SUBTRACT,d.MIN,d.MAX],this.glBlendFunctionColor=[d.ZERO,d.ONE,d.SRC_COLOR,d.ONE_MINUS_SRC_COLOR,d.DST_COLOR,d.ONE_MINUS_DST_COLOR,d.SRC_ALPHA,d.SRC_ALPHA_SATURATE,d.ONE_MINUS_SRC_ALPHA,d.DST_ALPHA,d.ONE_MINUS_DST_ALPHA,d.CONSTANT_COLOR,d.ONE_MINUS_CONSTANT_COLOR],this.glBlendFunctionAlpha=[d.ZERO,d.ONE,d.SRC_COLOR,d.ONE_MINUS_SRC_COLOR,d.DST_COLOR,d.ONE_MINUS_DST_COLOR,d.SRC_ALPHA,d.SRC_ALPHA_SATURATE,d.ONE_MINUS_SRC_ALPHA,d.DST_ALPHA,d.ONE_MINUS_DST_ALPHA,d.CONSTANT_ALPHA,d.ONE_MINUS_CONSTANT_ALPHA],this.glComparison=[d.NEVER,d.LESS,d.EQUAL,d.LEQUAL,d.GREATER,d.NOTEQUAL,d.GEQUAL,d.ALWAYS],this.glStencilOp=[d.KEEP,d.ZERO,d.REPLACE,d.INCR,d.INCR_WRAP,d.DECR,d.DECR_WRAP,d.INVERT],this.glClearFlag=[0,d.COLOR_BUFFER_BIT,d.DEPTH_BUFFER_BIT,d.COLOR_BUFFER_BIT|d.DEPTH_BUFFER_BIT,d.STENCIL_BUFFER_BIT,d.STENCIL_BUFFER_BIT|d.COLOR_BUFFER_BIT,d.STENCIL_BUFFER_BIT|d.DEPTH_BUFFER_BIT,d.STENCIL_BUFFER_BIT|d.COLOR_BUFFER_BIT|d.DEPTH_BUFFER_BIT],this.glCull=[0,d.BACK,d.FRONT,d.FRONT_AND_BACK],this.glFilter=[d.NEAREST,d.LINEAR,d.NEAREST_MIPMAP_NEAREST,d.NEAREST_MIPMAP_LINEAR,d.LINEAR_MIPMAP_NEAREST,d.LINEAR_MIPMAP_LINEAR],this.glPrimitive=[d.POINTS,d.LINES,d.LINE_LOOP,d.LINE_STRIP,d.TRIANGLES,d.TRIANGLE_STRIP,d.TRIANGLE_FAN],this.glType=[d.BYTE,d.UNSIGNED_BYTE,d.SHORT,d.UNSIGNED_SHORT,d.INT,d.UNSIGNED_INT,d.FLOAT,d.HALF_FLOAT],this.pcUniformType={},this.pcUniformType[d.BOOL]=0,this.pcUniformType[d.INT]=1,this.pcUniformType[d.FLOAT]=2,this.pcUniformType[d.FLOAT_VEC2]=3,this.pcUniformType[d.FLOAT_VEC3]=4,this.pcUniformType[d.FLOAT_VEC4]=5,this.pcUniformType[d.INT_VEC2]=6,this.pcUniformType[d.INT_VEC3]=7,this.pcUniformType[d.INT_VEC4]=8,this.pcUniformType[d.BOOL_VEC2]=9,this.pcUniformType[d.BOOL_VEC3]=10,this.pcUniformType[d.BOOL_VEC4]=11,this.pcUniformType[d.FLOAT_MAT2]=12,this.pcUniformType[d.FLOAT_MAT3]=13,this.pcUniformType[d.FLOAT_MAT4]=14,this.pcUniformType[d.SAMPLER_2D]=15,this.pcUniformType[d.SAMPLER_CUBE]=16,this.pcUniformType[d.UNSIGNED_INT]=26,this.pcUniformType[d.UNSIGNED_INT_VEC2]=27,this.pcUniformType[d.UNSIGNED_INT_VEC3]=28,this.pcUniformType[d.UNSIGNED_INT_VEC4]=29,this.pcUniformType[d.SAMPLER_2D_SHADOW]=18,this.pcUniformType[d.SAMPLER_CUBE_SHADOW]=19,this.pcUniformType[d.SAMPLER_2D_ARRAY]=25,this.pcUniformType[d.SAMPLER_3D]=20,this.pcUniformType[d.INT_SAMPLER_2D]=42,this.pcUniformType[d.UNSIGNED_INT_SAMPLER_2D]=43,this.pcUniformType[d.INT_SAMPLER_CUBE]=44,this.pcUniformType[d.UNSIGNED_INT_SAMPLER_2D]=45,this.pcUniformType[d.INT_SAMPLER_3D]=46,this.pcUniformType[d.UNSIGNED_INT_SAMPLER_3D]=47,this.pcUniformType[d.INT_SAMPLER_2D_ARRAY]=48,this.pcUniformType[d.UNSIGNED_INT_SAMPLER_2D_ARRAY]=49,this.targetToSlot={},this.targetToSlot[d.TEXTURE_2D]=0,this.targetToSlot[d.TEXTURE_CUBE_MAP]=1,this.targetToSlot[d.TEXTURE_3D]=2,this.commitFunction=[],this.commitFunction[0]=function(e,t){e.value!==t&&(d.uniform1i(e.locationId,t),e.value=t);},this.commitFunction[1]=this.commitFunction[0],this.commitFunction[2]=function(e,t){e.value!==t&&(d.uniform1f(e.locationId,t),e.value=t);},this.commitFunction[3]=function(e,t){l=e.value,n=t[0],r=t[1],(l[0]!==n||l[1]!==r)&&(d.uniform2fv(e.locationId,t),l[0]=n,l[1]=r);},this.commitFunction[4]=function(e,t){l=e.value,n=t[0],r=t[1],a=t[2],(l[0]!==n||l[1]!==r||l[2]!==a)&&(d.uniform3fv(e.locationId,t),l[0]=n,l[1]=r,l[2]=a);},this.commitFunction[5]=function(e,t){l=e.value,n=t[0],r=t[1],a=t[2],o=t[3],(l[0]!==n||l[1]!==r||l[2]!==a||l[3]!==o)&&(d.uniform4fv(e.locationId,t),l[0]=n,l[1]=r,l[2]=a,l[3]=o);},this.commitFunction[6]=function(e,t){l=e.value,n=t[0],r=t[1],(l[0]!==n||l[1]!==r)&&(d.uniform2iv(e.locationId,t),l[0]=n,l[1]=r);},this.commitFunction[9]=this.commitFunction[6],this.commitFunction[7]=function(e,t){l=e.value,n=t[0],r=t[1],a=t[2],(l[0]!==n||l[1]!==r||l[2]!==a)&&(d.uniform3iv(e.locationId,t),l[0]=n,l[1]=r,l[2]=a);},this.commitFunction[10]=this.commitFunction[7],this.commitFunction[8]=function(e,t){l=e.value,n=t[0],r=t[1],a=t[2],o=t[3],(l[0]!==n||l[1]!==r||l[2]!==a||l[3]!==o)&&(d.uniform4iv(e.locationId,t),l[0]=n,l[1]=r,l[2]=a,l[3]=o);},this.commitFunction[11]=this.commitFunction[8],this.commitFunction[12]=function(e,t){d.uniformMatrix2fv(e.locationId,false,t);},this.commitFunction[13]=function(e,t){d.uniformMatrix3fv(e.locationId,false,t);},this.commitFunction[14]=function(e,t){d.uniformMatrix4fv(e.locationId,false,t);},this.commitFunction[17]=function(e,t){d.uniform1fv(e.locationId,t);},this.commitFunction[21]=function(e,t){d.uniform2fv(e.locationId,t);},this.commitFunction[22]=function(e,t){d.uniform3fv(e.locationId,t);},this.commitFunction[23]=function(e,t){d.uniform4fv(e.locationId,t);},this.commitFunction[26]=function(e,t){e.value!==t&&(d.uniform1ui(e.locationId,t),e.value=t);},this.commitFunction[27]=function(e,t){l=e.value,n=t[0],r=t[1],(l[0]!==n||l[1]!==r)&&(d.uniform2uiv(e.locationId,t),l[0]=n,l[1]=r);},this.commitFunction[28]=function(e,t){l=e.value,n=t[0],r=t[1],a=t[2],(l[0]!==n||l[1]!==r||l[2]!==a)&&(d.uniform3uiv(e.locationId,t),l[0]=n,l[1]=r,l[2]=a);},this.commitFunction[29]=function(e,t){l=e.value,n=t[0],r=t[1],a=t[2],o=t[3],(l[0]!==n||l[1]!==r||l[2]!==a||l[3]!==o)&&(d.uniform4uiv(e.locationId,t),l[0]=n,l[1]=r,l[2]=a,l[3]=o);},this.commitFunction[30]=function(e,t){d.uniform1iv(e.locationId,t);},this.commitFunction[31]=function(e,t){d.uniform1uiv(e.locationId,t);},this.commitFunction[32]=this.commitFunction[30],this.commitFunction[33]=function(e,t){d.uniform2iv(e.locationId,t);},this.commitFunction[34]=function(e,t){d.uniform2uiv(e.locationId,t);},this.commitFunction[35]=this.commitFunction[33],this.commitFunction[36]=function(e,t){d.uniform3iv(e.locationId,t);},this.commitFunction[37]=function(e,t){d.uniform3uiv(e.locationId,t);},this.commitFunction[38]=this.commitFunction[36],this.commitFunction[39]=function(e,t){d.uniform4iv(e.locationId,t);},this.commitFunction[40]=function(e,t){d.uniform4uiv(e.locationId,t);},this.commitFunction[41]=this.commitFunction[39],this.commitFunction[24]=function(e,t){d.uniformMatrix4fv(e.locationId,false,t);},this.constantTexSource=this.scope.resolve("source"),this.postInit();}}class nU{unlock(e){}}class nk{destroy(e){}init(e,t){}loseContext(){}resolve(e,t,s,i){}}class nz{destroy(e){}loseContext(){}restoreContext(e,t){}}class nV{destroy(e){}propertyChanged(e){}loseContext(){}}class nG{destroy(e){}unlock(e){}}class nH extends sM{destroy(){super.destroy();}initDeviceCaps(){this.disableParticleSystem=true,this.precision="highp",this.maxPrecision="highp",this.maxSamples=4,this.maxTextures=16,this.maxTextureSize=4096,this.maxCubeMapSize=4096,this.maxVolumeSize=4096,this.maxColorAttachments=8,this.maxPixelRatio=1,this.maxAnisotropy=16,this.supportsUniformBuffers=false,this.supportsAreaLights=true,this.supportsGpuParticles=false,this.textureFloatRenderable=true,this.textureHalfFloatRenderable=true,this.supportsImageBitmap=false;}postInit(){super.postInit();}frameStart(){super.frameStart();}frameEnd(){super.frameEnd();}updateBegin(){}updateEnd(){}readPixels(e,t,s,i,n){}createVertexBufferImpl(e,t){return new nG(e,t)}createIndexBufferImpl(e){return new nU(e)}createShaderImpl(e){return new nz(e)}createTextureImpl(e){return new nV(e)}createRenderTargetImpl(e){return new nk(e)}draw(e,t,s){}setShader(e,t){}setBlendState(e){}setDepthState(e){}setStencilState(e,t){}setBlendColor(e,t,s,i){}setCullMode(e){}setAlphaToCoverage(e){}initializeContextCaches(){super.initializeContextCaches();}clear(e){}setViewport(e,t,s,i){}setScissor(e,t,s,i){}copyRenderTarget(e,t,s,i){return  true}constructor(e,t={}){super(e,t),t=this.initOptions,this.isNull=true,this._deviceType=tH,this.samples=1,this.backBuffer=new sR({name:"Framebuffer",graphicsDevice:this,depth:this.initOptions.depth,stencil:this.supportsStencil,samples:this.samples}),this.initDeviceCaps();}}class nW{constructor(){this.scopeId=null;}}let nX=0;class nY{destroy(){let e=this.device,t=e.buffers.indexOf(this);-1!==t&&e.buffers.splice(t,1),this.device.indexBuffer===this&&(this.device.indexBuffer=null),this.impl.initialized&&(this.impl.destroy(e),this.adjustVramSizeTracking(e._vram,-this.storage.byteLength));}adjustVramSizeTracking(e,t){e.ib+=t;}loseContext(){this.impl.loseContext();}getFormat(){return this.format}getNumIndices(){return this.numIndices}lock(){return this.storage}unlock(){this.impl.unlock(this);}setData(e){return e.byteLength===this.numBytes&&(this.storage=e,this.unlock(),true)}_lockTypedArray(){let e=this.lock();return 2===this.format?new Uint32Array(e):1===this.format?new Uint16Array(e):new Uint8Array(e)}writeData(e,t){let s=this._lockTypedArray();if(e.length>t){if(ArrayBuffer.isView(e))e=e.subarray(0,t),s.set(e);else for(let i=0;i<t;i++)s[i]=e[i];}else s.set(e);this.unlock();}readData(e){let t=this._lockTypedArray(),s=this.numIndices;if(ArrayBuffer.isView(e))e.set(t);else {e.length=0;for(let i=0;i<s;i++)e[i]=t[i];}return s}constructor(e,t,s,i=0,n,r){this.device=e,this.format=t,this.numIndices=s,this.usage=i,this.id=nX++,this.impl=e.createIndexBufferImpl(this,r);let a=tQ[t];this.bytesPerIndex=a,this.numBytes=this.numIndices*a,n?this.setData(n):this.storage=new ArrayBuffer(this.numBytes),this.adjustVramSizeTracking(e._vram,this.numBytes),this.device.buffers.push(this);}}class nj{constructor(){this.clearValue=new en(0,0,0,1),this.clearValueLinear=new en(0,0,0,1),this.clear=false,this.store=false,this.resolve=true,this.genMipmaps=false;}}class nq{constructor(){this.clearDepthValue=1,this.clearStencilValue=0,this.clearDepth=false,this.clearStencil=false,this.storeDepth=false,this.resolveDepth=false,this.storeStencil=false;}}class nK{get colorOps(){return this.colorArrayOps[0]}set name(e){this._name=e;}get name(){return this._name||(this._name=this.constructor.name),this._name}set scaleX(e){this._options.scaleX=e;}get scaleX(){return this._options.scaleX}set scaleY(e){this._options.scaleY=e;}get scaleY(){return this._options.scaleY}set options(e){if(this._options=e,e){var t,s;this.scaleX=null!=(t=this.scaleX)?t:1,this.scaleY=null!=(s=this.scaleY)?s:1;}}get options(){return this._options}init(e,t){ void 0===e&&(e=null),this.options=t,this.renderTarget=e,this.samples=Math.max(this.renderTarget?this.renderTarget.samples:this.device.samples,1),this.allocateAttachments(),this.postInit();}allocateAttachments(){var e,t,s,i,n;let r=this.renderTarget;this.depthStencilOps=new nq,(null==r?void 0:r.depthBuffer)&&(this.depthStencilOps.storeDepth=true);let a=r?null!=(t=null==(e=r._colorBuffers)?void 0:e.length)?t:0:1;this.colorArrayOps.length=0;for(let e=0;e<a;e++){let t=new nj;this.colorArrayOps[e]=t,1===this.samples&&(t.store=true,t.resolve=false);let r=null==(i=this.renderTarget)?void 0:null==(s=i._colorBuffers)?void 0:s[e];(null==(n=this.renderTarget)?void 0:n.mipmaps)&&(null==r?void 0:r.mipmaps)&&(t.genMipmaps=!eQ(r._format));}}destroy(){}postInit(){}frameUpdate(){if(this._options&&this.renderTarget){var e;let t=null!=(e=this._options.resizeSource)?e:this.device.backBuffer,s=Math.floor(t.width*this.scaleX),i=Math.floor(t.height*this.scaleY);this.renderTarget.resize(s,i);}}before(){}execute(){}after(){}onEnable(){}onDisable(){}set enabled(e){this._enabled!==e&&(this._enabled=e,e?this.onEnable():this.onDisable());}get enabled(){return this._enabled}setClearColor(e){let t=this.colorArrayOps.length;for(let s=0;s<t;s++){let t=this.colorArrayOps[s];e&&(t.clearValue.copy(e),t.clearValueLinear.linear(e)),t.clear=!!e;}}setClearDepth(e){e&&(this.depthStencilOps.clearDepthValue=e),this.depthStencilOps.clearDepth=void 0!==e;}setClearStencil(e){e&&(this.depthStencilOps.clearStencilValue=e),this.depthStencilOps.clearStencil=void 0!==e;}render(){if(this.enabled){let e=this.device,t=void 0!==this.renderTarget;this.before(),this.executeEnabled&&(t&&!this._skipStart&&e.startRenderPass(this),this.execute(),t&&!this._skipEnd&&e.endRenderPass(this)),this.after(),e.renderPassIndex++;}}constructor(e){this._enabled=true,this._skipStart=false,this._skipEnd=false,this.executeEnabled=true,this.samples=0,this.colorArrayOps=[],this.requiresCubemaps=true,this.fullSizeClearRect=true,this.beforePasses=[],this.afterPasses=[],this.device=e;}}let nZ=0;function nQ(e){this.array[this.index]=e;}function nJ(e,t){this.array[this.index]=e,this.array[this.index+1]=t;}function n$(e,t,s){this.array[this.index]=e,this.array[this.index+1]=t,this.array[this.index+2]=s;}function n0(e,t,s,i){this.array[this.index]=e,this.array[this.index+1]=t,this.array[this.index+2]=s,this.array[this.index+3]=i;}function n1(e,t,s){this.array[e]=t[s];}function n2(e,t,s){this.array[e]=t[s],this.array[e+1]=t[s+1];}function n3(e,t,s){this.array[e]=t[s],this.array[e+1]=t[s+1],this.array[e+2]=t[s+2];}function n4(e,t,s){this.array[e]=t[s],this.array[e+1]=t[s+1],this.array[e+2]=t[s+2],this.array[e+3]=t[s+3];}function n5(e,t,s){t[s]=this.array[e];}function n6(e,t,s){t[s]=this.array[e],t[s+1]=this.array[e+1];}function n8(e,t,s){t[s]=this.array[e],t[s+1]=this.array[e+1],t[s+2]=this.array[e+2];}function n9(e,t,s){t[s]=this.array[e],t[s+1]=this.array[e+1],t[s+2]=this.array[e+2],t[s+3]=this.array[e+3];}class n7{get(e){return this.array[this.index+e]}set(e,t,s,i){}getToArray(e,t,s){}setFromArray(e,t,s){}constructor(e,t,s){switch(this.index=0,this.numComponents=t.numComponents,s.interleaved?this.array=new tq[t.dataType](e,t.offset):this.array=new tq[t.dataType](e,t.offset,s.vertexCount*t.numComponents),this.stride=t.stride/this.array.constructor.BYTES_PER_ELEMENT,t.numComponents){case 1:this.set=nQ,this.getToArray=n5,this.setFromArray=n1;break;case 2:this.set=nJ,this.getToArray=n6,this.setFromArray=n2;break;case 3:this.set=n$,this.getToArray=n8,this.setFromArray=n3;break;case 4:this.set=n0,this.getToArray=n9,this.setFromArray=n4;}}}class re{next(e){ void 0===e&&(e=1);let t=0,s=this.accessors,i=this.accessors.length;for(;t<i;){let i=s[t++];i.index+=e*i.stride;}}end(){this.vertexBuffer.unlock();}writeData(e,t,s){let i=this.element[e];if(i){s>this.vertexBuffer.numVertices&&(s=this.vertexBuffer.numVertices);let e=i.numComponents;if(this.vertexBuffer.getFormat().interleaved){let n=0;for(let r=0;r<s;r++)i.setFromArray(n,t,r*e),n+=i.stride;}else if(t.length>s*e){let n=s*e;if(ArrayBuffer.isView(t))t=t.subarray(0,n),i.array.set(t);else for(let e=0;e<n;e++)i.array[e]=t[e];}else i.array.set(t);}}readData(e,t){let s=this.element[e],i=0;if(s){let e;i=this.vertexBuffer.numVertices;let n=s.numComponents;if(this.vertexBuffer.getFormat().interleaved){Array.isArray(t)&&(t.length=0),s.index=0;let r=0;for(e=0;e<i;e++)s.getToArray(r,t,e*n),r+=s.stride;}else if(ArrayBuffer.isView(t))t.set(s.array);else {t.length=0;let r=i*n;for(e=0;e<r;e++)t[e]=s.array[e];}}return i}constructor(e){this.vertexBuffer=e,this.vertexFormatSize=e.getFormat().size,this.buffer=this.vertexBuffer.lock(),this.accessors=[],this.element={};let t=this.vertexBuffer.getFormat();for(let e=0;e<t.elements.length;e++){let s=t.elements[e];this.accessors[e]=new n7(this.buffer,s,t),this.element[s.name]=this.accessors[e];}}}let rt="mouse",rs="keyboard",ri="gamepad";class rn{constructor(e,t){this.key=null,this.element=null,this.event=null,t&&(this.key=t.keyCode,this.element=t.target,this.event=t);}}let rr=new rn;function ra(e){return rr.key=e.keyCode,rr.element=e.target,rr.event=e,rr}function ro(e){return "string"==typeof e?e.toUpperCase().charCodeAt(0):e}let rl={9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",27:"Escape",37:"Left",38:"Up",39:"Right",40:"Down",46:"Delete",91:"Win"};class rh extends Y{attach(e){this._element&&this.detach(),this._element=e,this._element.addEventListener("keydown",this._keyDownHandler,false),this._element.addEventListener("keypress",this._keyPressHandler,false),this._element.addEventListener("keyup",this._keyUpHandler,false),document.addEventListener("visibilitychange",this._visibilityChangeHandler,false),window.addEventListener("blur",this._windowBlurHandler,false);}detach(){this._element&&(this._element.removeEventListener("keydown",this._keyDownHandler),this._element.removeEventListener("keypress",this._keyPressHandler),this._element.removeEventListener("keyup",this._keyUpHandler),this._element=null,document.removeEventListener("visibilitychange",this._visibilityChangeHandler,false),window.removeEventListener("blur",this._windowBlurHandler,false));}toKeyIdentifier(e){let t=rl[(e=ro(e)).toString()];if(t)return t;let s=e.toString(16).toUpperCase(),i=s.length;for(let e=0;e<4-i;e++)s="0"+s;return "U+"+s}_handleKeyDown(e){let t=e.keyCode||e.charCode;if(void 0===t)return;let s=this.toKeyIdentifier(t);this._keymap[s]=true,this.fire("keydown",ra(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation();}_handleKeyUp(e){let t=e.keyCode||e.charCode;if(void 0===t)return;let s=this.toKeyIdentifier(t);delete this._keymap[s],this.fire("keyup",ra(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation();}_handleKeyPress(e){this.fire("keypress",ra(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation();}_handleVisibilityChange(){"hidden"===document.visibilityState&&this._handleWindowBlur();}_handleWindowBlur(){this._keymap={},this._lastmap={};}update(){for(let e in this._lastmap)delete this._lastmap[e];for(let e in this._keymap)this._keymap.hasOwnProperty(e)&&(this._lastmap[e]=this._keymap[e]);}isPressed(e){let t=ro(e),s=this.toKeyIdentifier(t);return !!this._keymap[s]}wasPressed(e){let t=ro(e),s=this.toKeyIdentifier(t);return !!this._keymap[s]&&!this._lastmap[s]}wasReleased(e){let t=ro(e),s=this.toKeyIdentifier(t);return !this._keymap[s]&&!!this._lastmap[s]}constructor(e,t={}){super(),this._element=null,this._keymap={},this._lastmap={},this._keyDownHandler=this._handleKeyDown.bind(this),this._keyUpHandler=this._handleKeyUp.bind(this),this._keyPressHandler=this._handleKeyPress.bind(this),this._visibilityChangeHandler=this._handleVisibilityChange.bind(this),this._windowBlurHandler=this._handleWindowBlur.bind(this),e&&this.attach(e),this.preventDefault=t.preventDefault||false,this.stopPropagation=t.stopPropagation||false;}}function rd(){return !!(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)}rh.EVENT_KEYDOWN="keydown",rh.EVENT_KEYUP="keyup";class rc{constructor(e,t){var s,i,n,r;this.x=0,this.y=0,this.dx=0,this.dy=0,this.button=-1,this.wheelDelta=0,this.ctrlKey=false,this.altKey=false,this.shiftKey=false,this.metaKey=false;let a={x:0,y:0};if(t){if(t instanceof rc)throw Error("Expected MouseEvent");a=e._getTargetCoords(t);}else t={};if(a)this.x=a.x,this.y=a.y;else {if(!rd())return;this.x=0,this.y=0;}"wheel"===t.type&&(t.deltaY>0?this.wheelDelta=1:t.deltaY<0&&(this.wheelDelta=-1)),rd()?(this.dx=t.movementX||t.webkitMovementX||t.mozMovementX||0,this.dy=t.movementY||t.webkitMovementY||t.mozMovementY||0):(this.dx=this.x-e._lastX,this.dy=this.y-e._lastY),("mousedown"===t.type||"mouseup"===t.type)&&(this.button=t.button),this.buttons=e._buttons.slice(0),this.element=t.target,this.ctrlKey=null!=(s=t.ctrlKey)&&s,this.altKey=null!=(i=t.altKey)&&i,this.shiftKey=null!=(n=t.shiftKey)&&n,this.metaKey=null!=(r=t.metaKey)&&r,this.event=t;}}class ru extends Y{static isPointerLocked(){return rd()}attach(e){if(this._target=e,this._attached)return;this._attached=true;let t=!!k.passiveEvents&&{passive:false};window.addEventListener("mouseup",this._upHandler,t),window.addEventListener("mousedown",this._downHandler,t),window.addEventListener("mousemove",this._moveHandler,t),window.addEventListener("wheel",this._wheelHandler,t);}detach(){if(!this._attached)return;this._attached=false,this._target=null;let e=!!k.passiveEvents&&{passive:false};window.removeEventListener("mouseup",this._upHandler,e),window.removeEventListener("mousedown",this._downHandler,e),window.removeEventListener("mousemove",this._moveHandler,e),window.removeEventListener("wheel",this._wheelHandler,e);}disableContextMenu(){this._target&&this._target.addEventListener("contextmenu",this._contextMenuHandler);}enableContextMenu(){this._target&&this._target.removeEventListener("contextmenu",this._contextMenuHandler);}enablePointerLock(e,t){if(!document.body.requestPointerLock){t&&t();return}let s=()=>{e(),document.removeEventListener("pointerlockchange",s);},i=()=>{t(),document.removeEventListener("pointerlockerror",i);};e&&document.addEventListener("pointerlockchange",s,false),t&&document.addEventListener("pointerlockerror",i,false),document.body.requestPointerLock();}disablePointerLock(e){if(!document.exitPointerLock)return;let t=()=>{e(),document.removeEventListener("pointerlockchange",t);};e&&document.addEventListener("pointerlockchange",t,false),document.exitPointerLock();}update(){this._lastbuttons[0]=this._buttons[0],this._lastbuttons[1]=this._buttons[1],this._lastbuttons[2]=this._buttons[2];}isPressed(e){return this._buttons[e]}wasPressed(e){return this._buttons[e]&&!this._lastbuttons[e]}wasReleased(e){return !this._buttons[e]&&this._lastbuttons[e]}_handleUp(e){this._buttons[e.button]=false;let t=new rc(this,e);t.event&&this.fire("mouseup",t);}_handleDown(e){this._buttons[e.button]=true;let t=new rc(this,e);t.event&&this.fire("mousedown",t);}_handleMove(e){let t=new rc(this,e);t.event&&(this.fire("mousemove",t),this._lastX=t.x,this._lastY=t.y);}_handleWheel(e){let t=new rc(this,e);t.event&&this.fire("mousewheel",t);}_getTargetCoords(e){let t=this._target.getBoundingClientRect(),s=Math.floor(t.left),i=Math.floor(t.top);return e.clientX<s||e.clientX>=s+this._target.clientWidth||e.clientY<i||e.clientY>=i+this._target.clientHeight?null:{x:e.clientX-s,y:e.clientY-i}}constructor(e){super(),this._lastX=0,this._lastY=0,this._buttons=[false,false,false],this._lastbuttons=[false,false,false],this._target=null,this._attached=false,this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._contextMenuHandler=e=>{e.preventDefault();},this.attach(e);}}ru.EVENT_MOUSEMOVE="mousemove",ru.EVENT_MOUSEDOWN="mousedown",ru.EVENT_MOUSEUP="mouseup",ru.EVENT_MOUSEWHEEL="mousewheel";let rp=Object.freeze([]),rf=function(){return rp};"undefined"!=typeof navigator&&(rf=(navigator.getGamepads||navigator.webkitGetGamepads||rf).bind(navigator));let rm={PAD_FACE_1:0,PAD_FACE_2:1,PAD_FACE_3:2,PAD_FACE_4:3,PAD_L_SHOULDER_1:4,PAD_R_SHOULDER_1:5,PAD_L_SHOULDER_2:6,PAD_R_SHOULDER_2:7,PAD_SELECT:8,PAD_START:9,PAD_L_STICK_BUTTON:10,PAD_R_STICK_BUTTON:11,PAD_UP:12,PAD_DOWN:13,PAD_LEFT:14,PAD_RIGHT:15,PAD_VENDOR:16,XRPAD_TRIGGER:0,XRPAD_SQUEEZE:1,XRPAD_TOUCHPAD_BUTTON:2,XRPAD_STICK_BUTTON:3,XRPAD_A:4,XRPAD_B:5},r_={PAD_L_STICK_X:0,PAD_L_STICK_Y:1,PAD_R_STICK_X:2,PAD_R_STICK_Y:3,XRPAD_TOUCHPAD_X:0,XRPAD_TOUCHPAD_Y:1,XRPAD_STICK_X:2,XRPAD_STICK_Y:3},rg={DEFAULT:{buttons:["PAD_FACE_1","PAD_FACE_2","PAD_FACE_3","PAD_FACE_4","PAD_L_SHOULDER_1","PAD_R_SHOULDER_1","PAD_L_SHOULDER_2","PAD_R_SHOULDER_2","PAD_SELECT","PAD_START","PAD_L_STICK_BUTTON","PAD_R_STICK_BUTTON","PAD_UP","PAD_DOWN","PAD_LEFT","PAD_RIGHT","PAD_VENDOR"],axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]},DEFAULT_DUAL:{buttons:["PAD_FACE_1","PAD_FACE_2","PAD_FACE_3","PAD_FACE_4","PAD_L_SHOULDER_1","PAD_R_SHOULDER_1","PAD_L_SHOULDER_2","PAD_R_SHOULDER_2","PAD_SELECT","PAD_START","PAD_L_STICK_BUTTON","PAD_R_STICK_BUTTON","PAD_VENDOR"],axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"],synthesizedButtons:{PAD_UP:{axis:0,min:0,max:1},PAD_DOWN:{axis:0,min:-1,max:0},PAD_LEFT:{axis:0,min:-1,max:0},PAD_RIGHT:{axis:0,min:0,max:1}}},PS3:{buttons:["PAD_FACE_1","PAD_FACE_2","PAD_FACE_4","PAD_FACE_3","PAD_L_SHOULDER_1","PAD_R_SHOULDER_1","PAD_L_SHOULDER_2","PAD_R_SHOULDER_2","PAD_SELECT","PAD_START","PAD_L_STICK_BUTTON","PAD_R_STICK_BUTTON","PAD_UP","PAD_DOWN","PAD_LEFT","PAD_RIGHT","PAD_VENDOR"],axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"],mapping:"standard"},DEFAULT_XR:{buttons:["XRPAD_TRIGGER","XRPAD_SQUEEZE","XRPAD_TOUCHPAD_BUTTON","XRPAD_STICK_BUTTON","XRPAD_A","XRPAD_B"],axes:["XRPAD_TOUCHPAD_X","XRPAD_TOUCHPAD_Y","XRPAD_STICK_X","XRPAD_STICK_Y"],mapping:"xr-standard"}},rv={"Product: 0268":"PS3"},ry={};function rS(e){let t=ry[e.id];if(t)return t;for(let t in rv)if(-1!==e.id.indexOf(t)){let s=rv[t];if(!e.mapping){let e=rg["RAW_"+s];if(e)return e}return rg[s]}if("xr-standard"===e.mapping)return rg.DEFAULT_XR;let s=rg.DEFAULT,i=e.buttons.length<s.buttons.length?rg.DEFAULT_DUAL:s;return i.mapping=e.mapping,i}let rx=.25;class rT{update(e){var t;let{value:s,pressed:i}=e,n=null!=(t=e.touched)?t:s>0;this.wasPressed=!this.pressed&&i,this.wasReleased=this.pressed&&!i,this.wasTouched=!this.touched&&n,this.value=s,this.pressed=i,this.touched=n;}constructor(e,t){var s,i;this.value=0,this.pressed=false,this.touched=false,this.wasPressed=false,this.wasReleased=false,this.wasTouched=false,"number"==typeof e?(this.value=e,this.pressed=1===e,this.touched=e>0):(this.value=e.value,this.pressed=e.pressed,this.touched=null!=(s=e.touched)?s:e.value>0),t&&("number"==typeof t?(this.wasPressed=1!==t&&this.pressed,this.wasReleased=1===t&&!this.pressed,this.wasTouched=0===t&&this.touched):(this.wasPressed=!t.pressed&&this.pressed,this.wasReleased=t.pressed&&!this.pressed,this.wasTouched=!(null!=(i=t.touched)?i:t.value>0)&&this.touched));}}let rb=Object.freeze(new rT(0));class rE{get connected(){return this.pad.connected}_compileMapping(){let{axes:e,buttons:t}=this._compiledMapping;e.length=0,t.length=0,this.map.axes&&this.map.axes.forEach((t,s)=>{e[r_[t]]=()=>this.pad.axes[s]||0;});for(let t=0,s=e.length;t<s;t++)e[t]||(e[t]=()=>0);let s=this.map.buttons;s&&s.forEach((e,s)=>{t[rm[e]]=()=>this._buttons[s]||rb;});let i=this.map.synthesizedButtons;i&&Object.entries(i).forEach(e=>{let{axis:s,max:i,min:n}=e[1];t[rm[e[0]]]=()=>{var e,t;return new rT(Math.abs(ei.clamp(null!=(e=this._axes[s])?e:0,n,i)),Math.abs(ei.clamp(null!=(t=this._previousAxes[s])?t:0,n,i)))};});for(let e=0,s=t.length;e<s;e++)t[e]||(t[e]=()=>rb);}update(e){this.pad=e;let t=this._previousAxes,s=this._axes;t.length=0,t.push(...s),s.length=0,s.push(...e.axes);let i=this._buttons;for(let t=0,s=i.length;t<s;t++)i[t].update(e.buttons[t]);return this}updateMap(e){e.mapping="custom",ry[this.id]=e,this.map=e,this.mapping="custom",this._compileMapping();}resetMap(){if(ry[this.id]){delete ry[this.id];let e=rS(this.pad);this.map=e,this.mapping=e.mapping,this._compileMapping();}}get axes(){return this._compiledMapping.axes.map(e=>e())}get buttons(){return this._compiledMapping.buttons.map(e=>e())}async pulse(e,t,s){let i=this.pad.vibrationActuator?[this.pad.vibrationActuator]:this.pad.hapticActuators||rp;if(i.length){var n,r,a;let o=null!=(n=null==s?void 0:s.startDelay)?n:0,l=null!=(r=null==s?void 0:s.strongMagnitude)?r:e,h=null!=(a=null==s?void 0:s.weakMagnitude)?a:e;return (await Promise.all(i.map(async s=>{if(!s)return  true;if(s.playEffect)return s.playEffect(s.type,{duration:t,startDelay:o,strongMagnitude:l,weakMagnitude:h});if(s.pulse)return await new Promise(e=>{setTimeout(e,o);}),s.pulse(e,t);return  false}))).some(e=>true===e||"complete"===e)}return  false}getButton(e){let t=this._compiledMapping.buttons[e];return t?t():rb}isPressed(e){return this.getButton(e).pressed}wasPressed(e){return this.getButton(e).wasPressed}wasReleased(e){return this.getButton(e).wasReleased}isTouched(e){return this.getButton(e).touched}wasTouched(e){return this.getButton(e).wasTouched}getValue(e){return this.getButton(e).value}getAxis(e){let t=this.axes[e];return t&&Math.abs(t)>rx?t:0}constructor(e,t){this._compiledMapping={buttons:[],axes:[]},this.id=e.id,this.index=e.index,this._buttons=e.buttons.map(e=>new rT(e)),this._axes=[...e.axes],this._previousAxes=[...e.axes],this.mapping=t.mapping,this.map=t,this.hand=e.hand||"none",this.pad=e,this._compileMapping();}}class rA extends Y{set deadZone(e){rx=e;}get deadZone(){return rx}get previous(){let e=this.current;for(let t=0,s=e.length;t<s;t++){let s=e[t]._buttons;this._previous[t]||(this._previous[t]=[]);for(let e=0,i=s.length;e<i;e++){let i=s[t];this.previous[t][e]=!!i&&(!i.wasPressed&&i.pressed||i.wasReleased);}}return this._previous.length=this.current.length,this._previous}_ongamepadconnected(e){let t=new rE(e.gamepad,this.getMap(e.gamepad)),s=this.current,i=s.findIndex(e=>e.index===t.index);for(;-1!==i;)s.splice(i,1),i=s.findIndex(e=>e.index===t.index);s.push(t),this.fire("gamepadconnected",t);}_ongamepaddisconnected(e){let t=this.current,s=t.findIndex(t=>t.index===e.gamepad.index);-1!==s&&(this.fire("gamepaddisconnected",t[s]),t.splice(s,1));}update(){this.poll();}poll(e){ void 0===e&&(e=[]),e.length>0&&(e.length=0);let t=rf();for(let s=0,i=t.length;s<i;s++)if(t[s]){let i=this.findByIndex(t[s].index);if(i)e.push(i.update(t[s]));else {let i=new rE(t[s],this.getMap(t[s]));this.current.push(i),e.push(i);}}return e}destroy(){window.removeEventListener("gamepadconnected",this._ongamepadconnectedHandler,false),window.removeEventListener("gamepaddisconnected",this._ongamepaddisconnectedHandler,false);}getMap(e){return rS(e)}isPressed(e,t){var s;return (null==(s=this.current[e])?void 0:s.isPressed(t))||false}wasPressed(e,t){var s;return (null==(s=this.current[e])?void 0:s.wasPressed(t))||false}wasReleased(e,t){var s;return (null==(s=this.current[e])?void 0:s.wasReleased(t))||false}getAxis(e,t){var s;return (null==(s=this.current[e])?void 0:s.getAxis(t))||0}pulse(e,t,s,i){let n=this.current[e];return n?n.pulse(t,s,i):Promise.resolve(false)}pulseAll(e,t,s){return Promise.all(this.current.map(i=>i.pulse(e,t,s)))}findById(e){return this.current.find(t=>t&&t.id===e)||null}findByIndex(e){return this.current.find(t=>t&&t.index===e)||null}constructor(){super(),this.gamepadsSupported=k.gamepads,this.current=[],this._previous=[],this._ongamepadconnectedHandler=this._ongamepadconnected.bind(this),this._ongamepaddisconnectedHandler=this._ongamepaddisconnected.bind(this),window.addEventListener("gamepadconnected",this._ongamepadconnectedHandler,false),window.addEventListener("gamepaddisconnected",this._ongamepaddisconnectedHandler,false),this.poll();}}function rw(e){let t=0,s=0,i=e.target;for(;!(i instanceof HTMLElement)&&i;)i=i.parentNode;for(;i;)t+=i.offsetLeft-i.scrollLeft,s+=i.offsetTop-i.scrollTop,i=i.offsetParent;return {x:e.pageX-t,y:e.pageY-s}}rA.EVENT_GAMEPADCONNECTED="gamepadconnected",rA.EVENT_GAMEPADDISCONNECTED="gamepaddisconnected";class rC{constructor(e){let t=rw(e);this.id=e.identifier,this.x=t.x,this.y=t.y,this.target=e.target,this.touch=e;}}class rP{getTouchById(e,t){return t.find(t=>t.id===e)||null}constructor(e,t){this.touches=[],this.changedTouches=[],this.element=t.target,this.event=t,this.touches=Array.from(t.touches).map(e=>new rC(e)),this.changedTouches=Array.from(t.changedTouches).map(e=>new rC(e));}}class rM extends Y{attach(e){this._element&&this.detach(),this._element=e,this._element.addEventListener("touchstart",this._startHandler,false),this._element.addEventListener("touchend",this._endHandler,false),this._element.addEventListener("touchmove",this._moveHandler,false),this._element.addEventListener("touchcancel",this._cancelHandler,false);}detach(){this._element&&(this._element.removeEventListener("touchstart",this._startHandler,false),this._element.removeEventListener("touchend",this._endHandler,false),this._element.removeEventListener("touchmove",this._moveHandler,false),this._element.removeEventListener("touchcancel",this._cancelHandler,false)),this._element=null;}_handleTouchStart(e){this.fire("touchstart",new rP(this,e));}_handleTouchEnd(e){this.fire("touchend",new rP(this,e));}_handleTouchMove(e){e.preventDefault(),this.fire("touchmove",new rP(this,e));}_handleTouchCancel(e){this.fire("touchcancel",new rP(this,e));}constructor(e){super(),this._element=null,this._startHandler=this._handleTouchStart.bind(this),this._endHandler=this._handleTouchEnd.bind(this),this._moveHandler=this._handleTouchMove.bind(this),this._cancelHandler=this._handleTouchCancel.bind(this),this.attach(e);}}rM.EVENT_TOUCHSTART="touchstart",rM.EVENT_TOUCHEND="touchend",rM.EVENT_TOUCHMOVE="touchmove",rM.EVENT_TOUCHCANCEL="touchcancel";class rI{get(e,t,s){return "function"==typeof t&&(s=t,t={}),this.request("GET",e,t,s)}post(e,t,s,i){return "function"==typeof s&&(i=s,s={}),s.postdata=t,this.request("POST",e,s,i)}put(e,t,s,i){return "function"==typeof s&&(i=s,s={}),s.postdata=t,this.request("PUT",e,s,i)}del(e,t,s){return "function"==typeof t&&(s=t,t={}),this.request("DELETE",e,t,s)}request(e,t,s,i){let n,r,a;let o=false;if("function"==typeof s&&(i=s,s={}),s.retry&&(s=Object.assign({retries:0,maxRetries:5},s)),s.callback=i,null==s.async&&(s.async=true),null==s.headers&&(s.headers={}),null!=s.postdata){if(s.postdata instanceof Document)a=s.postdata;else if(s.postdata instanceof FormData)a=s.postdata;else if(s.postdata instanceof Object){let e=s.headers["Content-Type"];switch(void 0===e&&(s.headers["Content-Type"]=rI.ContentType.FORM_URLENCODED,e=s.headers["Content-Type"]),e){case rI.ContentType.FORM_URLENCODED:{a="";let e=true;for(let t in s.postdata)s.postdata.hasOwnProperty(t)&&(e?e=false:a+="&",a+=encodeURIComponent(t)+"="+encodeURIComponent(s.postdata[t]));break}default:case rI.ContentType.JSON:null==e&&(s.headers["Content-Type"]=rI.ContentType.JSON),a=JSON.stringify(s.postdata);}}else a=s.postdata;}if(false===s.cache){let e=$();(n=new et(t)).query?n.query=n.query+"&ts="+e:n.query="ts="+e,t=n.toString();}s.query&&(r=C((n=new et(t)).getQuery(),s.query),n.setQuery(r),t=n.toString());let l=new XMLHttpRequest;for(let i in l.open(e,t,s.async),l.withCredentials=void 0!==s.withCredentials&&s.withCredentials,l.responseType=s.responseType||this._guessResponseType(t),s.headers)s.headers.hasOwnProperty(i)&&l.setRequestHeader(i,s.headers[i]);l.onreadystatechange=()=>{this._onReadyStateChange(e,t,s,l);},l.onerror=()=>{this._onError(e,t,s,l),o=true;};try{l.send(a);}catch(e){o||s.error(l.status,l,e);}return l}_guessResponseType(e){let t=new et(e),s=M.getExtension(t.path).toLowerCase();return rI.binaryExtensions.indexOf(s)>=0?rI.ResponseType.ARRAY_BUFFER:".json"===s?rI.ResponseType.JSON:".xml"===s?rI.ResponseType.DOCUMENT:rI.ResponseType.TEXT}_isBinaryContentType(e){return [rI.ContentType.BASIS,rI.ContentType.BIN,rI.ContentType.DDS,rI.ContentType.GLB,rI.ContentType.MP3,rI.ContentType.MP4,rI.ContentType.OGG,rI.ContentType.OPUS,rI.ContentType.WAV].indexOf(e)>=0}_isBinaryResponseType(e){return e===rI.ResponseType.ARRAY_BUFFER||e===rI.ResponseType.BLOB||e===rI.ResponseType.JSON}_onReadyStateChange(e,t,s,i){if(4===i.readyState)switch(i.status){case 0:i.responseURL&&i.responseURL.startsWith("file:///")?this._onSuccess(e,t,s,i):this._onError(e,t,s,i);break;case 200:case 201:case 206:case 304:this._onSuccess(e,t,s,i);break;default:this._onError(e,t,s,i);}}_onSuccess(e,t,s,i){let n,r;let a=i.getResponseHeader("Content-Type");a&&(r=a.split(";")[0].trim());try{n=this._isBinaryContentType(r)||this._isBinaryResponseType(i.responseType)?i.response:r===rI.ContentType.JSON||t.split("?")[0].endsWith(".json")?JSON.parse(i.responseText):i.responseType===rI.ResponseType.DOCUMENT||r===rI.ContentType.XML?i.responseXML:i.responseText,s.callback(null,n);}catch(e){s.callback(e);}}_onError(e,t,s,i){!s.retrying&&(s.retry&&s.retries<s.maxRetries?(s.retries++,s.retrying=true,setTimeout(()=>{s.retrying=false,this.request(e,t,s,s.callback);},ei.clamp(Math.pow(2,s.retries)*rI.retryDelay,0,s.maxRetryDelay||5e3))):s.callback(0===i.status?"Network error":i.status,null));}}rI.ContentType={AAC:"audio/aac",BASIS:"image/basis",BIN:"application/octet-stream",DDS:"image/dds",FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",GLB:"model/gltf-binary",JPEG:"image/jpeg",JSON:"application/json",MP3:"audio/mpeg",MP4:"audio/mp4",OGG:"audio/ogg",OPUS:'audio/ogg; codecs="opus"',PNG:"image/png",TEXT:"text/plain",WAV:"audio/x-wav",XML:"application/xml"},rI.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document",JSON:"json"},rI.binaryExtensions=[".model",".wav",".ogg",".mp3",".mp4",".m4a",".aac",".dds",".basis",".glb",".opus"],rI.retryDelay=100;let rR=new rI;function rL(){return "undefined"!=typeof AudioContext||"undefined"!=typeof webkitAudioContext}class rD{getVolume(){return this.volume}getLoop(){return this.loop}setLoop(e){this.loop=e,this.source&&(this.source.loop=e);}getPitch(){return this.pitch}onManagerVolumeChange(){this.setVolume(this.getVolume());}onManagerSuspend(){this.isPlaying()&&!this.suspended&&(this.suspended=true,this.pause());}onManagerResume(){this.suspended&&(this.suspended=false,this.unpause());}play(){if(this.source)throw Error("Call stop() before calling play()");this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended&&this.onManagerSuspend());}pause(){this.source&&(this.paused=true,this.startOffset+=this.manager.context.currentTime-this.startTime,this.source.stop(0),this.source=null);}unpause(){if(!this.source&&this.paused)this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.paused=false);}stop(){this.source&&(this.source.stop(0),this.source=null),this.manager.off("volumechange",this.onManagerVolumeChange,this),this.manager.off("suspend",this.onManagerSuspend,this),this.manager.off("resume",this.onManagerResume,this);}setVolume(e){e=ei.clamp(e,0,1),this.volume=e,this.gain&&(this.gain.gain.value=e*this.manager.volume);}setPitch(e){this.pitch=e,this.source&&(this.source.playbackRate.value=e);}isPlaying(){return !this.paused&&this.source.playbackState===this.source.PLAYING_STATE}getDuration(){return this.source?this.source.buffer.duration:0}_createSource(){let e=this.manager.context;this.sound.buffer&&(this.source=e.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.gain),this.gain.connect(e.destination),this.loop||(this.source.onended=this.pause.bind(this)));}constructor(e,t,s={}){var i,n,r;if(this.volume=null!=(i=s.volume)?i:1,this.loop=null!=(n=s.loop)&&n,this.pitch=null!=(r=s.pitch)?r:1,this.sound=t,this.paused=false,this.suspended=false,this.manager=e,this.source=null,rL()){this.startTime=0,this.startOffset=0;let t=e.context;this.gain=t.createGain();}else t.audio&&(this.source=t.audio.cloneNode(false),this.source.pause());}}rL()||Object.assign(rD.prototype,{play:function(){this.source&&(this.paused=false,this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.source.play()),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended&&this.onManagerSuspend();},pause:function(){this.source&&(this.paused=true,this.source.pause());},unpause:function(){this.source&&(this.paused=false,this.source.play());},stop:function(){this.source&&this.source.pause(),this.manager.off("volumechange",this.onManagerVolumeChange,this),this.manager.off("suspend",this.onManagerSuspend,this),this.manager.off("resume",this.onManagerResume,this);},setVolume:function(e){e=ei.clamp(e,0,1),this.volume=e,this.source&&(this.source.volume=e*this.manager.volume);},setPitch:function(e){this.pitch=e,this.source&&(this.source.playbackRate=e);},getDuration:function(){return this.source&&!isNaN(this.source.duration)?this.source.duration:0},isPlaying:function(){return !this.source.paused}});class rO extends rD{getPosition(){return this.position}setPosition(e){this.position.copy(e);let t=this.panner;"positionX"in t?(t.positionX.value=e.x,t.positionY.value=e.y,t.positionZ.value=e.z):t.setPosition&&t.setPosition(e.x,e.y,e.z);}getVelocity(){return this.velocity}setVelocity(e){this.velocity.copy(e);}getMaxDistance(){return this.panner.maxDistance}setMaxDistance(e){this.panner.maxDistance=e;}getMinDistance(){return this.panner.refDistance}setMinDistance(e){this.panner.refDistance=e;}getRollOffFactor(){return this.panner.rolloffFactor}setRollOffFactor(e){this.panner.rolloffFactor=e;}getDistanceModel(){return this.panner.distanceModel}setDistanceModel(e){this.panner.distanceModel=e;}_createSource(){let e=this.manager.context;this.source=e.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.panner),this.panner.connect(this.gain),this.gain.connect(e.destination),this.loop||(this.source.onended=this.pause.bind(this));}constructor(e,t,s){super(e,t,s),this.position=new eu,this.velocity=new eu,rL()?this.panner=e.context.createPanner():(this.maxDistance=1e4,this.minDistance=1,this.rollOffFactor=1,this.distanceModel=eY);}}if(!rL()){let e=new eu,t=function(t,s,i,n,r,a){let o=(e=e.sub2(t,s)).length();if(o<i)return 1;if(o>n)return 0;let l=0;return a===eX?l=1-r*(o-i)/(n-i):a===eY?l=i/(i+r*(o-i)):a===ej&&(l=Math.pow(o/i,-r)),ei.clamp(l,0,1)};Object.assign(rO.prototype,{setPosition:function(e){if(this.position.copy(e),this.source){let e=t(this.manager.listener.getPosition(),this.position,this.minDistance,this.maxDistance,this.rollOffFactor,this.distanceModel),s=this.getVolume();this.source.volume=s*e;}},getMaxDistance:function(){return this.maxDistance},setMaxDistance:function(e){this.maxDistance=e;},getMinDistance:function(){return this.minDistance},setMinDistance:function(e){this.minDistance=e;},getRollOffFactor:function(){return this.rollOffFactor},setRollOffFactor:function(e){this.rollOffFactor=e;},getDistanceModel:function(){return this.distanceModel},setDistanceModel:function(e){this.distanceModel=e;}});}class rF{getPosition(){return this.position}setPosition(e){this.position.copy(e);let t=this.listener;t&&("positionX"in t?(t.positionX.value=e.x,t.positionY.value=e.y,t.positionZ.value=e.z):t.setPosition&&t.setPosition(e.x,e.y,e.z));}setOrientation(e){this.orientation.copy(e);let t=this.listener;if(t){let s=e.data;"forwardX"in t?(t.forwardX.value=-s[8],t.forwardY.value=-s[9],t.forwardZ.value=-s[10],t.upX.value=s[4],t.upY.value=s[5],t.upZ.value=s[6]):t.setOrientation&&t.setOrientation(-s[8],-s[9],-s[10],s[4],s[5],s[6]);}}getOrientation(){return this.orientation}get listener(){let e=this._manager.context;return e?e.listener:null}constructor(e){this.position=new eu,this.orientation=new ex,this._manager=e;}}let rN="running",rB=["click","touchstart","mousedown"];class rU extends Y{set volume(e){e=ei.clamp(e,0,1),this._volume=e,this.fire("volumechange",e);}get volume(){return this._volume}get suspended(){return this._userSuspended}get context(){return !this._context&&this.AudioContext&&(this._context=new this.AudioContext,this._context.state!==rN&&this._registerUnlockListeners()),this._context}suspend(){!this._userSuspended&&(this._userSuspended=true,this._context&&this._context.state===rN&&this._suspend());}resume(){this._userSuspended&&(this._userSuspended=false,this._context&&this._context.state!==rN&&this._resume());}destroy(){if(this.fire("destroy"),this._context){var e;this._removeUnlockListeners(),null==(e=this._context)||e.close(),this._context=null;}}playSound(e,t){ void 0===t&&(t={});let s=null;return rD&&(s=new rD(this,e,t)).play(),s}playSound3d(e,t,s){ void 0===s&&(s={});let i=null;return rO&&((i=new rO(this,e,s)).setPosition(t),s.volume&&i.setVolume(s.volume),s.loop&&i.setLoop(s.loop),s.maxDistance&&i.setMaxDistance(s.maxDistance),s.minDistance&&i.setMinDistance(s.minDistance),s.rollOffFactor&&i.setRollOffFactor(s.rollOffFactor),s.distanceModel&&i.setDistanceModel(s.distanceModel),i.play()),i}_resume(){this._context.resume().then(()=>{let e=this._context.createBufferSource();e.buffer=this._context.createBuffer(1,1,this._context.sampleRate),e.connect(this._context.destination),e.start(0),e.onended=t=>{e.disconnect(0),this.fire("resume");};},e=>{}).catch(e=>{});}_suspend(){this._context.suspend().then(()=>{this.fire("suspend");},e=>{}).catch(e=>{});}_unlockHandler(){this._removeUnlockListeners(),this._userSuspended||this._context.state===rN||this._resume();}_registerUnlockListeners(){rB.forEach(e=>{window.addEventListener(e,this._unlockHandlerFunc,false);});}_removeUnlockListeners(){rB.forEach(e=>{window.removeEventListener(e,this._unlockHandlerFunc,false);});}constructor(){super(),this._context=null,this.AudioContext="undefined"!=typeof AudioContext&&AudioContext||"undefined"!=typeof webkitAudioContext&&webkitAudioContext,this.AudioContext,this._unlockHandlerFunc=this._unlockHandler.bind(this),this._userSuspended=false,this.listener=new rF(this),this._volume=1;}}class rk{get duration(){let e=0;return this.buffer?e=this.buffer.duration:this.audio&&(e=this.audio.duration),e||0}constructor(e){e instanceof Audio?this.audio=e:this.buffer=e;}}class rz extends Y{set currentTime(e){if(!(e<0)){if(0===this._state){let t=this._suspendInstanceEvents;this._suspendInstanceEvents=true,this.stop(),this._startOffset=e,this.play(),this._suspendInstanceEvents=t;}else this._startOffset=e,this._currentTime=e;}}get currentTime(){return null!==this._startOffset?this._startOffset:1===this._state?this._currentTime:2!==this._state&&this.source?(this._updateCurrentTime(),this._currentTime):0}set duration(e){this._duration=Math.max(0,Number(e)||0);let t=0===this._state;this.stop(),t&&this.play();}get duration(){if(!this._sound)return 0;if(this._duration)return this._duration%this._sound.duration||0;return this._sound.duration}get isPaused(){return 1===this._state}get isPlaying(){return 0===this._state}get isStopped(){return 2===this._state}get isSuspended(){return this._suspended}set loop(e){this._loop=!!e,this.source&&(this.source.loop=this._loop);}get loop(){return this._loop}set pitch(e){this._currentOffset=this.currentTime,this._startedAt=this._manager.context.currentTime,this._pitch=Math.max(Number(e)||0,.01),this.source&&(this.source.playbackRate.value=this._pitch);}get pitch(){return this._pitch}set sound(e){this._sound=e,2!==this._state?this.stop():this._createSource();}get sound(){return this._sound}set startTime(e){this._startTime=Math.max(0,Number(e)||0);let t=0===this._state;this.stop(),t&&this.play();}get startTime(){return this._startTime}set volume(e){e=ei.clamp(e,0,1),this._volume=e,this.gain&&(this.gain.gain.value=e*this._manager.volume);}get volume(){return this._volume}_onPlay(){this.fire("play"),this._onPlayCallback&&this._onPlayCallback(this);}_onPause(){this.fire("pause"),this._onPauseCallback&&this._onPauseCallback(this);}_onResume(){this.fire("resume"),this._onResumeCallback&&this._onResumeCallback(this);}_onStop(){this.fire("stop"),this._onStopCallback&&this._onStopCallback(this);}_onEnded(){if(this._suspendEndEvent>0){this._suspendEndEvent--;return}this.fire("end"),this._onEndCallback&&this._onEndCallback(this),this.stop();}_onManagerVolumeChange(){this.volume=this._volume;}_onManagerSuspend(){0!==this._state||this._suspended||(this._suspended=true,this.pause());}_onManagerResume(){this._suspended&&(this._suspended=false,this.resume());}_initializeNodes(){this.gain=this._manager.context.createGain(),this._inputNode=this.gain,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination);}play(){return 2!==this._state&&this.stop(),this._state=0,this._playWhenLoaded=false,!this._waitingContextSuspension&&(this._manager.suspended?(this._manager.once("resume",this._playAudioImmediate,this),this._waitingContextSuspension=true,false):(this._playAudioImmediate(),true))}_playAudioImmediate(){if(this._waitingContextSuspension=false,0!==this._state)return;this.source||this._createSource();let e=this._startOffset%this.duration||0;e=(this._startTime+e)%this._sound.duration||0,this._startOffset=null,this._duration?this.source.start(0,e,this._duration):this.source.start(0,e),this._startedAt=this._manager.context.currentTime,this._currentTime=0,this._currentOffset=e,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._suspendInstanceEvents||this._onPlay();}pause(){return this._playWhenLoaded=false,0===this._state&&(this._state=1,!!this._waitingContextSuspension||(this._updateCurrentTime(),this._suspendEndEvent++,this.source.stop(0),this.source=null,this._startOffset=null,this._suspendInstanceEvents||this._onPause(),true))}resume(){if(1!==this._state)return  false;let e=this.currentTime;if(this._state=0,this._waitingContextSuspension)return  true;if(this.source||this._createSource(),null!==this._startOffset)e=this._startOffset%this.duration||0,e=(this._startTime+e)%this._sound.duration||0,this._startOffset=null;return this._duration?this.source.start(0,e,this._duration):this.source.start(0,e),this._startedAt=this._manager.context.currentTime,this._currentOffset=e,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._playWhenLoaded=false,this._suspendInstanceEvents||this._onResume(),true}stop(){if(this._playWhenLoaded=false,2===this._state)return  false;let e=0===this._state;return this._state=2,!!this._waitingContextSuspension||(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._startedAt=0,this._currentTime=0,this._currentOffset=0,this._startOffset=null,this._suspendEndEvent++,e&&this.source&&this.source.stop(0),this.source=null,this._suspendInstanceEvents||this._onStop(),true)}setExternalNodes(e,t){if(!e)return;t||(t=e);let s=this._manager.context.destination;this._firstNode!==e&&(this._firstNode?this._connectorNode.disconnect(this._firstNode):this._connectorNode.disconnect(s),this._firstNode=e,this._connectorNode.connect(e)),this._lastNode!==t&&(this._lastNode&&this._lastNode.disconnect(s),this._lastNode=t,this._lastNode.connect(s));}clearExternalNodes(){let e=this._manager.context.destination;this._firstNode&&(this._connectorNode.disconnect(this._firstNode),this._firstNode=null),this._lastNode&&(this._lastNode.disconnect(e),this._lastNode=null),this._connectorNode.connect(e);}getExternalNodes(){return [this._firstNode,this._lastNode]}_createSource(){if(!this._sound)return null;let e=this._manager.context;if(this._sound.buffer)this.source=e.createBufferSource(),this.source.buffer=this._sound.buffer,this.source.connect(this._inputNode),this.source.onended=this._endedHandler,this.source.loopStart=this._startTime%this.source.buffer.duration||0,this._duration&&(this.source.loopEnd=Math.max(this.source.loopStart,(this._startTime+this._duration)%this.source.buffer.duration||0));return this.source}_updateCurrentTime(){this._currentTime=((this._manager.context.currentTime-this._startedAt)*this._pitch+this._currentOffset)%this.duration||0;}_onManagerDestroy(){this.source&&0===this._state&&(this.source.stop(0),this.source=null);}constructor(e,t,s){super(),this.source=null,this._manager=e,this._volume=void 0!==s.volume?ei.clamp(Number(s.volume)||0,0,1):1,this._pitch=void 0!==s.pitch?Math.max(.01,Number(s.pitch)||0):1,this._loop=!!(void 0!==s.loop&&s.loop),this._sound=t,this._state=2,this._suspended=false,this._suspendEndEvent=0,this._suspendInstanceEvents=false,this._playWhenLoaded=true,this._startTime=Math.max(0,Number(s.startTime)||0),this._duration=Math.max(0,Number(s.duration)||0),this._startOffset=null,this._onPlayCallback=s.onPlay,this._onPauseCallback=s.onPause,this._onResumeCallback=s.onResume,this._onStopCallback=s.onStop,this._onEndCallback=s.onEnd,rL()?(this._startedAt=0,this._currentTime=0,this._currentOffset=0,this._inputNode=null,this._connectorNode=null,this._firstNode=null,this._lastNode=null,this._waitingContextSuspension=false,this._initializeNodes(),this._endedHandler=this._onEnded.bind(this)):(this._isReady=false,this._loadedMetadataHandler=this._onLoadedMetadata.bind(this),this._timeUpdateHandler=this._onTimeUpdate.bind(this),this._endedHandler=this._onEnded.bind(this),this._createSource());}}rz.EVENT_PLAY="play",rz.EVENT_PAUSE="pause",rz.EVENT_RESUME="resume",rz.EVENT_STOP="stop",rz.EVENT_END="end",rL()||(Object.assign(rz.prototype,{play:function(){return 2!==this._state&&this.stop(),!!(this.source||this._createSource())&&(this.volume=this._volume,this.pitch=this._pitch,this.loop=this._loop,this.source.play(),this._state=0,this._playWhenLoaded=false,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._manager.suspended&&this._onManagerSuspend(),this._suspendInstanceEvents||this._onPlay(),true)},pause:function(){return !!this.source&&0===this._state&&(this._suspendEndEvent++,this.source.pause(),this._playWhenLoaded=false,this._state=1,this._startOffset=null,this._suspendInstanceEvents||this._onPause(),true)},resume:function(){return !!this.source&&1===this._state&&(this._state=0,this._playWhenLoaded=false,this.source.paused&&(this.source.play(),this._suspendInstanceEvents||this._onResume()),true)},stop:function(){return !!this.source&&2!==this._state&&(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._suspendEndEvent++,this.source.pause(),this._playWhenLoaded=false,this._state=2,this._startOffset=null,this._suspendInstanceEvents||this._onStop(),true)},setExternalNodes:function(){},clearExternalNodes:function(){},getExternalNodes:function(){return [null,null]},_onLoadedMetadata:function(){this.source.removeEventListener("loadedmetadata",this._loadedMetadataHandler),this._isReady=true;let e=this._startOffset%this.duration||0;e=(this._startTime+e)%this._sound.duration||0,this._startOffset=null,this.source.currentTime=e;},_createSource:function(){return this._sound&&this._sound.audio&&(this._isReady=false,this.source=this._sound.audio.cloneNode(true),this.source.addEventListener("loadedmetadata",this._loadedMetadataHandler),this.source.addEventListener("timeupdate",this._timeUpdateHandler),this.source.onended=this._endedHandler),this.source},_onTimeUpdate:function(){this._duration&&this.source.currentTime>((this._startTime+this._duration)%this.source.duration||0)&&(this.loop?this.source.currentTime=this._startTime%this.source.duration||0:(this.source.removeEventListener("timeupdate",this._timeUpdateHandler),this.source.pause(),this._onEnded()));},_onManagerDestroy:function(){this.source&&this.source.pause();}}),Object.defineProperty(rz.prototype,"volume",{get:function(){return this._volume},set:function(e){e=ei.clamp(e,0,1),this._volume=e,this.source&&(this.source.volume=e*this._manager.volume);}}),Object.defineProperty(rz.prototype,"pitch",{get:function(){return this._pitch},set:function(e){this._pitch=Math.max(Number(e)||0,.01),this.source&&(this.source.playbackRate=this._pitch);}}),Object.defineProperty(rz.prototype,"sound",{get:function(){return this._sound},set:function(e){this.stop(),this._sound=e;}}),Object.defineProperty(rz.prototype,"currentTime",{get:function(){return null!==this._startOffset?this._startOffset:2!==this._state&&this.source?this.source.currentTime-this._startTime:0},set:function(e){if(!(e<0)&&(this._startOffset=e,this.source&&this._isReady))this.source.currentTime=(this._startTime+(e%this.duration||0))%this._sound.duration||0,this._startOffset=null;}}));class rV extends rz{_initializeNodes(){this.gain=this._manager.context.createGain(),this.panner=this._manager.context.createPanner(),this.panner.connect(this.gain),this._inputNode=this.panner,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination);}set position(e){this._position.copy(e);let t=this.panner;"positionX"in t?(t.positionX.value=e.x,t.positionY.value=e.y,t.positionZ.value=e.z):t.setPosition&&t.setPosition(e.x,e.y,e.z);}get position(){return this._position}set velocity(e){this._velocity.copy(e);}get velocity(){return this._velocity}set maxDistance(e){this.panner.maxDistance=e;}get maxDistance(){return this.panner.maxDistance}set refDistance(e){this.panner.refDistance=e;}get refDistance(){return this.panner.refDistance}set rollOffFactor(e){this.panner.rolloffFactor=e;}get rollOffFactor(){return this.panner.rolloffFactor}set distanceModel(e){this.panner.distanceModel=e;}get distanceModel(){return this.panner.distanceModel}constructor(e,t,s={}){super(e,t,s),this._position=new eu,this._velocity=new eu,s.position&&(this.position=s.position),this.maxDistance=void 0!==s.maxDistance?Number(s.maxDistance):1e4,this.refDistance=void 0!==s.refDistance?Number(s.refDistance):1,this.rollOffFactor=void 0!==s.rollOffFactor?Number(s.rollOffFactor):1,this.distanceModel=void 0!==s.distanceModel?s.distanceModel:eX;}}if(!rL()){let e=new eu,t=function(t,s,i,n,r,a){let o=(e=e.sub2(t,s)).length();if(o<i)return 1;if(o>n)return 0;let l=0;return a===eX?l=1-r*(o-i)/(n-i):a===eY?l=i/(i+r*(o-i)):a===ej&&(l=Math.pow(o/i,-r)),ei.clamp(l,0,1)};Object.defineProperty(rV.prototype,"position",{get:function(){return this._position},set:function(e){if(this._position.copy(e),this.source){let e=t(this._manager.listener.getPosition(),this._position,this.refDistance,this.maxDistance,this.rollOffFactor,this.distanceModel),s=this.volume;this.source.volume=s*e*this._manager.volume;}}}),Object.defineProperty(rV.prototype,"maxDistance",{get:function(){return this._maxDistance},set:function(e){this._maxDistance=e;}}),Object.defineProperty(rV.prototype,"refDistance",{get:function(){return this._refDistance},set:function(e){this._refDistance=e;}}),Object.defineProperty(rV.prototype,"rollOffFactor",{get:function(){return this._rollOffFactor},set:function(e){this._rollOffFactor=e;}}),Object.defineProperty(rV.prototype,"distanceModel",{get:function(){return this._distanceModel},set:function(e){this._distanceModel=e;}});}let rG={0:"SUBTRACTIVE",1:"ADDITIVE",2:"NORMAL",3:"NONE",4:"PREMULTIPLIED",5:"MULTIPLICATIVE",6:"ADDITIVEALPHA",7:"MULTIPLICATIVE2X",8:"SCREEN",9:"MIN",10:"MAX"},rH="none",rW="linear",rX={0:"NONE",2:"SCHLICK"},rY={0:"DIRECTIONAL",1:"OMNI",2:"SPOT"},rj={0:"PUNCTUAL",1:"RECT",2:"DISK",3:"SPHERE"},rq={0:"LINEAR",1:"INVERSESQUARED"},rK=new Map([[5,{name:"PCF1_32F",kind:"PCF1",format:16,pcf:true}],[0,{name:"PCF3_32F",kind:"PCF3",format:16,pcf:true}],[4,{name:"PCF5_32F",kind:"PCF5",format:16,pcf:true}],[7,{name:"PCF1_16F",kind:"PCF1",format:69,pcf:true}],[8,{name:"PCF3_16F",kind:"PCF3",format:69,pcf:true}],[9,{name:"PCF5_16F",kind:"PCF5",format:69,pcf:true}],[2,{name:"VSM_16F",kind:"VSM",format:12,vsm:true}],[3,{name:"VSM_32F",kind:"VSM",format:14,vsm:true}],[6,{name:"PCSS_32F",kind:"PCSS",format:15,pcss:true}]]),rZ={0:"NONE",1:"BOX"},rQ={0:"NONE",1:"SRGB"},rJ=["LINEAR","FILMIC","HEJL","ACES","ACES2","NEUTRAL","NONE"],r$={0:"NONE",1:"AO",2:"GLOSSDEPENDENT"},r0="none",r1="envAtlas",r2="envAtlasHQ",r3="cubeMap",r4="sphereMap",r5={[r0]:"NONE",[r1]:"ENVATLAS",[r2]:"ENVATLASHQ",[r3]:"CUBEMAP",[r4]:"SPHEREMAP"},r6="ambientSH",r8="envAtlas",r9="constant",r7={[r6]:"AMBIENTSH",[r8]:"ENVALATLAS",[r9]:"CONSTANT"},ae={0:"SIMPLE",1:"SLICED",2:"TILED"},at="infinite",as="dome",ai="none",an="bayer8",ar="bluenoise",aa="ignnoise",ao={[ai]:"NONE",[an]:"BAYER8",[ar]:"BLUENOISE",[aa]:"IGNNOISE"},al="prerender",ah="postrender",ad="prerender:layer",ac="postrender:layer",au="precull",ap="postcull";class af{hasUniform(e){for(let t=0;t<this.uniformFormats.length;t++){let s=this.uniformFormats[t];if(null==s?void 0:s.get(e))return  true}return  false}hasTexture(e){for(let t=0;t<this.bindGroupFormats.length;t++){let s=this.bindGroupFormats[t];if(null==s?void 0:s.getTexture(e))return  true}return  false}getVertexElement(e){var t;return null==(t=this.vertexFormat)?void 0:t.elements.find(t=>t.name===e)}generateKey(e){let t=JSON.stringify(this.uniformFormats)+JSON.stringify(this.bindGroupFormats);if(e.isWebGPU){var s;t+=null==(s=this.vertexFormat)?void 0:s.shaderProcessingHashString;}return t}constructor(e,t,s){this.uniformFormats=[],this.bindGroupFormats=[],this.uniformFormats[0]=e,this.bindGroupFormats[0]=t,this.vertexFormat=s;}}let am={alphaTestPS:"\nuniform float alpha_ref;\nvoid alphaTest(float a) {\n	if (a < alpha_ref) discard;\n}\n",ambientPS:'\n#ifdef LIT_AMBIENT_SOURCE == AMBIENTSH\n	uniform vec3 ambientSH[9];\n#endif\n#if LIT_AMBIENT_SOURCE == ENVALATLAS\n	#include "envAtlasPS"\n	#ifndef ENV_ATLAS\n	#define ENV_ATLAS\n	uniform sampler2D texture_envAtlas;\n	#endif\n#endif\nvoid addAmbient(vec3 worldNormal) {\n	#ifdef LIT_AMBIENT_SOURCE == AMBIENTSH\n		vec3 n = cubeMapRotate(worldNormal);\n		vec3 color =\n			ambientSH[0] +\n			ambientSH[1] * n.x +\n			ambientSH[2] * n.y +\n			ambientSH[3] * n.z +\n			ambientSH[4] * n.x * n.z +\n			ambientSH[5] * n.z * n.y +\n			ambientSH[6] * n.y * n.x +\n			ambientSH[7] * (3.0 * n.z * n.z - 1.0) +\n			ambientSH[8] * (n.x * n.x - n.y * n.y);\n		dDiffuseLight += processEnvironment(max(color, vec3(0.0)));\n	#endif\n	#if LIT_AMBIENT_SOURCE == ENVALATLAS\n		vec3 dir = normalize(cubeMapRotate(worldNormal) * vec3(-1.0, 1.0, 1.0));\n		vec2 uv = mapUv(toSphericalUv(dir), vec4(128.0, 256.0 + 128.0, 64.0, 32.0) / atlasSize);\n		vec4 raw = texture2D(texture_envAtlas, uv);\n		vec3 linear = {ambientDecode}(raw);\n		dDiffuseLight += processEnvironment(linear);\n	#endif\n	#if LIT_AMBIENT_SOURCE == CONSTANT\n		dDiffuseLight += light_globalAmbient;\n	#endif\n}\n',aoPS:'\n#if defined(STD_AO_TEXTURE) || defined(STD_AO_VERTEX)\n	uniform float material_aoIntensity;\n#endif\n#ifdef STD_AODETAIL_TEXTURE\n	#include "detailModesPS"\n#endif\nvoid getAO() {\n	dAo = 1.0;\n	#ifdef STD_AO_TEXTURE\n		float aoBase = texture2DBias({STD_AO_TEXTURE_NAME}, {STD_AO_TEXTURE_UV}, textureBias).{STD_AO_TEXTURE_CHANNEL};\n		#ifdef STD_AODETAIL_TEXTURE\n			float aoDetail = texture2DBias({STD_AODETAIL_TEXTURE_NAME}, {STD_AODETAIL_TEXTURE_UV}, textureBias).{STD_AODETAIL_TEXTURE_CHANNEL};\n			aoBase = detailMode_{STD_AODETAIL_DETAILMODE}(vec3(aoBase), vec3(aoDetail)).r;\n		#endif\n		dAo *= aoBase;\n	#endif\n	#ifdef STD_AO_VERTEX\n		dAo *= saturate(vVertexColor.{STD_AO_VERTEX_CHANNEL});\n	#endif\n	#if defined(STD_AO_TEXTURE) || defined(STD_AO_VERTEX)\n		dAo = mix(1.0, dAo, material_aoIntensity);\n	#endif\n}\n',aoDiffuseOccPS:"\nvoid occludeDiffuse(float ao) {\n	dDiffuseLight *= ao;\n}\n",aoSpecOccPS:"\n#if LIT_OCCLUDE_SPECULAR != NONE\n	#ifdef LIT_OCCLUDE_SPECULAR_FLOAT\n		uniform float material_occludeSpecularIntensity;\n	#endif\n#endif\nvoid occludeSpecular(float gloss, float ao, vec3 worldNormal, vec3 viewDir) {\n	#if LIT_OCCLUDE_SPECULAR == AO\n		#ifdef LIT_OCCLUDE_SPECULAR_FLOAT\n			float specOcc = mix(1.0, ao, material_occludeSpecularIntensity);\n		#else\n			float specOcc = ao;\n		#endif\n	#endif\n	#if LIT_OCCLUDE_SPECULAR == GLOSSDEPENDENT\n		float specPow = exp2(gloss * 11.0);\n		float specOcc = saturate(pow(dot(worldNormal, viewDir) + ao, 0.01*specPow) - 1.0 + ao);\n		#ifdef LIT_OCCLUDE_SPECULAR_FLOAT\n			specOcc = mix(1.0, specOcc, material_occludeSpecularIntensity);\n		#endif\n	#endif\n	#if LIT_OCCLUDE_SPECULAR != NONE\n		dSpecularLight *= specOcc;\n		dReflection *= specOcc;\n		#ifdef LIT_SHEEN\n			sSpecularLight *= specOcc;\n			sReflection *= specOcc;\n		#endif\n	#endif\n}\n",basePS:"\nuniform vec3 view_position;\nuniform vec3 light_globalAmbient;\nfloat square(float x) {\n	return x*x;\n}\nfloat saturate(float x) {\n	return clamp(x, 0.0, 1.0);\n}\nvec3 saturate(vec3 x) {\n	return clamp(x, vec3(0.0), vec3(1.0));\n}\n",baseNineSlicedPS:"\n#define NINESLICED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n",baseNineSlicedTiledPS:"\n#define NINESLICED\n#define NINESLICETILED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n",bayerPS:"\nfloat bayer2(vec2 p) {\n	return mod(2.0 * p.y + p.x + 1.0, 4.0);\n}\nfloat bayer4(vec2 p) {\n	vec2 p1 = mod(p, 2.0);\n	vec2 p2 = floor(0.5 * mod(p, 4.0));\n	return 4.0 * bayer2(p1) + bayer2(p2);\n}\nfloat bayer8(vec2 p) {\n	vec2 p1 = mod(p, 2.0);\n	vec2 p2 = floor(0.5 * mod(p, 4.0));\n	vec2 p4 = floor(0.25 * mod(p, 8.0));\n	return 4.0 * (4.0 * bayer2(p1) + bayer2(p2)) + bayer2(p4);\n}\n",blurVSMPS:"\nvarying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\n#ifdef GAUSS\nuniform float weight[SAMPLES];\n#endif\nvoid main(void) {\n	vec3 moments = vec3(0.0);\n	vec2 uv = vUv0 - pixelOffset * (float(SAMPLES) * 0.5);\n	for (int i=0; i<SAMPLES; i++) {\n		vec4 c = texture2D(source, uv + pixelOffset * float(i));\n		#ifdef GAUSS\n		moments += c.xyz * weight[i];\n		#else\n		moments += c.xyz;\n		#endif\n	}\n	#ifndef GAUSS\n	moments /= float(SAMPLES);\n	#endif\n	gl_FragColor = vec4(moments.x, moments.y, moments.z, 1.0);\n}\n",clearCoatPS:"\n#ifdef STD_CLEARCOAT_CONSTANT\nuniform float material_clearCoat;\n#endif\nvoid getClearCoat() {\n	ccSpecularity = 1.0;\n	#ifdef STD_CLEARCOAT_CONSTANT\n	ccSpecularity *= material_clearCoat;\n	#endif\n	#ifdef STD_CLEARCOAT_TEXTURE\n	ccSpecularity *= texture2DBias({STD_CLEARCOAT_TEXTURE_NAME}, {STD_CLEARCOAT_TEXTURE_UV}, textureBias).{STD_CLEARCOAT_TEXTURE_CHANNEL};\n	#endif\n	#ifdef STD_CLEARCOAT_VERTEX\n	ccSpecularity *= saturate(vVertexColor.{STD_CLEARCOAT_VERTEX_CHANNEL});\n	#endif\n}\n",clearCoatGlossPS:"\n#ifdef STD_CLEARCOATGLOSS_CONSTANT\nuniform float material_clearCoatGloss;\n#endif\nvoid getClearCoatGlossiness() {\n	ccGlossiness = 1.0;\n	#ifdef STD_CLEARCOATGLOSS_CONSTANT\n	ccGlossiness *= material_clearCoatGloss;\n	#endif\n	#ifdef STD_CLEARCOATGLOSS_TEXTURE\n	ccGlossiness *= texture2DBias({STD_CLEARCOATGLOSS_TEXTURE_NAME}, {STD_CLEARCOATGLOSS_TEXTURE_UV}, textureBias).{STD_CLEARCOATGLOSS_TEXTURE_CHANNEL};\n	#endif\n	#ifdef STD_CLEARCOATGLOSS_VERTEX\n	ccGlossiness *= saturate(vVertexColor.{STD_CLEARCOATGLOSS_VERTEX_CHANNEL});\n	#endif\n	#ifdef STD_CLEARCOATGLOSS_INVERT\n	ccGlossiness = 1.0 - ccGlossiness;\n	#endif\n	ccGlossiness += 0.0000001;\n}\n",clearCoatNormalPS:"\n#ifdef STD_CLEARCOATNORMAL_TEXTURE\nuniform float material_clearCoatBumpiness;\n#endif\nvoid getClearCoatNormal() {\n#ifdef STD_CLEARCOATNORMAL_TEXTURE\n	vec3 normalMap = {STD_CLEARCOATNORMAL_TEXTURE_DECODE}(texture2DBias({STD_CLEARCOATNORMAL_TEXTURE_NAME}, {STD_CLEARCOATNORMAL_TEXTURE_UV}, textureBias));\n	normalMap = mix(vec3(0.0, 0.0, 1.0), normalMap, material_clearCoatBumpiness);\n	ccNormalW = normalize(dTBN * normalMap);\n#else\n	ccNormalW = dVertexNormalW;\n#endif\n}\n",clusteredLightCookiesPS:"\nvec3 _getCookieClustered(TEXTURE_ACCEPT(tex), vec2 uv, float intensity, vec4 cookieChannel) {\n	vec4 pixel = mix(vec4(1.0), texture2DLod(tex, uv, 0.0), intensity);\n	bool isRgb = dot(cookieChannel.rgb, vec3(1.0)) == 3.0;\n	return isRgb ? pixel.rgb : vec3(dot(pixel, cookieChannel));\n}\nvec3 getCookie2DClustered(TEXTURE_ACCEPT(tex), mat4 transform, vec3 worldPosition, float intensity, vec4 cookieChannel) {\n	vec4 projPos = transform * vec4(worldPosition, 1.0);\n	return _getCookieClustered(TEXTURE_PASS(tex), projPos.xy / projPos.w, intensity, cookieChannel);\n}\nvec3 getCookieCubeClustered(TEXTURE_ACCEPT(tex), vec3 dir, float intensity, vec4 cookieChannel, float shadowTextureResolution, float shadowEdgePixels, vec3 omniAtlasViewport) {\n	vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n	return _getCookieClustered(TEXTURE_PASS(tex), uv, intensity, cookieChannel);\n}\n",clusteredLightShadowsPS:"\nvec3 _getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n	vec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n	projPos.xyz /= projPos.w;\n	return projPos.xyz;\n}\nvec3 getShadowCoordPerspZbufferNormalOffset(mat4 shadowMatrix, vec4 shadowParams, vec3 normal) {\n	vec3 wPos = vPositionW + normal * shadowParams.y;\n	return _getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);\n}\nvec3 normalOffsetPointShadow(vec4 shadowParams, vec3 lightPos, inout vec3 lightDir, vec3 lightDirNorm, vec3 normal) {\n	float distScale = length(lightDir);\n	vec3 wPos = vPositionW + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;\n	vec3 dir = wPos - lightPos;\n	return dir;\n}\n#if defined(CLUSTER_SHADOW_TYPE_PCF1)\nfloat getShadowOmniClusteredPCF1(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {\n	float shadowTextureResolution = shadowParams.x;\n	vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n	float shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n	return textureShadow(shadowMap, vec3(uv, shadowZ));\n}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF3)\nfloat getShadowOmniClusteredPCF3(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {\n	float shadowTextureResolution = shadowParams.x;\n	vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n	float shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n	vec3 shadowCoord = vec3(uv, shadowZ);\n	return getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);\n}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF5)\nfloat getShadowOmniClusteredPCF5(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {\n	float shadowTextureResolution = shadowParams.x;\n	vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n	float shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n	vec3 shadowCoord = vec3(uv, shadowZ);\n	return getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);\n}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF1)\nfloat getShadowSpotClusteredPCF1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n	return textureShadow(shadowMap, shadowCoord);\n}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF3)\nfloat getShadowSpotClusteredPCF3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n	return getShadowSpotPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);\n}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF5)\nfloat getShadowSpotClusteredPCF5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n	return getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);\n}\n#endif\n",clusteredLightUtilsPS:"\nvec2 getCubemapFaceCoordinates(const vec3 dir, out float faceIndex, out vec2 tileOffset)\n{\n	vec3 vAbs = abs(dir);\n	float ma;\n	vec2 uv;\n	if (vAbs.z >= vAbs.x && vAbs.z >= vAbs.y) {\n		faceIndex = dir.z < 0.0 ? 5.0 : 4.0;\n		ma = 0.5 / vAbs.z;\n		uv = vec2(dir.z < 0.0 ? -dir.x : dir.x, -dir.y);\n		tileOffset.x = 2.0;\n		tileOffset.y = dir.z < 0.0 ? 1.0 : 0.0;\n	} else if(vAbs.y >= vAbs.x) {\n		faceIndex = dir.y < 0.0 ? 3.0 : 2.0;\n		ma = 0.5 / vAbs.y;\n		uv = vec2(dir.x, dir.y < 0.0 ? -dir.z : dir.z);\n		tileOffset.x = 1.0;\n		tileOffset.y = dir.y < 0.0 ? 1.0 : 0.0;\n	} else {\n		faceIndex = dir.x < 0.0 ? 1.0 : 0.0;\n		ma = 0.5 / vAbs.x;\n		uv = vec2(dir.x < 0.0 ? dir.z : -dir.z, -dir.y);\n		tileOffset.x = 0.0;\n		tileOffset.y = dir.x < 0.0 ? 1.0 : 0.0;\n	}\n	return uv * ma + 0.5;\n}\nvec2 getCubemapAtlasCoordinates(const vec3 omniAtlasViewport, float shadowEdgePixels, float shadowTextureResolution, const vec3 dir) {\n	float faceIndex;\n	vec2 tileOffset;\n	vec2 uv = getCubemapFaceCoordinates(dir, faceIndex, tileOffset);\n	float atlasFaceSize = omniAtlasViewport.z;\n	float tileSize = shadowTextureResolution * atlasFaceSize;\n	float offset = shadowEdgePixels / tileSize;\n	uv = uv * vec2(1.0 - offset * 2.0) + vec2(offset * 1.0);\n	uv *= atlasFaceSize;\n	uv += tileOffset * atlasFaceSize;\n	uv += omniAtlasViewport.xy;\n	return uv;\n}\n",clusteredLightPS:'\n#include "lightBufferDefinesPS"\n#include "clusteredLightUtilsPS"\n#ifdef CLUSTER_COOKIES\n	#include "clusteredLightCookiesPS"\n#endif\n#ifdef CLUSTER_SHADOWS\n	#include "clusteredLightShadowsPS"\n#endif\nuniform highp sampler2D clusterWorldTexture;\nuniform highp sampler2D lightsTexture;\n#ifdef CLUSTER_SHADOWS\n	uniform sampler2DShadow shadowAtlasTexture;\n#endif\n#ifdef CLUSTER_COOKIES\n	uniform sampler2D cookieAtlasTexture;\n#endif\nuniform int clusterMaxCells;\nuniform float clusterSkip;\nuniform vec3 clusterCellsCountByBoundsSize;\nuniform vec3 clusterTextureSize;\nuniform vec3 clusterBoundsMin;\nuniform vec3 clusterBoundsDelta;\nuniform vec3 clusterCellsDot;\nuniform vec3 clusterCellsMax;\nuniform vec2 shadowAtlasParams;\nstruct ClusterLightData {\n	uint flags;\n	vec3 halfWidth;\n	bool isSpot;\n	vec3 halfHeight;\n	int lightIndex;\n	vec3 position;\n	uint shape;\n	vec3 direction;\n	bool falloffModeLinear;\n	vec3 color;\n	float shadowIntensity;\n	vec3 omniAtlasViewport;\n	float range;\n	vec4 cookieChannelMask;\n	float biasesData;\n	float shadowBias;\n	float shadowNormalBias;\n	float anglesData;\n	float innerConeAngleCos;\n	float outerConeAngleCos;\n	float cookieIntensity;\n	bool isDynamic;\n	bool isLightmapped;\n};\nmat4 lightProjectionMatrix;\nvec4 sampleLightTextureF(const ClusterLightData clusterLightData, int index) {\n	return texelFetch(lightsTexture, ivec2(index, clusterLightData.lightIndex), 0);\n}\nvoid decodeClusterLightCore(inout ClusterLightData clusterLightData, float lightIndex) {\n	clusterLightData.lightIndex = int(lightIndex);\n	vec4 halfData = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_COLOR_ANGLES_BIAS);\n	clusterLightData.anglesData = halfData.z;\n	clusterLightData.biasesData = halfData.w;\n	vec2 colorRG = unpackHalf2x16(floatBitsToUint(halfData.x));\n	vec2 colorB_ = unpackHalf2x16(floatBitsToUint(halfData.y));\n	clusterLightData.color = vec3(colorRG, colorB_.x) * {LIGHT_COLOR_DIVIDER};\n	vec4 lightPosRange = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_POSITION_RANGE);\n	clusterLightData.position = lightPosRange.xyz;\n	clusterLightData.range = lightPosRange.w;\n	vec4 lightDir_Flags = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_DIRECTION_FLAGS);\n	clusterLightData.direction = lightDir_Flags.xyz;\n	clusterLightData.flags = floatBitsToUint(lightDir_Flags.w);\n	clusterLightData.isSpot = (clusterLightData.flags & (1u << 30u)) != 0u;\n	clusterLightData.shape = (clusterLightData.flags >> 28u) & 0x3u;\n	clusterLightData.falloffModeLinear = (clusterLightData.flags & (1u << 27u)) == 0u;\n	clusterLightData.shadowIntensity = float((clusterLightData.flags >> 0u) & 0xFFu) / 255.0;\n	clusterLightData.cookieIntensity = float((clusterLightData.flags >> 8u) & 0xFFu) / 255.0;\n	clusterLightData.isDynamic = (clusterLightData.flags & (1u << 22u)) != 0u;\n	clusterLightData.isLightmapped = (clusterLightData.flags & (1u << 21u)) != 0u;\n}\nvoid decodeClusterLightSpot(inout ClusterLightData clusterLightData) {\n	vec2 angles = unpackHalf2x16(floatBitsToUint(clusterLightData.anglesData));\n	clusterLightData.innerConeAngleCos = angles.x;\n	clusterLightData.outerConeAngleCos = angles.y;\n}\nvoid decodeClusterLightOmniAtlasViewport(inout ClusterLightData clusterLightData) {\n	clusterLightData.omniAtlasViewport = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_PROJ_MAT_0).xyz;\n}\nvoid decodeClusterLightAreaData(inout ClusterLightData clusterLightData) {\n	clusterLightData.halfWidth = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_AREA_DATA_WIDTH).xyz;\n	clusterLightData.halfHeight = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_AREA_DATA_HEIGHT).xyz;\n}\nvoid decodeClusterLightProjectionMatrixData(inout ClusterLightData clusterLightData) {\n	\n	vec4 m0 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_PROJ_MAT_0);\n	vec4 m1 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_PROJ_MAT_1);\n	vec4 m2 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_PROJ_MAT_2);\n	vec4 m3 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_PROJ_MAT_3);\n	lightProjectionMatrix = mat4(m0, m1, m2, m3);\n}\nvoid decodeClusterLightShadowData(inout ClusterLightData clusterLightData) {\n	\n	vec2 biases = unpackHalf2x16(floatBitsToUint(clusterLightData.biasesData));\n	clusterLightData.shadowBias = biases.x;\n	clusterLightData.shadowNormalBias = biases.y;\n}\nvoid decodeClusterLightCookieData(inout ClusterLightData clusterLightData) {\n	uint cookieFlags = (clusterLightData.flags >> 23u) & 0x0Fu;\n	clusterLightData.cookieChannelMask = vec4(uvec4(cookieFlags) & uvec4(1u, 2u, 4u, 8u));\n	clusterLightData.cookieChannelMask = step(1.0, clusterLightData.cookieChannelMask);\n}\nvoid evaluateLight(\n	ClusterLightData light, \n	vec3 worldNormal, \n	vec3 viewDir, \n	vec3 reflectionDir,\n#if defined(LIT_CLEARCOAT)\n	vec3 clearcoatReflectionDir,\n#endif\n	float gloss, \n	vec3 specularity, \n	vec3 geometricNormal, \n	mat3 tbn, \n#if defined(LIT_IRIDESCENCE)\n	vec3 iridescenceFresnel,\n#endif\n	vec3 clearcoat_worldNormal,\n	float clearcoat_gloss,\n	float sheen_gloss,\n	float iridescence_intensity\n) {\n	vec3 cookieAttenuation = vec3(1.0);\n	float diffuseAttenuation = 1.0;\n	float falloffAttenuation = 1.0;\n	vec3 lightDirW;\n	vec3 lightDirNormW;\n	evalOmniLight(light.position, lightDirW, lightDirNormW);\n	#ifdef CLUSTER_AREALIGHTS\n	if (light.shape != {LIGHTSHAPE_PUNCTUAL}) {\n		decodeClusterLightAreaData(light);\n		if (light.shape == {LIGHTSHAPE_RECT}) {\n			calcRectLightValues(light.position, light.halfWidth, light.halfHeight);\n		} else if (light.shape == {LIGHTSHAPE_DISK}) {\n			calcDiskLightValues(light.position, light.halfWidth, light.halfHeight);\n		} else {\n			calcSphereLightValues(light.position, light.halfWidth, light.halfHeight);\n		}\n		falloffAttenuation = getFalloffWindow(light.range, lightDirW);\n	} else\n	#endif\n	{\n		if (light.falloffModeLinear)\n			falloffAttenuation = getFalloffLinear(light.range, lightDirW);\n		else\n			falloffAttenuation = getFalloffInvSquared(light.range, lightDirW);\n	}\n	if (falloffAttenuation > 0.00001) {\n		#ifdef CLUSTER_AREALIGHTS\n		if (light.shape != {LIGHTSHAPE_PUNCTUAL}) {\n			if (light.shape == {LIGHTSHAPE_RECT}) {\n				diffuseAttenuation = getRectLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;\n			} else if (light.shape == {LIGHTSHAPE_DISK}) {\n				diffuseAttenuation = getDiskLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;\n			} else {\n				diffuseAttenuation = getSphereLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;\n			}\n		} else\n		#endif\n		{\n			falloffAttenuation *= getLightDiffuse(worldNormal, viewDir, lightDirNormW); \n		}\n		if (light.isSpot) {\n			decodeClusterLightSpot(light);\n			falloffAttenuation *= getSpotEffect(light.direction, light.innerConeAngleCos, light.outerConeAngleCos, lightDirNormW);\n		}\n		#if defined(CLUSTER_COOKIES) || defined(CLUSTER_SHADOWS)\n		if (falloffAttenuation > 0.00001) {\n			if (light.shadowIntensity > 0.0 || light.cookieIntensity > 0.0) {\n				if (light.isSpot) {\n					decodeClusterLightProjectionMatrixData(light);\n				} else {\n					decodeClusterLightOmniAtlasViewport(light);\n				}\n				float shadowTextureResolution = shadowAtlasParams.x;\n				float shadowEdgePixels = shadowAtlasParams.y;\n				#ifdef CLUSTER_COOKIES\n				if (light.cookieIntensity > 0.0) {\n					decodeClusterLightCookieData(light);\n					if (light.isSpot) {\n						cookieAttenuation = getCookie2DClustered(TEXTURE_PASS(cookieAtlasTexture), lightProjectionMatrix, vPositionW, light.cookieIntensity, light.cookieChannelMask);\n					} else {\n						cookieAttenuation = getCookieCubeClustered(TEXTURE_PASS(cookieAtlasTexture), lightDirW, light.cookieIntensity, light.cookieChannelMask, shadowTextureResolution, shadowEdgePixels, light.omniAtlasViewport);\n					}\n				}\n				#endif\n				#ifdef CLUSTER_SHADOWS\n				if (light.shadowIntensity > 0.0) {\n					decodeClusterLightShadowData(light);\n					vec4 shadowParams = vec4(shadowTextureResolution, light.shadowNormalBias, light.shadowBias, 1.0 / light.range);\n					if (light.isSpot) {\n						vec3 shadowCoord = getShadowCoordPerspZbufferNormalOffset(lightProjectionMatrix, shadowParams, geometricNormal);\n						\n						#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n							float shadow = getShadowSpotClusteredPCF1(SHADOWMAP_PASS(shadowAtlasTexture), shadowCoord, shadowParams);\n						#elif defined(CLUSTER_SHADOW_TYPE_PCF3)\n							float shadow = getShadowSpotClusteredPCF3(SHADOWMAP_PASS(shadowAtlasTexture), shadowCoord, shadowParams);\n						#elif defined(CLUSTER_SHADOW_TYPE_PCF5)\n							float shadow = getShadowSpotClusteredPCF5(SHADOWMAP_PASS(shadowAtlasTexture), shadowCoord, shadowParams);\n						#elif defined(CLUSTER_SHADOW_TYPE_PCSS)\n							float shadow = getShadowSpotClusteredPCSS(SHADOWMAP_PASS(shadowAtlasTexture), shadowCoord, shadowParams);\n						#endif\n						falloffAttenuation *= mix(1.0, shadow, light.shadowIntensity);\n					} else {\n						vec3 dir = normalOffsetPointShadow(shadowParams, light.position, lightDirW, lightDirNormW, geometricNormal);\n						#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n							float shadow = getShadowOmniClusteredPCF1(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);\n						#elif defined(CLUSTER_SHADOW_TYPE_PCF3)\n							float shadow = getShadowOmniClusteredPCF3(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);\n						#elif defined(CLUSTER_SHADOW_TYPE_PCF5)\n							float shadow = getShadowOmniClusteredPCF5(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);\n						#endif\n						falloffAttenuation *= mix(1.0, shadow, light.shadowIntensity);\n					}\n				}\n				#endif\n			}\n		}\n		#endif\n		#ifdef CLUSTER_AREALIGHTS\n		if (light.shape != {LIGHTSHAPE_PUNCTUAL}) {\n			{\n				vec3 areaDiffuse = (diffuseAttenuation * falloffAttenuation) * light.color * cookieAttenuation;\n				#if defined(LIT_SPECULAR)\n					areaDiffuse = mix(areaDiffuse, vec3(0), dLTCSpecFres);\n				#endif\n				dDiffuseLight += areaDiffuse;\n			}\n			#ifdef LIT_SPECULAR\n				float areaLightSpecular;\n				if (light.shape == {LIGHTSHAPE_RECT}) {\n					areaLightSpecular = getRectLightSpecular(worldNormal, viewDir);\n				} else if (light.shape == {LIGHTSHAPE_DISK}) {\n					areaLightSpecular = getDiskLightSpecular(worldNormal, viewDir);\n				} else {\n					areaLightSpecular = getSphereLightSpecular(worldNormal, viewDir);\n				}\n				dSpecularLight += dLTCSpecFres * areaLightSpecular * falloffAttenuation * light.color * cookieAttenuation;\n				#ifdef LIT_CLEARCOAT\n					float areaLightSpecularCC;\n					if (light.shape == {LIGHTSHAPE_RECT}) {\n						areaLightSpecularCC = getRectLightSpecular(clearcoat_worldNormal, viewDir);\n					} else if (light.shape == {LIGHTSHAPE_DISK}) {\n						areaLightSpecularCC = getDiskLightSpecular(clearcoat_worldNormal, viewDir);\n					} else {\n						areaLightSpecularCC = getSphereLightSpecular(clearcoat_worldNormal, viewDir);\n					}\n					ccSpecularLight += ccLTCSpecFres * areaLightSpecularCC * falloffAttenuation * light.color  * cookieAttenuation;\n				#endif\n			#endif\n		} else\n		#endif\n		{\n			{\n				vec3 punctualDiffuse = falloffAttenuation * light.color * cookieAttenuation;\n				#if defined(CLUSTER_AREALIGHTS)\n				#if defined(LIT_SPECULAR)\n					punctualDiffuse = mix(punctualDiffuse, vec3(0), specularity);\n				#endif\n				#endif\n				dDiffuseLight += punctualDiffuse;\n			}\n   \n			#ifdef LIT_SPECULAR\n				vec3 halfDir = normalize(-lightDirNormW + viewDir);\n				\n				#ifdef LIT_SPECULAR_FRESNEL\n					dSpecularLight += \n						getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, lightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * \n						getFresnel(\n							dot(viewDir, halfDir), \n							gloss, \n							specularity\n						#if defined(LIT_IRIDESCENCE)\n							, iridescenceFresnel,\n							iridescence_intensity\n						#endif\n							);\n				#else\n					dSpecularLight += getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, lightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * specularity;\n				#endif\n				#ifdef LIT_CLEARCOAT\n					#ifdef LIT_SPECULAR_FRESNEL\n						ccSpecularLight += getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, lightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * getFresnelCC(dot(viewDir, halfDir));\n					#else\n						ccSpecularLight += getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, lightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation; \n					#endif\n				#endif\n				#ifdef LIT_SHEEN\n					sSpecularLight += getLightSpecularSheen(halfDir, worldNormal, viewDir, lightDirNormW, sheen_gloss) * falloffAttenuation * light.color * cookieAttenuation;\n				#endif\n			#endif\n		}\n	}\n	dAtten = falloffAttenuation;\n	dLightDirNormW = lightDirNormW;\n}\nvoid evaluateClusterLight(\n	float lightIndex, \n	vec3 worldNormal, \n	vec3 viewDir, \n	vec3 reflectionDir, \n#if defined(LIT_CLEARCOAT)\n	vec3 clearcoatReflectionDir,\n#endif\n	float gloss, \n	vec3 specularity, \n	vec3 geometricNormal, \n	mat3 tbn, \n#if defined(LIT_IRIDESCENCE)\n	vec3 iridescenceFresnel,\n#endif\n	vec3 clearcoat_worldNormal,\n	float clearcoat_gloss,\n	float sheen_gloss,\n	float iridescence_intensity\n) {\n	ClusterLightData clusterLightData;\n	decodeClusterLightCore(clusterLightData, lightIndex);\n	#ifdef CLUSTER_MESH_DYNAMIC_LIGHTS\n		bool acceptLightMask = clusterLightData.isDynamic;\n	#else\n		bool acceptLightMask = clusterLightData.isLightmapped;\n	#endif\n	if (acceptLightMask)\n		evaluateLight(\n			clusterLightData, \n			worldNormal, \n			viewDir, \n			reflectionDir, \n#if defined(LIT_CLEARCOAT)\n			clearcoatReflectionDir, \n#endif\n			gloss, \n			specularity, \n			geometricNormal, \n			tbn, \n#if defined(LIT_IRIDESCENCE)\n			iridescenceFresnel,\n#endif\n			clearcoat_worldNormal,\n			clearcoat_gloss,\n			sheen_gloss,\n			iridescence_intensity\n		);\n}\nvoid addClusteredLights(\n	vec3 worldNormal, \n	vec3 viewDir, \n	vec3 reflectionDir, \n#if defined(LIT_CLEARCOAT)\n	vec3 clearcoatReflectionDir,\n#endif\n	float gloss, \n	vec3 specularity, \n	vec3 geometricNormal, \n	mat3 tbn, \n#if defined(LIT_IRIDESCENCE)\n	vec3 iridescenceFresnel,\n#endif\n	vec3 clearcoat_worldNormal,\n	float clearcoat_gloss,\n	float sheen_gloss,\n	float iridescence_intensity\n) {\n	if (clusterSkip > 0.5)\n		return;\n	vec3 cellCoords = floor((vPositionW - clusterBoundsMin) * clusterCellsCountByBoundsSize);\n	if (!(any(lessThan(cellCoords, vec3(0.0))) || any(greaterThanEqual(cellCoords, clusterCellsMax)))) {\n		float cellIndex = dot(clusterCellsDot, cellCoords);\n		float clusterV = floor(cellIndex * clusterTextureSize.y);\n		float clusterU = cellIndex - (clusterV * clusterTextureSize.x);\n		for (int lightCellIndex = 0; lightCellIndex < clusterMaxCells; lightCellIndex++) {\n			float lightIndex = texelFetch(clusterWorldTexture, ivec2(int(clusterU) + lightCellIndex, clusterV), 0).x;\n			if (lightIndex <= 0.0)\n					return;\n			evaluateClusterLight(\n				lightIndex * 255.0, \n				worldNormal, \n				viewDir, \n				reflectionDir,\n#if defined(LIT_CLEARCOAT)\n				clearcoatReflectionDir,\n#endif\n				gloss, \n				specularity, \n				geometricNormal, \n				tbn, \n#if defined(LIT_IRIDESCENCE)\n				iridescenceFresnel,\n#endif\n				clearcoat_worldNormal,\n				clearcoat_gloss,\n				sheen_gloss,\n				iridescence_intensity\n			); \n		}\n	}\n}\n',combinePS:"\nvec3 combineColor(vec3 albedo, vec3 sheenSpecularity, float clearcoatSpecularity) {\n	vec3 ret = vec3(0);\n#ifdef LIT_OLD_AMBIENT\n	ret += (dDiffuseLight - light_globalAmbient) * albedo + material_ambient * light_globalAmbient;\n#else\n	ret += albedo * dDiffuseLight;\n#endif\n#ifdef LIT_SPECULAR\n	ret += dSpecularLight;\n#endif\n#ifdef LIT_REFLECTIONS\n	ret += dReflection.rgb * dReflection.a;\n#endif\n#ifdef LIT_SHEEN\n	float sheenScaling = 1.0 - max(max(sheenSpecularity.r, sheenSpecularity.g), sheenSpecularity.b) * 0.157;\n	ret = ret * sheenScaling + (sSpecularLight + sReflection.rgb) * sheenSpecularity;\n#endif\n#ifdef LIT_CLEARCOAT\n	float clearCoatScaling = 1.0 - ccFresnel * clearcoatSpecularity;\n	ret = ret * clearCoatScaling + (ccSpecularLight + ccReflection.rgb) * clearcoatSpecularity;\n#endif\n	return ret;\n}\n",cookieBlit2DPS:"\n	varying vec2 uv0;\n	uniform sampler2D blitTexture;\n	void main(void) {\n		gl_FragColor = texture2D(blitTexture, uv0);\n	}\n",cookieBlitCubePS:"\n	varying vec2 uv0;\n	uniform samplerCube blitTexture;\n	uniform mat4 invViewProj;\n	void main(void) {\n		vec4 projPos = vec4(uv0 * 2.0 - 1.0, 0.5, 1.0);\n		vec4 worldPos = invViewProj * projPos;\n		gl_FragColor = textureCube(blitTexture, worldPos.xyz);\n	}\n",cookieBlitVS:"\n	attribute vec2 vertex_position;\n	varying vec2 uv0;\n	void main(void) {\n		gl_Position = vec4(vertex_position, 0.5, 1.0);\n		uv0 = vertex_position.xy * 0.5 + 0.5;\n		#ifndef WEBGPU\n			uv0.y = 1.0 - uv0.y;\n		#endif\n	}\n",cookiePS:"\nvec4 getCookie2D(sampler2D tex, mat4 transform, float intensity) {\n	vec4 projPos = transform * vec4(vPositionW, 1.0);\n	projPos.xy /= projPos.w;\n	return mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DClip(sampler2D tex, mat4 transform, float intensity) {\n	vec4 projPos = transform * vec4(vPositionW, 1.0);\n	projPos.xy /= projPos.w;\n	if (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n	return mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n	vec4 projPos = transform * vec4(vPositionW, 1.0);\n	projPos.xy /= projPos.w;\n	projPos.xy += cookieOffset;\n	vec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n	return mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookie2DClipXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n	vec4 projPos = transform * vec4(vPositionW, 1.0);\n	projPos.xy /= projPos.w;\n	projPos.xy += cookieOffset;\n	if (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n	vec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n	return mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookieCube(samplerCube tex, mat4 transform, float intensity) {\n	return mix(vec4(1.0), textureCube(tex, dLightDirNormW * mat3(transform)), intensity);\n}\n",cubeMapProjectPS:"\n#if LIT_CUBEMAP_PROJECTION == BOX\n	uniform vec3 envBoxMin;\n	uniform vec3 envBoxMax;\n#endif\nvec3 cubeMapProject(vec3 nrdir) {\n	#if LIT_CUBEMAP_PROJECTION == NONE\n		return cubeMapRotate(nrdir);\n	#endif\n	#if LIT_CUBEMAP_PROJECTION == BOX\n		nrdir = cubeMapRotate(nrdir);\n		vec3 rbmax = (envBoxMax - vPositionW) / nrdir;\n		vec3 rbmin = (envBoxMin - vPositionW) / nrdir;\n		vec3 rbminmax;\n		rbminmax.x = nrdir.x>0.0? rbmax.x : rbmin.x;\n		rbminmax.y = nrdir.y>0.0? rbmax.y : rbmin.y;\n		rbminmax.z = nrdir.z>0.0? rbmax.z : rbmin.z;\n		float fa = min(min(rbminmax.x, rbminmax.y), rbminmax.z);\n		vec3 posonbox = vPositionW + nrdir * fa;\n		vec3 envBoxPos = (envBoxMin + envBoxMax) * 0.5;\n		return normalize(posonbox - envBoxPos);\n	#endif\n}\n",cubeMapRotatePS:"\n#ifdef CUBEMAP_ROTATION\nuniform mat3 cubeMapRotationMatrix;\n#endif\nvec3 cubeMapRotate(vec3 refDir) {\n#ifdef CUBEMAP_ROTATION\n	return refDir * cubeMapRotationMatrix;\n#else\n	return refDir;\n#endif\n}\n",debugOutputPS:"\n#ifdef DEBUG_ALBEDO_PASS\ngl_FragColor = vec4(gammaCorrectOutput(dAlbedo), 1.0);\n#endif\n#ifdef DEBUG_UV0_PASS\ngl_FragColor = vec4(litArgs_albedo , 1.0);\n#endif\n#ifdef DEBUG_WORLD_NORMAL_PASS\ngl_FragColor = vec4(litArgs_worldNormal * 0.5 + 0.5, 1.0);\n#endif\n#ifdef DEBUG_OPACITY_PASS\ngl_FragColor = vec4(vec3(litArgs_opacity) , 1.0);\n#endif\n#ifdef DEBUG_SPECULARITY_PASS\ngl_FragColor = vec4(litArgs_specularity, 1.0);\n#endif\n#ifdef DEBUG_GLOSS_PASS\ngl_FragColor = vec4(vec3(litArgs_gloss) , 1.0);\n#endif\n#ifdef DEBUG_METALNESS_PASS\ngl_FragColor = vec4(vec3(litArgs_metalness) , 1.0);\n#endif\n#ifdef DEBUG_AO_PASS\ngl_FragColor = vec4(vec3(litArgs_ao) , 1.0);\n#endif\n#ifdef DEBUG_EMISSION_PASS\ngl_FragColor = vec4(gammaCorrectOutput(litArgs_emission), 1.0);\n#endif\n",debugProcessFrontendPS:"\n#ifdef DEBUG_LIGHTING_PASS\nlitArgs_albedo = vec3(0.5);\n#endif\n#ifdef DEBUG_UV0_PASS\n#ifdef VARYING_VUV0\nlitArgs_albedo = vec3(vUv0, 0);\n#else\nlitArgs_albedo = vec3(0);\n#endif\n#endif\n",detailModesPS:"\n#ifndef _DETAILMODES_INCLUDED_\n#define _DETAILMODES_INCLUDED_\nvec3 detailMode_mul(vec3 c1, vec3 c2) {\n	return c1 * c2;\n}\nvec3 detailMode_add(vec3 c1, vec3 c2) {\n	return c1 + c2;\n}\nvec3 detailMode_screen(vec3 c1, vec3 c2) {\n	return 1.0 - (1.0 - c1)*(1.0 - c2);\n}\nvec3 detailMode_overlay(vec3 c1, vec3 c2) {\n	return mix(1.0 - 2.0*(1.0 - c1)*(1.0 - c2), 2.0*c1*c2, step(c1, vec3(0.5)));\n}\nvec3 detailMode_min(vec3 c1, vec3 c2) {\n	return min(c1, c2);\n}\nvec3 detailMode_max(vec3 c1, vec3 c2) {\n	return max(c1, c2);\n}\n#endif\n",diffusePS:'\nuniform vec3 material_diffuse;\n#ifdef STD_DIFFUSEDETAIL_TEXTURE\n	#include "detailModesPS"\n#endif\nvoid getAlbedo() {\n	dAlbedo = material_diffuse.rgb;\n	#ifdef STD_DIFFUSE_TEXTURE\n		vec3 albedoTexture = {STD_DIFFUSE_TEXTURE_DECODE}(texture2DBias({STD_DIFFUSE_TEXTURE_NAME}, {STD_DIFFUSE_TEXTURE_UV}, textureBias)).{STD_DIFFUSE_TEXTURE_CHANNEL};\n		#ifdef STD_DIFFUSEDETAIL_TEXTURE\n			vec3 albedoDetail = {STD_DIFFUSEDETAIL_TEXTURE_DECODE}(texture2DBias({STD_DIFFUSEDETAIL_TEXTURE_NAME}, {STD_DIFFUSEDETAIL_TEXTURE_UV}, textureBias)).{STD_DIFFUSEDETAIL_TEXTURE_CHANNEL};\n			albedoTexture = detailMode_{STD_DIFFUSEDETAIL_DETAILMODE}(albedoTexture, albedoDetail);\n		#endif\n		dAlbedo *= albedoTexture;\n	#endif\n	#ifdef STD_DIFFUSE_VERTEX\n		dAlbedo *= gammaCorrectInput(saturate(vVertexColor.{STD_DIFFUSE_VERTEX_CHANNEL}));\n	#endif\n}\n',decodePS:"\n#ifndef _DECODE_INCLUDED_\n#define _DECODE_INCLUDED_\nvec3 decodeLinear(vec4 raw) {\n	return raw.rgb;\n}\nfloat decodeGamma(float raw) {\n	return pow(raw, 2.2);\n}\nvec3 decodeGamma(vec3 raw) {\n	return pow(raw, vec3(2.2));\n}\nvec3 decodeGamma(vec4 raw) {\n	return pow(raw.xyz, vec3(2.2));\n}\nvec3 decodeRGBM(vec4 raw) {\n	vec3 color = (8.0 * raw.a) * raw.rgb;\n	return color * color;\n}\nvec3 decodeRGBP(vec4 raw) {\n	vec3 color = raw.rgb * (-raw.a * 7.0 + 8.0);\n	return color * color;\n}\nvec3 decodeRGBE(vec4 raw) {\n	if (raw.a == 0.0) {\n		return vec3(0.0, 0.0, 0.0);\n	} else {\n		return raw.xyz * pow(2.0, raw.w * 255.0 - 128.0);\n	}\n}\nvec4 passThrough(vec4 raw) {\n	return raw;\n}\nvec3 unpackNormalXYZ(vec4 nmap) {\n	return nmap.xyz * 2.0 - 1.0;\n}\nvec3 unpackNormalXY(vec4 nmap) {\n	vec3 normal;\n	normal.xy = nmap.wy * 2.0 - 1.0;\n	normal.z = sqrt(1.0 - clamp(dot(normal.xy, normal.xy), 0.0, 1.0));\n	return normal;\n}\n#endif\n",emissivePS:"\nuniform vec3 material_emissive;\nuniform float material_emissiveIntensity;\nvoid getEmission() {\n	dEmission = material_emissive * material_emissiveIntensity;\n	#ifdef STD_EMISSIVE_TEXTURE\n	dEmission *= {STD_EMISSIVE_TEXTURE_DECODE}(texture2DBias({STD_EMISSIVE_TEXTURE_NAME}, {STD_EMISSIVE_TEXTURE_UV}, textureBias)).{STD_EMISSIVE_TEXTURE_CHANNEL};\n	#endif\n	#ifdef STD_EMISSIVE_VERTEX\n	dEmission *= gammaCorrectInput(saturate(vVertexColor.{STD_EMISSIVE_VERTEX_CHANNEL}));\n	#endif\n}\n",encodePS:"\nvec4 encodeLinear(vec3 source) {\n	return vec4(source, 1.0);\n}\nvec4 encodeGamma(vec3 source) {\n	return vec4(pow(source + 0.0000001, vec3(1.0 / 2.2)), 1.0);\n}\nvec4 encodeRGBM(vec3 source) {\n	vec4 result;\n	result.rgb = pow(source.rgb, vec3(0.5));\n	result.rgb *= 1.0 / 8.0;\n	result.a = saturate( max( max( result.r, result.g ), max( result.b, 1.0 / 255.0 ) ) );\n	result.a = ceil(result.a * 255.0) / 255.0;\n	result.rgb /= result.a;\n	return result;\n}\nvec4 encodeRGBP(vec3 source) {\n	vec3 gamma = pow(source, vec3(0.5));\n	float maxVal = min(8.0, max(1.0, max(gamma.x, max(gamma.y, gamma.z))));\n	float v = 1.0 - ((maxVal - 1.0) / 7.0);\n	v = ceil(v * 255.0) / 255.0;\n	return vec4(gamma / (-v * 7.0 + 8.0), v);	\n}\nvec4 encodeRGBE(vec3 source) {\n	float maxVal = max(source.x, max(source.y, source.z));\n	if (maxVal < 1e-32) {\n		return vec4(0, 0, 0, 0);\n	} else {\n		float e = ceil(log2(maxVal));\n		return vec4(source / pow(2.0, e), (e + 128.0) / 255.0);\n	}\n}\n",endPS:"\n	gl_FragColor.rgb = combineColor(litArgs_albedo, litArgs_sheen_specularity, litArgs_clearcoat_specularity);\n	gl_FragColor.rgb += litArgs_emission;\n	gl_FragColor.rgb = addFog(gl_FragColor.rgb);\n	gl_FragColor.rgb = toneMap(gl_FragColor.rgb);\n	gl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);\n",envAtlasPS:"\n#ifndef _ENVATLAS_INCLUDED_\n#define _ENVATLAS_INCLUDED_\nconst float atlasSize = 512.0;\nconst float seamSize = 1.0 / atlasSize;\nvec2 mapUv(vec2 uv, vec4 rect) {\n	return vec2(mix(rect.x + seamSize, rect.x + rect.z - seamSize, uv.x),\n				mix(rect.y + seamSize, rect.y + rect.w - seamSize, uv.y));\n}\nvec2 mapRoughnessUv(vec2 uv, float level) {\n	float t = 1.0 / exp2(level);\n	return mapUv(uv, vec4(0, 1.0 - t, t, t * 0.5));\n}\nvec2 mapShinyUv(vec2 uv, float level) {\n	float t = 1.0 / exp2(level);\n	return mapUv(uv, vec4(1.0 - t, 1.0 - t, t, t * 0.5));\n}\n#endif\n",envProcPS:"\n#ifdef LIT_SKYBOX_INTENSITY\n	uniform float skyboxIntensity;\n#endif\nvec3 processEnvironment(vec3 color) {\n	#ifdef LIT_SKYBOX_INTENSITY\n		return color * skyboxIntensity;\n	#else\n		return color;\n	#endif\n}\n",falloffInvSquaredPS:"\nfloat getFalloffWindow(float lightRadius, vec3 lightDir) {\n	float sqrDist = dot(lightDir, lightDir);\n	float invRadius = 1.0 / lightRadius;\n	return square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n}\nfloat getFalloffInvSquared(float lightRadius, vec3 lightDir) {\n	float sqrDist = dot(lightDir, lightDir);\n	float falloff = 1.0 / (sqrDist + 1.0);\n	float invRadius = 1.0 / lightRadius;\n	falloff *= 16.0;\n	falloff *= square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n	return falloff;\n}\n",falloffLinearPS:"\nfloat getFalloffLinear(float lightRadius, vec3 lightDir) {\n	float d = length(lightDir);\n	return max(((lightRadius - d) / lightRadius), 0.0);\n}\n",floatAsUintPS:"\n#ifndef FLOAT_AS_UINT\n#define FLOAT_AS_UINT\nvec4 float2uint(float value) {\n	uint intBits = floatBitsToUint(value);\n	return vec4(\n		float((intBits >> 24u) & 0xFFu) / 255.0,\n		float((intBits >> 16u) & 0xFFu) / 255.0,\n		float((intBits >> 8u) & 0xFFu) / 255.0,\n		float(intBits & 0xFFu) / 255.0\n	);\n}\nfloat uint2float(vec4 value) {\n	uint intBits = \n		(uint(value.r * 255.0) << 24u) |\n		(uint(value.g * 255.0) << 16u) |\n		(uint(value.b * 255.0) << 8u) |\n		uint(value.a * 255.0);\n	return uintBitsToFloat(intBits);\n}\nvec4 float2vec4(float value) {\n	#if defined(CAPS_TEXTURE_FLOAT_RENDERABLE)\n		return vec4(value, 1.0, 1.0, 1.0);\n	#else\n		return float2uint(value);\n	#endif\n}\n#endif\n",fogPS:"\nfloat dBlendModeFogFactor = 1.0;\n#if (FOG != NONE)\n	uniform vec3 fog_color;\n	#if (FOG == LINEAR)\n		uniform float fog_start;\n		uniform float fog_end;\n	#else\n		uniform float fog_density;\n	#endif\n#endif\nfloat getFogFactor() {\n	float depth = gl_FragCoord.z / gl_FragCoord.w;\n	float fogFactor = 0.0;\n	#if (FOG == LINEAR)\n		fogFactor = (fog_end - depth) / (fog_end - fog_start);\n	#elif (FOG == EXP)\n		fogFactor = exp(-depth * fog_density);\n	#elif (FOG == EXP2)\n		fogFactor = exp(-depth * depth * fog_density * fog_density);\n	#endif\n	return clamp(fogFactor, 0.0, 1.0);\n}\nvec3 addFog(vec3 color) {\n	#if (FOG != NONE)\n		return mix(fog_color * dBlendModeFogFactor, color, getFogFactor());\n	#endif\n	return color;\n}\n",fresnelSchlickPS:"\nvec3 getFresnel(\n		float cosTheta, \n		float gloss, \n		vec3 specularity\n#if defined(LIT_IRIDESCENCE)\n		, vec3 iridescenceFresnel, \n		float iridescenceIntensity\n#endif\n	) {\n	float fresnel = pow(1.0 - max(cosTheta, 0.0), 5.0);\n	float glossSq = gloss * gloss;\n	vec3 ret = specularity + (max(vec3(glossSq), specularity) - specularity) * fresnel;\n#if defined(LIT_IRIDESCENCE)\n	return mix(ret, iridescenceFresnel, iridescenceIntensity);\n#else\n	return ret;\n#endif	\n}\nfloat getFresnelCC(float cosTheta) {\n	float fresnel = pow(1.0 - max(cosTheta, 0.0), 5.0);\n	return 0.04 + (1.0 - 0.04) * fresnel;\n}\n",fullscreenQuadPS:"\nvarying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n	gl_FragColor = texture2D(source, vUv0);\n}\n",fullscreenQuadVS:"\nattribute vec2 vertex_position;\nvarying vec2 vUv0;\nvoid main(void)\n{\n	gl_Position = vec4(vertex_position, 0.5, 1.0);\n	vUv0 = vertex_position.xy*0.5+0.5;\n}\n",gammaPS:'\n#include "decodePS"\n#if (GAMMA == SRGB)\n	float gammaCorrectInput(float color) {\n		return decodeGamma(color);\n	}\n	vec3 gammaCorrectInput(vec3 color) {\n		return decodeGamma(color);\n	}\n	vec4 gammaCorrectInput(vec4 color) {\n		return vec4(decodeGamma(color.xyz), color.w);\n	}\n	vec3 gammaCorrectOutput(vec3 color) {\n		return pow(color + 0.0000001, vec3(1.0 / 2.2));\n	}\n#else\n	float gammaCorrectInput(float color) {\n		return color;\n	}\n	vec3 gammaCorrectInput(vec3 color) {\n		return color;\n	}\n	vec4 gammaCorrectInput(vec4 color) {\n		return color;\n	}\n	vec3 gammaCorrectOutput(vec3 color) {\n		return color;\n	}\n#endif\n',gles3PS:i3,gles3VS:i4,glossPS:"\n#ifdef STD_GLOSS_CONSTANT\nuniform float material_gloss;\n#endif\nvoid getGlossiness() {\n	dGlossiness = 1.0;\n	#ifdef STD_GLOSS_CONSTANT\n	dGlossiness *= material_gloss;\n	#endif\n	#ifdef STD_GLOSS_TEXTURE\n	dGlossiness *= texture2DBias({STD_GLOSS_TEXTURE_NAME}, {STD_GLOSS_TEXTURE_UV}, textureBias).{STD_GLOSS_TEXTURE_CHANNEL};\n	#endif\n	#ifdef STD_GLOSS_VERTEX\n	dGlossiness *= saturate(vVertexColor.{STD_GLOSS_VERTEX_CHANNEL});\n	#endif\n	#ifdef STD_GLOSS_INVERT\n	dGlossiness = 1.0 - dGlossiness;\n	#endif\n	dGlossiness += 0.0000001;\n}\n",gsplatCenterVS:"\nuniform mat4 matrix_model;\nuniform mat4 matrix_view;\nuniform mat4 matrix_projection;\nbool initCenter(vec3 modelCenter, out SplatCenter center) {\n	mat4 modelView = matrix_view * matrix_model;\n	vec4 centerView = modelView * vec4(modelCenter, 1.0);\n	if (centerView.z > 0.0) {\n		return false;\n	}\n	vec4 centerProj = matrix_projection * centerView;\n#if WEBGPU\n	centerProj.z = clamp(centerProj.z, 0, abs(centerProj.w));\n#else\n	centerProj.z = clamp(centerProj.z, -abs(centerProj.w), abs(centerProj.w));\n#endif\n	center.view = centerView.xyz / centerView.w;\n	center.proj = centerProj;\n	center.projMat00 = matrix_projection[0][0];\n	center.modelView = modelView;\n	return true;\n}\n",gsplatCornerVS:"\nuniform vec2 viewport;\nuniform vec4 camera_params;\nbool initCorner(SplatSource source, SplatCenter center, out SplatCorner corner) {\n	vec3 covA, covB;\n	readCovariance(source, covA, covB);\n	mat3 Vrk = mat3(\n		covA.x, covA.y, covA.z, \n		covA.y, covB.x, covB.y,\n		covA.z, covB.y, covB.z\n	);\n	float focal = viewport.x * center.projMat00;\n	vec3 v = camera_params.w == 1.0 ? vec3(0.0, 0.0, 1.0) : center.view.xyz;\n	float J1 = focal / v.z;\n	vec2 J2 = -J1 / v.z * v.xy;\n	mat3 J = mat3(\n		J1, 0.0, J2.x, \n		0.0, J1, J2.y, \n		0.0, 0.0, 0.0\n	);\n	mat3 W = transpose(mat3(center.modelView));\n	mat3 T = W * J;\n	mat3 cov = transpose(T) * Vrk * T;\n	#if GSPLAT_AA\n		float detOrig = cov[0][0] * cov[1][1] - cov[0][1] * cov[0][1];\n		float detBlur = (cov[0][0] + 0.3) * (cov[1][1] + 0.3) - cov[0][1] * cov[0][1];\n		corner.aaFactor = sqrt(max(detOrig / detBlur, 0.0));\n	#endif\n	float diagonal1 = cov[0][0] + 0.3;\n	float offDiagonal = cov[0][1];\n	float diagonal2 = cov[1][1] + 0.3;\n	float mid = 0.5 * (diagonal1 + diagonal2);\n	float radius = length(vec2((diagonal1 - diagonal2) / 2.0, offDiagonal));\n	float lambda1 = mid + radius;\n	float lambda2 = max(mid - radius, 0.1);\n	float l1 = 2.0 * min(sqrt(2.0 * lambda1), 1024.0);\n	float l2 = 2.0 * min(sqrt(2.0 * lambda2), 1024.0);\n	if (l1 < 2.0 && l2 < 2.0) {\n		return false;\n	}\n	vec2 c = center.proj.ww / viewport;\n	if (any(greaterThan(abs(center.proj.xy) - vec2(max(l1, l2)) * c, center.proj.ww))) {\n		return false;\n	}\n	vec2 diagonalVector = normalize(vec2(offDiagonal, lambda1 - diagonal1));\n	vec2 v1 = l1 * diagonalVector;\n	vec2 v2 = l2 * vec2(diagonalVector.y, -diagonalVector.x);\n	corner.offset = (source.cornerUV.x * v1 + source.cornerUV.y * v2) * c;\n	corner.uv = source.cornerUV;\n	return true;\n}\n",gsplatColorVS:"\nuniform mediump sampler2D splatColor;\nvec4 readColor(in SplatSource source) {\n	return texelFetch(splatColor, source.uv, 0);\n}\n",gsplatCommonVS:'\nstruct SplatSource {\n	uint order;\n	uint id;\n	ivec2 uv;\n	vec2 cornerUV;\n};\nstruct SplatCenter {\n	vec3 view;\n	vec4 proj;\n	mat4 modelView;\n	float projMat00;\n};\nstruct SplatCorner {\n	vec2 offset;\n	vec2 uv;\n	#if GSPLAT_AA\n		float aaFactor;\n	#endif\n};\n#if SH_BANDS > 0\n	#if SH_BANDS == 1\n		#define SH_COEFFS 3\n	#elif SH_BANDS == 2\n		#define SH_COEFFS 8\n	#elif SH_BANDS == 3\n		#define SH_COEFFS 15\n	#endif\n#endif\n#if GSPLAT_COMPRESSED_DATA == true\n	#include "gsplatCompressedDataVS"\n	#include "gsplatCompressedSHVS"\n#elif GSPLAT_SOGS_DATA == true\n	#include "gsplatSogsDataVS"\n	#include "gsplatSogsColorVS"\n	#include "gsplatSogsSHVS"\n#else\n	#include "gsplatDataVS"\n	#include "gsplatColorVS"\n	#include "gsplatSHVS"\n#endif\n#include "gsplatSourceVS"\n#include "gsplatCenterVS"\n#include "gsplatCornerVS"\n#include "gsplatOutputVS"\nvoid clipCorner(inout SplatCorner corner, float alpha) {\n	float clip = min(1.0, sqrt(-log(1.0 / 255.0 / alpha)) / 2.0);\n	corner.offset *= clip;\n	corner.uv *= clip;\n}\n#if SH_BANDS > 0\n#define SH_C1 0.4886025119029199f\n#if SH_BANDS > 1\n	#define SH_C2_0 1.0925484305920792f\n	#define SH_C2_1 -1.0925484305920792f\n	#define SH_C2_2 0.31539156525252005f\n	#define SH_C2_3 -1.0925484305920792f\n	#define SH_C2_4 0.5462742152960396f\n#endif\n#if SH_BANDS > 2\n	#define SH_C3_0 -0.5900435899266435f\n	#define SH_C3_1 2.890611442640554f\n	#define SH_C3_2 -0.4570457994644658f\n	#define SH_C3_3 0.3731763325901154f\n	#define SH_C3_4 -0.4570457994644658f\n	#define SH_C3_5 1.445305721320277f\n	#define SH_C3_6 -0.5900435899266435f\n#endif\nvec3 evalSH(in SplatSource source, in vec3 dir) {\n	vec3 sh[SH_COEFFS];\n	float scale;\n	readSHData(source, sh, scale);\n	float x = dir.x;\n	float y = dir.y;\n	float z = dir.z;\n	vec3 result = SH_C1 * (-sh[0] * y + sh[1] * z - sh[2] * x);\n#if SH_BANDS > 1\n	float xx = x * x;\n	float yy = y * y;\n	float zz = z * z;\n	float xy = x * y;\n	float yz = y * z;\n	float xz = x * z;\n	result +=\n		sh[3] * (SH_C2_0 * xy) *  +\n		sh[4] * (SH_C2_1 * yz) +\n		sh[5] * (SH_C2_2 * (2.0 * zz - xx - yy)) +\n		sh[6] * (SH_C2_3 * xz) +\n		sh[7] * (SH_C2_4 * (xx - yy));\n#endif\n#if SH_BANDS > 2\n	result +=\n		sh[8]  * (SH_C3_0 * y * (3.0 * xx - yy)) +\n		sh[9]  * (SH_C3_1 * xy * z) +\n		sh[10] * (SH_C3_2 * y * (4.0 * zz - xx - yy)) +\n		sh[11] * (SH_C3_3 * z * (2.0 * zz - 3.0 * xx - 3.0 * yy)) +\n		sh[12] * (SH_C3_4 * x * (4.0 * zz - xx - yy)) +\n		sh[13] * (SH_C3_5 * z * (xx - yy)) +\n		sh[14] * (SH_C3_6 * x * (xx - 3.0 * yy));\n#endif\n	return result * scale;\n}\n#endif\n',gsplatCompressedDataVS:"\nuniform highp usampler2D packedTexture;\nuniform highp sampler2D chunkTexture;\nvec4 chunkDataA;\nvec4 chunkDataB;\nvec4 chunkDataC;\nvec4 chunkDataD;\nvec4 chunkDataE;\nuvec4 packedData;\nvec3 unpack111011(uint bits) {\n	return vec3(\n		float(bits >> 21u) / 2047.0,\n		float((bits >> 11u) & 0x3ffu) / 1023.0,\n		float(bits & 0x7ffu) / 2047.0\n	);\n}\nvec4 unpack8888(uint bits) {\n	return vec4(\n		float(bits >> 24u) / 255.0,\n		float((bits >> 16u) & 0xffu) / 255.0,\n		float((bits >> 8u) & 0xffu) / 255.0,\n		float(bits & 0xffu) / 255.0\n	);\n}\nconst float norm = 1.0 / (sqrt(2.0) * 0.5);\nvec4 unpackRotation(uint bits) {\n	float a = (float((bits >> 20u) & 0x3ffu) / 1023.0 - 0.5) * norm;\n	float b = (float((bits >> 10u) & 0x3ffu) / 1023.0 - 0.5) * norm;\n	float c = (float(bits & 0x3ffu) / 1023.0 - 0.5) * norm;\n	float m = sqrt(1.0 - (a * a + b * b + c * c));\n	uint mode = bits >> 30u;\n	if (mode == 0u) return vec4(m, a, b, c);\n	if (mode == 1u) return vec4(a, m, b, c);\n	if (mode == 2u) return vec4(a, b, m, c);\n	return vec4(a, b, c, m);\n}\nmat3 quatToMat3(vec4 R) {\n	float x = R.x;\n	float y = R.y;\n	float z = R.z;\n	float w = R.w;\n	return mat3(\n		1.0 - 2.0 * (z * z + w * w),\n			  2.0 * (y * z + x * w),\n			  2.0 * (y * w - x * z),\n			  2.0 * (y * z - x * w),\n		1.0 - 2.0 * (y * y + w * w),\n			  2.0 * (z * w + x * y),\n			  2.0 * (y * w + x * z),\n			  2.0 * (z * w - x * y),\n		1.0 - 2.0 * (y * y + z * z)\n	);\n}\nvec3 readCenter(SplatSource source) {\n	uint w = uint(textureSize(chunkTexture, 0).x) / 5u;\n	uint chunkId = source.id / 256u;\n	ivec2 chunkUV = ivec2((chunkId % w) * 5u, chunkId / w);\n	chunkDataA = texelFetch(chunkTexture, chunkUV, 0);\n	chunkDataB = texelFetch(chunkTexture, chunkUV + ivec2(1, 0), 0);\n	chunkDataC = texelFetch(chunkTexture, chunkUV + ivec2(2, 0), 0);\n	chunkDataD = texelFetch(chunkTexture, chunkUV + ivec2(3, 0), 0);\n	chunkDataE = texelFetch(chunkTexture, chunkUV + ivec2(4, 0), 0);\n	packedData = texelFetch(packedTexture, source.uv, 0);\n	return mix(chunkDataA.xyz, vec3(chunkDataA.w, chunkDataB.xy), unpack111011(packedData.x));\n}\nvec4 readColor(in SplatSource source) {\n	vec4 r = unpack8888(packedData.w);\n	return vec4(mix(chunkDataD.xyz, vec3(chunkDataD.w, chunkDataE.xy), r.rgb), r.w);\n}\nvec4 getRotation() {\n	return unpackRotation(packedData.y);\n}\nvec3 getScale() {\n	return exp(mix(vec3(chunkDataB.zw, chunkDataC.x), chunkDataC.yzw, unpack111011(packedData.z)));\n}\nvoid readCovariance(in SplatSource source, out vec3 covA, out vec3 covB) {\n	mat3 rot = quatToMat3(getRotation());\n	vec3 scale = getScale();\n	mat3 M = transpose(mat3(\n		scale.x * rot[0],\n		scale.y * rot[1],\n		scale.z * rot[2]\n	));\n	covA = vec3(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));\n	covB = vec3(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));\n}\n",gsplatCompressedSHVS:"\n#if SH_BANDS > 0\nuniform highp usampler2D shTexture0;\nuniform highp usampler2D shTexture1;\nuniform highp usampler2D shTexture2;\nvec4 unpack8888s(in uint bits) {\n	return vec4((uvec4(bits) >> uvec4(0u, 8u, 16u, 24u)) & 0xffu) * (8.0 / 255.0) - 4.0;\n}\nvoid readSHData(in SplatSource source, out vec3 sh[15], out float scale) {\n	uvec4 shData0 = texelFetch(shTexture0, source.uv, 0);\n	uvec4 shData1 = texelFetch(shTexture1, source.uv, 0);\n	uvec4 shData2 = texelFetch(shTexture2, source.uv, 0);\n	vec4 r0 = unpack8888s(shData0.x);\n	vec4 r1 = unpack8888s(shData0.y);\n	vec4 r2 = unpack8888s(shData0.z);\n	vec4 r3 = unpack8888s(shData0.w);\n	vec4 g0 = unpack8888s(shData1.x);\n	vec4 g1 = unpack8888s(shData1.y);\n	vec4 g2 = unpack8888s(shData1.z);\n	vec4 g3 = unpack8888s(shData1.w);\n	vec4 b0 = unpack8888s(shData2.x);\n	vec4 b1 = unpack8888s(shData2.y);\n	vec4 b2 = unpack8888s(shData2.z);\n	vec4 b3 = unpack8888s(shData2.w);\n	sh[0] =  vec3(r0.x, g0.x, b0.x);\n	sh[1] =  vec3(r0.y, g0.y, b0.y);\n	sh[2] =  vec3(r0.z, g0.z, b0.z);\n	sh[3] =  vec3(r0.w, g0.w, b0.w);\n	sh[4] =  vec3(r1.x, g1.x, b1.x);\n	sh[5] =  vec3(r1.y, g1.y, b1.y);\n	sh[6] =  vec3(r1.z, g1.z, b1.z);\n	sh[7] =  vec3(r1.w, g1.w, b1.w);\n	sh[8] =  vec3(r2.x, g2.x, b2.x);\n	sh[9] =  vec3(r2.y, g2.y, b2.y);\n	sh[10] = vec3(r2.z, g2.z, b2.z);\n	sh[11] = vec3(r2.w, g2.w, b2.w);\n	sh[12] = vec3(r3.x, g3.x, b3.x);\n	sh[13] = vec3(r3.y, g3.y, b3.y);\n	sh[14] = vec3(r3.z, g3.z, b3.z);\n	scale = 1.0;\n}\n#endif\n",gsplatSogsColorVS:"\nuniform mediump sampler2D sh0;\nuniform mediump sampler2D opacities;\nuniform vec3 sh0_mins;\nuniform vec3 sh0_maxs;\nuniform float opacities_mins;\nuniform float opacities_maxs;\nfloat SH_C0 = 0.28209479177387814;\nvec4 readColor(in SplatSource source) {\n	vec3 clr = mix(sh0_mins, sh0_maxs, texelFetch(sh0, source.uv, 0).xyz);\n	float opacity = mix(opacities_mins, opacities_maxs, texelFetch(opacities, source.uv, 0).x);\n	return vec4(vec3(0.5) + clr * SH_C0, 1.0 / (1.0 + exp(opacity * -1.0)));\n}\n",gsplatSogsDataVS:"\nuniform highp sampler2D means_u;\nuniform highp sampler2D means_l;\nuniform highp sampler2D quats;\nuniform highp sampler2D scales;\nuniform vec3 means_mins;\nuniform vec3 means_maxs;\nuniform vec3 quats_mins;\nuniform vec3 quats_maxs;\nuniform vec3 scales_mins;\nuniform vec3 scales_maxs;\nvec3 readCenter(SplatSource source) {\n	vec3 u = texelFetch(means_u, source.uv, 0).xyz;\n	vec3 l = texelFetch(means_l, source.uv, 0).xyz;\n	vec3 n = (l * 255.0 + u * 255.0 * 256.0) / 65535.0;\n	vec3 v = mix(means_mins, means_maxs, n);\n	return sign(v) * (exp(abs(v)) - 1.0);\n}\nmat3 quatToMat3(vec3 R) {\n	float x = R.x;\n	float y = R.y;\n	float z = R.z;\n	float w2 = clamp(1.0 - (x*x + y*y + z*z), 0.0, 1.0);\n	float w  = sqrt(w2);\n	return mat3(\n		1.0 - 2.0 * (z * z + w2),\n			  2.0 * (y * z + x * w),\n			  2.0 * (y * w - x * z),\n			  2.0 * (y * z - x * w),\n		1.0 - 2.0 * (y * y + w2),\n			  2.0 * (z * w + x * y),\n			  2.0 * (y * w + x * z),\n			  2.0 * (z * w - x * y),\n		1.0 - 2.0 * (y * y + z * z)\n	);\n}\nvoid readCovariance(in SplatSource source, out vec3 covA, out vec3 covB) {\n	vec3 quat = mix(quats_mins, quats_maxs, texelFetch(quats, source.uv, 0).xyz);\n	mat3 rot = quatToMat3(quat);\n	vec3 scale = exp(mix(scales_mins, scales_maxs, texelFetch(scales, source.uv, 0).xyz));\n	mat3 M = transpose(mat3(\n		scale.x * rot[0],\n		scale.y * rot[1],\n		scale.z * rot[2]\n	));\n	covA = vec3(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));\n	covB = vec3(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));\n}\n",gsplatSogsSHVS:"\nuniform highp sampler2D sh_labels_u;\nuniform highp sampler2D sh_labels_l;\nuniform highp sampler2D sh_centroids;\nuniform float shN_mins;\nuniform float shN_maxs;\nvoid readSHData(in SplatSource source, out vec3 sh[15], out float scale) {\n	int tu = int(texelFetch(sh_labels_u, source.uv, 0).x * 255.0 * 256.0);\n	int tl = int(texelFetch(sh_labels_l, source.uv, 0).x * 255.0);\n	int n = tu + tl;\n	int u = (n % 64) * 15;\n	int v = n / 64;\n	for (int i = 0; i < 15; i++) {\n		sh[i] = mix(vec3(shN_mins), vec3(shN_maxs), texelFetch(sh_centroids, ivec2(u + i, v), 0).xyz);\n	}\n	scale = 1.0;\n}\n",gsplatDataVS:"\nuniform highp usampler2D transformA;\nuniform highp sampler2D transformB;\nuint tAw;\nvec3 readCenter(SplatSource source) {\n	uvec4 tA = texelFetch(transformA, source.uv, 0);\n	tAw = tA.w;\n	return uintBitsToFloat(tA.xyz);\n}\nmat3 quatToMat3(vec4 R) {\n	float x = R.w;\n	float y = R.x;\n	float z = R.y;\n	float w = R.z;\n	return mat3(\n		1.0 - 2.0 * (z * z + w * w),\n			  2.0 * (y * z + x * w),\n			  2.0 * (y * w - x * z),\n			  2.0 * (y * z - x * w),\n		1.0 - 2.0 * (y * y + w * w),\n			  2.0 * (z * w + x * y),\n			  2.0 * (y * w + x * z),\n			  2.0 * (z * w - x * y),\n		1.0 - 2.0 * (y * y + z * z)\n	);\n}\nvec4 unpackRotation(vec3 packed) {\n	return vec4(packed.xyz, sqrt(max(0.0, 1.0 - dot(packed, packed))));\n}\nvoid readCovariance(in SplatSource source, out vec3 covA, out vec3 covB) {\n	vec4 tB = texelFetch(transformB, source.uv, 0);\n	mat3 rot = quatToMat3(unpackRotation(vec3(unpackHalf2x16(tAw), tB.w)));\n	vec3 scale = tB.xyz;\n	\n	mat3 M = transpose(mat3(\n		scale.x * rot[0],\n		scale.y * rot[1],\n		scale.z * rot[2]\n	));\n	covA = vec3(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));\n	covB = vec3(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));\n}\n",gsplatOutputVS:'\n#include "tonemappingPS"\n#include "decodePS"\n#include "gammaPS"\nvec3 prepareOutputFromGamma(vec3 gammaColor) {\n	#if TONEMAP == NONE\n		#if GAMMA == NONE\n			return decodeGamma(gammaColor);\n		#else\n			return gammaColor;\n		#endif\n	#else\n		return gammaCorrectOutput(toneMap(decodeGamma(gammaColor)));\n	#endif\n}\n',gsplatPS:'\n#ifndef DITHER_NONE\n	#include "bayerPS"\n	#include "opacityDitherPS"\n	varying float id;\n#endif\n#ifdef PICK_PASS\n	#include "pickPS"\n#endif\n#if defined(SHADOW_PASS) || defined(PICK_PASS) || defined(PREPASS_PASS)\n	uniform float alphaClip;\n#endif\n#ifdef PREPASS_PASS\n	varying float vLinearDepth;\n	#include "floatAsUintPS"\n#endif\nvarying mediump vec2 gaussianUV;\nvarying mediump vec4 gaussianColor;\nvoid main(void) {\n	mediump float A = dot(gaussianUV, gaussianUV);\n	if (A > 1.0) {\n		discard;\n	}\n	mediump float alpha = exp(-A * 4.0) * gaussianColor.a;\n	#if defined(SHADOW_PASS) || defined(PICK_PASS) || defined(PREPASS_PASS)\n		if (alpha < alphaClip) {\n			discard;\n		}\n	#endif\n	#ifdef PICK_PASS\n		gl_FragColor = getPickOutput();\n	#elif SHADOW_PASS\n		gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n	#elif PREPASS_PASS\n		gl_FragColor = float2vec4(vLinearDepth);\n	#else\n		if (alpha < 1.0 / 255.0) {\n			discard;\n		}\n		#ifndef DITHER_NONE\n			opacityDither(alpha, id * 0.013);\n		#endif\n		gl_FragColor = vec4(gaussianColor.xyz * alpha, alpha);\n	#endif\n}\n',gsplatSHVS:"\n#if SH_BANDS > 0\nvec3 unpack111011s(uint bits) {\n	return vec3((uvec3(bits) >> uvec3(21u, 11u, 0u)) & uvec3(0x7ffu, 0x3ffu, 0x7ffu)) / vec3(2047.0, 1023.0, 2047.0) * 2.0 - 1.0;\n}\nvoid fetchScale(in uvec4 t, out float scale, out vec3 a, out vec3 b, out vec3 c) {\n	scale = uintBitsToFloat(t.x);\n	a = unpack111011s(t.y);\n	b = unpack111011s(t.z);\n	c = unpack111011s(t.w);\n}\nvoid fetch(in uvec4 t, out vec3 a, out vec3 b, out vec3 c, out vec3 d) {\n	a = unpack111011s(t.x);\n	b = unpack111011s(t.y);\n	c = unpack111011s(t.z);\n	d = unpack111011s(t.w);\n}\nvoid fetch(in uint t, out vec3 a) {\n	a = unpack111011s(t);\n}\n#if SH_BANDS == 1\n	uniform highp usampler2D splatSH_1to3;\n	void readSHData(in SplatSource source, out vec3 sh[3], out float scale) {\n		fetchScale(texelFetch(splatSH_1to3, source.uv, 0), scale, sh[0], sh[1], sh[2]);\n	}\n#elif SH_BANDS == 2\n	uniform highp usampler2D splatSH_1to3;\n	uniform highp usampler2D splatSH_4to7;\n	uniform highp usampler2D splatSH_8to11;\n	void readSHData(in SplatSource source, out vec3 sh[8], out float scale) {\n		fetchScale(texelFetch(splatSH_1to3, source.uv, 0), scale, sh[0], sh[1], sh[2]);\n		fetch(texelFetch(splatSH_4to7, source.uv, 0), sh[3], sh[4], sh[5], sh[6]);\n		fetch(texelFetch(splatSH_8to11, source.uv, 0).x, sh[7]);\n	}\n#else\n	uniform highp usampler2D splatSH_1to3;\n	uniform highp usampler2D splatSH_4to7;\n	uniform highp usampler2D splatSH_8to11;\n	uniform highp usampler2D splatSH_12to15;\n	void readSHData(in SplatSource source, out vec3 sh[15], out float scale) {\n		fetchScale(texelFetch(splatSH_1to3, source.uv, 0), scale, sh[0], sh[1], sh[2]);\n		fetch(texelFetch(splatSH_4to7, source.uv, 0), sh[3], sh[4], sh[5], sh[6]);\n		fetch(texelFetch(splatSH_8to11, source.uv, 0), sh[7], sh[8], sh[9], sh[10]);\n		fetch(texelFetch(splatSH_12to15, source.uv, 0), sh[11], sh[12], sh[13], sh[14]);\n	}\n#endif\n#endif\n",gsplatSourceVS:"\nattribute vec3 vertex_position;\nattribute uint vertex_id_attrib;\nuniform uint numSplats;\nuniform highp usampler2D splatOrder;\nbool initSource(out SplatSource source) {\n	uint w = uint(textureSize(splatOrder, 0).x);\n	source.order = vertex_id_attrib + uint(vertex_position.z);\n	if (source.order >= numSplats) {\n		return false;\n	}\n	ivec2 orderUV = ivec2(source.order % w, source.order / w);\n	source.id = texelFetch(splatOrder, orderUV, 0).r;\n	source.uv = ivec2(source.id % w, source.id / w);\n	source.cornerUV = vertex_position.xy;\n	return true;\n}\n",gsplatVS:'\n#include "gsplatCommonVS"\nvarying mediump vec2 gaussianUV;\nvarying mediump vec4 gaussianColor;\n#ifndef DITHER_NONE\n	varying float id;\n#endif\nmediump vec4 discardVec = vec4(0.0, 0.0, 2.0, 1.0);\n#ifdef PREPASS_PASS\n	varying float vLinearDepth;\n#endif\nvoid main(void) {\n	SplatSource source;\n	if (!initSource(source)) {\n		gl_Position = discardVec;\n		return;\n	}\n	vec3 modelCenter = readCenter(source);\n	SplatCenter center;\n	if (!initCenter(modelCenter, center)) {\n		gl_Position = discardVec;\n		return;\n	}\n	SplatCorner corner;\n	if (!initCorner(source, center, corner)) {\n		gl_Position = discardVec;\n		return;\n	}\n	vec4 clr = readColor(source);\n	#if GSPLAT_AA\n		clr.a *= corner.aaFactor;\n	#endif\n	#if SH_BANDS > 0\n		vec3 dir = normalize(center.view * mat3(center.modelView));\n		clr.xyz += evalSH(source, dir);\n	#endif\n	clipCorner(corner, clr.w);\n	gl_Position = center.proj + vec4(corner.offset, 0, 0);\n	gaussianUV = corner.uv;\n	gaussianColor = vec4(prepareOutputFromGamma(max(clr.xyz, 0.0)), clr.w);\n	#ifndef DITHER_NONE\n		id = float(source.id);\n	#endif\n	#ifdef PREPASS_PASS\n		vLinearDepth = -center.view.z;\n	#endif\n}\n',immediateLinePS:'\n		#include "gammaPS"\n		varying vec4 color;\n		void main(void) {\n			gl_FragColor = vec4(gammaCorrectOutput(decodeGamma(color.rgb)), color.a);\n		}\n',immediateLineVS:"\n	attribute vec4 vertex_position;\n	attribute vec4 vertex_color;\n	uniform mat4 matrix_model;\n	uniform mat4 matrix_viewProjection;\n	varying vec4 color;\n	void main(void) {\n		color = vertex_color;\n		gl_Position = matrix_viewProjection * matrix_model * vertex_position;\n	}\n",iridescenceDiffractionPS:"\nuniform float material_iridescenceRefractionIndex;\n#ifndef PI\n#define PI 3.14159265\n#endif\nfloat iridescence_iorToFresnel(float transmittedIor, float incidentIor) {\n	return pow((transmittedIor - incidentIor) / (transmittedIor + incidentIor), 2.0);\n}\nvec3 iridescence_iorToFresnel(vec3 transmittedIor, float incidentIor) {\n	return pow((transmittedIor - vec3(incidentIor)) / (transmittedIor + vec3(incidentIor)), vec3(2.0));\n}\nvec3 iridescence_fresnelToIor(vec3 f0) {\n	vec3 sqrtF0 = sqrt(f0);\n	return (vec3(1.0) + sqrtF0) / (vec3(1.0) - sqrtF0);\n}\nvec3 iridescence_sensitivity(float opd, vec3 shift) {\n	float phase = 2.0 * PI * opd * 1.0e-9;\n	const vec3 val = vec3(5.4856e-13, 4.4201e-13, 5.2481e-13);\n	const vec3 pos = vec3(1.6810e+06, 1.7953e+06, 2.2084e+06);\n	const vec3 var = vec3(4.3278e+09, 9.3046e+09, 6.6121e+09);\n	vec3 xyz = val * sqrt(2.0 * PI * var) * cos(pos * phase + shift) * exp(-pow(phase, 2.0) * var);\n	xyz.x += 9.7470e-14 * sqrt(2.0 * PI * 4.5282e+09) * cos(2.2399e+06 * phase + shift[0]) * exp(-4.5282e+09 * pow(phase, 2.0));\n	xyz /= vec3(1.0685e-07);\n	const mat3 XYZ_TO_REC709 = mat3(\n		3.2404542, -0.9692660,  0.0556434,\n	   -1.5371385,  1.8760108, -0.2040259,\n	   -0.4985314,  0.0415560,  1.0572252\n	);\n	return XYZ_TO_REC709 * xyz;\n}\nfloat iridescence_fresnel(float cosTheta, float f0) {\n	float x = clamp(1.0 - cosTheta, 0.0, 1.0);\n	float x2 = x * x;\n	float x5 = x * x2 * x2;\n	return f0 + (1.0 - f0) * x5;\n} \nvec3 iridescence_fresnel(float cosTheta, vec3 f0) {\n	float x = clamp(1.0 - cosTheta, 0.0, 1.0);\n	float x2 = x * x;\n	float x5 = x * x2 * x2; \n	return f0 + (vec3(1.0) - f0) * x5;\n}\nvec3 calcIridescence(float outsideIor, float cosTheta, vec3 base_f0, float iridescenceThickness) {\n	float iridescenceIor = mix(outsideIor, material_iridescenceRefractionIndex, smoothstep(0.0, 0.03, iridescenceThickness));\n	float sinTheta2Sq = pow(outsideIor / iridescenceIor, 2.0) * (1.0 - pow(cosTheta, 2.0));\n	float cosTheta2Sq = 1.0 - sinTheta2Sq;\n	if (cosTheta2Sq < 0.0) {\n		return vec3(1.0);\n	}\n	float cosTheta2 = sqrt(cosTheta2Sq);\n	float r0 = iridescence_iorToFresnel(iridescenceIor, outsideIor);\n	float r12 = iridescence_fresnel(cosTheta, r0);\n	float r21 = r12;\n	float t121 = 1.0 - r12;\n	float phi12 = iridescenceIor < outsideIor ? PI : 0.0;\n	float phi21 = PI - phi12;\n	vec3 baseIor = iridescence_fresnelToIor(base_f0 + vec3(0.0001));\n	vec3 r1 = iridescence_iorToFresnel(baseIor, iridescenceIor);\n	vec3 r23 = iridescence_fresnel(cosTheta2, r1);\n	vec3 phi23 = vec3(0.0);\n	if (baseIor[0] < iridescenceIor) phi23[0] = PI;\n	if (baseIor[1] < iridescenceIor) phi23[1] = PI;\n	if (baseIor[2] < iridescenceIor) phi23[2] = PI;\n	float opd = 2.0 * iridescenceIor * iridescenceThickness * cosTheta2;\n	vec3 phi = vec3(phi21) + phi23; \n	vec3 r123Sq = clamp(r12 * r23, 1e-5, 0.9999);\n	vec3 r123 = sqrt(r123Sq);\n	vec3 rs = pow(t121, 2.0) * r23 / (1.0 - r123Sq);\n	vec3 c0 = r12 + rs;\n	vec3 i = c0;\n	vec3 cm = rs - t121;\n	for (int m = 1; m <= 2; m++) {\n		cm *= r123;\n		vec3 sm = 2.0 * iridescence_sensitivity(float(m) * opd, float(m) * phi);\n		i += cm * sm;\n	}\n	return max(i, vec3(0.0));\n}\nvec3 getIridescence(float cosTheta, vec3 specularity, float iridescenceThickness) {\n	return calcIridescence(1.0, cosTheta, specularity, iridescenceThickness);\n}\n",iridescencePS:"\n#ifdef STD_IRIDESCENCE_CONSTANT\nuniform float material_iridescence;\n#endif\nvoid getIridescence() {\n	float iridescence = 1.0;\n	#ifdef STD_IRIDESCENCE_CONSTANT\n	iridescence *= material_iridescence;\n	#endif\n	#ifdef STD_IRIDESCENCE_TEXTURE\n	iridescence *= texture2DBias({STD_IRIDESCENCE_TEXTURE_NAME}, {STD_IRIDESCENCE_TEXTURE_UV}, textureBias).{STD_IRIDESCENCE_TEXTURE_CHANNEL};\n	#endif\n	dIridescence = iridescence; \n}\n",iridescenceThicknessPS:"\nuniform float material_iridescenceThicknessMax;\n#ifdef STD_IRIDESCENCETHICKNESS_TEXTURE\nuniform float material_iridescenceThicknessMin;\n#endif\nvoid getIridescenceThickness() {\n	#ifdef STD_IRIDESCENCETHICKNESS_TEXTURE\n		float blend = texture2DBias({STD_IRIDESCENCETHICKNESS_TEXTURE_NAME}, {STD_IRIDESCENCETHICKNESS_TEXTURE_UV}, textureBias).{STD_IRIDESCENCETHICKNESS_TEXTURE_CHANNEL};\n		float iridescenceThickness = mix(material_iridescenceThicknessMin, material_iridescenceThicknessMax, blend);\n	#else\n		float iridescenceThickness = material_iridescenceThicknessMax;\n	#endif\n	dIridescenceThickness = iridescenceThickness; \n}\n",iorPS:"\n#ifdef STD_IOR_CONSTANT\nuniform float material_refractionIndex;\n#endif\nvoid getIor() {\n#ifdef STD_IOR_CONSTANT\n	dIor = material_refractionIndex;\n#else\n	dIor = 1.0 / 1.5;\n#endif\n}\n",lightBufferDefinesPS:"",lightDeclarationPS:"\n#if defined(LIGHT{i})\n	uniform vec3 light{i}_color;\n	#if LIGHT{i}TYPE == DIRECTIONAL\n		uniform vec3 light{i}_direction;\n	#else\n		#define LIT_CODE_LIGHTS_POINT\n		uniform vec3 light{i}_position;\n		uniform float light{i}_radius;\n		#if LIGHT{i}TYPE == SPOT\n			#define LIT_CODE_LIGHTS_SPOT\n			uniform vec3 light{i}_direction;\n			uniform float light{i}_innerConeAngle;\n			uniform float light{i}_outerConeAngle;\n		#endif\n	#endif\n	#if LIGHT{i}SHAPE != PUNCTUAL\n		#define LIT_CODE_FALLOFF_SQUARED\n		#if LIGHT{i}TYPE == DIRECTIONAL\n			uniform vec3 light{i}_position;\n		#endif\n		uniform vec3 light{i}_halfWidth;\n		uniform vec3 light{i}_halfHeight;\n	#else\n		#if LIGHT{i}FALLOFF == LINEAR\n			#define LIT_CODE_FALLOFF_LINEAR\n		#endif\n		#if LIGHT{i}FALLOFF == INVERSESQUARED\n			#define LIT_CODE_FALLOFF_SQUARED\n		#endif\n	#endif\n	#if defined(LIGHT{i}CASTSHADOW)\n		uniform mat4 light{i}_shadowMatrix;\n		uniform float light{i}_shadowIntensity;\n		uniform vec4 light{i}_shadowParams;\n		#if LIGHT{i}SHADOWTYPE == PCSS_32F\n			uniform float light{i}_shadowSearchArea;\n			uniform vec4 light{i}_cameraParams;\n			#if LIGHT{i}TYPE == DIRECTIONAL\n				uniform vec4 light{i}_softShadowParams;\n			#endif\n		#endif\n		#if LIGHT{i}TYPE == DIRECTIONAL\n			uniform mat4 light{i}_shadowMatrixPalette[4];\n			uniform vec4 light{i}_shadowCascadeDistances;\n			uniform int light{i}_shadowCascadeCount;\n			uniform float light{i}_shadowCascadeBlend;\n		#endif\n		#if LIGHT{i}TYPE == OMNI\n			#if defined(LIGHT{i}SHADOW_PCF)\n				uniform samplerCubeShadow light{i}_shadowMap;\n			#else\n				uniform samplerCube light{i}_shadowMap;\n			#endif\n		#else\n			#if defined(LIGHT{i}SHADOW_PCF)\n				uniform sampler2DShadow light{i}_shadowMap;\n			#else\n				uniform sampler2D light{i}_shadowMap;\n			#endif\n		#endif\n	#endif\n	#if defined(LIGHT{i}COOKIE)\n		#define LIT_CODE_COOKIE\n		#if LIGHT{i}TYPE == OMNI\n			uniform samplerCube light{i}_cookie;\n			uniform float light{i}_cookieIntensity;\n			#if !defined(LIGHT{i}CASTSHADOW)\n				uniform mat4 light{i}_shadowMatrix;\n			#endif\n		#endif\n		#if LIGHT{i}TYPE == SPOT\n			uniform sampler2D light{i}_cookie;\n			uniform float light{i}_cookieIntensity;\n			#if !defined(LIGHT{i}CASTSHADOW)\n				uniform mat4 light{i}_shadowMatrix;\n			#endif\n			#if defined(LIGHT{i}COOKIE_TRANSFORM)\n				uniform vec4 light{i}_cookieMatrix;\n				uniform vec2 light{i}_cookieOffset;\n			#endif\n		#endif\n	#endif\n#endif\n",lightDiffuseLambertPS:"\nfloat getLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm) {\n	return max(dot(worldNormal, -lightDirNorm), 0.0);\n}\n",lightDirPointPS:"\nvoid evalOmniLight(vec3 lightPosW, out vec3 lightDirW, out vec3 lightDirNormW) {\n	lightDirW = vPositionW - lightPosW;\n	lightDirNormW = normalize(lightDirW);\n}\n",lightEvaluationPS:"\n#if defined(LIGHT{i})\n	evaluateLight{i}(\n		#if defined(LIT_IRIDESCENCE)\n			iridescenceFresnel\n		#endif\n	);\n#endif\n",lightFunctionLightPS:"\n#if defined(LIGHT{i})\nvoid evaluateLight{i}(\n	#if defined(LIT_IRIDESCENCE)\n		vec3 iridescenceFresnel\n	#endif\n) {\n	vec3 lightColor = light{i}_color;\n	#if LIGHT{i}TYPE == DIRECTIONAL && !defined(LIT_SHADOW_CATCHER)\n		if (all(equal(lightColor, vec3(0.0)))) {\n			return;\n		}\n	#endif\n	#if LIGHT{i}TYPE == DIRECTIONAL\n		dLightDirNormW = light{i}_direction;\n		dAtten = 1.0;\n	#else\n		\n		vec3 lightDirW;\n		evalOmniLight(light{i}_position, lightDirW, dLightDirNormW);\n		#if defined(LIGHT{i}COOKIE)\n			#if LIGHT{i}TYPE == SPOT\n				#ifdef LIGHT{i}COOKIE_FALLOFF\n					#ifdef LIGHT{i}COOKIE_TRANSFORM\n						vec3 cookieAttenuation = getCookie2DXform(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity, light{i}_cookieMatrix, light{i}_cookieOffset).{LIGHT{i}COOKIE_CHANNEL};\n					#else\n						vec3 cookieAttenuation = getCookie2D(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};\n					#endif\n				#else\n					#ifdef LIGHT{i}COOKIE_TRANSFORM\n						vec3 cookieAttenuation = getCookie2DClipXform(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity, light{i}_cookieMatrix, light{i}_cookieOffset).{LIGHT{i}COOKIE_CHANNEL};\n					#else\n						vec3 cookieAttenuation = getCookie2DClip(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};\n					#endif\n				#endif\n			#endif\n			#if LIGHT{i}TYPE == OMNI\n				vec3 cookieAttenuation = getCookieCube(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};\n			#endif\n			lightColor *= cookieAttenuation;\n		#endif\n		#if LIGHT{i}SHAPE == PUNCTUAL\n			#if LIGHT{i}FALLOFF == LINEAR\n				dAtten = getFalloffLinear(light{i}_radius, lightDirW);\n			#else\n				dAtten = getFalloffInvSquared(light{i}_radius, lightDirW);\n			#endif\n		#else\n			dAtten = getFalloffWindow(light{i}_radius, lightDirW);\n		#endif\n		#if LIGHT{i}TYPE == SPOT\n			#if !defined(LIGHT{i}COOKIE) || defined(LIGHT{i}COOKIE_FALLOFF)\n				dAtten *= getSpotEffect(light{i}_direction, light{i}_innerConeAngle, light{i}_outerConeAngle, dLightDirNormW);\n			#endif\n		#endif\n	#endif\n	if (dAtten < 0.00001) {\n		return;\n	}\n	#if LIGHT{i}SHAPE != PUNCTUAL\n		#if LIGHT{i}SHAPE == RECT\n			calcRectLightValues(light{i}_position, light{i}_halfWidth, light{i}_halfHeight);\n		#elif LIGHT{i}SHAPE == DISK\n			calcDiskLightValues(light{i}_position, light{i}_halfWidth, light{i}_halfHeight);\n		#elif LIGHT{i}SHAPE == SPHERE\n			calcSphereLightValues(light{i}_position, light{i}_halfWidth, light{i}_halfHeight);\n		#endif\n	#endif\n	#if LIGHT{i}SHAPE != PUNCTUAL\n		#if LIGHT{i}TYPE == DIRECTIONAL\n			float attenDiffuse = getLightDiffuse(litArgs_worldNormal, dViewDirW, dLightDirNormW);\n		#else\n			#if LIGHT{i}SHAPE == RECT\n				float attenDiffuse = getRectLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;\n			#elif LIGHT{i}SHAPE == DISK\n				float attenDiffuse = getDiskLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;\n			#elif LIGHT{i}SHAPE == SPHERE\n				float attenDiffuse = getSphereLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;\n			#endif\n		#endif\n	#else\n		dAtten *= getLightDiffuse(litArgs_worldNormal, vec3(0.0), dLightDirNormW);\n	#endif\n	#ifdef LIGHT{i}CASTSHADOW\n		#if LIGHT{i}TYPE == DIRECTIONAL\n			float shadow = getShadow{i}(vec3(0.0));\n		#else\n			float shadow = getShadow{i}(lightDirW);\n		#endif\n		shadow = mix(1.0, shadow, light{i}_shadowIntensity);\n		dAtten *= shadow;\n		#if defined(LIT_SHADOW_CATCHER) && LIGHT{i}TYPE == DIRECTIONAL\n			dShadowCatcher *= shadow;\n		#endif			\n	#endif\n	#if LIGHT{i}SHAPE != PUNCTUAL\n		#ifdef LIT_SPECULAR\n			dDiffuseLight += ((attenDiffuse * dAtten) * lightColor) * (1.0 - dLTCSpecFres);\n		#else\n			dDiffuseLight += (attenDiffuse * dAtten) * lightColor;\n		#endif						\n	#else\n		#if defined(AREA_LIGHTS) && defined(LIT_SPECULAR)\n			dDiffuseLight += (dAtten * lightColor) * (1.0 - litArgs_specularity);\n		#else\n			dDiffuseLight += dAtten * lightColor;\n		#endif\n	#endif\n	#ifdef LIGHT{i}AFFECT_SPECULARITY\n		#if LIGHT{i}SHAPE != PUNCTUAL\n			#ifdef LIT_CLEARCOAT\n				#if LIGHT{i}SHAPE == RECT\n					ccSpecularLight += ccLTCSpecFres * getRectLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor;\n				#elif LIGHT{i}SHAPE == DISK\n					ccSpecularLight += ccLTCSpecFres * getDiskLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor;\n				#elif LIGHT{i}SHAPE == SPHERE\n					ccSpecularLight += ccLTCSpecFres * getSphereLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor;\n				#endif\n			#endif\n			#ifdef LIT_SPECULAR\n				#if LIGHT{i}SHAPE == RECT\n					dSpecularLight += dLTCSpecFres * getRectLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor;\n				#elif LIGHT{i}SHAPE == DISK\n					dSpecularLight += dLTCSpecFres * getDiskLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor;\n				#elif LIGHT{i}SHAPE == SPHERE\n					dSpecularLight += dLTCSpecFres * getSphereLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor;\n				#endif\n			#endif\n		#else\n			#if LIGHT{i}TYPE == DIRECTIONAL && LIT_FRESNEL_MODEL != NONE\n				#define LIGHT{i}FRESNEL\n			#endif\n			#ifdef LIT_SPECULAR\n				vec3 halfDirW = normalize(-dLightDirNormW + dViewDirW);\n			#endif\n			#ifdef LIT_CLEARCOAT\n				vec3 lightspecularCC = getLightSpecular(halfDirW, ccReflDirW, litArgs_clearcoat_worldNormal, dViewDirW, dLightDirNormW, litArgs_clearcoat_gloss, dTBN) * dAtten * lightColor;\n				#ifdef LIGHT{i}FRESNEL\n					lightspecularCC *= getFresnelCC(dot(dViewDirW, halfDirW));\n				#endif\n				ccSpecularLight += lightspecularCC;\n			#endif\n			#ifdef LIT_SHEEN\n				sSpecularLight += getLightSpecularSheen(halfDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_sheen_gloss) * dAtten * lightColor;\n			#endif\n			#ifdef LIT_SPECULAR\n				vec3 lightSpecular = getLightSpecular(halfDirW, dReflDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_gloss, dTBN) * dAtten * lightColor;\n				#ifdef LIGHT{i}FRESNEL\n					#if defined(LIT_IRIDESCENCE)\n						lightSpecular *= getFresnel(dot(dViewDirW, halfDirW), litArgs_gloss, litArgs_specularity, iridescenceFresnel, litArgs_iridescence_intensity);\n					#else\n						lightSpecular *= getFresnel(dot(dViewDirW, halfDirW), litArgs_gloss, litArgs_specularity);\n					#endif\n				#else\n					lightSpecular *= litArgs_specularity;\n				#endif\n				\n				dSpecularLight += lightSpecular;\n			#endif\n		#endif\n	#endif\n}\n#endif\n",lightFunctionShadowPS:"\n#ifdef LIGHT{i}CASTSHADOW\n	vec3 getShadowSampleCoord{i}(mat4 shadowTransform, vec4 shadowParams, vec3 worldPosition, vec3 lightPos, inout vec3 lightDir, vec3 lightDirNorm, vec3 normal) {\n		vec3 surfacePosition = worldPosition;\n		#ifdef LIGHT{i}_SHADOW_SAMPLE_POINT\n			#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET\n				float distScale = length(lightDir);\n				surfacePosition = surfacePosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;\n				lightDir = surfacePosition - lightPos;\n				return lightDir;\n			#endif\n		#else\n			#ifdef LIGHT{i}_SHADOW_SAMPLE_SOURCE_ZBUFFER\n				#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET\n					surfacePosition = surfacePosition + normal * shadowParams.y;\n				#endif\n			#else\n				#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET\n					#ifdef LIGHT{i}_SHADOW_SAMPLE_ORTHO\n						float distScale = 1.0;\n					#else\n						float distScale = abs(dot(vPositionW - lightPos, lightDirNorm));\n					#endif\n					surfacePosition = surfacePosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;\n				#endif\n			#endif\n			vec4 positionInShadowSpace = shadowTransform * vec4(surfacePosition, 1.0);\n			#ifdef LIGHT{i}_SHADOW_SAMPLE_ORTHO\n				positionInShadowSpace.z = saturate(positionInShadowSpace.z) - 0.0001;\n			#else\n				#ifdef LIGHT{i}_SHADOW_SAMPLE_SOURCE_ZBUFFER\n					positionInShadowSpace.xyz /= positionInShadowSpace.w;\n				#else\n					positionInShadowSpace.xy /= positionInShadowSpace.w;\n					positionInShadowSpace.z = length(lightDir) * shadowParams.w;\n				#endif\n			#endif\n			surfacePosition = positionInShadowSpace.xyz;\n		#endif\n		return surfacePosition;\n	}\n	float getShadow{i}(vec3 lightDirW) {\n		#ifdef LIGHT{i}_SHADOW_CASCADES\n			int cascadeIndex = getShadowCascadeIndex(light{i}_shadowCascadeDistances, light{i}_shadowCascadeCount);\n			#ifdef LIGHT{i}_SHADOW_CASCADE_BLEND\n				cascadeIndex = ditherShadowCascadeIndex(cascadeIndex, light{i}_shadowCascadeDistances, light{i}_shadowCascadeCount, light{i}_shadowCascadeBlend);\n			#endif\n			mat4 shadowMatrix = light{i}_shadowMatrixPalette[cascadeIndex];\n		#else\n			mat4 shadowMatrix = light{i}_shadowMatrix;\n		#endif\n		#if LIGHT{i}TYPE == DIRECTIONAL\n			vec3 shadowCoord = getShadowSampleCoord{i}(shadowMatrix, light{i}_shadowParams, vPositionW, vec3(0.0), lightDirW, dLightDirNormW, dVertexNormalW);\n		#else\n			vec3 shadowCoord = getShadowSampleCoord{i}(shadowMatrix, light{i}_shadowParams, vPositionW, light{i}_position, lightDirW, dLightDirNormW, dVertexNormalW);\n		#endif\n		#if LIGHT{i}TYPE == DIRECTIONAL\n			shadowCoord = fadeShadow(shadowCoord, light{i}_shadowCascadeDistances);\n		#endif\n		#if LIGHT{i}TYPE == DIRECTIONAL\n			#if LIGHT{i}SHADOWTYPE == VSM_16F\n				return getShadowVSM16(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, 5.54);\n			#endif\n			#if LIGHT{i}SHADOWTYPE == VSM_32F\n				return getShadowVSM32(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, 15.0);\n			#endif\n			#if LIGHT{i}SHADOWTYPE == PCSS_32F\n				#if LIGHT{i}SHAPE != PUNCTUAL\n					vec2 shadowSearchArea = vec2(length(light{i}_halfWidth), length(light{i}_halfHeight)) * light{i}_shadowSearchArea;\n					return getShadowPCSS(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, light{i}_cameraParams, shadowSearchArea, lightDirW);\n				#else\n					return getShadowPCSS(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, light{i}_cameraParams, light{i}_softShadowParams, lightDirW);\n				#endif\n			#endif\n			#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F\n				return getShadowPCF1x1(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);\n			#endif\n			#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F\n				return getShadowPCF3x3(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);\n			#endif\n			#if LIGHT{i}SHADOWTYPE == PCF5_16F || LIGHT{i}SHADOWTYPE == PCF5_32F\n				return getShadowPCF5x5(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);\n			#endif\n		#endif\n		#if LIGHT{i}TYPE == SPOT\n			#if LIGHT{i}SHADOWTYPE == VSM_16F\n				return getShadowSpotVSM16(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, 5.54, lightDirW);\n			#endif\n			#if LIGHT{i}SHADOWTYPE == VSM_32F\n				return getShadowSpotVSM32(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, 15.0, lightDirW);\n			#endif\n			#if LIGHT{i}SHADOWTYPE == PCSS_32F\n				#if LIGHT{i}SHAPE != PUNCTUAL\n					vec2 shadowSearchArea = vec2(length(light{i}_halfWidth), length(light{i}_halfHeight)) * light{i}_shadowSearchArea;\n				#else\n					vec2 shadowSearchArea = vec2(light{i}_shadowSearchArea);\n				#endif\n				return getShadowSpotPCSS(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, light{i}_cameraParams, shadowSearchArea, lightDirW);\n			#endif\n			#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F\n				return getShadowSpotPCF1x1(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);\n			#endif\n			#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F\n				return getShadowSpotPCF3x3(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);\n			#endif\n			#if LIGHT{i}SHADOWTYPE == PCF5_16F || LIGHT{i}SHADOWTYPE == PCF5_32F\n				return getShadowSpotPCF5x5(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);\n			#endif\n		#endif\n		#if LIGHT{i}TYPE == OMNI\n			#if LIGHT{i}SHADOWTYPE == PCSS_32F\n				#if LIGHT{i}SHAPE != PUNCTUAL\n					vec2 shadowSearchArea = vec2(length(light{i}_halfWidth), length(light{i}_halfHeight)) * light{i}_shadowSearchArea;\n				#else\n					vec2 shadowSearchArea = vec2(light{i}_shadowSearchArea);\n				#endif\n				return getShadowOmniPCSS(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, light{i}_cameraParams, shadowSearchArea, lightDirW);\n			#endif\n			#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F\n				return getShadowOmniPCF1x1(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, lightDirW);\n			#endif\n			#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F\n				return getShadowOmniPCF3x3(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, lightDirW);\n			#endif\n		#endif\n	}\n#endif\n",lightingPS:'\n#ifdef LIT_CLUSTERED_LIGHTS\n	#define LIT_CODE_FALLOFF_LINEAR\n	#define LIT_CODE_FALLOFF_SQUARED\n	#define LIT_CODE_LIGHTS_POINT\n	#define LIT_CODE_LIGHTS_SPOT\n#endif\n#ifdef AREA_LIGHTS\n	uniform highp sampler2D areaLightsLutTex1;\n	uniform highp sampler2D areaLightsLutTex2;\n#endif\n#ifdef LIT_LIGHTING\n	#include "lightDiffuseLambertPS"\n	#if defined(AREA_LIGHTS) || defined(LIT_CLUSTERED_AREA_LIGHTS)\n		#include "ltcPS"\n	#endif\n#endif\n#ifdef SHADOW_DIRECTIONAL\n	#include "shadowCascadesPS"\n#endif\n#if defined(SHADOW_KIND_PCF1)\n	#include "shadowPCF1PS"\n#endif\n#if defined(SHADOW_KIND_PCF3)\n	#include "shadowPCF3PS"\n#endif\n#if defined(SHADOW_KIND_PCF5)\n	#include "shadowPCF5PS"\n#endif\n#if defined(SHADOW_KIND_PCSS)\n	#include "linearizeDepthPS"\n	#include "shadowPCSSPS"\n	#include "shadowSoftPS"\n#endif\n#if defined(SHADOW_KIND_VSM)\n	#include "shadowEVSMPS"\n#endif\n#ifdef LIT_CODE_FALLOFF_LINEAR\n	#include "falloffLinearPS"\n#endif\n#ifdef LIT_CODE_FALLOFF_SQUARED\n	#include "falloffInvSquaredPS"\n#endif\n#ifdef LIT_CODE_LIGHTS_POINT\n	#include "lightDirPointPS"\n#endif\n#ifdef LIT_CODE_LIGHTS_SPOT\n	#include "spotPS"\n#endif\n#ifdef LIT_CODE_COOKIE\n	#include "cookiePS"\n#endif\n#ifdef LIT_CLUSTERED_LIGHTS\n	#include "clusteredLightPS"\n#endif\n#ifdef LIGHT_COUNT > 0\n	#include "lightFunctionShadowPS, LIGHT_COUNT"\n	#include "lightFunctionLightPS, LIGHT_COUNT"\n#endif\n',lightmapAddPS:"\nvoid addLightMap(\n	vec3 lightmap, \n	vec3 dir, \n	vec3 worldNormal, \n	vec3 viewDir, \n	vec3 reflectionDir, \n	float gloss, \n	vec3 specularity, \n	vec3 vertexNormal, \n	mat3 tbn\n#if defined(LIT_IRIDESCENCE)\n	vec3 iridescenceFresnel, \n	float iridescenceIntensity\n#endif\n) {\n	#if defined(LIT_SPECULAR) && defined(LIT_DIR_LIGHTMAP)\n		if (dot(dir, dir) < 0.0001) {\n				dDiffuseLight += lightmap;\n		} else {\n			float vlight = saturate(dot(dir, -vertexNormal));\n			float flight = saturate(dot(dir, -worldNormal));\n			float nlight = (flight / max(vlight, 0.01)) * 0.5;\n			dDiffuseLight += lightmap * nlight * 2.0;\n			vec3 halfDir = normalize(-dir + viewDir);\n			vec3 specularLight = lightmap * getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, dir, gloss, tbn);\n			#ifdef LIT_SPECULAR_FRESNEL\n				specularLight *= \n					getFresnel(dot(viewDir, halfDir), \n					gloss, \n					specularity\n				#if defined(LIT_IRIDESCENCE)\n					, iridescenceFresnel,\n					iridescenceIntensity\n				#endif\n					);\n			#endif\n			dSpecularLight += specularLight;\n		}\n	#else\n		dDiffuseLight += lightmap;\n	#endif\n}\n",lightmapPS:"\n#ifdef STD_LIGHTMAP_DIR\n	vec3 dLightmapDir;\n	uniform sampler2D texture_dirLightMap;\n#endif\nvoid getLightMap() {\n	dLightmap = vec3(1.0);\n	#ifdef STD_LIGHT_TEXTURE\n		dLightmap *= {STD_LIGHT_TEXTURE_DECODE}(texture2DBias({STD_LIGHT_TEXTURE_NAME}, {STD_LIGHT_TEXTURE_UV}, textureBias)).{STD_LIGHT_TEXTURE_CHANNEL};\n		#ifdef STD_LIGHTMAP_DIR\n			vec3 dir = texture2DBias(texture_dirLightMap, {STD_LIGHT_TEXTURE_UV}, textureBias).xyz * 2.0 - 1.0;\n			float dirDot = dot(dir, dir);\n			dLightmapDir = (dirDot > 0.001) ? dir / sqrt(dirDot) : vec3(0.0);\n		#endif\n	#endif\n	#ifdef STD_LIGHT_VERTEX\n		dLightmap *= saturate(vVertexColor.{STD_LIGHT_VERTEX_CHANNEL});\n	#endif\n}\n",lightSpecularAnisoGGXPS:"\nfloat calcLightSpecular(float gloss, vec3 worldNormal, vec3 viewDir, vec3 h, vec3 lightDirNorm, mat3 tbn) {\n	float PI = 3.141592653589793;\n	float roughness = max((1.0 - gloss) * (1.0 - gloss), 0.001);\n	float anisotropy = material_anisotropy * roughness;\n \n	float at = max((roughness + anisotropy), roughness / 4.0);\n	float ab = max((roughness - anisotropy), roughness / 4.0);\n	float NoH = dot(worldNormal, h);\n	float ToH = dot(tbn[0], h);\n	float BoH = dot(tbn[1], h);\n	float a2 = at * ab;\n	vec3 v = vec3(ab * ToH, at * BoH, a2 * NoH);\n	float v2 = dot(v, v);\n	float w2 = a2 / v2;\n	float D = a2 * w2 * w2 * (1.0 / PI);\n	float ToV = dot(tbn[0], viewDir);\n	float BoV = dot(tbn[1], viewDir);\n	float ToL = dot(tbn[0], -lightDirNorm);\n	float BoL = dot(tbn[1], -lightDirNorm);\n	float NoV = dot(worldNormal, viewDir);\n	float NoL = dot(worldNormal, -lightDirNorm);\n	float lambdaV = NoL * length(vec3(at * ToV, ab * BoV, NoV));\n	float lambdaL = NoV * length(vec3(at * ToL, ab * BoL, NoL));\n	float G = 0.5 / (lambdaV + lambdaL);\n	return D * G;\n}\nfloat getLightSpecular(vec3 h, vec3 reflDir, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float gloss, mat3 tbn) {\n	return calcLightSpecular(gloss, worldNormal, viewDir, h, lightDirNorm, tbn);\n}\n",lightSpecularBlinnPS:"\nfloat calcLightSpecular(float gloss, vec3 worldNormal, vec3 h) {\n	float nh = max( dot( h, worldNormal ), 0.0 );\n	float specPow = exp2(gloss * 11.0);\n	specPow = max(specPow, 0.0001);\n	return pow(nh, specPow) * (specPow + 2.0) / 8.0;\n}\nfloat getLightSpecular(vec3 h, vec3 reflDir, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float gloss, mat3 tbn) {\n	return calcLightSpecular(gloss, worldNormal, h);\n}\n",lightSheenPS:"\nfloat sheenD(vec3 normal, vec3 h, float roughness) {\n	const float PI = 3.141592653589793;\n	float invR = 1.0 / (roughness * roughness);\n	float cos2h = max(dot(normal, h), 0.0);\n	cos2h *= cos2h;\n	float sin2h = max(1.0 - cos2h, 0.0078125);\n	return (2.0 + invR) * pow(sin2h, invR * 0.5) / (2.0 * PI);\n}\nfloat sheenV(vec3 normal, vec3 viewDir, vec3 light) {\n	float NoV = max(dot(normal, viewDir), 0.000001);\n	float NoL = max(dot(normal, light), 0.000001);\n	return 1.0 / (4.0 * (NoL + NoV - NoL * NoV));\n}\nfloat getLightSpecularSheen(vec3 h, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float sheenGloss) {\n	float D = sheenD(worldNormal, h, sheenGloss);\n	float V = sheenV(worldNormal, viewDir, -lightDirNorm);\n	return D * V;\n}\n",linearizeDepthPS:"\n#ifndef LINEARIZE_DEPTH\n#define LINEARIZE_DEPTH\nfloat linearizeDepth(float z, vec4 cameraParams) {\n	if (cameraParams.w == 0.0)\n		return (cameraParams.z * cameraParams.y) / (cameraParams.y + z * (cameraParams.z - cameraParams.y));\n	else\n		return cameraParams.z + z * (cameraParams.y - cameraParams.z);\n}\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nfloat linearizeDepth(float z) {\n	return linearizeDepth(z, camera_params);\n}\n#endif\n",litForwardBackendPS:'\nvoid evaluateBackend() {\n	#ifdef LIT_SSAO\n		litArgs_ao *= texture2DLod(ssaoTexture, gl_FragCoord.xy * ssaoTextureSizeInv, 0.0).r;\n	#endif\n	#ifdef LIT_NEEDS_NORMAL\n		#ifdef LIT_SPECULAR\n			getReflDir(litArgs_worldNormal, dViewDirW, litArgs_gloss, dTBN);\n		#endif\n		#ifdef LIT_CLEARCOAT\n			ccReflDirW = normalize(-reflect(dViewDirW, litArgs_clearcoat_worldNormal));\n		#endif\n	#endif\n	#ifdef LIT_SPECULAR_OR_REFLECTION\n		#ifdef LIT_METALNESS\n			float f0 = 1.0 / litArgs_ior;\n			f0 = (f0 - 1.0) / (f0 + 1.0);\n			f0 *= f0;\n			litArgs_specularity = getSpecularModulate(litArgs_specularity, litArgs_albedo, litArgs_metalness, f0);\n			litArgs_albedo = getAlbedoModulate(litArgs_albedo, litArgs_metalness);\n		#endif\n		#ifdef LIT_IRIDESCENCE\n			vec3 iridescenceFresnel = getIridescence(saturate(dot(dViewDirW, litArgs_worldNormal)), litArgs_specularity, litArgs_iridescence_thickness);\n		#endif\n	#endif\n	#ifdef LIT_ADD_AMBIENT\n		addAmbient(litArgs_worldNormal);\n		#ifdef LIT_SPECULAR\n			dDiffuseLight = dDiffuseLight * (1.0 - litArgs_specularity);\n		#endif\n		#ifdef LIT_SEPARATE_AMBIENT\n			vec3 dAmbientLight = dDiffuseLight;\n			dDiffuseLight = vec3(0);\n		#endif\n	#endif\n	#ifndef LIT_OLD_AMBIENT\n		dDiffuseLight *= material_ambient;\n	#endif\n	#ifdef LIT_AO\n		#ifndef LIT_OCCLUDE_DIRECT\n			occludeDiffuse(litArgs_ao);\n		#endif\n	#endif\n	#ifdef LIT_LIGHTMAP\n		addLightMap(\n			litArgs_lightmap, \n			litArgs_lightmapDir, \n			litArgs_worldNormal, \n			dViewDirW, \n			dReflDirW, \n			litArgs_gloss, \n			litArgs_specularity, \n			dVertexNormalW,\n			dTBN\n		#if defined(LIT_IRIDESCENCE)\n			, iridescenceFresnel,\n			litArgs_iridescence_intensity\n		#endif\n		);\n	#endif\n	#ifdef LIT_LIGHTING || LIT_REFLECTIONS\n		#ifdef LIT_REFLECTIONS\n			#ifdef LIT_CLEARCOAT\n				addReflectionCC(ccReflDirW, litArgs_clearcoat_gloss);\n			\n				#ifdef LIT_SPECULAR_FRESNEL\n					ccFresnel = getFresnelCC(dot(dViewDirW, litArgs_clearcoat_worldNormal));\n					ccReflection.rgb *= ccFresnel;\n				#else\n					ccFresnel = 0.0;\n				#endif\n			#endif\n			#ifdef LIT_SPECULARITY_FACTOR\n				ccReflection.rgb *= litArgs_specularityFactor;\n			#endif\n			#ifdef LIT_SHEEN\n				addReflectionSheen(litArgs_worldNormal, dViewDirW, litArgs_sheen_gloss);\n			#endif\n			addReflection(dReflDirW, litArgs_gloss);\n			#ifdef LIT_FRESNEL_MODEL\n				dReflection.rgb *= getFresnel(\n					dot(dViewDirW, litArgs_worldNormal), \n					litArgs_gloss, \n					litArgs_specularity\n				#if defined(LIT_IRIDESCENCE)\n					, iridescenceFresnel,\n					litArgs_iridescence_intensity\n				#endif\n					);\n			#else\n				dReflection.rgb *= litArgs_specularity;\n			#endif\n			#ifdef LIT_SPECULARITY_FACTOR\n				dReflection.rgb *= litArgs_specularityFactor;\n			#endif\n		#endif\n		#ifdef AREA_LIGHTS\n			dSpecularLight *= litArgs_specularity;\n			#ifdef LIT_SPECULAR\n				calcLTCLightValues(litArgs_gloss, litArgs_worldNormal, dViewDirW, litArgs_specularity, litArgs_clearcoat_gloss, litArgs_clearcoat_worldNormal, litArgs_clearcoat_specularity);\n			#endif\n		#endif\n		\n		#include "lightEvaluationPS, LIGHT_COUNT"\n		#ifdef LIT_CLUSTERED_LIGHTS\n			addClusteredLights(litArgs_worldNormal, dViewDirW, dReflDirW,\n				#if defined(LIT_CLEARCOAT)\n						ccReflDirW,\n				#endif\n						litArgs_gloss, litArgs_specularity, dVertexNormalW, dTBN, \n				#if defined(LIT_IRIDESCENCE)\n						iridescenceFresnel,\n				#endif\n						litArgs_clearcoat_worldNormal, litArgs_clearcoat_gloss, litArgs_sheen_gloss, litArgs_iridescence_intensity\n			);\n		#endif\n		#ifdef AREA_LIGHTS\n			#ifdef LIT_CLEARCOAT\n				litArgs_clearcoat_specularity = 1.0;\n			#endif\n			#ifdef LIT_SPECULAR\n				litArgs_specularity = vec3(1);\n			#endif\n		#endif\n		#ifdef LIT_REFRACTION\n			addRefraction(\n				litArgs_worldNormal, \n				dViewDirW, \n				litArgs_thickness, \n				litArgs_gloss, \n				litArgs_specularity, \n				litArgs_albedo, \n				litArgs_transmission,\n				litArgs_ior,\n				litArgs_dispersion\n				#if defined(LIT_IRIDESCENCE)\n					, iridescenceFresnel, \n					litArgs_iridescence_intensity\n				#endif\n			);\n		#endif\n	#endif\n	#ifdef LIT_AO\n		#ifdef LIT_OCCLUDE_DIRECT\n			occludeDiffuse(litArgs_ao);\n		#endif\n		#if LIT_OCCLUDE_SPECULAR != NONE\n			occludeSpecular(litArgs_gloss, litArgs_ao, litArgs_worldNormal, dViewDirW);\n		#endif\n	#endif\n	#ifdef LIT_SPECULARITY_FACTOR\n		dSpecularLight *= litArgs_specularityFactor;\n	#endif\n	#if !defined(LIT_OPACITY_FADES_SPECULAR)\n		#if LIT_BLEND_TYPE == NORMAL || LIT_BLEND_TYPE == PREMULTIPLIED\n			float specLum = dot((dSpecularLight + dReflection.rgb * dReflection.a), vec3( 0.2126, 0.7152, 0.0722 ));\n			#ifdef LIT_CLEARCOAT\n				specLum += dot(ccSpecularLight * litArgs_clearcoat_specularity + ccReflection.rgb * litArgs_clearcoat_specularity, vec3( 0.2126, 0.7152, 0.0722 ));\n			#endif\n			litArgs_opacity = clamp(litArgs_opacity + gammaCorrectInput(specLum), 0.0, 1.0);\n		#endif\n		litArgs_opacity *= material_alphaFade;\n	#endif\n	#include "endPS"\n	#include "outputAlphaPS"\n	#ifdef LIT_MSDF\n		gl_FragColor = applyMsdf(gl_FragColor);\n	#endif\n	#include "outputPS"\n	#include "debugOutputPS"\n	#ifdef LIT_SHADOW_CATCHER\n		gl_FragColor.rgb = vec3(dShadowCatcher);\n	#endif\n}\n',litForwardDeclarationPS:'\nvec3 sReflection;\nvec3 dVertexNormalW;\nvec3 dTangentW;\nvec3 dBinormalW;\nvec3 dViewDirW;\nvec3 dReflDirW;\nvec3 ccReflDirW;\nvec3 dLightDirNormW;\nfloat dAtten;\nmat3 dTBN;\nvec4 dReflection;\nvec3 dDiffuseLight;\nvec3 dSpecularLight;\nfloat ccFresnel;\nvec3 ccReflection;\nvec3 ccSpecularLight;\nfloat ccSpecularityNoFres;\nvec3 sSpecularLight;\n#ifdef LIT_DISPERSION\n	uniform float material_dispersion;\n#endif\n#ifndef LIT_OPACITY_FADES_SPECULAR\n	uniform float material_alphaFade;\n#endif\n#ifdef LIT_SSAO\n	uniform sampler2D ssaoTexture;\n	uniform vec2 ssaoTextureSizeInv;\n#endif\n#ifdef LIT_SHADOW_CATCHER\n	float dShadowCatcher = 1.0;\n#endif\n#if LIGHT_COUNT > 0\n	#include "lightDeclarationPS, LIGHT_COUNT"\n#endif\n#ifdef LIT_SPECULAR\n	#if LIT_FRESNEL_MODEL == NONE && !defined(LIT_REFLECTIONS) && !defined(LIT_DIFFUSE_MAP) \n		#define LIT_OLD_AMBIENT\n	#endif\n#endif\n',litForwardMainPS:'\nvoid main(void) {\n	dReflection = vec4(0);\n	#ifdef LIT_CLEARCOAT\n		ccSpecularLight = vec3(0);\n		ccReflection = vec3(0);\n	#endif\n	#if LIT_NONE_SLICE_MODE == SLICED\n		#include "startNineSlicedPS"\n	#elif LIT_NONE_SLICE_MODE == TILED\n		#include "startNineSlicedTiledPS"\n	#endif\n	#ifdef LIT_NEEDS_NORMAL\n		dVertexNormalW = normalize(vNormalW);\n		#ifdef LIT_TANGENTS\n			#if defined(LIT_HEIGHTS) || defined(LIT_USE_NORMALS) || defined(LIT_USE_CLEARCOAT_NORMALS)\n				dTangentW = vTangentW;\n				dBinormalW = vBinormalW;\n			#endif\n		#endif\n		getViewDir();\n		#ifdef LIT_TBN\n			getTBN(dTangentW, dBinormalW, dVertexNormalW);\n			#ifdef LIT_TWO_SIDED_LIGHTING\n				handleTwoSidedLighting();\n			#endif\n		#endif\n	#endif\n	evaluateFrontend();\n	#include "debugProcessFrontendPS"\n	evaluateBackend();\n}\n',litForwardPostCodePS:'\n#ifdef LIT_NEEDS_NORMAL\n	#include "cubeMapRotatePS"\n	#include "cubeMapProjectPS"\n	#include "envProcPS"\n#endif\n#ifdef LIT_SPECULAR_OR_REFLECTION\n	#ifdef LIT_METALNESS\n		#include "metalnessModulatePS"\n	#endif\n	#if LIT_FRESNEL_MODEL == SCHLICK\n		#include "fresnelSchlickPS"\n	#endif\n	#ifdef LIT_IRIDESCENCE\n		#include "iridescenceDiffractionPS"\n	#endif\n#endif\n#ifdef LIT_AO\n	#include "aoDiffuseOccPS"\n	#include "aoSpecOccPS"\n#endif\n#if LIT_REFLECTION_SOURCE == ENVATLASHQ\n	#include "envAtlasPS"\n	#include "reflectionEnvHQPS"\n#elif LIT_REFLECTION_SOURCE == ENVATLAS\n	#include "envAtlasPS"\n	#include "reflectionEnvPS"\n#elif LIT_REFLECTION_SOURCE == CUBEMAP\n	#include "reflectionCubePS"\n#elif LIT_REFLECTION_SOURCE == SPHEREMAP\n	#include "reflectionSpherePS"\n#endif\n#ifdef LIT_REFLECTIONS\n	#ifdef LIT_CLEARCOAT\n		#include "reflectionCCPS"\n	#endif\n	#ifdef LIT_SHEEN\n		#include "reflectionSheenPS"\n	#endif\n#endif\n#ifdef LIT_REFRACTION\n	#if defined(LIT_DYNAMIC_REFRACTION)\n		#include "refractionDynamicPS"\n	#elif defined(LIT_REFLECTIONS)\n		#include "refractionCubePS"\n	#endif\n#endif\n#ifdef LIT_SHEEN\n	#include "lightSheenPS"\n#endif\n#ifdef LIT_GGX_SPECULAR\n	uniform float material_anisotropy;\n#endif\nuniform vec3 material_ambient;\n#ifdef LIT_SPECULAR\n	#ifdef LIT_LIGHTING\n		#ifdef LIT_GGX_SPECULAR\n			#include "lightSpecularAnisoGGXPS"\n		#else\n			#include "lightSpecularBlinnPS"\n		#endif\n	#endif\n#endif\n#include "combinePS"\n#ifdef LIT_LIGHTMAP\n	#include "lightmapAddPS"\n#endif\n#ifdef LIT_ADD_AMBIENT\n	#include "ambientPS"\n#endif\n#ifdef LIT_MSDF\n	#include "msdfPS"\n#endif\n#ifdef LIT_NEEDS_NORMAL\n	#include "viewDirPS"\n	#ifdef LIT_SPECULAR\n		#ifdef LIT_GGX_SPECULAR\n			#include "reflDirAnisoPS"\n		#else\n			#include "reflDirPS"\n		#endif\n	#endif\n#endif\n#include "lightingPS"\n',litForwardPreCodePS:'\n#include "basePS"\n#include "sphericalPS"\n#include "decodePS"\n#include "gammaPS"\n#include "tonemappingPS"\n#include "fogPS"\n#if LIT_NONE_SLICE_MODE == SLICED\n	#include "baseNineSlicedPS"\n#elif LIT_NONE_SLICE_MODE == TILED\n	#include "baseNineSlicedTiledPS"\n#endif\n#ifdef LIT_TBN\n	#include "TBNPS"\n	#ifdef LIT_TWO_SIDED_LIGHTING\n		#include "twoSidedLightingPS"\n	#endif\n#endif\n',litMainVS:'\n#ifdef VERTEX_COLOR\n	attribute vec4 vertex_color;\n#endif\n#ifdef NINESLICED\n	varying vec2 vMask;\n	varying vec2 vTiledUv;\n	uniform mediump vec4 innerOffset;\n	uniform mediump vec2 outerScale;\n	uniform mediump vec4 atlasRect;\n#endif\nvec3 dPositionW;\nmat4 dModelMatrix;\n#include "transformCoreVS"\n#ifdef UV0\n	attribute vec2 vertex_texCoord0;\n	#include "uv0VS"\n#endif\n#ifdef UV1\n	attribute vec2 vertex_texCoord1;\n	#include "uv1VS"\n#endif\n#ifdef LINEAR_DEPTH\n	#ifndef VIEWMATRIX\n	#define VIEWMATRIX\n		uniform mat4 matrix_view;\n	#endif\n#endif\n#include "transformVS"\n#ifdef NORMALS\n	#include "normalCoreVS"\n	#include "normalVS"\n#endif\n#ifdef TANGENTS\n	attribute vec4 vertex_tangent;\n	#include "tangentBinormalVS"\n#endif\n#include "uvTransformUniformsPS, UV_TRANSFORMS_COUNT"\n#ifdef MSDF\n	#include "msdfVS"\n#endif\nvoid main(void) {\n	gl_Position = getPosition();\n	vPositionW = getWorldPosition();\n	#ifdef NORMALS\n		vNormalW = getNormal();\n	#endif\n	#ifdef TANGENTS\n		vTangentW = getTangent();\n		vBinormalW = getBinormal();\n	#elif defined(GGX_SPECULAR)\n		vObjectSpaceUpW = normalize(dNormalMatrix * vec3(0, 1, 0));\n	#endif\n	#ifdef UV0\n		vec2 uv0 = getUv0();\n		#ifdef UV0_UNMODIFIED\n			vUv0 = uv0;\n		#endif\n	#endif\n	#ifdef UV1\n		vec2 uv1 = getUv1();\n		#ifdef UV1_UNMODIFIED\n			vUv1 = uv1;\n		#endif\n	#endif\n	#include "uvTransformVS, UV_TRANSFORMS_COUNT"\n	#ifdef VERTEX_COLOR\n		vVertexColor = vertex_color;\n	#endif\n	#ifdef LINEAR_DEPTH\n		vLinearDepth = -(matrix_view * vec4(vPositionW, 1.0)).z;\n	#endif\n	#ifdef MSDF\n		unpackMsdfParams();\n	#endif\n}\n',litOtherMainPS:'\n#ifdef PICK_PASS\n	#include "pickPS"\n#endif\n#ifdef PREPASS_PASS\n	#include "floatAsUintPS"\n#endif\nvoid main(void) {\n	evaluateFrontend();\n	#ifdef PICK_PASS\n		gl_FragColor = getPickOutput();\n	#endif\n	#ifdef DEPTH_PASS\n		gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);\n	#endif\n	#ifdef PREPASS_PASS\n		gl_FragColor = float2vec4(vLinearDepth);\n	#endif\n}\n',litShaderArgsPS:"\nvec3 litArgs_albedo;\nfloat litArgs_opacity;\nvec3 litArgs_emission;\nvec3 litArgs_worldNormal;\nfloat litArgs_ao;\nvec3 litArgs_lightmap;\nvec3 litArgs_lightmapDir;\nfloat litArgs_metalness;\nvec3 litArgs_specularity;\nfloat litArgs_specularityFactor;\nfloat litArgs_gloss;\nfloat litArgs_sheen_gloss;\nvec3 litArgs_sheen_specularity;\nfloat litArgs_transmission;\nfloat litArgs_thickness;\nfloat litArgs_ior;\nfloat litArgs_dispersion;\nfloat litArgs_iridescence_intensity;\nfloat litArgs_iridescence_thickness;\nvec3 litArgs_clearcoat_worldNormal;\nfloat litArgs_clearcoat_specularity;\nfloat litArgs_clearcoat_gloss;\n",litShaderCorePS:'\n	#if LIT_NONE_SLICE_MODE == TILED\n		const float textureBias = -1000.0;\n	#else\n		uniform float textureBias;\n	#endif\n	#include "litShaderArgsPS"\n',litShadowMainPS:'\n#if LIGHT_TYPE != DIRECTIONAL\n	uniform vec3 view_position;\n	uniform float light_radius;\n#endif\n#if SHADOW_TYPE == PCSS_32F\n	#include "linearizeDepthPS"\n#endif\nvoid main(void) {\n	evaluateFrontend();\n	#ifdef PERSPECTIVE_DEPTH\n		float depth = gl_FragCoord.z;\n		#if SHADOW_TYPE == PCSS_32F\n			#if LIGHT_TYPE != DIRECTIONAL\n				depth = linearizeDepth(depth, camera_params);\n			#endif\n		#endif\n	#else\n		float depth = min(distance(view_position, vPositionW) / light_radius, 0.99999);\n		#define MODIFIED_DEPTH\n	#endif\n	#if SHADOW_TYPE == VSM_16F || SHADOW_TYPE == VSM_32F\n		#if SHADOW_TYPE == VSM_32F\n			float exponent = 15.0;\n		#else\n			float exponent = 5.54;\n		#endif\n		depth = 2.0 * depth - 1.0;\n		depth =  exp(exponent * depth);\n		gl_FragColor = vec4(depth, depth*depth, 1.0, 1.0);\n	#else\n		#if SHADOW_TYPE == PCSS_32F\n			gl_FragColor.r = depth;\n		#else\n			#ifdef MODIFIED_DEPTH\n				gl_FragDepth = depth;\n			#endif\n			gl_FragColor = vec4(1.0);\n		#endif\n	#endif\n}\n',ltcPS:"\nmat3 transposeMat3( const in mat3 m ) {\n	mat3 tmp;\n	tmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n	tmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n	tmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n	return tmp;\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n	const float LUT_SIZE = 64.0;\n	const float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n	const float LUT_BIAS = 0.5 / LUT_SIZE;\n	float dotNV = saturate( dot( N, V ) );\n	vec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n	uv = uv * LUT_SCALE + LUT_BIAS;\n	return uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n	float l = length( f );\n	return max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n	float x = dot( v1, v2 );\n	float y = abs( x );\n	float a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n	float b = 3.4175940 + ( 4.1616724 + y ) * y;\n	float v = a / b;\n	float theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n	return cross( v1, v2 ) * theta_sintheta;\n}\nstruct Coords {\n	vec3 coord0;\n	vec3 coord1;\n	vec3 coord2;\n	vec3 coord3;\n};\nfloat LTC_EvaluateRect( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in Coords rectCoords) {\n	vec3 v1 = rectCoords.coord1 - rectCoords.coord0;\n	vec3 v2 = rectCoords.coord3 - rectCoords.coord0;\n	\n	vec3 lightNormal = cross( v1, v2 );\n	float factor = sign(-dot( lightNormal, P - rectCoords.coord0 ));\n	vec3 T1, T2;\n	T1 = normalize( V - N * dot( V, N ) );\n	T2 =  factor * cross( N, T1 );\n	mat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n	vec3 coords[ 4 ];\n	coords[ 0 ] = mat * ( rectCoords.coord0 - P );\n	coords[ 1 ] = mat * ( rectCoords.coord1 - P );\n	coords[ 2 ] = mat * ( rectCoords.coord2 - P );\n	coords[ 3 ] = mat * ( rectCoords.coord3 - P );\n	coords[ 0 ] = normalize( coords[ 0 ] );\n	coords[ 1 ] = normalize( coords[ 1 ] );\n	coords[ 2 ] = normalize( coords[ 2 ] );\n	coords[ 3 ] = normalize( coords[ 3 ] );\n	vec3 vectorFormFactor = vec3( 0.0 );\n	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n	float result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n	return result;\n}\nCoords dLTCCoords;\nCoords getLTCLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){\n	Coords coords;\n	coords.coord0 = lightPos + halfWidth - halfHeight;\n	coords.coord1 = lightPos - halfWidth - halfHeight;\n	coords.coord2 = lightPos - halfWidth + halfHeight;\n	coords.coord3 = lightPos + halfWidth + halfHeight;\n	return coords;\n}\nfloat dSphereRadius;\nCoords getSphereLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){\n	dSphereRadius = max(length(halfWidth), length(halfHeight));\n	vec3 f = reflect(normalize(lightPos - view_position), vNormalW);\n	vec3 w = normalize(cross(f, halfHeight));\n	vec3 h = normalize(cross(f, w));\n	return getLTCLightCoords(lightPos, w * dSphereRadius, h * dSphereRadius);\n}\nvec2 dLTCUV;\n#ifdef LIT_CLEARCOAT\nvec2 ccLTCUV;\n#endif\nvec2 getLTCLightUV(float gloss, vec3 worldNormal, vec3 viewDir)\n{\n	float roughness = max((1.0 - gloss) * (1.0 - gloss), 0.001);\n	return LTC_Uv( worldNormal, viewDir, roughness );\n}\nvec3 dLTCSpecFres;\n#ifdef LIT_CLEARCOAT\nvec3 ccLTCSpecFres;\n#endif\nvec3 getLTCLightSpecFres(vec2 uv, vec3 specularity)\n{\n	vec4 t2 = texture2DLod(areaLightsLutTex2, uv, 0.0);\n	return specularity * t2.x + ( vec3( 1.0 ) - specularity) * t2.y;\n}\nvoid calcLTCLightValues(float gloss, vec3 worldNormal, vec3 viewDir, vec3 specularity, float clearcoatGloss, vec3 clearcoatWorldNormal, float clearcoatSpecularity)\n{\n	dLTCUV = getLTCLightUV(gloss, worldNormal, viewDir);\n	dLTCSpecFres = getLTCLightSpecFres(dLTCUV, specularity); \n#ifdef LIT_CLEARCOAT\n	ccLTCUV = getLTCLightUV(clearcoatGloss, clearcoatWorldNormal, viewDir);\n	ccLTCSpecFres = getLTCLightSpecFres(ccLTCUV, vec3(clearcoatSpecularity));\n#endif\n}\nvoid calcRectLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n	dLTCCoords = getLTCLightCoords(lightPos, halfWidth, halfHeight);\n}\nvoid calcDiskLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n	calcRectLightValues(lightPos, halfWidth, halfHeight);\n}\nvoid calcSphereLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n	dLTCCoords = getSphereLightCoords(lightPos, halfWidth, halfHeight);\n}\nvec3 SolveCubic(vec4 Coefficient)\n{\n	float pi = 3.14159;\n	Coefficient.xyz /= Coefficient.w;\n	Coefficient.yz /= 3.0;\n	float A = Coefficient.w;\n	float B = Coefficient.z;\n	float C = Coefficient.y;\n	float D = Coefficient.x;\n	vec3 Delta = vec3(\n		-Coefficient.z * Coefficient.z + Coefficient.y,\n		-Coefficient.y * Coefficient.z + Coefficient.x,\n		dot(vec2(Coefficient.z, -Coefficient.y), Coefficient.xy)\n	);\n	float Discriminant = dot(vec2(4.0 * Delta.x, -Delta.y), Delta.zy);\n	vec3 RootsA, RootsD;\n	vec2 xlc, xsc;\n	{\n		float A_a = 1.0;\n		float C_a = Delta.x;\n		float D_a = -2.0 * B * Delta.x + Delta.y;\n		float Theta = atan(sqrt(Discriminant), -D_a) / 3.0;\n		float x_1a = 2.0 * sqrt(-C_a) * cos(Theta);\n		float x_3a = 2.0 * sqrt(-C_a) * cos(Theta + (2.0 / 3.0) * pi);\n		float xl;\n		if ((x_1a + x_3a) > 2.0 * B)\n			xl = x_1a;\n		else\n			xl = x_3a;\n		xlc = vec2(xl - B, A);\n	}\n	{\n		float A_d = D;\n		float C_d = Delta.z;\n		float D_d = -D * Delta.y + 2.0 * C * Delta.z;\n		float Theta = atan(D * sqrt(Discriminant), -D_d) / 3.0;\n		float x_1d = 2.0 * sqrt(-C_d) * cos(Theta);\n		float x_3d = 2.0 * sqrt(-C_d) * cos(Theta + (2.0 / 3.0) * pi);\n		float xs;\n		if (x_1d + x_3d < 2.0 * C)\n			xs = x_1d;\n		else\n			xs = x_3d;\n		xsc = vec2(-D, xs + C);\n	}\n	float E =  xlc.y * xsc.y;\n	float F = -xlc.x * xsc.y - xlc.y * xsc.x;\n	float G =  xlc.x * xsc.x;\n	vec2 xmc = vec2(C * F - B * G, -B * F + C * E);\n	vec3 Root = vec3(xsc.x / xsc.y, xmc.x / xmc.y, xlc.x / xlc.y);\n	if (Root.x < Root.y && Root.x < Root.z)\n		Root.xyz = Root.yxz;\n	else if (Root.z < Root.x && Root.z < Root.y)\n		Root.xyz = Root.xzy;\n	return Root;\n}\nfloat LTC_EvaluateDisk(vec3 N, vec3 V, vec3 P, mat3 Minv, Coords points)\n{\n	vec3 T1, T2;\n	T1 = normalize(V - N * dot(V, N));\n	T2 = cross(N, T1);\n	mat3 R = transposeMat3( mat3( T1, T2, N ) );\n	vec3 L_[ 3 ];\n	L_[ 0 ] = R * ( points.coord0 - P );\n	L_[ 1 ] = R * ( points.coord1 - P );\n	L_[ 2 ] = R * ( points.coord2 - P );\n	vec3 Lo_i = vec3(0);\n	vec3 C  = 0.5 * (L_[0] + L_[2]);\n	vec3 V1 = 0.5 * (L_[1] - L_[2]);\n	vec3 V2 = 0.5 * (L_[1] - L_[0]);\n	C  = Minv * C;\n	V1 = Minv * V1;\n	V2 = Minv * V2;\n	float a, b;\n	float d11 = dot(V1, V1);\n	float d22 = dot(V2, V2);\n	float d12 = dot(V1, V2);\n	if (abs(d12) / sqrt(d11 * d22) > 0.0001)\n	{\n		float tr = d11 + d22;\n		float det = -d12 * d12 + d11 * d22;\n		det = sqrt(det);\n		float u = 0.5 * sqrt(tr - 2.0 * det);\n		float v = 0.5 * sqrt(tr + 2.0 * det);\n		float e_max = (u + v) * (u + v);\n		float e_min = (u - v) * (u - v);\n		vec3 V1_, V2_;\n		if (d11 > d22)\n		{\n			V1_ = d12 * V1 + (e_max - d11) * V2;\n			V2_ = d12 * V1 + (e_min - d11) * V2;\n		}\n		else\n		{\n			V1_ = d12*V2 + (e_max - d22)*V1;\n			V2_ = d12*V2 + (e_min - d22)*V1;\n		}\n		a = 1.0 / e_max;\n		b = 1.0 / e_min;\n		V1 = normalize(V1_);\n		V2 = normalize(V2_);\n	}\n	else\n	{\n		a = 1.0 / dot(V1, V1);\n		b = 1.0 / dot(V2, V2);\n		V1 *= sqrt(a);\n		V2 *= sqrt(b);\n	}\n	vec3 V3 = normalize(cross(V1, V2));\n	if (dot(C, V3) < 0.0)\n		V3 *= -1.0;\n	float L  = dot(V3, C);\n	float x0 = dot(V1, C) / L;\n	float y0 = dot(V2, C) / L;\n	float E1 = inversesqrt(a);\n	float E2 = inversesqrt(b);\n	a *= L * L;\n	b *= L * L;\n	float c0 = a * b;\n	float c1 = a * b * (1.0 + x0 * x0 + y0 * y0) - a - b;\n	float c2 = 1.0 - a * (1.0 + x0 * x0) - b * (1.0 + y0 * y0);\n	float c3 = 1.0;\n	vec3 roots = SolveCubic(vec4(c0, c1, c2, c3));\n	float e1 = roots.x;\n	float e2 = roots.y;\n	float e3 = roots.z;\n	vec3 avgDir = vec3(a * x0 / (a - e2), b * y0 / (b - e2), 1.0);\n	mat3 rotate = mat3(V1, V2, V3);\n	avgDir = rotate * avgDir;\n	avgDir = normalize(avgDir);\n	float L1 = sqrt(-e2 / e3);\n	float L2 = sqrt(-e2 / e1);\n	float formFactor = max(0.0, L1 * L2 * inversesqrt((1.0 + L1 * L1) * (1.0 + L2 * L2)));\n	\n	const float LUT_SIZE = 64.0;\n	const float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n	const float LUT_BIAS = 0.5 / LUT_SIZE;\n	vec2 uv = vec2(avgDir.z * 0.5 + 0.5, formFactor);\n	uv = uv*LUT_SCALE + LUT_BIAS;\n	float scale = texture2DLod(areaLightsLutTex2, uv, 0.0).w;\n	return formFactor*scale;\n}\nfloat FixNan(float value) {\n	#ifdef WEBGPU\n		return value != value ? 0.0 : value;\n	#else\n		return isnan(value) ? 0.0 : value;\n	#endif\n}\nfloat getRectLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {\n	return LTC_EvaluateRect( worldNormal, viewDir, vPositionW, mat3( 1.0 ), dLTCCoords );\n}\nfloat getDiskLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {\n	return FixNan(LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, mat3( 1.0 ), dLTCCoords ));\n}\nfloat getSphereLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {\n	float falloff = dSphereRadius / (dot(lightDir, lightDir) + dSphereRadius);\n	return FixNan(getLightDiffuse(worldNormal, viewDir, lightDirNorm) * falloff);\n}\nmat3 getLTCLightInvMat(vec2 uv)\n{\n	vec4 t1 = texture2DLod(areaLightsLutTex1, uv, 0.0);\n	return mat3(\n		vec3( t1.x, 0, t1.y ),\n		vec3(	0, 1,	0 ),\n		vec3( t1.z, 0, t1.w )\n	);\n}\nfloat calcRectLightSpecular(vec3 worldNormal, vec3 viewDir, vec2 uv) {\n	mat3 mInv = getLTCLightInvMat(uv);\n	return LTC_EvaluateRect( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );\n}\nfloat getRectLightSpecular(vec3 worldNormal, vec3 viewDir) {\n	return calcRectLightSpecular(worldNormal, viewDir, dLTCUV);\n}\nfloat calcDiskLightSpecular(vec3 worldNormal, vec3 viewDir, vec2 uv) {\n	mat3 mInv = getLTCLightInvMat(uv);\n	return LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );\n}\nfloat getDiskLightSpecular(vec3 worldNormal, vec3 viewDir) {\n	return calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);\n}\nfloat getSphereLightSpecular(vec3 worldNormal, vec3 viewDir) {\n	return calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);\n}\n",metalnessPS:"\n#ifdef STD_METALNESS_CONSTANT\nuniform float material_metalness;\n#endif\nvoid getMetalness() {\n	float metalness = 1.0;\n	#ifdef STD_METALNESS_CONSTANT\n	metalness *= material_metalness;\n	#endif\n	#ifdef STD_METALNESS_TEXTURE\n	metalness *= texture2DBias({STD_METALNESS_TEXTURE_NAME}, {STD_METALNESS_TEXTURE_UV}, textureBias).{STD_METALNESS_TEXTURE_CHANNEL};\n	#endif\n	#ifdef STD_METALNESS_VERTEX\n	metalness *= saturate(vVertexColor.{STD_METALNESS_VERTEX_CHANNEL});\n	#endif\n	dMetalness = metalness;\n}\n",metalnessModulatePS:"\nvec3 getSpecularModulate(in vec3 specularity, in vec3 albedo, in float metalness, in float f0) {\n	vec3 dielectricF0 = f0 * specularity;\n	return mix(dielectricF0, albedo, metalness);\n}\nvec3 getAlbedoModulate(in vec3 albedo, in float metalness) {\n	return albedo * (1.0 - metalness);\n}\n",morphEvaluationPS:"\n	color.xyz += morphFactor[{i}] * texture2DLod(morphBlendTex{i}, uv0, 0.0).xyz;\n",morphDeclarationPS:"\n	uniform highp sampler2D morphBlendTex{i};\n",morphPS:'\n	varying vec2 uv0;\n	#include "morphDeclarationPS, MORPH_TEXTURE_COUNT"\n	#if MORPH_TEXTURE_COUNT > 0\n		uniform highp float morphFactor[{MORPH_TEXTURE_COUNT}];\n	#endif\n	#ifdef MORPH_INT\n		uniform vec3 aabbSize;\n		uniform vec3 aabbMin;\n	#endif\n	void main (void) {\n		highp vec4 color = vec4(0, 0, 0, 1);\n		#include "morphEvaluationPS, MORPH_TEXTURE_COUNT"\n		#ifdef MORPH_INT\n			color.xyz = (color.xyz - aabbMin) / aabbSize * 65535.0;\n			gl_FragColor = uvec4(color);\n		#else\n			gl_FragColor = color;\n		#endif\n	}\n',morphVS:"\n	attribute vec2 vertex_position;\n	varying vec2 uv0;\n	void main(void) {\n		gl_Position = vec4(vertex_position, 0.5, 1.0);\n		uv0 = vertex_position.xy * 0.5 + 0.5;\n	}\n",msdfPS:"\nuniform sampler2D texture_msdfMap;\nfloat median(float r, float g, float b) {\n	return max(min(r, g), min(max(r, g), b));\n}\nfloat map (float min, float max, float v) {\n	return (v - min) / (max - min);\n}\nuniform float font_sdfIntensity;\nuniform float font_pxrange;\nuniform float font_textureWidth;\n#ifndef LIT_MSDF_TEXT_ATTRIBUTE\n	uniform vec4 outline_color;\n	uniform float outline_thickness;\n	uniform vec4 shadow_color;\n	uniform vec2 shadow_offset;\n#else\n	varying vec4 outline_color;\n	varying float outline_thickness;\n	varying vec4 shadow_color;\n	varying vec2 shadow_offset;\n#endif\nvec4 applyMsdf(vec4 color) {\n	color.rgb = gammaCorrectInput(color.rgb);\n	vec3 tsample = texture2D(texture_msdfMap, vUv0).rgb;\n	vec2 uvShdw = vUv0 - shadow_offset;\n	vec3 ssample = texture2D(texture_msdfMap, uvShdw).rgb;\n	float sigDist = median(tsample.r, tsample.g, tsample.b);\n	float sigDistShdw = median(ssample.r, ssample.g, ssample.b);\n	float smoothingMax = 0.2;\n	vec2 w = fwidth(vUv0);\n	float smoothing = clamp(w.x * font_textureWidth / font_pxrange, 0.0, smoothingMax);\n	float mapMin = 0.05;\n	float mapMax = clamp(1.0 - font_sdfIntensity, mapMin, 1.0);\n	float sigDistInner = map(mapMin, mapMax, sigDist);\n	float sigDistOutline = map(mapMin, mapMax, sigDist + outline_thickness);\n	sigDistShdw = map(mapMin, mapMax, sigDistShdw + outline_thickness);\n	float center = 0.5;\n	float inside = smoothstep(center-smoothing, center+smoothing, sigDistInner);\n	float outline = smoothstep(center-smoothing, center+smoothing, sigDistOutline);\n	float shadow = smoothstep(center-smoothing, center+smoothing, sigDistShdw);\n	vec4 tcolor = (outline > inside) ? outline * vec4(outline_color.a * outline_color.rgb, outline_color.a) : vec4(0.0);\n	tcolor = mix(tcolor, color, inside);\n	vec4 scolor = (shadow > outline) ? shadow * vec4(shadow_color.a * shadow_color.rgb, shadow_color.a) : tcolor;\n	tcolor = mix(scolor, tcolor, outline);\n	tcolor.rgb = gammaCorrectOutput(tcolor.rgb);\n	\n	return tcolor;\n}\n",msdfVS:"\nattribute vec3 vertex_outlineParameters;\nattribute vec3 vertex_shadowParameters;\nvarying vec4 outline_color;\nvarying float outline_thickness;\nvarying vec4 shadow_color;\nvarying vec2 shadow_offset;\nvoid unpackMsdfParams() {\n	vec3 little = mod(vertex_outlineParameters, 256.);\n	vec3 big = (vertex_outlineParameters - little) / 256.;\n	outline_color.rb = little.xy / 255.;\n	outline_color.ga = big.xy / 255.;\n	outline_thickness = little.z / 255. * 0.2;\n	little = mod(vertex_shadowParameters, 256.);\n	big = (vertex_shadowParameters - little) / 256.;\n	shadow_color.rb = little.xy / 255.;\n	shadow_color.ga = big.xy / 255.;\n	shadow_offset = (vec2(little.z, big.z) / 127. - 1.) * 0.005;\n}\n",normalVS:"\nmat3 dNormalMatrix;\nvec3 getNormal() {\n	dNormalMatrix = getNormalMatrix(dModelMatrix);\n	vec3 localNormal = getLocalNormal(vertex_normal);\n	return normalize(dNormalMatrix * localNormal);\n}\n",normalCoreVS:"\nattribute vec3 vertex_normal;\n#ifdef MORPHING_NORMAL\n	#ifdef MORPHING_INT\n		uniform highp usampler2D morphNormalTex;\n	#else\n		uniform highp sampler2D morphNormalTex;\n	#endif\n#endif\nvec3 getLocalNormal(vec3 vertexNormal) {\n	vec3 localNormal = vertex_normal;\n	#ifdef MORPHING_NORMAL\n		ivec2 morphUV = getTextureMorphCoords();\n		#ifdef MORPHING_INT\n			vec3 morphNormal = vec3(texelFetch(morphNormalTex, ivec2(morphUV), 0).xyz) / 65535.0 * 2.0 - 1.0;\n		#else\n			vec3 morphNormal = texelFetch(morphNormalTex, ivec2(morphUV), 0).xyz;\n		#endif\n		localNormal += morphNormal;\n	#endif\n	return localNormal;\n}\n#ifdef SKIN\n	mat3 getNormalMatrix(mat4 modelMatrix) {\n		return mat3(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);\n	}\n#elif defined(INSTANCING)\n	mat3 getNormalMatrix(mat4 modelMatrix) {\n		return mat3(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);\n	}\n#else\n	mat3 getNormalMatrix(mat4 modelMatrix) {\n		return matrix_normal;\n	}\n#endif\n",normalMapPS:"\n#ifdef STD_NORMAL_TEXTURE\nuniform float material_bumpiness;\n#endif\n#ifdef STD_NORMALDETAIL_TEXTURE\nuniform float material_normalDetailMapBumpiness;\nvec3 blendNormals(vec3 n1, vec3 n2) {\n	n1 += vec3(0, 0, 1);\n	n2 *= vec3(-1, -1, 1);\n	return n1 * dot(n1, n2) / n1.z - n2;\n}\n#endif\nvoid getNormal() {\n#ifdef STD_NORMAL_TEXTURE\n	vec3 normalMap = {STD_NORMAL_TEXTURE_DECODE}(texture2DBias({STD_NORMAL_TEXTURE_NAME}, {STD_NORMAL_TEXTURE_UV}, textureBias));\n	normalMap = mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness);\n	#ifdef STD_NORMALDETAIL_TEXTURE\n		vec3 normalDetailMap = {STD_NORMALDETAIL_TEXTURE_DECODE}(texture2DBias({STD_NORMALDETAIL_TEXTURE_NAME}, {STD_NORMALDETAIL_TEXTURE_UV}, textureBias));\n		normalDetailMap = mix(vec3(0.0, 0.0, 1.0), normalDetailMap, material_normalDetailMapBumpiness);\n		normalMap = blendNormals(normalMap, normalDetailMap);\n	#endif\n	dNormalW = normalize(dTBN * normalMap);\n#else\n	dNormalW = dVertexNormalW;\n#endif\n}\n",opacityPS:"\nuniform float material_opacity;\nvoid getOpacity() {\n	dAlpha = material_opacity;\n	#ifdef STD_OPACITY_TEXTURE\n	dAlpha *= texture2DBias({STD_OPACITY_TEXTURE_NAME}, {STD_OPACITY_TEXTURE_UV}, textureBias).{STD_OPACITY_TEXTURE_CHANNEL};\n	#endif\n	#ifdef STD_OPACITY_VERTEX\n	dAlpha *= clamp(vVertexColor.{STD_OPACITY_VERTEX_CHANNEL}, 0.0, 1.0);\n	#endif\n}\n",opacityDitherPS:'\n#if STD_OPACITY_DITHER == BAYER8\n	#include "bayerPS"\n#endif\nuniform vec4 blueNoiseJitter;\n#if STD_OPACITY_DITHER == BLUENOISE\n	uniform sampler2D blueNoiseTex32;\n#endif\nvoid opacityDither(float alpha, float id) {\n	#if STD_OPACITY_DITHER == BAYER8\n		float noise = bayer8(floor(mod(gl_FragCoord.xy + blueNoiseJitter.xy + id, 8.0))) / 64.0;\n	#else\n		#if STD_OPACITY_DITHER == BLUENOISE\n			vec2 uv = fract(gl_FragCoord.xy / 32.0 + blueNoiseJitter.xy + id);\n			float noise = texture2DLod(blueNoiseTex32, uv, 0.0).y;\n		#endif\n		#if STD_OPACITY_DITHER == IGNNOISE\n			vec3 magic = vec3(0.06711056, 0.00583715, 52.9829189);\n			float noise = fract(magic.z * fract(dot(gl_FragCoord.xy + blueNoiseJitter.xy + id, magic.xy)));\n		#endif\n	#endif\n	noise = pow(noise, 2.2);\n	if (alpha < noise)\n		discard;\n}\n',outputPS:"\n",outputAlphaPS:"\n#if LIT_BLEND_TYPE == NORMAL || LIT_BLEND_TYPE == ADDITIVEALPHA || defined(LIT_ALPHA_TO_COVERAGE)\n	gl_FragColor.a = litArgs_opacity;\n#elif LIT_BLEND_TYPE == PREMULTIPLIED\n	gl_FragColor.rgb *= litArgs_opacity;\n	gl_FragColor.a = litArgs_opacity;\n#else\n	gl_FragColor.a = 1.0;\n#endif\n",outputTex2DPS:"\nvarying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n	gl_FragColor = texture2D(source, vUv0);\n}\n",sheenPS:"\nuniform vec3 material_sheen;\nvoid getSheen() {\n	vec3 sheenColor = material_sheen;\n	#ifdef STD_SHEEN_TEXTURE\n	sheenColor *= {STD_SHEEN_TEXTURE_DECODE}(texture2DBias({STD_SHEEN_TEXTURE_NAME}, {STD_SHEEN_TEXTURE_UV}, textureBias)).{STD_SHEEN_TEXTURE_CHANNEL};\n	#endif\n	#ifdef STD_SHEEN_VERTEX\n	sheenColor *= saturate(vVertexColor.{STD_SHEEN_VERTEX_CHANNEL});\n	#endif\n	sSpecularity = sheenColor;\n}\n",sheenGlossPS:"\nuniform float material_sheenGloss;\nvoid getSheenGlossiness() {\n	float sheenGlossiness = material_sheenGloss;\n	#ifdef STD_SHEENGLOSS_TEXTURE\n	sheenGlossiness *= texture2DBias({STD_SHEENGLOSS_TEXTURE_NAME}, {STD_SHEENGLOSS_TEXTURE_UV}, textureBias).{STD_SHEENGLOSS_TEXTURE_CHANNEL};\n	#endif\n	#ifdef STD_SHEENGLOSS_VERTEX\n	sheenGlossiness *= saturate(vVertexColor.{STD_SHEENGLOSS_VERTEX_CHANNEL});\n	#endif\n	#ifdef STD_SHEENGLOSS_INVERT\n	sheenGlossiness = 1.0 - sheenGlossiness;\n	#endif\n	sGlossiness = sheenGlossiness + 0.0000001;\n}\n",parallaxPS:"\nuniform float material_heightMapFactor;\nvoid getParallax() {\n	float parallaxScale = material_heightMapFactor;\n	float height = texture2DBias({STD_HEIGHT_TEXTURE_NAME}, {STD_HEIGHT_TEXTURE_UV}, textureBias).{STD_HEIGHT_TEXTURE_CHANNEL};\n	height = height * parallaxScale - parallaxScale*0.5;\n	vec3 viewDirT = dViewDirW * dTBN;\n	viewDirT.z += 0.42;\n	dUvOffset = height * (viewDirT.xy / viewDirT.z);\n}\n",particlePS:"\nvarying vec4 texCoordsAlphaLife;\nuniform sampler2D colorMap;\nuniform sampler2D colorParam;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nuniform float softening;\nuniform float colorMult;\nfloat saturate(float x) {\n	return clamp(x, 0.0, 1.0);\n}\nvoid main(void) {\n	vec4 tex  = texture2D(colorMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y));\n	vec4 ramp = texture2D(colorParam, vec2(texCoordsAlphaLife.w, 0.0));\n	ramp.rgb *= colorMult;\n	ramp.a += texCoordsAlphaLife.z;\n	vec3 rgb = tex.rgb * ramp.rgb;\n	float a  = tex.a * ramp.a;\n",particleVS:"\nvec3 unpack3NFloats(float src) {\n	float r = fract(src);\n	float g = fract(src * 256.0);\n	float b = fract(src * 65536.0);\n	return vec3(r, g, b);\n}\nfloat saturate(float x) {\n	return clamp(x, 0.0, 1.0);\n}\nvec4 tex1Dlod_lerp(TEXTURE_ACCEPT_HIGHP(tex), vec2 tc) {\n	return mix( texture2D(tex,tc), texture2D(tex,tc + graphSampleSize), fract(tc.x*graphNumSamples) );\n}\nvec4 tex1Dlod_lerp(TEXTURE_ACCEPT_HIGHP(tex), vec2 tc, out vec3 w) {\n	vec4 a = texture2D(tex,tc);\n	vec4 b = texture2D(tex,tc + graphSampleSize);\n	float c = fract(tc.x*graphNumSamples);\n	vec3 unpackedA = unpack3NFloats(a.w);\n	vec3 unpackedB = unpack3NFloats(b.w);\n	w = mix(unpackedA, unpackedB, c);\n	return mix(a, b, c);\n}\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix) {\n	float c = cos(pRotation);\n	float s = sin(pRotation);\n	mat2 m = mat2(c, -s, s, c);\n	rotMatrix = m;\n	return m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY) {\n	#ifdef SCREEN_SPACE\n		vec3 pos = vec3(-1, 0, 0) * quadXY.x + vec3(0, -1, 0) * quadXY.y;\n	#else\n		vec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n	#endif\n	return pos;\n}\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY) {\n	vec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n	return pos;\n}\nvec2 safeNormalize(vec2 v) {\n	float l = length(v);\n	return (l > 1e-06) ? v / l : v;\n}\nvoid main(void) {\n	vec3 meshLocalPos = particle_vertexData.xyz;\n	float id = floor(particle_vertexData.w);\n	float rndFactor = fract(sin(id + 1.0 + seed));\n	vec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n	float uv = id / numParticlesPot;\n	readInput(uv);\n#ifdef LOCAL_SPACE\n	inVel = mat3(matrix_model) * inVel;\n#endif\n	vec2 velocityV = safeNormalize((mat3(matrix_view) * inVel).xy);\n	float particleLifetime = lifetime;\n	if (inLife <= 0.0 || inLife > particleLifetime || !inShow) meshLocalPos = vec3(0.0);\n	vec2 quadXY = meshLocalPos.xy;\n	float nlife = clamp(inLife / particleLifetime, 0.0, 1.0);\n	vec3 paramDiv;\n	vec4 params = tex1Dlod_lerp(TEXTURE_PASS(internalTex2), vec2(nlife, 0), paramDiv);\n	float scale = params.y;\n	float scaleDiv = paramDiv.x;\n	float alphaDiv = paramDiv.z;\n	scale += (scaleDiv * 2.0 - 1.0) * scaleDivMult * fract(rndFactor*10000.0);\n#ifndef USE_MESH\n	texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#else\n	texCoordsAlphaLife = vec4(particle_uv, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#endif\n	vec3 particlePos = inPos;\n	vec3 particlePosMoved = vec3(0.0);\n	mat2 rotMatrix;\n",particleAnimFrameClampVS:"\n	float animFrame = min(floor(texCoordsAlphaLife.w * animTexParams.y) + animTexParams.x, animTexParams.z);\n",particleAnimFrameLoopVS:"\n	float animFrame = floor(mod(texCoordsAlphaLife.w * animTexParams.y + animTexParams.x, animTexParams.z + 1.0));\n",particleAnimTexVS:"\n	float animationIndex;\n	if (animTexIndexParams.y == 1.0) {\n		animationIndex = floor((animTexParams.w + 1.0) * rndFactor3.z) * (animTexParams.z + 1.0);\n	} else {\n		animationIndex = animTexIndexParams.x * (animTexParams.z + 1.0);\n	}\n	float atlasX = (animationIndex + animFrame) * animTexTilesParams.x;\n	float atlasY = 1.0 - floor(atlasX + 1.0) * animTexTilesParams.y;\n	atlasX = fract(atlasX);\n	texCoordsAlphaLife.xy *= animTexTilesParams.xy;\n	texCoordsAlphaLife.xy += vec2(atlasX, atlasY);\n",particleInputFloatPS:"\nvoid readInput(float uv) {\n	vec4 tex = texture2D(particleTexIN, vec2(uv, 0.25));\n	vec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.75));\n	inPos = tex.xyz;\n	inVel = tex2.xyz;\n	inAngle = (tex.w < 0.0? -tex.w : tex.w) - 1000.0;\n	inShow = tex.w >= 0.0;\n	inLife = tex2.w;\n}\n",particleInputRgba8PS:"\n#define PI2 6.283185307179586\nuniform vec3 inBoundsSize;\nuniform vec3 inBoundsCenter;\nuniform float maxVel;\nfloat decodeFloatRG(vec2 rg) {\n	return rg.y*(1.0/255.0) + rg.x;\n}\nfloat decodeFloatRGBA( vec4 rgba ) {\n  return dot( rgba, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) );\n}\nvoid readInput(float uv) {\n	vec4 tex0 = texture2D(particleTexIN, vec2(uv, 0.125));\n	vec4 tex1 = texture2D(particleTexIN, vec2(uv, 0.375));\n	vec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.625));\n	vec4 tex3 = texture2D(particleTexIN, vec2(uv, 0.875));\n	inPos = vec3(decodeFloatRG(tex0.rg), decodeFloatRG(tex0.ba), decodeFloatRG(tex1.rg));\n	inPos = (inPos - vec3(0.5)) * inBoundsSize + inBoundsCenter;\n	inVel = tex2.xyz;\n	inVel = (inVel - vec3(0.5)) * maxVel;\n	inAngle = decodeFloatRG(tex1.ba) * PI2;\n	inShow = tex2.a > 0.5;\n	inLife = decodeFloatRGBA(tex3);\n	float maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n	float maxPosLife = lifetime+1.0;\n	inLife = inLife * (maxNegLife + maxPosLife) - maxNegLife;\n}\n",particleOutputFloatPS:"\nvoid writeOutput() {\n	if (gl_FragCoord.y<1.0) {\n		gl_FragColor = vec4(outPos, (outAngle + 1000.0) * visMode);\n	} else {\n		gl_FragColor = vec4(outVel, outLife);\n	}\n}\n",particleOutputRgba8PS:"\nuniform vec3 outBoundsMul;\nuniform vec3 outBoundsAdd;\nvec2 encodeFloatRG( float v ) {\n	vec2 enc = vec2(1.0, 255.0) * v;\n	enc = fract(enc);\n	enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n	return enc;\n}\nvec4 encodeFloatRGBA( float v ) {\n	vec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * v;\n	enc = fract(enc);\n	enc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n	return enc;\n}\nvoid writeOutput() {\n	outPos = outPos * outBoundsMul + outBoundsAdd;\n	outAngle = fract(outAngle / PI2);\n	outVel = (outVel / maxVel) + vec3(0.5);\n	float maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n	float maxPosLife = lifetime+1.0;\n	outLife = (outLife + maxNegLife) / (maxNegLife + maxPosLife);\n	if (gl_FragCoord.y < 1.0) {\n		gl_FragColor = vec4(encodeFloatRG(outPos.x), encodeFloatRG(outPos.y));\n	} else if (gl_FragCoord.y < 2.0) {\n		gl_FragColor = vec4(encodeFloatRG(outPos.z), encodeFloatRG(outAngle));\n	} else if (gl_FragCoord.y < 3.0) {\n		gl_FragColor = vec4(outVel, visMode*0.5+0.5);\n	} else {\n		gl_FragColor = encodeFloatRGBA(outLife);\n	}\n}\n",particleUpdaterAABBPS:"\nuniform mat3 spawnBounds;\nuniform vec3 spawnPosInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n	vec3 pos = inBounds - vec3(0.5);\n	vec3 posAbs = abs(pos);\n	vec3 maxPos = vec3(max(posAbs.x, max(posAbs.y, posAbs.z)));\n	vec3 edge = maxPos + (vec3(0.5) - maxPos) * spawnPosInnerRatio;\n	pos.x = edge.x * (maxPos.x == posAbs.x ? sign(pos.x) : 2.0 * pos.x);\n	pos.y = edge.y * (maxPos.y == posAbs.y ? sign(pos.y) : 2.0 * pos.y);\n	pos.z = edge.z * (maxPos.z == posAbs.z ? sign(pos.z) : 2.0 * pos.z);\n#ifndef LOCAL_SPACE\n	return emitterPos + spawnBounds * pos;\n#else\n	return spawnBounds * pos;\n#endif\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n	localVelocity -= vec3(0, 0, initialVelocity);\n}\n",particleUpdaterEndPS:"\n	writeOutput();\n}\n",particleUpdaterInitPS:"\nvarying vec2 vUv0;\nuniform highp sampler2D particleTexIN;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\nuniform highp sampler2D internalTex3;\nuniform mat3 emitterMatrix;\nuniform mat3 emitterMatrixInv;\nuniform vec3 emitterScale;\nuniform vec3 emitterPos;\nuniform vec3 frameRandom;\nuniform vec3 localVelocityDivMult;\nuniform vec3 velocityDivMult;\nuniform float delta;\nuniform float rate;\nuniform float rateDiv;\nuniform float lifetime;\nuniform float numParticles;\nuniform float rotSpeedDivMult;\nuniform float radialSpeedDivMult;\nuniform float seed;\nuniform float startAngle;\nuniform float startAngle2;\nuniform float initialVelocity;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\nfloat visMode;\nvec3 outPos;\nvec3 outVel;\nfloat outAngle;\nbool outShow;\nfloat outLife;\n",particleUpdaterNoRespawnPS:"\n	if (outLife >= lifetime) {\n		outLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n		visMode = -1.0;\n	}\n",particleUpdaterOnStopPS:"\n	visMode = outLife < 0.0? -1.0: visMode;\n",particleUpdaterRespawnPS:"\n	if (outLife >= lifetime) {\n		outLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n		visMode = 1.0;\n	}\n	visMode = outLife < 0.0? 1.0: visMode;\n",particleUpdaterSpherePS:"\nuniform float spawnBoundsSphere;\nuniform float spawnBoundsSphereInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n	float rnd4 = fract(rndFactor * 1000.0);\n	vec3 norm = normalize(inBounds.xyz - vec3(0.5));\n	float r = rnd4 * (1.0 - spawnBoundsSphereInnerRatio) + spawnBoundsSphereInnerRatio;\n#ifndef LOCAL_SPACE\n	return emitterPos + norm * r * spawnBoundsSphere;\n#else\n	return norm * r * spawnBoundsSphere;\n#endif\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n	localVelocity += normalize(inBounds - vec3(0.5)) * initialVelocity;\n}\n",particleUpdaterStartPS:"\nfloat saturate(float x) {\n	return clamp(x, 0.0, 1.0);\n}\nvec3 unpack3NFloats(float src) {\n	float r = fract(src);\n	float g = fract(src * 256.0);\n	float b = fract(src * 65536.0);\n	return vec3(r, g, b);\n}\nvec3 tex1Dlod_lerp(TEXTURE_ACCEPT_HIGHP(tex), vec2 tc, out vec3 w) {\n	vec4 a = texture2D(tex, tc);\n	vec4 b = texture2D(tex, tc + graphSampleSize);\n	float c = fract(tc.x * graphNumSamples);\n	vec3 unpackedA = unpack3NFloats(a.w);\n	vec3 unpackedB = unpack3NFloats(b.w);\n	w = mix(unpackedA, unpackedB, c);\n	return mix(a.xyz, b.xyz, c);\n}\n#define HASHSCALE4 vec4(1031, .1030, .0973, .1099)\nvec4 hash41(float p) {\n	vec4 p4 = fract(vec4(p) * HASHSCALE4);\n	p4 += dot(p4, p4.wzxy+19.19);\n	return fract(vec4((p4.x + p4.y)*p4.z, (p4.x + p4.z)*p4.y, (p4.y + p4.z)*p4.w, (p4.z + p4.w)*p4.x));\n}\nvoid main(void) {\n	if (gl_FragCoord.x > numParticles) discard;\n	readInput(vUv0.x);\n	visMode = inShow? 1.0 : -1.0;\n	vec4 rndFactor = hash41(gl_FragCoord.x + seed);\n	float particleRate = rate + rateDiv * rndFactor.x;\n	outLife = inLife + delta;\n	float nlife = clamp(outLife / lifetime, 0.0, 1.0);\n	vec3 localVelocityDiv;\n	vec3 velocityDiv;\n	vec3 paramDiv;\n	vec3 localVelocity = tex1Dlod_lerp(TEXTURE_PASS(internalTex0), vec2(nlife, 0), localVelocityDiv);\n	vec3 velocity =	  tex1Dlod_lerp(TEXTURE_PASS(internalTex1), vec2(nlife, 0), velocityDiv);\n	vec3 params =		tex1Dlod_lerp(TEXTURE_PASS(internalTex2), vec2(nlife, 0), paramDiv);\n	float rotSpeed = params.x;\n	float rotSpeedDiv = paramDiv.y;\n	vec3 radialParams = tex1Dlod_lerp(TEXTURE_PASS(internalTex3), vec2(nlife, 0), paramDiv);\n	float radialSpeed = radialParams.x;\n	float radialSpeedDiv = radialParams.y;\n	bool respawn = inLife <= 0.0 || outLife >= lifetime;\n	inPos = respawn ? calcSpawnPosition(rndFactor.xyz, rndFactor.x) : inPos;\n	inAngle = respawn ? mix(startAngle, startAngle2, rndFactor.x) : inAngle;\n#ifndef LOCAL_SPACE\n	vec3 radialVel = inPos - emitterPos;\n#else\n	vec3 radialVel = inPos;\n#endif\n	radialVel = (dot(radialVel, radialVel) > 1.0E-8) ? radialSpeed * normalize(radialVel) : vec3(0.0);\n	radialVel += (radialSpeedDiv * vec3(2.0) - vec3(1.0)) * radialSpeedDivMult * rndFactor.xyz;\n	localVelocity +=	(localVelocityDiv * vec3(2.0) - vec3(1.0)) * localVelocityDivMult * rndFactor.xyz;\n	velocity +=		 (velocityDiv * vec3(2.0) - vec3(1.0)) * velocityDivMult * rndFactor.xyz;\n	rotSpeed +=		 (rotSpeedDiv * 2.0 - 1.0) * rotSpeedDivMult * rndFactor.y;\n	addInitialVelocity(localVelocity, rndFactor.xyz);\n#ifndef LOCAL_SPACE\n	outVel = emitterMatrix * localVelocity + (radialVel + velocity) * emitterScale;\n#else\n	outVel = (localVelocity + radialVel) / emitterScale + emitterMatrixInv * velocity;\n#endif\n	outPos = inPos + outVel * delta;\n	outAngle = inAngle + rotSpeed * delta;\n",particle_billboardVS:"\n	quadXY = rotate(quadXY, inAngle, rotMatrix);\n	vec3 localPos = billboard(particlePos, quadXY);\n",particle_blendAddPS:"\n	dBlendModeFogFactor = 0.0;\n	rgb *= saturate(gammaCorrectInput(max(a, 0.0)));\n	if ((rgb.r + rgb.g + rgb.b) < 0.000001) discard;\n",particle_blendMultiplyPS:"\n	rgb = mix(vec3(1.0), rgb, vec3(a));\n	if (rgb.r + rgb.g + rgb.b > 2.99) discard;\n",particle_blendNormalPS:"\n	if (a < 0.01) discard;\n",particle_cpuVS:"\nattribute vec4 particle_vertexData;\nattribute vec4 particle_vertexData2;\nattribute vec4 particle_vertexData3;\nattribute float particle_vertexData4;\n#ifndef USE_MESH\nattribute vec2 particle_vertexData5;\n#else\nattribute vec4 particle_vertexData5;\n#endif\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\nuniform float numParticles;\nuniform float lifetime;\nuniform float stretch;\nuniform float seed;\nuniform vec3 wrapBounds;\nuniform vec3 emitterScale;\nuniform vec3 faceTangent;\nuniform vec3 faceBinorm;\n#ifdef PARTICLE_GPU\n	uniform highp sampler2D internalTex0;\n	uniform highp sampler2D internalTex1;\n	uniform highp sampler2D internalTex2;\n#endif\nuniform vec3 emitterPos;\nvarying vec4 texCoordsAlphaLife;\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix)\n{\n	float c = cos(pRotation);\n	float s = sin(pRotation);\n	mat2 m = mat2(c, -s, s, c);\n	rotMatrix = m;\n	return m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY)\n{\n	vec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n	return pos;\n}\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY)\n{\n	vec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n	return pos;\n}\nvoid main(void)\n{\n	vec3 particlePos = particle_vertexData.xyz;\n	vec3 inPos = particlePos;\n	vec3 vertPos = particle_vertexData3.xyz;\n	vec3 inVel = vec3(particle_vertexData2.w, particle_vertexData3.w, particle_vertexData5.x);\n	float id = floor(particle_vertexData4);\n	float rndFactor = fract(sin(id + 1.0 + seed));\n	vec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n#ifdef LOCAL_SPACE\n	inVel = mat3(matrix_model) * inVel;\n#endif\n	vec2 velocityV = normalize((mat3(matrix_view) * inVel).xy);\n	vec2 quadXY = vertPos.xy;\n#ifdef USE_MESH\n	texCoordsAlphaLife = vec4(particle_vertexData5.zw, particle_vertexData2.z, particle_vertexData.w);\n#else\n	texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, particle_vertexData2.z, particle_vertexData.w);\n#endif\n	mat2 rotMatrix;\n	float inAngle = particle_vertexData2.x;\n	vec3 particlePosMoved = vec3(0.0);\n	vec3 meshLocalPos = particle_vertexData3.xyz;\n",particle_cpu_endVS:"\n	localPos *= particle_vertexData2.y * emitterScale;\n	localPos += particlePos;\n	gl_Position = matrix_viewProjection * vec4(localPos, 1.0);\n",particle_customFaceVS:"\n	quadXY = rotate(quadXY, inAngle, rotMatrix);\n	vec3 localPos = customFace(particlePos, quadXY);\n",particle_endPS:"\n	rgb = addFog(rgb);\n	rgb = toneMap(rgb);\n	rgb = gammaCorrectOutput(rgb);\n	gl_FragColor = vec4(rgb, a);\n}\n",particle_endVS:"\n	localPos *= scale * emitterScale;\n	localPos += particlePos;\n	#ifdef SCREEN_SPACE\n	gl_Position = vec4(localPos.x, localPos.y, 0.0, 1.0);\n	#else\n	gl_Position = matrix_viewProjection * vec4(localPos.xyz, 1.0);\n	#endif\n",particle_halflambertPS:"\n	vec3 negNormal = normal*0.5+0.5;\n	vec3 posNormal = -normal*0.5+0.5;\n	negNormal *= negNormal;\n	posNormal *= posNormal;\n",particle_initVS:"\nattribute vec4 particle_vertexData;\n#ifdef USE_MESH\nattribute vec2 particle_uv;\n#endif\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform float numParticles;\nuniform float numParticlesPot;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nuniform float stretch;\nuniform vec3 wrapBounds;\nuniform vec3 emitterScale;\nuniform vec3 emitterPos;\nuniform vec3 faceTangent;\nuniform vec3 faceBinorm;\nuniform float rate;\nuniform float rateDiv;\nuniform float lifetime;\nuniform float deltaRandomnessStatic;\nuniform float scaleDivMult;\nuniform float alphaDivMult;\nuniform float seed;\nuniform float delta;\nuniform sampler2D particleTexOUT;\nuniform sampler2D particleTexIN;\n#ifdef PARTICLE_GPU\n	uniform highp sampler2D internalTex0;\n	uniform highp sampler2D internalTex1;\n	uniform highp sampler2D internalTex2;\n#endif\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nvarying vec4 texCoordsAlphaLife;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\n",particle_lambertPS:"\n	vec3 negNormal = max(normal, vec3(0.0));\n	vec3 posNormal = max(-normal, vec3(0.0));\n",particle_lightingPS:"\n	vec3 light = negNormal.x*lightCube[0] + posNormal.x*lightCube[1] +\n						negNormal.y*lightCube[2] + posNormal.y*lightCube[3] +\n						negNormal.z*lightCube[4] + posNormal.z*lightCube[5];\n	rgb *= light;\n",particle_localShiftVS:"\n	particlePos = (matrix_model * vec4(particlePos, 1.0)).xyz;\n",particle_meshVS:"\n	vec3 localPos = meshLocalPos;\n	localPos.xy = rotate(localPos.xy, inAngle, rotMatrix);\n	localPos.yz = rotate(localPos.yz, inAngle, rotMatrix);\n	billboard(particlePos, quadXY);\n",particle_normalVS:"\n	Normal = normalize(localPos + matrix_viewInverse[2].xyz);\n",particle_normalMapPS:"\n	vec3 normalMap = normalize(texture2D(normalMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y)).xyz * 2.0 - 1.0);\n	vec3 normal = ParticleMat * normalMap;\n",particle_pointAlongVS:"\n	inAngle = atan(velocityV.x, velocityV.y);\n",particle_simulationPS:'\n	#include "particleUpdaterInitPS"\n	#ifdef PACK8\n		#include "particleInputRgba8PS"\n		#include "particleOutputRgba8PS"\n	#else\n		#include "particleInputFloatPS"\n		#include "particleOutputFloatPS"\n	#endif\n	#ifdef EMITTERSHAPE_BOX\n		#include "particleUpdaterAABBPS"\n	#else\n		#include "particleUpdaterSpherePS"\n	#endif\n	#include "particleUpdaterStartPS"\n	#ifdef RESPAWN\n		#include "particleUpdaterRespawnPS"\n	#endif\n	#ifdef NO_RESPAWN\n		#include "particleUpdaterNoRespawnPS"\n	#endif\n	#ifdef ON_STOP\n		#include "particleUpdaterOnStopPS"\n	#endif\n	#include "particleUpdaterEndPS"\n',particle_shaderPS:'\n	#if NORMAL != NONE\n		#if NORMAL == VERTEX\n			varying vec3 Normal;\n		#endif\n		#if NORMAL == MAP\n			varying mat3 ParticleMat;\n		#endif\n		uniform vec3 lightCube[6];\n	#endif\n	#ifdef SOFT\n		varying float vDepth;\n		#include "screenDepthPS"\n	#endif\n	#include "gammaPS"\n	#include "tonemappingPS"\n	#include "fogPS"\n	#if NORMAL == MAP\n		uniform sampler2D normalMap;\n	#endif\n	#include "particlePS"\n	#ifdef SOFT\n		#include "particle_softPS"\n	#endif\n	#if NORMAL == VERTEX\n		vec3 normal = Normal;\n	#endif\n	#if NORMAL == MAP\n		#include "particle_normalMapPS"\n	#endif\n	#if NORMAL != NONE\n		#ifdef HALF_LAMBERT\n			#include "particle_halflambertPS"\n		#else\n			#include "particle_lambertPS"\n		#endif\n		#include "particle_lightingPS"\n	#endif\n	#if BLEND == NORMAL\n		#include "particle_blendNormalPS"\n	#elif BLEND == ADDITIVE\n		#include "particle_blendAddPS"\n	#elif BLEND == MULTIPLICATIVE\n		#include "particle_blendMultiplyPS"\n	#endif\n	#include "particle_endPS"\n',particle_shaderVS:'\n	#ifdef ANIMTEX\n		uniform vec2 animTexTilesParams;\n		uniform vec4 animTexParams;\n		uniform vec2 animTexIndexParams;\n	#endif\n	#if NORMAL == MAP\n		varying mat3 ParticleMat;\n	#endif\n	#if NORMAL == VERTEX\n		varying vec3 Normal;\n	#endif\n	#ifdef SOFT\n		varying float vDepth;\n	#endif\n	#ifdef PARTICLE_GPU\n		#include "particle_initVS"\n		#ifdef PACK8\n			#include "particleInputRgba8PS"\n		#else\n			#include  "particleInputFloatPS"\n		#endif\n		#ifdef SOFT\n			#include "screenDepthPS"\n		#endif\n		#include "particleVS"\n	#else\n		#ifdef SOFT\n			#include "screenDepthPS"\n		#endif\n		#include "particle_cpuVS"\n	#endif\n	#ifdef LOCAL_SPACE\n		#include "particle_localShiftVS"\n	#endif\n	#ifdef ANIMTEX\n		#ifdef ANIMTEX_LOOP\n			#include "particleAnimFrameLoopVS"\n		#else\n			#include "particleAnimFrameClampVS"\n		#endif\n		#include "particleAnimTexVS"\n	#endif\n	#ifdef PARTICLE_GPU\n		#ifdef WRAP\n			#include "particle_wrapVS"\n		#endif\n	#endif\n	#ifdef ALIGN_TO_MOTION\n		#include "particle_pointAlongVS"\n	#endif\n	#ifdef USE_MESH\n		#include "particle_meshVS"\n	#else\n		#ifdef CUSTOM_FACE\n			#include "particle_customFaceVS"\n		#else\n			#include "particle_billboardVS"\n		#endif\n	#endif\n	#if NORMAL == VERTEX\n		#include "particle_normalVS"\n	#endif\n	#if NORMAL == MAP\n		#include "particle_TBNVS"\n	#endif\n	#ifdef STRETCH\n		#include "particle_stretchVS"\n	#endif\n	#ifdef PARTICLE_GPU\n		#include "particle_endVS"\n	#else\n		#include "particle_cpu_endVS"\n	#endif\n	#ifdef SOFT\n		#include "particle_softVS"\n	#endif\n	}\n',particle_softPS:"\n	float depth = getLinearScreenDepth();\n	float particleDepth = vDepth;\n	float depthDiff = saturate(abs(particleDepth - depth) * softening);\n	a *= depthDiff;\n",particle_softVS:"\n	vDepth = getLinearDepth(localPos);\n",particle_stretchVS:"\n	vec3 moveDir = inVel * stretch;\n	vec3 posPrev = particlePos - moveDir;\n	posPrev += particlePosMoved;\n	vec2 centerToVertexV = normalize((mat3(matrix_view) * localPos).xy);\n	float interpolation = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;\n	particlePos = mix(particlePos, posPrev, interpolation);\n",particle_TBNVS:"\n	mat3 rot3 = mat3(rotMatrix[0][0], rotMatrix[0][1], 0.0, rotMatrix[1][0], rotMatrix[1][1], 0.0, 0.0, 0.0, 1.0);\n	ParticleMat = mat3(-matrix_viewInverse[0].xyz, -matrix_viewInverse[1].xyz, matrix_viewInverse[2].xyz) * rot3;\n",particle_wrapVS:"\n	vec3 origParticlePos = particlePos;\n	particlePos -= matrix_model[3].xyz;\n	particlePos = mod(particlePos, wrapBounds) - wrapBounds * 0.5;\n	particlePos += matrix_model[3].xyz;\n	particlePosMoved = particlePos - origParticlePos;\n",pickPS:"\nuniform uint meshInstanceId;\nvec4 getPickOutput() {\n	const vec4 inv = vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0);\n	const uvec4 shifts = uvec4(16, 8, 0, 24);\n	uvec4 col = (uvec4(meshInstanceId) >> shifts) & uvec4(0xff);\n	return vec4(col) * inv;\n}\n",reflDirPS:"\nvoid getReflDir(vec3 worldNormal, vec3 viewDir, float gloss, mat3 tbn) {\n	dReflDirW = normalize(-reflect(viewDir, worldNormal));\n}\n",reflDirAnisoPS:"\nvoid getReflDir(vec3 worldNormal, vec3 viewDir, float gloss, mat3 tbn) {\n	float roughness = sqrt(1.0 - min(gloss, 1.0));\n	float anisotropy = material_anisotropy * roughness;\n	vec3 anisotropicDirection = anisotropy >= 0.0 ? tbn[1] : tbn[0];\n	vec3 anisotropicTangent = cross(anisotropicDirection, viewDir);\n	vec3 anisotropicNormal = cross(anisotropicTangent, anisotropicDirection);\n	vec3 bentNormal = normalize(mix(normalize(worldNormal), normalize(anisotropicNormal), anisotropy));\n	dReflDirW = reflect(-viewDir, bentNormal);\n}\n",reflectionCCPS:"\n#ifdef LIT_CLEARCOAT\nvoid addReflectionCC(vec3 reflDir, float gloss) {\n	ccReflection += calcReflection(reflDir, gloss);\n}\n#endif\n",reflectionCubePS:"\nuniform samplerCube texture_cubeMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 reflDir, float gloss) {\n	vec3 lookupVec = cubeMapProject(reflDir);\n	lookupVec.x *= -1.0;\n	return {reflectionDecode}(textureCube(texture_cubeMap, lookupVec));\n}\nvoid addReflection(vec3 reflDir, float gloss) {   \n	dReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);\n}\n",reflectionEnvHQPS:"\n#ifndef ENV_ATLAS\n#define ENV_ATLAS\nuniform sampler2D texture_envAtlas;\n#endif\nuniform samplerCube texture_cubeMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 reflDir, float gloss) {\n	vec3 dir = cubeMapProject(reflDir) * vec3(-1.0, 1.0, 1.0);\n	vec2 uv = toSphericalUv(dir);\n	float level = saturate(1.0 - gloss) * 5.0;\n	float ilevel = floor(level);\n	float flevel = level - ilevel;\n	vec3 sharp = {reflectionCubemapDecode}(textureCube(texture_cubeMap, dir));\n	vec3 roughA = {reflectionDecode}(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel)));\n	vec3 roughB = {reflectionDecode}(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel + 1.0)));\n	return processEnvironment(mix(sharp, mix(roughA, roughB, flevel), min(level, 1.0)));\n}\nvoid addReflection(vec3 reflDir, float gloss) {   \n	dReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);\n}\n",reflectionEnvPS:"\n#ifndef ENV_ATLAS\n#define ENV_ATLAS\nuniform sampler2D texture_envAtlas;\n#endif\nuniform float material_reflectivity;\nfloat shinyMipLevel(vec2 uv) {\n	vec2 dx = dFdx(uv);\n	vec2 dy = dFdy(uv);\n	vec2 uv2 = vec2(fract(uv.x + 0.5), uv.y);\n	vec2 dx2 = dFdx(uv2);\n	vec2 dy2 = dFdy(uv2);\n	float maxd = min(max(dot(dx, dx), dot(dy, dy)), max(dot(dx2, dx2), dot(dy2, dy2)));\n	return clamp(0.5 * log2(maxd) - 1.0 + textureBias, 0.0, 5.0);\n}\nvec3 calcReflection(vec3 reflDir, float gloss) {\n	vec3 dir = cubeMapProject(reflDir) * vec3(-1.0, 1.0, 1.0);\n	vec2 uv = toSphericalUv(dir);\n	float level = saturate(1.0 - gloss) * 5.0;\n	float ilevel = floor(level);\n	float level2 = shinyMipLevel(uv * atlasSize);\n	float ilevel2 = floor(level2);\n	vec2 uv0, uv1;\n	float weight;\n	if (ilevel == 0.0) {\n		uv0 = mapShinyUv(uv, ilevel2);\n		uv1 = mapShinyUv(uv, ilevel2 + 1.0);\n		weight = level2 - ilevel2;\n	} else {\n		uv0 = uv1 = mapRoughnessUv(uv, ilevel);\n		weight = 0.0;\n	}\n	vec3 linearA = {reflectionDecode}(texture2D(texture_envAtlas, uv0));\n	vec3 linearB = {reflectionDecode}(texture2D(texture_envAtlas, uv1));\n	vec3 linear0 = mix(linearA, linearB, weight);\n	vec3 linear1 = {reflectionDecode}(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel + 1.0)));\n	return processEnvironment(mix(linear0, linear1, level - ilevel));\n}\nvoid addReflection(vec3 reflDir, float gloss) {   \n	dReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);\n}\n",reflectionSpherePS:"\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 reflDir, float gloss) {\n	vec3 reflDirV = (mat3(matrix_view) * reflDir).xyz;\n	float m = 2.0 * sqrt( dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z+1.0)*(reflDirV.z+1.0) );\n	vec2 sphereMapUv = reflDirV.xy / m + 0.5;\n	return {reflectionDecode}(texture2D(texture_sphereMap, sphereMapUv));\n}\nvoid addReflection(vec3 reflDir, float gloss) {   \n	dReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);\n}\n",reflectionSheenPS:"\nvoid addReflectionSheen(vec3 worldNormal, vec3 viewDir, float gloss) {\n	float NoV = dot(worldNormal, viewDir);\n	float alphaG = gloss * gloss;\n	float a = gloss < 0.25 ? -339.2 * alphaG + 161.4 * gloss - 25.9 : -8.48 * alphaG + 14.3 * gloss - 9.95;\n	float b = gloss < 0.25 ? 44.0 * alphaG - 23.7 * gloss + 3.26 : 1.97 * alphaG - 3.27 * gloss + 0.72;\n	float DG = exp( a * NoV + b ) + ( gloss < 0.25 ? 0.0 : 0.1 * ( gloss - 0.25 ) );\n	sReflection += calcReflection(worldNormal, 0.0) * saturate(DG);\n}\n",refractionCubePS:"\nvec3 refract2(vec3 viewVec, vec3 normal, float IOR) {\n	float vn = dot(viewVec, normal);\n	float k = 1.0 - IOR * IOR * (1.0 - vn * vn);\n	vec3 refrVec = IOR * viewVec - (IOR * vn + sqrt(k)) * normal;\n	return refrVec;\n}\nvoid addRefraction(\n	vec3 worldNormal, \n	vec3 viewDir, \n	float thickness, \n	float gloss, \n	vec3 specularity, \n	vec3 albedo, \n	float transmission,\n	float refractionIndex,\n	float dispersion\n#if defined(LIT_IRIDESCENCE)\n	, vec3 iridescenceFresnel,\n	float iridescenceIntensity\n#endif \n) {\n	vec4 tmpRefl = dReflection;\n	vec3 reflectionDir = refract2(-viewDir, worldNormal, refractionIndex);\n	dReflection = vec4(0);\n	addReflection(reflectionDir, gloss);\n	dDiffuseLight = mix(dDiffuseLight, dReflection.rgb * albedo, transmission);\n	dReflection = tmpRefl;\n}\n",refractionDynamicPS:"\nuniform float material_invAttenuationDistance;\nuniform vec3 material_attenuation;\nvec3 evalRefractionColor(vec3 refractionVector, float gloss, float refractionIndex) {\n	vec4 pointOfRefraction = vec4(vPositionW + refractionVector, 1.0);\n	vec4 projectionPoint = matrix_viewProjection * pointOfRefraction;\n	vec2 uv = getGrabScreenPos(projectionPoint);\n	float iorToRoughness = (1.0 - gloss) * clamp((1.0 / refractionIndex) * 2.0 - 2.0, 0.0, 1.0);\n	float refractionLod = log2(uScreenSize.x) * iorToRoughness;\n	vec3 refraction = texture2DLod(uSceneColorMap, uv, refractionLod).rgb;\n	return refraction;\n}\nvoid addRefraction(\n	vec3 worldNormal, \n	vec3 viewDir, \n	float thickness, \n	float gloss, \n	vec3 specularity, \n	vec3 albedo, \n	float transmission,\n	float refractionIndex,\n	float dispersion\n#if defined(LIT_IRIDESCENCE)\n	, vec3 iridescenceFresnel,\n	float iridescenceIntensity\n#endif\n) {\n	vec3 modelScale;\n	modelScale.x = length(vec3(matrix_model[0].xyz));\n	modelScale.y = length(vec3(matrix_model[1].xyz));\n	modelScale.z = length(vec3(matrix_model[2].xyz));\n	vec3 scale = thickness * modelScale;\n	vec3 refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndex)) * scale;\n	vec3 refraction = evalRefractionColor(refractionVector, gloss, refractionIndex);\n	#ifdef LIT_DISPERSION\n		float halfSpread = (1.0 / refractionIndex - 1.0) * 0.025 * dispersion;\n		float refractionIndexR = refractionIndex - halfSpread;\n		refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndexR)) * scale;\n		refraction.r = evalRefractionColor(refractionVector, gloss, refractionIndexR).r;\n		float refractionIndexB = refractionIndex + halfSpread;\n		refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndexB)) * scale;\n		refraction.b = evalRefractionColor(refractionVector, gloss, refractionIndexB).b;\n	#endif\n	vec3 transmittance;\n	if (material_invAttenuationDistance != 0.0)\n	{\n		vec3 attenuation = -log(material_attenuation) * material_invAttenuationDistance;\n		transmittance = exp(-attenuation * length(refractionVector));\n	}\n	else\n	{\n		transmittance = refraction;\n	}\n	vec3 fresnel = vec3(1.0) - \n		getFresnel(\n			dot(viewDir, worldNormal), \n			gloss, \n			specularity\n		#if defined(LIT_IRIDESCENCE)\n			, iridescenceFresnel,\n			iridescenceIntensity\n		#endif\n		);\n	dDiffuseLight = mix(dDiffuseLight, refraction * transmittance * fresnel, transmission);\n}\n",reprojectPS:'\nvarying vec2 vUv0;\n#ifdef CUBEMAP_SOURCE\n	uniform samplerCube sourceCube;\n#else\n	uniform sampler2D sourceTex;\n#endif\n#ifdef USE_SAMPLES_TEX\n	uniform sampler2D samplesTex;\n	uniform vec2 samplesTexInverseSize;\n#endif\nuniform vec3 params;\nfloat targetFace() { return params.x; }\nfloat targetTotalPixels() { return params.y; }\nfloat sourceTotalPixels() { return params.z; }\nfloat PI = 3.141592653589793;\nfloat saturate(float x) {\n	return clamp(x, 0.0, 1.0);\n}\n#include "decodePS"\n#include "encodePS"\nvec3 modifySeams(vec3 dir, float scale) {\n	vec3 adir = abs(dir);\n	float M = max(max(adir.x, adir.y), adir.z);\n	return dir / M * vec3(\n		adir.x == M ? 1.0 : scale,\n		adir.y == M ? 1.0 : scale,\n		adir.z == M ? 1.0 : scale\n	);\n}\nvec2 toSpherical(vec3 dir) {\n	return vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));\n}\nvec3 fromSpherical(vec2 uv) {\n	return vec3(cos(uv.y) * sin(uv.x),\n				sin(uv.y),\n				cos(uv.y) * cos(uv.x));\n}\nvec3 getDirectionEquirect() {\n	return fromSpherical((vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0) * vec2(PI, PI * 0.5));\n}\nfloat signNotZero(float k){\n	return(k >= 0.0) ? 1.0 : -1.0;\n}\nvec2 signNotZero(vec2 v) {\n	return vec2(signNotZero(v.x), signNotZero(v.y));\n}\nvec3 octDecode(vec2 o) {\n	vec3 v = vec3(o.x, 1.0 - abs(o.x) - abs(o.y), o.y);\n	if (v.y < 0.0) {\n		v.xz = (1.0 - abs(v.zx)) * signNotZero(v.xz);\n	}\n	return normalize(v);\n}\nvec3 getDirectionOctahedral() {\n	return octDecode(vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0);\n}\nvec2 octEncode(in vec3 v) {\n	float l1norm = abs(v.x) + abs(v.y) + abs(v.z);\n	vec2 result = v.xz * (1.0 / l1norm);\n	if (v.y < 0.0) {\n		result = (1.0 - abs(result.yx)) * signNotZero(result.xy);\n	}\n	return result;\n}\n#ifdef CUBEMAP_SOURCE\n	vec4 sampleCubemap(vec3 dir) {\n		return textureCube(sourceCube, modifySeams(dir, 1.0));\n	}\n	vec4 sampleCubemap(vec2 sph) {\n		return sampleCubemap(fromSpherical(sph));\n	}\n	vec4 sampleCubemap(vec3 dir, float mipLevel) {\n		return textureCubeLod(sourceCube, modifySeams(dir, 1.0), mipLevel);\n	}\n	vec4 sampleCubemap(vec2 sph, float mipLevel) {\n		return sampleCubemap(fromSpherical(sph), mipLevel);\n	}\n#else\n	vec4 sampleEquirect(vec2 sph) {\n		vec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;\n		return texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n	}\n	vec4 sampleEquirect(vec3 dir) {\n		return sampleEquirect(toSpherical(dir));\n	}\n	vec4 sampleEquirect(vec2 sph, float mipLevel) {\n		vec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;\n		return texture2DLod(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);\n	}\n	vec4 sampleEquirect(vec3 dir, float mipLevel) {\n		return sampleEquirect(toSpherical(dir), mipLevel);\n	}\n	vec4 sampleOctahedral(vec3 dir) {\n		vec2 uv = octEncode(dir) * 0.5 + 0.5;\n		return texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n	}\n	vec4 sampleOctahedral(vec2 sph) {\n		return sampleOctahedral(fromSpherical(sph));\n	}\n	vec4 sampleOctahedral(vec3 dir, float mipLevel) {\n		vec2 uv = octEncode(dir) * 0.5 + 0.5;\n		return texture2DLod(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);\n	}\n	vec4 sampleOctahedral(vec2 sph, float mipLevel) {\n		return sampleOctahedral(fromSpherical(sph), mipLevel);\n	}\n#endif\nvec3 getDirectionCubemap() {\n	vec2 st = vUv0 * 2.0 - 1.0;\n	float face = targetFace();\n	vec3 vec;\n	if (face == 0.0) {\n		vec = vec3(1, -st.y, -st.x);\n	} else if (face == 1.0) {\n		vec = vec3(-1, -st.y, st.x);\n	} else if (face == 2.0) {\n		vec = vec3(st.x, 1, st.y);\n	} else if (face == 3.0) {\n		vec = vec3(st.x, -1, -st.y);\n	} else if (face == 4.0) {\n		vec = vec3(st.x, -st.y, 1);\n	} else {\n		vec = vec3(-st.x, -st.y, -1);\n	}\n	return normalize(modifySeams(vec, 1.0));\n}\nmat3 matrixFromVector(vec3 n) {\n	float a = 1.0 / (1.0 + n.z);\n	float b = -n.x * n.y * a;\n	vec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n	vec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n	return mat3(b1, b2, n);\n}\nmat3 matrixFromVectorSlow(vec3 n) {\n	vec3 up = (1.0 - abs(n.y) <= 0.0000001) ? vec3(0.0, 0.0, n.y > 0.0 ? 1.0 : -1.0) : vec3(0.0, 1.0, 0.0);\n	vec3 x = normalize(cross(up, n));\n	vec3 y = cross(n, x);\n	return mat3(x, y, n);\n}\nvec4 reproject() {\n	if ({NUM_SAMPLES} <= 1) {\n		return {ENCODE_FUNC}({DECODE_FUNC}({SOURCE_FUNC}({TARGET_FUNC}())));\n	} else {\n		vec3 t = {TARGET_FUNC}();\n		vec3 tu = dFdx(t);\n		vec3 tv = dFdy(t);\n		vec3 result = vec3(0.0);\n		for (float u = 0.0; u < {NUM_SAMPLES_SQRT}; ++u) {\n			for (float v = 0.0; v < {NUM_SAMPLES_SQRT}; ++v) {\n				result += {DECODE_FUNC}({SOURCE_FUNC}(normalize(t +\n															tu * (u / {NUM_SAMPLES_SQRT} - 0.5) +\n															tv * (v / {NUM_SAMPLES_SQRT} - 0.5))));\n			}\n		}\n		return {ENCODE_FUNC}(result / ({NUM_SAMPLES_SQRT} * {NUM_SAMPLES_SQRT}));\n	}\n}\nvec4 unpackFloat = vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0);\n#ifdef USE_SAMPLES_TEX\n	void unpackSample(int i, out vec3 L, out float mipLevel) {\n		float u = (float(i * 4) + 0.5) * samplesTexInverseSize.x;\n		float v = (floor(u) + 0.5) * samplesTexInverseSize.y;\n		vec4 raw;\n		raw.x = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n		raw.y = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n		raw.z = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n		raw.w = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat);\n		L.xyz = raw.xyz * 2.0 - 1.0;\n		mipLevel = raw.w * 8.0;\n	}\n	vec4 prefilterSamples() {\n		mat3 vecSpace = matrixFromVectorSlow({TARGET_FUNC}());\n		vec3 L;\n		float mipLevel;\n		vec3 result = vec3(0.0);\n		float totalWeight = 0.0;\n		for (int i = 0; i < {NUM_SAMPLES}; ++i) {\n			unpackSample(i, L, mipLevel);\n			result += {DECODE_FUNC}({SOURCE_FUNC}(vecSpace * L, mipLevel)) * L.z;\n			totalWeight += L.z;\n		}\n		return {ENCODE_FUNC}(result / totalWeight);\n	}\n	vec4 prefilterSamplesUnweighted() {\n		mat3 vecSpace = matrixFromVectorSlow({TARGET_FUNC}());\n		vec3 L;\n		float mipLevel;\n		vec3 result = vec3(0.0);\n		float totalWeight = 0.0;\n		for (int i = 0; i < {NUM_SAMPLES}; ++i) {\n			unpackSample(i, L, mipLevel);\n			result += {DECODE_FUNC}({SOURCE_FUNC}(vecSpace * L, mipLevel));\n		}\n		return {ENCODE_FUNC}(result / float({NUM_SAMPLES}));\n	}\n#endif\nvoid main(void) {\n	gl_FragColor = {PROCESS_FUNC}();\n}\n',reprojectVS:"\nattribute vec2 vertex_position;\nuniform vec4 uvMod;\nvarying vec2 vUv0;\nvoid main(void) {\n	gl_Position = vec4(vertex_position, 0.5, 1.0);\n	vUv0 = getImageEffectUV((vertex_position.xy * 0.5 + 0.5) * uvMod.xy + uvMod.zw);\n}\n",sampleCatmullRomPS:"\nvec4 SampleTextureCatmullRom(TEXTURE_ACCEPT(tex), vec2 uv, vec2 texSize) {\n	vec2 samplePos = uv * texSize;\n	vec2 texPos1 = floor(samplePos - 0.5) + 0.5;\n	vec2 f = samplePos - texPos1;\n	vec2 w0 = f * (-0.5 + f * (1.0 - 0.5 * f));\n	vec2 w1 = 1.0 + f * f * (-2.5 + 1.5 * f);\n	vec2 w2 = f * (0.5 + f * (2.0 - 1.5 * f));\n	vec2 w3 = f * f * (-0.5 + 0.5 * f);\n	vec2 w12 = w1 + w2;\n	vec2 offset12 = w2 / (w1 + w2);\n	vec2 texPos0 = (texPos1 - 1.0) / texSize;\n	vec2 texPos3 = (texPos1 + 2.0) / texSize;\n	vec2 texPos12 = (texPos1 + offset12) / texSize;\n	vec4 result = vec4(0.0);\n	result += texture2DLod(tex, vec2(texPos0.x, texPos0.y), 0.0) * w0.x * w0.y;\n	result += texture2DLod(tex, vec2(texPos12.x, texPos0.y), 0.0) * w12.x * w0.y;\n	result += texture2DLod(tex, vec2(texPos3.x, texPos0.y), 0.0) * w3.x * w0.y;\n	result += texture2DLod(tex, vec2(texPos0.x, texPos12.y), 0.0) * w0.x * w12.y;\n	result += texture2DLod(tex, vec2(texPos12.x, texPos12.y), 0.0) * w12.x * w12.y;\n	result += texture2DLod(tex, vec2(texPos3.x, texPos12.y), 0.0) * w3.x * w12.y;\n	result += texture2DLod(tex, vec2(texPos0.x, texPos3.y), 0.0) * w0.x * w3.y;\n	result += texture2DLod(tex, vec2(texPos12.x, texPos3.y), 0.0) * w12.x * w3.y;\n	result += texture2DLod(tex, vec2(texPos3.x, texPos3.y), 0.0) * w3.x * w3.y;\n	return result;\n}\n",screenDepthPS:"\nuniform highp sampler2D uSceneDepthMap;\n#ifndef SCREENSIZE\n#define SCREENSIZE\nuniform vec4 uScreenSize;\n#endif\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n#ifndef LINEARIZE_DEPTH\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\n#define LINEARIZE_DEPTH\nfloat linearizeDepth(float z) {\n	if (camera_params.w == 0.0)\n		return (camera_params.z * camera_params.y) / (camera_params.y + z * (camera_params.z - camera_params.y));\n	else\n		return camera_params.z + z * (camera_params.y - camera_params.z);\n}\n#endif\nfloat delinearizeDepth(float linearDepth) {\n	if (camera_params.w == 0.0) {\n		return (camera_params.y * (camera_params.z - linearDepth)) / (linearDepth * (camera_params.z - camera_params.y));\n	} else {\n		return (linearDepth - camera_params.z) / (camera_params.y - camera_params.z);\n	}\n}\nfloat getLinearScreenDepth(vec2 uv) {\n	#ifdef SCENE_DEPTHMAP_LINEAR\n		#ifdef SCENE_DEPTHMAP_FLOAT\n			return texture2D(uSceneDepthMap, uv).r;\n		#else\n			ivec2 textureSize = textureSize(uSceneDepthMap, 0);\n			ivec2 texel = ivec2(uv * vec2(textureSize));\n			vec4 data = texelFetch(uSceneDepthMap, texel, 0);\n			uint intBits = \n				(uint(data.r * 255.0) << 24u) |\n				(uint(data.g * 255.0) << 16u) |\n				(uint(data.b * 255.0) << 8u) |\n				uint(data.a * 255.0);\n			return uintBitsToFloat(intBits);\n		#endif\n	#else\n		return linearizeDepth(texture2D(uSceneDepthMap, uv).r);\n	#endif\n}\n#ifndef VERTEXSHADER\nfloat getLinearScreenDepth() {\n	vec2 uv = gl_FragCoord.xy * uScreenSize.zw;\n	return getLinearScreenDepth(uv);\n}\n#endif\nfloat getLinearDepth(vec3 pos) {\n	return -(matrix_view * vec4(pos, 1.0)).z;\n}\n",shadowCascadesPS:"\nint getShadowCascadeIndex(vec4 shadowCascadeDistances, int shadowCascadeCount) {\n	float depth = 1.0 / gl_FragCoord.w;\n	vec4 comparisons = step(shadowCascadeDistances, vec4(depth));\n	int cascadeIndex = int(dot(comparisons, vec4(1.0)));\n	return min(cascadeIndex, shadowCascadeCount - 1);\n}\nint ditherShadowCascadeIndex(int cascadeIndex, vec4 shadowCascadeDistances, int shadowCascadeCount, float blendFactor) {\n \n	if (cascadeIndex < shadowCascadeCount - 1) {\n		float currentRangeEnd = shadowCascadeDistances[cascadeIndex];\n		float transitionStart = blendFactor * currentRangeEnd;\n		float depth = 1.0 / gl_FragCoord.w;\n		if (depth > transitionStart) {\n			float transitionFactor = smoothstep(transitionStart, currentRangeEnd, depth);\n			float dither = fract(sin(dot(gl_FragCoord.xy, vec2(12.9898, 78.233))) * 43758.5453);\n			if (dither < transitionFactor) {\n				cascadeIndex += 1;\n			}\n		}\n	}\n	return cascadeIndex;\n}\nvec3 fadeShadow(vec3 shadowCoord, vec4 shadowCascadeDistances) {				  \n	float depth = 1.0 / gl_FragCoord.w;\n	if (depth > shadowCascadeDistances.w) {\n		shadowCoord.z = -9999999.0;\n	}\n	return shadowCoord;\n}\n",shadowEVSMPS:"\nfloat linstep(float a, float b, float v) {\n	return saturate((v - a) / (b - a));\n}\nfloat reduceLightBleeding(float pMax, float amount) {\n   return linstep(amount, 1.0, pMax);\n}\nfloat chebyshevUpperBound(vec2 moments, float mean, float minVariance, float lightBleedingReduction) {\n	float variance = moments.y - (moments.x * moments.x);\n	variance = max(variance, minVariance);\n	float d = mean - moments.x;\n	float pMax = variance / (variance + (d * d));\n	pMax = reduceLightBleeding(pMax, lightBleedingReduction);\n	return (mean <= moments.x ? 1.0 : pMax);\n}\nfloat calculateEVSM(vec3 moments, float Z, float vsmBias, float exponent) {\n	Z = 2.0 * Z - 1.0;\n	float warpedDepth = exp(exponent * Z);\n	moments.xy += vec2(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments.z);\n	float VSMBias = vsmBias;\n	float depthScale = VSMBias * exponent * warpedDepth;\n	float minVariance1 = depthScale * depthScale;\n	return chebyshevUpperBound(moments.xy, warpedDepth, minVariance1, 0.1);\n}\nfloat VSM16(TEXTURE_ACCEPT(tex), vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n	vec3 moments = texture2DLod(tex, texCoords, 0.0).xyz;\n	return calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM16(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent) {\n	return VSM16(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM16(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {\n	return VSM16(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, length(lightDir) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\nfloat VSM32(TEXTURE_ACCEPT(tex), vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n	#ifdef CAPS_TEXTURE_FLOAT_FILTERABLE\n		vec3 moments = texture2DLod(tex, texCoords, 0.0).xyz;\n	#else\n		float pixelSize = 1.0 / resolution;\n		texCoords -= vec2(pixelSize);\n		vec3 s00 = texture2DLod(tex, texCoords, 0.0).xyz;\n		vec3 s10 = texture2DLod(tex, texCoords + vec2(pixelSize, 0), 0.0).xyz;\n		vec3 s01 = texture2DLod(tex, texCoords + vec2(0, pixelSize), 0.0).xyz;\n		vec3 s11 = texture2DLod(tex, texCoords + vec2(pixelSize), 0.0).xyz;\n		vec2 fr = fract(texCoords * resolution);\n		vec3 h0 = mix(s00, s10, fr.x);\n		vec3 h1 = mix(s01, s11, fr.x);\n		vec3 moments = mix(h0, h1, fr.y);\n	#endif\n	return calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM32(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent) {\n	return VSM32(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM32(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {\n	return VSM32(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, length(lightDir) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n",shadowPCF1PS:"\nfloat getShadowPCF1x1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n	return textureShadow(shadowMap, shadowCoord);\n}\nfloat getShadowSpotPCF1x1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n	return textureShadow(shadowMap, shadowCoord);\n}\n#ifndef WEBGPU\nfloat getShadowOmniPCF1x1(samplerCubeShadow shadowMap, vec3 shadowCoord, vec4 shadowParams, vec3 lightDir) {\n	float shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n	return texture(shadowMap, vec4(lightDir, shadowZ));\n}\n#endif\n",shadowPCF3PS:"\nfloat _getShadowPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec3 shadowParams) {\n	float z = shadowCoord.z;\n	vec2 uv = shadowCoord.xy * shadowParams.x;\n	float shadowMapSizeInv = 1.0 / shadowParams.x;\n	vec2 base_uv = floor(uv + 0.5);\n	float s = (uv.x + 0.5 - base_uv.x);\n	float t = (uv.y + 0.5 - base_uv.y);\n	base_uv -= vec2(0.5);\n	base_uv *= shadowMapSizeInv;\n	float sum = 0.0;\n	float uw0 = (3.0 - 2.0 * s);\n	float uw1 = (1.0 + 2.0 * s);\n	float u0 = (2.0 - s) / uw0 - 1.0;\n	float u1 = s / uw1 + 1.0;\n	float vw0 = (3.0 - 2.0 * t);\n	float vw1 = (1.0 + 2.0 * t);\n	float v0 = (2.0 - t) / vw0 - 1.0;\n	float v1 = t / vw1 + 1.0;\n	u0 = u0 * shadowMapSizeInv + base_uv.x;\n	v0 = v0 * shadowMapSizeInv + base_uv.y;\n	u1 = u1 * shadowMapSizeInv + base_uv.x;\n	v1 = v1 * shadowMapSizeInv + base_uv.y;\n	sum += uw0 * vw0 * textureShadow(shadowMap, vec3(u0, v0, z));\n	sum += uw1 * vw0 * textureShadow(shadowMap, vec3(u1, v0, z));\n	sum += uw0 * vw1 * textureShadow(shadowMap, vec3(u0, v1, z));\n	sum += uw1 * vw1 * textureShadow(shadowMap, vec3(u1, v1, z));\n	sum *= 1.0f / 16.0;\n	return sum;\n}\nfloat getShadowPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n	return _getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);\n}\nfloat getShadowSpotPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n	return _getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);\n}\n#ifndef WEBGPU\nfloat getShadowOmniPCF3x3(samplerCubeShadow shadowMap, vec4 shadowParams, vec3 dir) {\n	\n	float shadowZ = length(dir) * shadowParams.w + shadowParams.z;\n	float z = 1.0 / float(textureSize(shadowMap, 0));\n	vec3 tc = normalize(dir);\n	mediump vec4 shadows;\n	shadows.x = texture(shadowMap, vec4(tc + vec3( z, z, z), shadowZ));\n	shadows.y = texture(shadowMap, vec4(tc + vec3(-z,-z, z), shadowZ));\n	shadows.z = texture(shadowMap, vec4(tc + vec3(-z, z,-z), shadowZ));\n	shadows.w = texture(shadowMap, vec4(tc + vec3( z,-z,-z), shadowZ));\n	return dot(shadows, vec4(0.25));\n}\nfloat getShadowOmniPCF3x3(samplerCubeShadow shadowMap, vec3 shadowCoord, vec4 shadowParams, vec3 lightDir) {\n	return getShadowOmniPCF3x3(shadowMap, shadowParams, lightDir);\n}\n#endif\n",shadowPCF5PS:"\nfloat _getShadowPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec3 shadowParams) {\n	float z = shadowCoord.z;\n	vec2 uv = shadowCoord.xy * shadowParams.x;\n	float shadowMapSizeInv = 1.0 / shadowParams.x;\n	vec2 base_uv = floor(uv + 0.5);\n	float s = (uv.x + 0.5 - base_uv.x);\n	float t = (uv.y + 0.5 - base_uv.y);\n	base_uv -= vec2(0.5);\n	base_uv *= shadowMapSizeInv;\n	float uw0 = (4.0 - 3.0 * s);\n	float uw1 = 7.0;\n	float uw2 = (1.0 + 3.0 * s);\n	float u0 = (3.0 - 2.0 * s) / uw0 - 2.0;\n	float u1 = (3.0 + s) / uw1;\n	float u2 = s / uw2 + 2.0;\n	float vw0 = (4.0 - 3.0 * t);\n	float vw1 = 7.0;\n	float vw2 = (1.0 + 3.0 * t);\n	float v0 = (3.0 - 2.0 * t) / vw0 - 2.0;\n	float v1 = (3.0 + t) / vw1;\n	float v2 = t / vw2 + 2.0;\n	float sum = 0.0;\n	u0 = u0 * shadowMapSizeInv + base_uv.x;\n	v0 = v0 * shadowMapSizeInv + base_uv.y;\n	u1 = u1 * shadowMapSizeInv + base_uv.x;\n	v1 = v1 * shadowMapSizeInv + base_uv.y;\n	u2 = u2 * shadowMapSizeInv + base_uv.x;\n	v2 = v2 * shadowMapSizeInv + base_uv.y;\n	sum += uw0 * vw0 * textureShadow(shadowMap, vec3(u0, v0, z));\n	sum += uw1 * vw0 * textureShadow(shadowMap, vec3(u1, v0, z));\n	sum += uw2 * vw0 * textureShadow(shadowMap, vec3(u2, v0, z));\n	sum += uw0 * vw1 * textureShadow(shadowMap, vec3(u0, v1, z));\n	sum += uw1 * vw1 * textureShadow(shadowMap, vec3(u1, v1, z));\n	sum += uw2 * vw1 * textureShadow(shadowMap, vec3(u2, v1, z));\n	sum += uw0 * vw2 * textureShadow(shadowMap, vec3(u0, v2, z));\n	sum += uw1 * vw2 * textureShadow(shadowMap, vec3(u1, v2, z));\n	sum += uw2 * vw2 * textureShadow(shadowMap, vec3(u2, v2, z));\n	sum *= 1.0f / 144.0;\n	sum = saturate(sum);\n	return sum;\n}\nfloat getShadowPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n	return _getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);\n}\nfloat getShadowSpotPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n	return _getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);\n}\n",shadowPCSSPS:"\n#define PCSS_SAMPLE_COUNT 16\nuniform float pcssDiskSamples[PCSS_SAMPLE_COUNT];\nuniform float pcssSphereSamples[PCSS_SAMPLE_COUNT];\nvec2 vogelDisk(int sampleIndex, float count, float phi, float r) {\n	const float GoldenAngle = 2.4;\n	float theta = float(sampleIndex) * GoldenAngle + phi;\n	float sine = sin(theta);\n	float cosine = cos(theta);\n	return vec2(r * cosine, r * sine);\n}\nvec3 vogelSphere(int sampleIndex, float count, float phi, float r) {\n	const float GoldenAngle = 2.4;\n	float theta = float(sampleIndex) * GoldenAngle + phi;\n	float weight = float(sampleIndex) / count;\n	return vec3(cos(theta) * r, weight, sin(theta) * r);\n}\nfloat noise(vec2 screenPos) {\n	const float PHI = 1.61803398874989484820459;\n	return fract(sin(dot(screenPos * PHI, screenPos)) * screenPos.x);\n}\nfloat viewSpaceDepth(float depth, mat4 invProjection) {\n	float z = depth * 2.0 - 1.0;\n	vec4 clipSpace = vec4(0.0, 0.0, z, 1.0);\n	vec4 viewSpace = invProjection * clipSpace;\n	return viewSpace.z;\n}\nfloat PCSSBlockerDistance(TEXTURE_ACCEPT(shadowMap), vec2 sampleCoords[PCSS_SAMPLE_COUNT], vec2 shadowCoords, vec2 searchSize, float z, vec4 cameraParams) {\n	float blockers = 0.0;\n	float averageBlocker = 0.0;\n	for (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {\n		vec2 offset = sampleCoords[i] * searchSize;\n		vec2 sampleUV = shadowCoords + offset;\n		float blocker = texture2DLod(shadowMap, sampleUV, 0.0).r;\n		float isBlocking = step(blocker, z);\n		blockers += isBlocking;\n		averageBlocker += blocker * isBlocking;\n	}\n	if (blockers > 0.0)\n		return averageBlocker / blockers;\n	return -1.0;\n}\nfloat PCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoords, vec4 cameraParams, vec2 shadowSearchArea) {\n	float receiverDepth = linearizeDepth(shadowCoords.z, cameraParams);\n	vec2 samplePoints[PCSS_SAMPLE_COUNT];\n	const float PI = 3.141592653589793;\n	float noise = noise( gl_FragCoord.xy ) * 2.0 * PI;\n	for (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {\n		float pcssPresample = pcssDiskSamples[i];\n		samplePoints[i] = vogelDisk(i, float(PCSS_SAMPLE_COUNT), noise, pcssPresample);\n	}\n	float averageBlocker = PCSSBlockerDistance(TEXTURE_PASS(shadowMap), samplePoints, shadowCoords.xy, shadowSearchArea, receiverDepth, cameraParams);\n	if (averageBlocker == -1.0) {\n		return 1.0;\n	} else {\n		float depthDifference = (receiverDepth - averageBlocker) / 3.0;\n		vec2 filterRadius = depthDifference * shadowSearchArea;\n		float shadow = 0.0;\n		for (int i = 0; i < PCSS_SAMPLE_COUNT; i ++)\n		{\n			vec2 sampleUV = samplePoints[i] * filterRadius;\n			sampleUV = shadowCoords.xy + sampleUV;\n			float depth = texture2DLod(shadowMap, sampleUV, 0.0).r;\n			shadow += step(receiverDepth, depth);\n		}\n		return shadow / float(PCSS_SAMPLE_COUNT);\n	} \n}\n#ifndef WEBGPU\nfloat PCSSCubeBlockerDistance(samplerCube shadowMap, vec3 lightDirNorm, vec3 samplePoints[PCSS_SAMPLE_COUNT], float z, float shadowSearchArea) {\n	float blockers = 0.0;\n	float averageBlocker = 0.0;\n	for (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {\n		vec3 sampleDir = lightDirNorm + samplePoints[i] * shadowSearchArea;\n		sampleDir = normalize(sampleDir);\n		float blocker = textureCubeLod(shadowMap, sampleDir, 0.0).r;\n		float isBlocking = step(blocker, z);\n		blockers += isBlocking;\n		averageBlocker += blocker * isBlocking;\n	}\n	if (blockers > 0.0)\n		return averageBlocker / blockers;\n	return -1.0;\n}\nfloat PCSSCube(samplerCube shadowMap, vec4 shadowParams, vec3 shadowCoords, vec4 cameraParams, float shadowSearchArea, vec3 lightDir) {\n	\n	vec3 samplePoints[PCSS_SAMPLE_COUNT];\n	const float PI = 3.141592653589793;\n	float noise = noise( gl_FragCoord.xy ) * 2.0 * PI;\n	for (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {\n		float r = pcssSphereSamples[i];\n		samplePoints[i] = vogelSphere(i, float(PCSS_SAMPLE_COUNT), noise, r);\n	}\n	float receiverDepth = length(lightDir) * shadowParams.w + shadowParams.z;\n	vec3 lightDirNorm = normalize(lightDir);\n	\n	float averageBlocker = PCSSCubeBlockerDistance(shadowMap, lightDirNorm, samplePoints, receiverDepth, shadowSearchArea);\n	if (averageBlocker == -1.0) {\n		return 1.0;\n	} else {\n		float filterRadius = ((receiverDepth - averageBlocker) / averageBlocker) * shadowSearchArea;\n		float shadow = 0.0;\n		for (int i = 0; i < PCSS_SAMPLE_COUNT; i++)\n		{\n			vec3 offset = samplePoints[i] * filterRadius;\n			vec3 sampleDir = lightDirNorm + offset;\n			sampleDir = normalize(sampleDir);\n			float depth = textureCubeLod(shadowMap, sampleDir, 0.0).r;\n			shadow += step(receiverDepth, depth);\n		}\n		return shadow / float(PCSS_SAMPLE_COUNT);\n	}\n}\nfloat getShadowOmniPCSS(samplerCube shadowMap, vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec2 shadowSearchArea, vec3 lightDir) {\n	return PCSSCube(shadowMap, shadowParams, shadowCoord, cameraParams, shadowSearchArea.x, lightDir);\n}\n#endif\nfloat getShadowSpotPCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec2 shadowSearchArea, vec3 lightDir) {\n	return PCSS(TEXTURE_PASS(shadowMap), shadowCoord, cameraParams, shadowSearchArea);\n}\n",shadowSoftPS:"\nhighp float fractSinRand( const in vec2 uv ) {\n	const float PI = 3.141592653589793;\n	const highp float a = 12.9898, b = 78.233, c = 43758.5453;\n	highp float dt = dot(uv.xy, vec2(a, b)), sn = mod(dt, PI);\n	return fract(sin(sn) * c);\n}\nstruct VogelDiskData {\n	float invNumSamples;\n	float initialAngle;\n	float currentPointId;\n};\nvoid prepareDiskConstants(out VogelDiskData data, int sampleCount, int numRings, float randomSeed) {\n	const float pi2 = 6.28318530718;\n	data.invNumSamples = 1.0 / float(sampleCount);\n	data.initialAngle = randomSeed * pi2;\n	data.currentPointId = 0.0;\n}\n#define GOLDEN_ANGLE 2.399963\nvec2 generateDiskSample(inout VogelDiskData data) {\n	float r = sqrt((data.currentPointId + 0.5) * data.invNumSamples);\n	float theta = data.currentPointId * GOLDEN_ANGLE + data.initialAngle;\n	vec2 offset = vec2(cos(theta), sin(theta)) * pow(r, 1.33);\n	data.currentPointId += 1.0;\n	return offset;\n}\nvoid PCSSFindBlocker(TEXTURE_ACCEPT(shadowMap), out float avgBlockerDepth, out int numBlockers,\n	vec2 shadowCoords, float z, int shadowBlockerSamples, float penumbraSize, float invShadowMapSize, float randomSeed) {\n	VogelDiskData diskData;\n	prepareDiskConstants(diskData, shadowBlockerSamples, 11, randomSeed);\n	float searchWidth = penumbraSize * invShadowMapSize;\n	float blockerSum = 0.0;\n	numBlockers = 0;\n	for( int i = 0; i < shadowBlockerSamples; ++i ) {\n		vec2 diskUV = generateDiskSample(diskData);\n		vec2 sampleUV = shadowCoords + diskUV * searchWidth;\n		float shadowMapDepth = texture2DLod(shadowMap, sampleUV, 0.0).r;\n		if ( shadowMapDepth < z ) {\n			blockerSum += shadowMapDepth;\n			numBlockers++;\n		}\n	}\n	avgBlockerDepth = blockerSum / float(numBlockers);\n}\nfloat PCSSFilter(TEXTURE_ACCEPT(shadowMap), vec2 uv, float receiverDepth, int shadowSamples, float filterRadius, float randomSeed) {\n	VogelDiskData diskData;\n	prepareDiskConstants(diskData, shadowSamples, 11, randomSeed);\n	float sum = 0.0;\n	for (int i = 0; i < shadowSamples; i++) {\n		vec2 offsetUV = generateDiskSample(diskData) * filterRadius;\n		float depth = texture2DLod(shadowMap, uv + offsetUV, 0.0).r;\n		sum += step(receiverDepth, depth);\n	}\n	return sum / float(shadowSamples);\n}\nfloat getPenumbra(float dblocker, float dreceiver, float penumbraSize, float penumbraFalloff) {\n	float dist = dreceiver - dblocker;\n	float penumbra = 1.0 - pow(1.0 - dist, penumbraFalloff);\n	return penumbra * penumbraSize;\n}\nfloat PCSSDirectional(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoords, vec4 cameraParams, vec4 softShadowParams) {\n	float receiverDepth = shadowCoords.z;\n	float randomSeed = fractSinRand(gl_FragCoord.xy);\n	int shadowSamples = int(softShadowParams.x);\n	int shadowBlockerSamples = int(softShadowParams.y);\n	float penumbraSize = softShadowParams.z;\n	float penumbraFalloff = softShadowParams.w;\n	int shadowMapSize = textureSize(shadowMap, 0).x;\n	float invShadowMapSize = 1.0 / float(shadowMapSize);\n	invShadowMapSize *= float(shadowMapSize) / 2048.0;\n	float penumbra;\n	if (shadowBlockerSamples > 0) {\n		float avgBlockerDepth = 0.0;\n		int numBlockers = 0;\n		PCSSFindBlocker(TEXTURE_PASS(shadowMap), avgBlockerDepth, numBlockers, shadowCoords.xy, receiverDepth, shadowBlockerSamples, penumbraSize, invShadowMapSize, randomSeed);\n		if (numBlockers < 1)\n			return 1.0f;\n		penumbra = getPenumbra(avgBlockerDepth, shadowCoords.z, penumbraSize, penumbraFalloff);\n	} else {\n		penumbra = penumbraSize;\n	}\n	float filterRadius = penumbra * invShadowMapSize;\n	return PCSSFilter(TEXTURE_PASS(shadowMap), shadowCoords.xy, receiverDepth, shadowSamples, filterRadius, randomSeed);\n}\nfloat getShadowPCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec4 softShadowParams, vec3 lightDir) {\n	return PCSSDirectional(TEXTURE_PASS(shadowMap), shadowCoord, cameraParams, softShadowParams);\n}\n",skinBatchVS:"\nattribute float vertex_boneIndices;\nuniform highp sampler2D texture_poseMap;\nmat4 getBoneMatrix(const in float indexFloat) {\n	int width = textureSize(texture_poseMap, 0).x;\n	int index = int(indexFloat + 0.5) * 3;\n	int iy = index / width;\n	int ix = index % width;\n	vec4 v1 = texelFetch(texture_poseMap, ivec2(ix + 0, iy), 0);\n	vec4 v2 = texelFetch(texture_poseMap, ivec2(ix + 1, iy), 0);\n	vec4 v3 = texelFetch(texture_poseMap, ivec2(ix + 2, iy), 0);\n	return mat4(\n		v1.x, v2.x, v3.x, 0,\n		v1.y, v2.y, v3.y, 0,\n		v1.z, v2.z, v3.z, 0,\n		v1.w, v2.w, v3.w, 1\n	);\n}\n",skinVS:"\nattribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\nuniform highp sampler2D texture_poseMap;\nvoid getBoneMatrix(const in int width, const in int index, out vec4 v1, out vec4 v2, out vec4 v3) {\n	int v = index / width;\n	int u = index % width;\n	v1 = texelFetch(texture_poseMap, ivec2(u + 0, v), 0);\n	v2 = texelFetch(texture_poseMap, ivec2(u + 1, v), 0);\n	v3 = texelFetch(texture_poseMap, ivec2(u + 2, v), 0);\n}\nmat4 getSkinMatrix(const in vec4 indicesFloat, const in vec4 weights) {\n	int width = textureSize(texture_poseMap, 0).x;\n	ivec4 indices = ivec4(indicesFloat + 0.5) * 3;\n	vec4 a1, a2, a3;\n	getBoneMatrix(width, indices.x, a1, a2, a3);\n	vec4 b1, b2, b3;\n	getBoneMatrix(width, indices.y, b1, b2, b3);\n	vec4 c1, c2, c3;\n	getBoneMatrix(width, indices.z, c1, c2, c3);\n	vec4 d1, d2, d3;\n	getBoneMatrix(width, indices.w, d1, d2, d3);\n	vec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;\n	vec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;\n	vec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;\n	float one = dot(weights, vec4(1.0));\n	return mat4(\n		v1.x, v2.x, v3.x, 0,\n		v1.y, v2.y, v3.y, 0,\n		v1.z, v2.z, v3.z, 0,\n		v1.w, v2.w, v3.w, one\n	);\n}\n",skyboxPS:'\n	#define LIT_SKYBOX_INTENSITY\n	#include "envProcPS"\n	#include "gammaPS"\n	#include "tonemappingPS"\n	varying vec3 vViewDir;\n	uniform float skyboxHighlightMultiplier;\n	#ifdef SKY_CUBEMAP\n		uniform samplerCube texture_cubeMap;\n		#ifdef SKYMESH\n			varying vec3 vWorldPos;\n			uniform mat3 cubeMapRotationMatrix;\n			uniform vec3 projectedSkydomeCenter;\n		#endif\n	#else\n		#include "sphericalPS"\n		#include "envAtlasPS"\n		uniform sampler2D texture_envAtlas;\n		uniform float mipLevel;\n	#endif\n	void main(void) {\n		#ifdef SKY_CUBEMAP\n			#ifdef SKYMESH\n				vec3 envDir = normalize(vWorldPos - projectedSkydomeCenter);\n				vec3 dir = envDir * cubeMapRotationMatrix;\n			#else\n				vec3 dir = vViewDir;\n			#endif\n			dir.x *= -1.0;\n			vec3 linear = {SKYBOX_DECODE_FNC}(textureCube(texture_cubeMap, dir));\n		#else\n			vec3 dir = vViewDir * vec3(-1.0, 1.0, 1.0);\n			vec2 uv = toSphericalUv(normalize(dir));\n			vec3 linear = {SKYBOX_DECODE_FNC}(texture2D(texture_envAtlas, mapRoughnessUv(uv, mipLevel)));\n		#endif\n		if (any(greaterThanEqual(linear, vec3(64.0)))) {\n			linear *= skyboxHighlightMultiplier;\n		}\n		gl_FragColor = vec4(gammaCorrectOutput(toneMap(processEnvironment(linear))), 1.0);\n	}\n',skyboxVS:"\nattribute vec4 aPosition;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform mat4 matrix_projectionSkybox;\nuniform mat3 cubeMapRotationMatrix;\nvarying vec3 vViewDir;\n#ifdef SKYMESH\n	uniform mat4 matrix_model;\n	varying vec3 vWorldPos;\n#endif\nvoid main(void) {\n	mat4 view = matrix_view;\n	#ifdef SKYMESH\n		vec4 worldPos = matrix_model * aPosition;\n		vWorldPos = worldPos.xyz;\n		gl_Position = matrix_projectionSkybox * (view * worldPos);\n	#else\n		view[3][0] = view[3][1] = view[3][2] = 0.0;\n		gl_Position = matrix_projectionSkybox * (view * aPosition);\n		vViewDir = aPosition.xyz * cubeMapRotationMatrix;\n	#endif\n	gl_Position.z = gl_Position.w - 1.0e-7;\n}\n",specularPS:"\n#ifdef STD_SPECULAR_CONSTANT\nuniform vec3 material_specular;\n#endif\nvoid getSpecularity() {\n	vec3 specularColor = vec3(1,1,1);\n	#ifdef STD_SPECULAR_CONSTANT\n	specularColor *= material_specular;\n	#endif\n	#ifdef STD_SPECULAR_TEXTURE\n	specularColor *= {STD_SPECULAR_TEXTURE_DECODE}(texture2DBias({STD_SPECULAR_TEXTURE_NAME}, {STD_SPECULAR_TEXTURE_UV}, textureBias)).{STD_SPECULAR_TEXTURE_CHANNEL};\n	#endif\n	#ifdef STD_SPECULAR_VERTEX\n	specularColor *= saturate(vVertexColor.{STD_SPECULAR_VERTEX_CHANNEL});\n	#endif\n	dSpecularity = specularColor;\n}\n",sphericalPS:"\nvec2 toSpherical(vec3 dir) {\n	return vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));\n}\nvec2 toSphericalUv(vec3 dir) {\n	const float PI = 3.141592653589793;\n	vec2 uv = toSpherical(dir) / vec2(PI * 2.0, PI) + 0.5;\n	return vec2(uv.x, 1.0 - uv.y);\n}\n",specularityFactorPS:"\n#ifdef STD_SPECULARITYFACTOR_CONSTANT\nuniform float material_specularityFactor;\n#endif\nvoid getSpecularityFactor() {\n	float specularityFactor = 1.0;\n	#ifdef STD_SPECULARITYFACTOR_CONSTANT\n	specularityFactor *= material_specularityFactor;\n	#endif\n	#ifdef STD_SPECULARITYFACTOR_TEXTURE\n	specularityFactor *= texture2DBias({STD_SPECULARITYFACTOR_TEXTURE_NAME}, {STD_SPECULARITYFACTOR_TEXTURE_UV}, textureBias).{STD_SPECULARITYFACTOR_TEXTURE_CHANNEL};\n	#endif\n	#ifdef STD_SPECULARITYFACTOR_VERTEX\n	specularityFactor *= saturate(vVertexColor.{STD_SPECULARITYFACTOR_VERTEX_CHANNEL});\n	#endif\n	dSpecularityFactor = specularityFactor;\n}\n",spotPS:"\nfloat getSpotEffect(vec3 lightSpotDir, float lightInnerConeAngle, float lightOuterConeAngle, vec3 lightDirNorm) {\n	float cosAngle = dot(lightDirNorm, lightSpotDir);\n	return smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);\n}\n",startNineSlicedPS:"\n	nineSlicedUv = vUv0;\n	nineSlicedUv.y = 1.0 - nineSlicedUv.y;\n",startNineSlicedTiledPS:"\n	vec2 tileMask = step(vMask, vec2(0.99999));\n	vec2 tileSize = 0.5 * (innerOffset.xy + innerOffset.zw);\n	vec2 tileScale = vec2(1.0) / (vec2(1.0) - tileSize);\n	vec2 clampedUv = mix(innerOffset.xy * 0.5, vec2(1.0) - innerOffset.zw * 0.5, fract((vTiledUv - tileSize) * tileScale));\n	clampedUv = clampedUv * atlasRect.zw + atlasRect.xy;\n	nineSlicedUv = vUv0 * tileMask + clampedUv * (vec2(1.0) - tileMask);\n	nineSlicedUv.y = 1.0 - nineSlicedUv.y;\n	\n",stdDeclarationPS:'\n	float dAlpha = 1.0;\n	#if defined(LIT_ALPHA_TEST)\n		#include "alphaTestPS"\n	#endif\n	#if STD_OPACITY_DITHER != NONE\n		#include "opacityDitherPS"\n	#endif\n	#ifdef FORWARD_PASS\n		vec3 dAlbedo;\n		vec3 dNormalW;\n		vec3 dSpecularity = vec3(0.0);\n		float dGlossiness = 0.0;\n		#ifdef LIT_REFRACTION\n			float dTransmission;\n			float dThickness;\n		#endif\n		#ifdef LIT_SCENE_COLOR\n			uniform sampler2D uSceneColorMap;\n		#endif\n		#ifdef LIT_SCREEN_SIZE\n			uniform vec4 uScreenSize;\n		#endif\n		#ifdef LIT_TRANSFORMS\n			uniform mat4 matrix_viewProjection;\n			uniform mat4 matrix_model;\n		#endif\n		#ifdef STD_HEIGHT_MAP\n			vec2 dUvOffset;\n			#ifdef STD_DIFFUSE_TEXTURE_ALLOCATE\n				uniform sampler2D texture_heightMap;\n			#endif\n		#endif\n		#ifdef STD_DIFFUSE_TEXTURE_ALLOCATE\n			uniform sampler2D texture_diffuseMap;\n		#endif\n		#ifdef STD_DIFFUSEDETAIL_TEXTURE_ALLOCATE\n			uniform sampler2D texture_diffuseDetailMap;\n		#endif\n		#ifdef STD_NORMAL_TEXTURE_ALLOCATE\n			uniform sampler2D texture_normalMap;\n		#endif\n		#ifdef STD_NORMALDETAIL_TEXTURE_ALLOCATE\n			uniform sampler2D texture_normalDetailMap;\n		#endif\n		#ifdef STD_THICKNESS_TEXTURE_ALLOCATE\n			uniform sampler2D texture_thicknessMap;\n		#endif\n		#ifdef STD_REFRACTION_TEXTURE_ALLOCATE\n			uniform sampler2D texture_refractionMap;\n		#endif\n		#ifdef LIT_IRIDESCENCE\n			float dIridescence;\n			float dIridescenceThickness;\n			#ifdef STD_IRIDESCENCE_THICKNESS_TEXTURE_ALLOCATE\n				uniform sampler2D texture_iridescenceThicknessMap;\n			#endif\n			#ifdef STD_IRIDESCENCE_TEXTURE_ALLOCATE\n				uniform sampler2D texture_iridescenceMap;\n			#endif\n		#endif\n		#ifdef LIT_CLEARCOAT\n			float ccSpecularity;\n			float ccGlossiness;\n			vec3 ccNormalW;\n		#endif\n		#ifdef LIT_SPECULAR_OR_REFLECTION\n			#ifdef LIT_SHEEN\n				vec3 sSpecularity;\n				float sGlossiness;\n				#ifdef STD_SHEEN_TEXTURE_ALLOCATE\n					uniform sampler2D texture_sheenMap;\n				#endif\n				#ifdef STD_SHEENGLOSS_TEXTURE_ALLOCATE\n					uniform sampler2D texture_sheenGlossMap;\n				#endif\n			#endif\n			#ifdef LIT_METALNESS\n				float dMetalness;\n				float dIor;\n				#ifdef STD_METALNESS_TEXTURE_ALLOCATE\n					uniform sampler2D texture_metalnessMap;\n				#endif\n			#endif\n			#ifdef LIT_SPECULARITY_FACTOR\n				float dSpecularityFactor;\n				#ifdef STD_SPECULARITYFACTOR_TEXTURE_ALLOCATE\n					uniform sampler2D texture_specularityFactorMap;\n				#endif\n			#endif\n			#ifdef STD_SPECULAR_COLOR\n				#ifdef STD_SPECULAR_TEXTURE_ALLOCATE\n					uniform sampler2D texture_specularMap;\n				#endif\n			#endif\n			#ifdef STD_GLOSS_TEXTURE_ALLOCATE\n				uniform sampler2D texture_glossMap;\n			#endif\n		#endif\n		#ifdef STD_AO\n			float dAo;\n			#ifdef STD_AO_TEXTURE_ALLOCATE\n				uniform sampler2D texture_aoMap;\n			#endif\n			#ifdef STD_AODETAIL_TEXTURE_ALLOCATE\n				uniform sampler2D texture_aoDetailMap;\n			#endif\n		#endif\n		vec3 dEmission;\n		#ifdef STD_EMISSIVE_TEXTURE_ALLOCATE\n			uniform sampler2D texture_emissiveMap;\n		#endif\n		#ifdef LIT_CLEARCOAT\n			#ifdef STD_CLEARCOAT_TEXTURE_ALLOCATE\n				uniform sampler2D texture_clearCoatMap;\n			#endif\n			#ifdef STD_CLEARCOATGLOSS_TEXTURE_ALLOCATE\n				uniform sampler2D texture_clearCoatGlossMap;\n			#endif\n			#ifdef STD_CLEARCOATNORMAL_TEXTURE_ALLOCATE\n				uniform sampler2D texture_clearCoatNormalMap;\n			#endif\n		#endif\n		#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)\n			vec3 dLightmap;\n			#ifdef STD_LIGHT_TEXTURE_ALLOCATE\n				uniform sampler2D texture_lightMap;\n			#endif\n		#endif\n	#endif\n	#include "litShaderCorePS"\n',stdFrontEndPS:'\n	#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE\n		#ifdef STD_OPACITY_TEXTURE_ALLOCATE\n			uniform sampler2D texture_opacityMap;\n		#endif\n		#include "opacityPS"\n	#endif\n	#ifdef FORWARD_PASS\n		#ifdef STD_HEIGHT_MAP\n			#include "parallaxPS"\n		#endif\n		#include  "diffusePS"\n		#ifdef LIT_NEEDS_NORMAL\n			#include "normalMapPS"\n		#endif\n		#ifdef LIT_REFRACTION\n			#include "transmissionPS"\n			#include "thicknessPS"\n		#endif\n		#ifdef LIT_IRIDESCENCE\n			#include "iridescencePS"\n			#include "iridescenceThicknessPS"\n		#endif\n		#ifdef LIT_SPECULAR_OR_REFLECTION\n			#ifdef LIT_SHEEN\n				#include "sheenPS"\n				#include "sheenGlossPS"\n			#endif\n			#ifdef LIT_METALNESS\n				#include "metalnessPS"\n				#include "iorPS"\n			#endif\n			#ifdef LIT_SPECULARITY_FACTOR\n				#include "specularityFactorPS"\n			#endif\n			#ifdef STD_SPECULAR_COLOR\n				#include "specularPS"\n			#else\n				void getSpecularity() { \n					dSpecularity = vec3(1);\n				}\n			#endif\n			#include "glossPS"\n		#endif\n		#ifdef STD_AO\n			#include "aoPS"\n		#endif\n		#include "emissivePS"\n		#ifdef LIT_CLEARCOAT\n			#include "clearCoatPS"\n			#include "clearCoatGlossPS"\n			#include "clearCoatNormalPS"\n		#endif\n		#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)\n			#include "lightmapPS"\n		#endif\n	#endif\n	void evaluateFrontend() {\n		#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE\n			getOpacity();\n			#if defined(LIT_ALPHA_TEST)\n				alphaTest(dAlpha);\n			#endif\n			#if STD_OPACITY_DITHER != NONE\n				opacityDither(dAlpha, 0.0);\n			#endif\n			litArgs_opacity = dAlpha;\n		#endif\n		#ifdef FORWARD_PASS\n			#ifdef STD_HEIGHT_MAP\n				getParallax();\n			#endif\n			getAlbedo();\n			litArgs_albedo = dAlbedo;\n			#ifdef LIT_NEEDS_NORMAL\n				getNormal();\n				litArgs_worldNormal = dNormalW;\n			#endif\n			#ifdef LIT_REFRACTION\n				getRefraction();\n				litArgs_transmission = dTransmission;\n				getThickness();\n				litArgs_thickness = dThickness;\n				#ifdef LIT_DISPERSION\n					litArgs_dispersion = material_dispersion;\n				#endif\n			#endif\n			#ifdef LIT_IRIDESCENCE\n				getIridescence();\n				getIridescenceThickness();\n				litArgs_iridescence_intensity = dIridescence;\n				litArgs_iridescence_thickness = dIridescenceThickness;\n			#endif\n			#ifdef LIT_SPECULAR_OR_REFLECTION\n				#ifdef LIT_SHEEN\n					getSheen();\n					litArgs_sheen_specularity = sSpecularity;\n					getSheenGlossiness();\n					litArgs_sheen_gloss = sGlossiness;\n				#endif\n				#ifdef LIT_METALNESS\n					getMetalness();\n					litArgs_metalness = dMetalness;\n					getIor();\n					litArgs_ior = dIor;\n				#endif\n				#ifdef LIT_SPECULARITY_FACTOR\n					getSpecularityFactor();\n					litArgs_specularityFactor = dSpecularityFactor;\n				#endif\n				getGlossiness();\n				getSpecularity();\n				litArgs_specularity = dSpecularity;\n				litArgs_gloss = dGlossiness;\n			#endif\n			#ifdef STD_AO\n				getAO();\n				litArgs_ao = dAo;\n			#endif\n			getEmission();\n			litArgs_emission = dEmission;\n			#ifdef LIT_CLEARCOAT\n				getClearCoat();\n				getClearCoatGlossiness();\n				getClearCoatNormal();\n				litArgs_clearcoat_specularity = ccSpecularity;\n				litArgs_clearcoat_gloss = ccGlossiness;\n				litArgs_clearcoat_worldNormal = ccNormalW;\n			#endif\n			#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)\n				getLightMap();\n				litArgs_lightmap = dLightmap;\n				#ifdef STD_LIGHTMAP_DIR\n					litArgs_lightmapDir = dLightmapDir;\n				#endif\n			#endif\n		#endif\n	}\n',tangentBinormalVS:"\nvec3 getTangent() {\n	return normalize(dNormalMatrix * vertex_tangent.xyz);\n}\nvec3 getBinormal() {\n	return cross(vNormalW, vTangentW) * vertex_tangent.w;\n}\n",TBNPS:"\n#ifdef LIT_TANGENTS\n	#define TBN_TANGENTS\n#else\n	#if defined(LIT_USE_NORMALS) || defined(LIT_USE_CLEARCOAT_NORMALS)\n		#define TBN_DERIVATIVES\n	#endif\n#endif\n#if defined(TBN_DERIVATIVES)\n	uniform float tbnBasis;\n#endif\nvoid getTBN(vec3 tangent, vec3 binormal, vec3 normal) {\n	#ifdef TBN_TANGENTS\n		dTBN = mat3(normalize(tangent), normalize(binormal), normalize(normal));\n	#elif defined(TBN_DERIVATIVES)\n		vec2 uv = {lightingUv};\n		vec3 dp1 = dFdx( vPositionW );\n		vec3 dp2 = dFdy( vPositionW );\n		vec2 duv1 = dFdx( uv );\n		vec2 duv2 = dFdy( uv );\n		vec3 dp2perp = cross( dp2, normal );\n		vec3 dp1perp = cross( normal, dp1 );\n		vec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n		vec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n		float denom = max( dot(T,T), dot(B,B) );\n		float invmax = (denom == 0.0) ? 0.0 : tbnBasis / sqrt( denom );\n		dTBN = mat3(T * invmax, -B * invmax, normal );\n	#else\n		vec3 B = cross(normal, vObjectSpaceUpW);\n		vec3 T = cross(normal, B);\n		if (dot(B,B)==0.0)\n		{\n			float major=max(max(normal.x, normal.y), normal.z);\n			if (normal.x == major)\n			{\n				B = cross(normal, vec3(0,1,0));\n				T = cross(normal, B);\n			}\n			else if (normal.y == major)\n			{\n				B = cross(normal, vec3(0,0,1));\n				T = cross(normal, B);\n			}\n			else if (normal.z == major)\n			{\n				B = cross(normal, vec3(1,0,0));\n				T = cross(normal, B);\n			}\n		}\n		dTBN = mat3(normalize(T), normalize(B), normalize(normal));\n	#endif\n}\n",thicknessPS:"\n#ifdef STD_THICKNESS_CONSTANT\nuniform float material_thickness;\n#endif\nvoid getThickness() {\n	dThickness = 1.0;\n	#ifdef STD_THICKNESS_CONSTANT\n	dThickness *= material_thickness;\n	#endif\n	#ifdef STD_THICKNESS_TEXTURE\n	dThickness *= texture2DBias({STD_THICKNESS_TEXTURE_NAME}, {STD_THICKNESS_TEXTURE_UV}, textureBias).{STD_THICKNESS_TEXTURE_CHANNEL};\n	#endif\n	#ifdef STD_THICKNESS_VERTEX\n	dThickness *= saturate(vVertexColor.{STD_THICKNESS_VERTEX_CHANNEL});\n	#endif\n}\n",tonemappingPS:'\n#if (TONEMAP == NONE)\n	#include "tonemappingNonePS"\n#elif TONEMAP == FILMIC\n	#include "tonemappingFilmicPS"\n#elif TONEMAP == LINEAR\n	#include "tonemappingLinearPS"\n#elif TONEMAP == HEJL\n	#include "tonemappingHejlPS"\n#elif TONEMAP == ACES\n	#include "tonemappingAcesPS"\n#elif TONEMAP == ACES2\n	#include "tonemappingAces2PS"\n#elif TONEMAP == NEUTRAL\n	#include "tonemappingNeutralPS"\n#endif\n',tonemappingAcesPS:"\nuniform float exposure;\nvec3 toneMap(vec3 color) {\n	float tA = 2.51;\n	float tB = 0.03;\n	float tC = 2.43;\n	float tD = 0.59;\n	float tE = 0.14;\n	vec3 x = color * exposure;\n	return (x*(tA*x+tB))/(x*(tC*x+tD)+tE);\n}\n",tonemappingAces2PS:"\nuniform float exposure;\nconst mat3 ACESInputMat = mat3(\n	0.59719, 0.35458, 0.04823,\n	0.07600, 0.90834, 0.01566,\n	0.02840, 0.13383, 0.83777\n);\nconst mat3 ACESOutputMat = mat3(\n	 1.60475, -0.53108, -0.07367,\n	-0.10208,  1.10813, -0.00605,\n	-0.00327, -0.07276,  1.07602\n);\nvec3 RRTAndODTFit(vec3 v) {\n	vec3 a = v * (v + 0.0245786) - 0.000090537;\n	vec3 b = v * (0.983729 * v + 0.4329510) + 0.238081;\n	return a / b;\n}\nvec3 toneMap(vec3 color) {\n	color *= exposure / 0.6;\n	color = color * ACESInputMat;\n	color = RRTAndODTFit(color);\n	color = color * ACESOutputMat;\n	color = clamp(color, 0.0, 1.0);\n	return color;\n}\n",tonemappingFilmicPS:"\nconst float A =  0.15;\nconst float B =  0.50;\nconst float C =  0.10;\nconst float D =  0.20;\nconst float E =  0.02;\nconst float F =  0.30;\nconst float W =  11.2;\nuniform float exposure;\nvec3 uncharted2Tonemap(vec3 x) {\n   return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\n}\nvec3 toneMap(vec3 color) {\n	color = uncharted2Tonemap(color * exposure);\n	vec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W,W,W));\n	color = color * whiteScale;\n	return color;\n}\n",tonemappingHejlPS:"\nuniform float exposure;\nvec3 toneMap(vec3 color) {\n	color *= exposure;\n	const float  A = 0.22, B = 0.3, C = .1, D = 0.2, E = .01, F = 0.3;\n	const float Scl = 1.25;\n	vec3 h = max( vec3(0.0), color - vec3(0.004) );\n	return (h*((Scl*A)*h+Scl*vec3(C*B,C*B,C*B))+Scl*vec3(D*E,D*E,D*E)) / (h*(A*h+vec3(B,B,B))+vec3(D*F,D*F,D*F)) - Scl*vec3(E/F,E/F,E/F);\n}\n",tonemappingLinearPS:"\nuniform float exposure;\nvec3 toneMap(vec3 color) {\n	return color * exposure;\n}\n",tonemappingNeutralPS:"\nuniform float exposure;\nvec3 toneMap(vec3 color) {\n	color *= exposure;\n	float startCompression = 0.8 - 0.04;\n	float desaturation = 0.15;\n	float x = min(color.r, min(color.g, color.b));\n	float offset = x < 0.08 ? x - 6.25 * x * x : 0.04;\n	color -= offset;\n	float peak = max(color.r, max(color.g, color.b));\n	if (peak < startCompression) return color;\n	float d = 1. - startCompression;\n	float newPeak = 1. - d * d / (peak + d - startCompression);\n	color *= newPeak / peak;\n	float g = 1. - 1. / (desaturation * (peak - newPeak) + 1.);\n	return mix(color, newPeak * vec3(1, 1, 1), g);\n}\n",tonemappingNonePS:"\nvec3 toneMap(vec3 color) {\n	return color;\n}\n",transformVS:"\n#ifdef PIXELSNAP\nuniform vec4 uScreenSize;\n#endif\n#ifdef SCREENSPACE\nuniform float projectionFlipY;\n#endif\nvec4 evalWorldPosition(vec3 vertexPosition, mat4 modelMatrix) {\n	vec3 localPos = getLocalPosition(vertexPosition);\n	#ifdef NINESLICED\n		localPos.xz *= outerScale;\n		vec2 positiveUnitOffset = clamp(vertexPosition.xz, vec2(0.0), vec2(1.0));\n		vec2 negativeUnitOffset = clamp(-vertexPosition.xz, vec2(0.0), vec2(1.0));\n		localPos.xz += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n		vTiledUv = (localPos.xz - outerScale + innerOffset.xy) * -0.5 + 1.0;\n		localPos.xz *= -0.5;\n		localPos = localPos.xzy;\n	#endif\n	vec4 posW = modelMatrix * vec4(localPos, 1.0);\n	#ifdef SCREENSPACE\n		posW.zw = vec2(0.0, 1.0);\n	#endif\n	return posW;\n}\nvec4 getPosition() {\n	dModelMatrix = getModelMatrix();\n	vec4 posW = evalWorldPosition(vertex_position.xyz, dModelMatrix);\n	dPositionW = posW.xyz;\n	vec4 screenPos;\n	#ifdef UV1LAYOUT\n		screenPos = vec4(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1);\n		#ifdef WEBGPU\n			screenPos.y *= -1.0;\n		#endif\n	#else\n		#ifdef SCREENSPACE\n			screenPos = posW;\n			screenPos.y *= projectionFlipY;\n		#else\n			screenPos = matrix_viewProjection * posW;\n		#endif\n		#ifdef PIXELSNAP\n			screenPos.xy = (screenPos.xy * 0.5) + 0.5;\n			screenPos.xy *= uScreenSize.xy;\n			screenPos.xy = floor(screenPos.xy);\n			screenPos.xy *= uScreenSize.zw;\n			screenPos.xy = (screenPos.xy * 2.0) - 1.0;\n		#endif\n	#endif\n	return screenPos;\n}\nvec3 getWorldPosition() {\n	return dPositionW;\n}\n",transformCoreVS:'\nattribute vec4 vertex_position;\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\n#ifdef MORPHING\n	uniform vec2 morph_tex_params;\n	attribute uint morph_vertex_id;\n	ivec2 getTextureMorphCoords() {\n		ivec2 textureSize = ivec2(morph_tex_params);\n		int morphGridV = int(morph_vertex_id) / textureSize.x;\n		int morphGridU = int(morph_vertex_id) - (morphGridV * textureSize.x);\n		#ifdef WEBGPU\n			morphGridV = textureSize.y - morphGridV - 1;\n		#endif\n		return ivec2(morphGridU, morphGridV);\n	}\n	#ifdef MORPHING_POSITION\n		#ifdef MORPHING_INT\n			uniform vec3 aabbSize;\n			uniform vec3 aabbMin;\n			uniform usampler2D morphPositionTex;\n		#else\n			uniform highp sampler2D morphPositionTex;\n		#endif\n	#endif\n#endif\n#ifdef defined(BATCH)\n	#include "skinBatchVS"\n	mat4 getModelMatrix() {\n		return getBoneMatrix(vertex_boneIndices);\n	}\n#elif defined(SKIN)\n	#include "skinVS"\n	mat4 getModelMatrix() {\n		return matrix_model * getSkinMatrix(vertex_boneIndices, vertex_boneWeights);\n	}\n#elif defined(INSTANCING)\n	#include "transformInstancingVS"\n#else\n	mat4 getModelMatrix() {\n		return matrix_model;\n	}\n#endif\nvec3 getLocalPosition(vec3 vertexPosition) {\n	vec3 localPos = vertexPosition;\n	#ifdef MORPHING_POSITION\n		ivec2 morphUV = getTextureMorphCoords();\n		#ifdef MORPHING_INT\n			vec3 morphPos = vec3(texelFetch(morphPositionTex, ivec2(morphUV), 0).xyz) / 65535.0 * aabbSize + aabbMin;\n		#else\n			vec3 morphPos = texelFetch(morphPositionTex, ivec2(morphUV), 0).xyz;\n		#endif\n		localPos += morphPos;\n	#endif\n	return localPos;\n}\n',transformInstancingVS:"\nattribute vec4 instance_line1;\nattribute vec4 instance_line2;\nattribute vec4 instance_line3;\nattribute vec4 instance_line4;\nmat4 getModelMatrix() {\n	return matrix_model * mat4(instance_line1, instance_line2, instance_line3, instance_line4);\n}\n",transmissionPS:"\n#ifdef STD_REFRACTION_CONSTANT\nuniform float material_refraction;\n#endif\nvoid getRefraction() {\n	float refraction = 1.0;\n	#ifdef STD_REFRACTION_CONSTANT\n	refraction = material_refraction;\n	#endif\n	#ifdef STD_REFRACTION_TEXTURE\n	refraction *= texture2DBias({STD_REFRACTION_TEXTURE_NAME}, {STD_REFRACTION_TEXTURE_UV}, textureBias).{STD_REFRACTION_TEXTURE_CHANNEL};\n	#endif\n	#ifdef STD_REFRACTION_VERTEX\n	refraction *= saturate(vVertexColor.{STD_REFRACTION_VERTEX_CHANNEL});\n	#endif\n	dTransmission = refraction;\n}\n",twoSidedLightingPS:"\nuniform float twoSidedLightingNegScaleFactor;\nvoid handleTwoSidedLighting() {\n	dTBN[2] *= gl_FrontFacing ? twoSidedLightingNegScaleFactor : -twoSidedLightingNegScaleFactor;\n}\n",uv0VS:"\n#ifdef NINESLICED\n	vec2 getUv0() {\n		vec2 uv = vertex_position.xz;\n		vec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n		vec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n		uv += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n		uv = uv * -0.5 + 0.5;\n		uv = uv * atlasRect.zw + atlasRect.xy;\n		vMask = vertex_texCoord0.xy;\n		return uv;\n	}\n#else\n	vec2 getUv0() {\n		return vertex_texCoord0;\n	}\n#endif\n",uv1VS:"\nvec2 getUv1() {\n	return vertex_texCoord1;\n}\n",uvTransformVS:"\nvUV{TRANSFORM_UV_{i}}_{TRANSFORM_ID_{i}} = vec2(\n	dot(vec3(uv{TRANSFORM_UV_{i}}, 1), {TRANSFORM_NAME_{i}}0),\n	dot(vec3(uv{TRANSFORM_UV_{i}}, 1), {TRANSFORM_NAME_{i}}1)\n);\n",uvTransformUniformsPS:"\n	uniform vec3 {TRANSFORM_NAME_{i}}0;\n	uniform vec3 {TRANSFORM_NAME_{i}}1;\n",viewDirPS:"\nvoid getViewDir() {\n	dViewDirW = normalize(view_position - vPositionW);\n}\n",webgpuPS:i5,webgpuVS:i6},a_=new t8;function ag(e){return a_.get(e)}class av{static definesHash(e){return sS(JSON.stringify(Array.from(e).sort((e,t)=>e[0]>t[0]?1:-1)))}}let ay=new t8;class aS{buildShaderDefines(){let e;this.isShadow?e="SHADOW":this.isForward?e="FORWARD":2===this.index?e="DEPTH":3===this.index&&(e="PICK"),this.defines.set(""+e+"_PASS",""),this.defines.set(""+this.name.toUpperCase()+"_PASS","");}constructor(e,t,s={}){this.defines=new Map,this.name=e,this.index=t,Object.assign(this,s),this.buildShaderDefines();}}class ax{static get(e){return ay.get(e,()=>new ax)}allocate(e,t){let s=this.passesNamed.get(e);return void 0===s&&(s=new aS(e,this.nextIndex,t),this.passesNamed.set(s.name,s),this.passesIndexed[s.index]=s,this.nextIndex++),s}getByIndex(e){return this.passesIndexed[e]}getByName(e){return this.passesNamed.get(e)}constructor(){this.passesNamed=new Map,this.passesIndexed=[],this.nextIndex=0;let e=(e,t,s)=>{this.allocate(e,s);};e("forward",0,{isForward:true}),e("prepass"),e("depth"),e("pick"),e("shadow");}}function aT(){return (aT=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i]);}return e}).apply(this,arguments)}function ab(e,t,s,i,n,r,a){ void 0===r&&(r=false),void 0===a&&(a={}),"boolean"==typeof r?a.useTransformFeedback=r:"object"==typeof r&&(a=aT({},a,r));let o=ag(e),l=o.getCachedShader(i);return l||(l=new ns(e,ne.createDefinition(e,aT({},a,{name:i,vertexCode:t,fragmentCode:s,attributes:n}))),o.setCachedShader(i,l)),l}class aE extends av{generateKey(e){return this.key}createShaderDefinition(e,t){return this.shaderDefinition}constructor(e,t){super(),this.key=e,this.shaderDefinition=t;}}let aA=(e,t)=>{let s=new Map(e.defines);return t.cameraShaderParams.defines.forEach((e,t)=>s.set(t,e)),ax.get(t.device).getByIndex(t.pass).defines.forEach((e,t)=>s.set(t,e)),s},aw={type:5,base:0,count:4,indexed:false},aC=new em,aP=new em,aM=new sa;class aI{destroy(){var e,t;null==(e=this.uniformBuffer)||e.destroy(),this.uniformBuffer=null,null==(t=this.bindGroup)||t.destroy(),this.bindGroup=null;}render(e,t){let s=this.shader.device;e&&(aC.set(s.vx,s.vy,s.vw,s.vh),aP.set(s.sx,s.sy,s.sw,s.sh),t=null!=t?t:e,s.setViewport(e.x,e.y,e.z,e.w),s.setScissor(t.x,t.y,t.z,t.w)),s.setVertexBuffer(s.quadVertexBuffer,0);let i=this.shader;if(s.setShader(i),s.supportsUniformBuffers){s.setBindGroup(0,s.emptyBindGroup);let e=this.bindGroup;e.update(),s.setBindGroup(1,e);let t=this.uniformBuffer;t?(t.update(aM),s.setBindGroup(2,aM.bindGroup,aM.offsets)):s.setBindGroup(2,s.emptyBindGroup);}s.draw(aw),e&&(s.setViewport(aC.x,aC.y,aC.z,aC.w),s.setScissor(aP.x,aP.y,aP.z,aP.w));}constructor(e){let t=e.device;if(this.shader=e,t.supportsUniformBuffers){let s=new af;this.shader=function(e,t){var s;let i=e.definition,n=new aE((null!=(s=i.name)?s:"shader")+"-id-"+e.id,i),r="shader",a=ag(e.device);a.register(r,n);let o=a.getProgram(r,{},t);return a.unregister(r),o}(e,s);let i=this.shader.meshUniformBufferFormat;i&&(this.uniformBuffer=new no(t,i,false));let n=this.shader.meshBindGroupFormat;this.bindGroup=new so(t,n);}}}class aR extends nK{execute(){let{device:e}=this;e.setCullMode(0),e.setDepthState(su.NODEPTH),e.setStencilState(null,null),this.quad.render(this.rect,this.scissorRect);}constructor(e,t,s,i){super(e),this.quad=t,this.rect=s,this.scissorRect=i;}}let aL=new em;function aD(e,t,s,i,n){let r=new aI(s);i||((i=aL).x=0,i.y=0,i.z=t?t.width:e.width,i.w=t?t.height:e.height);let a=new aR(e,r,i,n);a.init(t),a.colorOps.clear=false,a.depthStencilOps.clearDepth=false,e.isWebGPU&&null===t&&e.samples>1&&(a.colorOps.store=true),a.render(),r.destroy();}class aO{destroy(e,t){this.meshInstance&&(this.removeFromLayers(e,t),this.meshInstance.destroy(),this.meshInstance=null);}addToLayers(e,t){for(let s=0;s<t.length;s++){let i=e.layers.getLayerById(t[s]);i&&i.addMeshInstances([this.meshInstance]);}}removeFromLayers(e,t){for(let s=0;s<t.length;s++){let i=e.layers.getLayerById(t[s]);i&&i.removeMeshInstances([this.meshInstance]);}}updateBoundingBox(){this._aabb.copy(this.origMeshInstances[0].aabb);for(let e=1;e<this.origMeshInstances.length;e++)this._aabb.add(this.origMeshInstances[e].aabb);this.meshInstance.aabb=this._aabb,this.meshInstance._aabbVer=0;}get model(){}constructor(e,t,s){this._aabb=new eP,this.meshInstance=null,this.origMeshInstances=e,this.dynamic=t,this.batchGroupId=s;}}class aF{constructor(e,t,s,i,n=[0]){this._ui=false,this._sprite=false,this._obj={model:[],element:[],sprite:[],render:[]},this.id=e,this.name=t,this.dynamic=s,this.maxAabbSize=i,this.layers=n;}}aF.MODEL="model",aF.ELEMENT="element",aF.SPRITE="sprite",aF.RENDER="render";let aN=new ex;class aB{set rootBone(e){this._rootBone=e;}get rootBone(){return this._rootBone}init(e,t){let s=3*t,i=Math.ceil(Math.sqrt(s)),n=Math.ceil(s/(i=ei.roundUp(i,3)));this.boneTexture=new se(e,{width:i,height:n,format:14,mipmaps:false,minFilter:0,magFilter:0,name:"skin"}),this.matrixPalette=this.boneTexture.lock({mode:1}),this.boneTexture.unlock();}destroy(){this.boneTexture&&(this.boneTexture.destroy(),this.boneTexture=null);}resolve(e,t){this.rootBone=e;let s=this.skin,i=[];for(let n=0;n<s.boneNames.length;n++){let r=s.boneNames[n],a=e.findByName(r);a||(a=t),i.push(a);}this.bones=i;}initSkin(e){this.skin=e,this.bones=[];let t=e.inverseBindPose.length;this.init(e.device,t),this.matrices=[];for(let e=0;e<t;e++)this.matrices[e]=new ex;}uploadBones(e){this.boneTexture.upload();}_updateMatrices(e,t){if(this._skinUpdateIndex!==t){this._skinUpdateIndex=t,aN.copy(e.getWorldTransform()).invert();for(let e=this.bones.length-1;e>=0;e--)this.matrices[e].mulAffine2(aN,this.bones[e].getWorldTransform()),this.matrices[e].mulAffine2(this.matrices[e],this.skin.inverseBindPose[e]);}}updateMatrices(e,t){this._updateBeforeCull&&this._updateMatrices(e,t);}updateMatrixPalette(e,t){this._updateMatrices(e,t);let s=this.matrixPalette,i=this.bones.length;for(let e=0;e<i;e++){let t=this.matrices[e].data,i=12*e;s[i]=t[0],s[i+1]=t[4],s[i+2]=t[8],s[i+3]=t[12],s[i+4]=t[1],s[i+5]=t[5],s[i+6]=t[9],s[i+7]=t[13],s[i+8]=t[2],s[i+9]=t[6],s[i+10]=t[10],s[i+11]=t[14];}this.uploadBones(this.skin.device);}constructor(e){this._dirty=true,this._rootBone=null,this._skinUpdateIndex=-1,this._updateBeforeCull=true,e&&this.initSkin(e);}}class aU extends aB{updateMatrices(e,t){}updateMatrixPalette(e,t){let s=this.matrixPalette,i=this.bones.length;for(let e=0;e<i;e++){let t=this.bones[e].getWorldTransform().data,i=12*e;s[i]=t[0],s[i+1]=t[4],s[i+2]=t[8],s[i+3]=t[12],s[i+4]=t[1],s[i+5]=t[5],s[i+6]=t[9],s[i+7]=t[13],s[i+8]=t[2],s[i+9]=t[6],s[i+10]=t[10],s[i+11]=t[14];}this.uploadBones(this.device);}constructor(e,t,s){super();let i=t.length;this.init(e,i),this.device=e,this.rootNode=s,this.bones=t;}}let ak=0;class az{initDefaults(){this.recreate=false,this.verticesUsage=0,this.indicesUsage=0,this.maxVertices=0,this.maxIndices=0,this.vertexCount=0,this.indexCount=0,this.vertexStreamsUpdated=false,this.indexStreamUpdated=false,this.vertexStreamDictionary={},this.indices=null;}_changeVertexCount(e,t){this.vertexCount||(this.vertexCount=e);}constructor(){this.initDefaults();}}az.DEFAULT_COMPONENTS_POSITION=3,az.DEFAULT_COMPONENTS_NORMAL=3,az.DEFAULT_COMPONENTS_UV=2,az.DEFAULT_COMPONENTS_COLORS=4;class aV{constructor(e,t,s,i,n){this.data=e,this.componentCount=t,this.dataType=s,this.dataTypeNormalize=i,this.asInt=n;}}class aG extends s2{static fromGeometry(e,t,s){ void 0===s&&(s={});let i=new aG(e,s),{positions:n,normals:r,tangents:a,colors:o,uvs:l,uvs1:h,blendIndices:d,blendWeights:c,indices:u}=t;return n&&i.setPositions(n),r&&i.setNormals(r),a&&i.setVertexStream(e4,a,4),o&&i.setColors32(o),l&&i.setUvs(0,l),h&&i.setUvs(1,h),d&&i.setVertexStream(e6,d,4,d.length/4,1),c&&i.setVertexStream(e5,c,4),u&&i.setIndices(u),i.update(),i}set morph(e){e!==this._morph&&(this._morph&&this._morph.decRefCount(),this._morph=e,e&&e.incRefCount());}get morph(){return this._morph}set aabb(e){this._aabb=e,this._aabbVer++;}get aabb(){return this._aabb}destroy(){let e=this.morph;e&&(this.morph=null,e.refCount<1&&e.destroy()),this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);for(let e=0;e<this.indexBuffer.length;e++)this._destroyIndexBuffer(e);this.indexBuffer.length=0,this._geometryData=null;}_destroyIndexBuffer(e){this.indexBuffer[e]&&(this.indexBuffer[e].destroy(),this.indexBuffer[e]=null);}_initBoneAabbs(e){let t,s,i,n,r,a,o,l;this.boneAabb=[],this.boneUsed=[];let h=[],d=[],c=this.boneUsed,u=this.skin.boneNames.length;for(let e=0;e<u;e++)h[e]=new eu(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),d[e]=new eu(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);let p=new re(this.vertexBuffer),f=p.element[e2],m=p.element[e5],_=p.element[e6],g=this.vertexBuffer.numVertices;for(let u=0;u<g;u++){for(let p=0;p<4;p++)if(m.array[m.index+p]>0){let m=_.array[_.index+p];if(c[m]=true,t=f.array[f.index],s=f.array[f.index+1],i=f.array[f.index+2],n=d[m],(r=h[m]).x>t&&(r.x=t),r.y>s&&(r.y=s),r.z>i&&(r.z=i),n.x<t&&(n.x=t),n.y<s&&(n.y=s),n.z<i&&(n.z=i),e){let h=a=t,d=o=s,c=l=i;for(let t=0;t<e.length;t++){let s=e[t],i=s.deltaPositions[3*u],n=s.deltaPositions[3*u+1],r=s.deltaPositions[3*u+2];i<0?h+=i:a+=i,n<0?d+=n:o+=n,r<0?c+=r:l+=r;}r.x>h&&(r.x=h),r.y>d&&(r.y=d),r.z>c&&(r.z=c),n.x<a&&(n.x=a),n.y<o&&(n.y=o),n.z<l&&(n.z=l);}}p.next();}let v=this.vertexBuffer.getFormat().elements.find(e=>e.name===e2);if(v&&v.normalize){let e=(()=>{switch(v.dataType){case 0:return e=>Math.max(e/127,-1);case 1:return e=>e/255;case 2:return e=>Math.max(e/32767,-1);case 3:return e=>e/65535;default:return e=>e}})();for(let t=0;t<u;t++)if(c[t]){let s=h[t],i=d[t];s.set(e(s.x),e(s.y),e(s.z)),i.set(e(i.x),e(i.y),e(i.z));}}for(let e=0;e<u;e++){let t=new eP;t.setMinMax(h[e],d[e]),this.boneAabb.push(t);}}_initGeometryData(){!this._geometryData&&(this._geometryData=new az,this.vertexBuffer&&(this._geometryData.vertexCount=this.vertexBuffer.numVertices,this._geometryData.maxVertices=this.vertexBuffer.numVertices),this.indexBuffer.length>0&&this.indexBuffer[0]&&(this._geometryData.indexCount=this.indexBuffer[0].numIndices,this._geometryData.maxIndices=this.indexBuffer[0].numIndices));}clear(e,t,s,i){ void 0===s&&(s=0),void 0===i&&(i=0),this._initGeometryData(),this._geometryData.initDefaults(),this._geometryData.recreate=true,this._geometryData.maxVertices=s,this._geometryData.maxIndices=i,this._geometryData.verticesUsage=+!e,this._geometryData.indicesUsage=+!t;}setVertexStream(e,t,s,i,n,r,a){ void 0===n&&(n=6),void 0===r&&(r=false),void 0===a&&(a=false),this._initGeometryData();let o=i||t.length/s;this._geometryData._changeVertexCount(o,e),this._geometryData.vertexStreamsUpdated=true,this._geometryData.vertexStreamDictionary[e]=new aV(t,s,n,r,a);}getVertexStream(e,t){let s=0,i=false;if(this._geometryData){let n=this._geometryData.vertexStreamDictionary[e];n&&(i=true,s=this._geometryData.vertexCount,ArrayBuffer.isView(t)?t.set(n.data):(t.length=0,t.push(n.data)));}return !i&&this.vertexBuffer&&(s=new re(this.vertexBuffer).readData(e,t)),s}setPositions(e,t,s){ void 0===t&&(t=az.DEFAULT_COMPONENTS_POSITION),this.setVertexStream(e2,e,t,s,6,false);}setNormals(e,t,s){ void 0===t&&(t=az.DEFAULT_COMPONENTS_NORMAL),this.setVertexStream(e3,e,t,s,6,false);}setUvs(e,t,s,i){ void 0===s&&(s=az.DEFAULT_COMPONENTS_UV),this.setVertexStream(e9+e,t,s,i,6,false);}setColors(e,t,s){ void 0===t&&(t=az.DEFAULT_COMPONENTS_COLORS),this.setVertexStream(e8,e,t,s,6,false);}setColors32(e,t){this.setVertexStream(e8,e,az.DEFAULT_COMPONENTS_COLORS,t,1,true);}setIndices(e,t){this._initGeometryData(),this._geometryData.indexStreamUpdated=true,this._geometryData.indices=e,this._geometryData.indexCount=t||e.length;}getPositions(e){return this.getVertexStream(e2,e)}getNormals(e){return this.getVertexStream(e3,e)}getUvs(e,t){return this.getVertexStream(e9+e,t)}getColors(e){return this.getVertexStream(e8,e)}getIndices(e){let t=0;if(this._geometryData&&this._geometryData.indices){let s=this._geometryData.indices;if(t=this._geometryData.indexCount,ArrayBuffer.isView(e))e.set(s);else {e.length=0;for(let t=0,i=s.length;t<i;t++)e.push(s[t]);}}else this.indexBuffer.length>0&&this.indexBuffer[0]&&(t=this.indexBuffer[0].readData(e));return t}update(e,t){if(void 0===e&&(e=4),void 0===t&&(t=true),this._geometryData){if(t){let e=this._geometryData.vertexStreamDictionary[e2];e&&3===e.componentCount&&(this._aabb.compute(e.data,this._geometryData.vertexCount),this._aabbVer++);}let s=this._geometryData.recreate;this._geometryData.vertexCount>this._geometryData.maxVertices&&(s=true,this._geometryData.maxVertices=this._geometryData.vertexCount),s&&this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);let i=this._geometryData.recreate;this._geometryData.indexCount>this._geometryData.maxIndices&&(i=true,this._geometryData.maxIndices=this._geometryData.indexCount),i&&this.indexBuffer.length>0&&this.indexBuffer[0]&&(this.indexBuffer[0].destroy(),this.indexBuffer[0]=null),this._geometryData.vertexStreamsUpdated&&this._updateVertexBuffer(),this._geometryData.indexStreamUpdated&&this._updateIndexBuffer(),this.primitive[0].type=e,this.indexBuffer.length>0&&this.indexBuffer[0]?this._geometryData.indexStreamUpdated&&(this.primitive[0].count=this._geometryData.indexCount,this.primitive[0].indexed=true):this._geometryData.vertexStreamsUpdated&&(this.primitive[0].count=this._geometryData.vertexCount,this.primitive[0].indexed=false),this._geometryData.vertexCount=0,this._geometryData.indexCount=0,this._geometryData.vertexStreamsUpdated=false,this._geometryData.indexStreamUpdated=false,this._geometryData.recreate=false,this.updateRenderStates();}}_buildVertexFormat(e){let t=[];for(let e in this._geometryData.vertexStreamDictionary){let s=this._geometryData.vertexStreamDictionary[e];t.push({semantic:e,components:s.componentCount,type:s.dataType,normalize:s.dataTypeNormalize,asInt:s.asInt});}return new sA(this.device,t,e)}_updateVertexBuffer(){if(!this.vertexBuffer){let e=this._geometryData.maxVertices,t=this._buildVertexFormat(e);this.vertexBuffer=new sy(this.device,t,e,{usage:this._geometryData.verticesUsage,storage:this._storageVertex});}let e=new re(this.vertexBuffer),t=this._geometryData.vertexCount;for(let s in this._geometryData.vertexStreamDictionary){let i=this._geometryData.vertexStreamDictionary[s];e.writeData(s,i.data,t),delete this._geometryData.vertexStreamDictionary[s];}e.end();}_updateIndexBuffer(){if(this.indexBuffer.length<=0||!this.indexBuffer[0]){let e=this._geometryData.maxVertices,t=this._storageIndex?{storage:true}:void 0;this.indexBuffer[0]=new nY(this.device,e>65535||0===e?2:1,this._geometryData.maxIndices,this._geometryData.indicesUsage,void 0,t);}let e=this._geometryData.indices;e&&(this.indexBuffer[0].writeData(e,this._geometryData.indexCount),this._geometryData.indices=null);}prepareRenderState(e){1===e?this.generateWireframe():2===e&&(this.primitive[2]={type:0,base:0,count:this.vertexBuffer?this.vertexBuffer.numVertices:0,indexed:false});}updateRenderStates(){this.primitive[2]&&this.prepareRenderState(2),this.primitive[1]&&this.prepareRenderState(1);}generateWireframe(){let e;this._destroyIndexBuffer(1);let t=this.vertexBuffer.numVertices,s=[];if(this.indexBuffer.length>0&&this.indexBuffer[0]){let i=[[0,1],[1,2],[2,0]],n=this.primitive[0].base,r=this.primitive[0].count,a=this.indexBuffer[0],o=new tZ[a.format](a.storage),l=new Set;for(let e=n;e<n+r;e+=3)for(let n=0;n<3;n++){let r=o[e+i[n][0]],a=o[e+i[n][1]],h=r>a?a*t+r:r*t+a;l.has(h)||(l.add(h),s.push(r,a));}e=a.format;}else {for(let e=0;e<t;e+=3)s.push(e,e+1,e+1,e+2,e+2,e);e=s.length>65535?2:1;}let i=new nY(this.vertexBuffer.device,e,s.length);new tZ[i.format](i.storage).set(s),i.unlock(),this.primitive[1]={type:1,base:0,count:s.length,indexed:true},this.indexBuffer[1]=i;}constructor(e,t){super(),this.indexBuffer=[null],this.vertexBuffer=null,this.primitive=[{type:0,base:0,count:0}],this.skin=null,this.boneAabb=null,this._aabbVer=0,this._aabb=new eP,this._geometryData=null,this._morph=null,this._storageIndex=false,this._storageVertex=false,this.id=ak++,this.device=e,this._storageIndex=(null==t?void 0:t.storageIndex)||false,this._storageVertex=(null==t?void 0:t.storageVertex)||false;}}let aH=new t8;function aW(e){return aH.get(e)}class aX{static incRef(e){this.cache.incRef(e);}static decRef(e){this.cache.decRef(e);}static destroy(){this.cache.destroy();}}aX.cache=new class{destroy(){this.cache.forEach((e,t)=>{t.destroy();}),this.cache.clear();}incRef(e){let t=(this.cache.get(e)||0)+1;this.cache.set(e,t);}decRef(e){if(e){let t=this.cache.get(e);t&&(0==--t?(this.cache.delete(e),e.destroy()):this.cache.set(e,t));}}constructor(){this.cache=new Map;}};let aY=0,aj=new eP,aq=new eP,aK=new eR,aZ=new Set,aQ=new Uint32Array(4);class aJ{destroy(){if(this._destroyVertexBuffer){var e;null==(e=this.vertexBuffer)||e.destroy();}this.vertexBuffer=null;}constructor(e){this.vertexBuffer=null,this._destroyVertexBuffer=false,this.count=e;}}class a${getBindGroup(e){if(!this.bindGroup){let t=this.shader.meshBindGroupFormat;this.bindGroup=new so(e,t);}return this.bindGroup}getUniformBuffer(e){if(!this.uniformBuffer){let t=this.shader.meshUniformBufferFormat;this.uniformBuffer=new no(e,t,false);}return this.uniformBuffer}destroy(){var e,t;null==(e=this.bindGroup)||e.destroy(),this.bindGroup=null,null==(t=this.uniformBuffer)||t.destroy(),this.uniformBuffer=null;}constructor(){this.bindGroup=null,this.uniformBuffer=null;}}class a0{set drawBucket(e){this._drawBucket=255&Math.floor(e),this.updateKey();}get drawBucket(){return this._drawBucket}set renderStyle(e){this._renderStyle=e,this.mesh.prepareRenderState(e);}get renderStyle(){return this._renderStyle}set mesh(e){e!==this._mesh&&(this._mesh&&this._mesh.decRefCount(),this._mesh=e,e&&e.incRefCount());}get mesh(){return this._mesh}set aabb(e){this._aabb=e;}get aabb(){if(!this._updateAabb)return this._aabb;if(this._updateAabbFunc)return this._updateAabbFunc(this._aabb);let e=this._customAabb,t=!!e;if(!e){if(e=aj,this.skinInstance){if(!this.mesh.boneAabb){let e=this._morphInstance?this._morphInstance.morph._targets:null;this.mesh._initBoneAabbs(e);}let s=this.mesh.boneUsed,i=true;for(let t=0;t<this.mesh.boneAabb.length;t++)s[t]&&(aq.setFromTransformedAabb(this.mesh.boneAabb[t],this.skinInstance.matrices[t]),i?(i=false,e.center.copy(aq.center),e.halfExtents.copy(aq.halfExtents)):e.add(aq));t=true;}else if(this.node._aabbVer!==this._aabbVer||this.mesh._aabbVer!==this._aabbMeshVer){if(this.mesh?(e.center.copy(this.mesh.aabb.center),e.halfExtents.copy(this.mesh.aabb.halfExtents)):(e.center.set(0,0,0),e.halfExtents.set(0,0,0)),this.mesh&&this.mesh.morph){let t=this.mesh.morph.aabb;e._expand(t.getMin(),t.getMax());}t=true,this._aabbVer=this.node._aabbVer,this._aabbMeshVer=this.mesh._aabbVer;}}return t&&this._aabb.setFromTransformedAabb(e,this.node.getWorldTransform()),this._aabb}clearShaders(){this._shaderCache.forEach(e=>{e.destroy();}),this._shaderCache.clear();}getShaderInstance(e,t,s,i,n,r,a){let o=this._shaderDefs;aQ[0]=e,aQ[1]=t,aQ[2]=o,aQ[3]=i.hash;let l=sx(aQ),h=this._shaderCache.get(l);if(!h){let t=this._material;if((h=new a$).shader=t.variants.get(l),h.hashes=new Uint32Array(aQ),!h.shader){var d;let c=t.getShaderVariant({device:this.mesh.device,scene:s,objDefs:o,cameraShaderParams:i,pass:e,sortedLights:a,viewUniformFormat:n,viewBindGroupFormat:r,vertexFormat:null==(d=this.mesh.vertexBuffer)?void 0:d.format});t.variants.set(l,c),h.shader=c;}this._shaderCache.set(l,h);}return h}set material(e){this.clearShaders();let t=this._material;t&&t.removeMeshInstanceRef(this),this._material=e,e&&(e.addMeshInstanceRef(this),this.transparent=e.transparent,this.updateKey());}get material(){return this._material}_updateShaderDefs(e){e!==this._shaderDefs&&(this._shaderDefs=e,this.clearShaders());}set calculateSortDistance(e){this._calculateSortDistance=e;}get calculateSortDistance(){return this._calculateSortDistance}set receiveShadow(e){this._receiveShadow!==e&&(this._receiveShadow=e,this._updateShaderDefs(e?-2&this._shaderDefs:1|this._shaderDefs));}get receiveShadow(){return this._receiveShadow}set batching(e){this._updateShaderDefs(e?16384|this._shaderDefs:-16385&this._shaderDefs);}get batching(){return (16384&this._shaderDefs)!=0}set skinInstance(e){this._skinInstance=e,this._updateShaderDefs(e?2|this._shaderDefs:-3&this._shaderDefs),this._setupSkinUpdate();}get skinInstance(){return this._skinInstance}set morphInstance(e){var t;null==(t=this._morphInstance)||t.destroy(),this._morphInstance=e;let s=this._shaderDefs;s=e&&e.morph.morphPositions?1024|s:-1025&s,s=e&&e.morph.morphNormals?2048|s:-2049&s,s=e&&e.morph.intRenderFormat?8192|s:-8193&s,this._updateShaderDefs(s);}get morphInstance(){return this._morphInstance}set screenSpace(e){this._screenSpace!==e&&(this._screenSpace=e,this._updateShaderDefs(e?256|this._shaderDefs:-257&this._shaderDefs));}get screenSpace(){return this._screenSpace}set key(e){this._sortKeyForward=e;}get key(){return this._sortKeyForward}set mask(e){let t=65535&this._shaderDefs;this._updateShaderDefs(t|e<<16);}get mask(){return this._shaderDefs>>16}set instancingCount(e){this.instancingData&&(this.instancingData.count=e);}get instancingCount(){return this.instancingData?this.instancingData.count:0}destroy(){var e,t,s;let i=this.mesh;i&&(this.mesh=null,i.refCount<1&&i.destroy()),this.setRealtimeLightmap(a0.lightmapParamNames[0],null),this.setRealtimeLightmap(a0.lightmapParamNames[1],null),null==(e=this._skinInstance)||e.destroy(),this._skinInstance=null,null==(t=this.morphInstance)||t.destroy(),this.morphInstance=null,this.clearShaders(),this.material=null,null==(s=this.instancingData)||s.destroy();}static _prepareRenderStyleForArray(e,t){if(e){for(let s=0;s<e.length;s++){e[s]._renderStyle=t;let i=e[s].mesh;aZ.has(i)||(aZ.add(i),i.prepareRenderState(t));}aZ.clear();}}_isVisible(e){return !!this.visible&&(this.isVisibleFunc?this.isVisibleFunc(e):(aK.center=this.aabb.center,aK.radius=this._aabb.halfExtents.length(),e.frustum.containsSphere(aK)>0))}updateKey(){let{material:e}=this;this._sortKeyForward=this._drawBucket<<25|(e.alphaToCoverage||e.alphaTest?0x1000000:0)|0xffffff&e.id;}setInstancing(e,t){ void 0===t&&(t=false),e?(this.instancingData=new aJ(e.numVertices),this.instancingData.vertexBuffer=e,e.format.instancing=true,this.cull=t):(this.instancingData=null,this.cull=true),this._updateShaderDefs(e?32|this._shaderDefs:-33&this._shaderDefs);}ensureMaterial(e){this.material||(this.material=aW(e));}clearParameters(){this.parameters={};}getParameters(){return this.parameters}getParameter(e){return this.parameters[e]}setParameter(e,t,s){ void 0===s&&(s=0xffffffff);let i=this.parameters[e];i?(i.data=t,i.passFlags=s):this.parameters[e]={scopeId:null,data:t,passFlags:s};}setRealtimeLightmap(e,t){let s=this.getParameter(e);s!==t&&(s&&aX.decRef(s.data),t?(aX.incRef(t),this.setParameter(e,t)):this.deleteParameter(e));}deleteParameter(e){this.parameters[e]&&delete this.parameters[e];}setParameters(e,t){let s=this.parameters;for(let i in s){let n=s[i];n.passFlags&t&&(n.scopeId||(n.scopeId=e.scope.resolve(i)),n.scopeId.setValue(n.data));}}setLightmapped(e){e?this.mask=(2|this.mask)&-6:(this.setRealtimeLightmap(a0.lightmapParamNames[0],null),this.setRealtimeLightmap(a0.lightmapParamNames[1],null),this._shaderDefs&=-4289,this.mask=(1|this.mask)&-7);}setCustomAabb(e){e?this._customAabb?this._customAabb.copy(e):this._customAabb=e.clone():(this._customAabb=null,this._aabbVer=-1),this._setupSkinUpdate();}_setupSkinUpdate(){this._skinInstance&&(this._skinInstance._updateBeforeCull=!this._customAabb);}constructor(e,t,s=null){if(this.castShadow=false,this.cull=true,this.drawOrder=0,this._drawBucket=127,this.visible=true,this.visibleThisFrame=false,this.flipFacesFactor=1,this.gsplatInstance=null,this.id=aY++,this.isVisibleFunc=null,this.instancingData=null,this.parameters={},this.pick=true,this.stencilFront=null,this.stencilBack=null,this.transparent=false,this._aabb=new eP,this._aabbVer=-1,this._aabbMeshVer=-1,this._customAabb=null,this._updateAabb=true,this._updateAabbFunc=null,this._sortKeyShadow=0,this._sortKeyForward=0,this._sortKeyDynamic=0,this._layer=15,this._material=null,this._skinInstance=null,this._morphInstance=null,this._receiveShadow=true,this._renderStyle=0,this._screenSpace=false,this._shaderCache=new Map,this._shaderDefs=65536,this._calculateSortDistance=null,this.node=s,this._mesh=e,e.incRefCount(),this.material=t,e.vertexBuffer){let t=e.vertexBuffer.format;this._shaderDefs|=4*!!t.hasUv0,this._shaderDefs|=8*!!t.hasUv1,this._shaderDefs|=16*!!t.hasColor,this._shaderDefs|=512*!!t.hasTangents;}this.updateKey();}}a0.lightmapParamNames=["texture_lightMap","texture_dirLightMap"];let a1=[0,1,3,2,3,1],a2=[0,1,3,0,3,2],a3=new ep;function a4(e,t){if(e&&!t||!e&&t)return  false;if((e=e.data)===(t=t.data))return  true;if(e instanceof Float32Array&&t instanceof Float32Array){if(e.length!==t.length)return  false;for(let s=0;s<e.length;s++)if(e[s]!==t[s])return  false;return  true}return  false}function a5(e){return e.node.worldTransform.scaleSign}class a6{destroy(){this.device=null,this.rootNode=null,this.scene=null,this._batchGroups={},this._batchList=[],this._dirtyGroups=[];}addGroup(e,t,s,i,n){if(void 0===i&&(i=this._batchGroupCounter,this._batchGroupCounter++),this._batchGroups[i])return;let r=new aF(i,e,t,s,n);return this._batchGroups[i]=r,r}removeGroup(e){if(!this._batchGroups[e])return;let t=[];for(let s=0;s<this._batchList.length;s++)this._batchList[s].batchGroupId===e?this.destroyBatch(this._batchList[s]):t.push(this._batchList[s]);this._batchList=t,this._removeModelsFromBatchGroup(this.rootNode,e),delete this._batchGroups[e];}markGroupDirty(e){0>this._dirtyGroups.indexOf(e)&&this._dirtyGroups.push(e);}getGroupByName(e){let t=this._batchGroups;for(let s in t)if(t.hasOwnProperty(s)&&t[s].name===e)return t[s];return null}getBatches(e){let t=[],s=this._batchList.length;for(let i=0;i<s;i++){let s=this._batchList[i];s.batchGroupId===e&&t.push(s);}return t}_removeModelsFromBatchGroup(e,t){if(e.enabled){e.model&&e.model.batchGroupId===t&&(e.model.batchGroupId=-1),e.render&&e.render.batchGroupId===t&&(e.render.batchGroupId=-1),e.element&&e.element.batchGroupId===t&&(e.element.batchGroupId=-1),e.sprite&&e.sprite.batchGroupId===t&&(e.sprite.batchGroupId=-1);for(let s=0;s<e._children.length;s++)this._removeModelsFromBatchGroup(e._children[s],t);}}insert(e,t,s){let i=this._batchGroups[t];i&&0>i._obj[e].indexOf(s)&&(i._obj[e].push(s),this.markGroupDirty(t));}remove(e,t,s){let i=this._batchGroups[t];if(i){let n=i._obj[e].indexOf(s);n>=0&&(i._obj[e].splice(n,1),this.markGroupDirty(t));}}_extractRender(e,t,s,i){return e.render&&(t=i[e.render.batchGroupId]=t.concat(e.render.meshInstances),e.render.removeFromLayers()),t}_extractModel(e,t,s,i){return e.model&&e.model.model&&(t=i[e.model.batchGroupId]=t.concat(e.model.meshInstances),e.model.removeModelFromLayers()),t}_extractElement(e,t,s){if(!e.element)return;let i=false;e.element._text&&e.element._text._model.meshInstances.length>0?(t.push(e.element._text._model.meshInstances[0]),e.element.removeModelFromLayers(e.element._text._model),i=true):e.element._image&&(t.push(e.element._image._renderable.meshInstance),e.element.removeModelFromLayers(e.element._image._renderable.model),!e.element._image._renderable.unmaskMeshInstance||(t.push(e.element._image._renderable.unmaskMeshInstance),e.element._image._renderable.unmaskMeshInstance.stencilFront&&e.element._image._renderable.unmaskMeshInstance.stencilBack||(e.element._dirtifyMask(),e.element._onPrerender())),i=true),i&&(s._ui=true);}_collectAndRemoveMeshInstances(e,t){for(let s=0;s<t.length;s++){let i=t[s],n=this._batchGroups[i];if(!n)continue;let r=e[i];r||(r=e[i]=[]);for(let t=0;t<n._obj.model.length;t++)r=this._extractModel(n._obj.model[t],r,n,e);for(let t=0;t<n._obj.render.length;t++)r=this._extractRender(n._obj.render[t],r,n,e);for(let e=0;e<n._obj.element.length;e++)this._extractElement(n._obj.element[e],r,n);for(let e=0;e<n._obj.sprite.length;e++){let t=n._obj.sprite[e];t.sprite&&t.sprite._meshInstance&&(n.dynamic||0===t.sprite.sprite._renderMode)&&(r.push(t.sprite._meshInstance),t.sprite.removeModelFromLayers(),n._sprite=true,t.sprite._batchGroup=n);}}}generate(e){let t,s,i,n;let r={};e||(e=Object.keys(this._batchGroups));let a=[];for(let t=0;t<this._batchList.length;t++){if(0>e.indexOf(this._batchList[t].batchGroupId)){a.push(this._batchList[t]);continue}this.destroyBatch(this._batchList[t]);}if(this._batchList=a,this._collectAndRemoveMeshInstances(r,e),e===this._dirtyGroups)this._dirtyGroups.length=0;else {let t=[];for(let s=0;s<this._dirtyGroups.length;s++)0>e.indexOf(this._dirtyGroups[s])&&t.push(this._dirtyGroups[s]);this._dirtyGroups=t;}for(let e in r)if(r.hasOwnProperty(e)){if(t=r[e],!(i=this._batchGroups[e]))continue;s=this.prepare(t,i.dynamic,i.maxAabbSize,i._ui||i._sprite);for(let t=0;t<s.length;t++)(n=this.create(s[t],i.dynamic,parseInt(e,10)))&&n.addToLayers(this.scene,i.layers);}}prepare(e,t,s,i){let n,r;if(void 0===s&&(s=Number.POSITIVE_INFINITY),0===e.length)return [];let a=.5*s,o=new eP,l=new eP,h=null,d=[],c=0;i&&e.sort((e,t)=>e.drawOrder-t.drawOrder);let u=e,p=i?function(e){h?h.add(e.aabb):h=e.aabb.clone(),r.push(e);}:function(e){r.push(e);};for(;u.length>0;){d[c]=[u[0]],r=[];let e=u[0].material,s=u[0].layer,f=u[0]._shaderDefs,m=u[0].parameters,_=u[0].stencilFront,g=u[0].mesh.vertexBuffer.getNumVertices(),v=u[0].drawOrder;o.copy(u[0].aabb);let y=a5(u[0]),S=u[0].mesh.vertexBuffer.format.batchingHash,x=u[0].mesh.primitive[0].indexed;h=null;for(let T=1;T<u.length;T++){let b=u[T];if(t&&d[c].length>=1024){r=r.concat(u.slice(T));break}if(e!==b.material||s!==b.layer||S!==b.mesh.vertexBuffer.format.batchingHash||x!==b.mesh.primitive[0].indexed||f!==b._shaderDefs||g+b.mesh.vertexBuffer.getNumVertices()>0xffffffff||(l.copy(o),l.add(b.aabb),l.halfExtents.x>a||l.halfExtents.y>a||l.halfExtents.z>a||_&&(!(n=b.stencilFront)||_.func!==n.func||_.zpass!==n.zpass)||y!==a5(b)||!function(e,t){for(let s in e)if(e.hasOwnProperty(s)&&!a4(e[s],t[s]))return  false;for(let s in t)if(t.hasOwnProperty(s)&&!a4(t[s],e[s]))return  false;return  true}(m,b.parameters)||i&&h&&h.intersects(b.aabb)&&b.drawOrder!==v)){p(b);continue}o.add(b.aabb),g+=b.mesh.vertexBuffer.getNumVertices(),d[c].push(b);}c++,u=r;}return d}collectBatchedMeshData(e,t){let s=null,i=0,n=0,r=null;for(let a=0;a<e.length;a++)if(e[a].visible){let o=e[a].mesh;if(i+=o.vertexBuffer.numVertices,o.primitive[0].indexed)n+=o.primitive[0].count;else {let e=o.primitive[0].type;(6===e||5===e)&&4===o.primitive[0].count&&(n+=6);}if(!s){r=e[a].material,s={};let i=o.vertexBuffer.format.elements;for(let e=0;e<i.length;e++)s[i[e].name]={numComponents:i[e].numComponents,dataType:i[e].dataType,normalize:i[e].normalize,count:0};t&&(s[e6]={numComponents:1,dataType:6,normalize:false,count:0});}}return {streams:s,batchNumVerts:i,batchNumIndices:n,material:r}}create(e,t,s){let i,n,r;this._init||(this.vertexFormats={},this._init=true);let a=null,o=null,l=this.collectBatchedMeshData(e,t);if(l.streams){let h,d,c,u;let p=l.streams,f=l.material,m=l.batchNumVerts,_=l.batchNumIndices;o=new aO(e,t,s),this._batchList.push(o);let g=0,v=0,y=new(m<=65535?Uint16Array:Uint32Array)(_);for(i in p)(a=p[i]).typeArrayType=tq[a.dataType],a.elementByteSize=tK[a.dataType],a.buffer=new a.typeArrayType(m*a.numComponents);for(let s=0;s<e.length;s++)if(e[s].visible){for(i in r=(n=e[s].mesh).vertexBuffer.numVertices,t||(u=e[s].node.getWorldTransform()),p)if(i!==e6){let e=new(a=p[i]).typeArrayType(a.buffer.buffer,a.elementByteSize*a.count),s=n.getVertexStream(i,e)*a.numComponents;if(a.count+=s,!t&&a.numComponents>=3){if(i===e2){let t,i,n;let r=u.data,o=r[0],l=r[1],h=r[2],d=r[4],c=r[5],p=r[6],f=r[8],m=r[9],_=r[10],g=r[12],v=r[13],y=r[14];for(let r=0;r<s;r+=a.numComponents)t=e[r],i=e[r+1],n=e[r+2],e[r]=t*o+i*d+n*f+g,e[r+1]=t*l+i*c+n*m+v,e[r+2]=t*h+i*p+n*_+y;}else if(i===e3||i===e4){let t,i,n;a3.invertMat4(u).transpose();let[r,o,l,h,d,c,p,f,m]=a3.data;for(let u=0;u<s;u+=a.numComponents)t=e[u],i=e[u+1],n=e[u+2],e[u]=t*r+i*h+n*p,e[u+1]=t*o+i*d+n*f,e[u+2]=t*l+i*c+n*m;}}}if(t){a=p[e6];for(let e=0;e<r;e++)a.buffer[a.count++]=s;}if(n.primitive[0].indexed)h=n.primitive[0].base,d=n.primitive[0].count,c=new tZ[n.indexBuffer[0].getFormat()](n.indexBuffer[0].storage);else {let e=n.primitive[0].type;if(6===e||5===e){if(4===n.primitive[0].count)h=0,d=6,c=6===e?a1:a2;else {d=0;continue}}}for(let e=0;e<d;e++)y[e+v]=c[h+e]+g;v+=d,g+=r;}for(i in n=new aG(this.device),p)a=p[i],n.setVertexStream(i,a.buffer,a.numComponents,void 0,a.dataType,a.normalize);y.length>0&&n.setIndices(y),n.update(4,false),t&&(f=f.clone()).update();let S=new a0(n,f,this.rootNode);S.castShadow=o.origMeshInstances[0].castShadow,S.parameters=o.origMeshInstances[0].parameters,S.layer=o.origMeshInstances[0].layer,S._shaderDefs=o.origMeshInstances[0]._shaderDefs,S.batching=true,S.cull=o.origMeshInstances[0].cull;let x=this._batchGroups[s];if(x&&x._ui&&(S.cull=false),t){let e=[];for(let t=0;t<o.origMeshInstances.length;t++)e.push(o.origMeshInstances[t].node);S.skinInstance=new aU(this.device,e,this.rootNode);}S._updateAabb=false,S.drawOrder=o.origMeshInstances[0].drawOrder,S.stencilFront=o.origMeshInstances[0].stencilFront,S.stencilBack=o.origMeshInstances[0].stencilBack,S.flipFacesFactor=a5(o.origMeshInstances[0]),S.castShadow=o.origMeshInstances[0].castShadow,o.meshInstance=S,o.updateBoundingBox();}return o}updateAll(){this._dirtyGroups.length>0&&this.generate(this._dirtyGroups);for(let e=0;e<this._batchList.length;e++)this._batchList[e].dynamic&&this._batchList[e].updateBoundingBox();}clone(e,t){let s=new aO(t,e.dynamic,e.batchGroupId);this._batchList.push(s);let i=[];for(let e=0;e<t.length;e++)i.push(t[e].node);return s.meshInstance=new a0(e.meshInstance.mesh,e.meshInstance.material,e.meshInstance.node),s.meshInstance._updateAabb=false,s.meshInstance.parameters=t[0].parameters,s.meshInstance.cull=t[0].cull,s.meshInstance.layer=t[0].layer,e.dynamic&&(s.meshInstance.skinInstance=new aU(this.device,i,this.rootNode)),s.meshInstance.castShadow=e.meshInstance.castShadow,s}destroyBatch(e){e.destroy(this.scene,this._batchGroups[e.batchGroupId].layers);}constructor(e,t,s){this.device=e,this.rootNode=t,this.scene=s,this._init=false,this._batchGroups={},this._batchGroupCounter=0,this._batchList=[],this._dirtyGroups=[];}}let a8="uSceneColorMap";class a9 extends nK{destroy(){super.destroy(),this.releaseRenderTarget(this.colorRenderTarget);}shouldReallocate(e,t,s){if((null==e?void 0:e.colorBuffer.format)!==s)return  true;let i=(null==t?void 0:t.width)||this.device.width,n=(null==t?void 0:t.height)||this.device.height;return !e||i!==e.width||n!==e.height}allocateRenderTarget(e,t,s,i){let n=new se(s,{name:a8,format:i,width:t?t.colorBuffer.width:s.width,height:t?t.colorBuffer.height:s.height,mipmaps:true,minFilter:5,magFilter:1,addressU:1,addressV:1});return e?(e.destroyFrameBuffers(),e._colorBuffer=n,e._colorBuffers=[n]):e=new sR({name:"ColorGrabRT",colorBuffer:n,depth:false,stencil:false,autoResolve:false}),e}releaseRenderTarget(e){e&&(e.destroyTextureBuffers(),e.destroy());}frameUpdate(){var e;let t=this.device,s=this.source,i=null!=(e=null==s?void 0:s.colorBuffer.format)?e:this.device.backBufferFormat;this.shouldReallocate(this.colorRenderTarget,null==s?void 0:s.colorBuffer,i)&&(this.releaseRenderTarget(this.colorRenderTarget),this.colorRenderTarget=this.allocateRenderTarget(this.colorRenderTarget,s,t,i));let n=this.colorRenderTarget.colorBuffer;t.scope.resolve(a8).setValue(n);}execute(){let e=this.device,t=this.source,s=this.colorRenderTarget.colorBuffer;e.isWebGPU?(e.copyRenderTarget(t,this.colorRenderTarget,true,false),e.mipmapRenderer.generate(this.colorRenderTarget.colorBuffer.impl)):(e.copyRenderTarget(t,this.colorRenderTarget,true,false),e.activeTexture(e.maxCombinedTextures-1),e.bindTexture(s),e.gl.generateMipmap(s.impl._glTarget));}constructor(...e){super(...e),this.colorRenderTarget=null,this.source=null;}}let a7="uSceneDepthMap";class oe extends nK{destroy(){super.destroy(),this.releaseRenderTarget(this.depthRenderTarget);}shouldReallocate(e,t){let s=(null==t?void 0:t.width)||this.device.width,i=(null==t?void 0:t.height)||this.device.height;return !e||s!==e.width||i!==e.height}allocateRenderTarget(e,t,s,i,n){let r=new se(s,{name:a7,format:i,width:t?t.colorBuffer.width:s.width,height:t?t.colorBuffer.height:s.height,mipmaps:false,minFilter:0,magFilter:0,addressU:1,addressV:1});return e?(e.destroyFrameBuffers(),n?e._depthBuffer=r:(e._colorBuffer=r,e._colorBuffers=[r])):e=new sR({name:"DepthGrabRT",colorBuffer:n?null:r,depthBuffer:n?r:null,depth:!n,stencil:s.supportsStencil,autoResolve:false}),e}releaseRenderTarget(e){e&&(e.destroyTextureBuffers(),e.destroy());}before(){var e,t,s,i;let n=this.camera,r=this.device,a=null!=(s=null==n?void 0:n.renderTarget)?s:r.backBuffer,o=true,l=a.stencil?17:16;r.isWebGPU&&a.samples>1&&(l=15,o=false);let h=null!=(i=null==(e=n.renderTarget)?void 0:e.depthBuffer)?i:null==(t=n.renderTarget)?void 0:t.colorBuffer;this.shouldReallocate(this.depthRenderTarget,h)&&(this.releaseRenderTarget(this.depthRenderTarget),this.depthRenderTarget=this.allocateRenderTarget(this.depthRenderTarget,n.renderTarget,r,l,o));let d=o?this.depthRenderTarget.depthBuffer:this.depthRenderTarget.colorBuffer;r.scope.resolve(a7).setValue(d);}execute(){let e=this.device;if(e.isWebGL2&&e.renderTarget.samples>1){let t=e.renderTarget.impl._glFrameBuffer,s=this.depthRenderTarget;e.renderTarget=s,e.updateBegin(),this.depthRenderTarget.impl.internalResolve(e,t,s.impl._glFrameBuffer,this.depthRenderTarget,e.gl.DEPTH_BUFFER_BIT);}else e.copyRenderTarget(e.renderTarget,this.depthRenderTarget,false,true);}constructor(e,t){super(e),this.depthRenderTarget=null,this.camera=null,this.camera=t;}}class ot{get hash(){if(void 0===this._hash){let e=this.gammaCorrection+"_"+this.toneMapping+"_"+this.srgbRenderTarget+"_"+this.fog+"_"+this.ssaoEnabled+"_"+this.sceneDepthMapLinear;this._hash=sS(e);}return this._hash}get defines(){let e=this._defines;return this._definesDirty&&(this._definesDirty=false,e.clear(),this._sceneDepthMapLinear&&e.set("SCENE_DEPTHMAP_LINEAR",true),e.set("FOG",this._fog.toUpperCase()),e.set("TONEMAP",rJ[this._toneMapping]),e.set("GAMMA",rQ[this.shaderOutputGamma])),e}markDirty(){this._hash=void 0,this._definesDirty=true;}set fog(e){this._fog!==e&&(this._fog=e,this.markDirty());}get fog(){return this._fog}set ssaoEnabled(e){this._ssaoEnabled!==e&&(this._ssaoEnabled=e,this.markDirty());}get ssaoEnabled(){return this._ssaoEnabled}set gammaCorrection(e){this._gammaCorrectionAssigned=true,this._gammaCorrection!==e&&(this._gammaCorrection=e,this.markDirty());}get gammaCorrection(){return this._gammaCorrection}set toneMapping(e){this._toneMapping!==e&&(this._toneMapping=e,this.markDirty());}get toneMapping(){return this._toneMapping}set srgbRenderTarget(e){this._srgbRenderTarget!==e&&(this._srgbRenderTarget=e,this.markDirty());}get srgbRenderTarget(){return this._srgbRenderTarget}set sceneDepthMapLinear(e){this._sceneDepthMapLinear!==e&&(this._sceneDepthMapLinear=e,this.markDirty());}get sceneDepthMapLinear(){return this._sceneDepthMapLinear}get shaderOutputGamma(){return 1!==this._gammaCorrection||this._srgbRenderTarget?0:1}constructor(){this._gammaCorrection=1,this._toneMapping=0,this._srgbRenderTarget=false,this._ssaoEnabled=false,this._fog=rH,this._sceneDepthMapLinear=false,this._defines=new Map,this._definesDirty=true;}}let os=new eu,oi=new eu,on=new eu,or=new ex,oa=[new eu,new eu,new eu,new eu,new eu,new eu,new eu,new eu];class oo{destroy(){var e,t;null==(e=this.renderPassColorGrab)||e.destroy(),this.renderPassColorGrab=null,null==(t=this.renderPassDepthGrab)||t.destroy(),this.renderPassDepthGrab=null,this.renderPasses.length=0;}_storeShaderMatrices(e,t,s,i){if(this._shaderMatricesVersion!==i){var n;this._shaderMatricesVersion=i,this._viewProjPrevious.copy(null!=(n=this._viewProjCurrent)?n:e),null!=this._viewProjCurrent||(this._viewProjCurrent=new ex),this._viewProjCurrent.copy(e),this._viewProjInverse.invert(e),this._jitters[2]=this._jitters[0],this._jitters[3]=this._jitters[1],this._jitters[0]=t,this._jitters[1]=s;}}get fullSizeClearRect(){let e=this._scissorRectClear?this.scissorRect:this._rect;return 0===e.x&&0===e.y&&1===e.z&&1===e.w}set aspectRatio(e){this._aspectRatio!==e&&(this._aspectRatio=e,this._projMatDirty=true);}get aspectRatio(){var e;return (null==(e=this.xr)?void 0:e.active)?this._xrProperties.aspectRatio:this._aspectRatio}set aspectRatioMode(e){this._aspectRatioMode!==e&&(this._aspectRatioMode=e,this._projMatDirty=true);}get aspectRatioMode(){return this._aspectRatioMode}set calculateProjection(e){this._calculateProjection=e,this._projMatDirty=true;}get calculateProjection(){return this._calculateProjection}set calculateTransform(e){this._calculateTransform=e;}get calculateTransform(){return this._calculateTransform}set clearColor(e){this._clearColor.copy(e);}get clearColor(){return this._clearColor}set clearColorBuffer(e){this._clearColorBuffer=e;}get clearColorBuffer(){return this._clearColorBuffer}set clearDepth(e){this._clearDepth=e;}get clearDepth(){return this._clearDepth}set clearDepthBuffer(e){this._clearDepthBuffer=e;}get clearDepthBuffer(){return this._clearDepthBuffer}set clearStencil(e){this._clearStencil=e;}get clearStencil(){return this._clearStencil}set clearStencilBuffer(e){this._clearStencilBuffer=e;}get clearStencilBuffer(){return this._clearStencilBuffer}set cullFaces(e){this._cullFaces=e;}get cullFaces(){return this._cullFaces}set farClip(e){this._farClip!==e&&(this._farClip=e,this._projMatDirty=true);}get farClip(){var e;return (null==(e=this.xr)?void 0:e.active)?this._xrProperties.farClip:this._farClip}set flipFaces(e){this._flipFaces=e;}get flipFaces(){return this._flipFaces}set fov(e){this._fov!==e&&(this._fov=e,this._projMatDirty=true);}get fov(){var e;return (null==(e=this.xr)?void 0:e.active)?this._xrProperties.fov:this._fov}set frustumCulling(e){this._frustumCulling=e;}get frustumCulling(){return this._frustumCulling}set horizontalFov(e){this._horizontalFov!==e&&(this._horizontalFov=e,this._projMatDirty=true);}get horizontalFov(){var e;return (null==(e=this.xr)?void 0:e.active)?this._xrProperties.horizontalFov:this._horizontalFov}set layers(e){this._layers=e.slice(0),this._layersSet=new Set(this._layers);}get layers(){return this._layers}get layersSet(){return this._layersSet}set nearClip(e){this._nearClip!==e&&(this._nearClip=e,this._projMatDirty=true);}get nearClip(){var e;return (null==(e=this.xr)?void 0:e.active)?this._xrProperties.nearClip:this._nearClip}set node(e){this._node=e;}get node(){return this._node}set orthoHeight(e){this._orthoHeight!==e&&(this._orthoHeight=e,this._projMatDirty=true);}get orthoHeight(){return this._orthoHeight}set projection(e){this._projection!==e&&(this._projection=e,this._projMatDirty=true);}get projection(){return this._projection}get projectionMatrix(){return this._evaluateProjectionMatrix(),this._projMat}set rect(e){this._rect.copy(e);}get rect(){return this._rect}set renderTarget(e){this._renderTarget=e;}get renderTarget(){return this._renderTarget}set scissorRect(e){this._scissorRect.copy(e);}get scissorRect(){return this._scissorRect}get viewMatrix(){if(this._viewMatDirty){let e=this._node.getWorldTransform();this._viewMat.copy(e).invert(),this._viewMatDirty=false;}return this._viewMat}set aperture(e){this._aperture=e;}get aperture(){return this._aperture}set sensitivity(e){this._sensitivity=e;}get sensitivity(){return this._sensitivity}set shutter(e){this._shutter=e;}get shutter(){return this._shutter}set xr(e){this._xr!==e&&(this._xr=e,this._projMatDirty=true);}get xr(){return this._xr}clone(){return new oo().copy(this)}copy(e){return this._aspectRatio=e._aspectRatio,this._farClip=e._farClip,this._fov=e._fov,this._horizontalFov=e._horizontalFov,this._nearClip=e._nearClip,this._xrProperties.aspectRatio=e._xrProperties.aspectRatio,this._xrProperties.farClip=e._xrProperties.farClip,this._xrProperties.fov=e._xrProperties.fov,this._xrProperties.horizontalFov=e._xrProperties.horizontalFov,this._xrProperties.nearClip=e._xrProperties.nearClip,this.aspectRatioMode=e.aspectRatioMode,this.calculateProjection=e.calculateProjection,this.calculateTransform=e.calculateTransform,this.clearColor=e.clearColor,this.clearColorBuffer=e.clearColorBuffer,this.clearDepth=e.clearDepth,this.clearDepthBuffer=e.clearDepthBuffer,this.clearStencil=e.clearStencil,this.clearStencilBuffer=e.clearStencilBuffer,this.cullFaces=e.cullFaces,this.flipFaces=e.flipFaces,this.frustumCulling=e.frustumCulling,this.layers=e.layers,this.orthoHeight=e.orthoHeight,this.projection=e.projection,this.rect=e.rect,this.renderTarget=e.renderTarget,this.scissorRect=e.scissorRect,this.aperture=e.aperture,this.shutter=e.shutter,this.sensitivity=e.sensitivity,this.shaderPassInfo=e.shaderPassInfo,this.jitter=e.jitter,this._projMatDirty=true,this}_enableRenderPassColorGrab(e,t){if(t)this.renderPassColorGrab||(this.renderPassColorGrab=new a9(e));else {var s;null==(s=this.renderPassColorGrab)||s.destroy(),this.renderPassColorGrab=null;}}_enableRenderPassDepthGrab(e,t,s){if(s)this.renderPassDepthGrab||(this.renderPassDepthGrab=new oe(e,this));else {var i;null==(i=this.renderPassDepthGrab)||i.destroy(),this.renderPassDepthGrab=null;}}_updateViewProjMat(){(this._projMatDirty||this._viewMatDirty||this._viewProjMatDirty)&&(this._viewProjMat.mul2(this.projectionMatrix,this.viewMatrix),this._viewProjMatDirty=false);}worldToScreen(e,t,s,i){ void 0===i&&(i=new eu),this._updateViewProjMat(),this._viewProjMat.transformPoint(e,i);let n=this._viewProjMat.data,r=e.x*n[3]+e.y*n[7]+e.z*n[11]+ +n[15];return i.x=(i.x/r+1)*.5*t,i.y=(1-i.y/r)*.5*s,i}screenToWorld(e,t,s,i,n,r){ void 0===r&&(r=new eu);let a=this.farClip-this.nearClip;if(os.set(e/i,(n-t)/n,s/a),os.mulScalar(2),os.sub(eu.ONE),0===this._projection){ex._getPerspectiveHalfSize(oi,this.fov,this.aspectRatio,this.nearClip,this.horizontalFov),oi.x*=os.x,oi.y*=os.y;let e=this._node.getWorldTransform();oi.z=-this.nearClip,e.transformPoint(oi,on);let t=this._node.getPosition();r.sub2(on,t),r.normalize(),r.mulScalar(s),r.add(t);}else this._updateViewProjMat(),or.copy(this._viewProjMat).invert(),or.transformPoint(os,r);return r}_evaluateProjectionMatrix(){if(this._projMatDirty){if(0===this._projection)this._projMat.setPerspective(this.fov,this.aspectRatio,this.nearClip,this.farClip,this.horizontalFov),this._projMatSkybox.copy(this._projMat);else {let e=this._orthoHeight,t=e*this.aspectRatio;this._projMat.setOrtho(-t,t,-e,e,this.nearClip,this.farClip),this._projMatSkybox.setPerspective(this.fov,this.aspectRatio,this.nearClip,this.farClip);}this._projMatDirty=false;}}getProjectionMatrixSkybox(){return this._evaluateProjectionMatrix(),this._projMatSkybox}getExposure(){return 1/(1.2*Math.pow(2,Math.log2(this._aperture*this._aperture/this._shutter*100/this._sensitivity)))}getScreenSize(e){if(0===this._projection){let t=this._node.getPosition().distance(e.center);return t<e.radius?1:Math.min(Math.tan(Math.asin(e.radius/t))/Math.tan(this.fov/2*ei.DEG_TO_RAD),1)}return ei.clamp(e.radius/this._orthoHeight,0,1)}getFrustumCorners(e,t){let s,i;void 0===e&&(e=this.nearClip),void 0===t&&(t=this.farClip);let n=this.fov*Math.PI/180;return 0===this.projection?this.horizontalFov?i=(s=e*Math.tan(n/2))/this.aspectRatio:s=(i=e*Math.tan(n/2))*this.aspectRatio:s=(i=this._orthoHeight)*this.aspectRatio,oa[0].x=s,oa[0].y=-i,oa[0].z=-e,oa[1].x=s,oa[1].y=i,oa[1].z=-e,oa[2].x=-s,oa[2].y=i,oa[2].z=-e,oa[3].x=-s,oa[3].y=-i,oa[3].z=-e,0===this._projection&&(this.horizontalFov?i=(s=t*Math.tan(n/2))/this.aspectRatio:s=(i=t*Math.tan(n/2))*this.aspectRatio),oa[4].x=s,oa[4].y=-i,oa[4].z=-t,oa[5].x=s,oa[5].y=i,oa[5].z=-t,oa[6].x=-s,oa[6].y=i,oa[6].z=-t,oa[7].x=-s,oa[7].y=-i,oa[7].z=-t,oa}setXrProperties(e){Object.assign(this._xrProperties,e),this._projMatDirty=true;}constructor(){this.shaderPassInfo=null,this.renderPassColorGrab=null,this.renderPassDepthGrab=null,this.fogParams=null,this.shaderParams=new ot,this.renderPasses=[],this.jitter=0,this._aspectRatio=16/9,this._aspectRatioMode=0,this._calculateProjection=null,this._calculateTransform=null,this._clearColor=new en(.75,.75,.75,1),this._clearColorBuffer=true,this._clearDepth=1,this._clearDepthBuffer=true,this._clearStencil=0,this._clearStencilBuffer=true,this._cullFaces=true,this._farClip=1e3,this._flipFaces=false,this._fov=45,this._frustumCulling=true,this._horizontalFov=false,this._layers=[0,1,2,4,3],this._layersSet=new Set(this._layers),this._nearClip=.1,this._node=null,this._orthoHeight=10,this._projection=0,this._rect=new em(0,0,1,1),this._renderTarget=null,this._scissorRect=new em(0,0,1,1),this._scissorRectClear=false,this._aperture=16,this._shutter=.001,this._sensitivity=1e3,this._projMat=new ex,this._projMatDirty=true,this._projMatSkybox=new ex,this._viewMat=new ex,this._viewMatDirty=true,this._viewProjMat=new ex,this._viewProjMatDirty=true,this._shaderMatricesVersion=0,this._viewProjInverse=new ex,this._viewProjCurrent=null,this._viewProjPrevious=new ex,this._jitters=[0,0,0,0],this.frustum=new eD,this._xr=null,this._xrProperties={horizontalFov:this._horizontalFov,fov:this._fov,aspectRatio:this._aspectRatio,farClip:this._farClip,nearClip:this._nearClip};}}let ol=new ex,oh=new eu,od=new eT,oc=new eT,ou=new eu,op=new eu,of=new ex,om=new eT,o_=new eu,og=new ex,ov=new eT,oy=new eT,oS=new ex,ox=new eu,oT=new eu;function ob(e,t){return e instanceof Function?e:s=>{let i=s[e];return i instanceof Function&&(i=i()),i===t}}class oE extends Y{get right(){return this._right||(this._right=new eu),this.getWorldTransform().getX(this._right).normalize()}get up(){return this._up||(this._up=new eu),this.getWorldTransform().getY(this._up).normalize()}get forward(){return this._forward||(this._forward=new eu),this.getWorldTransform().getZ(this._forward).normalize().mulScalar(-1)}get normalMatrix(){let e=this._normalMatrix;return this._dirtyNormal&&(e.invertMat4(this.getWorldTransform()).transpose(),this._dirtyNormal=false),e}set enabled(e){if(this._enabled!==e){var t;this._enabled=e,(e&&(null==(t=this._parent)?void 0:t.enabled)||!e)&&this._notifyHierarchyStateChanged(this,e);}}get enabled(){return this._enabled&&this._enabledInHierarchy}get parent(){return this._parent}get path(){let e=this._parent;if(!e)return "";let t=this.name;for(;e&&e._parent;)t=e.name+"/"+t,e=e._parent;return t}get root(){let e=this;for(;e._parent;)e=e._parent;return e}get children(){return this._children}get graphDepth(){return this._graphDepth}_notifyHierarchyStateChanged(e,t){e._onHierarchyStateChanged(t);let s=e._children;for(let e=0,i=s.length;e<i;e++)s[e]._enabled&&this._notifyHierarchyStateChanged(s[e],t);}_onHierarchyStateChanged(e){this._enabledInHierarchy=e,e&&!this._frozen&&this._unfreezeParentToRoot();}_cloneInternal(e){e.name=this.name;let t=this.tags._list;e.tags.clear();for(let s=0;s<t.length;s++)e.tags.add(t[s]);e.localPosition.copy(this.localPosition),e.localRotation.copy(this.localRotation),e.localScale.copy(this.localScale),e.localEulerAngles.copy(this.localEulerAngles),e.position.copy(this.position),e.rotation.copy(this.rotation),e.eulerAngles.copy(this.eulerAngles),e.localTransform.copy(this.localTransform),e._dirtyLocal=this._dirtyLocal,e.worldTransform.copy(this.worldTransform),e._dirtyWorld=this._dirtyWorld,e._dirtyNormal=this._dirtyNormal,e._aabbVer=this._aabbVer+1,e._enabled=this._enabled,e.scaleCompensation=this.scaleCompensation,e._enabledInHierarchy=false;}clone(){let e=new this.constructor;return this._cloneInternal(e),e}copy(e){return e._cloneInternal(this),this}destroy(){this.remove();let e=this._children;for(;e.length;){let t=e.pop();t._parent=null,t.destroy();}this.fire("destroy",this),this.off();}find(e,t){let s=[],i=ob(e,t);return this.forEach(e=>{i(e)&&s.push(e);}),s}findOne(e,t){return function e(t,s){if(s(t))return t;let i=t._children,n=i.length;for(let t=0;t<n;++t){let n=e(i[t],s);if(n)return n}return null}(this,ob(e,t))}findByTag(){for(var e=arguments.length,t=Array(e),s=0;s<e;s++)t[s]=arguments[s];let i=[],n=(e,s)=>{s&&e.tags.has(...t)&&i.push(e);for(let t=0;t<e._children.length;t++)n(e._children[t],true);};return n(this,false),i}findByName(e){return this.findOne("name",e)}findByPath(e){let t=Array.isArray(e)?e:e.split("/"),s=this;for(let e=0,i=t.length;e<i;++e)if(!(s=s.children.find(s=>s.name===t[e])))return null;return s}forEach(e,t){e.call(t,this);let s=this._children,i=s.length;for(let n=0;n<i;++n)s[n].forEach(e,t);}isDescendantOf(e){let t=this._parent;for(;t;){if(t===e)return  true;t=t._parent;}return  false}isAncestorOf(e){return e.isDescendantOf(this)}getEulerAngles(){return this.getWorldTransform().getEulerAngles(this.eulerAngles),this.eulerAngles}getLocalEulerAngles(){return this.localRotation.getEulerAngles(this.localEulerAngles),this.localEulerAngles}getLocalPosition(){return this.localPosition}getLocalRotation(){return this.localRotation}getLocalScale(){return this.localScale}getLocalTransform(){return this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=false),this.localTransform}getPosition(){return this.getWorldTransform().getTranslation(this.position),this.position}getRotation(){return this.rotation.setFromMat4(this.getWorldTransform()),this.rotation}getScale(){return this._scale||(this._scale=new eu),this.getWorldTransform().getScale(this._scale)}getWorldTransform(){return (this._dirtyLocal||this._dirtyWorld)&&(this._parent&&this._parent.getWorldTransform(),this._sync()),this.worldTransform}get worldScaleSign(){return 0===this._worldScaleSign&&(this._worldScaleSign=this.getWorldTransform().scaleSign),this._worldScaleSign}remove(){var e;null==(e=this._parent)||e.removeChild(this);}reparent(e,t){this.remove(),e&&(t>=0?e.insertChild(this,t):e.addChild(this));}setLocalEulerAngles(e,t,s){this.localRotation.setFromEulerAngles(e,t,s),this._dirtyLocal||this._dirtifyLocal();}setLocalPosition(e,t,s){e instanceof eu?this.localPosition.copy(e):this.localPosition.set(e,t,s),this._dirtyLocal||this._dirtifyLocal();}setLocalRotation(e,t,s,i){e instanceof eT?this.localRotation.copy(e):this.localRotation.set(e,t,s,i),this._dirtyLocal||this._dirtifyLocal();}setLocalScale(e,t,s){e instanceof eu?this.localScale.copy(e):this.localScale.set(e,t,s),this._dirtyLocal||this._dirtifyLocal();}_dirtifyLocal(){this._dirtyLocal||(this._dirtyLocal=true,this._dirtyWorld||this._dirtifyWorld());}_unfreezeParentToRoot(){let e=this._parent;for(;e;)e._frozen=false,e=e._parent;}_dirtifyWorld(){this._dirtyWorld||this._unfreezeParentToRoot(),this._dirtifyWorldInternal();}_dirtifyWorldInternal(){if(!this._dirtyWorld){this._frozen=false,this._dirtyWorld=true;for(let e=0;e<this._children.length;e++)this._children[e]._dirtyWorld||this._children[e]._dirtifyWorldInternal();}this._dirtyNormal=true,this._worldScaleSign=0,this._aabbVer++;}setPosition(e,t,s){e instanceof eu?o_.copy(e):o_.set(e,t,s),null===this._parent?this.localPosition.copy(o_):(og.copy(this._parent.getWorldTransform()).invert(),og.transformPoint(o_,this.localPosition)),this._dirtyLocal||this._dirtifyLocal();}setRotation(e,t,s,i){if(e instanceof eT?ov.copy(e):ov.set(e,t,s,i),null===this._parent)this.localRotation.copy(ov);else {let e=this._parent.getRotation();oy.copy(e).invert(),this.localRotation.copy(oy).mul(ov);}this._dirtyLocal||this._dirtifyLocal();}setPositionAndRotation(e,t){if(null===this._parent)this.localPosition.copy(e),this.localRotation.copy(t);else {let s=this._parent.getWorldTransform();og.copy(s).invert(),og.transformPoint(e,this.localPosition),this.localRotation.setFromMat4(og).mul(t);}this._dirtyLocal||this._dirtifyLocal();}setEulerAngles(e,t,s){if(this.localRotation.setFromEulerAngles(e,t,s),null!==this._parent){let e=this._parent.getRotation();oy.copy(e).invert(),this.localRotation.mul2(oy,this.localRotation);}this._dirtyLocal||this._dirtifyLocal();}addChild(e){this._prepareInsertChild(e),this._children.push(e),this._onInsertChild(e);}addChildAndSaveTransform(e){let t=e.getPosition(),s=e.getRotation();this._prepareInsertChild(e),e.setPosition(of.copy(this.worldTransform).invert().transformPoint(t)),e.setRotation(om.copy(this.getRotation()).invert().mul(s)),this._children.push(e),this._onInsertChild(e);}insertChild(e,t){this._prepareInsertChild(e),this._children.splice(t,0,e),this._onInsertChild(e);}_prepareInsertChild(e){e.remove();}_fireOnHierarchy(e,t,s){this.fire(e,s);for(let e=0;e<this._children.length;e++)this._children[e]._fireOnHierarchy(t,t,s);}_onInsertChild(e){e._parent=this;let t=e._enabled&&this.enabled;e._enabledInHierarchy!==t&&(e._enabledInHierarchy=t,e._notifyHierarchyStateChanged(e,t)),e._updateGraphDepth(),e._dirtifyWorld(),this._frozen&&e._unfreezeParentToRoot(),e._fireOnHierarchy("insert","inserthierarchy",this),this.fire&&this.fire("childinsert",e);}_updateGraphDepth(){this._graphDepth=this._parent?this._parent._graphDepth+1:0;for(let e=0,t=this._children.length;e<t;e++)this._children[e]._updateGraphDepth();}removeChild(e){let t=this._children.indexOf(e);-1!==t&&(this._children.splice(t,1),e._parent=null,e._fireOnHierarchy("remove","removehierarchy",this),this.fire("childremove",e));}_sync(){if(this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=false),this._dirtyWorld){if(null===this._parent)this.worldTransform.copy(this.localTransform);else if(this.scaleCompensation){let e;let t=this._parent,s=this.localScale,i=t;if(i){for(;i&&i.scaleCompensation;)i=i._parent;i&&(i=i._parent)&&(e=i.worldTransform.getScale(),ou.mul2(e,this.localScale),s=ou);}oc.setFromMat4(t.worldTransform),od.mul2(oc,this.localRotation);let n=t.worldTransform;t.scaleCompensation&&(op.mul2(e,t.getLocalScale()),ol.setTRS(t.worldTransform.getTranslation(oh),oc,op),n=ol),n.transformPoint(this.localPosition,oh),this.worldTransform.setTRS(oh,od,s);}else this.worldTransform.mulAffine2(this._parent.worldTransform,this.localTransform);this._dirtyWorld=false;}}syncHierarchy(){if(!this._enabled||this._frozen)return;this._frozen=true,(this._dirtyLocal||this._dirtyWorld)&&this._sync();let e=this._children;for(let t=0,s=e.length;t<s;t++)e[t].syncHierarchy();}lookAt(e,t,s,i,n,r){if(void 0===i&&(i=0),void 0===n&&(n=1),void 0===r&&(r=0),e instanceof eu)ox.copy(e),t instanceof eu?oT.copy(t):oT.copy(eu.UP);else {if(void 0===s)return;ox.set(e,t,s),oT.set(i,n,r);}oS.setLookAt(this.getPosition(),ox,oT),ov.setFromMat4(oS),this.setRotation(ov);}translate(e,t,s){e instanceof eu?o_.copy(e):o_.set(e,t,s),o_.add(this.getPosition()),this.setPosition(o_);}translateLocal(e,t,s){e instanceof eu?o_.copy(e):o_.set(e,t,s),this.localRotation.transformVector(o_,o_),this.localPosition.add(o_),this._dirtyLocal||this._dirtifyLocal();}rotate(e,t,s){if(ov.setFromEulerAngles(e,t,s),null===this._parent)this.localRotation.mul2(ov,this.localRotation);else {let e=this.getRotation(),t=this._parent.getRotation();oy.copy(t).invert(),ov.mul2(oy,ov),this.localRotation.mul2(ov,e);}this._dirtyLocal||this._dirtifyLocal();}rotateLocal(e,t,s){ov.setFromEulerAngles(e,t,s),this.localRotation.mul(ov),this._dirtyLocal||this._dirtifyLocal();}constructor(e="Untitled"){super(),this.tags=new J(this),this.localPosition=new eu,this.localRotation=new eT,this.localScale=new eu(1,1,1),this.localEulerAngles=new eu,this.position=new eu,this.rotation=new eT,this.eulerAngles=new eu,this._scale=null,this.localTransform=new ex,this._dirtyLocal=false,this._aabbVer=0,this._frozen=false,this.worldTransform=new ex,this._dirtyWorld=false,this._worldScaleSign=0,this._normalMatrix=new ep,this._dirtyNormal=true,this._right=null,this._up=null,this._forward=null,this._parent=null,this._children=[],this._graphDepth=0,this._enabled=true,this._enabledInHierarchy=false,this.scaleCompensation=false,this.name=e;}}let oA=new ex,ow=new ex,oC=new ex;class oP{static create(e,t,s){let i=new oo;switch(i.node=new oE(e),i.aspectRatio=1,i.aspectRatioMode=1,i._scissorRectClear=true,t){case 1:i.node.setRotation(oP.pointLightRotations[s]),i.fov=90,i.projection=0;break;case 2:i.projection=0;break;case 0:i.projection=1;}return i}static evalSpotCookieMatrix(e){let t=oP._spotCookieCamera;t||(t=oP.create("SpotCookieCamera",2),oP._spotCookieCamera=t),t.fov=2*e._outerConeAngle;let s=t._node;s.setPosition(e._node.getPosition()),s.setRotation(e._node.getRotation()),s.rotateLocal(-90,0,0),oA.setTRS(s.getPosition(),s.getRotation(),eu.ONE).invert(),ow.mul2(t.projectionMatrix,oA);let i=e.cookieMatrix,n=e.atlasViewport;return oC.setViewport(n.x,n.y,n.z,n.w),i.mul2(oC,ow),i}}oP.pointLightRotations=[new eT().setFromEulerAngles(0,90,180),new eT().setFromEulerAngles(0,-90,180),new eT().setFromEulerAngles(90,0,0),new eT().setFromEulerAngles(-90,0,0),new eT().setFromEulerAngles(0,180,180),new eT().setFromEulerAngles(0,0,180)],oP._spotCookieCamera=null;let oM={ambientPS:'\n\n#if LIT_AMBIENT_SOURCE == AMBIENTSH\n#endif\n\n#if LIT_AMBIENT_SOURCE == ENVALATLAS\n    #include "envAtlasPS"\n\n    #ifndef ENV_ATLAS\n        #define ENV_ATLAS\n        var texture_envAtlas: texture_2d<f32>;\n        var texture_envAtlasSampler: sampler;\n    #endif\n#endif\n\nfn addAmbient(worldNormal: vec3f) {\n    #ifdef LIT_AMBIENT_SOURCE == AMBIENTSH\n\n        let n: vec3f = cubeMapRotate(worldNormal);\n        let color: vec3f =\n            uniform.ambientSH[0] +\n            uniform.ambientSH[1] * n.x +\n            uniform.ambientSH[2] * n.y +\n            uniform.ambientSH[3] * n.z +\n            uniform.ambientSH[4] * n.x * n.z +\n            uniform.ambientSH[5] * n.z * n.y +\n            uniform.ambientSH[6] * n.y * n.x +\n            uniform.ambientSH[7] * (3.0 * n.z * n.z - 1.0) +\n            uniform.ambientSH[8] * (n.x * n.x - n.y * n.y);\n\n        dDiffuseLight += processEnvironment(max(color, vec3f(0.0)));\n\n    #endif\n\n    #if LIT_AMBIENT_SOURCE == ENVALATLAS\n\n        let dir: vec3f = normalize(cubeMapRotate(worldNormal) * vec3f(-1.0, 1.0, 1.0));\n        let uv: vec2f = mapUv(toSphericalUv(dir), vec4f(128.0, 256.0 + 128.0, 64.0, 32.0) / atlasSize);\n\n        let raw: vec4f = textureSample(texture_envAtlas, texture_envAtlasSampler, uv);\n        let linear: vec3f = {ambientDecode}(raw);\n        dDiffuseLight += processEnvironment(linear);\n\n    #endif\n\n    #if LIT_AMBIENT_SOURCE == CONSTANT\n\n        dDiffuseLight += uniform.light_globalAmbient;\n\n    #endif\n}\n',basePS:"\nuniform view_position: vec3f;\n\nuniform light_globalAmbient: vec3f;\n\nfn square(x: f32) -> f32 {\n    return x*x;\n}\n\nfn saturate(x: f32) -> f32 {\n    return clamp(x, 0.0, 1.0);\n}\n\nfn saturate3(x: vec3f) -> vec3f {\n    return clamp(x, vec3f(0.0), vec3f(1.0));\n}\n",combinePS:"\nfn combineColor(albedo: vec3f, sheenSpecularity: vec3f, clearcoatSpecularity: f32) -> vec3f {\n    var ret: vec3f = vec3f(0.0);\n\n    #ifdef LIT_OLD_AMBIENT\n        ret += (dDiffuseLight - uniform.light_globalAmbient) * albedo + uniform.material_ambient * uniform.light_globalAmbient;\n    #else\n        ret += albedo * dDiffuseLight;\n    #endif // LIT_OLD_AMBIENT\n    #ifdef LIT_SPECULAR\n        ret += dSpecularLight;\n    #endif // LIT_SPECULAR\n    #ifdef LIT_REFLECTIONS\n        ret += dReflection.rgb * dReflection.a;\n    #endif // LIT_REFLECTIONS\n\n    #ifdef LIT_SHEEN\n        let sheenScaling: f32 = 1.0 - max(max(sheenSpecularity.r, sheenSpecularity.g), sheenSpecularity.b) * 0.157;\n        ret = ret * sheenScaling + (sSpecularLight + sReflection.rgb) * sheenSpecularity;\n    #endif // LIT_SHEEN\n    #ifdef LIT_CLEARCOAT\n        let clearCoatScaling: f32 = 1.0 - ccFresnel * clearcoatSpecularity;\n        ret = ret * clearCoatScaling + (ccSpecularLight + ccReflection.rgb) * clearcoatSpecularity;\n    #endif // LIT_CLEARCOAT\n\n    return ret;\n}\n",cookieBlit2DPS:"\n    varying uv0: vec2f;\n\n    var blitTexture: texture_2d<f32>;\n    var blitTextureSampler : sampler;\n\n    @fragment\n    fn fragmentMain(input : FragmentInput) -> FragmentOutput {\n        var output: FragmentOutput;\n        output.color = textureSample(blitTexture, blitTextureSampler, input.uv0);\n        return output;\n    }\n",cookieBlitCubePS:"\n    varying uv0: vec2f;\n    uniform invViewProj: mat4x4<f32>;\n    var blitTexture: texture_cube<f32>;\n    var blitTextureSampler : sampler;\n\n    @fragment\n    fn fragmentMain(input : FragmentInput) -> FragmentOutput {\n        var output: FragmentOutput;\n        var projPos = vec4f(input.uv0 * 2.0 - 1.0, 0.5, 1.0);\n        var worldPos = uniform.invViewProj * projPos;\n        output.color = textureSample(blitTexture, blitTextureSampler, worldPos.xyz);\n        return output;\n    }\n",cookieBlitVS:"\n    attribute vertex_position: vec2f;\n    varying uv0: vec2f;\n\n    @vertex\n    fn vertexMain(input: VertexInput) -> VertexOutput {\n        var output: VertexOutput;\n        output.position = vec4f(input.vertex_position, 0.5, 1.0);\n        output.uv0 = input.vertex_position * 0.5 + vec2f(0.5, 0.5);\n        output.uv0.y = 1.0 - output.uv0.y;\n        return output;\n    }\n",debugOutputPS:"\n#ifdef DEBUG_ALBEDO_PASS\noutput.color = vec4(gammaCorrectOutput(dAlbedo), 1.0);\n#endif\n\n#ifdef DEBUG_UV0_PASS\noutput.color = vec4f(litArgs_albedo , 1.0);\n#endif\n\n#ifdef DEBUG_WORLD_NORMAL_PASS\noutput.color = vec4f(litArgs_worldNormal * 0.5 + 0.5, 1.0);\n#endif\n\n#ifdef DEBUG_OPACITY_PASS\noutput.color = vec4f(vec3f(litArgs_opacity) , 1.0);\n#endif\n\n#ifdef DEBUG_SPECULARITY_PASS\noutput.color = vec4f(litArgs_specularity, 1.0);\n#endif\n\n#ifdef DEBUG_GLOSS_PASS\noutput.color = vec4f(vec3f(litArgs_gloss) , 1.0);\n#endif\n\n#ifdef DEBUG_METALNESS_PASS\noutput.color = vec4f(vec3f(litArgs_metalness) , 1.0);\n#endif\n\n#ifdef DEBUG_AO_PASS\noutput.color = vec4f(vec3f(litArgs_ao) , 1.0);\n#endif\n\n#ifdef DEBUG_EMISSION_PASS\noutput.color = vec4f(gammaCorrectOutput(litArgs_emission), 1.0);\n#endif\n",debugProcessFrontendPS:"\n#ifdef DEBUG_LIGHTING_PASS\n    litArgs_albedo = vec3f(0.5);\n#endif\n\n#ifdef DEBUG_UV0_PASS\n#ifdef VARYING_VUV0\n    litArgs_albedo = vec3f(vUv0, 0.0);\n#else\n    litArgs_albedo = vec3f(0.0);\n#endif\n#endif\n",decodePS:"\n\n#ifndef _DECODE_INCLUDED_\n#define _DECODE_INCLUDED_\n\nfn decodeLinear(raw: vec4f) -> vec3f {\n    return raw.rgb;\n}\n\nfn decodeGammaFloat(raw: f32) -> f32 {\n    return pow(raw, 2.2);\n}\n\nfn decodeGamma3(raw: vec3f) -> vec3f {\n    return pow(raw, vec3f(2.2));\n}\n\nfn decodeGamma(raw: vec4f) -> vec3f {\n    return pow(raw.xyz, vec3f(2.2));\n}\n\nfn decodeRGBM(raw: vec4f) -> vec3f {\n    let color = (8.0 * raw.a) * raw.rgb;\n    return color * color;\n}\n\nfn decodeRGBP(raw: vec4f) -> vec3f {\n    let color = raw.rgb * (-raw.a * 7.0 + 8.0);\n    return color * color;\n}\n\nfn decodeRGBE(raw: vec4f) -> vec3f {\n    return select(vec3f(0.0), raw.xyz * pow(2.0, raw.w * 255.0 - 128.0), raw.a != 0.0);\n}\n\nfn passThrough(raw: vec4f) -> vec4f {\n    return raw;\n}\n\nfn unpackNormalXYZ(nmap: vec4f) -> vec3f {\n    return nmap.xyz * 2.0 - 1.0;\n}\n\nfn unpackNormalXY(nmap: vec4f) -> vec3f {\n    var xy = nmap.wy * 2.0 - 1.0;\n    return vec3f(xy, sqrt(1.0 - clamp(dot(xy, xy), 0.0, 1.0)));\n}\n\n#endif\n",encodePS:"\nfn encodeLinear(source: vec3f) -> vec4f {\n    return vec4f(source, 1.0);\n}\n\nfn encodeGamma(source: vec3f) -> vec4f {\n    return vec4f(pow(source + vec3f(0.0000001), vec3f(1.0 / 2.2)), 1.0);\n}\n\nfn encodeRGBM(source: vec3f) -> vec4f {\n    var color: vec3f = pow(source, vec3f(0.5));\n    color *= 1.0 / 8.0;\n\n    var a: f32 = saturate(max(max(color.r, color.g), max(color.b, 1.0 / 255.0)));\n    a = ceil(a * 255.0) / 255.0;\n\n    color /= a;\n    return vec4f(color, a);\n}\n\nfn encodeRGBP(source: vec3f) -> vec4f {\n    // convert incoming linear to gamma(ish)\n    var gamma: vec3f = pow(source, vec3f(0.5));\n\n    // calculate the maximum component clamped to 1..8\n    var maxVal: f32 = min(8.0, max(1.0, max(gamma.x, max(gamma.y, gamma.z))));\n\n    // calculate storage factor\n    var v: f32 = 1.0 - ((maxVal - 1.0) / 7.0);\n\n    // round the value for storage in 8bit channel\n    v = ceil(v * 255.0) / 255.0;\n\n    return vec4f(gamma / (-v * 7.0 + 8.0), v);\n}\n\nfn encodeRGBE(source: vec3f) -> vec4f {\n    var maxVal: f32 = max(source.x, max(source.y, source.z));\n    if (maxVal < 1e-32) {\n        return vec4f(0.0, 0.0, 0.0, 0.0);\n    } else {\n        var e: f32 = ceil(log2(maxVal));\n        return vec4f(source / pow(2.0, e), (e + 128.0) / 255.0);\n    }\n}\n",endPS:"\n    var finalRgb: vec3f = combineColor(litArgs_albedo, litArgs_sheen_specularity, litArgs_clearcoat_specularity);\n\n    finalRgb = finalRgb + litArgs_emission;\n    finalRgb = addFog(finalRgb);\n    finalRgb = toneMap(finalRgb);\n    finalRgb = gammaCorrectOutput(finalRgb);\n    output.color = vec4f(finalRgb, output.color.a);\n",envAtlasPS:"\n// the envAtlas is fixed at 512 pixels. every equirect is generated with 1 pixel boundary.\nconst atlasSize : f32 = 512.0;\nconst seamSize : f32 = 1.0 / atlasSize;\n\n// map a normalized equirect UV to the given rectangle (taking 1 pixel seam into account).\nfn mapUv(uv : vec2f, rect : vec4f) -> vec2f {\n    return vec2f(mix(rect.x + seamSize, rect.x + rect.z - seamSize, uv.x),\n                 mix(rect.y + seamSize, rect.y + rect.w - seamSize, uv.y));\n}\n\n// map a normalized equirect UV and roughness level to the correct atlas rect.\nfn mapRoughnessUv(uv : vec2f, level : f32) -> vec2f {\n    let t : f32 = 1.0 / exp2(level);\n    return mapUv(uv, vec4f(0.0, 1.0 - t, t, t * 0.5));\n}\n\n// map shiny level UV\nfn mapShinyUv(uv : vec2f, level : f32) -> vec2f {\n    let t : f32 = 1.0 / exp2(level);\n    return mapUv(uv, vec4f(1.0 - t, 1.0 - t, t, t * 0.5));\n}\n",envProcPS:"\n#ifdef LIT_SKYBOX_INTENSITY\n    uniform skyboxIntensity : f32;\n#endif\n\nfn processEnvironment(color : vec3f) -> vec3f {\n    #ifdef LIT_SKYBOX_INTENSITY\n        return color * uniform.skyboxIntensity;\n    #else\n        return color;\n    #endif\n}\n",fogPS:"\n\nvar<private> dBlendModeFogFactor : f32 = 1.0;\n\n#if (FOG != NONE)\n    uniform fog_color : vec3f;\n    \n    #if (FOG == LINEAR)\n        uniform fog_start : f32;\n        uniform fog_end : f32;\n    #else\n        uniform fog_density : f32;\n    #endif\n#endif\n\nfn getFogFactor() -> f32 {\n\n    let depth = pcPosition.z / pcPosition.w;\n\n    var fogFactor : f32 = 0.0;\n\n    #if (FOG == LINEAR)\n        fogFactor = (uniform.fog_end - depth) / (uniform.fog_end - uniform.fog_start);\n    #elif (FOG == EXP)\n        fogFactor = exp(-depth * uniform.fog_density);\n    #elif (FOG == EXP2)\n        fogFactor = exp(-depth * depth * uniform.fog_density * uniform.fog_density);\n    #endif\n\n    return clamp(fogFactor, 0.0, 1.0);\n}\n\nfn addFog(color : vec3f) -> vec3f {\n    #if (FOG != NONE)\n        return mix(uniform.fog_color * dBlendModeFogFactor, color, getFogFactor());\n    #else\n        return color;\n    #endif\n}\n",gammaPS:'\n\n#include "decodePS"\n\n#if (GAMMA == SRGB)\n\n    fn gammaCorrectInput(color: f32) -> f32 {\n        return decodeGammaFloat(color);\n    }\n\n    fn gammaCorrectInputVec3(color: vec3f) -> vec3f {\n        return decodeGamma3(color);\n    }\n\n    fn gammaCorrectInputVec4(color: vec4f) -> vec4f {\n        return vec4f(decodeGamma3(color.xyz), color.w);\n    }\n\n    fn gammaCorrectOutput(color: vec3f) -> vec3f {\n        return pow(color + 0.0000001, vec3f(1.0 / 2.2));\n    }\n\n#else // NONE\n\n    fn gammaCorrectInput(color: f32) -> f32 {\n        return color;\n    }\n\n    fn gammaCorrectInputVec3(color: vec3f) -> vec3f {\n        return color;\n    }\n\n    fn gammaCorrectInputVec4(color: vec4f) -> vec4f {\n        return color;\n    }\n\n    fn gammaCorrectOutput(color: vec3f) -> vec3f {\n        return color;\n    }\n\n#endif\n',immediateLinePS:'\n    #include "gammaPS"\n    varying color: vec4f;\n    @fragment\n    fn fragmentMain(input : FragmentInput) -> FragmentOutput {\n        var output: FragmentOutput;\n        output.color = vec4f(gammaCorrectOutput(decodeGamma3(input.color.rgb)), input.color.a);\n        return output;\n    }\n',immediateLineVS:"\n    attribute vertex_position: vec4f;\n    attribute vertex_color: vec4f;\n    uniform matrix_model: mat4x4f;\n    uniform matrix_viewProjection: mat4x4f;\n    varying color: vec4f;\n    @vertex\n    fn vertexMain(input : VertexInput) -> VertexOutput {\n        var output : VertexOutput;\n        output.color = input.vertex_color;\n        output.position = uniform.matrix_viewProjection * uniform.matrix_model * input.vertex_position;\n        return output;\n    }\n",lightBufferDefinesPS:"",lightingPS:'\n\n#ifdef LIT_CLUSTERED_LIGHTS\n    // all this functionality that needs to be included for clustered lighting\n    #define LIT_CODE_FALLOFF_LINEAR\n    #define LIT_CODE_FALLOFF_SQUARED\n    #define LIT_CODE_LIGHTS_POINT\n    #define LIT_CODE_LIGHTS_SPOT\n#endif\n\n#ifdef AREA_LIGHTS\n    var areaLightsLutTex1: texture_2d<f32>;\n    var areaLightsLutTex1Sampler: sampler;\n    var areaLightsLutTex2: texture_2d<f32>;\n    var areaLightsLutTex2Sampler: sampler;\n#endif\n\n#ifdef LIT_LIGHTING\n    #include "lightDiffuseLambertPS"\n\n    // area lights\n    #if defined(AREA_LIGHTS) || defined(LIT_CLUSTERED_AREA_LIGHTS)\n        #include "ltcPS"\n    #endif\n#endif\n\n#ifdef SHADOW_DIRECTIONAL\n    #include "shadowCascadesPS"\n#endif\n\n#if defined(SHADOW_KIND_PCF1)\n    #include "shadowPCF1PS"\n#endif\n\n#if defined(SHADOW_KIND_PCF3)\n    #include "shadowPCF3PS"\n#endif\n\n#if defined(SHADOW_KIND_PCF5)\n    #include "shadowPCF5PS"\n#endif\n\n#if defined(SHADOW_KIND_PCSS)\n    #include "linearizeDepthPS"\n    #include "shadowPCSSPS"\n    #include "shadowSoftPS"\n#endif\n\n#if defined(SHADOW_KIND_VSM)\n    #include "shadowEVSMPS"\n#endif\n\n#ifdef LIT_CODE_FALLOFF_LINEAR\n    #include "falloffLinearPS"\n#endif\n\n#ifdef LIT_CODE_FALLOFF_SQUARED\n    #include "falloffInvSquaredPS"\n#endif\n\n#ifdef LIT_CODE_LIGHTS_POINT\n    #include "lightDirPointPS"\n#endif\n\n#ifdef LIT_CODE_LIGHTS_SPOT\n    #include "spotPS"\n#endif\n\n#ifdef LIT_CODE_COOKIE\n    #include "cookiePS"\n#endif\n\n// clustered lighting\n#ifdef LIT_CLUSTERED_LIGHTS\n    #include "clusteredLightPS"\n#endif\n\n#ifdef LIGHT_COUNT > 0\n    // LOOP - generate shadow evaluation functions for all non-clustered lights\n    #include "lightFunctionShadowPS, LIGHT_COUNT"\n\n    // LOOP - generate light evaluation functions for all non-clustered lights\n    #include "lightFunctionLightPS, LIGHT_COUNT"\n#endif\n',litForwardBackendPS:'\nfn evaluateBackend() -> FragmentOutput {\n\n    var output: FragmentOutput;\n\n    // apply SSAO during lighting\n    #ifdef LIT_SSAO\n        litArgs_ao = litArgs_ao * textureSampleLevel(ssaoTexture, ssaoTextureSampler, pcPosition.xy * ssaoTextureSizeInv, 0.0).r;\n    #endif\n\n    // transform tangent space normals to world space\n    #ifdef LIT_NEEDS_NORMAL\n        #ifdef LIT_SPECULAR\n            getReflDir(litArgs_worldNormal, dViewDirW, litArgs_gloss, dTBN);\n        #endif\n\n        #ifdef LIT_CLEARCOAT\n            ccReflDirW = normalize(-reflect(dViewDirW, litArgs_clearcoat_worldNormal));\n        #endif\n    #endif\n\n    #ifdef LIT_SPECULAR_OR_REFLECTION\n        #ifdef LIT_METALNESS\n            var f0: f32 = 1.0 / litArgs_ior;\n            f0 = (f0 - 1.0) / (f0 + 1.0);\n            f0 = f0 * f0;\n            litArgs_specularity = getSpecularModulate(litArgs_specularity, litArgs_albedo, litArgs_metalness, f0);\n            litArgs_albedo = getAlbedoModulate(litArgs_albedo, litArgs_metalness);\n        #endif\n\n        #ifdef LIT_IRIDESCENCE\n            var iridescenceFresnel: vec3f = getIridescence(saturate3(dot(dViewDirW, litArgs_worldNormal)), litArgs_specularity, litArgs_iridescence_thickness);\n        #endif\n    #endif\n\n    // ambient\n    #ifdef LIT_ADD_AMBIENT\n        addAmbient(litArgs_worldNormal);\n\n        #ifdef LIT_SPECULAR\n            dDiffuseLight = dDiffuseLight * (1.0 - litArgs_specularity);\n        #endif\n\n        // move ambient color out of diffuse (used by Lightmapper, to multiply ambient color by accumulated AO)\n        #ifdef LIT_SEPARATE_AMBIENT\n            var dAmbientLight: vec3f = dDiffuseLight;\n            dDiffuseLight = vec3(0.0);\n        #endif\n    #endif\n\n    #ifndef LIT_OLD_AMBIENT\n        dDiffuseLight = dDiffuseLight * uniform.material_ambient;\n    #endif\n\n    #ifdef LIT_AO\n        #ifndef LIT_OCCLUDE_DIRECT\n            occludeDiffuse(litArgs_ao);\n        #endif\n    #endif\n\n    #ifdef LIT_LIGHTMAP\n        addLightMap(\n            litArgs_lightmap, \n            litArgs_lightmapDir, \n            litArgs_worldNormal, \n            dViewDirW, \n            dReflDirW, \n            litArgs_gloss, \n            litArgs_specularity, \n            dVertexNormalW,\n            dTBN\n        #if defined(LIT_IRIDESCENCE)\n            , iridescenceFresnel,\n            litArgs_iridescence_intensity\n        #endif\n        );\n    #endif\n\n    #ifdef LIT_LIGHTING || LIT_REFLECTIONS\n\n        #ifdef LIT_REFLECTIONS\n\n            #ifdef LIT_CLEARCOAT\n                addReflectionCC(ccReflDirW, litArgs_clearcoat_gloss);\n            \n                #ifdef LIT_SPECULAR_FRESNEL\n                    ccFresnel = getFresnelCC(dot(dViewDirW, litArgs_clearcoat_worldNormal));\n                    ccReflection.rgb = ccReflection.rgb * ccFresnel;\n                #else\n                    ccFresnel = 0.0;\n                #endif\n            #endif\n\n            #ifdef LIT_SPECULARITY_FACTOR\n                ccReflection.rgb = ccReflection.rgb * litArgs_specularityFactor;\n            #endif\n\n            #ifdef LIT_SHEEN\n                addReflectionSheen(litArgs_worldNormal, dViewDirW, litArgs_sheen_gloss);\n            #endif\n\n            // Fresnel has to be applied to reflections\n            addReflection(dReflDirW, litArgs_gloss);\n\n            #ifdef LIT_FRESNEL_MODEL\n\n                dReflection.rgb = dReflection.rgb * getFresnel(\n                    dot(dViewDirW, litArgs_worldNormal), \n                    litArgs_gloss, \n                    litArgs_specularity\n                #if defined(LIT_IRIDESCENCE)\n                    , iridescenceFresnel,\n                    litArgs_iridescence_intensity\n                #endif\n                    );\n\n            #else\n\n                dReflection.rgb = dReflection.rgb * litArgs_specularity;\n\n            #endif\n\n            #ifdef LIT_SPECULARITY_FACTOR\n                dReflection.rgb = dReflection.rgb * litArgs_specularityFactor;\n            #endif\n\n        #endif\n\n        #ifdef AREA_LIGHTS\n            // specular has to be accumulated differently if we want area lights to look correct\n            dSpecularLight = dSpecularLight * litArgs_specularity;\n\n            #ifdef LIT_SPECULAR\n                // evaluate material based area lights data, shared by all area lights\n                calcLTCLightValues(litArgs_gloss, litArgs_worldNormal, dViewDirW, litArgs_specularity, litArgs_clearcoat_gloss, litArgs_clearcoat_worldNormal, litArgs_clearcoat_specularity);\n            #endif\n        #endif\n        \n        // LOOP - evaluate all non-clustered lights\n        #include "lightEvaluationPS, LIGHT_COUNT"\n\n        // clustered lighting\n        #ifdef LIT_CLUSTERED_LIGHTS\n            addClusteredLights(litArgs_worldNormal, dViewDirW, dReflDirW,\n                #if defined(LIT_CLEARCOAT)\n                        ccReflDirW,\n                #endif\n                        litArgs_gloss, litArgs_specularity, dVertexNormalW, dTBN, \n                #if defined(LIT_IRIDESCENCE)\n                        iridescenceFresnel,\n                #endif\n                        litArgs_clearcoat_worldNormal, litArgs_clearcoat_gloss, litArgs_sheen_gloss, litArgs_iridescence_intensity\n            );\n        #endif\n\n        #ifdef AREA_LIGHTS\n\n            #ifdef LIT_CLEARCOAT\n                // specular has to be accumulated differently if we want area lights to look correct\n                litArgs_clearcoat_specularity = 1.0;\n            #endif\n\n            #ifdef LIT_SPECULAR\n                litArgs_specularity = vec3(1.0);\n            #endif\n\n        #endif\n\n        #ifdef LIT_REFRACTION\n            addRefraction(\n                litArgs_worldNormal, \n                dViewDirW, \n                litArgs_thickness, \n                litArgs_gloss, \n                litArgs_specularity, \n                litArgs_albedo, \n                litArgs_transmission,\n                litArgs_ior,\n                litArgs_dispersion\n                #if defined(LIT_IRIDESCENCE)\n                    , iridescenceFresnel, \n                    litArgs_iridescence_intensity\n                #endif\n            );\n        #endif\n    #endif\n\n    // apply ambient occlusion\n    #ifdef LIT_AO\n        #ifdef LIT_OCCLUDE_DIRECT\n            occludeDiffuse(litArgs_ao);\n        #endif\n\n        #if LIT_OCCLUDE_SPECULAR != NONE\n            occludeSpecular(litArgs_gloss, litArgs_ao, litArgs_worldNormal, dViewDirW);\n        #endif\n    #endif\n\n    #ifdef LIT_SPECULARITY_FACTOR\n        dSpecularLight = dSpecularLight * litArgs_specularityFactor;\n    #endif\n\n    #if !defined(LIT_OPACITY_FADES_SPECULAR)\n\n        #if LIT_BLEND_TYPE == NORMAL || LIT_BLEND_TYPE == PREMULTIPLIED\n\n            var specLum: f32 = dot((dSpecularLight + dReflection.rgb * dReflection.a), vec3f( 0.2126, 0.7152, 0.0722 ));\n            #ifdef LIT_CLEARCOAT\n                specLum = specLum + dot(ccSpecularLight * litArgs_clearcoat_specularity + ccReflection.rgb * litArgs_clearcoat_specularity, vec3f( 0.2126, 0.7152, 0.0722 ));\n            #endif\n            litArgs_opacity = clamp(litArgs_opacity + gammaCorrectInput(specLum), 0.0, 1.0);\n\n        #endif\n\n        litArgs_opacity = litArgs_opacity * material_alphaFade;\n\n    #endif\n\n    #include "endPS"\n    #include "outputAlphaPS"\n\n    #ifdef LIT_MSDF\n        output.color = applyMsdf(gl_FragColor);\n    #endif\n\n    #include "outputPS"\n    #include "debugOutputPS"\n\n    #ifdef LIT_SHADOW_CATCHER\n        // output when the shadow catcher is enabled - accumulated shadows\n        output.color = vec4f(dShadowCatcher, output.color.a);\n    #endif\n\n    return output;\n}\n',litForwardDeclarationPS:'\n\n// globals\nvar<private> sReflection: vec3f;\nvar<private> dVertexNormalW: vec3f;\nvar<private> dTangentW: vec3f;\nvar<private> dBinormalW: vec3f;\nvar<private> dViewDirW: vec3f;\nvar<private> dReflDirW: vec3f;\nvar<private> ccReflDirW: vec3f;\n\n// Per-light temporaries\nvar<private> dLightDirNormW: vec3f;\nvar<private> dAtten: f32;\n\n// Outputs\nvar<private> dTBN: mat3x3f;\nvar<private> dReflection: vec4f;\nvar<private> dDiffuseLight: vec3f;\nvar<private> dSpecularLight: vec3f;\nvar<private> ccFresnel: f32;\nvar<private> ccReflection: vec3f;\nvar<private> ccSpecularLight: vec3f;\nvar<private> ccSpecularityNoFres: f32;\nvar<private> sSpecularLight: vec3f;\n\n// FRAGMENT SHADER INPUTS: UNIFORMS\n\n#ifdef LIT_DISPERSION\n    uniform material_dispersion: f32;\n#endif\n\n#ifndef LIT_OPACITY_FADES_SPECULAR\n    uniform material_alphaFade: f32;\n#endif\n\n#ifdef LIT_SSAO\n    var ssaoTexture : texture_2d<f32>;\n    var ssaoTextureSampler : sampler;\n    uniform ssaoTextureSizeInv: vec2f;\n#endif\n\n// lighting and shadowing declarations\n\n#ifdef LIT_SHADOW_CATCHER\n    // a variable to accumulate shadows for shadow catcher materials\n    var<private> dShadowCatcher: f32 = 1.0;\n#endif\n\n// LOOP - uniform declarations for all non-clustered lights\n#if LIGHT_COUNT > 0\n    #include "lightDeclarationPS, LIGHT_COUNT"\n#endif\n\n#ifdef LIT_SPECULAR\n    #if LIT_FRESNEL_MODEL == NONE && !defined(LIT_REFLECTIONS) && !defined(LIT_DIFFUSE_MAP) \n        #define LIT_OLD_AMBIENT\n    #endif\n#endif\n',litForwardMainPS:'\n\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n\n    dReflection = vec4f(0.0);\n\n    #ifdef LIT_CLEARCOAT\n        ccSpecularLight = vec3f(0.0);\n        ccReflection = vec3f(0.0);\n    #endif\n\n    #if LIT_NONE_SLICE_MODE == SLICED\n        #include "startNineSlicedPS"\n    #elif LIT_NONE_SLICE_MODE == TILED\n        #include "startNineSlicedTiledPS"\n    #endif\n\n    #ifdef LIT_NEEDS_NORMAL\n        dVertexNormalW = normalize(vNormalW);\n\n        #ifdef LIT_TANGENTS\n            #if defined(LIT_HEIGHTS) || defined(LIT_USE_NORMALS) || defined(LIT_USE_CLEARCOAT_NORMALS)\n                dTangentW = vTangentW;\n                dBinormalW = vBinormalW;\n            #endif\n        #endif\n\n        getViewDir();\n\n        #ifdef LIT_TBN\n            getTBN(dTangentW, dBinormalW, dVertexNormalW);\n\n            #ifdef LIT_TWO_SIDED_LIGHTING\n                handleTwoSidedLighting();\n            #endif\n        #endif\n    #endif\n\n    // invoke frontend functions\n    evaluateFrontend();\n\n    #include "debugProcessFrontendPS"\n\n    var output: FragmentOutput = evaluateBackend();\n\n    return output;\n}\n',litForwardPostCodePS:'\n\n#ifdef LIT_NEEDS_NORMAL\n    #include "cubeMapRotatePS"\n    #include "cubeMapProjectPS"\n    #include "envProcPS"\n#endif\n\n// ----- specular or reflections -----\n#ifdef LIT_SPECULAR_OR_REFLECTION\n    #ifdef LIT_METALNESS\n        #include "metalnessModulatePS"\n    #endif\n\n    #if LIT_FRESNEL_MODEL == SCHLICK\n        #include "fresnelSchlickPS"\n    #endif\n\n    #ifdef LIT_IRIDESCENCE\n        #include "iridescenceDiffractionPS"\n    #endif\n#endif\n\n// ----- ambient occlusion -----\n#ifdef LIT_AO\n    #include "aoDiffuseOccPS"\n    #include "aoSpecOccPS"\n#endif\n\n#if LIT_REFLECTION_SOURCE == ENVATLASHQ\n    #include "envAtlasPS"\n    #include "reflectionEnvHQPS"\n#elif LIT_REFLECTION_SOURCE == ENVATLAS\n    #include "envAtlasPS"\n    #include "reflectionEnvPS"\n#elif LIT_REFLECTION_SOURCE == CUBEMAP\n    #include "reflectionCubePS"\n#elif LIT_REFLECTION_SOURCE == SPHEREMAP\n    #include "reflectionSpherePS"\n#endif\n\n#ifdef LIT_REFLECTIONS\n    #ifdef LIT_CLEARCOAT\n        #include "reflectionCCPS"\n    #endif\n\n    #ifdef LIT_SHEEN\n        #include "reflectionSheenPS"\n    #endif\n#endif\n\n#ifdef LIT_REFRACTION\n    #if defined(LIT_DYNAMIC_REFRACTION)\n        #include "refractionDynamicPS"\n    #elif defined(LIT_REFLECTIONS)\n        #include "refractionCubePS"\n    #endif\n#endif\n\n#ifdef LIT_SHEEN\n    #include "lightSheenPS"\n#endif\n\n#ifdef LIT_GGX_SPECULAR\n    uniform material_anisotropy: f32;\n#endif\n\nuniform material_ambient: vec3f;\n\n#ifdef LIT_SPECULAR\n    #ifdef LIT_LIGHTING\n        #ifdef LIT_GGX_SPECULAR\n            #include "lightSpecularAnisoGGXPS"\n        #else\n            #include "lightSpecularBlinnPS"\n        #endif\n    #endif\n#endif\n\n#include "combinePS"\n\n#ifdef LIT_LIGHTMAP\n    #include "lightmapAddPS"\n#endif\n\n#ifdef LIT_ADD_AMBIENT\n    #include "ambientPS"\n#endif\n\n#ifdef LIT_MSDF\n    #include "msdfPS"\n#endif\n\n#ifdef LIT_NEEDS_NORMAL\n    #include "viewDirPS"\n    #ifdef LIT_SPECULAR\n        #ifdef LIT_GGX_SPECULAR\n            #include "reflDirAnisoPS"\n        #else\n            #include "reflDirPS"\n        #endif\n    #endif\n#endif\n\n// lighting functionality\n#include "lightingPS"\n\n',litForwardPreCodePS:'\n\n#include "basePS"\n#include "sphericalPS"\n#include "decodePS"\n#include "gammaPS"\n#include "tonemappingPS"\n#include "fogPS"\n\n// 9-slice support code\n#if LIT_NONE_SLICE_MODE == SLICED\n    #include "baseNineSlicedPS"\n#elif LIT_NONE_SLICE_MODE == TILED\n    #include "baseNineSlicedTiledPS"\n#endif\n\n// TBN\n#ifdef LIT_TBN\n    #include "TBNPS"\n\n    #ifdef LIT_TWO_SIDED_LIGHTING\n        #include "twoSidedLightingPS"\n    #endif\n#endif\n\n',litMainVS:'\n#ifdef VERTEX_COLOR\n    attribute vertex_color: vec4f;\n#endif\n\n#ifdef NINESLICED\n\n    varying vMask: vec2f;\n    varying vTiledUv: vec2f;\n\n    uniform innerOffset: vec4f;\n    uniform outerScale: vec2f;\n    uniform atlasRect: vec4f;\n\n#endif\n\nvar<private> dPositionW: vec3f;\nvar<private> dModelMatrix: mat4x4f;\n\n#include "transformCoreVS"\n\n#ifdef UV0\n    attribute vertex_texCoord0: vec2f;\n    #include "uv0VS"\n#endif\n\n#ifdef UV1\n    attribute vertex_texCoord1: vec2f;\n    #include "uv1VS"\n#endif\n\n\n#ifdef LINEAR_DEPTH\n    #ifndef VIEWMATRIX\n    #define VIEWMATRIX\n        uniform matrix_view: mat4x4f;\n    #endif\n#endif\n\n#include "transformVS"\n\n#ifdef NORMALS\n    #include "normalCoreVS"\n    #include "normalVS"\n#endif\n\n#ifdef TANGENTS\n    attribute vertex_tangent: vec4f;\n    #include "tangentBinormalVS"\n#endif\n\n// expand uniforms for uv transforms\n#include "uvTransformUniformsPS, UV_TRANSFORMS_COUNT"\n\n#ifdef MSDF\n    #include "msdfVS"\n#endif\n\n@vertex\nfn vertexMain(input : VertexInput) -> VertexOutput {\n    var output : VertexOutput;\n    output.position = getPosition();\n    output.vPositionW = getWorldPosition();\n\n    #ifdef NORMALS\n        output.vNormalW = getNormal();\n    #endif\n\n    #ifdef TANGENTS\n        output.vTangentW = getTangent();\n        output.vBinormalW = getBinormal();\n    #elif defined(GGX_SPECULAR)\n        output.vObjectSpaceUpW = normalize(dNormalMatrix * vec3f(0.0, 1.0, 0.0));\n    #endif\n\n    #ifdef UV0\n        var uv0: vec2f = getUv0();\n        #ifdef UV0_UNMODIFIED\n            output.vUv0 = uv0;\n        #endif\n    #endif\n\n    #ifdef UV1\n        var uv1: vec2f = getUv1();\n        #ifdef UV1_UNMODIFIED\n            output.vUv1 = uv1;\n        #endif\n    #endif\n\n    // expand code for uv transforms\n    #include "uvTransformVS, UV_TRANSFORMS_COUNT"\n\n    #ifdef VERTEX_COLOR\n        output.vVertexColor = vertex_color;\n    #endif\n\n    #ifdef LINEAR_DEPTH\n        // linear depth from the worldPosition, see getLinearDepth\n        output.vLinearDepth = -(matrix_view * vec4f(vPositionW, 1.0)).z;\n    #endif\n\n    #ifdef MSDF\n        unpackMsdfParams();\n    #endif\n\n    return output;\n}\n',litShaderArgsPS:"\n\n// Surface albedo absorbance\nvar<private> litArgs_albedo: vec3f;\n\n// Transparency\nvar<private> litArgs_opacity: f32;\n\n// Emission color\nvar<private> litArgs_emission: vec3f;\n\n// Normal direction in world space\nvar<private> litArgs_worldNormal: vec3f;\n\n// Ambient occlusion amount, range [0..1]\nvar<private> litArgs_ao: f32;\n\n// Light map color\nvar<private> litArgs_lightmap: vec3f;\n\n// Light map direction\nvar<private> litArgs_lightmapDir: vec3f;\n\n// Surface metalness factor, range [0..1]\nvar<private> litArgs_metalness: f32;\n\n// The f0 specularity factor\nvar<private> litArgs_specularity: vec3f;\n\n// Specularity intensity factor, range [0..1]\nvar<private> litArgs_specularityFactor: f32;\n\n// The microfacet glossiness factor, range [0..1]\nvar<private> litArgs_gloss: f32;\n\n// Glossiness of the sheen layer, range [0..1]\nvar<private> litArgs_sheen_gloss: f32;\n\n// The color of the f0 specularity factor for the sheen layer\nvar<private> litArgs_sheen_specularity: vec3f;\n\n// Transmission factor (refraction), range [0..1]\nvar<private> litArgs_transmission: f32;\n\n// Uniform thickness of medium, used by transmission, range [0..inf]\nvar<private> litArgs_thickness: f32;\n\n// Index of refraction\nvar<private> litArgs_ior: f32;\n\n// Dispersion, range [0..1] typically, but can be higher\nvar<private> litArgs_dispersion: f32;\n\n// Iridescence effect intensity, range [0..1]\nvar<private> litArgs_iridescence_intensity: f32;\n\n// Thickness of the iridescent microfilm layer, value is in nanometers, range [0..1000]\nvar<private> litArgs_iridescence_thickness: f32;\n\n// The normal used for the clearcoat layer\nvar<private> litArgs_clearcoat_worldNormal: vec3f;\n\n// Intensity of the clearcoat layer, range [0..1]\nvar<private> litArgs_clearcoat_specularity: f32;\n\n// Glossiness of clearcoat layer, range [0..1]\nvar<private> litArgs_clearcoat_gloss: f32;\n\n",litShaderCorePS:'\n\n    // global texture bias for standard textures\n    #if LIT_NONE_SLICE_MODE == TILED\n        var<private> textureBias: f32 = -1000.0;\n    #else\n        uniform textureBias: f32;\n    #endif\n\n    #include "litShaderArgsPS"\n',morphEvaluationPS:"\n    color += uniform.morphFactor[{i}].element * textureSampleLevel(morphBlendTex{i}, morphBlendTex{i}Sampler, input.uv0, 0).xyz;\n",morphDeclarationPS:"\n    var morphBlendTex{i}: texture_2d<f32>;\n    var morphBlendTex{i}Sampler : sampler;\n",morphPS:'\n\n    varying uv0: vec2f;\n\n    // LOOP - source morph target textures\n    #include "morphDeclarationPS, MORPH_TEXTURE_COUNT"\n\n    #if MORPH_TEXTURE_COUNT > 0\n        uniform morphFactor: array<f32, {MORPH_TEXTURE_COUNT}>;\n    #endif\n\n    @fragment\n    fn fragmentMain(input : FragmentInput) -> FragmentOutput {\n        var output: FragmentOutput;\n\n        var color = vec3f(0, 0, 0);\n\n        // LOOP - source morph target textures\n        #include "morphEvaluationPS, MORPH_TEXTURE_COUNT"\n\n        output.color = vec4f(color, 1.0);\n        return output;\n    }\n',morphVS:"\n    attribute vertex_position: vec2f;\n    varying uv0: vec2f;\n\n    @vertex\n    fn vertexMain(input: VertexInput) -> VertexOutput {\n        var output: VertexOutput;\n        output.position = vec4f(input.vertex_position, 0.5, 1.0);\n        output.uv0 = input.vertex_position * 0.5 + vec2f(0.5, 0.5);\n        return output;\n    }\n",normalCoreVS:"\nattribute vertex_normal: vec3f;\n#ifdef MORPHING_NORMAL\n	#ifdef MORPHING_INT\n		uniform morphNormalTex: texture_2d<u32>;\n		uniform morphNormalTexSampler: sampler;\n	#else\n		uniform morphNormalTex: texture_2d<f32>;\n		uniform morphNormalTexSampler: sampler;\n	#endif\n#endif\nfn getLocalNormal(vertexNormal: vec3f) -> vec3f {\n	var localNormal: vec3f = vertexNormal;\n	#ifdef MORPHING_NORMAL\n		let morphUV: vec2i = getTextureMorphCoords();\n		#ifdef MORPHING_INT\n			let morphNormalInt: vec4u = textureLoad(morphNormalTex, morphUV, 0);\n			let morphNormalF: vec3f = vec3f(morphNormalInt.xyz) / 65535.0 * 2.0 - 1.0;\n			localNormal = localNormal + morphNormalF;\n		#else\n			let morphNormal: vec3f = textureLoad(morphNormalTex, morphUV, 0).xyz;\n			localNormal = localNormal + morphNormal;\n		#endif\n	#endif\n	return localNormal;\n}\n#ifdef SKIN\n	fn getNormalMatrix(modelMatrix: mat4x4f) -> mat3x3f {\n		return mat3x3f(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);\n	}\n#elif defined(INSTANCING)\n	fn getNormalMatrix(modelMatrix: mat4x4f) -> mat3x3f {\n		return mat3x3f(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);\n	}\n#else\n	fn getNormalMatrix(modelMatrix: mat4x4f) -> mat3x3f {\n		return uniform.matrix_normal;\n	}\n#endif\n",outputPS:"\n",outputAlphaPS:"\n\n#if LIT_BLEND_TYPE == NORMAL || LIT_BLEND_TYPE == ADDITIVEALPHA || defined(LIT_ALPHA_TO_COVERAGE)\n\n    output.color = vec4f(output.color.rgb, litArgs_opacity);\n\n#elif LIT_BLEND_TYPE == PREMULTIPLIED\n\n    output.color = vec4f(output.color.rgb * litArgs_opacity, litArgs_opacity);\n\n#else\n\n    output.color = vec4f(output.color.rgb, 1.0);\n\n#endif\n",reprojectPS:'\n\nvarying vUv0: vec2f;\n\n#ifdef CUBEMAP_SOURCE\n    var sourceCube: texture_cube<f32>;\n    var sourceCubeSampler : sampler;\n#else\n    var sourceTex: texture_2d<f32>;\n    var sourceTexSampler : sampler;\n#endif\n\n#ifdef USE_SAMPLES_TEX\n    // samples\n    var samplesTex: texture_2d<f32>;\n    var samplesTexSampler : sampler;\n    uniform samplesTexInverseSize: vec2f;\n#endif\n\n// params:\n// x - target cubemap face 0..6\n// y - target image total pixels\n// z - source cubemap size\nuniform params: vec3f;\n\nfn targetFace() -> f32 { return uniform.params.x; }\nfn targetTotalPixels() -> f32 { return uniform.params.y; }\nfn sourceTotalPixels() -> f32 { return uniform.params.z; }\n\nconst PI: f32 = 3.141592653589793;\n\nfn saturate(x: f32) -> f32 {\n    return clamp(x, 0.0, 1.0);\n}\n\n#include "decodePS"\n#include "encodePS"\n\n//-- supported projections\n\nfn modifySeams(dir: vec3f, scale: f32) -> vec3f {\n    let adir = abs(dir);\n    let M = max(max(adir.x, adir.y), adir.z);\n    return dir / M * vec3f(\n        select(scale, 1.0, adir.x == M),\n        select(scale, 1.0, adir.y == M),\n        select(scale, 1.0, adir.z == M)\n    );\n}\n\nfn toSpherical(dir: vec3f) -> vec2f {\n    let nonZeroXZ = any(dir.xz != vec2f(0.0, 0.0));\n    return vec2f(select(0.0, atan2(dir.x, dir.z), nonZeroXZ), asin(dir.y));\n}\n\nfn fromSpherical(uv: vec2f) -> vec3f {\n    return vec3f(cos(uv.y) * sin(uv.x),\n                sin(uv.y),\n                cos(uv.y) * cos(uv.x));\n}\n\nfn getDirectionEquirect(uv: vec2f) -> vec3f {\n    return fromSpherical((vec2f(uv.x, 1.0 - uv.y) * 2.0 - 1.0) * vec2f(PI, PI * 0.5));\n}\n\n// octahedral code, based on https://jcgt.org/published/0003/02/01/\n// "Survey of Efficient Representations for Independent Unit Vectors" by Cigolle, Donow, Evangelakos, Mara, McGuire, Meyer\n\nfn signNotZero(k: f32) -> f32 {\n    return select(-1.0, 1.0, k >= 0.0);\n}\n\nfn signNotZeroVec2(v: vec2f) -> vec2f {\n    return vec2f(signNotZero(v.x), signNotZero(v.y));\n}\n\n// Returns a unit vector. Argument o is an octahedral vector packed via octEncode, on the [-1, +1] square\nfn octDecode(o: vec2f) -> vec3f {\n    var v = vec3f(o.x, 1.0 - abs(o.x) - abs(o.y), o.y);\n    if (v.y < 0.0) {\n        var temp: vec2f = (1.0 - abs(v.zx)) * signNotZeroVec2(v.xz);\n        v = vec3f(temp.x, v.y, temp.y);\n    }\n    return normalize(v);\n}\n\nfn getDirectionOctahedral(uv: vec2f) -> vec3f {\n    return octDecode(vec2f(uv.x, 1.0 - uv.y) * 2.0 - 1.0);\n}\n\n// Assumes that v is a unit vector. The result is an octahedral vector on the [-1, +1] square\nfn octEncode(v: vec3f) -> vec2f {\n    let l1norm = abs(v.x) + abs(v.y) + abs(v.z);\n    var result = v.xz * (1.0 / l1norm);\n    if (v.y < 0.0) {\n        result = (1.0 - abs(result.yx)) * signNotZeroVec2(result.xy);\n    }\n    return result;\n}\n\n/////////////////////////////////////////////////////////////////////\n\n#ifdef CUBEMAP_SOURCE\n    fn sampleCubemapDir(dir: vec3f) -> vec4f {\n        return textureSample(sourceCube, sourceCubeSampler, modifySeams(dir, 1.0));\n    }\n\n    fn sampleCubemapSph(sph: vec2f) -> vec4f {\n        return sampleCubemapDir(fromSpherical(sph));\n    }\n\n    fn sampleCubemapDirLod(dir: vec3f, mipLevel: f32) -> vec4f {\n        return textureSampleLevel(sourceCube, sourceCubeSampler, modifySeams(dir, 1.0), mipLevel);\n    }\n\n    fn sampleCubemapSphLod(sph: vec2f, mipLevel: f32) -> vec4f {\n        return sampleCubemapDirLod(fromSpherical(sph), mipLevel);\n    }\n#else\n\n    fn sampleEquirectSph(sph: vec2f) -> vec4f {\n        let uv = sph / vec2f(PI * 2.0, PI) + 0.5;\n        return textureSample(sourceTex, sourceTexSampler, vec2f(uv.x, 1.0 - uv.y));\n    }\n\n    fn sampleEquirectDir(dir: vec3f) -> vec4f {\n        return sampleEquirectSph(toSpherical(dir));\n    }\n\n    fn sampleEquirectSphLod(sph: vec2f, mipLevel: f32) -> vec4f {\n        let uv = sph / vec2f(PI * 2.0, PI) + 0.5;\n        return textureSampleLevel(sourceTex, sourceTexSampler, vec2f(uv.x, 1.0 - uv.y), mipLevel);\n    }\n\n    fn sampleEquirectDirLod(dir: vec3f, mipLevel: f32) -> vec4f {\n        return sampleEquirectSphLod(toSpherical(dir), mipLevel);\n    }\n\n    fn sampleOctahedralDir(dir: vec3f) -> vec4f {\n        let uv = octEncode(dir) * 0.5 + 0.5;\n        return textureSample(sourceTex, sourceTexSampler, vec2f(uv.x, 1.0 - uv.y));\n    }\n\n    fn sampleOctahedralSph(sph: vec2f) -> vec4f {\n        return sampleOctahedralDir(fromSpherical(sph));\n    }\n\n    fn sampleOctahedralDirLod(dir: vec3f, mipLevel: f32) -> vec4f {\n        let uv = octEncode(dir) * 0.5 + 0.5;\n        return textureSampleLevel(sourceTex, sourceTexSampler, vec2f(uv.x, 1.0 - uv.y), mipLevel);\n    }\n\n    fn sampleOctahedralSphLod(sph: vec2f, mipLevel: f32) -> vec4f {\n        return sampleOctahedralDirLod(fromSpherical(sph), mipLevel);\n    }\n\n#endif\n\nfn getDirectionCubemap(uv: vec2f) -> vec3f {\n    let st = uv * 2.0 - 1.0;\n    let face = targetFace();\n\n    var vec: vec3f;\n    if (face == 0.0) {\n        vec = vec3f(1, -st.y, -st.x);\n    } else if (face == 1.0) {\n        vec = vec3f(-1, -st.y, st.x);\n    } else if (face == 2.0) {\n        vec = vec3f(st.x, 1, st.y);\n    } else if (face == 3.0) {\n        vec = vec3f(st.x, -1, -st.y);\n    } else if (face == 4.0) {\n        vec = vec3f(st.x, -st.y, 1);\n    } else {\n        vec = vec3f(-st.x, -st.y, -1);\n    }\n\n    return normalize(modifySeams(vec, 1.0));\n}\n\nfn matrixFromVector(n: vec3f) -> mat3x3f {\n    let a = 1.0 / (1.0 + n.z);\n    let b = -n.x * n.y * a;\n    let b1 = vec3f(1.0 - n.x * n.x * a, b, -n.x);\n    let b2 = vec3f(b, 1.0 - n.y * n.y * a, -n.y);\n    return mat3x3f(b1, b2, n);\n}\n\nfn matrixFromVectorSlow(n: vec3f) -> mat3x3f {\n    let up = select(vec3f(0.0, 0.0, select(-1.0, 1.0, n.y > 0.0)), vec3f(0.0, 1.0, 0.0), abs(n.y) > 0.0000001);\n    let x = normalize(cross(up, n));\n    let y = cross(n, x);\n    return mat3x3f(x, y, n);\n}\n\nfn reproject(uv: vec2f) -> vec4f {\n    if ({NUM_SAMPLES} <= 1) {\n        // single sample\n        return {ENCODE_FUNC}({DECODE_FUNC}({SOURCE_FUNC}Dir({TARGET_FUNC}(uv))));\n    } else {\n        // multi sample\n        let t = {TARGET_FUNC}(uv);\n        let tu = dpdx(t);\n        let tv = dpdy(t);\n\n        var result = vec3f(0.0);\n        for (var u = 0.0; u < {NUM_SAMPLES_SQRT}; u += 1.0) {\n            for (var v = 0.0; v < {NUM_SAMPLES_SQRT}; v += 1.0) {\n                result += {DECODE_FUNC}({SOURCE_FUNC}Dir(normalize(t +\n                                                            tu * (u / {NUM_SAMPLES_SQRT} - 0.5) +\n                                                            tv * (v / {NUM_SAMPLES_SQRT} - 0.5))));\n            }\n        }\n        return {ENCODE_FUNC}(result / ({NUM_SAMPLES_SQRT} * {NUM_SAMPLES_SQRT}));\n    }\n}\n\nconst unpackFloat: vec4f = vec4f(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0);\n\n#ifdef USE_SAMPLES_TEX\n    fn unpackSample(i: i32, L: ptr<function, vec3f>, mipLevel: ptr<function, f32>) {\n        var u = (f32(i * 4) + 0.5) * uniform.samplesTexInverseSize.x;\n        var v = (floor(u) + 0.5) * uniform.samplesTexInverseSize.y;\n\n        var raw: vec4f;\n        raw.x = dot(textureSample(samplesTex, samplesTexSampler, vec2f(u, v)), unpackFloat); u += uniform.samplesTexInverseSize.x;\n        raw.y = dot(textureSample(samplesTex, samplesTexSampler, vec2f(u, v)), unpackFloat); u += uniform.samplesTexInverseSize.x;\n        raw.z = dot(textureSample(samplesTex, samplesTexSampler, vec2f(u, v)), unpackFloat); u += uniform.samplesTexInverseSize.x;\n        raw.w = dot(textureSample(samplesTex, samplesTexSampler, vec2f(u, v)), unpackFloat);\n\n        *L = raw.xyz * 2.0 - 1.0;\n        *mipLevel = raw.w * 8.0;\n    }\n\n    // convolve an environment given pre-generated samples\n    fn prefilterSamples(uv: vec2f) -> vec4f {\n        // construct vector space given target direction\n        let vecSpace = matrixFromVectorSlow({TARGET_FUNC}(uv));\n\n        var L: vec3f;\n        var mipLevel: f32;\n\n        var result = vec3f(0.0);\n        var totalWeight = 0.0;\n        for (var i = 0; i < {NUM_SAMPLES}; i += 1) {\n            unpackSample(i, &L, &mipLevel);\n            result += {DECODE_FUNC}({SOURCE_FUNC}DirLod(vecSpace * L, mipLevel)) * L.z;\n            totalWeight += L.z;\n        }\n\n        return {ENCODE_FUNC}(result / totalWeight);\n    }\n\n    // unweighted version of prefilterSamples\n    fn prefilterSamplesUnweighted(uv: vec2f) -> vec4f {\n        // construct vector space given target direction\n        let vecSpace = matrixFromVectorSlow({TARGET_FUNC}(uv));\n\n        var L: vec3f;\n        var mipLevel: f32;\n\n        var result = vec3f(0.0);\n        for (var i = 0; i < {NUM_SAMPLES}; i += 1) {\n            unpackSample(i, &L, &mipLevel);\n            result += {DECODE_FUNC}({SOURCE_FUNC}DirLod(vecSpace * L, mipLevel));\n        }\n\n        return {ENCODE_FUNC}(result / f32({NUM_SAMPLES}));\n    }\n#endif\n\n@fragment\nfn fragmentMain(input : FragmentInput) -> FragmentOutput {\n    var output: FragmentOutput;\n    output.color = {PROCESS_FUNC}(input.vUv0);\n    return output;\n}\n',reprojectVS:"\nattribute vertex_position: vec2f;\nuniform uvMod: vec4f;\nvarying vUv0: vec2f;\n\n@vertex\nfn vertexMain(input: VertexInput) -> VertexOutput {\n  var output: VertexOutput;\n  output.position = vec4f(input.vertex_position, 0.5, 1.0);\n  output.vUv0 = getImageEffectUV((input.vertex_position * 0.5 + vec2f(0.5, 0.5)) * uniform.uvMod.xy + uniform.uvMod.zw);\n  return output;\n}\n",skinVS:"\n\nattribute vertex_boneWeights: vec4f;\nattribute vertex_boneIndices: vec4f;\n\nvar texture_poseMap: texture_2d<f32>;\n\nstruct BoneMatrix {\n    v1: vec4f,\n    v2: vec4f,\n    v3: vec4f,\n}\n\nfn getBoneMatrix(width: i32, index: i32) -> BoneMatrix {\n\n    let v = index / width;\n    let u = index % width;\n\n    var result: BoneMatrix;\n    result.v1 = textureLoad(texture_poseMap, vec2i(u + 0, v), 0);\n    result.v2 = textureLoad(texture_poseMap, vec2i(u + 1, v), 0);\n    result.v3 = textureLoad(texture_poseMap, vec2i(u + 2, v), 0);\n    return result;\n}\n\nfn getSkinMatrix(indicesFloat: vec4f, weights: vec4f) -> mat4x4f {\n\n    let width = i32(textureDimensions(texture_poseMap).x);\n    var indices = vec4i(indicesFloat + 0.5) * 3;\n\n    let boneA = getBoneMatrix(width, indices.x);\n    let boneB = getBoneMatrix(width, indices.y);\n    let boneC = getBoneMatrix(width, indices.z);\n    let boneD = getBoneMatrix(width, indices.w);\n\n    // ... rest of getSkinMatrix remains the same ...\n    let v1 = boneA.v1 * weights.x + boneB.v1 * weights.y + boneC.v1 * weights.z + boneD.v1 * weights.w;\n    let v2 = boneA.v2 * weights.x + boneB.v2 * weights.y + boneC.v2 * weights.z + boneD.v2 * weights.w;\n    let v3 = boneA.v3 * weights.x + boneB.v3 * weights.y + boneC.v3 * weights.z + boneD.v3 * weights.w;\n\n    let one = dot(weights, vec4f(1.0, 1.0, 1.0, 1.0));\n\n    // transpose to 4x4 matrix\n    return mat4x4f(\n        v1.x, v2.x, v3.x, 0,\n        v1.y, v2.y, v3.y, 0,\n        v1.z, v2.z, v3.z, 0,\n        v1.w, v2.w, v3.w, one\n    );\n}\n",skyboxPS:'\n    #define LIT_SKYBOX_INTENSITY\n\n    #include "envProcPS"\n    #include "gammaPS"\n    #include "tonemappingPS"\n\n    // Varying and uniform declarations\n    varying vViewDir : vec3f;\n    uniform skyboxHighlightMultiplier : f32;\n\n    #ifdef SKY_CUBEMAP\n\n        var texture_cubeMap : texture_cube<f32>;\n        var texture_cubeMap_sampler : sampler;\n\n        #ifdef SKYMESH\n            varying vWorldPos : vec3f;\n            uniform cubeMapRotationMatrix : mat3x3f;\n            uniform projectedSkydomeCenter : vec3f;\n        #endif\n\n    #else // env-atlas\n\n        #include "sphericalPS"\n        #include "envAtlasPS"\n\n        var texture_envAtlas : texture_2d<f32>;\n        var texture_envAtlas_sampler : sampler;\n\n        uniform mipLevel : f32;\n\n    #endif\n\n    @fragment\n    fn fragmentMain(input : FragmentInput) -> FragmentOutput {\n\n        var linear : vec3f;\n        var dir : vec3f;\n\n        #ifdef SKY_CUBEMAP\n\n            #ifdef SKYMESH\n                // get vector from world space pos to tripod origin\n                var envDir : vec3f = normalize(input.vWorldPos - uniform.projectedSkydomeCenter);\n                dir = envDir * uniform.cubeMapRotationMatrix;\n            #else\n                dir = input.vViewDir;\n            #endif\n\n            dir.x *= -1.0;\n            linear = {SKYBOX_DECODE_FNC}(textureSample(texture_cubeMap, texture_cubeMap_sampler, dir));\n\n        #else // env-atlas\n\n            dir = input.vViewDir * vec3f(-1.0, 1.0, 1.0);\n            let uv : vec2f = toSphericalUv(normalize(dir));\n            linear = {SKYBOX_DECODE_FNC}(textureSample(texture_envAtlas, texture_envAtlas_sampler, mapRoughnessUv(uv, uniform.mipLevel)));\n\n        #endif\n\n        // our HDR encodes values up to 64, so allow extra brightness for the clipped values\n        if (any(linear >= vec3f(64.0))) {\n            linear *= uniform.skyboxHighlightMultiplier;\n        }\n        \n        var output: FragmentOutput;\n        output.color = vec4f(gammaCorrectOutput(toneMap(processEnvironment(linear))), 1.0);\n        return output;\n    }\n',skyboxVS:"\n    // Attribute\n    attribute aPosition : vec4f;\n\n    #ifndef VIEWMATRIX\n    #define VIEWMATRIX\n    uniform matrix_view : mat4x4f;\n    #endif\n\n    uniform matrix_projectionSkybox : mat4x4f;\n    uniform cubeMapRotationMatrix : mat3x3f;\n\n    varying vViewDir : vec3f;\n\n    #ifdef SKYMESH\n        uniform matrix_model : mat4x4f;\n        varying vWorldPos : vec3f;\n    #endif\n\n    @vertex\n    fn vertexMain(input : VertexInput) -> VertexOutput {\n\n        var output : VertexOutput;\n        var view : mat4x4f = uniform.matrix_view;\n\n        #ifdef SKYMESH\n\n            var worldPos : vec4f = uniform.matrix_model * input.aPosition;\n            output.vWorldPos = worldPos.xyz;\n            output.position = uniform.matrix_projectionSkybox * (view * worldPos);\n\n        #else\n\n            view[3][0] = 0.0;\n            view[3][1] = 0.0;\n            view[3][2] = 0.0;\n            output.position = uniform.matrix_projectionSkybox * (view * input.aPosition);\n            output.vViewDir = input.aPosition.xyz * uniform.cubeMapRotationMatrix;\n\n        #endif\n\n        // Force skybox to far Z, regardless of the clip planes on the camera\n        // Subtract a tiny fudge factor to ensure floating point errors don't\n        // still push pixels beyond far Z. See:\n        // https://community.khronos.org/t/skybox-problem/61857\n\n        output.position.z = output.position.w - 1.0e-7;\n\n        return output;\n    }\n",sphericalPS:"\n\nfn toSpherical(dir: vec3f) -> vec2f {\n    let angle_xz = select(0.0, atan2(dir.x, dir.z), any(dir.xz != vec2f(0.0)));\n    return vec2f(angle_xz, asin(dir.y));\n}\n\nfn toSphericalUv(dir : vec3f) -> vec2f {\n    const PI : f32 = 3.141592653589793;\n    let uv : vec2f = toSpherical(dir) / vec2f(PI * 2.0, PI) + vec2f(0.5, 0.5);\n    return vec2f(uv.x, 1.0 - uv.y);\n}\n",tonemappingPS:'\n#if (TONEMAP == NONE)\n    #include "tonemappingNonePS"\n#elif TONEMAP == FILMIC\n    #include "tonemappingFilmicPS"\n#elif TONEMAP == LINEAR\n    #include "tonemappingLinearPS"\n#elif TONEMAP == HEJL\n    #include "tonemappingHejlPS"\n#elif TONEMAP == ACES\n    #include "tonemappingAcesPS"\n#elif TONEMAP == ACES2\n    #include "tonemappingAces2PS"\n#elif TONEMAP == NEUTRAL\n    #include "tonemappingNeutralPS"\n#endif\n',tonemappingAcesPS:"\nuniform exposure: f32;\n\nfn toneMap(color: vec3f) -> vec3f {\n    let tA: f32 = 2.51;\n    let tB: f32 = 0.03;\n    let tC: f32 = 2.43;\n    let tD: f32 = 0.59;\n    let tE: f32 = 0.14;\n    let x: vec3f = color * uniform.exposure;\n    return (x * (tA * x + tB)) / (x * (tC * x + tD) + tE);\n}\n",tonemappingAces2PS:"\nuniform exposure: f32;\n\n// ACES approximation by Stephen Hill\n\n// sRGB => XYZ => D65_2_D60 => AP1 => RRT_SAT\nconst ACESInputMat: mat3x3f = mat3x3f(\n    vec3f(0.59719, 0.35458, 0.04823),\n    vec3f(0.07600, 0.90834, 0.01566),\n    vec3f(0.02840, 0.13383, 0.83777)\n);\n\n// ODT_SAT => XYZ => D60_2_D65 => sRGB\nconst ACESOutputMat: mat3x3f = mat3x3f(\n    vec3f( 1.60475, -0.53108, -0.07367),\n    vec3f(-0.10208,  1.10813, -0.00605),\n    vec3f(-0.00327, -0.07276,  1.07602)\n);\n\nfn RRTAndODTFit(v: vec3f) -> vec3f {\n    let a: vec3f = v * (v + vec3f(0.0245786)) - vec3f(0.000090537);\n    let b: vec3f = v * (vec3f(0.983729) * v + vec3f(0.4329510)) + vec3f(0.238081);\n    return a / b;\n}\n\nfn toneMap(color: vec3f) -> vec3f {\n    var c: vec3f = color * (uniform.exposure / 0.6);\n    c = ACESInputMat * c;\n\n    // Apply RRT and ODT\n    c = RRTAndODTFit(c);\n    c = ACESOutputMat * c;\n\n    // Clamp to [0, 1]\n    return clamp(c, vec3f(0.0), vec3f(1.0));\n}\n",tonemappingFilmicPS:"\nconst A: f32 = 0.15;\nconst B: f32 = 0.50;\nconst C: f32 = 0.10;\nconst D: f32 = 0.20;\nconst E: f32 = 0.02;\nconst F: f32 = 0.30;\nconst W: f32 = 11.2;\n\nuniform exposure: f32;\n\nfn uncharted2Tonemap(x: vec3f) -> vec3f {\n    return ((x * (A * x + C * B) + D * E) / (x * (A * x + B) + D * F)) - vec3f(E / F);\n}\n\nfn toneMap(color: vec3f) -> vec3f {\n    var c: vec3f = uncharted2Tonemap(color * uniform.exposure);\n    let whiteScale: vec3f = vec3f(1.0) / uncharted2Tonemap(vec3f(W, W, W));\n    c *= whiteScale;\n    return c;\n}\n",tonemappingHejlPS:"\nuniform exposure: f32;\n\nfn toneMap(color: vec3f) -> vec3f {\n    let A: f32 = 0.22;\n    let B: f32 = 0.3;\n    let C: f32 = 0.1;\n    let D: f32 = 0.2;\n    let E: f32 = 0.01;\n    let F: f32 = 0.3;\n    let Scl: f32 = 1.25;\n\n    let adjusted_color = color * uniform.exposure;\n    let h = max(vec3f(0.0), adjusted_color - vec3f(0.004));\n\n    return (h * ((Scl * A) * h + Scl * vec3f(C * B)) + Scl * vec3f(D * E)) /\n           (h * (A * h + vec3f(B)) + vec3f(D * F)) -\n           Scl * vec3f(E / F);\n}\n",tonemappingLinearPS:"\nuniform exposure: f32;\n\nfn toneMap(color: vec3f) -> vec3f {\n    return color * uniform.exposure;\n}\n",tonemappingNeutralPS:"\nuniform exposure: f32;\n\nfn toneMap(col: vec3f) -> vec3f {\n    var color = col * uniform.exposure;\n\n    let startCompression = 0.8 - 0.04;\n    let desaturation = 0.15;\n\n    let x = min(color.r, min(color.g, color.b));\n    let offset = select(0.04, x - 6.25 * x * x, x < 0.08);\n    color -= vec3f(offset);\n\n    let peak = max(color.r, max(color.g, color.b));\n    if (peak < startCompression) {\n        return color;\n    }\n\n    let d = 1.0 - startCompression;\n    let newPeak = 1.0 - d * d / (peak + d - startCompression);\n    color *= newPeak / peak;\n\n    let g = 1.0 - 1.0 / (desaturation * (peak - newPeak) + 1.0);\n    return mix(color, vec3f(newPeak), vec3f(g));\n}\n",tonemappingNonePS:"\nfn toneMap(color: vec3f) -> vec3f {\n    return color;\n}\n",transformVS:"\n#ifdef PIXELSNAP\n    uniform uScreenSize: vec4f;\n#endif\n\n#ifdef SCREENSPACE\n    uniform projectionFlipY: f32;\n#endif\n\nfn evalWorldPosition(vertexPosition: vec3f, modelMatrix: mat4x4f) -> vec4f {\n\n    var localPos: vec3f = getLocalPosition(vertexPosition);\n\n    #ifdef NINESLICED\n        // outer and inner vertices are at the same position, scale both\n        localPos.xz *= uniform.outerScale;\n\n        // offset inner vertices inside\n        // (original vertices must be in [-1;1] range)\n        let positiveUnitOffset: vec2f = clamp(vertexPosition.xz, vec2f(0.0), vec2f(1.0));\n        let negativeUnitOffset: vec2f = clamp(-vertexPosition.xz, vec2f(0.0), vec2f(1.0));\n        localPos.xz += (-positiveUnitOffset * uniform.innerOffset.xy + negativeUnitOffset * uniform.innerOffset.zw) * vertex_texCoord0.xy;\n\n        vTiledUv = (localPos.xz - outerScale + uniform.innerOffset.xy) * -0.5 + 1.0; // uv = local pos - inner corner\n\n        localPos.xz *= -0.5; // move from -1;1 to -0.5;0.5\n        localPos = localPos.xzy;\n    #endif\n\n    var posW: vec4f = modelMatrix * vec4f(localPos, 1.0);\n\n    #ifdef SCREENSPACE\n        posW.zw = vec2f(0.0, 1.0);\n    #endif\n\n    return posW;\n}\n\nfn getPosition() -> vec4f {\n\n    dModelMatrix = getModelMatrix();\n\n    let posW: vec4f = evalWorldPosition(vertex_position.xyz, dModelMatrix);\n    dPositionW = posW.xyz;\n\n    var screenPos: vec4f;\n    #ifdef UV1LAYOUT\n        screenPos = vec4f(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1.0);\n        screenPos.y *= -1.0;\n    #else\n        #ifdef SCREENSPACE\n            screenPos = posW;\n            screenPos.y *= uniforms.projectionFlipY;\n        #else\n            screenPos = uniform.matrix_viewProjection * posW;\n        #endif\n\n        #ifdef PIXELSNAP\n            // snap vertex to a pixel boundary\n            screenPos.xy = (screenPos.xy * 0.5) + 0.5;\n            screenPos.xy *= uniforms.uScreenSize.xy;\n            screenPos.xy = floor(screenPos.xy);\n            screenPos.xy *= uniforms.uScreenSize.zw;\n            screenPos.xy = (screenPos.xy * 2.0) - 1.0;\n        #endif\n    #endif\n\n    return screenPos;\n}\n\nfn getWorldPosition() -> vec3f {\n    return dPositionW;\n}\n",transformCoreVS:'\n\n    attribute vertex_position: vec4f;\n\n    uniform matrix_viewProjection: mat4x4f;\n    uniform matrix_model: mat4x4f;\n    uniform matrix_normal: mat3x3f;\n\n    #ifdef MORPHING\n\n        uniform morph_tex_params: vec2f;\n        attribute morph_vertex_id: u32;\n\n        fn getTextureMorphCoords() -> vec2i {\n\n            // turn morph_vertex_id into int grid coordinates\n            var textureSize: vec2i = vec2i(uniform.morph_tex_params);\n            var morphGridV: i32 = i32(morph_vertex_id) / textureSize.x;\n            var morphGridU: i32 = i32(morph_vertex_id) - (morphGridV * textureSize.x);\n            morphGridV = textureSize.y - morphGridV - 1;\n            return vec2i(morphGridU, morphGridV);\n        }\n\n        #ifdef MORPHING_POSITION\n            #ifdef MORPHING_INT\n                uniform aabbSize: vec3f;\n                uniform aabbMin: vec3f;\n                var morphPositionTex: texture_2d<u32>;\n            #else\n                var morphPositionTex: texture_2d<f32>;\n            #endif\n        #endif\n    #endif\n\n    #ifdef defined(BATCH)\n        #include "skinBatchVS"\n\n        fn getModelMatrix() -> mat4x4f {\n            return getBoneMatrix(vertex_boneIndices);\n        }\n\n    #elif defined(SKIN)\n        #include "skinVS"\n        fn getModelMatrix() -> mat4x4f {\n            return uniform.matrix_model * getSkinMatrix(vertex_boneIndices, vertex_boneWeights);\n        }\n\n    #elif defined(INSTANCING)\n\n        #include "transformInstancingVS"\n\n    #else\n\n        fn getModelMatrix() -> mat4x4f {\n            return uniform.matrix_model;\n        }\n\n    #endif\n\n    fn getLocalPosition(vertexPosition: vec3f) -> vec3f {\n\n        var localPos: vec3f = vertexPosition;\n\n        #ifdef MORPHING_POSITION\n\n            var morphUV: vec2i = getTextureMorphCoords();\n\n            #ifdef MORPHING_INT\n                // Use textureLoad instead of texelFetch. Coordinates must be integer type (vec2i).\n                // WGSL requires explicit type conversion for vectors.\n                // Division by float literal ensures floating point division.\n                var morphPos: vec3f = vec3f(textureLoad(morphPositionTex, morphUV, 0).xyz) / 65535.0 * uniform.aabbSize + uniform.aabbMin;\n            #else\n                // Use textureLoad instead of texelFetch. Coordinates must be integer type (vec2i).\n                var morphPos: vec3f = textureLoad(morphPositionTex, morphUV, 0).xyz;\n            #endif\n\n            localPos += morphPos;\n\n        #endif\n\n        return localPos;\n    }\n',uv0VS:"\n#ifdef NINESLICED\n    fn getUv0() -> vec2f {\n        var uv = vertex_position.xz;\n\n        // offset inner vertices inside\n        let positiveUnitOffset = clamp(vertex_position.xz, vec2f(0.0, 0.0), vec2f(1.0, 1.0));\n        let negativeUnitOffset = clamp(-vertex_position.xz, vec2f(0.0, 0.0), vec2f(1.0, 1.0));\n\n        uv = uv + ((-positiveUnitOffset * uniform.innerOffset.xy) + (negativeUnitOffset * uniform.innerOffset.zw)) * vertex_texCoord0.xy;\n\n        uv = uv * -0.5 + vec2f(0.5, 0.5);\n        uv = uv * uniform.atlasRect.zw + uniform.atlasRect.xy;\n\n        vMask = vertex_texCoord0.xy;\n\n        return uv;\n    }\n#else\n    fn getUv0() -> vec2f {\n        return vertex_texCoord0;\n    }\n#endif\n",uv1VS:"\nfn getUv1() -> vec2f {\n    return vertex_texCoord1;\n}\n",uvTransformVS:"\nvUV{TRANSFORM_UV_{i}}_{TRANSFORM_ID_{i}} = vec2f(\n    dot(vec3f(uv{TRANSFORM_UV_{i}}, 1), {TRANSFORM_NAME_{i}}0),\n    dot(vec3f(uv{TRANSFORM_UV_{i}}, 1), {TRANSFORM_NAME_{i}}1)\n);\n",uvTransformUniformsPS:"\n    uniform {TRANSFORM_NAME_{i}}0: vec3f;\n    uniform {TRANSFORM_NAME_{i}}1: vec3f;\n"},oI=new eu,oR=new Float32Array(6),oL=new eu(-0.5,0,0),oD=new eu(0,0,.5),oO={POSITION_RANGE:0,DIRECTION_FLAGS:1,COLOR_ANGLES_BIAS:2,PROJ_MAT_0:3,ATLAS_VIEWPORT:3,PROJ_MAT_1:4,PROJ_MAT_2:5,PROJ_MAT_3:6,AREA_DATA_WIDTH:7,AREA_DATA_HEIGHT:8,COUNT:9},oF=(e,t)=>Object.keys(e).map(s=>"#define "+t+s+" "+e[s]).join("\n");am.lightBufferDefinesPS=oM.lightBufferDefinesPS="\n\n    "+oF(oO,"CLUSTER_TEXTURE_")+"\n    "+oF({"{LIGHTSHAPE_PUNCTUAL}":"0u","{LIGHTSHAPE_RECT}":"1u","{LIGHTSHAPE_DISK}":"2u","{LIGHTSHAPE_SPHERE}":"3u","{LIGHT_COLOR_DIVIDER}":"100.0"},"")+"\n";class oN{destroy(){var e;null==(e=this.lightsTexture)||e.destroy(),this.lightsTexture=null;}createTexture(e,t,s,i,n){return new se(e,{name:n,width:t,height:s,mipmaps:false,format:i,addressU:1,addressV:1,type:tb,magFilter:0,minFilter:0,anisotropy:1})}setBounds(e,t){this.boundsMin.copy(e),this.boundsDelta.copy(t);}uploadTextures(){this.lightsTexture.lock().set(this.lightsFloat),this.lightsTexture.unlock();}updateUniforms(){this._lightsTextureId.setValue(this.lightsTexture);}getSpotDirection(e,t){t._node.getWorldTransform().getY(e).mulScalar(-1),e.normalize();}getLightAreaSizes(e){let t=e._node.getWorldTransform();return t.transformVector(oL,oI),oR[0]=oI.x,oR[1]=oI.y,oR[2]=oI.z,t.transformVector(oD,oI),oR[3]=oI.x,oR[4]=oI.y,oR[5]=oI.z,oR}addLightData(e,t){let s=2===e._type,i=e.atlasViewportAllocated,n=this.cookiesEnabled&&!!e._cookie&&i,r=this.areaLightsEnabled&&0!==e.shape,a=this.shadowsEnabled&&e.castShadows&&i,o=e._node.getPosition(),l=null,h=null;s?a?l=e.getRenderData(null,0).shadowMatrix:n&&(l=oP.evalSpotCookieMatrix(e)):(a||n)&&(h=e.atlasViewport);let d=this.lightsFloat,c=this.lightsUint,u=t*this.lightsTexture.width*4;d[u+4*oO.POSITION_RANGE+0]=o.x,d[u+4*oO.POSITION_RANGE+1]=o.y,d[u+4*oO.POSITION_RANGE+2]=o.z,d[u+4*oO.POSITION_RANGE+3]=e.attenuationEnd;let p=e.clusteredData;if(c[u+4*oO.COLOR_ANGLES_BIAS+0]=p[0],c[u+4*oO.COLOR_ANGLES_BIAS+1]=p[1],c[u+4*oO.COLOR_ANGLES_BIAS+2]=p[2],e.castShadows){let t=e.getRenderData(null,0),s=e._getUniformBiasValues(t),i=ed.float2Half(s.bias),n=ed.float2Half(s.normalBias);c[u+4*oO.COLOR_ANGLES_BIAS+3]=i|n<<16;}if(s&&(this.getSpotDirection(oI,e),d[u+4*oO.DIRECTION_FLAGS+0]=oI.x,d[u+4*oO.DIRECTION_FLAGS+1]=oI.y,d[u+4*oO.DIRECTION_FLAGS+2]=oI.z),c[u+4*oO.DIRECTION_FLAGS+3]=e.getClusteredFlags(a,n),l){let e=l.data;for(let t=0;t<16;t++)d[u+4*oO.PROJ_MAT_0+t]=e[t];}if(h&&(d[u+4*oO.ATLAS_VIEWPORT+0]=h.x,d[u+4*oO.ATLAS_VIEWPORT+1]=h.y,d[u+4*oO.ATLAS_VIEWPORT+2]=h.z/3),r){let t=this.getLightAreaSizes(e);d[u+4*oO.AREA_DATA_WIDTH+0]=t[0],d[u+4*oO.AREA_DATA_WIDTH+1]=t[1],d[u+4*oO.AREA_DATA_WIDTH+2]=t[2],d[u+4*oO.AREA_DATA_HEIGHT+0]=t[3],d[u+4*oO.AREA_DATA_HEIGHT+1]=t[4],d[u+4*oO.AREA_DATA_HEIGHT+2]=t[5];}}constructor(e){this.areaLightsEnabled=false,this.device=e,this.cookiesEnabled=false,this.shadowsEnabled=false,this.areaLightsEnabled=false,this.maxLights=255;let t=oO.COUNT;this.lightsFloat=new Float32Array(4*t*this.maxLights),this.lightsUint=new Uint32Array(this.lightsFloat.buffer),this.lightsTexture=this.createTexture(this.device,t,this.maxLights,14,"LightsTexture"),this._lightsTextureId=this.device.scope.resolve("lightsTexture"),this.invMaxColorValue=0,this.invMaxAttenuation=0,this.boundsMin=new eu,this.boundsDelta=new eu;}}let oB=new eu,oU=new eu,ok=new eu,oz=new eP;class oV{constructor(){this.light=null,this.min=new eu,this.max=new eu;}}class oG{set maxCellLightCount(e){e!==this._maxCellLightCount&&(this._maxCellLightCount=e,this._cellsDirty=true);}get maxCellLightCount(){return this._maxCellLightCount}set cells(e){oB.copy(e).floor(),this._cells.equals(oB)||(this._cells.copy(oB),this._cellsLimit.copy(oB).sub(eu.ONE),this._cellsDirty=true);}get cells(){return this._cells}destroy(){this.lightsBuffer.destroy(),this.releaseClusterTexture();}releaseClusterTexture(){this.clusterTexture&&(this.clusterTexture.destroy(),this.clusterTexture=null);}registerUniforms(e){this._clusterSkipId=e.scope.resolve("clusterSkip"),this._clusterMaxCellsId=e.scope.resolve("clusterMaxCells"),this._clusterWorldTextureId=e.scope.resolve("clusterWorldTexture"),this._clusterTextureSizeId=e.scope.resolve("clusterTextureSize"),this._clusterTextureSizeData=new Float32Array(3),this._clusterBoundsMinId=e.scope.resolve("clusterBoundsMin"),this._clusterBoundsMinData=new Float32Array(3),this._clusterBoundsDeltaId=e.scope.resolve("clusterBoundsDelta"),this._clusterBoundsDeltaData=new Float32Array(3),this._clusterCellsCountByBoundsSizeId=e.scope.resolve("clusterCellsCountByBoundsSize"),this._clusterCellsCountByBoundsSizeData=new Float32Array(3),this._clusterCellsDotId=e.scope.resolve("clusterCellsDot"),this._clusterCellsDotData=new Float32Array(3),this._clusterCellsMaxId=e.scope.resolve("clusterCellsMax"),this._clusterCellsMaxData=new Float32Array(3);}updateParams(e){e&&(this.cells=e.cells,this.maxCellLightCount=e.maxLightsPerCell,this.lightsBuffer.cookiesEnabled=e.cookiesEnabled,this.lightsBuffer.shadowsEnabled=e.shadowsEnabled,this.lightsBuffer.areaLightsEnabled=e.areaLightsEnabled);}updateCells(){if(this._cellsDirty){this._cellsDirty=false;let e=this._cells.x,t=this._cells.y,s=this._cells.z,i=e*t*s,n=this.maxCellLightCount*i,r=Math.ceil(Math.sqrt(n)),a=Math.ceil(n/(r=ei.roundUp(r,this.maxCellLightCount)));this._clusterCellsMaxData[0]=e,this._clusterCellsMaxData[1]=t,this._clusterCellsMaxData[2]=s,this._clusterCellsDotData[0]=this.maxCellLightCount,this._clusterCellsDotData[1]=e*s*this.maxCellLightCount,this._clusterCellsDotData[2]=e*this.maxCellLightCount,this.clusters=new Uint8ClampedArray(n),this.counts=new Int32Array(i),this._clusterTextureSizeData[0]=r,this._clusterTextureSizeData[1]=1/r,this._clusterTextureSizeData[2]=1/a,this.releaseClusterTexture(),this.clusterTexture=this.lightsBuffer.createTexture(this.device,r,a,52,"ClusterTexture");}}uploadTextures(){this.clusterTexture.lock().set(this.clusters),this.clusterTexture.unlock(),this.lightsBuffer.uploadTextures();}updateUniforms(){this._clusterSkipId.setValue(this._usedLights.length>1?0:1),this.lightsBuffer.updateUniforms(),this._clusterWorldTextureId.setValue(this.clusterTexture),this._clusterMaxCellsId.setValue(this.maxCellLightCount);let e=this.boundsDelta;this._clusterCellsCountByBoundsSizeData[0]=this._cells.x/e.x,this._clusterCellsCountByBoundsSizeData[1]=this._cells.y/e.y,this._clusterCellsCountByBoundsSizeData[2]=this._cells.z/e.z,this._clusterCellsCountByBoundsSizeId.setValue(this._clusterCellsCountByBoundsSizeData),this._clusterBoundsMinData[0]=this.boundsMin.x,this._clusterBoundsMinData[1]=this.boundsMin.y,this._clusterBoundsMinData[2]=this.boundsMin.z,this._clusterBoundsDeltaData[0]=e.x,this._clusterBoundsDeltaData[1]=e.y,this._clusterBoundsDeltaData[2]=e.z,this._clusterTextureSizeId.setValue(this._clusterTextureSizeData),this._clusterBoundsMinId.setValue(this._clusterBoundsMinData),this._clusterBoundsDeltaId.setValue(this._clusterBoundsDeltaData),this._clusterCellsDotId.setValue(this._clusterCellsDotData),this._clusterCellsMaxId.setValue(this._clusterCellsMaxData);}evalLightCellMinMax(e,t,s){t.copy(e.min),t.sub(this.boundsMin),t.div(this.boundsDelta),t.mul2(t,this.cells),t.floor(),s.copy(e.max),s.sub(this.boundsMin),s.div(this.boundsDelta),s.mul2(s,this.cells),s.ceil(),t.max(eu.ZERO),s.min(this._cellsLimit);}collectLights(e){let t=this.lightsBuffer.maxLights,s=this._usedLights,i=1;e.forEach(e=>{let n=!!(3&e.mask),r=2===e.type&&0===e._outerConeAngle;if(e.enabled&&0!==e.type&&e.visibleThisFrame&&e.intensity>0&&n&&!r&&i<t){let t;i<s.length?t=s[i]:(t=new oV,s.push(t)),t.light=e,e.getBoundingBox(oz),t.min.copy(oz.getMin()),t.max.copy(oz.getMax()),i++;}}),s.length=i;}evaluateBounds(){let e=this._usedLights,t=this.boundsMin,s=this.boundsMax;if(e.length>1){t.copy(e[1].min),s.copy(e[1].max);for(let i=2;i<e.length;i++)t.min(e[i].min),s.max(e[i].max);}else t.set(0,0,0),s.set(1,1,1);this.boundsDelta.sub2(s,t),this.lightsBuffer.setBounds(t,this.boundsDelta);}updateClusters(e){this.counts.fill(0),this.clusters.fill(0),this.lightsBuffer.areaLightsEnabled=!!e&&e.areaLightsEnabled;let t=this._cells.x,s=this._cells.z,i=this.counts,n=this._maxCellLightCount,r=this.clusters,a=this.maxCellLightCount,o=this._usedLights;for(let e=1;e<o.length;e++){let l=o[e],h=l.light;this.lightsBuffer.addLightData(h,e),this.evalLightCellMinMax(l,oU,ok);let d=oU.x,c=ok.x,u=oU.y,p=ok.y,f=oU.z,m=ok.z;for(let o=d;o<=c;o++)for(let l=f;l<=m;l++)for(let h=u;h<=p;h++){let d=o+t*(l+h*s),c=i[d];c<n&&(r[a*d+c]=e,i[d]=c+1);}}}update(e,t){ void 0===t&&(t=null),this.updateParams(t),this.updateCells(),this.collectLights(e),this.evaluateBounds(),this.updateClusters(t),this.uploadTextures();}activate(){this.updateUniforms();}constructor(e){this.device=e,this.name="Untitled",this.reportCount=0,this.boundsMin=new eu,this.boundsMax=new eu,this.boundsDelta=new eu,this._cells=new eu(1,1,1),this._cellsLimit=new eu,this.cells=this._cells,this.maxCellLightCount=4,this._usedLights=[],this._usedLights.push(new oV),this.lightsBuffer=new oN(e),this.registerUniforms(e);}}let oH=null,oW=()=>{if(!oH){let e=atob("muPIHORMLNDCz4DxVR/ZvYfAUVEFR47KRIC4nwAAAAAP7WxlhD6Ci+2HCe7BF8jRAPZwdH2UPpI5PdLCJdkvG4UTaNDJ/0crAzne71GCrb4kbdMjjCEGzdX6fNxDMLJq5xkeoIVTdfiZkodEeArmZmp/FQzFjD4x8iOW7Dg64n+3mWqyEwLxXT8zoJXfbw8QJKDCaarUYyTlMzNFHbgUe9IQV7g4YOgtSKpIFZJ0qERm7u4PpmiF89ktHWCywaGmD6h+hfh2/Zd8KYlKqqo4Cem4T42bT/Z9FpCQF1hhSjfBzZ5XFn/y3jegWC6u86KuELRundQS/1Rp+XuKKGIgRv3CvP5y749yqLlFO495JOT3+f2CXgd71npU0/KjjpkZucbJ5m78IVyuSrSozc9jgBUhDrz0hFsyb7LFUH9//wJbBgLdNWJZObfKxrNt8TliLA9w9sXFv6g26iXpf6r/BqcAusj/QzGBZuoUGeEtw8BCXCZ3jUiw4hvM18ZVqlUD3C40LAFXW6FRjuAZGRNstb0/qVk4skwyT+MHrvRorI4rKHVMWZmKyAkzL/78u/9pMQuX14pZN50b2PHn6fRxeaCQLsfT4dpvIkWWFuFVENZIh+8xgR6lU+85W0PPdAu1j99kcCG40JBQa4JMyRzq6qriOBLtqF87vpCJan0WEduVr/mOYkS00urVA0mA6M3031+GmGmW48PaJDYOEIb3bIXWPaLoAOEinX1TN3+/vwhG6nqJu0TdHpedS7QsGZIoxH3nQYYjQP1jmbahlbNngw5ogsGk1y50XZyUmQBY+/JBJ3Unu4dApm+WmPwHPU9gLb+4mHh4BiY6M86pq+WeTyWdI3s0CXPEtHGXZ8zMZgUoyRomBi1VdazzuN+WOmQ9Pa0Z0tlNopUi8AJ4x2Xn4mmOKEbXLxlbVsWu8XhuDGYFOGCRVdSqDPXrHU5SDdUlti3k5///SBwzTMwK3L4a1H7w4lnpEas6////AfX8asyIBfeFXVJ3tgvxQ/blZuUKyIODIfr/UzdWNu7pciLBpdZRZ4pIfZ1R6szq+XNxkGG///8EZFpu7VHAhFWqHEOrB9unw+YQa5o8/9IR/V5/zq+986rJSyfgJKt2u9hxU1wzyQWPjJGvzG9+eWWxGFOHVKqI4jBQALwZZswesnvZ2UmmkEXdiRpz8B+oWE7PY70ZTMndisYSXg2TqoI+3y9BxbnY2Y4EfbdcRhAvG59NqDENNYbxKvK5HJfPG5M+Wi2AcpLVJrD6caiEOzgSoVNSgQK8fm2M3zGcF4xtClv/8Hs9oD7C3jitTATYNQxmKqKf1LhIxzf1bmfiNn7UKFmcJu4sLqVLwxGSue3taBEyknkw5hXTsUCvqmmL/f8n/w0giR7Hu/9EHvpkz3yuu64TioMkzdTJ30i0+hFnQqW1+v9mMwq+z9qGX0UFu9MomvVG2xod6vc12AAAAACq7sGa5qptFR0jF3nQt/D+7PibKYahaxP3hEixPbGi9nwNf2LAa7LkEZRKxzXeCD64Xpii5n+8Kpg8eHIv7AWXZltgMoGltmoJ0XGdOCL8WkzphvR9N2o3ARSZ42l5e5Pe4B58MCRlP3EKv+mcloknH+fto5BWsmEutW6KvjOVsznFCktkSczVk4aGvj9VXlRcLeDoKG8RkBgdcNG2bf8HUL4MT2DM+ar7NImJhKpxakX4Vk0CnP+/XNhl5UsP0lXgeZXPoDBMSW5An+DXlTCO5FQGwSPYwHLKYVIimEdAoVe49rQLaaNcye5LxU2/c5TijTgJtD5eQQIe1snxauj5jZsxJBUJdoP/zqpjqv8qBruoPsVsP8N44PCUW5Dd0DzqjSS/Dl5mI9cn1w2ndN/0KAEm1QAAAACwu6KM/083IBbH5bPa/9oHUwcU8I9v3j6/v18QYammrf+P6VL///8BrpuM3fOLCxaLNOFNF1zPbPYTP65ni6njft4eVcyrVXRQFrs52tr35StiSp55edVDCBC0H5rIfac6nzUwxQSt7y15QoKb+5zebEQUmVbrPjXuUa19Ey7sqXMiSUKHaw72PJKDdrutJoQr3u6lEYJ8K0MakWKj9zjTFi4X94TsKYco0GrLeB60M6D8M/80rhXUW8iMequg8y5F838WI0+gp3GBN5Kj/xIOxTWQuUaPV/LwvARr1VH93BFgGZR1MFW0Ua30GbYmdnAgo9VWy8SQtpDUgGE2r2zq2eTEMCL7sMKmE1hchVhuF/TCq9iXKEm86kzOf3Rp9ZnCxbpDUj+FKNxVyXe6pVZkRXv/m95SnB/EB8aME29N85MtAcDoXWlor8De2Q5Dg1tar+8wgiZufbMam81j//ASUohoR/zSh2KG4bvT6mkIPz6C5/98DC3LaWlaEZ1zA5JORZRu6J/a0GY285sEYzw71YqOT1ihAG0z5SDt1xNiDQWZdFpndArp6xWhqSDkRb4kSJEHb9liPvw7uLV/6i5MVf//A9Qjr8xkAEUh+KDI+zdtJ68d6MBOktg1iyp/SCq8O9f5pbamn1VVVQPRTWqNBvhQKa07s6P0lc9Luu/3gw4HeyOUfz8MxMwV4UQhua+t9cr4bz/nIB2wnDSK1K7I94M+s6C84htaX/CNlMQUSs2KJO+yaebfTbkNX5yWcqEJevo0vbKUiETuFXiL019A3E+lmsyZMwXrXLLiQAZ5t9+jI3JobhJTMiDH5ZOQ+8Jau5555NMjHSscP9qCVaa40doh+1a3Ukf6jqBmLddgh79/fwTfCyqiuldNkUoy+nUp+4nerwg0OjtGv2x485PJOJvUEokNhYIdWjpx7BWk0VZGWOp3jSFTJ2bnu6KCduZtG/UcBC9RZ3W/jMSfSMw4Etr/DoD/XYP2V5Ovw+YoM3F5g2dGLdvuG6ZkVGLE6Dk5Zr+sdSyGliJP1y2OFf/KFO0RWO+3gsGhesTnfZVpTd8/HwgO216gwaqo+vY3TljfJWowY+i0p0Os4SLn/1wLqDHMlszggmT/D8MRFzs+pLv6LNJSsNZ/r41mWi/rF6ZcKp/yzJdK0VU44hskq3RGpgO6mIpJDsf/mZkFrz0yYOMLbuaj/wp1v7JMFM5eqvBhmTd7U8frQAtHtys4zgpjZmzUhOVTfNNLifElGXADlqHGKrkBT/nYwX8ZRm3RjvyPvjKyEqEGKUpVnvOGx+NKPHiWM//ZDpDVGvvrjmk8RPF/wiYZD3+Us8YCXjrVOfjdd1UPAfjLp8jgSn4me7DPTpz1Ggy9XL80guFO7ECT10AvILKfD18Qx+KY/f8aRqu0oOO8hfKRFZa9PUJwCsp6VdZz6LFkm2b9Pl2LIifCwzRy7TpdG2uAtOxP2OemY26bJMa9ZGSLIRlMsgpDpnDJwd0oa5pQ13x1hrHf52HpulUWonGWsfXZbSQYKu9bnEN76ciQih0opN3deDVrbrxorfVlnCmL1R9zq3ePGWIv21c7pW8kEiFTM5JX8dAw867s/60cf79/BH+MDFCZBHlz1L+qGOJf/1txhhmrf3//As+RIJwevDb+fgNXVeHw67QptZegayhrEwr5Gy+EPo1RLaMtPbqOZYoVzXzwzjMFWZxyUG9YUIf6////AQWy84iAygLk9COtXt92+0mT/xg0zMzMBeLkb8y9SL2TDXgSX422hDgpGNLJyuPioA+YJ91G8znrpNqHkwYyscaJDEc9Vc+j4cXle3hvcd2JqDQH2lBZxDn6mUTs0b75raMvbs727codX01Anj8f3wir9P2xQaQ22v/TxCMglKDFoTjaP01XTLgxnTvPv02JgEUrW6UDgOnobFpLdvKdlypgIzPcq14fgXU5tvVW0FEs7VRlsG1IyA69fN4n+awHhT34cE+xUvdj86C8LgAsFheTjI9Ht9EyYAAAAAAVBVKRx2wLgUTI0/2QfyJo2riRw3JDqzEShmx/Lifo6mRkQVbS7X53t+EvKxcXogtdts31e9MRHdcHgsA8rt4/mt2unlzQ/wsU8Gu7+W6Oj7eD8EQdDp5XlCsVaS/AV/t5ZpPOHR3rGpyAJe9IPV+xMrBL1Oz/8MQhFs31h0N1cVnq371uqIJYHyafKH1jteAK3VpMXBcuC+yt0ZeKyRUY4QhdrJJ4tJ1wg3Hu6kDsbovxupTMkGdRrm8oZSoYPbJ+PwH/xotgTdkA1205vUEfnqkI04T/fnnd1fiZW5AwNcggd7fi4j5zasmcntZexIxqFZQMzMJpfndmI5jn17cgn5EV5t9XN0C///8Q9wlJpMGXdoiaMTG2sVyHQsn8mWRISCLNG777S0OuDRP2GlLcJ2UeOg7Fo8hTNPeJ//iTJhyqxhKRUntdXOihq2wfKfH///8B0GGrwT+fSOQRdctKxjjGCSS11d6BlQ9BDfE0J6Z25FaNTKGpFKNCMr2G/041KpWwBLVe1k08vncseQbKZdXi8x1t9XA45U/Wd43D9wAh3Tal0aiLVzGPusOZ1F+W3TWoqlX/A95+dNef11TsuGful+ctGssldk3fqpfqh+43XTxL42+leSHoF/dWHYGX6maqUEuLX7UB+r/6Llr4LKocbVIeu+hB9QTPfz9fCP8RyWmX4SmbhMFsNtCijV7lVcwejLKlvl0GfCndnWV7/39VBrtTRuUx92oke3GBgKkC5fdGK0YvNK+xenKaDmsHDjNFUM3NMz3ZiXXFuLgojosPVCDEl2W5BjX3Ms+j0GSqACHmh0+RPWyuNm/Qe8vFf9AW7N1uRaxWirrUytqEJnJ4/Flm8hSoiZ2NQBsS6w/yQlC4gCaFo8q4nyY6AFdo4hiwhBXzbNKKvZvktCjSCukRR/BbYVbNwZi2Yh3hGodEacLW8qijiWJODf0P2bhfaiPspPT4lYJBgi/KfcFwCfvyUIgkJOv///8CG/JEepRBLaMFE+2TgrqsJXOVOWHt6g/bFwVLLMVBsMR50dis/39/AlBX+/rMTJkUQrnlxpR2iu0Tp8tATkRYGmDIrcAiRP8PjoWIlb7/0ecTdSCE9Y58+a+n/FovJQTVF4F2jAxMZhTgrM/KVS5BQu6bVbkWY5HXnxRshks3urDdW4RkWp4M4TeLmFK5KF/uHkkiO5Kv96RioH984v/CSDBnG+BwlnU9B+o7Y+0X0Nob+0pLsStxjvPXMy2eCpzhOWV4XbObBHN4UE2sLQ/DIqXhOzxVf38GlTi6aG7EnePO7TRJm9yOfUUcqq1I2iQHrVDqn3TUNRi/lMw8KbMW/3/nqCz/Ef8PoW5Qxcz2yHR/f78EPB2Stbd+ZFmfNTUYILzsb9YNhpaHcaymYrBiNHmFE3Y4ccYJ25Prqm7zHobGHED8/93ZNlWro9vcKivGZs31UiK1k5zjUhexUgbqJb+fUTjxce/7Zly8a5KMC1fX5nfjPgibdvzbXV1jRT2asXvmSAusaLdq1TSIJ8fXINk5AtT34EWPAsfP9IFQqM5K11O6saoHJA==");oH=Uint8Array.from(e,e=>e.charCodeAt(0));}},oX=()=>(oW(),oH);class oY{_next(){this.seed=(this.seed+4)%oH.length;}value(){return this._next(),oH[this.seed]/255}vec4(e){return void 0===e&&(e=new em),this._next(),e.set(oH[this.seed],oH[this.seed+1],oH[this.seed+2],oH[this.seed+3]).mulScalar(1/255)}constructor(e=0){this.seed=0,this.seed=4*e,oW();}}let oj=[new eu(-1,0,0),new eu(1,0,0),new eu(0,-1,0),new eu(0,1,0),new eu(0,0,-1),new eu(0,0,1)];class oq{update(e,t){let s=this.colors,{r:i,g:n,b:r}=e;for(let e=0;e<6;e++)s[3*e]=i,s[3*e+1]=n,s[3*e+2]=r;for(let e=0;e<t.length;e++){let i=t[e];if(0===i._type)for(let e=0;e<6;e++){let t=Math.max(oj[e].dot(i._direction),0)*i._intensity,n=i._color;s[3*e]+=n.r*t,s[3*e+1]+=n.g*t,s[3*e+2]+=n.b*t;}}}constructor(){this.colors=new Float32Array(18);}}let oK=(e,t,s,i)=>{let n=new se(e,{name:""+t+s,width:s,height:s,format:7,addressU:0,addressV:0,type:tb,magFilter:0,minFilter:0,anisotropy:1,mipmaps:false});return n.lock().set(i),n.unlock(),n},oZ=new t8,oQ=e=>oZ.get(e,()=>{let t=oX();return oK(e,"BlueNoise",Math.sqrt(t.length/4),t)});class oJ{destroy(){this.texture&&(this.texture.destroy(),this.texture=null);let e=this.renderTargets;for(let t=0;t<e.length;t++)e[t].destroy();this.renderTargets.length=0;}static create(e,t){return 1===t._type?this.createCubemap(e,t._shadowResolution,t._shadowType):this.create2dMap(e,t._shadowResolution,t._shadowType)}static createAtlas(e,t,s){let i=this.create2dMap(e,t,s),n=i.renderTargets,r=n[0];for(let e=0;e<5;e++)n.push(r);return i}static create2dMap(e,t,s){var i;let n=rK.get(s),r=n.format;15===r&&!e.textureFloatRenderable&&e.textureHalfFloatRenderable&&(r=50);let a=null==(i=eq.get(r))?void 0:i.name,o=1;3===s&&(o=+!!e.extTextureFloatLinear),6===s&&(o=0);let l=new se(e,{format:r,width:t,height:t,mipmaps:false,minFilter:o,magFilter:o,addressU:1,addressV:1,name:"ShadowMap2D_"+a}),h=null;return (null==n?void 0:n.pcf)?(l.compareOnRead=true,l.compareFunc=1,h=new sR({depthBuffer:l})):h=new sR({colorBuffer:l,depth:true}),e.isWebGPU&&(h.flipY=true),new oJ(l,[h])}static createCubemap(e,t,s){var i;let n=rK.get(s),r=null==(i=eq.get(n.format))?void 0:i.name,a=6===s,o=+!a,l=new se(e,{format:null==n?void 0:n.format,width:t,height:t,cubemap:true,mipmaps:false,minFilter:o,magFilter:o,addressU:1,addressV:1,name:"ShadowMapCube_"+r});a||(l.compareOnRead=true,l.compareFunc=1);let h=[];for(let e=0;e<6;e++)a?h.push(new sR({colorBuffer:l,face:e,depth:true})):h.push(new sR({depthBuffer:l,face:e}));return new oJ(l,h)}constructor(e,t){this.texture=e,this.cached=false,this.renderTargets=t;}}let o$=[],o0=[],o1=new em,o2=new em;class o3{constructor(e){this.size=Math.floor(1024*e.w),this.used=false,this.lightId=-1,this.rect=e;}}class o4{destroy(){this.destroyShadowAtlas(),this.destroyCookieAtlas();}destroyShadowAtlas(){var e;null==(e=this.shadowAtlas)||e.destroy(),this.shadowAtlas=null;}destroyCookieAtlas(){var e,t;null==(e=this.cookieAtlas)||e.destroy(),this.cookieAtlas=null,null==(t=this.cookieRenderTarget)||t.destroy(),this.cookieRenderTarget=null;}allocateShadowAtlas(e,t){var s;void 0===t&&(t=0);let i=null==(s=this.shadowAtlas)?void 0:s.texture.format,n=rK.get(t).format;if(!this.shadowAtlas||this.shadowAtlas.texture.width!==e||i!==n){this.version++,this.destroyShadowAtlas(),this.shadowAtlas=oJ.createAtlas(this.device,e,t),this.shadowAtlas.cached=true;let s=4/this.shadowAtlasResolution;this.scissorVec.set(s,s,-2*s,-2*s);}}allocateCookieAtlas(e){this.cookieAtlas.width!==e&&(this.cookieRenderTarget.resize(e,e),this.version++);}allocateUniforms(){this._shadowAtlasTextureId=this.device.scope.resolve("shadowAtlasTexture"),this._shadowAtlasParamsId=this.device.scope.resolve("shadowAtlasParams"),this._shadowAtlasParams=new Float32Array(2),this._cookieAtlasTextureId=this.device.scope.resolve("cookieAtlasTexture");}updateUniforms(){let e=this.shadowAtlas.renderTargets[0].depthBuffer;this._shadowAtlasTextureId.setValue(e),this._shadowAtlasParams[0]=this.shadowAtlasResolution,this._shadowAtlasParams[1]=this.shadowEdgePixels,this._shadowAtlasParamsId.setValue(this._shadowAtlasParams),this._cookieAtlasTextureId.setValue(this.cookieAtlas);}subdivide(e,t){let s,i,n=t.atlasSplit;if(!n){let t=Math.ceil(Math.sqrt(e));(n=o0)[0]=t,n.length=1;}if(s=n,i=this.atlasSplit,!(s.length===i.length&&s.every((e,t)=>e===i[t]))){this.version++,this.slots.length=0,this.atlasSplit.length=0,this.atlasSplit.push(...n);let e=this.atlasSplit[0];if(e>1){let t=1/e;for(let s=0;s<e;s++)for(let i=0;i<e;i++){let n=new em(s*t,i*t,t,t),r=this.atlasSplit[1+s*e+i];if(r>1)for(let e=0;e<r;e++)for(let s=0;s<r;s++){let i=t/r,a=new em(n.x+e*i,n.y+s*i,i,i);this.slots.push(new o3(a));}else this.slots.push(new o3(n));}}else this.slots.push(new o3(new em(0,0,1,1)));this.slots.sort((e,t)=>t.size-e.size);}}collectLights(e,t){let s=t.cookiesEnabled,i=t.shadowsEnabled,n=false,r=false;return o$.length=0,(s||i)&&(e=>{for(let t=0;t<e.length;t++){let a=e[t];if(a.visibleThisFrame){let e=i&&a.castShadows,t=s&&!!a.cookie;n||(n=e),r||(r=t),(e||t)&&o$.push(a);}}})(e),o$.sort((e,t)=>t.maxScreenSize-e.maxScreenSize),n&&this.allocateShadowAtlas(this.shadowAtlasResolution,t.shadowType),r&&this.allocateCookieAtlas(this.cookieAtlasResolution),(n||r)&&this.subdivide(o$.length,t),o$}setupSlot(e,t){e.atlasViewport.copy(t);let s=e.numShadowFaces;for(let i=0;i<s;i++)if(e.castShadows||e._cookie){if(o1.copy(t),o2.copy(t),2===e._type&&o1.add(this.scissorVec),1===e._type){let e=o1.z/3,t=this.cubeSlotsOffsets[i];o1.x+=e*t.x,o1.y+=e*t.y,o1.z=e,o1.w=e,o2.copy(o1);}if(e.castShadows){let t=e.getRenderData(null,i);t.shadowViewport.copy(o1),t.shadowScissor.copy(o2);}}}assignSlot(e,t,s){e.atlasViewportAllocated=true;let i=this.slots[t];i.lightId=e.id,i.used=true,s&&(e.atlasSlotUpdated=true,e.atlasVersion=this.version,e.atlasSlotIndex=t);}update(e,t){this.shadowAtlasResolution=t.shadowAtlasResolution,this.cookieAtlasResolution=t.cookieAtlasResolution;let s=this.collectLights(e,t);if(s.length>0){let e=this.slots;for(let t=0;t<e.length;t++)e[t].used=false;let t=Math.min(s.length,e.length);for(let i=0;i<t;i++){let t=s[i];t.castShadows&&(t._shadowMap=this.shadowAtlas);let n=e[t.atlasSlotIndex];if(t.atlasVersion===this.version&&t.id===(null==n?void 0:n.lightId)){let s=e[t.atlasSlotIndex];s.size!==e[i].size||s.used||this.assignSlot(t,t.atlasSlotIndex,false);}}let i=0;for(let n=0;n<t;n++){for(;i<e.length&&e[i].used;)i++;let t=s[n];t.atlasViewportAllocated||this.assignSlot(t,i,true);let r=e[t.atlasSlotIndex];this.setupSlot(t,r.rect);}}this.updateUniforms();}constructor(e){this.device=e,this.version=1,this.shadowAtlasResolution=2048,this.shadowAtlas=null,this.shadowEdgePixels=3,this.cookieAtlasResolution=4,this.cookieAtlas=new se(this.device,{name:"CookieAtlas",width:this.cookieAtlasResolution,height:this.cookieAtlasResolution,format:20,cubemap:false,mipmaps:false,minFilter:0,magFilter:0,addressU:1,addressV:1}),this.cookieRenderTarget=new sR({colorBuffer:this.cookieAtlas,depth:false,flipY:true}),this.slots=[],this.atlasSplit=[],this.cubeSlotsOffsets=[new ef(0,0),new ef(0,1),new ef(1,0),new ef(1,1),new ef(2,0),new ef(2,1)],this.scissorVec=new em,this.allocateShadowAtlas(1),this.allocateCookieAtlas(1),this.allocateUniforms();}}let o5=[];o5[0]={src:1,dst:1,op:2},o5[3]={src:1,dst:0,op:0},o5[2]={src:6,dst:8,op:0,alphaSrc:1},o5[4]={src:1,dst:8,op:0},o5[1]={src:1,dst:1,op:0},o5[6]={src:6,dst:1,op:0},o5[7]={src:4,dst:2,op:0},o5[8]={src:5,dst:1,op:0},o5[5]={src:4,dst:0,op:0},o5[9]={src:1,dst:1,op:3},o5[10]={src:1,dst:1,op:4};let o6=0;class o8{set chunks(e){this._dirtyShader=true,this._chunks=e;}get chunks(){return this._dirtyShader=true,this._chunks}set depthBias(e){this._depthState.depthBias=e;}get depthBias(){return this._depthState.depthBias}set slopeDepthBias(e){this._depthState.depthBiasSlope=e;}get slopeDepthBias(){return this._depthState.depthBiasSlope}set redWrite(e){this._blendState.redWrite=e;}get redWrite(){return this._blendState.redWrite}set greenWrite(e){this._blendState.greenWrite=e;}get greenWrite(){return this._blendState.greenWrite}set blueWrite(e){this._blendState.blueWrite=e;}get blueWrite(){return this._blendState.blueWrite}set alphaWrite(e){this._blendState.alphaWrite=e;}get alphaWrite(){return this._blendState.alphaWrite}get transparent(){return this._blendState.blend}_updateTransparency(){let e=this.transparent,t=this.meshInstances;for(let s=0;s<t.length;s++)t[s].transparent=e;}set blendState(e){this._blendState.copy(e),this._updateTransparency();}get blendState(){return this._blendState}set blendType(e){var t,s,i;let n=o5[e];this._blendState.setColorBlend(n.op,n.src,n.dst),this._blendState.setAlphaBlend(null!=(t=n.alphaOp)?t:n.op,null!=(s=n.alphaSrc)?s:n.src,null!=(i=n.alphaDst)?i:n.dst);let r=3!==e;this._blendState.blend!==r&&(this._blendState.blend=r,this._updateTransparency()),this._updateMeshInstanceKeys();}get blendType(){if(!this.transparent)return 3;let{colorOp:e,colorSrcFactor:t,colorDstFactor:s,alphaOp:i,alphaSrcFactor:n,alphaDstFactor:r}=this._blendState;for(let a=0;a<o5.length;a++){let o=o5[a];if(o.src===t&&o.dst===s&&o.op===e&&o.src===n&&o.dst===r&&o.op===i)return a}return 2}set depthState(e){this._depthState.copy(e);}get depthState(){return this._depthState}set depthTest(e){this._depthState.test=e;}get depthTest(){return this._depthState.test}set depthFunc(e){this._depthState.func=e;}get depthFunc(){return this._depthState.func}set depthWrite(e){this._depthState.write=e;}get depthWrite(){return this._depthState.write}copy(e){var t;for(let s in this.name=e.name,this.alphaTest=e.alphaTest,this.alphaToCoverage=e.alphaToCoverage,this._blendState.copy(e._blendState),this._depthState.copy(e._depthState),this.cull=e.cull,this.stencilFront=null==(t=e.stencilFront)?void 0:t.clone(),e.stencilBack&&(this.stencilBack=e.stencilFront===e.stencilBack?this.stencilFront:e.stencilBack.clone()),this.clearParameters(),e.parameters)e.parameters.hasOwnProperty(s)&&this._setParameterSimple(s,e.parameters[s].data);this.defines.clear(),e.defines.forEach((e,t)=>this.defines.set(t,e));let s=e._chunks;for(let e in s)s.hasOwnProperty(e)&&(this._chunks[e]=s[e]);return this}clone(){return new this.constructor().copy(this)}_updateMeshInstanceKeys(){let e=this.meshInstances;for(let t=0;t<e.length;t++)e[t].updateKey();}updateUniforms(e,t){this._dirtyShader&&this.clearVariants();}getShaderVariant(e){}update(){this._definesDirty&&(this._definesDirty=false,this.clearVariants()),this.dirty=true;}clearParameters(){this.parameters={};}getParameters(){return this.parameters}clearVariants(){this.variants.clear();let e=this.meshInstances,t=e.length;for(let s=0;s<t;s++)e[s].clearShaders();}getParameter(e){return this.parameters[e]}_setParameterSimple(e,t){let s=this.parameters[e];s?s.data=t:this.parameters[e]={scopeId:null,data:t};}setParameter(e,t){if(void 0===t&&"object"==typeof e){let s=e;if(s.length){for(let e=0;e<s.length;e++)this.setParameter(s[e]);return}e=s.name,t=s.value;}this._setParameterSimple(e,t);}deleteParameter(e){this.parameters[e]&&delete this.parameters[e];}setParameters(e,t){let s=this.parameters;for(let i in void 0===t&&(t=s),t){let t=s[i];t&&(t.scopeId||(t.scopeId=e.scope.resolve(i)),t.scopeId.setValue(t.data));}}setDefine(e,t){let s=false,{defines:i}=this;void 0!==t&&false!==t?(s=!i.has(e)||i.get(e)!==t,i.set(e,t)):(s=i.has(e),i.delete(e)),this._definesDirty||(this._definesDirty=s);}getDefine(e){return this.defines.has(e)}destroy(){this.variants.clear();for(let e=0;e<this.meshInstances.length;e++){let t=this.meshInstances[e];if(t.clearShaders(),t._material=null,t.mesh){let e=aW(t.mesh.device);this!==e&&(t.material=e);}}this.meshInstances.length=0;}addMeshInstanceRef(e){this.meshInstances.push(e);}removeMeshInstanceRef(e){let t=this.meshInstances,s=t.indexOf(e);-1!==s&&t.splice(s,1);}constructor(){this.meshInstances=[],this.name="Untitled",this.userId="",this.id=o6++,this.variants=new Map,this.defines=new Map,this._definesDirty=false,this.parameters={},this.alphaTest=0,this.alphaToCoverage=false,this._blendState=new sh,this._depthState=new su,this.cull=1,this.stencilFront=null,this.stencilBack=null,this._chunks={},this._dirtyShader=true,this._shaderVersion=0,this._scene=null,this.dirty=true;}}class o9{destroy(){this.clear(),this.cache=null;}clear(){this.cache.forEach(e=>{e.forEach(e=>{e.destroy();});}),this.cache.clear();}getKey(e){let t=1===e._type;return t+"-"+e._shadowType+"-"+e._shadowResolution}get(e,t){let s=this.getKey(t),i=this.cache.get(s);if(i&&i.length)return i.pop();let n=oJ.create(e,t);return n.cached=true,n}add(e,t){let s=this.getKey(e),i=this.cache.get(s);i?i.push(t):this.cache.set(s,[t]);}constructor(){this.cache=new Map;}}class o7 extends nK{execute(){this.shadowRenderer.renderFace(this.light,null,this.face,false);}after(){this.applyVsm&&this.shadowRenderer.renderVsm(this.light,this.shadowCamera);}constructor(e,t,s,i,n){super(e),this.requiresCubemaps=false,this.shadowRenderer=t,this.light=s,this.face=i,this.applyVsm=n,this.shadowCamera=t.prepareFace(s,null,i),t.setupRenderPass(this,this.shadowCamera,true);}}class le{cull(e,t,s){ void 0===s&&(s=null);let i=this.renderer.scene.clusteredLightingEnabled;e.visibleThisFrame=true,i||e._shadowMap||(e._shadowMap=oJ.create(this.device,e));let n=e._type,r=2===n?1:6;for(let a=0;a<r;a++){let r=e.getRenderData(null,a),o=r.shadowCamera;o.nearClip=e.attenuationEnd/1e3,o.farClip=e.attenuationEnd;let l=o._node,h=e._node;l.setPosition(h.getPosition()),2===n?(o.fov=2*e._outerConeAngle,l.setRotation(h.getRotation()),l.rotateLocal(-90,0,0)):1===n&&(i?o.fov=Math.atan(1+2/(this.shadowRenderer.lightTextureAtlas.shadowAtlasResolution*e.atlasViewport.z/3)*this.shadowRenderer.lightTextureAtlas.shadowEdgePixels)*ei.RAD_TO_DEG*2:o.fov=90),this.renderer.updateCameraFrustum(o),this.shadowRenderer.cullShadowCasters(t,e,r.visibleCasters,o,s);}}prepareLights(e,t){let s;for(let i=0;i<t.length;i++){let n=t[i];if(this.shadowRenderer.needsShadowRendering(n)&&n.atlasViewportAllocated){e.push(n);for(let e=0;e<n.numShadowFaces;e++)s=this.shadowRenderer.prepareFace(n,null,e);}}return s}buildNonClusteredRenderPasses(e,t){for(let s=0;s<t.length;s++){let i=t[s];if(this.shadowRenderer.needsShadowRendering(i)){let t=2===i._type,s=i.numShadowFaces;for(let n=0;n<s;n++){let s=new o7(this.device,this.shadowRenderer,i,n,t);e.addRenderPass(s);}}}}constructor(e,t){this.shadowLights=[],this.renderer=e,this.shadowRenderer=t,this.device=e.device;}}class lt extends nK{execute(){let{light:e,camera:t,shadowRenderer:s,allCascadesRendering:i}=this,n=e.numShadowFaces,r=e.shadowUpdateOverrides;for(let a=0;a<n;a++)(null==r?void 0:r[a])!==0&&s.renderFace(e,t,a,!i),(null==r?void 0:r[a])===1&&(r[a]=0);}after(){this.shadowRenderer.renderVsm(this.light,this.camera);}constructor(e,t,s,i,n){super(e),this.shadowRenderer=t,this.light=s,this.camera=i,this.allCascadesRendering=n;}}let ls=new eP,li=new eu,ln=new ex,lr=[new eu,new eu,new eu,new eu,new eu,new eu,new eu,new eu],la={min:0,max:0};class lo{cull(e,t,s,i){ void 0===i&&(i=null),e.visibleThisFrame=true,e._shadowMap||(e._shadowMap=oJ.create(this.device,e));let n=s._nearClip;this.generateSplitDistances(e,n,Math.min(s._farClip,e.shadowDistance));let r=e.shadowUpdateOverrides;for(let a=0;a<e.numCascades&&(null==r?void 0:r[a])!==0;a++){let r=e.getRenderData(s,a),o=r.shadowCamera;o.renderTarget=e._shadowMap.renderTargets[0],r.shadowViewport.copy(e.cascades[a]),r.shadowScissor.copy(e.cascades[a]);let l=o._node,h=e._node;l.setPosition(h.getPosition()),l.setRotation(h.getRotation()),l.rotateLocal(-90,0,0);let d=0===a?n:e._shadowCascadeDistances[a-1],c=e._shadowCascadeDistances[a],u=s.getFrustumCorners(d,c);li.set(0,0,0);let p=s.node.getWorldTransform();for(let e=0;e<8;e++)p.transformPoint(u[e],u[e]),li.add(u[e]);li.mulScalar(1/8);let f=0;for(let e=0;e<8;e++){let t=u[e].sub(li).length();t>f&&(f=t);}let m=l.right,_=l.up,g=l.forward,v=.25*e._shadowResolution/f,y=Math.ceil(li.dot(_)*v)/v,S=Math.ceil(li.dot(m)*v)/v,x=_.mulScalar(y),T=m.mulScalar(S),b=li.dot(g),E=g.mulScalar(b);li.add2(x,T).add(E),l.setPosition(li),l.translateLocal(0,0,1e6),o.nearClip=.01,o.farClip=2e6,o.orthoHeight=f,this.renderer.updateCameraFrustum(o),this.shadowRenderer.cullShadowCasters(t,e,r.visibleCasters,o,i);let A=true,w=r.visibleCasters;for(let e=0;e<w.length;e++){let t=w[e];A?(A=false,ls.copy(t.aabb)):ls.add(t.aabb);}ln.copy(l.getWorldTransform()).invert();let C=function(e,t,s){lr[0].x=lr[1].x=lr[2].x=lr[3].x=t.x,lr[1].y=lr[3].y=lr[7].y=lr[5].y=t.y,lr[2].z=lr[3].z=lr[6].z=lr[7].z=t.z,lr[4].x=lr[5].x=lr[6].x=lr[7].x=s.x,lr[0].y=lr[2].y=lr[4].y=lr[6].y=s.y,lr[0].z=lr[1].z=lr[4].z=lr[5].z=s.z;let i=0x2540be3ff,n=-9999999999;for(let t=0;t<8;++t){e.transformPoint(lr[t],lr[t]);let s=lr[t].z;s<i&&(i=s),s>n&&(n=s);}return la.min=i,la.max=n,la}(ln,ls.getMin(),ls.getMax());l.translateLocal(0,0,C.max+.1),o.farClip=C.max-C.min+.2,r.projectionCompensation=f;}}generateSplitDistances(e,t,s){e._shadowCascadeDistances.fill(s);for(let i=1;i<e.numCascades;i++){let n=i/e.numCascades,r=t+(s-t)*n,a=t*(s/t)**n,o=ei.lerp(r,a,e.cascadeDistribution);e._shadowCascadeDistances[i-1]=o;}}getLightRenderPass(e,t){let s=null;if(this.shadowRenderer.needsShadowRendering(e)){let i;let n=e.numShadowFaces,r=e.shadowUpdateOverrides,a=true;for(let s=0;s<n;s++)(null==r?void 0:r[s])===0&&(a=false),i=this.shadowRenderer.prepareFace(e,t,s);s=new lt(this.device,this.shadowRenderer,e,t,a),this.shadowRenderer.setupRenderPass(s,i,a);}return s}constructor(e,t){this.renderer=e,this.shadowRenderer=t,this.device=e.device;}}let ll=new Set,lh=new ex,ld=new ex,lc=new Float32Array(2),lu=new em(1,1,0,0),lp=new ex;class lf{static createShadowCamera(e,t,s){var i,n;let r=oP.create("ShadowCamera",t,s),a=rK.get(e),o=null!=(i=null==a?void 0:a.vsm)&&i,l=null!=(n=null==a?void 0:a.pcf)&&n;return o?r.clearColor=new en(0,0,0,0):r.clearColor=new en(1,1,1,1),r.clearDepthBuffer=true,r.clearStencilBuffer=false,r.clearColorBuffer=!l,r}_cullShadowCastersInternal(e,t,s){let i=e.length;for(let n=0;n<i;n++){let i=e[n];i.castShadow&&(!i.cull||i._isVisible(s))&&(i.visibleThisFrame=true,t.push(i));}}cullShadowCasters(e,t,s,i,n){if(s.length=0,n)this._cullShadowCastersInternal(n,s,i);else {let n=e.layerList,r=n.length;for(let e=0;e<r;e++){let r=n[e];r._lightsSet.has(t)&&!ll.has(r)&&(ll.add(r),this._cullShadowCastersInternal(r.shadowCasters,s,i));}ll.clear();}s.sort(this.sortCompareShader);}sortCompareShader(e,t){let s=e._sortKeyShadow,i=t._sortKeyShadow;return s===i?t.mesh.id-e.mesh.id:i-s}setupRenderState(e,t){let s=this.renderer.scene.clusteredLightingEnabled?t._isPcf:t._isPcf&&1!==t._type;e.setBlendState(s?this.blendStateNoWrite:this.blendStateWrite),e.setDepthState(t.shadowDepthState),e.setStencilState(null,null);}dispatchUniforms(e,t,s,i){let n=t._node;0!==e._type&&(this.renderer.dispatchViewPos(n.getPosition()),this.shadowMapLightRadiusId.setValue(e.attenuationEnd)),lh.setTRS(n.getPosition(),n.getRotation(),eu.ONE).invert(),ld.mul2(t.projectionMatrix,lh);let r=s.shadowViewport;t.rect=r,t.scissorRect=s.shadowScissor,lp.setViewport(r.x,r.y,r.z,r.w),s.shadowMatrix.mul2(lp,ld),0===e._type&&e._shadowMatrixPalette.set(s.shadowMatrix.data,16*i);}getShadowPass(e){var t;let s=e._type,i=e._shadowType,n=null==(t=this.shadowPassCache[s])?void 0:t[i];return n||(n=ax.get(this.device).allocate("ShadowPass_"+s+"_"+i,{isShadow:true,lightType:s,shadowType:i}),this.shadowPassCache[s]||(this.shadowPassCache[s]=[]),this.shadowPassCache[s][i]=n),n.index}submitCasters(e,t,s){let i=this.device,n=this.renderer,r=n.scene,a=this.getShadowPass(t),o=s.shaderParams,l=s.renderTarget.flipY?-1:1,h=e.length;for(let t=0;t<h;t++){let s=e[t],h=s.mesh;s.ensureMaterial(i);let d=s.material;n.setBaseConstants(i,d),n.setSkinning(i,s),d.dirty&&(d.updateUniforms(i,r),d.dirty=false),n.setupCullMode(true,l,s),d.setParameters(i),s.setParameters(i,16);let c=s.getShaderInstance(a,0,r,o,this.viewUniformFormat,this.viewBindGroupFormat),u=c.shader;if(u.failed)continue;s._sortKeyShadow=u.id,i.setShader(u),n.setVertexBuffers(i,h),n.setMorphing(i,s.morphInstance),this.renderer.setupMeshUniformBuffers(c,s);let p=s.renderStyle;i.setIndexBuffer(h.indexBuffer[p]),n.drawInstance(i,s,h,p),n._shadowDrawCalls++;}}needsShadowRendering(e){let t=e.enabled&&e.castShadows&&0!==e.shadowUpdateMode&&e.visibleThisFrame;return 1===e.shadowUpdateMode&&(e.shadowUpdateMode=0),t&&(this.renderer._shadowMapUpdates+=e.numShadowFaces),t}getLightRenderData(e,t,s){return e.getRenderData(0===e._type?t:null,s)}setupRenderPass(e,t,s){let i=t.renderTarget;e.init(i),e.depthStencilOps.clearDepthValue=1,e.depthStencilOps.clearDepth=s,i.depthBuffer?e.depthStencilOps.storeDepth=true:(e.colorOps.clearValue.copy(t.clearColor),e.colorOps.clear=s,e.depthStencilOps.storeDepth=false),e.requiresCubemaps=false;}prepareFace(e,t,s){let i=e._type,n=this.getLightRenderData(e,t,s).shadowCamera,r=0===i?0:s;return n.renderTarget=e._shadowMap.renderTargets[r],n}renderFace(e,t,s,i,n){ void 0===n&&(n=true);let r=this.device,a=this.getLightRenderData(e,t,s),o=a.shadowCamera;this.dispatchUniforms(e,o,a,s);let l=o.renderTarget,h=this.renderer;h.setCameraUniforms(o,l),r.supportsUniformBuffers&&h.setupViewUniformBuffers(a.viewBindGroups,this.viewUniformFormat,this.viewBindGroupFormat,1),n?(h.setupViewport(o,l),i&&h.clear(o)):h.clearView(o,l,true,false),this.setupRenderState(r,e),this.submitCasters(a.visibleCasters,e,o);}render(e,t,s){if(void 0===s&&(s=true),this.needsShadowRendering(e)){let i=e.numShadowFaces;for(let n=0;n<i;n++)this.prepareFace(e,t,n),this.renderFace(e,t,n,true,s);this.renderVsm(e,t);}}renderVsm(e,t){e._isVsm&&e._vsmBlurSize>1&&(!this.renderer.scene.clusteredLightingEnabled||0===e._type)&&this.applyVsmBlur(e,t);}getVsmBlurShader(e,t){let s=this.blurVsmShader,i=s[e][t];if(!i){this.blurVsmWeights[t]=function(e){let t=(e-1)/6,s=(e-1)*.5,i=Array(e),n=0;for(let a=0;a<e;++a){var r;i[a]=Math.exp(-((r=a-s)*r)/(2*t*t)),n+=i[a];}for(let t=0;t<e;++t)i[t]/=n;return i}(t);let n=am.fullscreenQuadVS,r="#define SAMPLES "+t+"\n";r+=this.blurVsmShaderCode[e],i=ab(this.device,n,r,"blurVsm"+e+t),s[e][t]=i;}return i}applyVsmBlur(e,t){let s=this.device;s.setBlendState(sh.NOBLEND);let i=e.getRenderData(0===e._type?t:null,0).shadowCamera.renderTarget,n=this.renderer.shadowMapCache.get(s,e),r=n.renderTargets[0],a=e.vsmBlurMode,o=e._vsmBlurSize,l=this.getVsmBlurShader(a,o);lu.z=e._shadowResolution-2,lu.w=lu.z,this.sourceId.setValue(i.colorBuffer),lc[0]=1/e._shadowResolution,lc[1]=0,this.pixelOffsetId.setValue(lc),1===a&&this.weightId.setValue(this.blurVsmWeights[o]),aD(s,r,l,null,lu),this.sourceId.setValue(r.colorBuffer),lc[1]=lc[0],lc[0]=0,this.pixelOffsetId.setValue(lc),aD(s,i,l,null,lu),this.renderer.shadowMapCache.add(e,n);}initViewBindGroupFormat(){this.device.supportsUniformBuffers&&!this.viewUniformFormat&&(this.viewUniformFormat=new ir(this.device,[new ii("matrix_viewProjection",14)]),this.viewBindGroupFormat=new t6(this.device,[new t2(tY,3)]));}frameUpdate(){this.initViewBindGroupFormat();}constructor(e,t){this.shadowPassCache=[],this.device=e.device,this.renderer=e,this.lightTextureAtlas=t;let s=this.device.scope;this.sourceId=s.resolve("source"),this.pixelOffsetId=s.resolve("pixelOffset"),this.weightId=s.resolve("weight[0]"),this.blurVsmShaderCode=[am.blurVSMPS,"#define GAUSS\n"+am.blurVSMPS],this.blurVsmShader=[{},{}],this.blurVsmWeights={},this.shadowMapLightRadiusId=s.resolve("light_radius"),this.viewUniformFormat=null,this.viewBindGroupFormat=null,this.blendStateWrite=new sh,this.blendStateNoWrite=new sh,this.blendStateNoWrite.setColorWrite(false,false,false,false);}}let lm=[];class l_{destroy(){this._empty&&(this._empty.destroy(),this._empty=null),this._allocated.forEach(e=>{e.destroy();}),this._allocated.length=0;}get count(){return this._allocated.length}get empty(){if(!this._empty){let e=new oG(this.device);e.name="ClusterEmpty",e.update([]),this._empty=e;}return this._empty}assign(e){let t=this.empty;lm.push(...this._allocated),this._allocated.length=0,this._clusters.clear();let s=e.length;for(let n=0;n<s;n++){let s=e[n].renderActions;if(s){let e=s.length;for(let n=0;n<e;n++){let e=s[n];e.lightClusters=null;let r=e.layer;if(r.hasClusteredLights&&r.meshInstances.length){let t=r.getLightIdHash(),s=this._clusters.get(t),n=null==s?void 0:s.lightClusters;if(!n){var i;n=null!=(i=lm.pop())?i:new oG(this.device),this._allocated.push(n),this._clusters.set(t,e);}e.lightClusters=n;}e.lightClusters||(e.lightClusters=t);}}}lm.forEach(e=>e.destroy()),lm.length=0;}update(e,t){this.assign(e),this._clusters.forEach(e=>{let s=e.layer;e.lightClusters.update(s.clusteredLightsSet,t);});}constructor(e){this._empty=null,this._allocated=[],this._clusters=new Map,this.device=e;}}let lg=new em,lv=[];class ly extends nK{destroy(){var e,t;null==(e=this._quadRenderer2D)||e.destroy(),this._quadRenderer2D=null,null==(t=this._quadRendererCube)||t.destroy(),this._quadRendererCube=null;}static create(e,t){let s=new ly(e.device,t);return s.init(e),s.colorOps.clear=false,s.depthStencilOps.clearDepth=false,s}update(e){let t=this._filteredLights;this.filter(e,t),this.executeEnabled=t.length>0;}filter(e,t){for(let s=0;s<e.length;s++){let i=e[s];0!==i._type&&i.atlasViewportAllocated&&i.atlasSlotUpdated&&i.enabled&&i.cookie&&i.visibleThisFrame&&t.push(i);}}initInvViewProjMatrices(){if(!lv.length)for(let e=0;e<6;e++){let t=oP.create(null,1,e),s=t.projectionMatrix,i=t.node.getLocalTransform().clone().invert();lv[e]=new ex().mul2(s,i).invert();}}get quadRenderer2D(){if(!this._quadRenderer2D){let e=this.device.isWebGPU,t=e?oM:am,s=ab(this.device,t.cookieBlitVS,t.cookieBlit2DPS,"cookieRenderer2d",{vertex_position:e2},{shaderLanguage:e?tN:tF});this._quadRenderer2D=new aI(s);}return this._quadRenderer2D}get quadRendererCube(){if(!this._quadRendererCube){let e=this.device.isWebGPU,t=e?oM:am,s=ab(this.device,t.cookieBlitVS,t.cookieBlitCubePS,"cookieRendererCube",{vertex_position:e2},{shaderLanguage:e?tN:tF});this._quadRendererCube=new aI(s);}return this._quadRendererCube}execute(){let e=this.device;e.setBlendState(sh.NOBLEND),e.setCullMode(0),e.setDepthState(su.NODEPTH),e.setStencilState();let t=this.renderTarget.colorBuffer.width,s=this._cubeSlotsOffsets,i=this._filteredLights;for(let e=0;e<i.length;e++){let n=i[e],r=n.numShadowFaces,a=r>1?this.quadRendererCube:this.quadRenderer2D;r>1&&this.initInvViewProjMatrices(),this.blitTextureId.setValue(n.cookie);for(let e=0;e<r;e++){if(lg.copy(n.atlasViewport),r>1){let t=lg.z/3,i=s[e];lg.x+=t*i.x,lg.y+=t*i.y,lg.z=t,lg.w=t,this.invViewProjId.setValue(lv[e].data);}lg.mulScalar(t),a.render(lg);}}i.length=0;}constructor(e,t){super(e),this._quadRenderer2D=null,this._quadRendererCube=null,this._filteredLights=[],this._cubeSlotsOffsets=t,this.requiresCubemaps=false,this.blitTextureId=e.scope.resolve("blitTexture"),this.invViewProjId=e.scope.resolve("invViewProj");}}class lS extends nK{update(e){let t=this.shadowRendererLocal.shadowLights,s=this.shadowRendererLocal.prepareLights(t,e),i=t.length;this.enabled=i>0,i&&this.shadowRenderer.setupRenderPass(this,s,false);}execute(){let e=this.shadowRendererLocal.shadowLights,t=e.length;for(let s=0;s<t;s++){let t=e[s];for(let e=0;e<t.numShadowFaces;e++)this.shadowRenderer.renderFace(t,null,e,true);}e.length=0;}constructor(e,t,s){super(e),this.requiresCubemaps=false,this.shadowRenderer=t,this.shadowRendererLocal=s;}}class lx extends nK{update(e,t,s,i,n){this.frameGraph=e,this.cookiesRenderPass.enabled=s,s&&this.cookiesRenderPass.update(i),this.shadowRenderPass.enabled=t,t&&this.shadowRenderPass.update(n);}destroy(){this.cookiesRenderPass.destroy(),this.cookiesRenderPass=null;}execute(){let{renderer:e}=this,{scene:t}=e;e.worldClustersAllocator.update(this.frameGraph.renderPasses,t.lighting);}constructor(e,t,s,i,n){super(e),this.renderer=t,this.frameGraph=null,this.cookiesRenderPass=ly.create(n.cookieRenderTarget,n.cubeSlotsOffsets),this.beforePasses.push(this.cookiesRenderPass),this.shadowRenderPass=new lS(e,s,i),this.beforePasses.push(this.shadowRenderPass);}}let lT=0,lb=new ex,lE=new ex,lA=new ex,lw=new ep,lC=new eR,lP=new ex().setScale(1,-1,1),lM=new Set,lI=new Set,lR=new sa,lL=new ex().set([1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1]),lD=[new ef(.5,.333333),new ef(.25,.666667),new ef(.75,.111111),new ef(.125,.444444),new ef(.625,.777778),new ef(.375,.222222),new ef(.875,.555556),new ef(.0625,.888889),new ef(.5625,.037037),new ef(.3125,.37037),new ef(.8125,.703704),new ef(.1875,.148148),new ef(.6875,.481481),new ef(.4375,.814815),new ef(.9375,.259259),new ef(.03125,.592593)],lO=new ex,lF=new ex,lN=new ex,lB=new ex,lU=new ex,lk=new ex,lz=new Set,lV=[],lG=[];class lH{destroy(){this.shadowRenderer=null,this._shadowRendererLocal=null,this._shadowRendererDirectional=null,this.shadowMapCache.destroy(),this.shadowMapCache=null,this._renderPassUpdateClustered.destroy(),this._renderPassUpdateClustered=null,this.lightTextureAtlas.destroy(),this.lightTextureAtlas=null;}setupViewport(e,t){let s=this.device,i=t?t.width:s.width,n=t?t.height:s.height,r=e.rect,a=Math.floor(r.x*i),o=Math.floor(r.y*n),l=Math.floor(r.z*i),h=Math.floor(r.w*n);if(s.setViewport(a,o,l,h),e._scissorRectClear){let t=e.scissorRect;a=Math.floor(t.x*i),o=Math.floor(t.y*n),l=Math.floor(t.z*i),h=Math.floor(t.w*n);}s.setScissor(a,o,l,h);}setCameraUniforms(e,t){let s=null==t?void 0:t.flipY,i=1;if(e.xr&&e.xr.session){var n,r;let t=(null==(r=e._node)?void 0:null==(n=r.parent)?void 0:n.getWorldTransform())||null,s=e.xr.views;i=s.list.length;for(let n=0;n<i;n++){let i=s.list[n];i.updateTransforms(t),e.frustum.setFromMat4(i.projViewOffMat);}}else {let i=e.projectionMatrix;e.calculateProjection&&e.calculateProjection(i,0);let n=e.getProjectionMatrixSkybox();s&&(i=lO.mul2(lP,i),n=lF.mul2(lP,n)),this.device.isWebGPU&&(i=lN.mul2(lL,i),n=lB.mul2(lL,n));let{jitter:r}=e,a=0,o=0;if(r>0){let e=t?t.width:this.device.width,s=t?t.height:this.device.height,l=lD[this.device.renderVersion%lD.length];a=r*(2*l.x-1)/e,o=r*(2*l.y-1)/s,(i=lU.copy(i)).data[8]=a,i.data[9]=o,(n=lk.copy(n)).data[8]=a,n.data[9]=o,this.blueNoiseJitterVersion!==this.device.renderVersion&&(this.blueNoiseJitterVersion=this.device.renderVersion,this.blueNoise.vec4(this.blueNoiseJitterVec));}let l=r>0?this.blueNoiseJitterVec:em.ZERO;if(this.blueNoiseJitterData[0]=l.x,this.blueNoiseJitterData[1]=l.y,this.blueNoiseJitterData[2]=l.z,this.blueNoiseJitterData[3]=l.w,this.blueNoiseJitterId.setValue(this.blueNoiseJitterData),this.projId.setValue(i.data),this.projSkyboxId.setValue(n.data),e.calculateTransform)e.calculateTransform(lE,0);else {let t=e._node.getPosition(),s=e._node.getRotation();lE.setTRS(t,s,eu.ONE);}this.viewInvId.setValue(lE.data),lA.copy(lE).invert(),this.viewId.setValue(lA.data),lw.setFromMat4(lA),this.viewId3.setValue(lw.data),lb.mul2(i,lA),this.viewProjId.setValue(lb.data),e._storeShaderMatrices(lb,a,o,this.device.renderVersion),this.flipYId.setValue(s?-1:1),this.dispatchViewPos(e._node.getPosition()),e.frustum.setFromMat4(lb);}this.tbnBasis.setValue(s?-1:1);let a=e._nearClip,o=e._farClip;return this.nearClipId.setValue(a),this.farClipId.setValue(o),this.cameraParams[0]=1/o,this.cameraParams[1]=o,this.cameraParams[2]=a,this.cameraParams[3]=+(1===e.projection),this.cameraParamsId.setValue(this.cameraParams),this.exposureId.setValue(this.scene.physicalUnits?e.getExposure():this.scene.exposure),i}clear(e,t,s,i){let n=+(null!=t?!!t:!!e._clearColorBuffer)|2*(null!=s?!!s:!!e._clearDepthBuffer)|4*(null!=i?!!i:!!e._clearStencilBuffer);n&&this.device.clear({color:[e._clearColor.r,e._clearColor.g,e._clearColor.b,e._clearColor.a],depth:e._clearDepth,stencil:e._clearStencil,flags:n});}setCamera(e,t,s,i){this.setCameraUniforms(e,t),this.clearView(e,t,s,false);}clearView(e,t,s,i){let n=this.device;if(n.setRenderTarget(t),n.updateBegin(),i&&(n.setColorWrite(true,true,true,true),n.setDepthWrite(true)),this.setupViewport(e,t),s){let t=e._clearOptions;n.clear(t||{color:[e._clearColor.r,e._clearColor.g,e._clearColor.b,e._clearColor.a],depth:e._clearDepth,flags:+!!e._clearColorBuffer|2*!!e._clearDepthBuffer|4*!!e._clearStencilBuffer,stencil:e._clearStencil});}}setupCullMode(e,t,s){let i=s.material,n=0;if(e){let e=1;(2===i.cull||1===i.cull)&&(e=t*s.flipFacesFactor*s.node.worldScaleSign),n=e<0?2===i.cull?1:2:i.cull;}this.device.setCullMode(n),0===n&&0===i.cull&&this.twoSidedLightingNegScaleFactorId.setValue(s.node.worldScaleSign);}updateCameraFrustum(e){if(e.xr&&e.xr.views.list.length){let t=e.xr.views.list[0];lb.mul2(t.projMat,t.viewOffMat),e.frustum.setFromMat4(lb);return}let t=e.projectionMatrix;if(e.calculateProjection&&e.calculateProjection(t,0),e.calculateTransform)e.calculateTransform(lE,0);else {let t=e._node.getPosition(),s=e._node.getRotation();lE.setTRS(t,s,eu.ONE),this.viewInvId.setValue(lE.data);}lA.copy(lE).invert(),lb.mul2(t,lA),e.frustum.setFromMat4(lb);}setBaseConstants(e,t){e.setCullMode(t.cull),t.opacityMap&&this.opacityMapId.setValue(t.opacityMap),(t.opacityMap||t.alphaTest>0)&&this.alphaTestId.setValue(t.alphaTest);}updateCpuSkinMatrices(e){lT++;let t=e.length;if(0!==t)for(let s=0;s<t;s++){let t=e[s].skinInstance;t&&(t.updateMatrices(e[s].node,lT),t._dirty=true);}}updateGpuSkinMatrices(e){for(let t of e){let e=t.skinInstance;e&&e._dirty&&(e.updateMatrixPalette(t.node,lT),e._dirty=false);}}updateMorphing(e){for(let t of e){let e=t.morphInstance;e&&e._dirty&&e.update();}}updateGSplats(e){for(let s of e){var t;null==(t=s.gsplatInstance)||t.update();}}gpuUpdate(e){this.updateGpuSkinMatrices(e),this.updateMorphing(e),this.updateGSplats(e);}setVertexBuffers(e,t){e.setVertexBuffer(t.vertexBuffer);}setMorphing(e,t){t&&(t.prepareRendering(e),e.setVertexBuffer(t.morph.vertexBufferIds),this.morphPositionTex.setValue(t.texturePositions),this.morphNormalTex.setValue(t.textureNormals),this.morphTexParams.setValue(t._textureParams));}setSkinning(e,t){let s=t.skinInstance;if(s){this._skinDrawCalls++;let e=s.boneTexture;this.boneTextureId.setValue(e);}}dispatchViewPos(e){let t=this.viewPos;t[0]=e.x,t[1]=e.y,t[2]=e.z,this.viewPosId.setValue(t);}initViewBindGroupFormat(e){if(this.device.supportsUniformBuffers&&!this.viewUniformFormat){let t=[new ii("matrix_viewProjection",14),new ii("cubeMapRotationMatrix",13),new ii("view_position",4),new ii("skyboxIntensity",2),new ii("exposure",2),new ii("textureBias",2)];e&&t.push(new ii("clusterCellsCountByBoundsSize",4),new ii("clusterTextureSize",4),new ii("clusterBoundsMin",4),new ii("clusterBoundsDelta",4),new ii("clusterCellsDot",4),new ii("clusterCellsMax",4),new ii("shadowAtlasParams",3),new ii("clusterMaxCells",1),new ii("clusterSkip",2)),this.viewUniformFormat=new ir(this.device,t);let s=[new t2(tY,3)];this.viewBindGroupFormat=new t6(this.device,s);}}setupViewUniformBuffers(e,t,s,i){let n=this.device;for(;e.length<i;){let i=new no(n,t,false),r=new so(n,s,i);e.push(r);}let r=e[0];r.defaultUniformBuffer.update(),r.update(),n.setBindGroup(0,r);}setupMeshUniformBuffers(e,t){let s=this.device;if(s.supportsUniformBuffers){this.modelMatrixId.setValue(t.node.worldTransform.data),this.normalMatrixId.setValue(t.node.normalMatrix.data);let i=e.getBindGroup(s);i.update(),s.setBindGroup(1,i),e.getUniformBuffer(s).update(lR),s.setBindGroup(2,lR.bindGroup,lR.offsets);}}drawInstance(e,t,s,i,n){let r=t.node.worldTransform;this.modelMatrixId.setValue(r.data),n&&this.normalMatrixId.setValue(t.node.normalMatrix.data);let a=t.instancingData;a?a.count>0?(this._instancedDrawCalls++,e.setVertexBuffer(a.vertexBuffer),e.draw(s.primitive[i],a.count)):(e.clearVertexBuffer(),e.clearIndexBuffer()):e.draw(s.primitive[i]);}drawInstance2(e,t,s,i){let n=t.instancingData;n?n.count>0?(this._instancedDrawCalls++,e.draw(s.primitive[i],n.count,true)):(e.clearVertexBuffer(),e.clearIndexBuffer()):e.draw(s.primitive[i],void 0,true);}cull(e,t,s){let i=s.opaque;i.length=0;let n=s.transparent;n.length=0;let r=e.frustumCulling,a=t.length;for(let s=0;s<a;s++){let a=t[s];a.visible&&(!r||!a.cull||a._isVisible(e))&&(a.visibleThisFrame=true,(a.transparent?n:i).push(a),(a.skinInstance||a.morphInstance||a.gsplatInstance)&&(this.processingMeshInstances.add(a),a.gsplatInstance&&a.gsplatInstance.cameras.push(e)));}}collectLights(e){this.lights.length=0,this.localLights.length=0;let t=this.scene._stats,s=e.layerList.length;for(let t=0;t<s;t++){let s=e.layerList[t];if(!lI.has(s)){lI.add(s);let e=s._lights;for(let t=0;t<e.length;t++){let s=e[t];lM.has(s)||(lM.add(s),this.lights.push(s),0!==s._type&&this.localLights.push(s));}}}t.lights=this.lights.length,lM.clear(),lI.clear();}cullLights(e,t){let s=this.scene.clusteredLightingEnabled,i=this.scene.physicalUnits;for(let n=0;n<t.length;n++){let r=t[n];if(r.enabled){if(0!==r._type){if(r.getBoundingSphere(lC),e.frustum.containsSphere(lC)){r.visibleThisFrame=true,r.usePhysicalUnits=i;let t=e.getScreenSize(lC);r.maxScreenSize=Math.max(r.maxScreenSize,t);}else s||!r.castShadows||r.shadowMap||(r.visibleThisFrame=true);}else r.usePhysicalUnits=this.scene.physicalUnits;}}}cullShadowmaps(e){let t=this.scene.clusteredLightingEnabled;for(let s=0;s<this.localLights.length;s++){let i=this.localLights[s];0!==i._type&&(t?i.atlasSlotUpdated&&0===i.shadowUpdateMode&&(i.shadowUpdateMode=1):0===i.shadowUpdateMode&&i.castShadows&&!i.getRenderData(null,0).shadowCamera.renderTarget&&(i.shadowUpdateMode=1),i.visibleThisFrame&&i.castShadows&&0!==i.shadowUpdateMode&&this._shadowRendererLocal.cull(i,e));}this.cameraDirShadowLights.clear();let s=e.cameras;for(let t=0;t<s.length;t++){let i=s[t];if(i.enabled){let t;let s=i.camera,n=s.layers;for(let i=0;i<n.length;i++){let r=e.getLayerById(n[i]);if(r){let i=r.splitLights[0];for(let n=0;n<i.length;n++){let r=i[n];r.castShadows&&!lz.has(r)&&(lz.add(r),(t=null!=t?t:[]).push(r),this._shadowRendererDirectional.cull(r,e,s));}}}t&&this.cameraDirShadowLights.set(s,t),lz.clear();}}}cullComposition(e){let{scene:t}=this;this.processingMeshInstances.clear();let s=e.cameras.length;this._camerasRendered+=s;for(let i=0;i<s;i++){let s=e.cameras[i];null==t||t.fire(au,s);let n=s.renderTarget;s.frameUpdate(n),this.updateCameraFrustum(s.camera);let r=s.layers;for(let t=0;t<r.length;t++){let i=e.getLayerById(r[t]);if(i&&i.enabled){this.cullLights(s.camera,i._lights);let e=i.getCulledInstances(s.camera);this.cull(s.camera,i.meshInstances,e);}}null==t||t.fire(ap,s);}t.clusteredLightingEnabled&&this.updateLightTextureAtlas(),this.cullShadowmaps(e);}updateShaders(e,t){let s=e.length;for(let i=0;i<s;i++){let s=e[i].material;if(s&&!lz.has(s)&&(lz.add(s),s.getShaderVariant!==o8.prototype.getShaderVariant)){if(t&&(!s.useLighting||s.emitter&&!s.emitter.lighting))continue;s.clearVariants();}}lz.clear();}updateFrameUniforms(){this.blueNoiseTextureId.setValue(oQ(this.device));}beginFrame(e){let t=this.scene,s=t.updateShaders||this.device._shadersDirty,i=e.layerList,n=i.length;for(let e=0;e<n;e++){let t=i[e].meshInstances,n=t.length;for(let e=0;e<n;e++){let i=t[e];i.visibleThisFrame=false,s&&lV.push(i),i.skinInstance&&lG.push(i);}}if(s){let e=!t.updateShaders||!this.device._shadersDirty;this.updateShaders(lV,e),t.updateShaders=false,this.device._shadersDirty=false,t._shaderVersion++;}this.updateFrameUniforms(),this.updateCpuSkinMatrices(lG),lV.length=0,lG.length=0;let r=this.lights,a=r.length;for(let e=0;e<a;e++)r[e].beginFrame();}updateLightTextureAtlas(){this.lightTextureAtlas.update(this.localLights,this.scene.lighting);}updateLayerComposition(e){let t=e.layerList.length,s=this.scene._shaderVersion;for(let i=0;i<t;i++)e.layerList[i]._shaderVersion=s;e._update();}frameUpdate(){this.clustersDebugRendered=false,this.initViewBindGroupFormat(this.scene.clusteredLightingEnabled),this.dirLightShadows.clear();}constructor(e){this.clustersDebugRendered=false,this.processingMeshInstances=new Set,this.lights=[],this.localLights=[],this.cameraDirShadowLights=new Map,this.dirLightShadows=new Map,this.blueNoise=new oY(123),this.device=e,this.scene=null,this.worldClustersAllocator=new l_(e),this.lightTextureAtlas=new o4(e),this.shadowMapCache=new o9,this.shadowRenderer=new lf(this,this.lightTextureAtlas),this._shadowRendererLocal=new le(this,this.shadowRenderer),this._shadowRendererDirectional=new lo(this,this.shadowRenderer),this._renderPassUpdateClustered=new lx(this.device,this,this.shadowRenderer,this._shadowRendererLocal,this.lightTextureAtlas),this.viewUniformFormat=null,this.viewBindGroupFormat=null,this._skinTime=0,this._morphTime=0,this._cullTime=0,this._shadowMapTime=0,this._lightClustersTime=0,this._layerCompositionUpdateTime=0,this._shadowDrawCalls=0,this._skinDrawCalls=0,this._instancedDrawCalls=0,this._shadowMapUpdates=0,this._numDrawCallsCulled=0,this._camerasRendered=0,this._lightClusters=0;let t=e.scope;this.boneTextureId=t.resolve("texture_poseMap"),this.modelMatrixId=t.resolve("matrix_model"),this.normalMatrixId=t.resolve("matrix_normal"),this.viewInvId=t.resolve("matrix_viewInverse"),this.viewPos=new Float32Array(3),this.viewPosId=t.resolve("view_position"),this.projId=t.resolve("matrix_projection"),this.projSkyboxId=t.resolve("matrix_projectionSkybox"),this.viewId=t.resolve("matrix_view"),this.viewId3=t.resolve("matrix_view3"),this.viewProjId=t.resolve("matrix_viewProjection"),this.flipYId=t.resolve("projectionFlipY"),this.tbnBasis=t.resolve("tbnBasis"),this.nearClipId=t.resolve("camera_near"),this.farClipId=t.resolve("camera_far"),this.cameraParams=new Float32Array(4),this.cameraParamsId=t.resolve("camera_params"),this.viewIndexId=t.resolve("view_index"),this.blueNoiseJitterVersion=0,this.blueNoiseJitterVec=new em,this.blueNoiseJitterData=new Float32Array(4),this.blueNoiseJitterId=t.resolve("blueNoiseJitter"),this.blueNoiseTextureId=t.resolve("blueNoiseTex32"),this.alphaTestId=t.resolve("alpha_ref"),this.opacityMapId=t.resolve("texture_opacityMap"),this.exposureId=t.resolve("exposure"),this.twoSidedLightingNegScaleFactorId=t.resolve("twoSidedLightingNegScaleFactor"),this.twoSidedLightingNegScaleFactorId.setValue(0),this.morphPositionTex=t.resolve("morphPositionTex"),this.morphNormalTex=t.resolve("morphNormalTex"),this.morphTexParams=t.resolve("morph_tex_params"),this.lightCube=new oq,this.constantLightCube=t.resolve("lightCube[0]");}}class lW{destroy(){this.viewBindGroups.forEach(e=>{e.defaultUniformBuffer.destroy(),e.destroy();}),this.viewBindGroups.length=0;}setupClears(e,t){this.clearColor=(null==e?void 0:e.clearColorBuffer)||t.clearColorBuffer,this.clearDepth=(null==e?void 0:e.clearDepthBuffer)||t.clearDepthBuffer,this.clearStencil=(null==e?void 0:e.clearStencilBuffer)||t.clearStencilBuffer;}constructor(){this.camera=null,this.layer=null,this.transparent=false,this.renderTarget=null,this.lightClusters=null,this.clearColor=false,this.clearDepth=false,this.clearStencil=false,this.triggerPostprocess=false,this.firstCameraUse=false,this.lastCameraUse=false,this.viewBindGroups=[],this.useCameraPasses=false;}}class lX extends nK{get rendersAnything(){return this.renderActions.length>0}addRenderAction(e){this.renderActions.push(e);}addLayer(e,t,s,i){ void 0===i&&(i=true);let n=new lW;if(n.renderTarget=this.renderTarget,n.camera=e,n.layer=t,n.transparent=s,i){let s=0===this.renderActions.length;n.setupClears(s?e:void 0,t);}this.addRenderAction(n);}addLayers(e,t,s,i,n,r){ void 0===r&&(r=true);let{layerList:a,subLayerList:o}=e,l=i,h=s;for(;h<a.length;){let e=a[h],s=o[h];if(t.camera.layersSet.has(e.id)&&(this.addLayer(t,e,s,l),l=false),h++,e.id===n&&s===r)break}return h}updateDirectionalShadows(){let{renderer:e,renderActions:t}=this;for(let s=0;s<t.length;s++){let i=t[s].camera.camera,n=this.renderer.cameraDirShadowLights.get(i);if(n)for(let t=0;t<n.length;t++){let s=n[t];if(e.dirLightShadows.get(s)!==i){e.dirLightShadows.set(s,i);let t=e._shadowRendererDirectional.getLightRenderPass(s,i);t&&this.beforePasses.push(t);}}}}updateClears(){let e=this.renderActions[0];if(e){let t=e.camera.camera,s=t.fullSizeClearRect;this.setClearColor(s&&e.clearColor?t.clearColor:void 0),this.setClearDepth(s&&e.clearDepth&&!this.noDepthClear?t.clearDepth:void 0),this.setClearStencil(s&&e.clearStencil?t.clearStencil:void 0);}}frameUpdate(){super.frameUpdate(),this.updateDirectionalShadows(),this.updateClears();}before(){let{renderActions:e}=this;for(let t=0;t<e.length;t++){let s=e[t];s.firstCameraUse&&this.scene.fire(al,s.camera);}}execute(){let{layerComposition:e,renderActions:t}=this;for(let s=0;s<t.length;s++){let i=t[s],n=i.layer;e.isEnabled(n,i.transparent)&&this.renderRenderAction(i,0===s);}}after(){for(let e=0;e<this.renderActions.length;e++){let t=this.renderActions[e];t.lastCameraUse&&this.scene.fire(ah,t.camera);}this.beforePasses.length=0;}renderRenderAction(e,t){let{renderer:s,scene:i}=this,n=s.device,{layer:r,transparent:a,camera:o}=e;if(o){var l,h,d;let c=o.gammaCorrection,u=o.toneMapping;void 0!==this.gammaCorrection&&(o.gammaCorrection=this.gammaCorrection),void 0!==this.toneMapping&&(o.toneMapping=this.toneMapping),i.fire(ad,o,r,a);let p={lightClusters:e.lightClusters},f=null!=(h=null==(l=o.camera.shaderPassInfo)?void 0:l.index)?h:0;t&&o.camera.fullSizeClearRect||(p.clearColor=e.clearColor,p.clearDepth=e.clearDepth,p.clearStencil=e.clearStencil);let m=null!=(d=e.renderTarget)?d:n.backBuffer;s.renderForwardLayer(o.camera,m,r,a,f,e.viewBindGroups,p),n.setBlendState(sh.NOBLEND),n.setStencilState(null,null),n.setAlphaToCoverage(false),i.fire(ac,o,r,a),void 0!==this.gammaCorrection&&(o.gammaCorrection=c),void 0!==this.toneMapping&&(o.toneMapping=u);}}constructor(e,t,s,i){super(e),this.renderActions=[],this.noDepthClear=false,this.layerComposition=t,this.scene=s,this.renderer=i;}}class lY extends nK{execute(){this.renderAction.camera.onPostprocessing();}constructor(e,t,s){super(e),this.renderer=t,this.renderAction=s,this.requiresCubemaps=false;}}let lj=[[],[],[]],lq=new en,lK={drawCalls:[],shaderInstances:[],isNewMaterial:[],lightMaskChanged:[],clear:function(){this.drawCalls.length=0,this.shaderInstances.length=0,this.isNewMaterial.length=0,this.lightMaskChanged.length=0;}};class lZ extends lH{destroy(){super.destroy();}dispatchGlobalLights(e){let t=this.ambientColor;if(lq.linear(e.ambientLight),t[0]=lq.r,t[1]=lq.g,t[2]=lq.b,e.physicalUnits)for(let s=0;s<3;s++)t[s]*=e.ambientLuminance;this.ambientId.setValue(t),this.skyboxIntensityId.setValue(e.physicalUnits?e.skyboxLuminance:e.skyboxIntensity),this.cubeMapRotationMatrixId.setValue(e._skyboxRotationMat3.data);}_resolveLight(e,t){let s="light"+t;this.lightColorId[t]=e.resolve(""+s+"_color"),this.lightDir[t]=new Float32Array(3),this.lightDirId[t]=e.resolve(""+s+"_direction"),this.lightShadowMapId[t]=e.resolve(""+s+"_shadowMap"),this.lightShadowMatrixId[t]=e.resolve(""+s+"_shadowMatrix"),this.lightShadowParamsId[t]=e.resolve(""+s+"_shadowParams"),this.lightShadowIntensity[t]=e.resolve(""+s+"_shadowIntensity"),this.lightShadowSearchAreaId[t]=e.resolve(""+s+"_shadowSearchArea"),this.lightRadiusId[t]=e.resolve(""+s+"_radius"),this.lightPos[t]=new Float32Array(3),this.lightPosId[t]=e.resolve(""+s+"_position"),this.lightWidth[t]=new Float32Array(3),this.lightWidthId[t]=e.resolve(""+s+"_halfWidth"),this.lightHeight[t]=new Float32Array(3),this.lightHeightId[t]=e.resolve(""+s+"_halfHeight"),this.lightInAngleId[t]=e.resolve(""+s+"_innerConeAngle"),this.lightOutAngleId[t]=e.resolve(""+s+"_outerConeAngle"),this.lightCookieId[t]=e.resolve(""+s+"_cookie"),this.lightCookieIntId[t]=e.resolve(""+s+"_cookieIntensity"),this.lightCookieMatrixId[t]=e.resolve(""+s+"_cookieMatrix"),this.lightCookieOffsetId[t]=e.resolve(""+s+"_cookieOffset"),this.lightCameraParamsId[t]=e.resolve(""+s+"_cameraParams"),this.lightSoftShadowParamsId[t]=e.resolve(""+s+"_softShadowParams"),this.shadowMatrixPaletteId[t]=e.resolve(""+s+"_shadowMatrixPalette[0]"),this.shadowCascadeDistancesId[t]=e.resolve(""+s+"_shadowCascadeDistances"),this.shadowCascadeCountId[t]=e.resolve(""+s+"_shadowCascadeCount"),this.shadowCascadeBlendId[t]=e.resolve(""+s+"_shadowCascadeBlend");}setLTCDirectionalLight(e,t,s,i,n){this.lightPos[t][0]=i.x-s.x*n,this.lightPos[t][1]=i.y-s.y*n,this.lightPos[t][2]=i.z-s.z*n,this.lightPosId[t].setValue(this.lightPos[t]);let r=e.transformVector(new eu(-0.5,0,0));this.lightWidth[t][0]=r.x*n,this.lightWidth[t][1]=r.y*n,this.lightWidth[t][2]=r.z*n,this.lightWidthId[t].setValue(this.lightWidth[t]);let a=e.transformVector(new eu(0,0,.5));this.lightHeight[t][0]=a.x*n,this.lightHeight[t][1]=a.y*n,this.lightHeight[t][2]=a.z*n,this.lightHeightId[t].setValue(this.lightHeight[t]);}dispatchDirectLights(e,t,s){let i=0,n=this.device.scope;for(let r=0;r<e.length;r++){if(!(e[r].mask&t))continue;let a=e[r],o=a._node.getWorldTransform();if(this.lightColorId[i]||this._resolveLight(n,i),this.lightColorId[i].setValue(a._colorLinear),o.getY(a._direction).mulScalar(-1),a._direction.normalize(),this.lightDir[i][0]=a._direction.x,this.lightDir[i][1]=a._direction.y,this.lightDir[i][2]=a._direction.z,this.lightDirId[i].setValue(this.lightDir[i]),0!==a.shape&&this.setLTCDirectionalLight(o,i,a._direction,s._node.getPosition(),s.farClip),a.castShadows){let e=a.getRenderData(s,0),t=a._getUniformBiasValues(e);this.lightShadowMapId[i].setValue(e.shadowBuffer),this.lightShadowMatrixId[i].setValue(e.shadowMatrix.data),this.shadowMatrixPaletteId[i].setValue(a._shadowMatrixPalette),this.shadowCascadeDistancesId[i].setValue(a._shadowCascadeDistances),this.shadowCascadeCountId[i].setValue(a.numCascades),this.shadowCascadeBlendId[i].setValue(1-a.cascadeBlend),this.lightShadowIntensity[i].setValue(a.shadowIntensity),this.lightSoftShadowParamsId[i].setValue(a._softShadowParams),e.shadowCamera.renderTarget&&this.lightShadowSearchAreaId[i].setValue(a.penumbraSize/e.shadowCamera.renderTarget.width*e.projectionCompensation);let n=a._shadowCameraParams;n.length=4,n[0]=0,n[1]=e.shadowCamera._farClip,n[2]=e.shadowCamera._nearClip,n[3]=1,this.lightCameraParamsId[i].setValue(n);let r=a._shadowRenderParams;r.length=4,r[0]=a._shadowResolution,r[1]=t.normalBias,r[2]=t.bias,r[3]=0,this.lightShadowParamsId[i].setValue(r);}i++;}return i}setLTCPositionalLight(e,t){let s=e.transformVector(new eu(-0.5,0,0));this.lightWidth[t][0]=s.x,this.lightWidth[t][1]=s.y,this.lightWidth[t][2]=s.z,this.lightWidthId[t].setValue(this.lightWidth[t]);let i=e.transformVector(new eu(0,0,.5));this.lightHeight[t][0]=i.x,this.lightHeight[t][1]=i.y,this.lightHeight[t][2]=i.z,this.lightHeightId[t].setValue(this.lightHeight[t]);}dispatchOmniLight(e,t,s){let i=t._node.getWorldTransform();if(this.lightColorId[s]||this._resolveLight(e,s),this.lightRadiusId[s].setValue(t.attenuationEnd),this.lightColorId[s].setValue(t._colorLinear),i.getTranslation(t._position),this.lightPos[s][0]=t._position.x,this.lightPos[s][1]=t._position.y,this.lightPos[s][2]=t._position.z,this.lightPosId[s].setValue(this.lightPos[s]),0!==t.shape&&this.setLTCPositionalLight(i,s),t.castShadows){let e=t.getRenderData(null,0);this.lightShadowMapId[s].setValue(e.shadowBuffer);let i=t._getUniformBiasValues(e),n=t._shadowRenderParams;n.length=4,n[0]=t._shadowResolution,n[1]=i.normalBias,n[2]=i.bias,n[3]=1/t.attenuationEnd,this.lightShadowParamsId[s].setValue(n),this.lightShadowIntensity[s].setValue(t.shadowIntensity);let r=t.penumbraSize/e.shadowCamera.renderTarget.width;this.lightShadowSearchAreaId[s].setValue(r);let a=t._shadowCameraParams;a.length=4,a[0]=0,a[1]=e.shadowCamera._farClip,a[2]=e.shadowCamera._nearClip,a[3]=0,this.lightCameraParamsId[s].setValue(a);}t._cookie&&(this.lightCookieId[s].setValue(t._cookie),this.lightShadowMatrixId[s].setValue(i.data),this.lightCookieIntId[s].setValue(t.cookieIntensity));}dispatchSpotLight(e,t,s){let i=t._node.getWorldTransform();if(this.lightColorId[s]||this._resolveLight(e,s),this.lightInAngleId[s].setValue(t._innerConeAngleCos),this.lightOutAngleId[s].setValue(t._outerConeAngleCos),this.lightRadiusId[s].setValue(t.attenuationEnd),this.lightColorId[s].setValue(t._colorLinear),i.getTranslation(t._position),this.lightPos[s][0]=t._position.x,this.lightPos[s][1]=t._position.y,this.lightPos[s][2]=t._position.z,this.lightPosId[s].setValue(this.lightPos[s]),0!==t.shape&&this.setLTCPositionalLight(i,s),i.getY(t._direction).mulScalar(-1),t._direction.normalize(),this.lightDir[s][0]=t._direction.x,this.lightDir[s][1]=t._direction.y,this.lightDir[s][2]=t._direction.z,this.lightDirId[s].setValue(this.lightDir[s]),t.castShadows){let e=t.getRenderData(null,0);this.lightShadowMapId[s].setValue(e.shadowBuffer),this.lightShadowMatrixId[s].setValue(e.shadowMatrix.data);let i=t._getUniformBiasValues(e),n=t._shadowRenderParams;n.length=4,n[0]=t._shadowResolution,n[1]=i.normalBias,n[2]=i.bias,n[3]=1/t.attenuationEnd,this.lightShadowParamsId[s].setValue(n),this.lightShadowIntensity[s].setValue(t.shadowIntensity);let r=t.penumbraSize/e.shadowCamera.renderTarget.width,a=1/Math.tan(e.shadowCamera._fov*Math.PI/180/2);this.lightShadowSearchAreaId[s].setValue(r*a);let o=t._shadowCameraParams;o.length=4,o[0]=0,o[1]=e.shadowCamera._farClip,o[2]=e.shadowCamera._nearClip,o[3]=0,this.lightCameraParamsId[s].setValue(o);}if(t._cookie){if(!t.castShadows){let e=oP.evalSpotCookieMatrix(t);this.lightShadowMatrixId[s].setValue(e.data);}this.lightCookieId[s].setValue(t._cookie),this.lightCookieIntId[s].setValue(t.cookieIntensity),t._cookieTransform&&(t._cookieTransformUniform[0]=t._cookieTransform.x,t._cookieTransformUniform[1]=t._cookieTransform.y,t._cookieTransformUniform[2]=t._cookieTransform.z,t._cookieTransformUniform[3]=t._cookieTransform.w,this.lightCookieMatrixId[s].setValue(t._cookieTransformUniform),t._cookieOffsetUniform[0]=t._cookieOffset.x,t._cookieOffsetUniform[1]=t._cookieOffset.y,this.lightCookieOffsetId[s].setValue(t._cookieOffsetUniform));}}dispatchLocalLights(e,t,s){let i=s,n=this.device.scope,r=e[1],a=r.length;for(let e=0;e<a;e++){let s=r[e];s.mask&t&&(this.dispatchOmniLight(n,s,i),i++);}let o=e[2],l=o.length;for(let e=0;e<l;e++){let s=o[e];s.mask&t&&(this.dispatchSpotLight(n,s,i),i++);}}renderForwardPrepareMaterials(e,t,s,i,n,r){var a,o,l;let h=null!=(a=e.fogParams)?a:this.scene.fog,d=e.shaderParams;d.fog=h.type,d.srgbRenderTarget=null!=(o=null==t?void 0:t.isColorBufferSrgb(0))&&o;let c=(e,t,s,i)=>{lK.drawCalls.push(e),lK.shaderInstances.push(t),lK.isNewMaterial.push(s),lK.lightMaskChanged.push(i);};lK.clear();let u=this.device,p=this.scene,f=p.clusteredLightingEnabled,m=null!=(l=null==n?void 0:n.getLightHash(f))?l:0,_=null,g,v,y=s.length;for(let e=0;e<y;e++){let t=s[e];t.ensureMaterial(u);let n=t.material,a=t._shaderDefs,o=t.mask;n&&n===_&&a!==g&&(_=null),n!==_&&(this._materialSwitches++,n._scene=p,n.dirty&&(n.updateUniforms(u,p),n.dirty=false));let l=t.getShaderInstance(r,m,p,d,this.viewUniformFormat,this.viewBindGroupFormat,i);c(t,l,n!==_,!_||o!==v),_=n,g=a,v=o;}return lK}renderForwardInternal(e,t,s,i,n,r){let a=this.device,o=this.scene,l=1<<i,h=r?-1:1,d=o.clusteredLightingEnabled,c=t.drawCalls.length;for(let i=0;i<c;i++){var u,p;let r=t.drawCalls[i],o=t.isNewMaterial[i],f=t.lightMaskChanged[i],m=t.shaderInstances[i],_=r.material,g=r.mask;if(m.shader.failed)continue;if(o){if(a.setShader(m.shader,false),_.setParameters(a),f){let t=this.dispatchDirectLights(s[0],g,e);d||this.dispatchLocalLights(s,g,t);}this.alphaTestId.setValue(_.alphaTest),a.setBlendState(_.blendState),a.setDepthState(_.depthState),a.setAlphaToCoverage(_.alphaToCoverage);}this.setupCullMode(e._cullFaces,h,r);let v=null!=(u=r.stencilFront)?u:_.stencilFront,y=null!=(p=r.stencilBack)?p:_.stencilBack;a.setStencilState(v,y),r.setParameters(a,l),a.scope.resolve("meshInstanceId").setValue(r.id);let S=r.mesh;this.setVertexBuffers(a,S),this.setMorphing(a,r.morphInstance),this.setSkinning(a,r),this.setupMeshUniformBuffers(m,r);let x=r.renderStyle;if(a.setIndexBuffer(S.indexBuffer[x]),null==n||n(r,i),e.xr&&e.xr.session&&e.xr.views.list.length){let t=e.xr.views;for(let e=0;e<t.list.length;e++){let s=t.list[e];a.setViewport(s.viewport.x,s.viewport.y,s.viewport.z,s.viewport.w),this.projId.setValue(s.projMat.data),this.projSkyboxId.setValue(s.projMat.data),this.viewId.setValue(s.viewOffMat.data),this.viewInvId.setValue(s.viewInvOffMat.data),this.viewId3.setValue(s.viewMat3.data),this.viewProjId.setValue(s.projViewOffMat.data),this.viewPosId.setValue(s.positionData),this.viewIndexId.setValue(e),0===e?this.drawInstance(a,r,S,x,true):this.drawInstance2(a,r,S,x),this._forwardDrawCalls++;}}else this.drawInstance(a,r,S,x,true),this._forwardDrawCalls++;i<c-1&&!t.isNewMaterial[i+1]&&_.setParameters(a,r.parameters);}}renderForward(e,t,s,i,n,r,a,o){let l=this.renderForwardPrepareMaterials(e,t,s,i,a,n);this.renderForwardInternal(e,l,i,n,r,o),lK.clear();}renderForwardLayer(e,t,s,i,n,r,a){var o,l,h,d,c,u;let p,f;void 0===a&&(a={});let{scene:m,device:_}=this,g=m.clusteredLightingEnabled;if(this.setupViewport(e,t),s){s.sortVisible(e,i);let t=s.getCulledInstances(e);p=i?t.transparent:t.opaque,m.immediate.onPreRenderLayer(s,p,i),s.requiresLightCube&&(this.lightCube.update(m.ambientLight,s._lights),this.constantLightCube.setValue(this.lightCube.colors)),f=s.splitLights;}else p=a.meshInstances,f=null!=(o=a.splitLights)?o:lj;g&&((null!=(l=a.lightClusters)?l:this.worldClustersAllocator.empty).activate(),s&&!this.clustersDebugRendered&&m.lighting.debugLayer===s.id&&(this.clustersDebugRendered=true)),m._activeCamera=e;let v=null!=(h=e.fogParams)?h:this.scene.fog;this.setFogConstants(v);let y=this.setCameraUniforms(e,t);_.supportsUniformBuffers&&this.setupViewUniformBuffers(r,this.viewUniformFormat,this.viewBindGroupFormat,y);let S=null!=(d=a.clearColor)&&d,x=null!=(c=a.clearDepth)&&c,T=null!=(u=a.clearStencil)&&u;(S||x||T)&&this.clear(e,S,x,T);let b=!!(e._flipFaces^(null==t?void 0:t.flipY)),E=this._forwardDrawCalls;this.renderForward(e,t,p,f,n,null,s,b),s&&(s._forwardDrawCalls+=this._forwardDrawCalls-E);}setFogConstants(e){if(e.type!==rH){lq.linear(e.color);let t=this.fogColor;t[0]=lq.r,t[1]=lq.g,t[2]=lq.b,this.fogColorId.setValue(t),e.type===rW?(this.fogStartId.setValue(e.start),this.fogEndId.setValue(e.end)):this.fogDensityId.setValue(e.density);}}setSceneConstants(){let e=this.scene;this.dispatchGlobalLights(e);let t=this.device;this._screenSize[0]=t.width,this._screenSize[1]=t.height,this._screenSize[2]=1/t.width,this._screenSize[3]=1/t.height,this.screenSizeId.setValue(this._screenSize),this.pcssDiskSamplesId.setValue(this.pcssDiskSamples),this.pcssSphereSamplesId.setValue(this.pcssSphereSamples);}buildFrameGraph(e,t){let s=this.scene;if(e.reset(),s.clusteredLightingEnabled){let{shadowsEnabled:t,cookiesEnabled:i}=s.lighting;this._renderPassUpdateClustered.update(e,t,i,this.lights,this.localLights),e.addRenderPass(this._renderPassUpdateClustered);}else this._shadowRendererLocal.buildNonClusteredRenderPasses(e,this.localLights);let i=0,n=true,r=null,a=t._renderActions;for(let s=i;s<a.length;s++){let o=a[s],{layer:l,camera:h}=o;if(o.useCameraPasses)h.camera.renderPasses.forEach(t=>{e.addRenderPass(t);});else {let d=1===l.id,c=d&&(h.renderSceneColorMap||h.renderSceneDepthMap);n&&(n=false,i=s,r=o.renderTarget);let u=a[s+1],p=!!u&&!u.useCameraPasses&&1===u.layer.id&&(h.renderSceneColorMap||h.renderSceneDepthMap),f=!!u&&u.firstCameraUse&&this.cameraDirShadowLights.has(u.camera.camera);if(!u||u.renderTarget!==r||f||p||c){if(d&&i===s||this.addMainRenderPass(e,t,r,i,s),d){if(h.renderSceneColorMap){let t=h.camera.renderPassColorGrab;t.source=h.renderTarget,e.addRenderPass(t);}h.renderSceneDepthMap&&e.addRenderPass(h.camera.renderPassDepthGrab);}if(o.triggerPostprocess&&(null==h?void 0:h.onPostprocessing)){let t=new lY(this.device,this,o);e.addRenderPass(t);}n=true;}}}}addMainRenderPass(e,t,s,i,n){let r=new lX(this.device,t,this.scene,this);r.init(s);let a=t._renderActions;for(let e=i;e<=n;e++)r.addRenderAction(a[e]);e.addRenderPass(r);}update(e){this.frameUpdate(),this.shadowRenderer.frameUpdate(),this.scene._updateSkyMesh(),this.updateLayerComposition(e),this.collectLights(e),this.beginFrame(e),this.setSceneConstants(),this.cullComposition(e),this.gpuUpdate(this.processingMeshInstances);}constructor(e){super(e);let t=this.device;this._forwardDrawCalls=0,this._materialSwitches=0,this._depthMapTime=0,this._forwardTime=0,this._sortTime=0;let s=t.scope;this.fogColorId=s.resolve("fog_color"),this.fogStartId=s.resolve("fog_start"),this.fogEndId=s.resolve("fog_end"),this.fogDensityId=s.resolve("fog_density"),this.ambientId=s.resolve("light_globalAmbient"),this.skyboxIntensityId=s.resolve("skyboxIntensity"),this.cubeMapRotationMatrixId=s.resolve("cubeMapRotationMatrix"),this.pcssDiskSamplesId=s.resolve("pcssDiskSamples[0]"),this.pcssSphereSamplesId=s.resolve("pcssSphereSamples[0]"),this.lightColorId=[],this.lightDir=[],this.lightDirId=[],this.lightShadowMapId=[],this.lightShadowMatrixId=[],this.lightShadowParamsId=[],this.lightShadowIntensity=[],this.lightRadiusId=[],this.lightPos=[],this.lightPosId=[],this.lightWidth=[],this.lightWidthId=[],this.lightHeight=[],this.lightHeightId=[],this.lightInAngleId=[],this.lightOutAngleId=[],this.lightCookieId=[],this.lightCookieIntId=[],this.lightCookieMatrixId=[],this.lightCookieOffsetId=[],this.lightShadowSearchAreaId=[],this.lightCameraParamsId=[],this.lightSoftShadowParamsId=[],this.shadowMatrixPaletteId=[],this.shadowCascadeDistancesId=[],this.shadowCascadeCountId=[],this.shadowCascadeBlendId=[],this.screenSizeId=s.resolve("uScreenSize"),this._screenSize=new Float32Array(4),this.fogColor=new Float32Array(3),this.ambientColor=new Float32Array(3),this.pcssDiskSamples=function(e){let t=[];for(let e=0;e<16;++e){let s=Math.sqrt(e+.5)/Math.sqrt(16);t.push(s);}return t}(),this.pcssSphereSamples=function(e){let t=[];for(let e=0;e<16;e++){let s=e/16,i=Math.sqrt(s*s);t.push(i);}return t}();}}let lQ=0,lJ=[],l$=new Set,l0=[null,function(e,t){return e.drawOrder-t.drawOrder},function(e,t){let s=e._sortKeyForward,i=t._sortKeyForward;return s===i?t.mesh.id-e.mesh.id:i-s},function(e,t){return t._sortKeyDynamic-e._sortKeyDynamic},function(e,t){return e._sortKeyDynamic-t._sortKeyDynamic}];class l1{constructor(){this.opaque=[],this.transparent=[];}}class l2{set enabled(e){e!==this._enabled&&(this._dirtyComposition=true,this._enabled=e,e?(this.incrementCounter(),this.onEnable&&this.onEnable()):(this.decrementCounter(),this.onDisable&&this.onDisable()));}get enabled(){return this._enabled}set clearColorBuffer(e){this._clearColorBuffer=e,this._dirtyComposition=true;}get clearColorBuffer(){return this._clearColorBuffer}set clearDepthBuffer(e){this._clearDepthBuffer=e,this._dirtyComposition=true;}get clearDepthBuffer(){return this._clearDepthBuffer}set clearStencilBuffer(e){this._clearStencilBuffer=e,this._dirtyComposition=true;}get clearStencilBuffer(){return this._clearStencilBuffer}get hasClusteredLights(){return this._clusteredLightsSet.size>0}get clusteredLightsSet(){return this._clusteredLightsSet}incrementCounter(){0===this._refCounter&&(this._enabled=true,this.onEnable&&this.onEnable()),this._refCounter++;}decrementCounter(){if(1===this._refCounter)this._enabled=false,this.onDisable&&this.onDisable();else if(0===this._refCounter)return;this._refCounter--;}addMeshInstances(e,t){let s=this.meshInstances,i=this.meshInstancesSet;for(let t=0;t<e.length;t++){let n=e[t];i.has(n)||(s.push(n),i.add(n),l$.add(n.material));}if(t||this.addShadowCasters(e),l$.size>0){let e=this._shaderVersion;l$.forEach(t=>{e>=0&&t._shaderVersion!==e&&(t.getShaderVariant!==o8.prototype.getShaderVariant&&t.clearVariants(),t._shaderVersion=e);}),l$.clear();}}removeMeshInstances(e,t){let s=this.meshInstances,i=this.meshInstancesSet;for(let t=0;t<e.length;t++){let n=e[t];if(i.has(n)){i.delete(n);let e=s.indexOf(n);e>=0&&s.splice(e,1);}}t||this.removeShadowCasters(e);}addShadowCasters(e){let t=this.shadowCasters,s=this.shadowCastersSet;for(let i=0;i<e.length;i++){let n=e[i];n.castShadow&&!s.has(n)&&(s.add(n),t.push(n));}}removeShadowCasters(e){let t=this.shadowCasters,s=this.shadowCastersSet;for(let i=0;i<e.length;i++){let n=e[i];if(s.has(n)){s.delete(n);let e=t.indexOf(n);e>=0&&t.splice(e,1);}}}clearMeshInstances(e){ void 0===e&&(e=false),this.meshInstances.length=0,this.meshInstancesSet.clear(),e||(this.shadowCasters.length=0,this.shadowCastersSet.clear());}markLightsDirty(){this._lightHashDirty=true,this._lightIdHashDirty=true,this._splitLightsDirty=true;}hasLight(e){return this._lightsSet.has(e)}addLight(e){let t=e.light;this._lightsSet.has(t)||(this._lightsSet.add(t),this._lights.push(t),this.markLightsDirty()),0!==t.type&&this._clusteredLightsSet.add(t);}removeLight(e){let t=e.light;this._lightsSet.has(t)&&(this._lightsSet.delete(t),this._lights.splice(this._lights.indexOf(t),1),this.markLightsDirty()),0!==t.type&&this._clusteredLightsSet.delete(t);}clearLights(){this._lightsSet.forEach(e=>e.removeLayer(this)),this._lightsSet.clear(),this._clusteredLightsSet.clear(),this._lights.length=0,this.markLightsDirty();}get splitLights(){if(this._splitLightsDirty){this._splitLightsDirty=false;let e=this._splitLights;for(let t=0;t<e.length;t++)e[t].length=0;let t=this._lights;for(let s=0;s<t.length;s++){let i=t[s];i.enabled&&e[i._type].push(i);}for(let t=0;t<e.length;t++)e[t].sort((e,t)=>e.key-t.key);}return this._splitLights}evaluateLightHash(e,t,s){let i=0,n=this._lights;for(let i=0;i<n.length;i++){let r=0!==n[i].type;(e&&r||t&&!r)&&lJ.push(s?n[i].id:n[i].key);}return lJ.length>0&&(lJ.sort(),i=sx(lJ),lJ.length=0),i}getLightHash(e){return this._lightHashDirty&&(this._lightHashDirty=false,this._lightHash=this.evaluateLightHash(!e,true,false)),this._lightHash}getLightIdHash(){return this._lightIdHashDirty&&(this._lightIdHashDirty=false,this._lightIdHash=this.evaluateLightHash(true,false,true)),this._lightIdHash}addCamera(e){this.camerasSet.has(e.camera)||(this.camerasSet.add(e.camera),this.cameras.push(e),this._dirtyComposition=true);}removeCamera(e){if(this.camerasSet.has(e.camera)){this.camerasSet.delete(e.camera);let t=this.cameras.indexOf(e);this.cameras.splice(t,1),this._dirtyComposition=true;}}clearCameras(){this.cameras.length=0,this.camerasSet.clear(),this._dirtyComposition=true;}_calculateSortDistances(e,t,s){let i=e.length,{x:n,y:r,z:a}=t,{x:o,y:l,z:h}=s;for(let d=0;d<i;d++){let i;let c=e[d];if(c.calculateSortDistance)i=c.calculateSortDistance(c,t,s);else {let e=c.aabb.center;i=(e.x-n)*o+(e.y-r)*l+(e.z-a)*h;}let u=1e9*c._drawBucket;c._sortKeyDynamic=u+i;}}getCulledInstances(e){let t=this._visibleInstances.get(e);return t||(t=new l1,this._visibleInstances.set(e,t)),t}sortVisible(e,t){let s=t?this.transparentSortMode:this.opaqueSortMode;if(0===s)return;let i=this.getCulledInstances(e),n=t?i.transparent:i.opaque,r=e.node;if(5===s){let e=r.getPosition(),t=r.forward;this.customCalculateSortValues&&this.customCalculateSortValues(n,n.length,e,t),this.customSortCallback&&n.sort(this.customSortCallback);}else {if(3===s||4===s){let e=r.getPosition(),t=r.forward;this._calculateSortDistances(n,e,t);}n.sort(l0[s]);}}constructor(e={}){var t,s,i;this.meshInstances=[],this.meshInstancesSet=new Set,this.shadowCasters=[],this.shadowCastersSet=new Set,this._visibleInstances=new WeakMap,this._lights=[],this._lightsSet=new Set,this._clusteredLightsSet=new Set,this._splitLights=[[],[],[]],this._splitLightsDirty=true,this.requiresLightCube=false,this.cameras=[],this.camerasSet=new Set,this._dirtyComposition=false,void 0!==e.id?(this.id=e.id,lQ=Math.max(this.id+1,lQ)):this.id=lQ++,this.name=e.name,this._enabled=null==(t=e.enabled)||t,this._refCounter=+!!this._enabled,this.opaqueSortMode=null!=(s=e.opaqueSortMode)?s:2,this.transparentSortMode=null!=(i=e.transparentSortMode)?i:3,e.renderTarget&&(this.renderTarget=e.renderTarget),this._clearColorBuffer=!!e.clearColorBuffer,this._clearDepthBuffer=!!e.clearDepthBuffer,this._clearStencilBuffer=!!e.clearStencilBuffer,this.onEnable=e.onEnable,this.onDisable=e.onDisable,this._enabled&&this.onEnable&&this.onEnable(),this.customSortCallback=null,this.customCalculateSortValues=null,this._lightHash=0,this._lightHashDirty=false,this._lightIdHash=0,this._lightIdHashDirty=false,this._shaderVersion=-1;}}let l3=(e,t)=>e.priority-t.priority,l4=e=>e.sort(l3);class l5 extends Y{destroy(){this.destroyRenderActions();}destroyRenderActions(){this._renderActions.forEach(e=>e.destroy()),this._renderActions.length=0;}markDirty(){this._dirty=true;}_update(){let e=this.layerList.length;if(!this._dirty){for(let t=0;t<e;t++)if(this.layerList[t]._dirtyComposition){this._dirty=true;break}}if(this._dirty){this._dirty=false,this.cameras.length=0;for(let t=0;t<e;t++){let e=this.layerList[t];e._dirtyComposition=false;for(let t=0;t<e.cameras.length;t++){let s=e.cameras[t];0>this.cameras.indexOf(s)&&this.cameras.push(s);}}this.cameras.length>1&&l4(this.cameras);let t=0;this.destroyRenderActions();for(let s=0;s<this.cameras.length;s++){let i=this.cameras[s];if(i.camera.renderPasses.length>0){this.addDummyRenderAction(t,i),t++;continue}let n=true,r=t,a=null,o=false;for(let s=0;s<e;s++){let e=this.layerList[s];if(e.enabled&&this.subLayerEnabled[s]&&e.cameras.length>0&&i.layers.indexOf(e.id)>=0){!o&&e.id===i.disablePostEffectsLayer&&(o=true,a&&(a.triggerPostprocess=true));let r=this.subLayerList[s];a=this.addRenderAction(t,e,r,i,n,o),t++,n=false;}}r<t&&(a.lastCameraUse=true),!o&&a&&(a.triggerPostprocess=true),i.renderTarget&&i.postEffectsEnabled&&this.propagateRenderTarget(r-1,i);}this._logRenderActions();}}getNextRenderAction(e){let t=new lW;return this._renderActions.push(t),t}addDummyRenderAction(e,t){let s=this.getNextRenderAction(e);s.camera=t,s.useCameraPasses=true;}addRenderAction(e,t,s,i,n,r){let a=1!==t.id?i.renderTarget:null,o=false,l=this._renderActions;for(let t=e-1;t>=0;t--)if(l[t].camera===i&&l[t].renderTarget===a){o=true;break}r&&i.postEffectsEnabled&&(a=null);let h=this.getNextRenderAction(e);h.triggerPostprocess=false,h.layer=t,h.transparent=s,h.camera=i,h.renderTarget=a,h.firstCameraUse=n,h.lastCameraUse=false;let d=n||!o,c=t.clearColorBuffer||t.clearDepthBuffer||t.clearStencilBuffer;return (d||c)&&h.setupClears(d?i:void 0,t),h}propagateRenderTarget(e,t){for(let s=e;s>=0;s--){let e=this._renderActions[s],i=e.layer;if(e.renderTarget&&1!==i.id)break;if(1===i.id)continue;if(e.useCameraPasses)break;let n=null==e?void 0:e.camera.camera;if(n&&(!t.camera.rect.equals(n.rect)||!t.camera.scissorRect.equals(n.scissorRect)))break;e.renderTarget=t.renderTarget;}}_logRenderActions(){}_isLayerAdded(e){return this.layerIdMap.get(e.id)===e}_isSublayerAdded(e,t){return void 0!==(t?this.layerTransparentIndexMap:this.layerOpaqueIndexMap).get(e)}push(e){this._isLayerAdded(e)||(this.layerList.push(e),this.layerList.push(e),this._opaqueOrder[e.id]=this.subLayerList.push(false)-1,this._transparentOrder[e.id]=this.subLayerList.push(true)-1,this.subLayerEnabled.push(true),this.subLayerEnabled.push(true),this._updateLayerMaps(),this._dirty=true,this.fire("add",e));}insert(e,t){if(this._isLayerAdded(e))return;this.layerList.splice(t,0,e,e),this.subLayerList.splice(t,0,false,true);let s=this.layerList.length;this._updateOpaqueOrder(t,s-1),this._updateTransparentOrder(t,s-1),this.subLayerEnabled.splice(t,0,true,true),this._updateLayerMaps(),this._dirty=true,this.fire("add",e);}remove(e){let t=this.layerList.indexOf(e);for(delete this._opaqueOrder[t],delete this._transparentOrder[t];t>=0;)this.layerList.splice(t,1),this.subLayerList.splice(t,1),this.subLayerEnabled.splice(t,1),t=this.layerList.indexOf(e),this._dirty=true,this.fire("remove",e);let s=this.layerList.length;this._updateOpaqueOrder(0,s-1),this._updateTransparentOrder(0,s-1),this._updateLayerMaps();}pushOpaque(e){this._isSublayerAdded(e,false)||(this.layerList.push(e),this._opaqueOrder[e.id]=this.subLayerList.push(false)-1,this.subLayerEnabled.push(true),this._updateLayerMaps(),this._dirty=true,this.fire("add",e));}insertOpaque(e,t){if(this._isSublayerAdded(e,false))return;this.layerList.splice(t,0,e),this.subLayerList.splice(t,0,false);let s=this.subLayerList.length;this._updateOpaqueOrder(t,s-1),this.subLayerEnabled.splice(t,0,true),this._updateLayerMaps(),this._dirty=true,this.fire("add",e);}removeOpaque(e){for(let t=0,s=this.layerList.length;t<s;t++)if(this.layerList[t]===e&&!this.subLayerList[t]){this.layerList.splice(t,1),this.subLayerList.splice(t,1),s--,this._updateOpaqueOrder(t,s-1),this.subLayerEnabled.splice(t,1),this._dirty=true,0>this.layerList.indexOf(e)&&this.fire("remove",e);break}this._updateLayerMaps();}pushTransparent(e){this._isSublayerAdded(e,true)||(this.layerList.push(e),this._transparentOrder[e.id]=this.subLayerList.push(true)-1,this.subLayerEnabled.push(true),this._updateLayerMaps(),this._dirty=true,this.fire("add",e));}insertTransparent(e,t){if(this._isSublayerAdded(e,true))return;this.layerList.splice(t,0,e),this.subLayerList.splice(t,0,true);let s=this.subLayerList.length;this._updateTransparentOrder(t,s-1),this.subLayerEnabled.splice(t,0,true),this._updateLayerMaps(),this._dirty=true,this.fire("add",e);}removeTransparent(e){for(let t=0,s=this.layerList.length;t<s;t++)if(this.layerList[t]===e&&this.subLayerList[t]){this.layerList.splice(t,1),this.subLayerList.splice(t,1),s--,this._updateTransparentOrder(t,s-1),this.subLayerEnabled.splice(t,1),this._dirty=true,0>this.layerList.indexOf(e)&&this.fire("remove",e);break}this._updateLayerMaps();}getOpaqueIndex(e){var t;return null!=(t=this.layerOpaqueIndexMap.get(e))?t:-1}getTransparentIndex(e){var t;return null!=(t=this.layerTransparentIndexMap.get(e))?t:-1}isEnabled(e,t){if(e.enabled){let s=t?this.getTransparentIndex(e):this.getOpaqueIndex(e);if(s>=0)return this.subLayerEnabled[s]}return  false}_updateLayerMaps(){this.layerIdMap.clear(),this.layerNameMap.clear(),this.layerOpaqueIndexMap.clear(),this.layerTransparentIndexMap.clear();for(let e=0;e<this.layerList.length;e++){let t=this.layerList[e];this.layerIdMap.set(t.id,t),this.layerNameMap.set(t.name,t),(this.subLayerList[e]?this.layerTransparentIndexMap:this.layerOpaqueIndexMap).set(t,e);}}getLayerById(e){var t;return null!=(t=this.layerIdMap.get(e))?t:null}getLayerByName(e){var t;return null!=(t=this.layerNameMap.get(e))?t:null}_updateOpaqueOrder(e,t){for(let s=e;s<=t;s++) false===this.subLayerList[s]&&(this._opaqueOrder[this.layerList[s].id]=s);}_updateTransparentOrder(e,t){for(let s=e;s<=t;s++) true===this.subLayerList[s]&&(this._transparentOrder[this.layerList[s].id]=s);}_sortLayersDescending(e,t,s){let i=-1,n=-1;for(let t=0,n=e.length;t<n;t++){let n=e[t];s.hasOwnProperty(n)&&(i=Math.max(i,s[n]));}for(let e=0,i=t.length;e<i;e++){let i=t[e];s.hasOwnProperty(i)&&(n=Math.max(n,s[i]));}return -1===i&&-1!==n?1:-1===n&&-1!==i?-1:n-i}sortTransparentLayers(e,t){return this._sortLayersDescending(e,t,this._transparentOrder)}sortOpaqueLayers(e,t){return this._sortLayersDescending(e,t,this._opaqueOrder)}constructor(e="Untitled"){super(),this.layerList=[],this.layerIdMap=new Map,this.layerNameMap=new Map,this.layerOpaqueIndexMap=new Map,this.layerTransparentIndexMap=new Map,this.subLayerList=[],this.subLayerEnabled=[],this.cameras=[],this._renderActions=[],this._dirty=false,this.name=e,this._opaqueOrder={},this._transparentOrder={};}}let l6=new eu,l8={bias:0,normalBias:0},l9=new en,l7={r:0,g:1,b:2,a:3},he={directional:0,omni:1,point:1,spot:2},ht=[[new em(0,0,1,1)],[new em(0,0,.5,.5),new em(0,.5,.5,.5)],[new em(0,0,.5,.5),new em(0,.5,.5,.5),new em(.5,0,.5,.5)],[new em(0,0,.5,.5),new em(0,.5,.5,.5),new em(.5,0,.5,.5),new em(.5,.5,.5,.5)]],hs={rrr:1,ggg:2,bbb:4,aaa:8,rgb:7},hi=0;class hn{destroy(){this.viewBindGroups.forEach(e=>{e.defaultUniformBuffer.destroy(),e.destroy();}),this.viewBindGroups.length=0;}get shadowBuffer(){let e=this.shadowCamera.renderTarget;return e?this.light._isPcf?e.depthBuffer:e.colorBuffer:null}constructor(e,t,s){this.light=s,this.camera=e,this.shadowCamera=lf.createShadowCamera(s._shadowType,s._type,t),this.shadowMatrix=new ex,this.shadowViewport=new em(0,0,1,1),this.shadowScissor=new em(0,0,1,1),this.projectionCompensation=0,this.face=t,this.visibleCasters=[],this.viewBindGroups=[];}}class hr{destroy(){this._destroyShadowMap(),this.releaseRenderData(),this._renderData=null;}releaseRenderData(){if(this._renderData){for(let e=0;e<this._renderData.length;e++)this._renderData[e].destroy();this._renderData.length=0;}}addLayer(e){this.layers.add(e);}removeLayer(e){this.layers.delete(e);}set shadowSamples(e){this._softShadowParams[0]=e;}get shadowSamples(){return this._softShadowParams[0]}set shadowBlockerSamples(e){this._softShadowParams[1]=e;}get shadowBlockerSamples(){return this._softShadowParams[1]}set shadowBias(e){this._shadowBias!==e&&(this._shadowBias=e,this._updateShadowBias());}get shadowBias(){return this._shadowBias}set numCascades(e){this.cascades&&this.numCascades===e||(this.cascades=ht[e-1],this._shadowMatrixPalette=new Float32Array(64),this._shadowCascadeDistances=new Float32Array(4),this._destroyShadowMap(),this.updateKey());}get numCascades(){return this.cascades.length}set cascadeBlend(e){this._cascadeBlend!==e&&(this._cascadeBlend=e,this.updateKey());}get cascadeBlend(){return this._cascadeBlend}set shadowMap(e){this._shadowMap!==e&&(this._destroyShadowMap(),this._shadowMap=e);}get shadowMap(){return this._shadowMap}set mask(e){this._mask!==e&&(this._mask=e,this.updateKey(),this.updateClusteredFlags());}get mask(){return this._mask}get numShadowFaces(){let e=this._type;return 0===e?this.numCascades:1===e?6:1}set type(e){if(this._type===e)return;this._type=e,this._destroyShadowMap(),this._updateShadowBias(),this.updateKey(),this.updateClusteredFlags();let t=this._shadowType;this._shadowType=null,this.shadowUpdateOverrides=null,this.shadowType=t;}get type(){return this._type}set shape(e){if(this._shape===e)return;this._shape=e,this._destroyShadowMap(),this.updateKey(),this.updateClusteredFlags();let t=this._shadowType;this._shadowType=null,this.shadowType=t;}get shape(){return this._shape}set usePhysicalUnits(e){this._usePhysicalUnits!==e&&(this._usePhysicalUnits=e,this._updateLinearColor());}get usePhysicalUnits(){return this._usePhysicalUnits}set shadowType(e){var t,s;if(this._shadowType===e)return;let i=rK.get(e);i||(e=0);let n=this.device;6!==e||n.textureFloatRenderable||n.textureHalfFloatRenderable||(e=0),1===this._type&&5!==e&&0!==e&&7!==e&&8!==e&&6!==e&&(e=0),3!==e||n.textureFloatRenderable&&n.textureFloatFilterable||(e=2),2!==e||n.textureHalfFloatRenderable||(e=0),i=rK.get(e),this._isVsm=null!=(t=null==i?void 0:i.vsm)&&t,this._isPcf=null!=(s=null==i?void 0:i.pcf)&&s,this._shadowType=e,this._destroyShadowMap(),this.updateKey();}get shadowType(){return this._shadowType}set enabled(e){this._enabled!==e&&(this._enabled=e,this.layersDirty());}get enabled(){return this._enabled}set castShadows(e){this._castShadows!==e&&(this._castShadows=e,this._destroyShadowMap(),this.layersDirty(),this.updateKey());}get castShadows(){return this._castShadows&&4!==this._mask&&0!==this._mask}set shadowIntensity(e){this._shadowIntensity!==e&&(this._shadowIntensity=e,this.updateKey());}get shadowIntensity(){return this._shadowIntensity}get bakeShadows(){return this._castShadows&&4===this._mask}set shadowResolution(e){this._shadowResolution!==e&&(e=1===this._type?Math.min(e,this.device.maxCubeMapSize):Math.min(e,this.device.maxTextureSize),this._shadowResolution=e,this._destroyShadowMap());}get shadowResolution(){return this._shadowResolution}set vsmBlurSize(e){this._vsmBlurSize!==e&&(e%2==0&&e++,this._vsmBlurSize=e);}get vsmBlurSize(){return this._vsmBlurSize}set normalOffsetBias(e){if(this._normalOffsetBias!==e){let t=!this._normalOffsetBias&&e||this._normalOffsetBias&&!e;this._normalOffsetBias=e,t&&this.updateKey();}}get normalOffsetBias(){return this._normalOffsetBias}set falloffMode(e){this._falloffMode!==e&&(this._falloffMode=e,this.updateKey(),this.updateClusteredFlags());}get falloffMode(){return this._falloffMode}set innerConeAngle(e){this._innerConeAngle!==e&&(this._innerConeAngle=e,this._innerConeAngleCos=Math.cos(e*Math.PI/180),this.updateClusterData(false,true),this._usePhysicalUnits&&this._updateLinearColor());}get innerConeAngle(){return this._innerConeAngle}set outerConeAngle(e){this._outerConeAngle!==e&&(this._outerConeAngle=e,this._updateOuterAngle(e),this._usePhysicalUnits&&this._updateLinearColor());}get outerConeAngle(){return this._outerConeAngle}set penumbraSize(e){this._penumbraSize=e,this._softShadowParams[2]=e;}get penumbraSize(){return this._penumbraSize}set penumbraFalloff(e){this._softShadowParams[3]=e;}get penumbraFalloff(){return this._softShadowParams[3]}_updateOuterAngle(e){let t=e*Math.PI/180;this._outerConeAngleCos=Math.cos(t),this._outerConeAngleSin=Math.sin(t),this.updateClusterData(false,true);}set intensity(e){this._intensity!==e&&(this._intensity=e,this._updateLinearColor());}get intensity(){return this._intensity}set affectSpecularity(e){0===this._type&&(this._affectSpecularity=e,this.updateKey());}get affectSpecularity(){return this._affectSpecularity}set luminance(e){this._luminance!==e&&(this._luminance=e,this._updateLinearColor());}get luminance(){return this._luminance}get cookieMatrix(){return this._cookieMatrix||(this._cookieMatrix=new ex),this._cookieMatrix}get atlasViewport(){return this._atlasViewport||(this._atlasViewport=new em(0,0,1,1)),this._atlasViewport}set cookie(e){this._cookie!==e&&(this._cookie=e,this.updateKey());}get cookie(){return this._cookie}set cookieFalloff(e){this._cookieFalloff!==e&&(this._cookieFalloff=e,this.updateKey());}get cookieFalloff(){return this._cookieFalloff}set cookieChannel(e){if(this._cookieChannel!==e){if(e.length<3){let t=e.charAt(e.length-1),s=3-e.length;for(let i=0;i<s;i++)e+=t;}this._cookieChannel=e,this.updateKey(),this.updateClusteredFlags();}}get cookieChannel(){return this._cookieChannel}set cookieTransform(e){this._cookieTransform!==e&&(this._cookieTransform=e,this._cookieTransformSet=!!e,e&&!this._cookieOffset&&(this.cookieOffset=new ef,this._cookieOffsetSet=false),this.updateKey());}get cookieTransform(){return this._cookieTransform}set cookieOffset(e){this._cookieOffset!==e&&((this._cookieTransformSet||e)&&!e&&this._cookieOffset?this._cookieOffset.set(0,0):this._cookieOffset=e,this._cookieOffsetSet=!!e,e&&!this._cookieTransform&&(this.cookieTransform=new em(1,1,0,0),this._cookieTransformSet=false),this.updateKey());}get cookieOffset(){return this._cookieOffset}beginFrame(){this.visibleThisFrame=0===this._type&&this._enabled,this.maxScreenSize=0,this.atlasViewportAllocated=false,this.atlasSlotUpdated=false;}_destroyShadowMap(){if(this.releaseRenderData(),this._shadowMap&&(this._shadowMap.cached||this._shadowMap.destroy(),this._shadowMap=null),0===this.shadowUpdateMode&&(this.shadowUpdateMode=1),this.shadowUpdateOverrides)for(let e=0;e<this.shadowUpdateOverrides.length;e++)0===this.shadowUpdateOverrides[e]&&(this.shadowUpdateOverrides[e]=1);}getRenderData(e,t){for(let s=0;s<this._renderData.length;s++){let i=this._renderData[s];if(i.camera===e&&i.face===t)return i}let s=new hn(e,t,this);return this._renderData.push(s),s}clone(){let e=new hr(this.device,this.clusteredLighting);return e.type=this._type,e.setColor(this._color),e.intensity=this._intensity,e.affectSpecularity=this._affectSpecularity,e.luminance=this._luminance,e.castShadows=this.castShadows,e._enabled=this._enabled,e.attenuationStart=this.attenuationStart,e.attenuationEnd=this.attenuationEnd,e.falloffMode=this._falloffMode,e.shadowType=this._shadowType,e.vsmBlurSize=this._vsmBlurSize,e.vsmBlurMode=this.vsmBlurMode,e.vsmBias=this.vsmBias,e.shadowUpdateMode=this.shadowUpdateMode,e.mask=this.mask,this.shadowUpdateOverrides&&(e.shadowUpdateOverrides=this.shadowUpdateOverrides.slice()),e.innerConeAngle=this._innerConeAngle,e.outerConeAngle=this._outerConeAngle,e.numCascades=this.numCascades,e.cascadeDistribution=this.cascadeDistribution,e.cascadeBlend=this._cascadeBlend,e.shape=this._shape,e.shadowDepthState.copy(this.shadowDepthState),e.shadowBias=this.shadowBias,e.normalOffsetBias=this._normalOffsetBias,e.shadowResolution=this._shadowResolution,e.shadowDistance=this.shadowDistance,e.shadowIntensity=this.shadowIntensity,e.shadowSamples=this.shadowSamples,e.shadowBlockerSamples=this.shadowBlockerSamples,e.penumbraSize=this.penumbraSize,e.penumbraFalloff=this.penumbraFalloff,e}static getLightUnitConversion(e,t,s){switch(void 0===t&&(t=Math.PI/4),void 0===s&&(s=0),e){case 2:{let e=Math.cos(s);return 2*Math.PI*(1-e+(e-Math.cos(t))/2)}case 1:return 4*Math.PI;case 0:return 1}}_getUniformBiasValues(e){let t=e.shadowCamera._farClip;switch(this._type){case 1:l8.bias=this.shadowBias,l8.normalBias=this._normalOffsetBias;break;case 2:this._isVsm?l8.bias=-2e-4:l8.bias=20*this.shadowBias,l8.normalBias=this._isVsm?this.vsmBias/(this.attenuationEnd/7):this._normalOffsetBias;break;case 0:this._isVsm?l8.bias=-2e-4:l8.bias=this.shadowBias/t*100,l8.normalBias=this._isVsm?this.vsmBias/(t/7):this._normalOffsetBias;}return l8}getColor(){return this._color}getBoundingSphere(e){if(2===this._type){let t=this.attenuationEnd,s=this._outerConeAngle,i=this._outerConeAngleCos,n=this._node;l6.copy(n.up),s>45?(e.radius=t*this._outerConeAngleSin,l6.mulScalar(-t*i)):(e.radius=t/(2*i),l6.mulScalar(-e.radius)),e.center.add2(n.getPosition(),l6);}else 1===this._type&&(e.center=this._node.getPosition(),e.radius=this.attenuationEnd);}getBoundingBox(e){if(2===this._type){let t=this.attenuationEnd,s=this._outerConeAngle,i=this._node,n=Math.abs(Math.sin(s*ei.DEG_TO_RAD)*t);e.center.set(0,-(.5*t),0),e.halfExtents.set(n,.5*t,n),e.setFromTransformedAabb(e,i.getWorldTransform(),true);}else 1===this._type&&(e.center.copy(this._node.getPosition()),e.halfExtents.set(this.attenuationEnd,this.attenuationEnd,this.attenuationEnd));}_updateShadowBias(){if(1!==this._type||this.clusteredLighting){let e=-1e3*this.shadowBias;this.shadowDepthState.depthBias=e,this.shadowDepthState.depthBiasSlope=e;}else this.shadowDepthState.depthBias=0,this.shadowDepthState.depthBiasSlope=0;}_updateLinearColor(){let e=this._intensity;this._usePhysicalUnits&&(e=this._luminance/hr.getLightUnitConversion(this._type,this._outerConeAngle*ei.DEG_TO_RAD,this._innerConeAngle*ei.DEG_TO_RAD));let t=this._color,s=this._colorLinear;e>=1?l9.linear(t).mulScalar(e):l9.copy(t).mulScalar(e).linear(),s[0]=l9.r,s[1]=l9.g,s[2]=l9.b,this.updateClusterData(true);}setColor(){1==arguments.length?this._color.set(arguments[0].r,arguments[0].g,arguments[0].b):3==arguments.length&&this._color.set(arguments[0],arguments[1],arguments[2]),this._updateLinearColor();}layersDirty(){this.layers.forEach(e=>{e.hasLight(this)&&e.markLightsDirty();});}updateKey(){let e=this._type<<29|this._shadowType<<25|this._falloffMode<<23|+(0!==this._normalOffsetBias)<<22|+!!this._cookie<<21|+!!this._cookieFalloff<<20|l7[this._cookieChannel.charAt(0)]<<18|+!!this._cookieTransform<<12|this._shape<<10|+(this.numCascades>0)<<9|+(this._cascadeBlend>0)<<8|+!!this.affectSpecularity<<7|this.mask<<6|+!!this._castShadows<<3;3===this._cookieChannel.length&&(e|=l7[this._cookieChannel.charAt(1)]<<16,e|=l7[this._cookieChannel.charAt(2)]<<14),e!==this.key&&this.layersDirty(),this.key=e;}updateClusteredFlags(){var e;let t=!!(1&this.mask),s=!!(2&this.mask);this.clusteredFlags=+(2===this.type)<<30|(3&this._shape)<<28|(1&this._falloffMode)<<27|(null!=(e=hs[this._cookieChannel])?e:0)<<23|+!!t<<22|+!!s<<21;}getClusteredFlags(e,t){return this.clusteredFlags|((e?Math.floor(255*this.shadowIntensity):0)&255)<<0|((t?Math.floor(255*this.cookieIntensity):0)&255)<<8}updateClusterData(e,t){let{clusteredData16:s}=this,i=ed.float2Half;e&&(s[0]=i(ei.clamp(this._colorLinear[0]/100,0,65504)),s[1]=i(ei.clamp(this._colorLinear[1]/100,0,65504)),s[2]=i(ei.clamp(this._colorLinear[2]/100,0,65504))),t&&(s[4]=i(this._innerConeAngleCos),s[5]=i(this._outerConeAngleCos));}constructor(e,t){this.layers=new Set,this.shadowDepthState=su.DEFAULT.clone(),this.clusteredFlags=0,this.clusteredData=new Uint32Array(3),this.clusteredData16=new Uint16Array(this.clusteredData.buffer),this.device=e,this.clusteredLighting=t,this.id=hi++,this._type=0,this._color=new en(.8,.8,.8),this._intensity=1,this._affectSpecularity=true,this._luminance=0,this._castShadows=false,this._enabled=false,this._mask=1,this.isStatic=false,this.key=0,this.bakeDir=true,this.bakeNumSamples=1,this.bakeArea=0,this.attenuationStart=10,this.attenuationEnd=10,this._falloffMode=0,this._shadowType=0,this._vsmBlurSize=11,this.vsmBlurMode=1,this.vsmBias=.0025,this._cookie=null,this.cookieIntensity=1,this._cookieFalloff=true,this._cookieChannel="rgb",this._cookieTransform=null,this._cookieTransformUniform=new Float32Array(4),this._cookieOffset=null,this._cookieOffsetUniform=new Float32Array(2),this._cookieTransformSet=false,this._cookieOffsetSet=false,this._innerConeAngle=40,this._outerConeAngle=45,this.cascades=null,this._shadowMatrixPalette=null,this._shadowCascadeDistances=null,this.numCascades=1,this._cascadeBlend=0,this.cascadeDistribution=.5,this._shape=0,this._colorLinear=new Float32Array(3),this._updateLinearColor(),this._position=new eu(0,0,0),this._direction=new eu(0,0,0),this._innerConeAngleCos=Math.cos(this._innerConeAngle*Math.PI/180),this._updateOuterAngle(this._outerConeAngle),this._usePhysicalUnits=void 0,this._shadowMap=null,this._shadowRenderParams=[],this._shadowCameraParams=[],this.shadowDistance=40,this._shadowResolution=1024,this._shadowBias=-5e-4,this._shadowIntensity=1,this._normalOffsetBias=0,this.shadowUpdateMode=2,this.shadowUpdateOverrides=null,this._isVsm=false,this._isPcf=true,this._softShadowParams=new Float32Array(4),this.shadowSamples=16,this.shadowBlockerSamples=16,this.penumbraSize=1,this.penumbraFalloff=1,this._cookieMatrix=null,this._atlasViewport=null,this.atlasViewportAllocated=false,this.atlasVersion=0,this.atlasSlotIndex=0,this.atlasSlotUpdated=false,this._node=null,this._renderData=[],this.visibleThisFrame=false,this.maxScreenSize=0,this._updateShadowBias();}}class ha{applySettings(e){var t,s,i,n,r,a,o;this.shadowsEnabled=null!=(t=e.lightingShadowsEnabled)?t:this.shadowsEnabled,this.cookiesEnabled=null!=(s=e.lightingCookiesEnabled)?s:this.cookiesEnabled,this.areaLightsEnabled=null!=(i=e.lightingAreaLightsEnabled)?i:this.areaLightsEnabled,this.shadowAtlasResolution=null!=(n=e.lightingShadowAtlasResolution)?n:this.shadowAtlasResolution,this.cookieAtlasResolution=null!=(r=e.lightingCookieAtlasResolution)?r:this.cookieAtlasResolution,this.maxLightsPerCell=null!=(a=e.lightingMaxLightsPerCell)?a:this.maxLightsPerCell,this.shadowType=null!=(o=e.lightingShadowType)?o:this.shadowType,e.lightingCells&&(this.cells=new eu(e.lightingCells));}set cells(e){this._cells.copy(e);}get cells(){return this._cells}set maxLightsPerCell(e){this._maxLightsPerCell=ei.clamp(e,1,255);}get maxLightsPerCell(){return this._maxLightsPerCell}set cookieAtlasResolution(e){this._cookieAtlasResolution=ei.clamp(e,32,this._maxTextureSize);}get cookieAtlasResolution(){return this._cookieAtlasResolution}set shadowAtlasResolution(e){this._shadowAtlasResolution=ei.clamp(e,32,this._maxTextureSize);}get shadowAtlasResolution(){return this._shadowAtlasResolution}set shadowType(e){this._shadowType!==e&&(this._shadowType=e,this._dirtyLightsFnc());}get shadowType(){return this._shadowType}set cookiesEnabled(e){this._cookiesEnabled!==e&&(this._cookiesEnabled=e,this._dirtyLightsFnc());}get cookiesEnabled(){return this._cookiesEnabled}set areaLightsEnabled(e){this._supportsAreaLights&&this._areaLightsEnabled!==e&&(this._areaLightsEnabled=e,this._dirtyLightsFnc());}get areaLightsEnabled(){return this._areaLightsEnabled}set shadowsEnabled(e){this._shadowsEnabled!==e&&(this._shadowsEnabled=e,this._dirtyLightsFnc());}get shadowsEnabled(){return this._shadowsEnabled}constructor(e,t,s){this._areaLightsEnabled=false,this._cells=new eu(10,3,10),this._maxLightsPerCell=255,this._shadowsEnabled=true,this._shadowType=0,this._shadowAtlasResolution=2048,this._cookiesEnabled=false,this._cookieAtlasResolution=2048,this.atlasSplit=null,this._supportsAreaLights=e,this._maxTextureSize=t,this._dirtyLightsFnc=s;}}let ho=new sh(true,0,1,1);class hl{destroy(){this.shader=null;let e=this.morph;e&&(this.morph=null,e.decRefCount(),e.refCount<1&&e.destroy()),this.rtPositions&&(this.rtPositions.destroy(),this.rtPositions=null),this.texturePositions&&(this.texturePositions.destroy(),this.texturePositions=null),this.rtNormals&&(this.rtNormals.destroy(),this.rtNormals=null),this.textureNormals&&(this.textureNormals.destroy(),this.textureNormals=null);}clone(){return new hl(this.morph)}_getWeightIndex(e){return "string"==typeof e?this._weightMap.get(e):e}getWeight(e){let t=this._getWeightIndex(e);return this._weights[t]}setWeight(e,t){let s=this._getWeightIndex(e);this._weights[s]=t,this._dirty=true;}_getShader(e){let t=this.shaderCache[e];if(!t){let s=this.device.isWebGPU,i=s?oM:am,n=new Map;n.set("MORPH_TEXTURE_COUNT",e),n.set("{MORPH_TEXTURE_COUNT}",e),this.morph.intRenderFormat&&n.set("MORPH_INT","");let r=new Map;r.set("morphDeclarationPS",i.morphDeclarationPS),r.set("morphEvaluationPS",i.morphEvaluationPS);let a=this.morph.intRenderFormat?"uvec4":"vec4";t=ab(this.device,i.morphVS,i.morphPS,"textureMorph"+e,{vertex_position:e2},{shaderLanguage:s?tN:tF,fragmentIncludes:r,fragmentDefines:n,fragmentOutputTypes:[a]}),this.shaderCache[e]=t;}return t}_updateTextureRenderTarget(e,t,s){let i=this.device,n=(t,s)=>{this.morphFactor.setValue(this._shaderMorphWeights),i.setBlendState(s?ho:sh.NOBLEND),aD(i,e,this._getShader(t));};this.setAabbUniforms(s);let r=0,a=false,o=this._activeTargets.length;for(let e=0;e<o;e++){let s=this._activeTargets[e],i=s.target[t];i&&(this["morphBlendTex"+r].setValue(i),this._shaderMorphWeights[r]=s.weight,++r>=this.maxSubmitCount&&(n(r,a),r=0,a=true));}(r>0||0===o&&!this.zeroTextures)&&n(r,a);}_updateTextureMorph(){this.device,(this._activeTargets.length>0||!this.zeroTextures)&&(this.rtPositions&&this._updateTextureRenderTarget(this.rtPositions,"texturePositions",true),this.rtNormals&&this._updateTextureRenderTarget(this.rtNormals,"textureNormals",false),this.zeroTextures=0===this._activeTargets.length);}setAabbUniforms(e){ void 0===e&&(e=true),this.aabbSizeId.setValue(e?this._aabbSize:this._aabbNrmSize),this.aabbMinId.setValue(e?this._aabbMin:this._aabbNrmMin);}prepareRendering(e){this.setAabbUniforms();}update(){this._dirty=false;let e=this.morph._targets,t=0;for(let s=0;s<e.length;s++){let i=Math.abs(this.getWeight(s));if(i>1e-5){this._activeTargets.length<=t&&(this._activeTargets[t]={});let n=this._activeTargets[t++];n.absWeight=i,n.weight=this.getWeight(s),n.target=e[s];}}this._activeTargets.length=t,this.morph.intRenderFormat&&this._activeTargets.length>this.maxSubmitCount&&(this._activeTargets.sort((e,t)=>e.absWeight<t.absWeight?1:t.absWeight<e.absWeight?-1:0),this._activeTargets.length=this.maxSubmitCount),this._updateTextureMorph();}constructor(e){this.shaderCache=[],this.morph=e,e.incRefCount(),this.device=e.device,this._weights=[],this._weightMap=new Map;for(let t=0;t<e._targets.length;t++){let s=e._targets[t];s.name&&this._weightMap.set(s.name,t),this.setWeight(t,s.defaultWeight);}this._activeTargets=[],this.maxSubmitCount=this.device.maxTextures,this._shaderMorphWeights=new Float32Array(this.maxSubmitCount);let t=(t,s)=>(this[s]=e._createTexture(t,e._renderTextureFormat),new sR({colorBuffer:this[s],depth:false}));e.morphPositions&&(this.rtPositions=t("MorphRTPos","texturePositions")),e.morphNormals&&(this.rtNormals=t("MorphRTNrm","textureNormals")),this._textureParams=new Float32Array([e.morphTextureWidth,e.morphTextureHeight]);let s=e.aabb.halfExtents;this._aabbSize=new Float32Array([4*s.x,4*s.y,4*s.z]);let i=e.aabb.getMin();this._aabbMin=new Float32Array([2*i.x,2*i.y,2*i.z]),this._aabbNrmSize=new Float32Array([2,2,2]),this._aabbNrmMin=new Float32Array([-1,-1,-1]),this.aabbSizeId=this.device.scope.resolve("aabbSize"),this.aabbMinId=this.device.scope.resolve("aabbMin");for(let e=0;e<this.maxSubmitCount;e++)this["morphBlendTex"+e]=this.device.scope.resolve("morphBlendTex"+e);this.morphFactor=this.device.scope.resolve("morphFactor[0]"),this.zeroTextures=false;}}class hh{getGraph(){return this.graph}setGraph(e){this.graph=e;}getCameras(){return this.cameras}setCameras(e){this.cameras=e;}getLights(){return this.lights}setLights(e){this.lights=e;}getMaterials(){let e=[];for(let t=0;t<this.meshInstances.length;t++){let s=this.meshInstances[t];-1===e.indexOf(s.material)&&e.push(s.material);}return e}clone(){let e=[],t=[],s=function(i){let n=i.clone();e.push(i),t.push(n);for(let e=0;e<i._children.length;e++)n.addChild(s(i._children[e]));return n},i=s(this.graph),n=[],r=[],a=[];for(let e=0;e<this.skinInstances.length;e++){let t=this.skinInstances[e].skin,s=new aB(t),n=[];for(let e=0;e<t.boneNames.length;e++){let s=t.boneNames[e],r=i.findByName(s);n.push(r);}s.bones=n,r.push(s);}for(let e=0;e<this.morphInstances.length;e++){let t=new hl(this.morphInstances[e].morph);a.push(t);}for(let s=0;s<this.meshInstances.length;s++){let i=this.meshInstances[s],o=e.indexOf(i.node),l=new a0(i.mesh,i.material,t[o]);i.skinInstance&&(l.skinInstance=r[this.skinInstances.indexOf(i.skinInstance)]),i.morphInstance&&(l.morphInstance=a[this.morphInstances.indexOf(i.morphInstance)]),n.push(l);}let o=new hh;return o.graph=i,o.meshInstances=n,o.skinInstances=r,o.morphInstances=a,o.getGraph().syncHierarchy(),o}destroy(){let e=this.meshInstances;for(let t=0;t<e.length;t++)e[t].destroy();this.meshInstances.length=0;}generateWireframe(){a0._prepareRenderStyleForArray(this.meshInstances,1);}constructor(){this.graph=null,this.meshInstances=[],this.skinInstances=[],this.morphInstances=[],this.cameras=[],this.lights=[],this._shadersVersion=0,this._immutable=false;}}class hd extends s2{get aabb(){if(!this._aabb){let e=new eu,t=new eu;for(let s=0;s<this._targets.length;s++){let i=this._targets[s].aabb;e.min(i.getMin()),t.max(i.getMax());}this._aabb=new eP,this._aabb.setMinMax(e,t);}return this._aabb}get morphPositions(){return this._morphPositions}get morphNormals(){return this._morphNormals}_init(){this._initTextureBased();for(let e=0;e<this._targets.length;e++)this._targets[e]._postInit();}_findSparseSet(e,t,s){let i=1,n=e[0].length;for(let r=0;r<n;r+=3){let n=false;for(let t=0;t<e.length;t++){let s=e[t];if(0!==s[r]||0!==s[r+1]||0!==s[r+2]){n=true;break}}n?(t.push(i),s.push(r/3),i++):t.push(0);}return i}_initTextureBased(){let e=[],t=[];for(let s=0;s<this._targets.length;s++){let i=this._targets[s];i.options.deltaPositions&&(e.push(i.options.deltaPositions),t.push({target:i,name:"texturePositions"})),i.options.deltaNormals&&(e.push(i.options.deltaNormals),t.push({target:i,name:"textureNormals"}));}let s=[],i=[],n=this._findSparseSet(e,s,i),r=this.device.maxTextureSize,a=Math.ceil(Math.sqrt(n)),o=Math.ceil(n/(a=Math.min(a,r)));if(o>r)return  false;this.morphTextureWidth=a,this.morphTextureHeight=o;let l=false,h=ed.float2Half;12===this._textureFormat&&(l=true);let d=[];for(let t=0;t<e.length;t++)d.push(this._createTexture("MorphTarget",this._textureFormat));for(let s=0;s<e.length;s++){let n=e[s],r=d[s],a=r.lock();if(l)for(let e=0;e<i.length;e++){let t=3*i[e],s=4*e+4;a[s]=h(n[t]),a[s+1]=h(n[t+1]),a[s+2]=h(n[t+2]);}else for(let e=0;e<i.length;e++){let t=3*i[e],s=4*e+4;a[s]=n[t],a[s+1]=n[t+1],a[s+2]=n[t+2];}r.unlock(),t[s].target._setTexture(t[s].name,r);}let c=[{semantic:tT,components:1,type:5,asInt:true}];return this.vertexBufferIds=new sy(this.device,new sA(this.device,c,s.length),s.length,{data:new Uint32Array(s)}),true}destroy(){var e;null==(e=this.vertexBufferIds)||e.destroy(),this.vertexBufferIds=null;for(let e=0;e<this._targets.length;e++)this._targets[e].destroy();this._targets.length=0;}get targets(){return this._targets}_updateMorphFlags(){this._morphPositions=false,this._morphNormals=false;for(let e=0;e<this._targets.length;e++){let t=this._targets[e];t.morphPositions&&(this._morphPositions=true),t.morphNormals&&(this._morphNormals=true);}}_createTexture(e,t){return new se(this.device,{width:this.morphTextureWidth,height:this.morphTextureHeight,format:t,cubemap:false,mipmaps:false,minFilter:0,magFilter:0,addressU:1,addressV:1,name:e})}constructor(e,t,{preferHighPrecision:s=false}={}){var i;super(),this.device=t,this.preferHighPrecision=s,this._targets=e.slice();let n=t.textureHalfFloatRenderable?12:void 0,r=t.textureFloatRenderable?14:void 0;this._renderTextureFormat=this.preferHighPrecision?null!=r?r:n:null!=n?n:r,this._renderTextureFormat=null!=(i=this._renderTextureFormat)?i:47,this.intRenderFormat=eQ(this._renderTextureFormat),this._textureFormat=this.preferHighPrecision?14:12,this._init(),this._updateMorphFlags();}}class hc{destroy(){var e,t;null==(e=this.texturePositions)||e.destroy(),this.texturePositions=null,null==(t=this.textureNormals)||t.destroy(),this.textureNormals=null;}get name(){return this._name}get defaultWeight(){return this._defaultWeight}get aabb(){return !this._aabb&&(this._aabb=new eP,this.deltaPositions&&this._aabb.compute(this.deltaPositions)),this._aabb}get morphPositions(){return !!this.texturePositions}get morphNormals(){return !!this.textureNormals}clone(){return new hc(this.options)}_postInit(){this.options.preserveData||(this.options=null),this.used=true;}_setTexture(e,t){this[e]=t;}constructor(e){this.used=false,this.options=e,this._name=e.name,this._defaultWeight=e.defaultWeight||0,this._aabb=e.aabb,this.deltaPositions=e.deltaPositions;}}let hu=1,hp=new ex,hf=new ex,hm=new eu,h_=new eu,hg=new eu,hv=new eu,hy=new eu,hS=new eu,hx=new eu,hT=new eu,hb=new eu,hE=new eu,hA=new eu,hw=new eu,hC=new eu;function hP(e){return e-Math.floor(e)}function hM(e,t){return e-t*Math.floor(e/t)}function hI(e){let t=hP(e),s=hP(255*e);return [t-=s/255,s-=s/255]}class hR{calcSpawnPosition(e,t,s,i,n){let r=this._emitter,a=Math.random(),o=Math.random(),l=Math.random(),h=Math.random();if(r.useCpu&&(e[4*n+0+2*r.numParticlesPot*4]=a,e[4*n+1+2*r.numParticlesPot*4]=o,e[4*n+2+2*r.numParticlesPot*4]=l),h_.x=a-.5,h_.y=o-.5,h_.z=l-.5,0===r.emitterShape){let e=Math.max(Math.abs(h_.x),Math.max(Math.abs(h_.y),Math.abs(h_.z))),n=e+(.5-e)*s[0],a=e+(.5-e)*s[1],o=e+(.5-e)*s[2];h_.x=n*(e===Math.abs(h_.x)?Math.sign(h_.x):2*h_.x),h_.y=a*(e===Math.abs(h_.y)?Math.sign(h_.y):2*h_.y),h_.z=o*(e===Math.abs(h_.z)?Math.sign(h_.z):2*h_.z),r.localSpace?hm.copy(t.transformPoint(h_)):hm.copy(i).add(t.transformPoint(h_));}else {h_.normalize();let e=0===r.emitterRadius?0:r.emitterRadiusInner/r.emitterRadius,t=h*(1-e)+e;r.localSpace?hm.copy(h_.mulScalar(t*r.emitterRadius)):hm.copy(i).add(h_.mulScalar(t*r.emitterRadius));}let d=-ei.lerp(r.rate,r.rate2,a)*n;if(r.pack8){var c;let t,s,i,o;let l=(hm.x-r.worldBounds.center.x)/r.worldBoundsSize.x+.5,h=(hm.y-r.worldBounds.center.y)/r.worldBoundsSize.y+.5,u=(hm.z-r.worldBounds.center.z)/r.worldBoundsSize.z+.5,p=ei.lerp(r.startAngle*ei.DEG_TO_RAD,r.startAngle2*ei.DEG_TO_RAD,a);p=p%(2*Math.PI)/(2*Math.PI);let f=hI(l);e[4*n]=f[0],e[4*n+1]=f[1];let m=hI(h);e[4*n+2]=m[0],e[4*n+3]=m[1];let _=hI(u);e[4*n+0+4*r.numParticlesPot]=_[0],e[4*n+1+4*r.numParticlesPot]=_[1];let g=hI(p);e[4*n+2+4*r.numParticlesPot]=g[0],e[4*n+3+4*r.numParticlesPot]=g[1],e[4*n+3+8*r.numParticlesPot]=1;let v=Math.max(r.lifetime,(r.numParticles-1)*Math.max(r.rate,r.rate2)),y=(t=hP(c=d=(d+v)/(v+(r.lifetime+1))),s=hP(255*c),i=hP(65025*c),o=hP(0x99246ff*c),[t-=s/255,s-=i/255,i-=o/255,o-=o/255]);e[4*n+0+12*r.numParticlesPot]=y[0],e[4*n+1+12*r.numParticlesPot]=y[1],e[4*n+2+12*r.numParticlesPot]=y[2],e[4*n+3+12*r.numParticlesPot]=y[3];}else e[4*n]=hm.x,e[4*n+1]=hm.y,e[4*n+2]=hm.z,e[4*n+3]=ei.lerp(r.startAngle*ei.DEG_TO_RAD,r.startAngle2*ei.DEG_TO_RAD,a),e[4*n+3+4*r.numParticlesPot]=d;}update(e,s,i,n,r,a,o,l){let h,d,c,u,p,f,m,_,g,v,y,S;let x=this._emitter;if(x.meshInstance.node){let e=x.meshInstance.node.worldTransform;for(let t=0;t<12;t++)hp.data[t]=e.data[t];hf.copy(hp),hf.invert(),hu=Math.max(Math.max((t=x.meshInstance.node.localScale).x,t.y),t.z);}a=null===x.meshInstance.node||x.localSpace?eu.ZERO:x.meshInstance.node.getPosition();let T=x.camera?x.camera._node.getPosition():eu.ZERO,b=x.useMesh?17:15,E=x.precision-1;for(let s=0;s<x.numParticles;s++){let A=Math.floor(x.vbCPU[s*x.numParticleVerts*(x.useMesh?6:4)+3]),w=i[4*A+0+2*x.numParticlesPot*4];hg.x=w,hg.y=i[4*A+1+2*x.numParticlesPot*4],hg.z=i[4*A+2+2*x.numParticlesPot*4];let C=x.rate+(x.rate2-x.rate)*w,P=x.lifetime,M=i[4*A+3+4*x.numParticlesPot]+o,I=Math.max(Math.min(M/P,1),0),R=0,L=0;(M-o<=0||M>=P)&&this.calcSpawnPosition(i,n,r,a,A);let D=M>0&&M<P;D&&(u=Math.floor(c=I*E),p=Math.ceil(c),c%=1,f=(h=x.qRotSpeed[u])+((d=x.qRotSpeed[p])-h)*c,m=(h=x.qRotSpeed2[u])+((d=x.qRotSpeed2[p])-h)*c,R=(h=x.qScale[u])+((d=x.qScale[p])-h)*c,_=(h=x.qScale2[u])+((d=x.qScale2[p])-h)*c,g=(h=x.qAlpha[u])+((d=x.qAlpha[p])-h)*c,v=(h=x.qAlpha2[u])+((d=x.qAlpha2[p])-h)*c,y=(h=x.qRadialSpeed[u])+((d=x.qRadialSpeed[p])-h)*c,S=(h=x.qRadialSpeed2[u])+((d=x.qRadialSpeed2[p])-h)*c,y+=100*w%1*(S-y),hv.x=i[4*A],hv.y=i[4*A+1],hv.z=i[4*A+2],x.localSpace?hb.copy(hv):hb.copy(hv).sub(a),hb.normalize().mulScalar(y),u*=3,p*=3,h=x.qLocalVelocity[u],d=x.qLocalVelocity[p],hS.x=h+(d-h)*c,h=x.qLocalVelocity[u+1],d=x.qLocalVelocity[p+1],hS.y=h+(d-h)*c,h=x.qLocalVelocity[u+2],d=x.qLocalVelocity[p+2],hS.z=h+(d-h)*c,h=x.qLocalVelocity2[u],d=x.qLocalVelocity2[p],hT.x=h+(d-h)*c,h=x.qLocalVelocity2[u+1],d=x.qLocalVelocity2[p+1],hT.y=h+(d-h)*c,h=x.qLocalVelocity2[u+2],d=x.qLocalVelocity2[p+2],hT.z=h+(d-h)*c,h=x.qVelocity[u],d=x.qVelocity[p],hy.x=h+(d-h)*c,h=x.qVelocity[u+1],d=x.qVelocity[p+1],hy.y=h+(d-h)*c,h=x.qVelocity[u+2],d=x.qVelocity[p+2],hy.z=h+(d-h)*c,h=x.qVelocity2[u],d=x.qVelocity2[p],hx.x=h+(d-h)*c,h=x.qVelocity2[u+1],d=x.qVelocity2[p+1],hx.y=h+(d-h)*c,h=x.qVelocity2[u+2],d=x.qVelocity2[p+2],hx.z=h+(d-h)*c,hS.x+=(hT.x-hS.x)*hg.x,hS.y+=(hT.y-hS.y)*hg.y,hS.z+=(hT.z-hS.z)*hg.z,x.initialVelocity>0&&(1===x.emitterShape?(h_.copy(hg).mulScalar(2).sub(eu.ONE).normalize(),hS.add(h_.mulScalar(x.initialVelocity))):hS.add(eu.FORWARD.mulScalar(x.initialVelocity))),hy.x+=(hx.x-hy.x)*hg.x,hy.y+=(hx.y-hy.y)*hg.y,hy.z+=(hx.z-hy.z)*hg.z,f+=(m-f)*hg.y,R=(R+1e4*w%1*(_-R))*hu,L=1e3*w%1*(v-g),x.meshInstance.node&&(x.localSpace?(hS.x/=t.x,hS.y/=t.y,hS.z/=t.z):hp.transformPoint(hS,hS)),x.localSpace?(hf.transformPoint(hy,hy),hS.add(hy).add(hb)):(hS.add(hy.mul(t)),hS.add(hb.mul(t))),hw.copy(hS),hE.copy(hv).add(hS.mulScalar(o)),hA.copy(hE),i[4*A]=hA.x,i[4*A+1]=hA.y,i[4*A+2]=hA.z,i[4*A+3]+=f*o,x.wrap&&x.wrapBounds&&(x.localSpace||hA.sub(a),hA.x=hM(hA.x,x.wrapBounds.x)-.5*x.wrapBounds.x,hA.y=hM(hA.y,x.wrapBounds.y)-.5*x.wrapBounds.y,hA.z=hM(hA.z,x.wrapBounds.z)-.5*x.wrapBounds.z,x.localSpace||hA.add(a)),x.sort>0&&(1===x.sort?(hC.copy(hA).sub(T),x.particleDistance[A]=-(hC.x*hC.x+hC.y*hC.y+hC.z*hC.z)):2===x.sort?x.particleDistance[A]=M:3===x.sort&&(x.particleDistance[A]=-M))),l?M<0&&(i[4*A+3+2*x.numParticlesPot*4]=-1):(M>=P&&(M-=Math.max(P,(x.numParticles-1)*C),i[4*A+3+2*x.numParticlesPot*4]=x.loop?1:-1),M<0&&x.loop&&(i[4*A+3+2*x.numParticlesPot*4]=1)),i[4*A+3+2*x.numParticlesPot*4]<0&&(D=false),i[4*A+3+4*x.numParticlesPot]=M;for(let t=0;t<x.numParticleVerts;t++){let n=(s*x.numParticleVerts+t)*(x.useMesh?6:4),r=x.vbCPU[n],a=x.vbCPU[n+1],o=x.vbCPU[n+2];D||(r=a=o=0);let l=s*x.numParticleVerts*b+t*b;e[l]=hA.x,e[l+1]=hA.y,e[l+2]=hA.z,e[l+3]=I,e[l+4]=x.alignToMotion?0:i[4*A+3],e[l+5]=R,e[l+6]=L,e[l+7]=hw.x,e[l+8]=r,e[l+9]=a,e[l+10]=o,e[l+11]=hw.y,e[l+12]=A,e[l+13]=hw.z,e[l+14]=x.vbCPU[n+3],x.useMesh&&(e[l+15]=x.vbCPU[n+4],e[l+16]=x.vbCPU[n+5]);}}if(x.sort>0&&x.camera){let e=x.useMesh?6:4,t=x.particleDistance;for(let i=0;i<x.numParticles;i++)s[i][0]=i,s[i][1]=t[Math.floor(x.vbCPU[i*x.numParticleVerts*e+3])];x.vbOld.set(x.vbCPU),s.sort((e,t)=>e[1]-t[1]);for(let t=0;t<x.numParticles;t++){let i=s[t][0]*x.numParticleVerts*e,n=t*x.numParticleVerts*e;for(let t=0;t<x.numParticleVerts*e;t++)x.vbCPU[n+t]=x.vbOld[i+t];}}}constructor(e){this._emitter=e;}}let hL=new ep,hD=new ep,hO=new ep;class hF{_setInputBounds(){this.inBoundsSizeUniform[0]=this._emitter.prevWorldBoundsSize.x,this.inBoundsSizeUniform[1]=this._emitter.prevWorldBoundsSize.y,this.inBoundsSizeUniform[2]=this._emitter.prevWorldBoundsSize.z,this.constantInBoundsSize.setValue(this.inBoundsSizeUniform),this.inBoundsCenterUniform[0]=this._emitter.prevWorldBoundsCenter.x,this.inBoundsCenterUniform[1]=this._emitter.prevWorldBoundsCenter.y,this.inBoundsCenterUniform[2]=this._emitter.prevWorldBoundsCenter.z,this.constantInBoundsCenter.setValue(this.inBoundsCenterUniform);}randomize(){this.frameRandomUniform[0]=Math.random(),this.frameRandomUniform[1]=Math.random(),this.frameRandomUniform[2]=Math.random();}update(e,t,s,i,n){let r=this._emitter;e.setBlendState(sh.NOBLEND),e.setDepthState(su.NODEPTH),e.setCullMode(0),this.randomize(),this.constantGraphSampleSize.setValue(1/r.precision),this.constantGraphNumSamples.setValue(r.precision),this.constantNumParticles.setValue(r.numParticles),this.constantNumParticlesPot.setValue(r.numParticlesPot),this.constantInternalTex0.setValue(r.internalTex0),this.constantInternalTex1.setValue(r.internalTex1),this.constantInternalTex2.setValue(r.internalTex2),this.constantInternalTex3.setValue(r.internalTex3);let a=r.meshInstance.node,o=null===a?eu.ONE:a.localScale;if(r.pack8){this.worldBoundsMulUniform[0]=r.worldBoundsMul.x,this.worldBoundsMulUniform[1]=r.worldBoundsMul.y,this.worldBoundsMulUniform[2]=r.worldBoundsMul.z,this.constantOutBoundsMul.setValue(this.worldBoundsMulUniform),this.worldBoundsAddUniform[0]=r.worldBoundsAdd.x,this.worldBoundsAddUniform[1]=r.worldBoundsAdd.y,this.worldBoundsAddUniform[2]=r.worldBoundsAdd.z,this.constantOutBoundsAdd.setValue(this.worldBoundsAddUniform),this._setInputBounds();let e=r.maxVel*Math.max(Math.max(o.x,o.y),o.z);e=Math.max(e,1),this.constantMaxVel.setValue(e);}let l=null===a||r.localSpace?eu.ZERO:a.getPosition(),h=null===a?ex.IDENTITY:a.getWorldTransform();0===r.emitterShape?(hL.setFromMat4(t),this.constantSpawnBounds.setValue(hL.data),this.constantSpawnPosInnerRatio.setValue(s)):(this.constantSpawnBoundsSphere.setValue(r.emitterRadius),this.constantSpawnBoundsSphereInnerRatio.setValue(0===r.emitterRadius?0:r.emitterRadiusInner/r.emitterRadius)),this.constantInitialVelocity.setValue(r.initialVelocity),hD.setFromMat4(h),hO.invertMat4(h),this.emitterPosUniform[0]=l.x,this.emitterPosUniform[1]=l.y,this.emitterPosUniform[2]=l.z,this.constantEmitterPos.setValue(this.emitterPosUniform),this.constantFrameRandom.setValue(this.frameRandomUniform),this.constantDelta.setValue(i),this.constantRate.setValue(r.rate),this.constantRateDiv.setValue(r.rate2-r.rate),this.constantStartAngle.setValue(r.startAngle*ei.DEG_TO_RAD),this.constantStartAngle2.setValue(r.startAngle2*ei.DEG_TO_RAD),this.constantSeed.setValue(r.seed),this.constantLifetime.setValue(r.lifetime),this.emitterScaleUniform[0]=o.x,this.emitterScaleUniform[1]=o.y,this.emitterScaleUniform[2]=o.z,this.constantEmitterScale.setValue(this.emitterScaleUniform),this.constantEmitterMatrix.setValue(hD.data),this.constantEmitterMatrixInv.setValue(hO.data),this.constantLocalVelocityDivMult.setValue(r.localVelocityUMax),this.constantVelocityDivMult.setValue(r.velocityUMax),this.constantRotSpeedDivMult.setValue(r.rotSpeedUMax[0]);let d=r.swapTex?r.particleTexOUT:r.particleTexIN;d=r.beenReset?r.particleTexStart:d;let c=r.swapTex?r.particleTexIN:r.particleTexOUT;this.constantParticleTexIN.setValue(d),aD(e,r.swapTex?r.rtParticleTexIN:r.rtParticleTexOUT,n?r.shaderParticleUpdateOnStop:r.loop?r.shaderParticleUpdateRespawn:r.shaderParticleUpdateNoRespawn),r.material.setParameter("particleTexOUT",d),r.material.setParameter("particleTexIN",c),r.beenReset=false,r.swapTex=!r.swapTex,r.prevWorldBoundsSize.copy(r.worldBoundsSize),r.prevWorldBoundsCenter.copy(r.worldBounds.center),r.pack8&&this._setInputBounds();}constructor(e,t){this._emitter=e,this.frameRandomUniform=new Float32Array(3),this.emitterPosUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),this.worldBoundsMulUniform=new Float32Array(3),this.worldBoundsAddUniform=new Float32Array(3),this.inBoundsSizeUniform=new Float32Array(3),this.inBoundsCenterUniform=new Float32Array(3),this.constantParticleTexIN=t.scope.resolve("particleTexIN"),this.constantParticleTexOUT=t.scope.resolve("particleTexOUT"),this.constantEmitterPos=t.scope.resolve("emitterPos"),this.constantEmitterScale=t.scope.resolve("emitterScale"),this.constantSpawnBounds=t.scope.resolve("spawnBounds"),this.constantSpawnPosInnerRatio=t.scope.resolve("spawnPosInnerRatio"),this.constantSpawnBoundsSphere=t.scope.resolve("spawnBoundsSphere"),this.constantSpawnBoundsSphereInnerRatio=t.scope.resolve("spawnBoundsSphereInnerRatio"),this.constantInitialVelocity=t.scope.resolve("initialVelocity"),this.constantFrameRandom=t.scope.resolve("frameRandom"),this.constantDelta=t.scope.resolve("delta"),this.constantRate=t.scope.resolve("rate"),this.constantRateDiv=t.scope.resolve("rateDiv"),this.constantLifetime=t.scope.resolve("lifetime"),this.constantGraphSampleSize=t.scope.resolve("graphSampleSize"),this.constantGraphNumSamples=t.scope.resolve("graphNumSamples"),this.constantInternalTex0=t.scope.resolve("internalTex0"),this.constantInternalTex1=t.scope.resolve("internalTex1"),this.constantInternalTex2=t.scope.resolve("internalTex2"),this.constantInternalTex3=t.scope.resolve("internalTex3"),this.constantEmitterMatrix=t.scope.resolve("emitterMatrix"),this.constantEmitterMatrixInv=t.scope.resolve("emitterMatrixInv"),this.constantNumParticles=t.scope.resolve("numParticles"),this.constantNumParticlesPot=t.scope.resolve("numParticlesPot"),this.constantLocalVelocityDivMult=t.scope.resolve("localVelocityDivMult"),this.constantVelocityDivMult=t.scope.resolve("velocityDivMult"),this.constantRotSpeedDivMult=t.scope.resolve("rotSpeedDivMult"),this.constantSeed=t.scope.resolve("seed"),this.constantStartAngle=t.scope.resolve("startAngle"),this.constantStartAngle2=t.scope.resolve("startAngle2"),this.constantOutBoundsMul=t.scope.resolve("outBoundsMul"),this.constantOutBoundsAdd=t.scope.resolve("outBoundsAdd"),this.constantInBoundsSize=t.scope.resolve("inBoundsSize"),this.constantInBoundsCenter=t.scope.resolve("inBoundsCenter"),this.constantMaxVel=t.scope.resolve("maxVel"),this.constantFaceTangent=t.scope.resolve("faceTangent"),this.constantFaceBinorm=t.scope.resolve("faceBinorm");}}function hN(){return (hN=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i]);}return e}).apply(this,arguments)}let hB=["NONE","VERTEX","MAP"],hU=new class extends av{generateKey(e){let t="particle_"+av.definesHash(e.defines)+"_";for(let s in e)e.hasOwnProperty(s)&&(t+=e[s]);return t}createVertexDefines(e){let t=new Map(e.defines);return e.mesh&&t.set("USE_MESH",""),e.localSpace&&t.set("LOCAL_SPACE",""),e.screenSpace&&t.set("SCREEN_SPACE",""),e.animTex&&t.set("ANIMTEX",""),e.soft>0&&t.set("SOFT",""),e.stretch>0&&t.set("STRETCH",""),e.customFace&&t.set("CUSTOM_FACE",""),e.pack8&&t.set("PACK8",""),e.localSpace&&t.set("LOCAL_SPACE",""),e.animTexLoop&&t.set("ANIMTEX_LOOP",""),e.wrap&&t.set("WRAP",""),e.alignToMotion&&t.set("ALIGN_TO_MOTION",""),t.set("NORMAL",hB[e.normal]),t}createFragmentDefines(e){let t=new Map(e.defines);return e.soft>0&&t.set("SOFT",""),e.halflambert&&t.set("HALF_LAMBERT",""),t.set("NORMAL",hB[e.normal]),t.set("BLEND",rG[e.blend]),t}createShaderDefinition(e,t){let s=this.createVertexDefines(t),i=this.createFragmentDefines(t),n="PARTICLE_"+(t.useCpu?"CPU":"GPU")+"\n";s.set(n,""),i.set(n,"");let r=new Map(Object.entries(hN({},am,t.chunks)));return ne.createDefinition(e,{name:"ParticleShader",vertexCode:am.particle_shaderVS,fragmentCode:am.particle_shaderPS,fragmentDefines:i,fragmentIncludes:r,vertexIncludes:r,vertexDefines:s})}};class hk extends o8{getShaderVariant(e){var t,s;let{device:i,scene:n,cameraShaderParams:r}=e,{emitter:a}=this,o={defines:aA(this,e),pass:0,useCpu:this.emitter.useCpu,normal:a.lighting?null!==a.normalMap?2:1:0,halflambert:this.emitter.halfLambert,stretch:this.emitter.stretch,alignToMotion:this.emitter.alignToMotion,soft:this.emitter.depthSoftening,mesh:this.emitter.useMesh,gamma:null!=(t=null==r?void 0:r.shaderOutputGamma)?t:0,toneMap:null!=(s=null==r?void 0:r.toneMapping)?s:0,fog:n&&!this.emitter.noFog?n.fog.type:"none",wrap:this.emitter.wrap&&this.emitter.wrapBounds,localSpace:this.emitter.localSpace,screenSpace:!a.inTools&&this.emitter.screenSpace,blend:this.emitter.blendType,animTex:this.emitter._isAnimated(),animTexLoop:this.emitter.animLoop,pack8:this.emitter.pack8,customFace:0!==this.emitter.orientation},l=new af(e.viewUniformFormat,e.viewBindGroupFormat,e.vertexFormat),h=ag(i);return h.register("particle",hU),h.getProgram("particle",o,l,this.userId)}constructor(e){super(),this.emitter=null,this.emitter=e;}}let hz=[[-1,-1],[1,-1],[1,1],[-1,1]];function hV(e,t,s,i,n,r,a){ void 0===n&&(n=14);let o=0;a&&(7===n||20===n)&&(o=1);let l=new se(e,{width:t,height:s,format:n,cubemap:false,mipmaps:false,minFilter:o,magFilter:o,addressU:1,addressV:1,name:"ParticleSystemTexture"}),h=l.lock();if(7===n||20===n){let e=new Uint8Array(i.length);for(let t=0;t<i.length;t++)e[t]=i[t]*r*255;i=e;}return h.set(i),l.unlock(),l}function hG(e){return Math.max(Math.min(e,1),0)}let hH=new ea([0,0,1,0]),hW=new ea([0,1,1,1]),hX=new eo([0,0,1,0],[0,0,1,0],[0,0,1,0]),hY=new eo([0,1,1,1],[0,1,1,1],[0,1,1,1]),hj=2,hq=new Float32Array(3),hK=new ex,hZ=new eu,hQ=new eu,hJ=new eu;function h$(e,t){ void 0!==i[e]&&null!==i[e]?s[e]=i[e]:s[e]=t;}function h0(e,t,s){return (255*e<<16|255*t<<8|255*s)/0x1000000}function h1(e,t){let s=e.length/3,i=Array(4*s);for(let n=0;n<s;n++)i[4*n]=e[3*n],i[4*n+1]=e[3*n+1],i[4*n+2]=e[3*n+2],i[4*n+3]=h0(t[3*n],t[3*n+1],t[3*n+2]);return i}function h2(e,t){let s=t.length,i=e.length/s;for(let n=0;n<i;n++)for(let i=0;i<s;i++){let r=Math.abs(e[n*s+i]);t[i]=Math.max(t[i],r);}}function h3(e,t,s){let i=function(e,t){let s=new Float32Array(e.length);for(let i=0;i<e.length;i++)s[i]=e[i]-t[i];return s}(t,e);return h2(i,s),function(e,t){let s=t.length,i=e.length/s;for(let n=0;n<i;n++)for(let i=0;i<s;i++)e[n*s+i]/=0===t[i]?1:t[i],e[n*s+i]*=.5,e[n*s+i]+=.5;}(i,s),i}let h4=new t8;class h5{get defaultParamTexture(){return h4.get(this.graphicsDevice,()=>{let e=new Float32Array(1024);for(let t=0;t<16;t++)for(let s=0;s<16;s++){let i=s+1-8.5,n=t+1-8.5,r=hG(1-hG(Math.sqrt(i*i+n*n)/16)-.5),a=16*t+s;e[4*a]=1,e[4*a+1]=1,e[4*a+2]=1,e[4*a+3]=r;}let t=hV(this.graphicsDevice,16,16,e,20,1,true);return t.minFilter=1,t.magFilter=1,t})}onChangeCamera(){this.resetMaterial();}calculateBoundsMad(){this.worldBoundsMul.x=1/this.worldBoundsSize.x,this.worldBoundsMul.y=1/this.worldBoundsSize.y,this.worldBoundsMul.z=1/this.worldBoundsSize.z,this.worldBoundsAdd.copy(this.worldBounds.center).mul(this.worldBoundsMul).mulScalar(-1),this.worldBoundsAdd.x+=.5,this.worldBoundsAdd.y+=.5,this.worldBoundsAdd.z+=.5;}calculateWorldBounds(){if(!this.node)return;if(this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),!this.useCpu){(0===this.emitterShape?this.emitterExtents.equals(this.prevEmitterExtents):this.emitterRadius===this.prevEmitterRadius)||this.calculateLocalBounds();}let e=this.node.getWorldTransform();this.localSpace?this.worldBoundsNoTrail.copy(this.localBounds):this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,e),this.worldBoundsTrail[0].add(this.worldBoundsNoTrail),this.worldBoundsTrail[1].add(this.worldBoundsNoTrail);let t=this.simTimeTotal;t>=this.timeToSwitchBounds&&(this.worldBoundsTrail[0].copy(this.worldBoundsTrail[1]),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.timeToSwitchBounds=t+this.lifetime),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.localSpace?(this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,e),this.meshInstance.mesh.aabb.setFromTransformedAabb(this.worldBounds,e)):(this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance.mesh.aabb.copy(this.worldBounds)),this.meshInstance._aabbVer=1-this.meshInstance._aabbVer,this.pack8&&this.calculateBoundsMad();}resetWorldBounds(){this.node&&(this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,this.localSpace?ex.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBoundsNoTrail),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.simTimeTotal=0,this.timeToSwitchBounds=0);}calculateLocalBounds(){let e,t,s,i=Number.MAX_VALUE,n=Number.MAX_VALUE,r=Number.MAX_VALUE,a=-Number.MAX_VALUE,o=-Number.MAX_VALUE,l=-Number.MAX_VALUE,h=0,d=0,c=this.lifetime/this.precision,u=[this.qVelocity,this.qVelocity2],p=[this.qLocalVelocity,this.qLocalVelocity2],f=[0,0],m=[0,0],_=[0,0],g=[0,0],v=[0,0];for(let y=0;y<this.precision+1;y++){let S=Math.min(y,this.precision-1);for(let h=0;h<2;h++)e=p[h][3*S+0]*c+f[h],t=p[h][3*S+1]*c+m[h],s=p[h][3*S+2]*c+_[h],i=Math.min(e,i),n=Math.min(t,n),r=Math.min(s,r),a=Math.max(e,a),o=Math.max(t,o),l=Math.max(s,l),f[h]=e,m[h]=t,_[h]=s;for(let e=0;e<2;e++)v[e]+=c*Math.sqrt(u[e][3*S+0]*u[e][3*S+0]+u[e][3*S+1]*u[e][3*S+1]+u[e][3*S+2]*u[e][3*S+2]);g[0]+=this.qRadialSpeed[S]*c,g[1]+=this.qRadialSpeed2[S]*c,h=Math.max(h,Math.max(Math.abs(g[0]),Math.abs(g[1]))),d=Math.max(d,this.qScale[S]);}0===this.emitterShape?(e=.5*this.emitterExtents.x,t=.5*this.emitterExtents.y,s=.5*this.emitterExtents.z):(e=this.emitterRadius,t=this.emitterRadius,s=this.emitterRadius);let y=Math.max(v[0],v[1]);hQ.x=i-d-e-h-y,hQ.y=n-d-t-h-y,hQ.z=r-d-s-h-y,hJ.x=a+d+e+h+y,hJ.y=o+d+t+h+y,hJ.z=l+d+s+h+y,this.localBounds.setMinMax(hQ,hJ);}rebuild(){let e=this.graphicsDevice;null===this.colorMap&&(this.colorMap=this.defaultParamTexture),this.spawnBounds=0===this.emitterShape?this.emitterExtents:this.emitterRadius,this.useCpu=this.useCpu||this.sort>0||e.maxVertexTextures<=1||e.fragmentUniformsCount<64||e.forceCpuParticles,this._destroyResources(),this.pack8=(this.pack8||!e.textureFloatRenderable)&&!this.useCpu,hj=this.useCpu||this.pack8?4:2,this.useMesh=!!this.mesh,this.numParticlesPot=ei.nextPowerOfTwo(this.numParticles),this.rebuildGraphs(),this.calculateLocalBounds(),this.resetWorldBounds(),this.node&&(this.worldBounds.setFromTransformedAabb(this.localBounds,this.localSpace?ex.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBounds),this.worldBoundsTrail[1].copy(this.worldBounds),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.pack8&&this.calculateBoundsMad()),this.vbToSort=Array(this.numParticles);for(let e=0;e<this.numParticles;e++)this.vbToSort[e]=[0,0];this.particleDistance=new Float32Array(this.numParticles),this._gpuUpdater.randomize(),this.particleTex=new Float32Array(this.numParticlesPot*hj*4);let t=null===this.node||this.localSpace?eu.ZERO:this.node.getPosition();0===this.emitterShape&&(null===this.node||this.localSpace?hK.setTRS(eu.ZERO,eT.IDENTITY,this.spawnBounds):hK.setTRS(eu.ZERO,this.node.getRotation(),hZ.copy(this.spawnBounds).mul(this.node.localScale)),hq[0]=0!==this.emitterExtents.x?this.emitterExtentsInner.x/this.emitterExtents.x:0,hq[1]=0!==this.emitterExtents.y?this.emitterExtentsInner.y/this.emitterExtents.y:0,hq[2]=0!==this.emitterExtents.z?this.emitterExtentsInner.z/this.emitterExtents.z:0);for(let e=0;e<this.numParticles;e++)this._cpuUpdater.calcSpawnPosition(this.particleTex,hK,hq,t,e),this.useCpu&&(this.particleTex[4*e+3+2*this.numParticlesPot*4]=1);this.particleTexStart=new Float32Array(this.numParticlesPot*hj*4);for(let e=0;e<this.particleTexStart.length;e++)this.particleTexStart[e]=this.particleTex[e];this.useCpu||(this.pack8?(this.particleTexIN=hV(e,this.numParticlesPot,hj,this.particleTex,7,1,false),this.particleTexOUT=hV(e,this.numParticlesPot,hj,this.particleTex,7,1,false),this.particleTexStart=hV(e,this.numParticlesPot,hj,this.particleTexStart,7,1,false)):(this.particleTexIN=hV(e,this.numParticlesPot,hj,this.particleTex),this.particleTexOUT=hV(e,this.numParticlesPot,hj,this.particleTex),this.particleTexStart=hV(e,this.numParticlesPot,hj,this.particleTexStart)),this.rtParticleTexIN=new sR({colorBuffer:this.particleTexIN,depth:false}),this.rtParticleTexOUT=new sR({colorBuffer:this.particleTexOUT,depth:false}),this.swapTex=false);let s=new Map;this.localSpace&&s.set("LOCAL_SPACE",""),this.pack8&&s.set("PACK8",""),0===this.emitterShape&&s.set("EMITTERSHAPE_BOX","");let i=new Map(Object.entries(am)),n="#define RESPAWN\n "+am.particle_simulationPS,r="#define NO_RESPAWN\n "+am.particle_simulationPS,a="#define ON_STOP\n "+am.particle_simulationPS,o="Shape:"+this.emitterShape+"-Pack:"+this.pack8+"-Local:"+this.localSpace;this.shaderParticleUpdateRespawn=ab(e,am.fullscreenQuadVS,n,"ParticleUpdateRespawn-"+o,void 0,false,{fragmentDefines:s,fragmentIncludes:i}),this.shaderParticleUpdateNoRespawn=ab(e,am.fullscreenQuadVS,r,"ParticleUpdateNoRespawn-"+o,void 0,false,{fragmentDefines:s,fragmentIncludes:i}),this.shaderParticleUpdateOnStop=ab(e,am.fullscreenQuadVS,a,"ParticleUpdateStop-"+o,void 0,false,{fragmentDefines:s,fragmentIncludes:i}),this.numParticleVerts=this.useMesh?this.mesh.vertexBuffer.numVertices:4,this.numParticleIndices=this.useMesh?this.mesh.indexBuffer[0].numIndices:6,this._allocate(this.numParticles);let l=new aG(e);l.vertexBuffer=this.vertexBuffer,l.indexBuffer[0]=this.indexBuffer,l.primitive[0].type=4,l.primitive[0].base=0,l.primitive[0].count=this.numParticles*this.numParticleIndices,l.primitive[0].indexed=true,this.material=this._createMaterial(),this.resetMaterial();let h=!this.meshInstance||this.meshInstance.visible;this.meshInstance=new a0(l,this.material,this.node),this.meshInstance.pick=false,this.meshInstance.updateKey(),this.meshInstance.cull=true,this.localSpace?this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,this.node.getWorldTransform()):this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance._updateAabb=false,this.meshInstance.visible=h,this._setMaterialTextures(),this.resetTime(),this.addTime(0,false),this.preWarm&&this.prewarm(this.lifetime);}_isAnimated(){return this.animNumFrames>=1&&(this.animTilesX>1||this.animTilesY>1)&&(this.colorMap&&this.colorMap!==this.defaultParamTexture||this.normalMap)}rebuildGraphs(){let e=this.precision,t=this.graphicsDevice;this.qLocalVelocity=this.localVelocityGraph.quantize(e),this.qVelocity=this.velocityGraph.quantize(e),this.qColor=this.colorGraph.quantizeClamped(e,0,1),this.qRotSpeed=this.rotationSpeedGraph.quantize(e),this.qScale=this.scaleGraph.quantize(e),this.qAlpha=this.alphaGraph.quantize(e),this.qRadialSpeed=this.radialSpeedGraph.quantize(e),this.qLocalVelocity2=this.localVelocityGraph2.quantize(e),this.qVelocity2=this.velocityGraph2.quantize(e),this.qColor2=this.colorGraph2.quantizeClamped(e,0,1),this.qRotSpeed2=this.rotationSpeedGraph2.quantize(e),this.qScale2=this.scaleGraph2.quantize(e),this.qAlpha2=this.alphaGraph2.quantize(e),this.qRadialSpeed2=this.radialSpeedGraph2.quantize(e);for(let t=0;t<e;t++)this.qRotSpeed[t]*=ei.DEG_TO_RAD,this.qRotSpeed2[t]*=ei.DEG_TO_RAD;if(this.localVelocityUMax=new Float32Array(3),this.velocityUMax=new Float32Array(3),this.colorUMax=new Float32Array(3),this.rotSpeedUMax=[0],this.scaleUMax=[0],this.alphaUMax=[0],this.radialSpeedUMax=[0],this.qLocalVelocityDiv=h3(this.qLocalVelocity,this.qLocalVelocity2,this.localVelocityUMax),this.qVelocityDiv=h3(this.qVelocity,this.qVelocity2,this.velocityUMax),this.qColorDiv=h3(this.qColor,this.qColor2,this.colorUMax),this.qRotSpeedDiv=h3(this.qRotSpeed,this.qRotSpeed2,this.rotSpeedUMax),this.qScaleDiv=h3(this.qScale,this.qScale2,this.scaleUMax),this.qAlphaDiv=h3(this.qAlpha,this.qAlpha2,this.alphaUMax),this.qRadialSpeedDiv=h3(this.qRadialSpeed,this.qRadialSpeed2,this.radialSpeedUMax),this.pack8){let e=[0,0,0];h2(this.qVelocity,e);let t=[0,0,0];h2(this.qVelocity2,t);let s=[0,0,0];h2(this.qLocalVelocity,s);let i=[0,0,0];h2(this.qLocalVelocity2,i);let n=[0];h2(this.qRadialSpeed,n);let r=[0];h2(this.qRadialSpeed2,r);let a=Math.max(e[0],t[0]);a=Math.max(a=Math.max(a=Math.max(a=Math.max(a,e[1]),t[1]),e[2]),t[2]);let o=Math.max(s[0],i[0]);o=Math.max(o=Math.max(o=Math.max(o=Math.max(o,s[1]),i[1]),s[2]),i[2]);let l=Math.max(n[0],r[0]);this.maxVel=a+o+l;}this.useCpu||(this.internalTex0=hV(t,e,1,h1(this.qLocalVelocity,this.qLocalVelocityDiv)),this.internalTex1=hV(t,e,1,h1(this.qVelocity,this.qVelocityDiv)),this.internalTex2=hV(t,e,1,function(e,t,s,i,n){let r=Array(4*e.length);for(let a=0;a<e.length;a++)r[4*a]=e[a],r[4*a+1]=t[a],r[4*a+2]=0,r[4*a+3]=h0(s[a],i[a],n[a]);return r}(this.qRotSpeed,this.qScale,this.qScaleDiv,this.qRotSpeedDiv,this.qAlphaDiv)),this.internalTex3=hV(t,e,1,function(e,t){let s=Array(4*e.length);for(let i=0;i<e.length;i++)s[4*i]=e[i],s[4*i+1]=t[i],s[4*i+2]=0,s[4*i+3]=0;return s}(this.qRadialSpeed,this.qRadialSpeedDiv))),this.colorParam=hV(t,e,1,function(e,t){let s=Array(4*t.length);for(let i=0;i<t.length;i++)s[4*i]=e[3*i],s[4*i+1]=e[3*i+1],s[4*i+2]=e[3*i+2],s[4*i+3]=t[i];return s}(this.qColor,this.qAlpha),20,1,true);}_setMaterialTextures(){this.colorMap&&(this.material.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&this.material.setParameter("normalMap",this.normalMap));}_createMaterial(){let e=new hk(this);return e.name="EmitterMaterial:"+this.node.name,e.cull=0,e.alphaWrite=false,e.blendType=this.blendType,e.depthWrite=this.depthWrite,e}resetMaterial(){let e=this.material;e.setParameter("stretch",this.stretch),this._isAnimated()&&(e.setParameter("animTexTilesParams",this.animTilesParams),e.setParameter("animTexParams",this.animParams),e.setParameter("animTexIndexParams",this.animIndexParams)),e.setParameter("colorMult",this.intensity),this.useCpu||(e.setParameter("internalTex0",this.internalTex0),e.setParameter("internalTex1",this.internalTex1),e.setParameter("internalTex2",this.internalTex2),e.setParameter("internalTex3",this.internalTex3)),e.setParameter("colorParam",this.colorParam),e.setParameter("numParticles",this.numParticles),e.setParameter("numParticlesPot",this.numParticlesPot),e.setParameter("lifetime",this.lifetime),e.setParameter("rate",this.rate),e.setParameter("rateDiv",this.rate2-this.rate),e.setParameter("seed",this.seed),e.setParameter("scaleDivMult",this.scaleUMax[0]),e.setParameter("alphaDivMult",this.alphaUMax[0]),e.setParameter("radialSpeedDivMult",this.radialSpeedUMax[0]),e.setParameter("graphNumSamples",this.precision),e.setParameter("graphSampleSize",1/this.precision),e.setParameter("emitterScale",new Float32Array([1,1,1])),this.pack8&&(this._gpuUpdater._setInputBounds(),e.setParameter("inBoundsSize",this._gpuUpdater.inBoundsSizeUniform),e.setParameter("inBoundsCenter",this._gpuUpdater.inBoundsCenterUniform),e.setParameter("maxVel",this.maxVel)),this.wrap&&this.wrapBounds&&(this.wrapBoundsUniform[0]=this.wrapBounds.x,this.wrapBoundsUniform[1]=this.wrapBounds.y,this.wrapBoundsUniform[2]=this.wrapBounds.z,e.setParameter("wrapBounds",this.wrapBoundsUniform)),this._setMaterialTextures(),this.depthSoftening>0&&e.setParameter("softening",1/(this.depthSoftening*this.depthSoftening*100)),this.stretch>0&&(e.cull=0),this._compParticleFaceParams();}_compParticleFaceParams(){let e,t;if(0===this.orientation)e=new Float32Array([1,0,0]),t=new Float32Array([0,0,1]);else {let s;s=1===this.orientation?this.particleNormal.normalize():(null===this.node?ex.IDENTITY:this.node.getWorldTransform()).transformVector(this.particleNormal).normalize();let i=new eu(1,0,0);1===Math.abs(i.dot(s))&&i.set(0,0,1);let n=new eu().cross(s,i).normalize();i.cross(n,s).normalize(),e=new Float32Array([i.x,i.y,i.z]),t=new Float32Array([n.x,n.y,n.z]);}this.material.setParameter("faceTangent",e),this.material.setParameter("faceBinorm",t);}_allocate(e){let t=e*this.numParticleVerts,s=e*this.numParticleIndices;if(void 0===this.vertexBuffer||this.vertexBuffer.getNumVertices()!==t){let i,n,r;let a=[];this.useCpu?a.push({semantic:to,components:4,type:6},{semantic:tl,components:4,type:6},{semantic:th,components:4,type:6},{semantic:td,components:1,type:6},{semantic:tc,components:this.useMesh?4:2,type:6}):(a.push({semantic:to,components:4,type:6}),this.useMesh&&a.push({semantic:tl,components:2,type:6}));let o=new sA(this.graphicsDevice,a);this.vertexBuffer=new sy(this.graphicsDevice,o,t,{usage:1}),this.indexBuffer=new nY(this.graphicsDevice,2,s);let l=new Float32Array(this.vertexBuffer.lock());if(this.useMesh){n=(i=new Float32Array(this.mesh.vertexBuffer.lock())).length/this.mesh.vertexBuffer.numVertices;for(let e=0;e<this.mesh.vertexBuffer.format.elements.length;e++)if(this.mesh.vertexBuffer.format.elements[e].name===e7){r=this.mesh.vertexBuffer.format.elements[e].offset/4;break}}for(let e=0;e<t;e++){let t=Math.floor(e/this.numParticleVerts);if(this.useMesh){let s=e%this.numParticleVerts;l[6*e]=i[s*n],l[6*e+1]=i[s*n+1],l[6*e+2]=i[s*n+2],l[6*e+3]=t,l[6*e+4]=i[s*n+r+0],l[6*e+5]=1-i[s*n+r+1];}else {let s=e%4;l[4*e]=hz[s][0],l[4*e+1]=hz[s][1],l[4*e+2]=0,l[4*e+3]=t;}}this.useCpu&&(this.vbCPU=new Float32Array(l),this.vbOld=new Float32Array(this.vbCPU.length)),this.vertexBuffer.unlock(),this.useMesh&&this.mesh.vertexBuffer.unlock();let h=0,d=new Uint32Array(this.indexBuffer.lock());if(this.useMesh){let e=this.mesh.indexBuffer[0];i=new tZ[e.format](e.lock());}for(let t=0;t<e;t++)if(this.useMesh)for(let e=0;e<this.numParticleIndices;e++)d[t*this.numParticleIndices+e]=i[e]+t*this.numParticleVerts;else {let e=4*t;d[h++]=e,d[h++]=e+1,d[h++]=e+2,d[h++]=e,d[h++]=e+2,d[h++]=e+3;}this.indexBuffer.unlock(),this.useMesh&&this.mesh.indexBuffer[0].unlock();}}reset(){if(this.beenReset=true,this.seed=Math.random(),this.material.setParameter("seed",this.seed),this.useCpu)for(let e=0;e<this.particleTexStart.length;e++)this.particleTex[e]=this.particleTexStart[e];else this._setMaterialTextures();this.resetWorldBounds(),this.resetTime();let e=this.loop;this.loop=true,this.addTime(0,false),this.loop=e,this.preWarm&&this.prewarm(this.lifetime);}prewarm(e){let t=Math.min(Math.floor(e/this.lifetime*this.precision),this.precision),s=e/t;for(let e=0;e<t;e++)this.addTime(s,false);}resetTime(){this.endTime=function(e){let t=Math.max(e.rate,e.rate2)*e.numParticles+e.lifetime;return Date.now()+1e3*t}(this);}finishFrame(){this.useCpu&&this.vertexBuffer.unlock();}addTime(e,t){let s;let i=this.graphicsDevice;if(this.simTimeTotal+=e,this.calculateWorldBounds(),this._isAnimated()){let e=this.animTilesParams;e[0]=1/this.animTilesX,e[1]=1/this.animTilesY;let t=this.animParams;t[0]=this.animStartFrame,t[1]=this.animNumFrames*this.animSpeed,t[2]=this.animNumFrames-1,t[3]=this.animNumAnimations-1;let s=this.animIndexParams;s[0]=this.animIndex,s[1]=this.randomizeAnimIndex;}this.scene&&this.camera!==this.scene._activeCamera&&(this.camera=this.scene._activeCamera,this.onChangeCamera()),0===this.emitterShape&&(hq[0]=0!==this.emitterExtents.x?this.emitterExtentsInner.x/this.emitterExtents.x:0,hq[1]=0!==this.emitterExtents.y?this.emitterExtentsInner.y/this.emitterExtents.y:0,hq[2]=0!==this.emitterExtents.z?this.emitterExtentsInner.z/this.emitterExtents.z:0,null===this.meshInstance.node?hK.setTRS(eu.ZERO,eT.IDENTITY,this.emitterExtents):hK.setTRS(eu.ZERO,this.meshInstance.node.getRotation(),hZ.copy(this.emitterExtents).mul(this.meshInstance.node.localScale)));let n=null===this.meshInstance.node?eu.ONE:this.meshInstance.node.localScale;if(this.emitterScaleUniform[0]=n.x,this.emitterScaleUniform[1]=n.y,this.emitterScaleUniform[2]=n.z,this.material.setParameter("emitterScale",this.emitterScaleUniform),this.localSpace&&this.meshInstance.node&&(s=this.meshInstance.node.getPosition(),this.emitterPosUniform[0]=s.x,this.emitterPosUniform[1]=s.y,this.emitterPosUniform[2]=s.z,this.material.setParameter("emitterPos",this.emitterPosUniform)),this._compParticleFaceParams(),this.useCpu){let i=new Float32Array(this.vertexBuffer.lock());this._cpuUpdater.update(i,this.vbToSort,this.particleTex,hK,hq,s,e,t);}else this._gpuUpdater.update(i,hK,hq,e,t);!this.loop&&Date.now()>this.endTime&&(this.onFinished&&this.onFinished(),this.meshInstance.visible=false),this.meshInstance&&(this.meshInstance.drawOrder=this.drawOrder);}_destroyResources(){var e,t,s,i,n,r,a,o,l,h,d,c;null==(e=this.particleTexIN)||e.destroy(),this.particleTexIN=null,null==(t=this.particleTexOUT)||t.destroy(),this.particleTexOUT=null,this.particleTexStart&&this.particleTexStart.destroy&&(this.particleTexStart.destroy(),this.particleTexStart=null),null==(s=this.rtParticleTexIN)||s.destroy(),this.rtParticleTexIN=null,null==(i=this.rtParticleTexOUT)||i.destroy(),this.rtParticleTexOUT=null,null==(n=this.internalTex0)||n.destroy(),this.internalTex0=null,null==(r=this.internalTex1)||r.destroy(),this.internalTex1=null,null==(a=this.internalTex2)||a.destroy(),this.internalTex2=null,null==(o=this.internalTex3)||o.destroy(),this.internalTex3=null,null==(l=this.colorParam)||l.destroy(),this.colorParam=null,null==(h=this.vertexBuffer)||h.destroy(),this.vertexBuffer=void 0,null==(d=this.indexBuffer)||d.destroy(),this.indexBuffer=void 0,null==(c=this.material)||c.destroy(),this.material=null;}destroy(){this.camera=null,this._destroyResources();}constructor(e,t){this.material=null,this.internalTex0=null,this.internalTex1=null,this.internalTex2=null,this.colorParam=null,this.graphicsDevice=e,this.precision=32,this._addTimeTime=0,s=this,i=t,h$("numParticles",1),this.numParticles>e.maxTextureSize&&(this.numParticles=e.maxTextureSize),h$("rate",1),h$("rate2",this.rate),h$("lifetime",50),h$("emitterExtents",new eu(0,0,0)),h$("emitterExtentsInner",new eu(0,0,0)),h$("emitterRadius",0),h$("emitterRadiusInner",0),h$("emitterShape",0),h$("initialVelocity",1),h$("wrap",false),h$("localSpace",false),h$("screenSpace",false),h$("wrapBounds",null),h$("colorMap",this.defaultParamTexture),h$("normalMap",null),h$("loop",true),h$("preWarm",false),h$("sort",0),h$("mode",0),h$("scene",null),h$("lighting",false),h$("halfLambert",false),h$("intensity",1),h$("stretch",0),h$("alignToMotion",false),h$("depthSoftening",0),h$("mesh",null),h$("particleNormal",new eu(0,1,0)),h$("orientation",0),h$("depthWrite",false),h$("noFog",false),h$("blendType",2),h$("node",null),h$("startAngle",0),h$("startAngle2",this.startAngle),h$("animTilesX",1),h$("animTilesY",1),h$("animStartFrame",0),h$("animNumFrames",1),h$("animNumAnimations",1),h$("animIndex",0),h$("randomizeAnimIndex",false),h$("animSpeed",1),h$("animLoop",true),this._gpuUpdater=new hF(this,e),this._cpuUpdater=new hR(this),this.emitterPosUniform=new Float32Array(3),this.wrapBoundsUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),h$("colorGraph",hY),h$("colorGraph2",this.colorGraph),h$("scaleGraph",hW),h$("scaleGraph2",this.scaleGraph),h$("alphaGraph",hW),h$("alphaGraph2",this.alphaGraph),h$("localVelocityGraph",hX),h$("localVelocityGraph2",this.localVelocityGraph),h$("velocityGraph",hX),h$("velocityGraph2",this.velocityGraph),h$("rotationSpeedGraph",hH),h$("rotationSpeedGraph2",this.rotationSpeedGraph),h$("radialSpeedGraph",hH),h$("radialSpeedGraph2",this.radialSpeedGraph),this.animTilesParams=new Float32Array(2),this.animParams=new Float32Array(4),this.animIndexParams=new Float32Array(2),this.vbToSort=null,this.vbOld=null,this.particleDistance=null,this.camera=null,this.swapTex=false,this.useMesh=true,this.useCpu=!e.supportsGpuParticles,this.pack8=true,this.localBounds=new eP,this.worldBoundsNoTrail=new eP,this.worldBoundsTrail=[new eP,new eP],this.worldBounds=new eP,this.worldBoundsSize=new eu,this.prevWorldBoundsSize=new eu,this.prevWorldBoundsCenter=new eu,this.prevEmitterExtents=this.emitterExtents,this.prevEmitterRadius=this.emitterRadius,this.worldBoundsMul=new eu,this.worldBoundsAdd=new eu,this.timeToSwitchBounds=0,this.shaderParticleUpdateRespawn=null,this.shaderParticleUpdateNoRespawn=null,this.shaderParticleUpdateOnStop=null,this.numParticleVerts=0,this.numParticleIndices=0,this.material=null,this.meshInstance=null,this.drawOrder=0,this.seed=Math.random(),this.fixedTimeStep=1/60,this.maxSubSteps=10,this.simTime=0,this.simTimeTotal=0,this.beenReset=false,this._layer=null,this.rebuild();}}function h6(){return (h6=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i]);}return e}).apply(this,arguments)}let h8=new class extends av{generateKey(e){let t=e.shaderDesc,s=t.vertexGLSL?sS(t.vertexGLSL):0,i=t.fragmentGLSL?sS(t.fragmentGLSL):0,n=t.vertexWGSL?sS(t.vertexWGSL):0,r=t.fragmentWGSL?sS(t.fragmentWGSL):0,a=av.definesHash(e.defines),o=t.uniqueName+"_"+a+"_"+s+"_"+i+"_"+n+"_"+r;return e.skin&&(o+="_skin"),e.useInstancing&&(o+="_inst"),e.useMorphPosition&&(o+="_morphp"),e.useMorphNormal&&(o+="_morphn"),e.useMorphTextureBasedInt&&(o+="_morphi"),o}createAttributesDefinition(e,t){let s=t.shaderDesc.attributes,i=s?h6({},s):void 0;t.skin&&(i.vertex_boneWeights=e5,i.vertex_boneIndices=e6),(t.useMorphPosition||t.useMorphNormal)&&(i.morph_vertex_id=tT),e.attributes=i;}createVertexDefinition(e,t,s,i){let n=t.shaderDesc,r=new Map(s);r.set("transformInstancingVS","");let a=new Map(t.defines);t.skin&&a.set("SKIN",true),t.useInstancing&&a.set("INSTANCING",true),(t.useMorphPosition||t.useMorphNormal)&&(a.set("MORPHING",true),t.useMorphTextureBasedInt&&a.set("MORPHING_INT",true),t.useMorphPosition&&a.set("MORPHING_POSITION",true),t.useMorphNormal&&a.set("MORPHING_NORMAL",true)),e.vertexCode=i?n.vertexWGSL:n.vertexGLSL,e.vertexIncludes=r,e.vertexDefines=a;}createFragmentDefinition(e,t,s,i){let n=t.shaderDesc,r=new Map(s),a=new Map(t.defines);e.fragmentCode=i?n.fragmentWGSL:n.fragmentGLSL,e.fragmentIncludes=r,e.fragmentDefines=a;}createShaderDefinition(e,t){let s=t.shaderDesc,i=e.isWebGPU&&s.vertexWGSL&&s.fragmentWGSL,n={name:"ShaderMaterial-"+s.uniqueName,shaderLanguage:i?tN:tF,fragmentOutputTypes:s.fragmentOutputTypes,meshUniformBufferFormat:s.meshUniformBufferFormat,meshBindGroupFormat:s.meshBindGroupFormat},r=new Map(Object.entries(h6({},i?oM:am,t.chunks)));return this.createAttributesDefinition(n,t),this.createVertexDefinition(n,t,r,i),this.createFragmentDefinition(n,t,r,i),ne.createDefinition(e,n)}};class h9 extends o8{set shaderDesc(e){if(this._shaderDesc=void 0,e&&(this._shaderDesc={uniqueName:e.uniqueName,attributes:e.attributes,fragmentOutputTypes:e.fragmentOutputTypes,vertexGLSL:e.vertexGLSL,fragmentGLSL:e.fragmentGLSL,vertexWGSL:e.vertexWGSL,fragmentWGSL:e.fragmentWGSL},e.vertexCode||e.fragmentCode||e.shaderLanguage)){var t;let s=null!=(t=e.shaderLanguage)?t:tF;s===tF?(this._shaderDesc.vertexGLSL=e.vertexCode,this._shaderDesc.fragmentGLSL=e.fragmentCode):s===tN&&(this._shaderDesc.vertexWGSL=e.vertexCode,this._shaderDesc.fragmentWGSL=e.fragmentCode);}this.clearVariants();}get shaderDesc(){return this._shaderDesc}copy(e){return super.copy(e),this.shaderDesc=e.shaderDesc,this}getShaderVariant(e){var t;let{objDefs:s}=e,i={defines:aA(this,e),skin:(2&s)!=0,useInstancing:(32&s)!=0,useMorphPosition:(1024&s)!=0,useMorphNormal:(2048&s)!=0,useMorphTextureBasedInt:(8192&s)!=0,pass:e.pass,gamma:e.cameraShaderParams.shaderOutputGamma,toneMapping:e.cameraShaderParams.toneMapping,fog:e.cameraShaderParams.fog,shaderDesc:this.shaderDesc,chunks:null!=(t=this.chunks)?t:{}},n=new af(e.viewUniformFormat,e.viewBindGroupFormat,e.vertexFormat),r=ag(e.device);return r.register("shader-material",h8),r.getProgram("shader-material",i,n,this.userId)}constructor(e){super(),this.shaderDesc=e;}}let h7={linear:"decodeLinear",srgb:"decodeGamma",rgbm:"decodeRGBM",rgbe:"decodeRGBE",rgbp:"decodeRGBP",xy:"unpackNormalXY",xyz:"unpackNormalXYZ"},de={linear:"encodeLinear",srgb:"encodeGamma",rgbm:"encodeRGBM",rgbe:"encodeRGBE",rgbp:"encodeRGBP"};class dt{static decodeFunc(e){var t;return null!=(t=h7[e])?t:"decodeGamma"}static encodeFunc(e){var t;return null!=(t=de[e])?t:"encodeGamma"}static getScreenDepthChunk(e,t){return "\n            "+(t.sceneDepthMapLinear?"#define SCENE_DEPTHMAP_LINEAR":"")+"\n            "+(e.textureFloatRenderable?"#define SCENE_DEPTHMAP_FLOAT":"")+"\n            "+am.screenDepthPS+"\n        "}}let ds=(e,t)=>{let s=t.length/3,i=e.length/3,n=new eu,r=new eu,a=new eu,o=new eu,l=new eu,h=new eu,d=[];for(let t=0;t<e.length;t++)d[t]=0;for(let i=0;i<s;i++){let s=t[3*i],c=t[3*i+1],u=t[3*i+2];n.set(e[3*s],e[3*s+1],e[3*s+2]),r.set(e[3*c],e[3*c+1],e[3*c+2]),a.set(e[3*u],e[3*u+1],e[3*u+2]),o.sub2(r,n),l.sub2(a,n),h.cross(o,l).normalize(),d[3*s]+=h.x,d[3*s+1]+=h.y,d[3*s+2]+=h.z,d[3*c]+=h.x,d[3*c+1]+=h.y,d[3*c+2]+=h.z,d[3*u]+=h.x,d[3*u+1]+=h.y,d[3*u+2]+=h.z;}for(let e=0;e<i;e++){let t=d[3*e],s=d[3*e+1],i=d[3*e+2],n=1/Math.sqrt(t*t+s*s+i*i);d[3*e]*=n,d[3*e+1]*=n,d[3*e+2]*=n;}return d},di=(e,t,s,i)=>{let n=i.length/3,r=e.length/3,a=new eu,o=new eu,l=new eu,h=new ef,d=new ef,c=new ef,u=new eu,p=new eu,f=new Float32Array(3*r),m=new Float32Array(3*r),_=[];for(let t=0;t<n;t++){let n=i[3*t],r=i[3*t+1],_=i[3*t+2];a.set(e[3*n],e[3*n+1],e[3*n+2]),o.set(e[3*r],e[3*r+1],e[3*r+2]),l.set(e[3*_],e[3*_+1],e[3*_+2]),h.set(s[2*n],s[2*n+1]),d.set(s[2*r],s[2*r+1]),c.set(s[2*_],s[2*_+1]);let g=o.x-a.x,v=l.x-a.x,y=o.y-a.y,S=l.y-a.y,x=o.z-a.z,T=l.z-a.z,b=d.x-h.x,E=c.x-h.x,A=d.y-h.y,w=c.y-h.y,C=b*w-E*A;if(0===C)u.set(0,1,0),p.set(1,0,0);else {let e=1/C;u.set((w*g-A*v)*e,(w*y-A*S)*e,(w*x-A*T)*e),p.set((b*v-E*g)*e,(b*S-E*y)*e,(b*T-E*x)*e);}f[3*n+0]+=u.x,f[3*n+1]+=u.y,f[3*n+2]+=u.z,f[3*r+0]+=u.x,f[3*r+1]+=u.y,f[3*r+2]+=u.z,f[3*_+0]+=u.x,f[3*_+1]+=u.y,f[3*_+2]+=u.z,m[3*n+0]+=p.x,m[3*n+1]+=p.y,m[3*n+2]+=p.z,m[3*r+0]+=p.x,m[3*r+1]+=p.y,m[3*r+2]+=p.z,m[3*_+0]+=p.x,m[3*_+1]+=p.y,m[3*_+2]+=p.z;}let g=new eu,v=new eu,y=new eu,S=new eu;for(let e=0;e<r;e++){y.set(t[3*e],t[3*e+1],t[3*e+2]),g.set(f[3*e],f[3*e+1],f[3*e+2]),v.set(m[3*e],m[3*e+1],m[3*e+2]);let s=y.dot(g);S.copy(y).mulScalar(s),S.sub2(g,S).normalize(),_[4*e]=S.x,_[4*e+1]=S.y,_[4*e+2]=S.z,S.cross(y,g),_[4*e+3]=0>S.dot(v)?-1:1;}return _};class dn{calculateNormals(){this.normals=ds(this.positions,this.indices);}calculateTangents(){this.tangents=di(this.positions,this.normals,this.uvs,this.indices);}}class dr extends dn{constructor(e={}){var t,s,i,n,r;super();let a=null!=(t=e.halfExtents)?t:new eu(.5,.5,.5),o=null!=(s=e.widthSegments)?s:1,l=null!=(i=e.lengthSegments)?i:1,h=null!=(n=e.heightSegments)?n:1,d=null!=(r=e.yOffset)?r:0,c=-a.y+d,u=a.y+d,p=[new eu(-a.x,c,a.z),new eu(a.x,c,a.z),new eu(a.x,u,a.z),new eu(-a.x,u,a.z),new eu(a.x,c,-a.z),new eu(-a.x,c,-a.z),new eu(-a.x,u,-a.z),new eu(a.x,u,-a.z)],f=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]],m=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],_=[],g=[],v=[],y=[],S=0,x=(e,t,s)=>{let i=new eu,n=new eu,r=new eu,a=new eu;for(let o=0;o<=t;o++)for(let l=0;l<=s;l++){i.lerp(p[f[e][0]],p[f[e][1]],o/t),n.lerp(p[f[e][0]],p[f[e][2]],l/s),r.sub2(n,p[f[e][0]]),a.add2(i,r);let h=o/t,d=l/s;_.push(a.x,a.y,a.z),g.push(m[e][0],m[e][1],m[e][2]),v.push(h,1-d),d=(.875*d+.0625)/3,h=(.875*h+.0625)/3+e%3/3,d+=Math.floor(e/3)/3,o<t&&l<s&&(y.push(S+s+1,S+1,S),y.push(S+s+1,S+s+2,S+1)),S++;}};x(0,o,h),x(1,o,h),x(2,o,l),x(3,o,l),x(4,l,h),x(5,l,h),this.positions=_,this.normals=g,this.uvs=v,this.uvs1=v,this.indices=y,e.calculateTangents&&(this.tangents=di(_,g,v,y));}}class da extends dn{constructor(e={}){var t,s,i;super();let n=null!=(t=e.radius)?t:.5,r=null!=(s=e.latitudeBands)?s:16,a=null!=(i=e.longitudeBands)?i:16,o=[],l=[],h=[],d=[];for(let e=0;e<=r;e++){let t=e*Math.PI/r,s=Math.sin(t),i=Math.cos(t);for(let t=0;t<=a;t++){let d=2*t*Math.PI/a-Math.PI/2,c=Math.sin(d),u=Math.cos(d)*s,p=c*s,f=1-t/a,m=1-e/r;o.push(u*n,i*n,p*n),l.push(u,i,p),h.push(f,1-m);}}for(let e=0;e<r;++e)for(let t=0;t<a;++t){let s=e*(a+1)+t,i=s+a+1;d.push(s+1,i,s),d.push(s+1,i+1,i);}this.positions=o,this.normals=l,this.uvs=h,this.uvs1=h,this.indices=d,e.calculateTangents&&(this.tangents=di(o,l,h,d));}}class dl extends da{constructor(e={}){var t,s;super({radius:.5,latitudeBands:null!=(t=e.latitudeBands)?t:16,longitudeBands:null!=(s=e.longitudeBands)?s:16});let i=this.positions;for(let e=0;e<i.length;e+=3){let t=i[e]/.5,s=i[e+1]/.5,n=i[e+2]/.5;s<0&&(s*=.3,t*t+n*n<.9025&&(s=-0.1)),s+=.1,s*=.5,i[e+1]=s;}}}class dh{static create(e,t){switch(t){case "box":return dh.box(e);case as:return dh.dome(e)}return dh.infinite(e)}static infinite(e){return aG.fromGeometry(e,new dr(e))}static box(e){return aG.fromGeometry(e,new dr({yOffset:.5}))}static dome(e){let t=new dl({latitudeBands:50,longitudeBands:50});return t.normals=void 0,t.uvs=void 0,aG.fromGeometry(e,t)}}class dd{destroy(){this.meshInstance&&(this.skyLayer&&this.skyLayer.removeMeshInstances([this.meshInstance]),this.meshInstance.destroy(),this.meshInstance=null);}constructor(e,t,s,i,n){this.meshInstance=null;let r=new h9({uniqueName:"SkyMaterial",vertexGLSL:am.skyboxVS,fragmentGLSL:am.skyboxPS,vertexWGSL:oM.skyboxVS,fragmentWGSL:oM.skyboxPS,attributes:{aPosition:e2}});r.setDefine("{SKYBOX_DECODE_FNC}",dt.decodeFunc(i.encoding)),n!==at&&r.setDefine("SKYMESH",""),i.cubemap&&r.setDefine("SKY_CUBEMAP",""),r.setParameter("skyboxHighlightMultiplier",t.skyboxHighlightMultiplier),i.cubemap?r.setParameter("texture_cubeMap",i):(r.setParameter("texture_envAtlas",i),r.setParameter("mipLevel",t.skyboxMip)),r.cull=2,r.depthWrite=false;let a=t.layers.getLayerById(2);if(a){let t=new a0(dh.create(e,n),r,s);this.meshInstance=t,t.cull=false,t.pick=false,a.addMeshInstances([t]),this.skyLayer=a;}}}class dc{applySettings(e){var t,s,i,n;this.type=null!=(t=e.skyType)?t:at,this.node.setLocalPosition(new eu(null!=(s=e.skyMeshPosition)?s:[0,0,0])),this.node.setLocalEulerAngles(new eu(null!=(i=e.skyMeshRotation)?i:[0,0,0])),this.node.setLocalScale(new eu(null!=(n=e.skyMeshScale)?n:[1,1,1])),e.skyCenter&&(this._center=new eu(e.skyCenter));}set type(e){this._type!==e&&(this._type=e,this.scene.updateShaders=true,this.updateSkyMesh());}get type(){return this._type}set center(e){this._center.copy(e);}get center(){return this._center}updateSkyMesh(){let e=this.scene._getSkyboxTex();e&&(this.resetSkyMesh(),this.skyMesh=new dd(this.device,this.scene,this.node,e,this.type),this.scene.fire("set:skybox",e));}resetSkyMesh(){var e;null==(e=this.skyMesh)||e.destroy(),this.skyMesh=null;}update(){if(this.type!==at){let{center:e,centerArray:t}=this,s=new eu;this.node.getWorldTransform().transformPoint(e,s),t[0]=s.x,t[1]=s.y,t[2]=s.z,this.projectedSkydomeCenterId.setValue(t);}}constructor(e){this._type=at,this._center=new eu(0,1,0),this.skyMesh=null,this.node=new oE("SkyMeshNode"),this.device=e.device,this.scene=e,this.center=new eu(0,1,0),this.centerArray=new Float32Array(3),this.projectedSkydomeCenterId=this.device.scope.resolve("projectedSkydomeCenter");}}let du=new oE;du.worldTransform=ex.IDENTITY,du._dirtyWorld=du._dirtyNormal=false;class dp{addLines(e,t){let s=this.positions,i=e.length;for(let t=0;t<i;t++){let i=e[t];s.push(i.x,i.y,i.z);}let n=this.colors;if(t.length)for(let e=0;e<i;e++){let s=t[e];n.push(s.r,s.g,s.b,s.a);}else for(let e=0;e<i;e++)n.push(t.r,t.g,t.b,t.a);}addLinesArrays(e,t){let s=this.positions;for(let t=0;t<e.length;t+=3)s.push(e[t],e[t+1],e[t+2]);let i=this.colors;if(t.length)for(let e=0;e<t.length;e+=4)i.push(t[e],t[e+1],t[e+2],t[e+3]);else {let s=e.length/3;for(let e=0;e<s;e++)i.push(t.r,t.g,t.b,t.a);}}onPreRender(e,t){this.positions.length>0&&this.material.transparent===t&&(this.mesh.setPositions(this.positions),this.mesh.setColors(this.colors),this.mesh.update(1,false),this.meshInstance||(this.meshInstance=new a0(this.mesh,this.material,du)),e.push(this.meshInstance));}clear(){this.positions.length=0,this.colors.length=0;}constructor(e,t,s){this.material=t,this.layer=s,this.positions=[],this.colors=[],this.mesh=new aG(e),this.meshInstance=null;}}class df{getBatch(e,t){let s=this.map.get(e);return s||(s=new dp(this.device,e,t),this.map.set(e,s)),s}onPreRender(e,t){this.map.forEach(s=>{s.onPreRender(e,t);});}clear(){this.map.forEach(e=>e.clear());}constructor(e){this.device=e,this.map=new Map;}}let dm=[],d_=new eu,dg={uniqueName:"ImmediateLine",vertexGLSL:am.immediateLineVS,fragmentGLSL:am.immediateLinePS,vertexWGSL:oM.immediateLineVS,fragmentWGSL:oM.immediateLinePS,attributes:{vertex_position:e2,vertex_color:e8}};class dv{createMaterial(e){let t=new h9(dg);return t.blendType=2,t.depthTest=e,t.update(),t}get materialDepth(){return this._materialDepth||(this._materialDepth=this.createMaterial(true)),this._materialDepth}get materialNoDepth(){return this._materialNoDepth||(this._materialNoDepth=this.createMaterial(false)),this._materialNoDepth}getBatch(e,t){let s=this.batchesMap.get(e);s||(s=new df(this.device),this.batchesMap.set(e,s)),this.allBatches.add(s);let i=t?this.materialDepth:this.materialNoDepth;return s.getBatch(i,e)}getShaderDesc(e,t){return this.shaderDescs.has(e)||this.shaderDescs.set(e,{uniqueName:"DebugShader:"+e,vertexGLSL:"\n				attribute vec2 vertex_position;\n				uniform mat4 matrix_model;\n				varying vec2 uv0;\n				void main(void) {\n					gl_Position = matrix_model * vec4(vertex_position, 0, 1);\n					uv0 = vertex_position.xy + 0.5;\n				}\n			",fragmentGLSL:t,attributes:{vertex_position:e2}}),this.shaderDescs.get(e)}getTextureShaderDesc(e){let t=dt.decodeFunc(e);return this.getShaderDesc("textureShader-"+e,'\n			#include "gammaPS"\n			varying vec2 uv0;\n			uniform sampler2D colorMap;\n			void main (void) {\n				vec3 linearColor = '+t+"(texture2D(colorMap, uv0));\n				gl_FragColor = vec4(gammaCorrectOutput(linearColor), 1);\n			}\n		")}getUnfilterableTextureShaderDesc(){return this.getShaderDesc("textureShaderUnfilterable","\n			varying vec2 uv0;\n			uniform highp sampler2D colorMap;\n			void main (void) {\n				ivec2 uv = ivec2(uv0 * textureSize(colorMap, 0));\n				gl_FragColor = vec4(texelFetch(colorMap, uv, 0).xyz, 1);\n			}\n		")}getDepthTextureShaderDesc(){return this.getShaderDesc("depthTextureShader","\n			"+am.screenDepthPS+'\n			#include "gammaPS"\n			varying vec2 uv0;\n			void main() {\n				float depth = getLinearScreenDepth(getImageEffectUV(uv0)) * camera_params.x;\n				gl_FragColor = vec4(gammaCorrectOutput(vec3(depth)), 1.0);\n			}\n		')}getQuadMesh(){return this.quadMesh||(this.quadMesh=new aG(this.device),this.quadMesh.setPositions([-0.5,-0.5,0,.5,-0.5,0,-0.5,.5,0,.5,.5,0]),this.quadMesh.update(5)),this.quadMesh}drawMesh(e,t,s,i,n){i||(i=new a0(s,e,this.getGraphNode(t)));let r=this.layerMeshInstances.get(n);r||(r=[],this.layerMeshInstances.set(n,r)),r.push(i);}drawWireAlignedBox(e,t,s,i,n,r){if(r){let s=(e,t,s)=>{d_.set(e,t,s),r.transformPoint(d_,d_),dm.push(d_.x,d_.y,d_.z);};s(e.x,e.y,e.z),s(e.x,t.y,e.z),s(e.x,t.y,e.z),s(t.x,t.y,e.z),s(t.x,t.y,e.z),s(t.x,e.y,e.z),s(t.x,e.y,e.z),s(e.x,e.y,e.z),s(e.x,e.y,t.z),s(e.x,t.y,t.z),s(e.x,t.y,t.z),s(t.x,t.y,t.z),s(t.x,t.y,t.z),s(t.x,e.y,t.z),s(t.x,e.y,t.z),s(e.x,e.y,t.z),s(e.x,e.y,e.z),s(e.x,e.y,t.z),s(e.x,t.y,e.z),s(e.x,t.y,t.z),s(t.x,t.y,e.z),s(t.x,t.y,t.z),s(t.x,e.y,e.z),s(t.x,e.y,t.z);}else dm.push(e.x,e.y,e.z,e.x,t.y,e.z,e.x,t.y,e.z,t.x,t.y,e.z,t.x,t.y,e.z,t.x,e.y,e.z,t.x,e.y,e.z,e.x,e.y,e.z,e.x,e.y,t.z,e.x,t.y,t.z,e.x,t.y,t.z,t.x,t.y,t.z,t.x,t.y,t.z,t.x,e.y,t.z,t.x,e.y,t.z,e.x,e.y,t.z,e.x,e.y,e.z,e.x,e.y,t.z,e.x,t.y,e.z,e.x,t.y,t.z,t.x,t.y,e.z,t.x,t.y,t.z,t.x,e.y,e.z,t.x,e.y,t.z);this.getBatch(n,i).addLinesArrays(dm,s),dm.length=0;}drawWireSphere(e,t,s,i,n,r){let a=2*Math.PI/i,o=0;for(let s=0;s<i;s++){let s=Math.sin(o),i=Math.cos(o),n=Math.sin(o+=a),r=Math.cos(o);dm.push(e.x+t*s,e.y,e.z+t*i),dm.push(e.x+t*n,e.y,e.z+t*r),dm.push(e.x+t*s,e.y+t*i,e.z),dm.push(e.x+t*n,e.y+t*r,e.z),dm.push(e.x,e.y+t*s,e.z+t*i),dm.push(e.x,e.y+t*n,e.z+t*r);}this.getBatch(r,n).addLinesArrays(dm,s),dm.length=0;}getGraphNode(e){let t=new oE("ImmediateDebug");return t.worldTransform=e,t._dirtyWorld=t._dirtyNormal=false,t}onPreRenderLayer(e,t,s){if(this.batchesMap.forEach((i,n)=>{n===e&&i.onPreRender(t,s);}),!this.updatedLayers.has(e)){this.updatedLayers.add(e);let s=this.layerMeshInstances.get(e);if(s){for(let e=0;e<s.length;e++)t.push(s[e]);s.length=0;}}}onPostRender(){this.allBatches.forEach(e=>e.clear()),this.allBatches.clear(),this.updatedLayers.clear();}constructor(e){this.shaderDescs=new Map,this.device=e,this.quadMesh=null,this.textureShader=null,this.depthTextureShader=null,this.cubeLocalPos=null,this.cubeWorldPos=null,this.batchesMap=new Map,this.allBatches=new Set,this.updatedLayers=new Set,this._materialDepth=null,this._materialNoDepth=null,this.layerMeshInstances=new Map;}}let dy={circlePoint(e){let t=Math.sqrt(Math.random()),s=2*Math.random()*Math.PI;e.x=t*Math.cos(s),e.y=t*Math.sin(s);},circlePointDeterministic(e,t,s){let i=2.399963229728653*t,n=Math.sqrt(t)/Math.sqrt(s);e.x=n*Math.cos(i),e.y=n*Math.sin(i);},spherePointDeterministic(e,t,s,i,n){ void 0===i&&(i=0),void 0===n&&(n=1),i=1-2*i,n=1-2*n;let r=ei.lerp(i,n,t/s),a=Math.sqrt(1-r*r),o=2.399963229728653*t;e.x=Math.cos(o)*a,e.y=r,e.z=Math.sin(o)*a;},radicalInverse(e){let t=(e<<16|e>>>16)>>>0;return 23283064365386963e-26*(t=((0xff00ff&(t=((0xf0f0f0f&(t=((0x33333333&(t=((0x55555555&t)<<1|(0xaaaaaaaa&t)>>>1)>>>0))<<2|(0xcccccccc&t)>>>2)>>>0))<<4|(0xf0f0f0f0&t)>>>4)>>>0))<<8|(0xff00ff00&t)>>>8)>>>0)}},dS=e=>{switch(e){case tL:return "Cubemap";case tO:return "Octahedral";default:return "Equirect"}},dx=(e,t,s)=>{if(e<=0)t[s+0]=0,t[s+1]=0,t[s+2]=0,t[s+3]=0;else if(e>=1)t[s+0]=255,t[s+1]=0,t[s+2]=0,t[s+3]=0;else {let i=+e%1,n=255*e%1,r=65025*e%1,a=0xfd02ff*e%1;i-=n/255,n-=r/255,r-=a/255,t[s+0]=Math.min(255,Math.floor(256*i)),t[s+1]=Math.min(255,Math.floor(256*n)),t[s+2]=Math.min(255,Math.floor(256*r)),t[s+3]=Math.min(255,Math.floor(256*a));}},dT=e=>{let t=e.length,s=Math.min(t,512),i=Math.ceil(t/s),n=new Uint8Array(s*i*4),r=0;for(let s=0;s<t;s+=4)dx(.5*e[s+0]+.5,n,r+0),dx(.5*e[s+1]+.5,n,r+4),dx(.5*e[s+2]+.5,n,r+8),dx(e[s+3]/8,n,r+12),r+=16;return {width:s,height:i,data:n}},db=(e,t,s,i)=>{let n=2*s*Math.PI,r=Math.pow(1-t,1/(i+1)),a=Math.sqrt(1-r*r);e.set(Math.cos(n)*a,Math.sin(n)*a,r).normalize();},dE=(e,t,s)=>{let i=2*s*Math.PI,n=Math.sqrt(1-t),r=Math.sqrt(t);e.set(Math.cos(i)*r,Math.sin(i)*r,n).normalize();},dA=(e,t,s,i)=>{let n=2*s*Math.PI,r=Math.sqrt((1-t)/(1+(i*i-1)*t)),a=Math.sqrt(1-r*r);e.set(Math.cos(n)*a,Math.sin(n)*a,r).normalize();},dw=(e,t)=>{let s=e*t,i=t/(1-e*e+s*s);return i*i*(1/Math.PI)},dC=(e,t)=>{let s=new eu,i=[];for(let n=0;n<e;++n)db(s,n/e,dy.radicalInverse(n),t),i.push(s.x,s.y,s.z,0);return i},dP=(e,t)=>{let s=t/e,i=new eu,n=[];for(let t=0;t<e;++t){dE(i,t/e,dy.radicalInverse(t));let r=.5*Math.log2(s/(i.z/Math.PI));n.push(i.x,i.y,i.z,r);}return n},dM={16:{2:26,8:20,32:17,128:16,512:16},32:{2:53,8:40,32:34,128:32,512:32},128:{2:214,8:163,32:139,128:130,512:128},1024:{2:1722,8:1310,32:1114,128:1041,512:1025}},dI=(e,t)=>{let s=dM[e];return s&&s[t]||e},dR=(e,t,s)=>{let i=s/e,n=1-Math.log2(t)/11,r=n*n,a=new eu,o=new eu,l=new eu(0,0,1),h=[],d=dI(e,t);for(let e=0;e<d;++e){dA(a,e/d,dy.radicalInverse(e),r);let t=a.z;if(o.set(a.x,a.y,a.z).mulScalar(2*t).sub(l),o.z>0){let e=.5*Math.log2(i/(dw(Math.min(1,t),r)/4+.001));h.push(o.x,o.y,o.z,e);}}for(;h.length<4*e;)h.push(0,0,0,0);return h},dL=(e,t,s)=>{let i=dT(s);return new se(e,{name:t,width:i.width,height:i.height,mipmaps:false,minFilter:0,magFilter:0,levels:[i.data]})};class dD{destroy(){this.destroyContent&&this.map.forEach((e,t)=>{e.destroy();});}get(e,t){if(!this.map.has(e)){let s=t();return this.map.set(e,s),s}return this.map.get(e)}constructor(e=true){this.map=new Map,this.destroyContent=e;}}let dO=new dD(false),dF=new t8,dN=(e,t,s)=>dF.get(e,()=>new dD).get(t,()=>dL(e,t,dO.get(t,s))),dB=(e,t,s)=>dN(e,"lambert-samples-"+t+"-"+s,()=>dP(t,s)),dU=(e,t,s)=>dN(e,"phong-samples-"+t+"-"+s,()=>dC(t,s)),dk=(e,t,s,i)=>dN(e,"ggx-samples-"+t+"-"+s+"-"+i,()=>dR(t,s,i));function dz(e,t,s){var i,n,r,a,o;void 0===s&&(s={});let l=null!=(r=s.seamPixels)?r:0,h=(null!=(a=null==(i=s.rect)?void 0:i.z)?a:t.width)-2*l,d=(null!=(o=null==(n=s.rect)?void 0:n.w)?o:t.height)-2*l;if(h<1||d<1)return  false;let c=s.hasOwnProperty("specularPower")?s.specularPower:1,u=s.hasOwnProperty("face")?s.face:null,p=s.hasOwnProperty("distribution")?s.distribution:1===c?"none":"phong",f={none:"reproject",lambert:"prefilterSamplesUnweighted",phong:"prefilterSamplesUnweighted",ggx:"prefilterSamples"}[p]||"reproject",m=f.startsWith("prefilterSamples"),_=dt.decodeFunc(e.encoding),g=dt.encodeFunc(t.encoding),v="sample"+dS(e.projection),y="getDirection"+dS(t.projection),S=s.hasOwnProperty("numSamples")?s.numSamples:1024,x=f+"_"+_+"_"+g+"_"+v+"_"+y+"_"+S,T=e.device,b=ag(T).getCachedShader(x);if(!b){let t="\n            "+(m?"#define USE_SAMPLES_TEX":"")+"\n            "+(e.cubemap?"#define CUBEMAP_SOURCE":"")+"\n            #define {PROCESS_FUNC} "+f+"\n            #define {DECODE_FUNC} "+_+"\n            #define {ENCODE_FUNC} "+g+"\n            #define {SOURCE_FUNC} "+v+"\n            #define {TARGET_FUNC} "+y+"\n            #define {NUM_SAMPLES} "+S+"\n            #define {NUM_SAMPLES_SQRT} "+Math.round(Math.sqrt(S)).toFixed(1)+"\n        ",s=T.isWebGPU,i=s?oM:am,n=new Map;n.set("decodePS",i.decodePS),n.set("encodePS",i.encodePS),b=ab(T,i.reprojectVS,"\n                "+t+"\n                "+i.reprojectPS+"\n            ",x,{vertex_position:e2},{fragmentIncludes:n,shaderLanguage:s?tN:tF});}T.setBlendState(sh.NOBLEND),T.scope.resolve(e.cubemap?"sourceCube":"sourceTex").setValue(e);let E=T.scope.resolve("params"),A=T.scope.resolve("uvMod");l>0?A.setValue([(h+2*l)/h,(d+2*l)/d,-l/h,-l/d]):A.setValue([1,1,0,0]);let w=[0,t.width*t.height*(t.cubemap?6:1),e.width*e.height*(e.cubemap?6:1)];if(m){let t=e.width*e.height*(e.cubemap?6:1),s="ggx"===p?dk(T,S,c,t):"lambert"===p?dB(T,S,t):dU(T,S,c);T.scope.resolve("samplesTex").setValue(s),T.scope.resolve("samplesTexInverseSize").setValue([1/s.width,1/s.height]);}for(let e=0;e<(t.cubemap?6:1);e++)if(null===u||e===u){let i=new sR({colorBuffer:t,face:e,depth:false,flipY:T.isWebGPU});w[0]=e,E.setValue(w),aD(T,i,b,null==s?void 0:s.rect),i.destroy();}return  true}let dV=(e,t)=>(void 0===t&&(t=0),1+Math.floor(Math.log2(Math.max(e,t)))),dG=e=>e.textureHalfFloatRenderable,dH=e=>e.textureFloatRenderable,dW=e=>dG(e)?12:dH(e)?14:7,dX=e=>7,dY=(e,t,s,i)=>new se(e,{name:"lighting-"+t,cubemap:true,width:t,height:t,format:s,type:tw,addressU:1,addressV:1,mipmaps:false});class dj{static generateSkyboxCubemap(e,t){let s=dY(e.device,t||(e.cubemap?e.width:e.width/4),7);return dz(e,s,{numSamples:1024}),s}static generateLightingSource(e,t){let s=e.device,i=dW(s),n=(null==t?void 0:t.target)||new se(s,{name:"lighting-source",cubemap:true,width:(null==t?void 0:t.size)||128,height:(null==t?void 0:t.size)||128,format:i,type:7===i?tw:tb,addressU:1,addressV:1,mipmaps:true});return dz(e,n,{numSamples:e.mipmaps?1:1024}),n}static generateAtlas(e,t){let s=e.device,i=dX(),n=(null==t?void 0:t.target)||new se(s,{name:"envAtlas",width:(null==t?void 0:t.size)||512,height:(null==t?void 0:t.size)||512,format:i,type:tw,projection:tD,addressU:1,addressV:1,mipmaps:false}),r=n.width/512,a=new em(0,0,512*r,256*r),o=dV(256)-dV(4);for(let t=0;t<o;++t)dz(e,n,{numSamples:1,rect:a,seamPixels:r}),a.x+=a.w,a.y+=a.w,a.z=Math.max(1,Math.floor(.5*a.z)),a.w=Math.max(1,Math.floor(.5*a.w));a.set(0,256*r,256*r,128*r);for(let s=1;s<7;++s)dz(e,n,{numSamples:(null==t?void 0:t.numReflectionSamples)||1024,distribution:(null==t?void 0:t.distribution)||"ggx",specularPower:Math.max(1,2048>>2*s),rect:a,seamPixels:r}),a.y+=a.w,a.z=Math.max(1,Math.floor(.5*a.z)),a.w=Math.max(1,Math.floor(.5*a.w));return a.set(128*r,384*r,64*r,32*r),dz(e,n,{numSamples:(null==t?void 0:t.numAmbientSamples)||2048,distribution:"lambert",rect:a,seamPixels:r}),n}static generatePrefilteredAtlas(e,t){let s=e[0].device,i=e[0].format,n=e[0].type,r=(null==t?void 0:t.target)||new se(s,{name:"envPrefilteredAtlas",width:(null==t?void 0:t.size)||512,height:(null==t?void 0:t.size)||512,format:i,type:n,projection:tD,addressU:1,addressV:1,mipmaps:false}),a=r.width/512,o=new em(0,0,512*a,256*a),l=dV(512);for(let t=0;t<l;++t)dz(e[0],r,{numSamples:1,rect:o,seamPixels:a}),o.x+=o.w,o.y+=o.w,o.z=Math.max(1,Math.floor(.5*o.z)),o.w=Math.max(1,Math.floor(.5*o.w));o.set(0,256*a,256*a,128*a);for(let t=1;t<e.length;++t)dz(e[t],r,{numSamples:1,rect:o,seamPixels:a}),o.y+=o.w,o.z=Math.max(1,Math.floor(.5*o.z)),o.w=Math.max(1,Math.floor(.5*o.w));return o.set(128*a,384*a,64*a,32*a),(null==t?void 0:t.legacyAmbient)?dz(e[5],r,{numSamples:1,rect:o,seamPixels:a}):dz(e[0],r,{numSamples:(null==t?void 0:t.numSamples)||2048,distribution:"lambert",rect:o,seamPixels:a}),r}}class dq{constructor(){this.type=rH,this.color=new en(0,0,0),this.density=0,this.start=1,this.end=1e3;}}class dK extends Y{get defaultDrawLayer(){return this.layers.getLayerById(3)}set ambientBakeNumSamples(e){this._ambientBakeNumSamples=ei.clamp(Math.floor(e),1,255);}get ambientBakeNumSamples(){return this._ambientBakeNumSamples}set ambientBakeSpherePart(e){this._ambientBakeSpherePart=ei.clamp(e,.001,1);}get ambientBakeSpherePart(){return this._ambientBakeSpherePart}set clusteredLightingEnabled(e){(!this.device.isWebGPU||e)&&(this._clusteredLightingEnabled||!e)&&(this._clusteredLightingEnabled=e);}get clusteredLightingEnabled(){return this._clusteredLightingEnabled}set envAtlas(e){e!==this._envAtlas&&(this._envAtlas=e,e&&(e.addressU=1,e.addressV=1,e.minFilter=1,e.magFilter=1,e.mipmaps=false),this._prefilteredCubemaps=[],this._internalEnvAtlas&&(this._internalEnvAtlas.destroy(),this._internalEnvAtlas=null),this._resetSkyMesh());}get envAtlas(){return this._envAtlas}set layers(e){let t=this._layers;this._layers=e,this.fire("set:layers",t,e);}get layers(){return this._layers}get sky(){return this._sky}get lighting(){return this._lightingParams}get fog(){return this._fogParams}set lightmapFilterRange(e){this._lightmapFilterRange=Math.max(e,.001);}get lightmapFilterRange(){return this._lightmapFilterRange}set lightmapFilterSmoothness(e){this._lightmapFilterSmoothness=Math.max(e,.001);}get lightmapFilterSmoothness(){return this._lightmapFilterSmoothness}set prefilteredCubemaps(e){e=e||[];let t=this._prefilteredCubemaps;(t.length!==e.length||t.some((t,s)=>t!==e[s]))&&(6===e.length&&e.every(e=>!!e)?(this._internalEnvAtlas=dj.generatePrefilteredAtlas(e,{target:this._internalEnvAtlas}),this._envAtlas=this._internalEnvAtlas):(this._internalEnvAtlas&&(this._internalEnvAtlas.destroy(),this._internalEnvAtlas=null),this._envAtlas=null),this._prefilteredCubemaps=e.slice(),this._resetSkyMesh());}get prefilteredCubemaps(){return this._prefilteredCubemaps}set skybox(e){e!==this._skyboxCubeMap&&(this._skyboxCubeMap=e,this._resetSkyMesh());}get skybox(){return this._skyboxCubeMap}set skyboxIntensity(e){e!==this._skyboxIntensity&&(this._skyboxIntensity=e,this._resetSkyMesh());}get skyboxIntensity(){return this._skyboxIntensity}set skyboxLuminance(e){e!==this._skyboxLuminance&&(this._skyboxLuminance=e,this._resetSkyMesh());}get skyboxLuminance(){return this._skyboxLuminance}set skyboxMip(e){e!==this._skyboxMip&&(this._skyboxMip=e,this._resetSkyMesh());}get skyboxMip(){return this._skyboxMip}set skyboxHighlightMultiplier(e){e!==this._skyboxHighlightMultiplier&&(this._skyboxHighlightMultiplier=e,this._resetSkyMesh());}get skyboxHighlightMultiplier(){return this._skyboxHighlightMultiplier}set skyboxRotation(e){if(!this._skyboxRotation.equals(e)){let t=e.equals(eT.IDENTITY);this._skyboxRotation.copy(e),t?this._skyboxRotationMat3.setIdentity():(this._skyboxRotationMat4.setTRS(eu.ZERO,e,eu.ONE),this._skyboxRotationMat3.invertMat4(this._skyboxRotationMat4)),this._skyboxRotationShaderInclude||t||(this._skyboxRotationShaderInclude=true,this._resetSkyMesh());}}get skyboxRotation(){return this._skyboxRotation}destroy(){this._resetSkyMesh(),this.root=null,this.off();}drawLine(e,t,s,i,n){ void 0===s&&(s=en.WHITE),void 0===i&&(i=true),void 0===n&&(n=this.defaultDrawLayer),this.immediate.getBatch(n,i).addLines([e,t],[s,s]);}drawLines(e,t,s,i){ void 0===s&&(s=true),void 0===i&&(i=this.defaultDrawLayer),this.immediate.getBatch(i,s).addLines(e,t);}drawLineArrays(e,t,s,i){ void 0===s&&(s=true),void 0===i&&(i=this.defaultDrawLayer),this.immediate.getBatch(i,s).addLinesArrays(e,t);}applySettings(e){var t,s,i,n;let r=e.physics,a=e.render;this._gravity.set(r.gravity[0],r.gravity[1],r.gravity[2]),this.ambientLight.set(a.global_ambient[0],a.global_ambient[1],a.global_ambient[2]),this.ambientLuminance=a.ambientLuminance,this.fog.type=a.fog,this.fog.color.set(a.fog_color[0],a.fog_color[1],a.fog_color[2]),this.fog.start=a.fog_start,this.fog.end=a.fog_end,this.fog.density=a.fog_density,this.lightmapSizeMultiplier=a.lightmapSizeMultiplier,this.lightmapMaxResolution=a.lightmapMaxResolution,this.lightmapMode=a.lightmapMode,this.exposure=a.exposure,this._skyboxIntensity=null!=(t=a.skyboxIntensity)?t:1,this._skyboxLuminance=null!=(s=a.skyboxLuminance)?s:2e4,this._skyboxMip=null!=(i=a.skyboxMip)?i:0,a.skyboxRotation&&(this.skyboxRotation=new eT().setFromEulerAngles(a.skyboxRotation[0],a.skyboxRotation[1],a.skyboxRotation[2])),this.sky.applySettings(a),this.clusteredLightingEnabled=null!=(n=a.clusteredLightingEnabled)&&n,this.lighting.applySettings(a),["lightmapFilterEnabled","lightmapFilterRange","lightmapFilterSmoothness","ambientBake","ambientBakeNumSamples","ambientBakeSpherePart","ambientBakeOcclusionBrightness","ambientBakeOcclusionContrast"].forEach(e=>{a.hasOwnProperty(e)&&(this[e]=a[e]);}),this._resetSkyMesh();}_getSkyboxTex(){let e=this._prefilteredCubemaps;return this._skyboxMip?e[[0,1,3,4,5,6][this._skyboxMip]]||this._envAtlas||e[0]||this._skyboxCubeMap:this._skyboxCubeMap||e[0]||this._envAtlas}_updateSkyMesh(){this.sky.skyMesh||this.sky.updateSkyMesh(),this.sky.update();}_resetSkyMesh(){this.sky.resetSkyMesh(),this.updateShaders=true;}setSkybox(e){e?(this.skybox=e[0]||null,e[1]&&!e[1].cubemap?this.envAtlas=e[1]:this.prefilteredCubemaps=e.slice(1)):(this.skybox=null,this.envAtlas=null);}get lightmapPixelFormat(){return this.lightmapHDR&&this.device.getRenderableHdrFormat()||7}constructor(e){super(),this.ambientBake=false,this.ambientBakeOcclusionBrightness=0,this.ambientBakeOcclusionContrast=0,this.ambientLight=new en(0,0,0),this.ambientLuminance=0,this.exposure=1,this.lightmapSizeMultiplier=1,this.lightmapMaxResolution=2048,this.lightmapMode=1,this.lightmapFilterEnabled=false,this.lightmapHDR=false,this.root=null,this.physicalUnits=false,this._envAtlas=null,this._skyboxCubeMap=null,this._fogParams=new dq,this.forcePassThroughSpecular=false,this.device=e,this._gravity=new eu(0,-9.8,0),this._layers=null,this._prefilteredCubemaps=[],this._internalEnvAtlas=null,this._skyboxIntensity=1,this._skyboxLuminance=0,this._skyboxMip=0,this._skyboxHighlightMultiplier=1,this._skyboxRotationShaderInclude=false,this._skyboxRotation=new eT,this._skyboxRotationMat3=new ep,this._skyboxRotationMat4=new ex,this._ambientBakeNumSamples=1,this._ambientBakeSpherePart=.4,this._lightmapFilterRange=10,this._lightmapFilterSmoothness=.2,this._clusteredLightingEnabled=true,this._lightingParams=new ha(this.device.supportsAreaLights,this.device.maxTextureSize,()=>{this.updateShaders=true;}),this._sky=new dc(this),this._stats={meshInstances:0,lights:0,dynamicLights:0,bakedLights:0,updateShadersTime:0},this.updateShaders=true,this._shaderVersion=0,this.immediate=new dv(this.device);}}dK.EVENT_SETLAYERS="set:layers",dK.EVENT_SETSKYBOX="set:skybox",dK.EVENT_PRERENDER="prerender",dK.EVENT_POSTRENDER="postrender",dK.EVENT_PRERENDER_LAYER="prerender:layer",dK.EVENT_POSTRENDER_LAYER="postrender:layer",dK.EVENT_PRECULL="precull",dK.EVENT_POSTCULL="postcull";class dZ{constructor(e,t,s){this.device=e,this.inverseBindPose=t,this.boneNames=s;}}let dQ=[0,0,1,0,0,1,0,0,1,0,0,1],dJ=[0,1,3,2,3,1];class d$ extends Y{set frameKeys(e){this._frameKeys=e,this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=true:this._createMeshes()),this.fire("set:frameKeys",e);}get frameKeys(){return this._frameKeys}set atlas(e){e!==this._atlas&&(this._atlas&&(this._atlas.off("set:frames",this._onSetFrames,this),this._atlas.off("set:frame",this._onFrameChanged,this),this._atlas.off("remove:frame",this._onFrameRemoved,this)),this._atlas=e,this._atlas&&this._frameKeys&&(this._atlas.on("set:frames",this._onSetFrames,this),this._atlas.on("set:frame",this._onFrameChanged,this),this._atlas.on("remove:frame",this._onFrameRemoved,this),this._updatingProperties?this._meshesDirty=true:this._createMeshes()),this.fire("set:atlas",e));}get atlas(){return this._atlas}set pixelsPerUnit(e){this._pixelsPerUnit!==e&&(this._pixelsPerUnit=e,this.fire("set:pixelsPerUnit",e),this._atlas&&this._frameKeys&&0===this.renderMode&&(this._updatingProperties?this._meshesDirty=true:this._createMeshes()));}get pixelsPerUnit(){return this._pixelsPerUnit}set renderMode(e){if(this._renderMode===e)return;let t=this._renderMode;this._renderMode=e,this.fire("set:renderMode",e),(0===t||0===e)&&this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=true:this._createMeshes());}get renderMode(){return this._renderMode}get meshes(){return this._meshes}_createMeshes(){let e=this._meshes.length;for(let t=0;t<e;t++){let e=this._meshes[t];e&&e.destroy();}let t=this._frameKeys.length;this._meshes=Array(t);let s=1===this.renderMode||2===this._renderMode?this._create9SliceMesh:this._createSimpleMesh;for(let e=0;e<t;e++){let t=this._atlas.frames[this._frameKeys[e]];this._meshes[e]=t?s.call(this,t):null;}this.fire("set:meshes");}_createSimpleMesh(e){let t=e.rect,s=this._atlas.texture.width,i=this._atlas.texture.height,n=t.z/this._pixelsPerUnit,r=t.w/this._pixelsPerUnit,a=e.pivot.x,o=e.pivot.y,l=t.x/s,h=1-t.y/i,d=(t.x+t.z)/s,c=1-(t.y+t.w)/i,u=new dn;return u.positions=[-a*n,-o*r,0,(1-a)*n,-o*r,0,(1-a)*n,(1-o)*r,0,-a*n,(1-o)*r,0],u.normals=dQ,u.uvs=[l,h,d,h,d,c,l,c],u.indices=dJ,aG.fromGeometry(this._device,u)}_create9SliceMesh(){let e=ef.ONE,t=[],s=[],i=[],n=[],r=0;for(let a=0;a<=3;a++){let o=+(0!==a&&3!==a);for(let l=0;l<=3;l++){let h=-e.x+2*e.x*(a<=1?0:3)/3,d=-(-e.y+2*e.y*(l<=1?0:3)/3),c=+(0!==l&&3!==l);t.push(-h,0,d),s.push(0,1,0),i.push(o,c),a<3&&l<3&&(n.push(r+3+1,r+1,r),n.push(r+3+1,r+3+2,r+1)),r++;}}let a=new dn;return a.positions=t,a.normals=s,a.uvs=i,a.indices=n,aG.fromGeometry(this._device,a)}_onSetFrames(e){this._updatingProperties?this._meshesDirty=true:this._createMeshes();}_onFrameChanged(e,t){let s=this._frameKeys.indexOf(e);s<0||(t?0===this.renderMode&&(this._meshes[s]=this._createSimpleMesh(t)):this._meshes[s]=null,this.fire("set:meshes"));}_onFrameRemoved(e){let t=this._frameKeys.indexOf(e);t<0||(this._meshes[t]=null,this.fire("set:meshes"));}startUpdate(){this._updatingProperties=true,this._meshesDirty=false;}endUpdate(){this._updatingProperties=false,this._meshesDirty&&this._atlas&&this._frameKeys&&this._createMeshes(),this._meshesDirty=false;}destroy(){for(let e of this._meshes)e&&e.destroy();this._meshes.length=0;}constructor(e,t){super(),this._device=e,this._pixelsPerUnit=t&&void 0!==t.pixelsPerUnit?t.pixelsPerUnit:1,this._renderMode=t&&void 0!==t.renderMode?t.renderMode:0,this._atlas=t&&void 0!==t.atlas?t.atlas:null,this._frameKeys=t&&void 0!==t.frameKeys?t.frameKeys:null,this._meshes=[],this._updatingProperties=false,this._meshesDirty=false,this._atlas&&this._frameKeys&&this._createMeshes();}}class d0 extends Y{set texture(e){this._texture=e,this.fire("set:texture",e);}get texture(){return this._texture}set frames(e){this._frames=e,this.fire("set:frames",e);}get frames(){return this._frames}setFrame(e,t){let s=this._frames[e];s?(s.rect.copy(t.rect),s.pivot.copy(t.pivot),s.border.copy(t.border)):(s={rect:t.rect.clone(),pivot:t.pivot.clone(),border:t.border.clone()},this._frames[e]=s),this.fire("set:frame",e.toString(),s);}removeFrame(e){let t=this._frames[e];t&&(delete this._frames[e],this.fire("remove:frame",e.toString(),t));}destroy(){this._texture&&this._texture.destroy();}constructor(){super(),this._texture=null,this._frames=null;}}class d1{constructor(e,t,s,i){this.time=e,this.position=t,this.rotation=s,this.scale=i;}}class d2{constructor(){this._name="",this._keys=[];}}class d3{getNode(e){return this._nodeDict[e]}addNode(e){this._nodes.push(e),this._nodeDict[e._name]=e;}get nodes(){return this._nodes}constructor(){this.name="",this.duration=0,this._nodes=[],this._nodeDict={};}}class d4{getTarget(){return this._targetNode}setTarget(e){this._targetNode=e;}constructor(){this._written=false,this._name="",this._keyFrames=[],this._quat=new eT,this._pos=new eu,this._scale=new eu,this._targetNode=null;}}class d5{set animation(e){this._animation=e,this.currentTime=0;}get animation(){return this._animation}set currentTime(e){this._time=e;let t=this._interpolatedKeys.length;for(let e=0;e<t;e++){let t=this._interpolatedKeys[e]._name;this._currKeyIndices[t]=0;}this.addTime(0),this.updateGraph();}get currentTime(){return this._time}get numNodes(){return this._interpolatedKeys.length}addTime(e){if(null!==this._animation){let t=this._animation._nodes,s=this._animation.duration;if(this._time===s&&!this.looping)return;if(this._time+=e,this._time>s){this._time=this.looping?0:s;for(let e=0;e<t.length;e++){let s=t[e]._name;this._currKeyIndices[s]=0;}}else if(this._time<0){this._time=this.looping?s:0;for(let e=0;e<t.length;e++){let s=t[e],i=s._name;this._currKeyIndices[i]=s._keys.length-2;}}let i=e>=0?1:-1;for(let e=0;e<t.length;e++){let s=t[e],n=s._name,r=s._keys,a=this._interpolatedKeyDict[n];if(void 0===a)continue;let o=false;if(1!==r.length)for(let e=this._currKeyIndices[n];e<r.length-1&&e>=0;e+=i){let t=r[e],s=r[e+1];if(t.time<=this._time&&s.time>=this._time){let i=(this._time-t.time)/(s.time-t.time);a._pos.lerp(t.position,s.position,i),a._quat.slerp(t.rotation,s.rotation,i),a._scale.lerp(t.scale,s.scale,i),a._written=true,this._currKeyIndices[n]=e,o=true;break}}(1===r.length||!o&&0===this._time&&this.looping)&&(a._pos.copy(r[0].position),a._quat.copy(r[0].rotation),a._scale.copy(r[0].scale),a._written=true);}}}blend(e,t,s){let i=this._interpolatedKeys.length;for(let n=0;n<i;n++){let i=e._interpolatedKeys[n],r=t._interpolatedKeys[n],a=this._interpolatedKeys[n];i._written&&r._written?(a._quat.slerp(i._quat,t._interpolatedKeys[n]._quat,s),a._pos.lerp(i._pos,t._interpolatedKeys[n]._pos,s),a._scale.lerp(i._scale,r._scale,s),a._written=true):i._written?(a._quat.copy(i._quat),a._pos.copy(i._pos),a._scale.copy(i._scale),a._written=true):r._written&&(a._quat.copy(r._quat),a._pos.copy(r._pos),a._scale.copy(r._scale),a._written=true);}}setGraph(e){if(this.graph=e,e)for(let t=0;t<this._interpolatedKeys.length;t++){let s=this._interpolatedKeys[t],i=e.findByName(s._name);this._interpolatedKeys[t].setTarget(i);}else for(let e=0;e<this._interpolatedKeys.length;e++)this._interpolatedKeys[e].setTarget(null);}updateGraph(){if(this.graph)for(let e=0;e<this._interpolatedKeys.length;e++){let t=this._interpolatedKeys[e];if(t._written){let e=t.getTarget();e.localPosition.copy(t._pos),e.localRotation.copy(t._quat),e.localScale.copy(t._scale),e._dirtyLocal||e._dirtifyLocal(),t._written=false;}}}constructor(e){this.looping=true,this._animation=null,this._time=0,this._interpolatedKeys=[],this._interpolatedKeyDict={},this._currKeyIndices={},this.graph=null;let t=e=>{let s=new d4;s._name=e.name,this._interpolatedKeys.push(s),this._interpolatedKeyDict[e.name]=s,this._currKeyIndices[e.name]=0;for(let s=0;s<e._children.length;s++)t(e._children[s]);};t(e);}}let d6=new em;class d8{render(e,t,s){}drawQuad(e,t,s){let i;if(s){let t=e?e.width:this.device.width,n=e?e.height:this.device.height;i=d6.set(s.x*t,s.y*n,s.z*t,s.w*n);}this.device.setBlendState(sh.NOBLEND),aD(this.device,e,t,i);}constructor(e){this.device=e,this.needsDepthBuffer=false;}}d8.quadVertexShader="\n        attribute vec2 aPosition;\n        varying vec2 vUv0;\n        void main(void)\n        {\n            gl_Position = vec4(aPosition, 0.0, 1.0);\n            vUv0 = getImageEffectUV((aPosition.xy + 1.0) * 0.5);\n        }\n    ";class d9 extends nK{set shader(e){var t;null==(t=this.quadRender)||t.destroy(),this.quadRender=null,this._shader=e,e&&(this.quadRender=new aI(e));}get shader(){return this._shader}createQuadShader(e,t,s){return void 0===s&&(s={}),ab(this.device,d9.quadVertexShader,t,e,{aPosition:e2},s)}execute(){let e=this.device;e.setBlendState(this.blendState),e.setCullMode(this.cullMode),e.setDepthState(this.depthState),e.setStencilState(this.stencilFront,this.stencilBack),this.quadRender.render();}constructor(...e){super(...e),this._shader=null,this.quadRender=null,this.cullMode=0,this.blendState=sh.NOBLEND,this.depthState=su.NODEPTH,this.stencilFront=null,this.stencilBack=null;}}d9.quadVertexShader="\n        attribute vec2 aPosition;\n        varying vec2 uv0;\n        void main(void)\n        {\n            gl_Position = vec4(aPosition, 0.0, 1.0);\n            uv0 = getImageEffectUV((aPosition.xy + 1.0) * 0.5);\n        }\n    ";class d7{constructor(){this.hasTangents=false,this.chunks={},this.pass=0,this.alphaTest=false,this.blendType=3,this.separateAmbient=false,this.screenSpace=false,this.skin=false,this.batch=false,this.useInstancing=false,this.useMorphPosition=false,this.useMorphNormal=false,this.useMorphTextureBasedInt=false,this.nineSlicedMode=0,this.clusteredLightingEnabled=true,this.clusteredLightingCookiesEnabled=false,this.clusteredLightingShadowsEnabled=false,this.clusteredLightingShadowType=0,this.clusteredLightingAreaLightsEnabled=false,this.vertexColors=false,this.lightMapEnabled=false,this.dirLightMapEnabled=false,this.useHeights=false,this.useNormals=false,this.useClearCoatNormals=false,this.useAo=false,this.diffuseMapEnabled=false,this.customFragmentShader=null,this.pixelSnap=false,this.ambientSH=false,this.ssao=false,this.twoSidedLighting=false,this.occludeDirect=false,this.occludeSpecular=0,this.occludeSpecularFloat=false,this.useMsdf=false,this.msdfTextAttribute=false,this.alphaToCoverage=false,this.opacityFadesSpecular=false,this.opacityDither=ai,this.opacityShadowDither=ai,this.cubeMapProjection=0,this.useSpecular=false,this.useSpecularityFactor=false,this.enableGGXSpecular=false,this.fresnelModel=0,this.useRefraction=false,this.useClearCoat=false,this.useSheen=false,this.useIridescence=false,this.useMetalness=false,this.useDynamicRefraction=false,this.dispersion=false,this.fog=rH,this.gamma=0,this.toneMap=-1,this.reflectionSource=r0,this.reflectionEncoding=null,this.reflectionCubemapEncoding=null,this.ambientSource="constant",this.ambientEncoding=null,this.skyboxIntensity=1,this.useCubeMapRotation=false,this.lightMapWithoutAmbient=false,this.lights=[],this.noShadow=false,this.lightMaskDynamic=0,this.userAttributes={},this.linearDepth=false,this.shadowCatcher=false;}}class ce{static update(e,t,s,i,n,r,a){ce.updateSharedOptions(e,t,s,n,r),ce.updateMaterialOptions(e,t),ce.updateEnvOptions(e,t,s,i),ce.updateLightingOptions(e,t,n,a);}static updateSharedOptions(e,t,s,i,n){e.chunks=t.chunks,e.pass=n,e.alphaTest=t.alphaTest>0,e.blendType=t.blendType,e.screenSpace=i&&(256&i)!=0,e.skin=i&&(2&i)!=0,e.useInstancing=i&&(32&i)!=0,e.useMorphPosition=i&&(1024&i)!=0,e.useMorphNormal=i&&(2048&i)!=0,e.useMorphTextureBasedInt=i&&(8192&i)!=0,e.hasTangents=i&&(512&i)!=0,e.nineSlicedMode=t.nineSlicedMode||0,t.useLighting&&s.clusteredLightingEnabled?(e.clusteredLightingEnabled=true,e.clusteredLightingCookiesEnabled=s.lighting.cookiesEnabled,e.clusteredLightingShadowsEnabled=s.lighting.shadowsEnabled,e.clusteredLightingShadowType=s.lighting.shadowType,e.clusteredLightingAreaLightsEnabled=s.lighting.areaLightsEnabled):(e.clusteredLightingEnabled=false,e.clusteredLightingCookiesEnabled=false,e.clusteredLightingShadowsEnabled=false,e.clusteredLightingAreaLightsEnabled=false);}static updateMaterialOptions(e,t){e.separateAmbient=false,e.customFragmentShader=null,e.pixelSnap=t.pixelSnap,e.ambientSH=t.ambientSH,e.twoSidedLighting=t.twoSidedLighting,e.occludeDirect=t.occludeDirect,e.occludeSpecular=t.occludeSpecular,e.occludeSpecularFloat=1!==t.occludeSpecularIntensity,e.useMsdf=false,e.msdfTextAttribute=false,e.alphaToCoverage=t.alphaToCoverage,e.opacityFadesSpecular=t.opacityFadesSpecular,e.opacityDither=t.opacityDither,e.cubeMapProjection=0,e.useSpecular=t.hasSpecular,e.useSpecularityFactor=t.hasSpecularityFactor,e.enableGGXSpecular=t.ggxSpecular,e.fresnelModel=t.fresnelModel,e.useRefraction=t.hasRefraction,e.useClearCoat=t.hasClearCoat,e.useSheen=t.hasSheen,e.useIridescence=t.hasIrridescence,e.useMetalness=t.hasMetalness,e.useDynamicRefraction=t.dynamicRefraction,e.dispersion=t.dispersion>0,e.vertexColors=false,e.lightMapEnabled=t.hasLighting,e.dirLightMapEnabled=t.dirLightMap,e.useHeights=t.hasHeights,e.useNormals=t.hasNormals,e.useClearCoatNormals=t.hasClearCoatNormals,e.useAo=t.hasAo,e.diffuseMapEnabled=t.hasDiffuseMap;}static updateEnvOptions(e,t,s,i){e.fog=t.useFog?i.fog:rH,e.gamma=i.shaderOutputGamma,e.toneMap=t.useTonemap?i.toneMapping:6,t.useSkybox&&s.envAtlas&&s.skybox?(e.reflectionSource=r2,e.reflectionEncoding=s.envAtlas.encoding,e.reflectionCubemapEncoding=s.skybox.encoding):t.useSkybox&&s.envAtlas?(e.reflectionSource=r1,e.reflectionEncoding=s.envAtlas.encoding):t.useSkybox&&s.skybox?(e.reflectionSource=r3,e.reflectionEncoding=s.skybox.encoding):(e.reflectionSource=r0,e.reflectionEncoding=null),t.ambientSH?(e.ambientSource=r6,e.ambientEncoding=null):e.reflectionSource!==r0&&s.envAtlas?(e.ambientSource=r8,e.ambientEncoding=s.envAtlas.encoding):(e.ambientSource=r9,e.ambientEncoding=null);let n=e.reflectionSource!==r0;e.skyboxIntensity=n,e.useCubeMapRotation=n&&s._skyboxRotationShaderInclude;}static updateLightingOptions(e,t,s,i){if(e.lightMapWithoutAmbient=false,t.useLighting){let t=[],n=s?s>>16:1;e.lightMaskDynamic=!!(1&n),e.lightMapWithoutAmbient=false,i&&(ce.collectLights(0,i[0],t,n),ce.collectLights(1,i[1],t,n),ce.collectLights(2,i[2],t,n)),e.lights=t;}else e.lights=[];(0===e.lights.length||(1&s)!=0)&&(e.noShadow=true);}static collectLights(e,t,s,i){for(let e=0;e<t.length;e++){let n=t[e];n.enabled&&n.mask&i&&s.push(n);}}}let ct={vertex_normal:e3,vertex_tangent:e4,vertex_texCoord0:e7,vertex_texCoord1:te,vertex_color:e8,vertex_boneWeights:e5,vertex_boneIndices:e6},cs=new Map([["vec4","vec4f"],["vec3","vec3f"],["vec2","vec2f"],["float","f32"]]);class ci{fDefineSet(e,t,s){ void 0===s&&(s=""),e&&this.fDefines.set(t,s);}generateVertexShader(e,t,s){let{options:i,vDefines:n,attributes:r}=this,a=new Map;a.set("vPositionW","vec3"),(1===i.nineSlicedMode||2===i.nineSlicedMode)&&n.set("NINESLICED",true),this.options.linearDepth&&(n.set("LINEAR_DEPTH",true),a.set("vLinearDepth","float")),this.needsNormal&&n.set("NORMALS",true),this.options.useInstancing&&this.chunks.transformInstancingVS===am.transformInstancingVS&&(r.instance_line1=ty,r.instance_line2=tS,r.instance_line3=tx,r.instance_line4=tT),this.needsNormal&&(r.vertex_normal=e3,a.set("vNormalW","vec3"),i.hasTangents&&(i.useHeights||i.useNormals||i.useClearCoatNormals||i.enableGGXSpecular)?(n.set("TANGENTS",true),r.vertex_tangent=e4,a.set("vTangentW","vec3"),a.set("vBinormalW","vec3")):i.enableGGXSpecular&&(n.set("GGX_SPECULAR",true),a.set("vObjectSpaceUpW","vec3")));for(let s=0;s<2;s++)e[s]&&(n.set("UV"+s,true),r["vertex_texCoord"+s]="TEXCOORD"+s),t[s]&&(n.set("UV"+s+"_UNMODIFIED",true),a.set("vUv"+s,"vec2"));let o=0,l=new Set;s.forEach(e=>{let{id:t,uv:s,name:i}=e,r=t+100*s;!l.has(r)&&(l.add(r),a.set("vUV"+s+"_"+t,"vec2"),n.set("{TRANSFORM_NAME_"+o+"}","texture_"+i+"MapTransform"),n.set("{TRANSFORM_UV_"+o+"}",s),n.set("{TRANSFORM_ID_"+o+"}",t),o++);}),n.set("UV_TRANSFORMS_COUNT",o),i.vertexColors&&(r.vertex_color=e8,n.set("VERTEX_COLOR",true),a.set("vVertexColor","vec4")),i.useMsdf&&i.msdfTextAttribute&&(r.vertex_outlineParameters=tm,r.vertex_shadowParameters=t_,n.set("MSDF",true)),(i.useMorphPosition||i.useMorphNormal)&&(n.set("MORPHING",true),i.useMorphTextureBasedInt&&n.set("MORPHING_INT",true),i.useMorphPosition&&n.set("MORPHING_POSITION",true),i.useMorphNormal&&n.set("MORPHING_NORMAL",true),r.morph_vertex_id=tT),i.skin&&(r.vertex_boneIndices=e6,i.batch?n.set("BATCH",true):(r.vertex_boneWeights=e5,n.set("SKIN",true))),i.useInstancing&&n.set("INSTANCING",true),i.screenSpace&&n.set("SCREENSPACE",true),i.pixelSnap&&n.set("PIXELSNAP",true),a.forEach((e,t)=>{n.set("VARYING_"+t.toUpperCase(),true),this.varyingsCode+=this.shaderLanguage===tN?"varying "+t+": "+cs.get(e)+";\n":"varying "+e+" "+t+";\n";}),this.vshader="\n            "+this.varyingsCode+'\n            #include "litMainVS"\n        ';}_setupLightingDefines(e,t){let s=this.fDefines,i=this.options;if(this.fDefines.set("LIGHT_COUNT",i.lights.length),e&&s.set("AREA_LIGHTS",true),t&&this.lighting&&(s.set("LIT_CLUSTERED_LIGHTS",true),i.clusteredLightingCookiesEnabled&&s.set("CLUSTER_COOKIES",true),i.clusteredLightingAreaLightsEnabled&&s.set("CLUSTER_AREALIGHTS",true),i.lightMaskDynamic&&s.set("CLUSTER_MESH_DYNAMIC_LIGHTS",true),i.clusteredLightingShadowsEnabled&&!i.noShadow)){let e=rK.get(i.clusteredLightingShadowType);s.set("CLUSTER_SHADOWS",true),s.set("SHADOW_KIND_"+e.kind,true),s.set("CLUSTER_SHADOW_TYPE_"+e.kind,true);}for(let n=0;n<i.lights.length;n++){let r=i.lights[n],a=r._type;if(t&&0!==a)continue;let o=e&&r._shape?r._shape:0,l=r._shadowType,h=r.castShadows&&!i.noShadow,d=rK.get(l);s.set("LIGHT"+n,true),s.set("LIGHT"+n+"TYPE",""+rY[a]),s.set("LIGHT"+n+"SHADOWTYPE",""+d.name),s.set("LIGHT"+n+"SHAPE",""+rj[o]),s.set("LIGHT"+n+"FALLOFF",""+rq[r._falloffMode]),r.affectSpecularity&&s.set("LIGHT"+n+"AFFECT_SPECULARITY",true),r._cookie&&(2===a&&!r._cookie._cubemap||1===a&&r._cookie._cubemap)&&(s.set("LIGHT"+n+"COOKIE",true),s.set("{LIGHT"+n+"COOKIE_CHANNEL}",r._cookieChannel),2===a&&(r._cookieTransform&&s.set("LIGHT"+n+"COOKIE_TRANSFORM",true),r._cookieFalloff&&s.set("LIGHT"+n+"COOKIE_FALLOFF",true))),h&&(s.set("LIGHT"+n+"CASTSHADOW",true),d.pcf&&s.set("LIGHT"+n+"SHADOW_PCF",true),r._normalOffsetBias&&!r._isVsm&&s.set("LIGHT"+n+"_SHADOW_SAMPLE_NORMAL_OFFSET",true),0===a&&(s.set("LIGHT"+n+"_SHADOW_SAMPLE_ORTHO",true),r.cascadeBlend>0&&s.set("LIGHT"+n+"_SHADOW_CASCADE_BLEND",true),r.numCascades>1&&s.set("LIGHT"+n+"_SHADOW_CASCADES",true)),(d.pcf||d.pcss||this.device.isWebGPU)&&s.set("LIGHT"+n+"_SHADOW_SAMPLE_SOURCE_ZBUFFER",true),1===a&&s.set("LIGHT"+n+"_SHADOW_SAMPLE_POINT",true)),h&&(s.set("SHADOW_KIND_"+d.kind,true),0===a&&s.set("SHADOW_DIRECTIONAL",true));}}prepareForwardPass(e){let{options:t}=this,s=t.clusteredLightingEnabled&&t.clusteredLightingAreaLightsEnabled||t.lights.some(e=>e._shape&&0!==e._shape),i=!t.lightMapEnabled||t.lightMapWithoutAmbient,n=this.needsNormal&&(t.useNormals||t.useClearCoatNormals||t.enableGGXSpecular&&!t.useHeights);t.useSpecular&&(this.fDefineSet(true,"LIT_SPECULAR"),this.fDefineSet(this.reflections,"LIT_REFLECTIONS"),this.fDefineSet(t.useClearCoat,"LIT_CLEARCOAT"),this.fDefineSet(t.fresnelModel>0,"LIT_SPECULAR_FRESNEL"),this.fDefineSet(t.useSheen,"LIT_SHEEN"),this.fDefineSet(t.useIridescence,"LIT_IRIDESCENCE")),this.fDefineSet(this.lighting&&t.useSpecular||this.reflections,"LIT_SPECULAR_OR_REFLECTION"),this.fDefineSet(this.needsSceneColor,"LIT_SCENE_COLOR"),this.fDefineSet(this.needsScreenSize,"LIT_SCREEN_SIZE"),this.fDefineSet(this.needsTransforms,"LIT_TRANSFORMS"),this.fDefineSet(this.needsNormal,"LIT_NEEDS_NORMAL"),this.fDefineSet(this.lighting,"LIT_LIGHTING"),this.fDefineSet(t.useMetalness,"LIT_METALNESS"),this.fDefineSet(t.enableGGXSpecular,"LIT_GGX_SPECULAR"),this.fDefineSet(t.useSpecularityFactor,"LIT_SPECULARITY_FACTOR"),this.fDefineSet(t.useCubeMapRotation,"CUBEMAP_ROTATION"),this.fDefineSet(t.occludeSpecularFloat,"LIT_OCCLUDE_SPECULAR_FLOAT"),this.fDefineSet(t.separateAmbient,"LIT_SEPARATE_AMBIENT"),this.fDefineSet(t.twoSidedLighting,"LIT_TWO_SIDED_LIGHTING"),this.fDefineSet(t.lightMapEnabled,"LIT_LIGHTMAP"),this.fDefineSet(t.dirLightMapEnabled,"LIT_DIR_LIGHTMAP"),this.fDefineSet(t.skyboxIntensity>0,"LIT_SKYBOX_INTENSITY"),this.fDefineSet(t.clusteredLightingShadowsEnabled,"LIT_CLUSTERED_SHADOWS"),this.fDefineSet(t.clusteredLightingAreaLightsEnabled,"LIT_CLUSTERED_AREA_LIGHTS"),this.fDefineSet(n,"LIT_TBN"),this.fDefineSet(i,"LIT_ADD_AMBIENT"),this.fDefineSet(t.hasTangents,"LIT_TANGENTS"),this.fDefineSet(t.useNormals,"LIT_USE_NORMALS"),this.fDefineSet(t.useClearCoatNormals,"LIT_USE_CLEARCOAT_NORMALS"),this.fDefineSet(t.useRefraction,"LIT_REFRACTION"),this.fDefineSet(t.useDynamicRefraction,"LIT_DYNAMIC_REFRACTION"),this.fDefineSet(t.dispersion,"LIT_DISPERSION"),this.fDefineSet(t.useHeights,"LIT_HEIGHTS"),this.fDefineSet(t.opacityFadesSpecular,"LIT_OPACITY_FADES_SPECULAR"),this.fDefineSet(t.alphaToCoverage,"LIT_ALPHA_TO_COVERAGE"),this.fDefineSet(t.alphaTest,"LIT_ALPHA_TEST"),this.fDefineSet(t.useMsdf,"LIT_MSDF"),this.fDefineSet(t.ssao,"LIT_SSAO"),this.fDefineSet(t.useAo,"LIT_AO"),this.fDefineSet(t.occludeDirect,"LIT_OCCLUDE_DIRECT"),this.fDefineSet(t.msdfTextAttribute,"LIT_MSDF_TEXT_ATTRIBUTE"),this.fDefineSet(t.diffuseMapEnabled,"LIT_DIFFUSE_MAP"),this.fDefineSet(t.shadowCatcher,"LIT_SHADOW_CATCHER"),this.fDefineSet(true,"LIT_FRESNEL_MODEL",rX[t.fresnelModel]),this.fDefineSet(true,"LIT_NONE_SLICE_MODE",ae[t.nineSlicedMode]),this.fDefineSet(true,"LIT_BLEND_TYPE",rG[t.blendType]),this.fDefineSet(true,"LIT_CUBEMAP_PROJECTION",rZ[t.cubeMapProjection]),this.fDefineSet(true,"LIT_OCCLUDE_SPECULAR",r$[t.occludeSpecular]),this.fDefineSet(true,"LIT_REFLECTION_SOURCE",r5[t.reflectionSource]),this.fDefineSet(true,"LIT_AMBIENT_SOURCE",r7[t.ambientSource]),this.fDefineSet(true,"{lightingUv}",null!=e?e:""),this.fDefineSet(true,"{reflectionDecode}",dt.decodeFunc(t.reflectionEncoding)),this.fDefineSet(true,"{reflectionCubemapDecode}",dt.decodeFunc(t.reflectionCubemapEncoding)),this.fDefineSet(true,"{ambientDecode}",dt.decodeFunc(t.ambientEncoding)),this._setupLightingDefines(s,t.clusteredLightingEnabled);}prepareShadowPass(){let{options:e}=this,t=this.shaderPassInfo.lightType,s=this.shaderPassInfo.shadowType,i=rK.get(s),n=0===t||!i.vsm&&2===t;this.fDefineSet(n,"PERSPECTIVE_DEPTH"),this.fDefineSet(true,"LIGHT_TYPE",""+rY[t]),this.fDefineSet(true,"SHADOW_TYPE",""+i.name),this.fDefineSet(e.alphaTest,"LIT_ALPHA_TEST");}generateFragmentShader(e,t,s){let i=this.options;3===i.pass||2===i.pass||1===i.pass?this.fshader="\n\n                "+this.varyingsCode+"\n                "+e+"\n                "+t+'\n                #include "litOtherMainPS"\n            ':this.shadowPass?(this.prepareShadowPass(),this.fshader="\n                "+this.varyingsCode+"\n                "+e+"\n                "+t+'\n                #include "litShadowMainPS"\n            '):i.customFragmentShader?this.fshader="\n                "+i.customFragmentShader+"\n            ":(this.prepareForwardPass(s),this.fshader="\n                "+this.varyingsCode+"\n                "+e+'\n                #include "litForwardDeclarationPS"\n                #include "litForwardPreCodePS"\n                '+t+'\n                #include "litForwardPostCodePS"\n                #include "litForwardBackendPS"\n                #include "litForwardMainPS"\n            ');}constructor(e,t,s){if(this.varyingsCode="",this.device=e,this.options=t,this.shaderLanguage=s,this.attributes={vertex_position:e2},t.userAttributes)for(let[e,s]of Object.entries(t.userAttributes))this.attributes[s]=e;let i=s===tF?am:oM;if(t.chunks){let e=t.chunks;for(let t in this.chunks=Object.create(i),i)if(e.hasOwnProperty(t)){let s=e[t];for(let e in ct)ct.hasOwnProperty(e)&&s.indexOf(e)>=0&&(this.attributes[e]=ct[e]);this.chunks[t]=s;}}else this.chunks=i;this.shaderPassInfo=ax.get(this.device).getByIndex(t.pass),this.shadowPass=this.shaderPassInfo.isShadow,this.lighting=t.lights.length>0||t.dirLightMapEnabled||t.clusteredLightingEnabled,this.reflections=t.reflectionSource!==r0,this.needsNormal=this.lighting||this.reflections||t.useSpecular||t.ambientSH||t.useHeights||t.enableGGXSpecular||t.clusteredLightingEnabled&&!this.shadowPass||t.useClearCoatNormals,this.needsNormal=this.needsNormal&&!this.shadowPass,this.needsSceneColor=t.useDynamicRefraction,this.needsScreenSize=t.useDynamicRefraction,this.needsTransforms=t.useDynamicRefraction,this.vshader=null,this.vDefines=new Map,this.fDefines=new Map,this.fshader=null;}}let cn={generateKey:e=>"lit"+Object.keys(e).sort().map(t=>"chunks"===t?cn.generateChunksKey(e):"lights"===t?cn.generateLightsKey(e):t+e[t]).join("\n"),generateLightsKey:e=>"lights:"+e.lights.map(t=>e.clusteredLightingEnabled&&0!==t._type?"":""+t.key+",").join(""),generateChunksKey(e){var t;return "chunks:\n"+Object.keys(null!=(t=e.chunks)?t:{}).sort().map(t=>t+e.chunks[t]).join("")}};function cr(){return (cr=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i]);}return e}).apply(this,arguments)}let ca=[0,1,2,3,4,5,6,7],co=new class extends av{generateKey(e){var t,s;let i=av.definesHash(e.defines),n=sS(null!=(t=e.shaderChunkGLSL)?t:""),r=sS(null!=(s=e.shaderChunkWGSL)?s:""),a=cn.generateKey(e.litOptions);return "lit_"+i+"_"+ca.map((t,s)=>e.usedUvs[s]?"1":"0").join("")+"_"+n+"_"+r+"_"+a}createShaderDefinition(e,t){let s=e.isWebGPU&&t.shaderChunkWGSL,i=s?tN:tF,n=new ci(e,t.litOptions,i),r={name:"LitShader",shaderLanguage:i,tag:n.shaderPassInfo.isForward?1:void 0},a=t.usedUvs||[true];n.generateVertexShader(a,a,[]),n.generateFragmentShader("",s?t.shaderChunkWGSL:t.shaderChunkGLSL,"vUv0");let o=new Map(Object.entries(cr({},Object.getPrototypeOf(n.chunks),n.chunks,t.litOptions.chunks))),l=n.vDefines;t.defines.forEach((e,t)=>l.set(t,e));let h=n.fDefines;return t.defines.forEach((e,t)=>h.set(t,e)),r.attributes=n.attributes,r.vertexCode=n.vshader,r.vertexIncludes=o,r.vertexDefines=l,r.fragmentCode=n.fshader,r.fragmentIncludes=o,r.fragmentDefines=h,ne.createDefinition(e,r)}},cl=new class{constructor(){this.litOptions=new d7;}};class ch{get pass(){return this.litOptions.pass}constructor(){this.defines=new Map,this.forceUv1=false,this.specularTint=false,this.metalnessTint=false,this.glossTint=false,this.emissiveEncoding="linear",this.lightMapEncoding="linear",this.packedNormal=false,this.normalDetailPackedNormal=false,this.clearCoatPackedNormal=false,this.glossInvert=false,this.sheenGlossInvert=false,this.clearCoatGlossInvert=false,this.useAO=false,this.litOptions=new d7;}}function cd(){return (cd=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i]);}return e}).apply(this,arguments)}let cc=[],cu=e=>Object.keys(e).filter(e=>"litOptions"!==e).sort(),cp=new class extends av{generateKey(e){let t;return e===this.optionsContextMin?(this.propsMin||(this.propsMin=cu(e)),t=this.propsMin):e===this.optionsContext?(this.props||(this.props=cu(e)),t=this.props):t=cu(e),"standard:\n"+av.definesHash(e.defines)+"\n"+t.map(t=>t+e[t]).join("\n")+cn.generateKey(e.litOptions)}_getUvSourceExpression(e,t,s){let i;let n=s[e],r=s[t],a=0===s.litOptions.pass;return a&&1===s.litOptions.nineSlicedMode?i="nineSlicedUv":a&&2===s.litOptions.nineSlicedMode?i="nineSlicedUv":(i=0===n?"vUv"+r:"vUV"+r+"_"+n,s.heightMap&&"heightMapTransform"!==e&&(i+=" + dUvOffset")),i}_validateMapChunk(e,t,s){}_addMapDefines(e,t,s,i,n,r,a){ void 0===a&&(a=null);let o=""+t+"Map",l=t.toUpperCase(),h=""+o+"Channel",d=""+t+"VertexColorChannel",c=""+t+"Tint",u=""+t+"VertexColor",p=""+t+"Mode",f=""+t+"Invert",m=i[c],_=i[u],g=i[o],v=i[""+o+"Identifier"],y=i[p],S=n[s];if(g){e.set("STD_"+l+"_TEXTURE","");let t=this._getUvSourceExpression(""+o+"Transform",""+o+"Uv",i);e.set("{STD_"+l+"_TEXTURE_UV}",t),e.set("{STD_"+l+"_TEXTURE_CHANNEL}",i[h]);let s="{STD_"+l+"_TEXTURE_NAME}";if(S.includes(s)){let t="texture_"+o,i=r[v];i?t=i:(r[v]=t,e.set("STD_"+l+"_TEXTURE_ALLOCATE","")),e.set(s,t);}if(a){let t="aaa"===i[h]?"passThrough":dt.decodeFunc(a);e.set("{STD_"+l+"_TEXTURE_DECODE}",t);}}_&&(e.set("STD_"+l+"_VERTEX",""),e.set("{STD_"+l+"_VERTEX_CHANNEL}",i[d])),y&&e.set("{STD_"+l+"_DETAILMODE}",y),m&&e.set("STD_"+l+"_CONSTANT",""),i[f]&&e.set("STD_"+l+"_INVERT","");}_correctChannel(e,t,s){if(s[e]>0){if(s[e]<t.length)return t.substring(0,s[e]);if(s[e]>t.length){let i=t,n=i.charAt(i.length-1),r=s[e]-i.length;for(let e=0;e<r;e++)i+=n;return i}return t}}createVertexShader(e,t){let s=[],i=[],n=[];for(let e in cc){let r=""+e+"Map";if(t[""+e+"VertexColor"]){let s=""+e+"VertexColorChannel";t[s]=this._correctChannel(e,t[s],cc);}if(t[r]){let a=""+r+"Channel",o=""+r+"Transform",l=""+r+"Uv";t[l]=Math.min(t[l],1),t[a]=this._correctChannel(e,t[a],cc);let h=t[l];s[h]=true,i[h]=i[h]||t[r]&&!t[o],t[o]&&n.push({name:e,id:t[o],uv:t[l]});}}t.forceUv1&&(s[1]=true,i[1]=void 0===i[1]||i[1]),e.generateVertexShader(s,i,n);}prepareFragmentDefines(e,t,s){let i=(e,s,i)=>{ void 0===i&&(i=""),e&&t.set(s,i);};i(e.lightMap,"STD_LIGHTMAP",""),i(e.lightVertexColor,"STD_LIGHT_VERTEX_COLOR",""),i(e.dirLightMap&&e.litOptions.useSpecular,"STD_LIGHTMAP_DIR",""),i(e.heightMap,"STD_HEIGHT_MAP",""),i(e.useSpecularColor,"STD_SPECULAR_COLOR",""),i(e.aoMap||e.aoVertexColor||e.useAO,"STD_AO",""),i(true,"STD_OPACITY_DITHER",ao[s.isForward?e.litOptions.opacityDither:e.litOptions.opacityShadowDither]);}createShaderDefinition(e,t){let s=ax.get(e).getByIndex(t.litOptions.pass),i=s.isForward,n=new ci(e,t.litOptions,tF);this.createVertexShader(n,t);let r={};t.litOptions.fresnelModel=0===t.litOptions.fresnelModel?2:t.litOptions.fresnelModel;let a=n.fDefines;this.prepareFragmentDefines(t,a,s);let o="";if(i){if(t.heightMap&&this._addMapDefines(a,"height","parallaxPS",t,n.chunks,r),(3!==t.litOptions.blendType||t.litOptions.alphaTest||t.litOptions.alphaToCoverage||t.litOptions.opacityDither!==ai)&&this._addMapDefines(a,"opacity","opacityPS",t,n.chunks,r),n.needsNormal){if((t.normalMap||t.clearCoatNormalMap)&&!t.litOptions.hasTangents){let e=t.normalMap?"normalMap":"clearCoatNormalMap";o=this._getUvSourceExpression(""+e+"Transform",""+e+"Uv",t);}this._addMapDefines(a,"normalDetail","normalMapPS",t,n.chunks,r,t.normalDetailPackedNormal?"xy":"xyz"),this._addMapDefines(a,"normal","normalMapPS",t,n.chunks,r,t.packedNormal?"xy":"xyz");}t.diffuseDetail&&this._addMapDefines(a,"diffuseDetail","diffusePS",t,n.chunks,r,t.diffuseDetailEncoding),this._addMapDefines(a,"diffuse","diffusePS",t,n.chunks,r,t.diffuseEncoding),t.litOptions.useRefraction&&(this._addMapDefines(a,"refraction","transmissionPS",t,n.chunks,r),this._addMapDefines(a,"thickness","thicknessPS",t,n.chunks,r)),t.litOptions.useIridescence&&(this._addMapDefines(a,"iridescence","iridescencePS",t,n.chunks,r),this._addMapDefines(a,"iridescenceThickness","iridescenceThicknessPS",t,n.chunks,r)),(n.lighting&&t.litOptions.useSpecular||n.reflections)&&(t.litOptions.useSheen&&(this._addMapDefines(a,"sheen","sheenPS",t,n.chunks,r,t.sheenEncoding),this._addMapDefines(a,"sheenGloss","sheenGlossPS",t,n.chunks,r)),t.litOptions.useMetalness&&(this._addMapDefines(a,"metalness","metalnessPS",t,n.chunks,r),this._addMapDefines(a,"ior","iorPS",t,n.chunks,r)),t.litOptions.useSpecularityFactor&&this._addMapDefines(a,"specularityFactor","specularityFactorPS",t,n.chunks,r),t.useSpecularColor&&this._addMapDefines(a,"specular","specularPS",t,n.chunks,r,t.specularEncoding),this._addMapDefines(a,"gloss","glossPS",t,n.chunks,r)),t.aoDetail&&this._addMapDefines(a,"aoDetail","aoPS",t,n.chunks,r),(t.aoMap||t.aoVertexColor||t.useAO)&&this._addMapDefines(a,"ao","aoPS",t,n.chunks,r),this._addMapDefines(a,"emissive","emissivePS",t,n.chunks,r,t.emissiveEncoding),t.litOptions.useClearCoat&&(this._addMapDefines(a,"clearCoat","clearCoatPS",t,n.chunks,r),this._addMapDefines(a,"clearCoatGloss","clearCoatGlossPS",t,n.chunks,r),this._addMapDefines(a,"clearCoatNormal","clearCoatNormalPS",t,n.chunks,r,t.clearCoatPackedNormal?"xy":"xyz")),(t.lightMap||t.lightVertexColor)&&this._addMapDefines(a,"light","lightmapPS",t,n.chunks,r,t.lightMapEncoding);}else {let e=t.litOptions.opacityShadowDither;(t.litOptions.alphaTest||e)&&this._addMapDefines(a,"opacity","opacityPS",t,n.chunks,r);}n.generateFragmentShader(n.chunks.stdDeclarationPS,n.chunks.stdFrontEndPS,o);let l=new Map(Object.entries(cd({},Object.getPrototypeOf(n.chunks),n.chunks,t.litOptions.chunks))),h=n.vDefines;t.defines.forEach((e,t)=>h.set(t,e)),t.defines.forEach((e,t)=>a.set(t,e));let d=ne.createDefinition(e,{name:"StandardShader",attributes:n.attributes,vertexCode:n.vshader,fragmentCode:n.fshader,vertexIncludes:l,fragmentIncludes:l,fragmentDefines:a,vertexDefines:h});return n.shaderPassInfo.isForward&&(d.tag=1),d}constructor(...e){super(...e),this.optionsContext=new ch,this.optionsContextMin=new ch;}},cf=(e,t)=>{if(e.length!==t.length)return  false;for(let s=0;s<e.length;++s)if(e[s]!==t[s])return  false;return  true},cm=e=>1!==e.r||1!==e.g||1!==e.b,c_=e=>0!==e.r||0!==e.g||0!==e.b;class cg{updateMinRef(e,t,s,i,n,r){this._updateSharedOptions(e,t,s,i,n),this._updateMinOptions(e,s,n),this._updateUVOptions(e,s,i,true);}updateRef(e,t,s,i,n,r,a){this._updateSharedOptions(e,t,i,n,r),this._updateEnvOptions(e,i,t,s),this._updateMaterialOptions(e,i,t),e.litOptions.hasTangents=n&&(512&n)!=0,this._updateLightOptions(e,t,i,n,a),this._updateUVOptions(e,i,n,false,s);}_updateSharedOptions(e,t,s,i,n){e.forceUv1=s.forceUv1,s.userAttributes&&(e.litOptions.userAttributes=Object.fromEntries(s.userAttributes.entries())),e.litOptions.chunks=s.chunks||{},e.litOptions.pass=n,e.litOptions.alphaTest=s.alphaTest>0,e.litOptions.blendType=s.blendType,e.litOptions.screenSpace=i&&(256&i)!=0,e.litOptions.skin=i&&(2&i)!=0,e.litOptions.batch=i&&(16384&i)!=0,e.litOptions.useInstancing=i&&(32&i)!=0,e.litOptions.useMorphPosition=i&&(1024&i)!=0,e.litOptions.useMorphNormal=i&&(2048&i)!=0,e.litOptions.useMorphTextureBasedInt=i&&(8192&i)!=0,e.litOptions.nineSlicedMode=s.nineSlicedMode||0,t.clusteredLightingEnabled&&s.useLighting?(e.litOptions.clusteredLightingEnabled=true,e.litOptions.clusteredLightingCookiesEnabled=t.lighting.cookiesEnabled,e.litOptions.clusteredLightingShadowsEnabled=t.lighting.shadowsEnabled,e.litOptions.clusteredLightingShadowType=t.lighting.shadowType,e.litOptions.clusteredLightingAreaLightsEnabled=t.lighting.areaLightsEnabled):(e.litOptions.clusteredLightingEnabled=false,e.litOptions.clusteredLightingCookiesEnabled=false,e.litOptions.clusteredLightingShadowsEnabled=false,e.litOptions.clusteredLightingAreaLightsEnabled=false);}_updateUVOptions(e,t,s,i,n){let r=false,a=false,o=false;s&&(r=(4&s)!=0,a=(8&s)!=0,o=(16&s)!=0),e.litOptions.vertexColors=false,this._mapXForms=[];let l={};for(let s in cc)this._updateTexOptions(e,t,s,r,a,o,i,l);this._mapXForms=null,e.litOptions.ssao=null==n?void 0:n.ssaoEnabled,e.useAO=e.litOptions.ssao,e.litOptions.lightMapEnabled=e.lightMap,e.litOptions.dirLightMapEnabled=e.dirLightMap,e.litOptions.useHeights=e.heightMap,e.litOptions.useNormals=e.normalMap,e.litOptions.useClearCoatNormals=e.clearCoatNormalMap,e.litOptions.useAo=e.aoMap||e.aoVertexColor||e.litOptions.ssao,e.litOptions.diffuseMapEnabled=e.diffuseMap;}_updateTexOptions(e,t,s,i,n,r,a,o){let l="opacity"===s;if(!a||l){let a=""+s+"Map",h=""+s+"VertexColor",d=""+s+"VertexColorChannel",c=""+a+"Channel",u=""+a+"Transform",p=""+a+"Uv",f=""+a+"Identifier";if("light"!==s&&(e[a]=false,e[f]=void 0,e[c]="",e[u]=0,e[p]=0),e[h]=false,e[d]="",l&&3===t.blendType&&0===t.alphaTest&&!t.alphaToCoverage&&t.opacityDither===ai)return;if("height"!==s&&t[h]&&r&&(e[h]=t[h],e[d]=t[d],e.litOptions.vertexColors=true),t[a]){let r=true;if(0!==t[p]||i||(r=false),1!==t[p]||n||(r=false),r){let i=t[a].id,n=o[i];void 0===n&&(o[i]=s,n=s),e[a]=!!t[a],e[f]=n,e[u]=this._getMapTransformID(t.getUniform(u),t[p]),e[c]=t[c],e[p]=t[p];}}}}_updateMinOptions(e,t,s){let i=1===s;e.litOptions.opacityShadowDither=i?t.opacityDither:t.opacityShadowDither,e.litOptions.linearDepth=i,e.litOptions.lights=[];}_updateMaterialOptions(e,t,s){var i,n,r,a,o,l;let h=!!(t.useMetalness||t.specularMap||t.sphereMap||t.cubeMap||c_(t.specular)||t.specularityFactor>0&&t.useMetalness||t.enableGGXSpecular||t.clearCoat>0),d=!t.useMetalness||t.useMetalnessSpecularColor,c=h&&(t.specularTint||!t.specularMap&&!t.specularVertexColor)&&cm(t.specular),u=h&&t.useMetalnessSpecularColor&&(t.specularityFactorTint||t.specularityFactor<1&&!t.specularityFactorMap),p=e=>!!e&&(10===e.format||e.type===tC),f=(e,t)=>1e-4>Math.abs(e-t);e.specularTint=c,e.specularityFactorTint=u,e.metalnessTint=t.useMetalness&&t.metalness<1,e.glossTint=true,e.diffuseEncoding=null==(i=t.diffuseMap)?void 0:i.encoding,e.diffuseDetailEncoding=null==(n=t.diffuseDetailMap)?void 0:n.encoding,e.emissiveEncoding=null==(r=t.emissiveMap)?void 0:r.encoding,e.lightMapEncoding=null==(a=t.lightMap)?void 0:a.encoding,e.packedNormal=p(t.normalMap),e.refractionTint=f(t.refraction,1),e.refractionIndexTint=f(t.refractionIndex,1/1.5),e.thicknessTint=t.useDynamicRefraction&&1!==t.thickness,e.specularEncoding=null==(o=t.specularMap)?void 0:o.encoding,e.sheenEncoding=null==(l=t.sheenMap)?void 0:l.encoding,e.aoMapUv=t.aoUvSet,e.aoDetail=!!t.aoDetailMap,e.diffuseDetail=!!t.diffuseDetailMap,e.normalDetail=!!t.normalMap,e.normalDetailPackedNormal=p(t.normalDetailMap),e.diffuseDetailMode=t.diffuseDetailMode,e.aoDetailMode=t.aoDetailMode,e.clearCoatTint=f(t.clearCoat,1),e.clearCoatGloss=!!t.clearCoatGloss,e.clearCoatGlossTint=1!==t.clearCoatGloss,e.clearCoatPackedNormal=p(t.clearCoatNormalMap),e.iorTint=f(t.refractionIndex,1/1.5),s.forcePassThroughSpecular&&(e.specularEncoding="linear",e.sheenEncoding="linear"),e.iridescenceTint=1!==t.iridescence,e.glossInvert=t.glossInvert,e.sheenGlossInvert=t.sheenGlossInvert,e.clearCoatGlossInvert=t.clearCoatGlossInvert,e.useSpecularColor=d,e.litOptions.separateAmbient=false,e.litOptions.customFragmentShader=t.customFragmentShader,e.litOptions.pixelSnap=t.pixelSnap,e.litOptions.ambientSH=!!t.ambientSH,e.litOptions.twoSidedLighting=t.twoSidedLighting,e.litOptions.occludeSpecular=t.occludeSpecular,e.litOptions.occludeSpecularFloat=1!==t.occludeSpecularIntensity,e.litOptions.useMsdf=!!t.msdfMap,e.litOptions.msdfTextAttribute=!!t.msdfTextAttribute,e.litOptions.alphaToCoverage=t.alphaToCoverage,e.litOptions.opacityFadesSpecular=t.opacityFadesSpecular,e.litOptions.opacityDither=t.opacityDither,e.litOptions.cubeMapProjection=t.cubeMapProjection,e.litOptions.occludeDirect=t.occludeDirect,e.litOptions.useSpecular=h,e.litOptions.useSpecularityFactor=(u||!!t.specularityFactorMap)&&t.useMetalnessSpecularColor,e.litOptions.enableGGXSpecular=t.enableGGXSpecular,e.litOptions.fresnelModel=t.fresnelModel,e.litOptions.useRefraction=(t.refraction||!!t.refractionMap)&&(t.useDynamicRefraction||e.litOptions.reflectionSource!==r0),e.litOptions.useClearCoat=!!t.clearCoat,e.litOptions.useSheen=t.useSheen,e.litOptions.useIridescence=t.useIridescence&&0!==t.iridescence,e.litOptions.useMetalness=t.useMetalness,e.litOptions.useDynamicRefraction=t.useDynamicRefraction,e.litOptions.dispersion=t.dispersion>0,e.litOptions.shadowCatcher=t.shadowCatcher;}_updateEnvOptions(e,t,s,i){e.litOptions.fog=t.useFog?i.fog:rH,e.litOptions.gamma=i.shaderOutputGamma,e.litOptions.toneMap=t.useTonemap?i.toneMapping:6;let n=false;if(t.envAtlas&&t.cubeMap?(e.litOptions.reflectionSource=r2,e.litOptions.reflectionEncoding=t.envAtlas.encoding,e.litOptions.reflectionCubemapEncoding=t.cubeMap.encoding):t.envAtlas?(e.litOptions.reflectionSource=r1,e.litOptions.reflectionEncoding=t.envAtlas.encoding):t.cubeMap?(e.litOptions.reflectionSource=r3,e.litOptions.reflectionEncoding=t.cubeMap.encoding):t.sphereMap?(e.litOptions.reflectionSource=r4,e.litOptions.reflectionEncoding=t.sphereMap.encoding):t.useSkybox&&s.envAtlas&&s.skybox?(e.litOptions.reflectionSource=r2,e.litOptions.reflectionEncoding=s.envAtlas.encoding,e.litOptions.reflectionCubemapEncoding=s.skybox.encoding,n=true):t.useSkybox&&s.envAtlas?(e.litOptions.reflectionSource=r1,e.litOptions.reflectionEncoding=s.envAtlas.encoding,n=true):t.useSkybox&&s.skybox?(e.litOptions.reflectionSource=r3,e.litOptions.reflectionEncoding=s.skybox.encoding,n=true):(e.litOptions.reflectionSource=r0,e.litOptions.reflectionEncoding=null),t.ambientSH)e.litOptions.ambientSource=r6,e.litOptions.ambientEncoding=null;else {let i=t.envAtlas||(t.useSkybox&&s.envAtlas?s.envAtlas:null);i&&!t.sphereMap?(e.litOptions.ambientSource=r8,e.litOptions.ambientEncoding=i.encoding):(e.litOptions.ambientSource=r9,e.litOptions.ambientEncoding=null);}e.litOptions.skyboxIntensity=n,e.litOptions.useCubeMapRotation=n&&s._skyboxRotationShaderInclude;}_updateLightOptions(e,t,s,i,n){if(e.lightMap=false,e.lightMapChannel="",e.lightMapUv=0,e.lightMapTransform=0,e.litOptions.lightMapWithoutAmbient=false,e.dirLightMap=false,i&&(e.litOptions.noShadow=(1&i)!=0,(64&i)!=0&&(e.lightMapEncoding=7===t.lightmapPixelFormat?"rgbm":"linear",e.lightMap=true,e.lightMapChannel="rgb",e.lightMapUv=1,e.lightMapTransform=0,e.litOptions.lightMapWithoutAmbient=!s.lightMap,(128&i)!=0&&(e.dirLightMap=true),(4096&i)!=0&&(e.litOptions.lightMapWithoutAmbient=false))),s.useLighting){let t=[],s=i?i>>16:1;e.litOptions.lightMaskDynamic=!!(1&s),n&&(ce.collectLights(0,n[0],t,s),ce.collectLights(1,n[1],t,s),ce.collectLights(2,n[2],t,s)),e.litOptions.lights=t;}else e.litOptions.lights=[];0===e.litOptions.lights.length&&(e.litOptions.noShadow=true);}_getMapTransformID(e,t){if(!e)return 0;let s=this._mapXForms[t];s||(s=[],this._mapXForms[t]=s);for(let t=0;t<s.length;t++)if(cf(s[t][0].value,e[0].value)&&cf(s[t][1].value,e[1].value))return t+1;return s.push(e)}constructor(){this._mapXForms=null;}}function cv(){return (cv=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i]);}return e}).apply(this,arguments)}function cy(e,t,s){ void 0===t&&(t=true),void 0===s&&(s=true);let i={};return i[""+e+"Map"]="texture",i[""+e+"MapTiling"]="vec2",i[""+e+"MapOffset"]="vec2",i[""+e+"MapRotation"]="number",i[""+e+"MapUv"]="number",t&&(i[""+e+"MapChannel"]="string",s&&(i[""+e+"VertexColor"]="boolean",i[""+e+"VertexColorChannel"]="string")),i}let cS=cv({name:"string",chunks:"chunks",mappingFormat:"string",_engine:"boolean",ambient:"rgb"},cy("ao"),cy("aoDetail",true,false),{aoDetailMode:"string",diffuse:"rgb"},cy("diffuse"),cy("diffuseDetail",true,false),{diffuseDetailMode:"string",specular:"rgb",specularTint:"boolean"},cy("specular"),{occludeSpecular:"enum:occludeSpecular",specularityFactor:"number",specularityFactorTint:"boolean"},cy("specularityFactor"),{useMetalness:"boolean",metalness:"number",enableGGXSpecular:"boolean",anisotropy:"number",metalnessTint:"boolean"},cy("metalness"),{useMetalnessSpecularColor:"boolean",shininess:"number",gloss:"number",glossInvert:"boolean"},cy("gloss"),{clearCoat:"number"},cy("clearCoat"),{clearCoatGloss:"number",clearCoatGlossInvert:"boolean"},cy("clearCoatGloss"),{clearCoatBumpiness:"number"},cy("clearCoatNormal",false),{useSheen:"boolean",sheen:"rgb"},cy("sheen"),{sheenGloss:"number",sheenGlossInvert:"boolean"},cy("sheenGloss"),{fresnelModel:"number",emissive:"rgb"},cy("emissive"),{emissiveIntensity:"number"},cy("normal",false),{bumpiness:"number"},cy("normalDetail",false),{normalDetailMapBumpiness:"number"},cy("height",true,false),{heightMapFactor:"number",alphaToCoverage:"boolean",alphaTest:"number",alphaFade:"number",opacity:"number"},cy("opacity"),{opacityFadesSpecular:"boolean",opacityDither:"string",opacityShadowDither:"string",reflectivity:"number",refraction:"number",refractionTint:"boolean"},cy("refraction"),{refractionIndex:"number",dispersion:"number",thickness:"number",thicknessTint:"boolean"},cy("thickness"),{attenuation:"rgb",attenuationDistance:"number",useDynamicRefraction:"boolean",sphereMap:"texture",cubeMap:"cubemap",cubeMapProjection:"number",cubeMapProjectionBox:"boundingbox",useIridescence:"boolean",iridescence:"number",iridescenceTint:"boolean"},cy("iridescence"),{iridescenceThicknessTint:"boolean",iridescenceThicknessMin:"number",iridescenceThicknessMax:"number",iridescenceRefractionIndex:"number"},cy("iridescenceThickness"),cy("light"),{depthTest:"boolean",depthFunc:"enum:depthFunc",depthWrite:"boolean",depthBias:"number",slopeDepthBias:"number",cull:"enum:cull",blendType:"enum:blendType",useFog:"boolean",useLighting:"boolean",useSkybox:"boolean",useTonemap:"boolean",envAtlas:"texture",twoSidedLighting:"boolean",shadowCatcher:"boolean"}),cx=[];for(let e in cS)"texture"===cS[e]&&cx.push(e);let cT=[];for(let e in cS)"cubemap"===cS[e]&&cT.push(e);let cb={aoMapVertexColor:"boolean",diffuseMapTint:"boolean",diffuseMapVertexColor:"boolean",emissiveMapTint:"boolean",emissiveMapVertexColor:"boolean",glossMapVertexColor:"boolean",metalnessMapVertexColor:"boolean",opacityMapVertexColor:"boolean",specularAntialias:"boolean",specularMapTint:"boolean",specularMapVertexColor:"boolean",ambientTint:"boolean",emissiveTint:"boolean",diffuseTint:"boolean",sheenTint:"boolean",conserveEnergy:"boolean",useGamma:"boolean",useGammaTonemap:"boolean",sheenGlossTint:"boolean"},cE={},cA={},cw=new Set,cC=new en;class cP extends o8{reset(){Object.keys(cE).forEach(e=>{this["_"+e]=cE[e].value();}),this._uniformCache={};}copy(e){return super.copy(e),Object.keys(cE).forEach(t=>{this[t]=e[t];}),this.userAttributes=new Map(e.userAttributes),this}setAttribute(e,t){this.userAttributes.set(t,e);}_setParameter(e,t){cw.add(e),this.setParameter(e,t);}_setParameters(e){e.forEach(e=>{this._setParameter(e.name,e.value);});}_processParameters(e){let t=this[e];t.forEach(e=>{cw.has(e)||delete this.parameters[e];}),this[e]=cw,(cw=t).clear();}_updateMap(e){let t=""+e+"Map",s=this[t];if(s){this._setParameter("texture_"+t,s);let e=this.getUniform(""+t+"Transform");e&&this._setParameters(e);}}_allocUniform(e,t){let s=this._uniformCache[e];return s||(s=t(),this._uniformCache[e]=s),s}getUniform(e,t,s){return cA[e](this,t,s)}updateUniforms(e,t){let s=s=>this.getUniform(s,e,t);for(let e in this._setParameter("material_ambient",s("ambient")),this._setParameter("material_diffuse",s("diffuse")),this._setParameter("material_aoIntensity",this.aoIntensity),this.useMetalness?((!this.metalnessMap||this.metalness<1)&&this._setParameter("material_metalness",this.metalness),(!this.specularMap||this.specularTint)&&this._setParameter("material_specular",s("specular")),(!this.specularityFactorMap||this.specularityFactorTint)&&this._setParameter("material_specularityFactor",this.specularityFactor),this._setParameter("material_sheen",s("sheen")),this._setParameter("material_sheenGloss",this.sheenGloss),this._setParameter("material_refractionIndex",this.refractionIndex)):(!this.specularMap||this.specularTint)&&this._setParameter("material_specular",s("specular")),this.enableGGXSpecular&&this._setParameter("material_anisotropy",this.anisotropy),this.clearCoat>0&&(this._setParameter("material_clearCoat",this.clearCoat),this._setParameter("material_clearCoatGloss",this.clearCoatGloss),this._setParameter("material_clearCoatBumpiness",this.clearCoatBumpiness)),this._setParameter("material_gloss",this.gloss),this._setParameter("material_emissive",s("emissive")),this._setParameter("material_emissiveIntensity",this.emissiveIntensity),this.refraction>0&&this._setParameter("material_refraction",this.refraction),this.dispersion>0&&this._setParameter("material_dispersion",this.dispersion),this.useDynamicRefraction&&(this._setParameter("material_thickness",this.thickness),this._setParameter("material_attenuation",s("attenuation")),this._setParameter("material_invAttenuationDistance",0===this.attenuationDistance?0:1/this.attenuationDistance)),this.useIridescence&&(this._setParameter("material_iridescence",this.iridescence),this._setParameter("material_iridescenceRefractionIndex",this.iridescenceRefractionIndex),this._setParameter("material_iridescenceThicknessMin",this.iridescenceThicknessMin),this._setParameter("material_iridescenceThicknessMax",this.iridescenceThicknessMax)),this._setParameter("material_opacity",this.opacity),false===this.opacityFadesSpecular&&this._setParameter("material_alphaFade",this.alphaFade),this.occludeSpecular&&this._setParameter("material_occludeSpecularIntensity",this.occludeSpecularIntensity),1===this.cubeMapProjection&&this._setParameter(s("cubeMapProjectionBox")),cc)this._updateMap(e);this.ambientSH&&this._setParameter("ambientSH[0]",this.ambientSH),this.normalMap&&this._setParameter("material_bumpiness",this.bumpiness),this.normalMap&&this.normalDetailMap&&this._setParameter("material_normalDetailMapBumpiness",this.normalDetailMapBumpiness),this.heightMap&&this._setParameter("material_heightMapFactor",s("heightMapFactor")),this.envAtlas&&this.cubeMap?(this._setParameter("texture_envAtlas",this.envAtlas),this._setParameter("texture_cubeMap",this.cubeMap)):this.envAtlas?this._setParameter("texture_envAtlas",this.envAtlas):this.cubeMap?this._setParameter("texture_cubeMap",this.cubeMap):this.sphereMap&&this._setParameter("texture_sphereMap",this.sphereMap),this._setParameter("material_reflectivity",this.reflectivity),this._processParameters("_activeParams"),super.updateUniforms(e,t);}updateEnvUniforms(e,t){!(this.envAtlas||this.cubeMap||this.sphereMap)&&this.useSkybox&&(t.envAtlas&&t.skybox?(this._setParameter("texture_envAtlas",t.envAtlas),this._setParameter("texture_cubeMap",t.skybox)):t.envAtlas?this._setParameter("texture_envAtlas",t.envAtlas):t.skybox&&this._setParameter("texture_cubeMap",t.skybox)),this._processParameters("_activeLightingParams");}getShaderVariant(e){let{device:t,scene:s,pass:i,objDefs:n,sortedLights:r,cameraShaderParams:a}=e;this.updateEnvUniforms(t,s);let o=ax.get(t).getByIndex(i),l=2===i||3===i||1===i||o.isShadow,h=l?cp.optionsContextMin:cp.optionsContext;h.defines=aA(this,e),l?this.shaderOptBuilder.updateMinRef(h,s,this,n,i,r):this.shaderOptBuilder.updateRef(h,s,a,this,n,i,r),this.useFog||h.defines.set("FOG","NONE"),h.defines.set("TONEMAP",rJ[h.litOptions.toneMap]),this.onUpdateShader&&(h=this.onUpdateShader(h));let d=new af(e.viewUniformFormat,e.viewBindGroupFormat,e.vertexFormat),c=ag(t);c.register("standard",cp);let u=c.getProgram("standard",h,d,this.userId);return this._dirtyShader=false,u}destroy(){for(let e in this._assetReferences)this._assetReferences[e]._unbind();this._assetReferences=null,super.destroy();}constructor(){super(),this.userAttributes=new Map,this._assetReferences={},this._activeParams=new Set,this._activeLightingParams=new Set,this.shaderOptBuilder=new cg,this.reset();}}cP.TEXTURE_PARAMETERS=cx,cP.CUBEMAP_PARAMETERS=cT;let cM=(e,t)=>{cA[e]=t;},cI=(e,t,s,i)=>{Object.defineProperty(cP.prototype,e,{get:i||function(){return this["_"+e]},set:s}),cE[e]={value:t};},cR=e=>{let t="_"+e.name,s=e.dirtyShaderFunc||(()=>true);cI(e.name,()=>e.defaultValue,function(e){let i=this[t];i!==e&&(this._dirtyShader=this._dirtyShader||s(i,e),this[t]=e);},e.getterFunc);},cL=e=>{let t="_"+e.name,s=e.dirtyShaderFunc||(()=>true);cI(e.name,()=>e.defaultValue.clone(),function(e){let i=this[t];i.equals(e)||(this._dirtyShader=this._dirtyShader||s(i,e),this[t]=i.copy(e));},e.getterFunc);},cD=e=>e.defaultValue&&e.defaultValue.clone?cL(e):cR(e);function cO(e,t,s,i){ void 0===t&&(t="rgb"),void 0===s&&(s=true),void 0===i&&(i=0),cc[e]=t.length||-1,cD({name:""+e+"Map",defaultValue:null,dirtyShaderFunc:(e,t)=>!!e!=!!t||e&&(e.type!==t.type||e.format!==t.format)}),cD({name:""+e+"MapTiling",defaultValue:new ef(1,1)}),cD({name:""+e+"MapOffset",defaultValue:new ef(0,0)}),cD({name:""+e+"MapRotation",defaultValue:0}),cD({name:""+e+"MapUv",defaultValue:i}),t&&(cD({name:""+e+"MapChannel",defaultValue:t}),s&&(cD({name:""+e+"VertexColor",defaultValue:false}),cD({name:""+e+"VertexColorChannel",defaultValue:t})));let n=""+e+"MapTiling",r=""+e+"MapOffset",a=""+e+"MapRotation",o=""+e+"MapTransform";cM(o,(e,t,s)=>{let i=e[n],l=e[r],h=e[a];if(1===i.x&&1===i.y&&0===l.x&&0===l.y&&0===h)return null;let d=e._allocUniform(o,()=>[{name:"texture_"+o+"0",value:new Float32Array(3)},{name:"texture_"+o+"1",value:new Float32Array(3)}]),c=Math.cos(h*ei.DEG_TO_RAD),u=Math.sin(h*ei.DEG_TO_RAD),p=d[0].value;p[0]=c*i.x,p[1]=-u*i.y,p[2]=l.x;let f=d[1].value;return f[0]=u*i.x,f[1]=c*i.y,f[2]=1-i.y-l.y,d});}function cF(e,t){cD({name:e,defaultValue:t,getterFunc:function(){return this._dirtyShader=true,this["_"+e]}}),cM(e,(t,s,i)=>{let n=t._allocUniform(e,()=>new Float32Array(3)),r=t[e];return cC.linear(r),n[0]=cC.r,n[1]=cC.g,n[2]=cC.b,n});}function cN(e,t,s){cD({name:e,defaultValue:t,dirtyShaderFunc:(e,t)=>(0===e||1===e)!=(0===t||1===t)}),cM(e,s);}function cB(e,t){cD({name:e,defaultValue:null,dirtyShaderFunc:(e,t)=>!!e==!!t}),cM(e,t);}function cU(e,t){cD({name:e,defaultValue:t});}!function(){cF("ambient",new en(1,1,1)),cF("diffuse",new en(1,1,1)),cF("specular",new en(0,0,0)),cF("emissive",new en(0,0,0)),cF("sheen",new en(1,1,1)),cF("attenuation",new en(1,1,1)),cN("emissiveIntensity",1),cN("specularityFactor",1),cN("sheenGloss",0),cN("gloss",.25),cN("aoIntensity",1),cN("heightMapFactor",1,(e,t,s)=>.025*e.heightMapFactor),cN("opacity",1),cN("alphaFade",1),cN("alphaTest",0),cN("bumpiness",1),cN("normalDetailMapBumpiness",1),cN("reflectivity",1),cN("occludeSpecularIntensity",1),cN("refraction",0),cN("refractionIndex",1/1.5),cN("dispersion",0),cN("thickness",0),cN("attenuationDistance",0),cN("metalness",1),cN("anisotropy",0),cN("clearCoat",0),cN("clearCoatGloss",1),cN("clearCoatBumpiness",1),cN("aoUvSet",0,null),cN("iridescence",0),cN("iridescenceRefractionIndex",1/1.5),cN("iridescenceThicknessMin",0),cN("iridescenceThicknessMax",0),cB("ambientSH"),cB("cubeMapProjectionBox",(e,t,s)=>{let i=e._allocUniform("cubeMapProjectionBox",()=>[{name:"envBoxMin",value:new Float32Array(3)},{name:"envBoxMax",value:new Float32Array(3)}]),n=e.cubeMapProjectionBox.getMin(),r=i[0].value;r[0]=n.x,r[1]=n.y,r[2]=n.z;let a=e.cubeMapProjectionBox.getMax(),o=i[1].value;return o[0]=a.x,o[1]=a.y,o[2]=a.z,i}),cU("specularTint",false),cU("specularityFactorTint",false),cU("useMetalness",false),cU("useMetalnessSpecularColor",false),cU("useSheen",false),cU("enableGGXSpecular",false),cU("occludeDirect",false),cU("opacityFadesSpecular",true),cU("occludeSpecular",1),cU("fresnelModel",2),cU("useDynamicRefraction",false),cU("cubeMapProjection",0),cU("customFragmentShader",null),cU("useFog",true),cU("useLighting",true),cU("useTonemap",true),cU("useSkybox",true),cU("forceUv1",false),cU("pixelSnap",false),cU("twoSidedLighting",false),cU("nineSlicedMode",void 0),cU("msdfTextAttribute",false),cU("useIridescence",false),cU("glossInvert",false),cU("sheenGlossInvert",false),cU("clearCoatGlossInvert",false),cU("opacityDither",ai),cU("opacityShadowDither",ai),cU("shadowCatcher",false),cO("diffuse"),cO("specular"),cO("emissive"),cO("thickness","g"),cO("specularityFactor","g"),cO("normal",""),cO("metalness","g"),cO("gloss","g"),cO("opacity","a"),cO("refraction","g"),cO("height","g",false),cO("ao","g"),cO("light","rgb",true,1),cO("msdf",""),cO("diffuseDetail","rgb",false),cO("normalDetail",""),cO("aoDetail","g",false),cO("clearCoat","g"),cO("clearCoatGloss","g"),cO("clearCoatNormal",""),cO("sheen","rgb"),cO("sheenGloss","g"),cO("iridescence","g"),cO("iridescenceThickness","g"),cU("diffuseDetailMode","mul"),cU("aoDetailMode","mul"),cB("cubeMap"),cB("sphereMap"),cB("envAtlas");let e=[null,null,null,null,null,null];cI("prefilteredCubemaps",()=>e.slice(),function(e){let t=this._prefilteredCubemaps;e=e||[];let s=false,i=true;for(let n=0;n<6;++n){let r=e[n]||null;t[n]!==r&&(t[n]=r,s=true),i=i&&!!t[n];}s&&(i?this.envAtlas=dj.generatePrefilteredAtlas(t,{target:this.envAtlas}):this.envAtlas&&(this.envAtlas.destroy(),this.envAtlas=null),this._dirtyShader=true);},function(){return this._prefilteredCubemaps});}();class ck extends dn{constructor(e,t,s,i,n,r){let a;super();let o=new eu,l=new eu,h=new eu,d=new eu,c=new eu,u=new eu,p=[],f=[],m=[],_=[],g=[];if(s>0)for(let r=0;r<=i;r++)for(let a=0;a<=n;a++){let v=a/n*2*Math.PI-Math.PI,y=Math.sin(v),S=Math.cos(v);c.set(y*e,-s/2,S*e),d.set(y*t,s/2,S*t),o.lerp(c,d,r/i),l.sub2(d,c).normalize(),u.set(S,0,-y),h.cross(u,l).normalize(),p.push(o.x,o.y,o.z),f.push(h.x,h.y,h.z);let x=a/n,T=r/i;m.push(x,1-T);let b=T;if(T=x,x=.875*(x=b)+.0625,T=.875*T+.0625,x/=3,_.push(x,1-T),r<i&&a<n){let e=r*(n+1)+a,t=r*(n+1)+(a+1),s=(r+1)*(n+1)+a,i=(r+1)*(n+1)+(a+1);g.push(e,t,s),g.push(t,i,s);}}if(r){let e=Math.floor(n/2),r=s/2;for(let s=0;s<=e;s++){let i=s*Math.PI*.5/e,a=Math.sin(i),o=Math.cos(i);for(let i=0;i<=n;i++){let l=2*i*Math.PI/n-Math.PI/2,h=Math.sin(l),d=Math.cos(l)*a,c=h*a,u=1-i/n,g=1-s/e;p.push(d*t,o*t+r,c*t),f.push(d,o,c),m.push(u,1-g),g=(.875*g+.0625)/3,u=(.875*u+.0625)/3+1/3,_.push(u,1-g);}}a=(i+1)*(n+1);for(let t=0;t<e;++t)for(let e=0;e<n;++e){let s=t*(n+1)+e,i=s+n+1;g.push(a+s+1,a+i,a+s),g.push(a+s+1,a+i+1,a+i);}for(let s=0;s<=e;s++){let i=.5*Math.PI+s*Math.PI*.5/e,a=Math.sin(i),o=Math.cos(i);for(let i=0;i<=n;i++){let l=2*i*Math.PI/n-Math.PI/2,h=Math.sin(l),d=Math.cos(l)*a,c=h*a,u=1-i/n,g=1-s/e;p.push(d*t,o*t-r,c*t),f.push(d,o,c),m.push(u,1-g),g=(.875*g+.0625)/3,u=(.875*u+.0625)/3+2/3,_.push(u,1-g);}}a=(i+1)*(n+1)+(n+1)*(e+1);for(let t=0;t<e;++t)for(let e=0;e<n;++e){let s=t*(n+1)+e,i=s+n+1;g.push(a+s+1,a+i,a+s),g.push(a+s+1,a+i+1,a+i);}}else {if(a=(i+1)*(n+1),e>0)for(let t=0;t<n;t++){let i=t/n*2*Math.PI,r=Math.sin(i),o=-s/2,l=Math.cos(i),h=1-(r+1)/2,d=(l+1)/2;p.push(r*e,o,l*e),f.push(0,-1,0),m.push(h,1-d),d=(.875*d+.0625)/3,h=(.875*h+.0625)/3+1/3,_.push(h,1-d),t>1&&g.push(a,a+t,a+t-1);}if(a+=n,t>0)for(let e=0;e<n;e++){let i=e/n*2*Math.PI,r=Math.sin(i),o=s/2,l=Math.cos(i),h=1-(r+1)/2,d=(l+1)/2;p.push(r*t,o,l*t),f.push(0,1,0),m.push(h,1-d),d=(.875*d+.0625)/3,h=(.875*h+.0625)/3+2/3,_.push(h,1-d),e>1&&g.push(a,a+e-1,a+e);}}this.positions=p,this.normals=f,this.uvs=m,this.uvs1=_,this.indices=g;}}class cz extends ck{constructor(e={}){var t,s,i,n;let r=null!=(t=e.radius)?t:.3,a=null!=(s=e.height)?s:1;super(r,r,a-2*r,null!=(i=e.heightSegments)?i:1,null!=(n=e.sides)?n:20,true),e.calculateTangents&&(this.tangents=di(this.positions,this.normals,this.uvs,this.indices));}}class cV extends ck{constructor(e={}){var t,s,i,n,r;let a=null!=(t=e.baseRadius)?t:.5,o=null!=(s=e.peakRadius)?s:0,l=null!=(i=e.height)?i:1;super(a,o,l,null!=(n=e.heightSegments)?n:5,null!=(r=e.capSegments)?r:18,false),e.calculateTangents&&(this.tangents=di(this.positions,this.normals,this.uvs,this.indices));}}class cG extends ck{constructor(e={}){var t,s,i,n;let r=null!=(t=e.radius)?t:.5,a=null!=(s=e.height)?s:1;super(r,r,a,null!=(i=e.heightSegments)?i:5,null!=(n=e.capSegments)?n:20,false),e.calculateTangents&&(this.tangents=di(this.positions,this.normals,this.uvs,this.indices));}}class cH extends dn{constructor(e={}){var t,s,i;super();let n=null!=(t=e.halfExtents)?t:new ef(.5,.5),r=null!=(s=e.widthSegments)?s:5,a=null!=(i=e.lengthSegments)?i:5,o=[],l=[],h=[],d=[],c=0;for(let e=0;e<=r;e++)for(let t=0;t<=a;t++){let s=-n.x+2*n.x*e/r,i=-(-n.y+2*n.y*t/a),u=e/r,p=t/a;o.push(s,0,i),l.push(0,1,0),h.push(u,1-p),e<r&&t<a&&(d.push(c+a+1,c+1,c),d.push(c+a+1,c+a+2,c+1)),c++;}this.positions=o,this.normals=l,this.uvs=h,this.uvs1=h,this.indices=d,e.calculateTangents&&(this.tangents=di(o,l,h,d));}}class cW extends dn{constructor(e={}){var t,s,i,n,r;super();let a=null!=(t=e.tubeRadius)?t:.2,o=null!=(s=e.ringRadius)?s:.3,l=(null!=(i=e.sectorAngle)?i:360)*ei.DEG_TO_RAD,h=null!=(n=e.segments)?n:30,d=null!=(r=e.sides)?r:20,c=[],u=[],p=[],f=[];for(let e=0;e<=d;e++)for(let t=0;t<=h;t++){let s=Math.cos(l*t/h)*(o+a*Math.cos(2*Math.PI*e/d)),i=Math.sin(2*Math.PI*e/d)*a,n=Math.sin(l*t/h)*(o+a*Math.cos(2*Math.PI*e/d)),r=Math.cos(l*t/h)*Math.cos(2*Math.PI*e/d),m=Math.sin(2*Math.PI*e/d),_=Math.sin(l*t/h)*Math.cos(2*Math.PI*e/d),g=e/d,v=1-t/h;if(c.push(s,i,n),u.push(r,m,_),p.push(g,1-v),e<d&&t<h){let s=e*(h+1)+t,i=(e+1)*(h+1)+t,n=e*(h+1)+(t+1),r=(e+1)*(h+1)+(t+1);f.push(s,i,n),f.push(i,r,n);}}this.positions=c,this.normals=u,this.uvs=p,this.uvs1=p,this.indices=f,e.calculateTangents&&(this.tangents=di(c,u,p,f));}}class cX{destroy(){this.clearCache();}register(e,t){this._generators.has(e)||this._generators.set(e,t);}unregister(e){this._generators.has(e)&&this._generators.delete(e);}isRegistered(e){return this._generators.has(e)}generateShaderDefinition(e,t,s,i){let n=this.definitionsCache.get(s);if(!n){var r,a,o;let l;(null==(r=i.litOptions)?void 0:r.lights)&&(l=i.litOptions.lights,i.litOptions.lights=l.map(e=>{let t=e.clone?e.clone():e;return t.key=e.key,t})),this.storeNewProgram(t,i),(null==(a=i.litOptions)?void 0:a.lights)&&(i.litOptions.lights=l),this._precached;let h=this._device;(n=e.createShaderDefinition(h,i)).name=null!=(o=n.name)?o:i.pass?t+"-pass:"+i.pass:t,this.definitionsCache.set(s,n);}return n}getCachedShader(e){return this.processedCache.get(e)}setCachedShader(e,t){this.processedCache.set(e,t);}getProgram(e,t,s,i){let n=this._generators.get(e);if(!n)return null;let r=sS(n.generateKey(t)),a=r+"#"+sS(s.generateKey(this._device)),o=this.getCachedShader(a);if(!o){let l;let h=this.generateShaderDefinition(n,e,r,t),d="";void 0!==t.pass&&(d="-"+(l=ax.get(this._device).getByIndex(t.pass)).name),this._device.fire("shader:generate",{userMaterialId:i,shaderPassInfo:l,definition:h});let c={name:""+h.name+d+"-proc",attributes:h.attributes,vshader:h.vshader,vincludes:h.vincludes,fincludes:h.fincludes,fshader:h.fshader,processingOptions:s,shaderLanguage:h.shaderLanguage,meshUniformBufferFormat:h.meshUniformBufferFormat,meshBindGroupFormat:h.meshBindGroupFormat};o=new ns(this._device,c),this.setCachedShader(a,o);}return o}storeNewProgram(e,t){let s={};if("standard"===e){let e=this._getDefaultStdMatOptions(t.pass);for(let i in t)(t.hasOwnProperty(i)&&e[i]!==t[i]||"pass"===i)&&(s[i]=t[i]);for(let e in t.litOptions)s[e]=t.litOptions[e];}else s=t;this._programsCollection.push(JSON.stringify({name:e,options:s}));}dumpPrograms(){let e="let device = pc.app ? pc.app.graphicsDevice : pc.Application.getApplication().graphicsDevice;\n";e+="let shaders = [",this._programsCollection[0]&&(e+="\n	"+this._programsCollection[0]);for(let t=1;t<this._programsCollection.length;++t)e+=",\n	"+this._programsCollection[t];e+="\n];\npc.getProgramLibrary(device).precompile(shaders);\n"+('if (pc.version != "'+A+'" || pc.revision != "'+w)+'")\n	console.warn("precompile-shaders.js: engine version mismatch, rebuild shaders lib with current engine");';let t=document.createElement("a");t.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(e)),t.setAttribute("download","precompile-shaders.js"),t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t);}clearCache(){this._isClearingCache=true,this.processedCache.forEach(e=>{e.destroy();}),this.processedCache.clear(),this._isClearingCache=false;}removeFromCache(e){!this._isClearingCache&&this.processedCache.forEach((t,s)=>{e===t&&this.processedCache.delete(s);});}_getDefaultStdMatOptions(e){let t=ax.get(this._device).getByIndex(e);return 2===e||3===e||1===e||t.isShadow?this._defaultStdMatOptionMin:this._defaultStdMatOption}precompile(e){if(e){let t=Array(e.length);for(let s=0;s<e.length;s++){if("standard"===e[s].name){let t=e[s].options,i=this._getDefaultStdMatOptions(t.pass);for(let e in i)i.hasOwnProperty(e)&&void 0===t[e]&&(t[e]=i[e]);}t[s]=this.getProgram(e[s].name,e[s].options);}}this._precached=true;}constructor(e,t){this.processedCache=new Map,this.definitionsCache=new Map,this._generators=new Map,this._device=e,this._isClearingCache=false,this._precached=false,this._programsCollection=[],this._defaultStdMatOption=new ch,this._defaultStdMatOptionMin=new ch;let s=new ot;t.shaderOptBuilder.updateRef(this._defaultStdMatOption,{},s,t,null,[],0,null),t.shaderOptBuilder.updateMinRef(this._defaultStdMatOptionMin,{},t,null,4,null),e.on("destroy:shader",e=>{this.removeFromCache(e);});}}let cY={bakeDirLmEndPS:"\n	vec4 dirLm = texture2D(texture_dirLightMap, vUv1);\n	if (bakeDir > 0.5) {\n		if (dAtten > 0.00001) {\n			dirLm.xyz = dirLm.xyz * 2.0 - vec3(1.0);\n			dAtten = saturate(dAtten);\n			gl_FragColor.rgb = normalize(dLightDirNormW.xyz*dAtten + dirLm.xyz*dirLm.w) * 0.5 + vec3(0.5);\n			gl_FragColor.a = dirLm.w + dAtten;\n			gl_FragColor.a = max(gl_FragColor.a, 1.0 / 255.0);\n		} else {\n			gl_FragColor = dirLm;\n		}\n	} else {\n		gl_FragColor.rgb = dirLm.xyz;\n		gl_FragColor.a = max(dirLm.w, dAtten > 0.00001? (1.0/255.0) : 0.0);\n	}\n",bakeLmEndPS:"\n#ifdef LIGHTMAP_RGBM\n	gl_FragColor.rgb = dDiffuseLight;\n	gl_FragColor.rgb = pow(gl_FragColor.rgb, vec3(0.5));\n	gl_FragColor.rgb /= 8.0;\n	gl_FragColor.a = clamp( max( max( gl_FragColor.r, gl_FragColor.g ), max( gl_FragColor.b, 1.0 / 255.0 ) ), 0.0,1.0 );\n	gl_FragColor.a = ceil(gl_FragColor.a * 255.0) / 255.0;\n	gl_FragColor.rgb /= gl_FragColor.a;\n#else\n	gl_FragColor = vec4(dDiffuseLight, 1.0);\n#endif\n",dilatePS:"\nvarying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\nbool isUsed(vec4 pixel) {\n	#if HDR\n		return any(greaterThan(pixel.rgb, vec3(0.0)));\n	#else\n		return pixel.a > 0.0;\n	#endif\n}\nvoid main(void) {\n	vec4 c = texture2DLod(source, vUv0, 0.0);\n	c = isUsed(c) ? c : texture2DLod(source, vUv0 - pixelOffset, 0.0);\n	c = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(0, -pixelOffset.y), 0.0);\n	c = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(pixelOffset.x, -pixelOffset.y), 0.0);\n	c = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(-pixelOffset.x, 0), 0.0);\n	c = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(pixelOffset.x, 0), 0.0);\n	c = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(-pixelOffset.x, pixelOffset.y), 0.0);\n	c = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(0, pixelOffset.y), 0.0);\n	c = isUsed(c) ? c : texture2DLod(source, vUv0 + pixelOffset, 0.0);\n	gl_FragColor = c;\n}\n",bilateralDeNoisePS:"\nfloat normpdf3(in vec3 v, in float sigma) {\n	return 0.39894 * exp(-0.5 * dot(v, v) / (sigma * sigma)) / sigma;\n}\nvec3 decodeRGBM(vec4 rgbm) {\n	vec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n	return color * color;\n}\nfloat saturate(float x) {\n	return clamp(x, 0.0, 1.0);\n}\nvec4 encodeRGBM(vec3 color) {\n	vec4 encoded;\n	encoded.rgb = pow(color.rgb, vec3(0.5));\n	encoded.rgb *= 1.0 / 8.0;\n	encoded.a = saturate( max( max( encoded.r, encoded.g ), max( encoded.b, 1.0 / 255.0 ) ) );\n	encoded.a = ceil(encoded.a * 255.0) / 255.0;\n	encoded.rgb /= encoded.a;\n	return encoded;\n}\nvec3 decode(vec4 pixel) {\n	#if HDR\n		return pixel.rgb;\n	#else\n		return decodeRGBM(pixel);\n	#endif\n}\nbool isUsed(vec4 pixel) {\n	#if HDR\n		return any(greaterThan(pixel.rgb, vec3(0.0)));\n	#else\n		return pixel.a > 0.0;\n	#endif\n}\n#define MSIZE 15\nvarying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\nuniform vec2 sigmas;\nuniform float bZnorm;\nuniform float kernel[MSIZE];\nvoid main(void) {\n	\n	vec4 pixel = texture2DLod(source, vUv0, 0.0);\n	if (!isUsed(pixel)) {\n		gl_FragColor = pixel;\n		return ;\n	}\n	float sigma = sigmas.x;\n	float bSigma = sigmas.y;\n	vec3 pixelHdr = decode(pixel);\n	vec3 accumulatedHdr = vec3(0.0);\n	float accumulatedFactor = 0.000001;\n	const int kSize = (MSIZE-1)/2;\n	for (int i = -kSize; i <= kSize; ++i) {\n		for (int j = -kSize; j <= kSize; ++j) {\n			\n			vec2 coord = vUv0 + vec2(float(i), float(j)) * pixelOffset;\n			vec4 pix = texture2DLod(source, coord, 0.0);\n			if (isUsed(pix)) {\n				vec3 hdr = decode(pix);\n				float factor = kernel[kSize + j] * kernel[kSize + i];\n				factor *= normpdf3(hdr - pixelHdr, bSigma) * bZnorm;\n				accumulatedHdr += factor * hdr;\n				accumulatedFactor += factor;\n			}\n		}\n	}\n	vec3 finalHDR = accumulatedHdr / accumulatedFactor;\n	#if HDR\n		gl_FragColor = vec4(finalHDR, 1.0);\n	#else\n		gl_FragColor = encodeRGBM(finalHDR);\n	#endif\n}\n"},cj=new ex,cq=new eT,cK=new eP,cZ=new eP,cQ=new en(1,1,0,.4);class cJ{constructor(e,t,s,i,n){let r=e.getProp("x"),a=e.getProp("y"),o=e.getProp("z"),l=e.getProp("rot_1"),h=e.getProp("rot_2"),d=e.getProp("rot_3"),c=e.getProp("rot_0"),u=e.getProp("scale_0"),p=e.getProp("scale_1"),f=e.getProp("scale_2"),m=e.getProp("f_dc_0"),_=e.getProp("f_dc_1"),g=e.getProp("f_dc_2"),v=e.getProp("opacity"),y=e=>{if(e>0)return 1/(1+Math.exp(-e));let t=Math.exp(e);return t/(1+t)};this.read=e=>{t&&(t.x=r[e],t.y=a[e],t.z=o[e]),s&&s.set(l[e],h[e],d[e],c[e]),i&&i.set(Math.exp(u[e]),Math.exp(p[e]),Math.exp(f[e])),n&&n.set(.5+.28209479177387814*m[e],.5+.28209479177387814*_[e],.5+.28209479177387814*g[e],y(v[e]));};}}let c$=(e,t,s)=>{cq.set(s.x,s.y,s.z,s.w).normalize(),e.setTRS(t,cq,eu.ONE);};class c0{static calcSplatAabb(e,t,s,i){c$(cj,t,s),cK.center.set(0,0,0),cK.halfExtents.set(2*i.x,2*i.y,2*i.z),e.setFromTransformedAabb(cK,cj);}getProp(e,t){var s,i;return void 0===t&&(t="vertex"),null==(i=this.getElement(t))?void 0:null==(s=i.properties.find(t=>t.name===e))?void 0:s.storage}getElement(e){return this.elements.find(t=>t.name===e)}addProp(e,t){this.getElement("vertex").properties.push({type:"float",name:e,storage:t,byteSize:4});}createIter(e,t,s,i){return new cJ(this,e,t,s,i)}calcAabb(e,t){let s,i,n,r,a,o;let l=true,h=this.getProp("x"),d=this.getProp("y"),c=this.getProp("z"),u=this.getProp("scale_0"),p=this.getProp("scale_1"),f=this.getProp("scale_2");for(let e=0;e<this.numSplats;++e){if(t&&!t(e))continue;let m=h[e],_=d[e],g=c[e],v=Math.max(u[e],p[e],f[e]);if(!isFinite(m)||!isFinite(_)||!isFinite(g)||!isFinite(v))continue;let y=2*Math.exp(v);l?(l=false,s=m-y,i=_-y,n=g-y,r=m+y,a=_+y,o=g+y):(s=Math.min(s,m-y),i=Math.min(i,_-y),n=Math.min(n,g-y),r=Math.max(r,m+y),a=Math.max(a,_+y),o=Math.max(o,g+y));}return l||(e.center.set((s+r)*.5,(i+a)*.5,(n+o)*.5),e.halfExtents.set((r-s)*.5,(a-i)*.5,(o-n)*.5)),!l}calcAabbExact(e,t){let s=new eu,i=new eT,n=new eu,r=this.createIter(s,i,n),a=true;for(let o=0;o<this.numSplats;++o)(!t||t(o))&&(r.read(o),a?(a=false,c0.calcSplatAabb(e,s,i,n)):(c0.calcSplatAabb(cZ,s,i,n),e.add(cZ)));return !a}getCenters(e){let t=this.getProp("x"),s=this.getProp("y"),i=this.getProp("z");for(let n=0;n<this.numSplats;++n)e[3*n+0]=t[n],e[3*n+1]=s[n],e[3*n+2]=i[n];}calcFocalPoint(e,t){let s=this.getProp("x"),i=this.getProp("y"),n=this.getProp("z"),r=this.getProp("scale_0"),a=this.getProp("scale_1"),o=this.getProp("scale_2");e.x=0,e.y=0,e.z=0;let l=0;for(let h=0;h<this.numSplats;++h){if(t&&!t(h))continue;let d=s[h],c=i[h],u=n[h];if(!isFinite(d)||!isFinite(c)||!isFinite(u))continue;let p=1/(1+Math.exp(Math.max(r[h],a[h],o[h])));e.x+=d*p,e.y+=c*p,e.z+=u*p,l+=p;}e.mulScalar(1/l);}renderWireframeBounds(e,t){let s=new eu,i=new eT,n=new eu,r=new eu,a=new eu,o=this.createIter(s,i,n);for(let l=0;l<this.numSplats;++l)o.read(l),c$(cj,s,i),cj.mul2(t,cj),r.set(-2*n.x,-2*n.y,-2*n.z),a.set(2*n.x,2*n.y,2*n.z),e.immediate.drawWireAlignedBox(r,a,cQ,true,e.defaultDrawLayer,cj);}get isCompressed(){return  false}get shBands(){var e;return null!=(e=({9:1,24:2,45:3})[(()=>{for(let e=0;e<45;++e)if(!this.getProp("f_rest_"+e))return e;return 45})()])?e:0}calcMortonOrder(){let e=e=>{let t=e[0],s=e[0];for(let i=1;i<e.length;i++)e[i]<t&&(t=e[i]),e[i]>s&&(s=e[i]);return {min:t,max:s}},t=(e,t,s)=>{let i=e=>(e&=1023,e=((e=((e=((e=(e^e<<16)&0xff0000ff)^e<<8)&0x300f00f)^e<<4)&0x30c30c3)^e<<2)&0x9249249);return (i(s)<<2)+(i(t)<<1)+i(e)},s=this.getProp("x"),i=this.getProp("y"),n=this.getProp("z"),{min:r,max:a}=e(s),{min:o,max:l}=e(i),{min:h,max:d}=e(n),c=r===a?0:1024/(a-r),u=o===l?0:1024/(l-o),p=h===d?0:1024/(d-h),f=new Map;for(let e=0;e<this.numSplats;e++){let a=Math.floor((s[e]-r)*c),l=t(a,Math.floor((i[e]-o)*u),Math.floor((n[e]-h)*p)),d=f.get(l);d?d.push(e):f.set(l,[e]);}let m=Array.from(f.keys()).sort((e,t)=>e-t),_=new Uint32Array(this.numSplats),g=0;for(let e=0;e<m.length;++e){let t=f.get(m[e]);for(let e=0;e<t.length;++e)_[g++]=t[e];}return _}reorder(e){let t=new Map,s=e=>{if(t.has(e)){let s=t.get(e);return t.delete(e),s}return new ArrayBuffer(e)},i=e=>{t.set(e.byteLength,e);},n=t=>{let n=new t.constructor(s(t.byteLength));for(let s=0;s<e.length;s++)n[s]=t[e[s]];return i(t.buffer),n};this.elements.forEach(e=>{e.properties.forEach(e=>{e.storage&&(e.storage=n(e.storage));});});}reorderData(){this.reorder(this.calcMortonOrder());}constructor(e){this.elements=e,this.numSplats=this.getElement("vertex").count;}}let c1=e=>{var t,s,i;void 0===e&&(e={});let n=null!=(t=e.dither)?t:ai,r=n!==ai,a=new h9({uniqueName:"SplatMaterial",vertexGLSL:null!=(s=e.vertex)?s:am.gsplatVS,fragmentGLSL:null!=(i=e.fragment)?i:am.gsplatPS,attributes:{vertex_position:e2,vertex_id_attrib:tS}});return a.setDefine("DITHER_"+n.toUpperCase(),""),a.cull=0,a.blendType=r?3:4,a.depthWrite=r,a.update(),a},c2=(e,t)=>{let s=[];for(let i=0;i<t;++i)s.push(e.getProp("f_rest_"+i));return s};class c3{destroy(){var e,t,s,i,n,r,a;null==(e=this.colorTexture)||e.destroy(),null==(t=this.transformATexture)||t.destroy(),null==(s=this.transformBTexture)||s.destroy(),null==(i=this.sh1to3Texture)||i.destroy(),null==(n=this.sh4to7Texture)||n.destroy(),null==(r=this.sh8to11Texture)||r.destroy(),null==(a=this.sh12to15Texture)||a.destroy();}createMaterial(e){let t=c1(e);return t.setParameter("splatColor",this.colorTexture),t.setParameter("transformA",this.transformATexture),t.setParameter("transformB",this.transformBTexture),t.setParameter("numSplats",this.numSplatsVisible),t.setDefine("SH_BANDS",this.shBands),this.sh1to3Texture&&t.setParameter("splatSH_1to3",this.sh1to3Texture),this.sh4to7Texture&&t.setParameter("splatSH_4to7",this.sh4to7Texture),this.sh8to11Texture&&t.setParameter("splatSH_8to11",this.sh8to11Texture),this.sh12to15Texture&&t.setParameter("splatSH_12to15",this.sh12to15Texture),t}evalTextureSize(e){let t=Math.ceil(Math.sqrt(e)),s=Math.ceil(e/t);return new ef(t,s)}createTexture(e,t,s){return new se(this.device,{name:e,width:s.x,height:s.y,format:t,cubemap:false,mipmaps:false,minFilter:0,magFilter:0,addressU:1,addressV:1})}updateColorData(e){let t=this.colorTexture;if(!t)return;let s=ed.float2Half,i=t.lock(),n=e.getProp("f_dc_0"),r=e.getProp("f_dc_1"),a=e.getProp("f_dc_2"),o=e.getProp("opacity");for(let e=0;e<this.numSplats;++e){let t=.28209479177387814*n[e]+.5,l=.28209479177387814*r[e]+.5,h=.28209479177387814*a[e]+.5,d=1/(1+Math.exp(-o[e]));i[4*e+0]=s(t),i[4*e+1]=s(l),i[4*e+2]=s(h),i[4*e+3]=s(d);}t.unlock();}updateTransformData(e){let t=ed.float2Half;if(!this.transformATexture)return;let s=this.transformATexture.lock(),i=new Float32Array(s.buffer),n=this.transformBTexture.lock(),r=new eu,a=new eT,o=new eu,l=e.createIter(r,a,o);for(let e=0;e<this.numSplats;e++)l.read(e),a.normalize(),a.w<0&&a.mulScalar(-1),i[4*e+0]=r.x,i[4*e+1]=r.y,i[4*e+2]=r.z,s[4*e+3]=t(a.x)|t(a.y)<<16,n[4*e+0]=t(o.x),n[4*e+1]=t(o.y),n[4*e+2]=t(o.z),n[4*e+3]=t(a.z);this.transformATexture.unlock(),this.transformBTexture.unlock();}updateSHData(e){var t,s,i,n,r,a;let o=this.sh1to3Texture.lock(),l=null==(t=this.sh4to7Texture)?void 0:t.lock(),h=null==(s=this.sh8to11Texture)?void 0:s.lock(),d=null==(i=this.sh12to15Texture)?void 0:i.lock(),c={1:3,2:8,3:15}[this.shBands],u=c2(e,3*c),p=new Float32Array(1),f=new Uint32Array(p.buffer),m=Array(3*c).fill(0);for(let t=0;t<e.numSplats;++t){for(let e=0;e<c;++e)m[3*e]=u[e][t],m[3*e+1]=u[e+c][t],m[3*e+2]=u[e+2*c][t];let e=m[0];for(let t=1;t<3*c;++t)e=Math.max(e,Math.abs(m[t]));if(0!==e){for(let t=0;t<c;++t)m[3*t+0]=Math.max(0,Math.min(2047,Math.floor((m[3*t+0]/e*.5+.5)*2047+.5))),m[3*t+1]=Math.max(0,Math.min(1023,Math.floor((m[3*t+1]/e*.5+.5)*1023+.5))),m[3*t+2]=Math.max(0,Math.min(2047,Math.floor((m[3*t+2]/e*.5+.5)*2047+.5)));p[0]=e,o[4*t+0]=f[0],o[4*t+1]=m[0]<<21|m[1]<<11|m[2],o[4*t+2]=m[3]<<21|m[4]<<11|m[5],o[4*t+3]=m[6]<<21|m[7]<<11|m[8],this.shBands>1&&(l[4*t+0]=m[9]<<21|m[10]<<11|m[11],l[4*t+1]=m[12]<<21|m[13]<<11|m[14],l[4*t+2]=m[15]<<21|m[16]<<11|m[17],l[4*t+3]=m[18]<<21|m[19]<<11|m[20],this.shBands>2?(h[4*t+0]=m[21]<<21|m[22]<<11|m[23],h[4*t+1]=m[24]<<21|m[25]<<11|m[26],h[4*t+2]=m[27]<<21|m[28]<<11|m[29],h[4*t+3]=m[30]<<21|m[31]<<11|m[32],d[4*t+0]=m[33]<<21|m[34]<<11|m[35],d[4*t+1]=m[36]<<21|m[37]<<11|m[38],d[4*t+2]=m[39]<<21|m[40]<<11|m[41],d[4*t+3]=m[42]<<21|m[43]<<11|m[44]):h[t]=m[21]<<21|m[22]<<11|m[23]);}}this.sh1to3Texture.unlock(),null==(n=this.sh4to7Texture)||n.unlock(),null==(r=this.sh8to11Texture)||r.unlock(),null==(a=this.sh12to15Texture)||a.unlock();}constructor(e,t){let s=t.numSplats;this.device=e,this.numSplats=s,this.numSplatsVisible=s,this.centers=new Float32Array(3*t.numSplats),t.getCenters(this.centers),this.aabb=new eP,t.calcAabb(this.aabb);let i=this.evalTextureSize(s);this.colorTexture=this.createTexture("splatColor",12,i),this.transformATexture=this.createTexture("transformA",49,i),this.transformBTexture=this.createTexture("transformB",12,i),this.updateColorData(t),this.updateTransformData(t),this.shBands=t.shBands,this.shBands>0&&(this.sh1to3Texture=this.createTexture("splatSH_1to3",49,i),this.shBands>1&&(this.sh4to7Texture=this.createTexture("splatSH_4to7",49,i),this.shBands>2?(this.sh8to11Texture=this.createTexture("splatSH_8to11",49,i),this.sh12to15Texture=this.createTexture("splatSH_12to15",49,i)):this.sh8to11Texture=this.createTexture("splatSH_8to11",37,i)),this.updateSHData(t));}}function c4(){let e,t,s,i,n,r,a,o;let l=false,h={x:0,y:0,z:0},d={x:0,y:0,z:0},c={x:0,y:0,z:0},u={x:0,y:0,z:0},p=Array(32).fill(0),f=Array(32).fill(0),m=Array(32).fill(0),_=(e,t,s)=>{for(;e<=t;){let i=t+e>>1,n=s(i);if(n>0)e=i+1;else {if(!(n<0))return i;t=i-1;}}return ~e},g=()=>{let g,v;if(!e||!t||0===t.length||!n||!r)return;let y=n.x,S=n.y,x=n.z,T=r.x,b=r.y,E=r.z;if(!l&&.001>Math.abs(y-h.x)&&.001>Math.abs(S-h.y)&&.001>Math.abs(x-h.z)&&.001>Math.abs(T-d.x)&&.001>Math.abs(b-d.y)&&.001>Math.abs(E-d.z))return;l=false,h.x=y,h.y=S,h.z=x,d.x=T,d.y=b,d.z=E;for(let e=0;e<8;++e){let t=1&e?c.x:u.x,s=t*T+(2&e?c.y:u.y)*b+(4&e?c.z:u.z)*E;0===e?g=v=s:(g=Math.min(g,s),v=Math.max(v,s));}let A=t.length/3,w=Math.max(10,Math.min(20,Math.round(Math.log2(A/4)))),C=2**w+1;(null==a?void 0:a.length)!==A&&(a=new Uint32Array(A)),o&&o.length===C?o.fill(0):o=new Uint32Array(C);let P=v-g;if(P<1e-6)for(let e=0;e<A;++e)a[e]=0,o[0]++;else {let e=s.length/4;p.fill(0);for(let t=0;t<e;++t){let e=s[4*t+0],i=s[4*t+1],n=s[4*t+2],r=s[4*t+3],a=e*T+i*b+n*E-g,o=Math.max(0,Math.floor((a-r)*32/P)),l=Math.min(32,Math.ceil((a+r)*32/P));for(let e=o;e<l;++e)p[e]++;}let i=p.reduce((e,t)=>e+t,0);for(let e=0;e<32;++e)m[e]=p[e]/i*C>>>0;for(let e=0;e<32;++e)f[e]=0===e?0:f[e-1]+m[e-1];let n=P/32,r=0;for(let e=0;e<A;++e){let s=t[r++],i=(s*T+t[r++]*b+t[r++]*E-g)/n,l=i>>>0,h=f[l]+m[l]*(i-l)>>>0;a[e]=h,o[h]++;}}for(let e=1;e<C;e++)o[e]+=o[e-1];for(let t=0;t<A;t++){let s=a[t];e[--o[s]]=t;}let M=y*T+S*b+x*E,I=s=>{let i=3*e[s];return t[i++]*T+t[i++]*b+t[i]*E-M},R=I(A-1)>=0?(()=>{let e=_(0,A-1,e=>-I(e));return Math.min(A,Math.abs(e))})():A;if(i)for(let t=0;t<A;++t)e[t]=i[e[t]];self.postMessage({order:e.buffer,count:R},[e.buffer]),e=null;};self.onmessage=a=>{if(a.data.order&&(e=new Uint32Array(a.data.order)),a.data.centers){if(t=new Float32Array(a.data.centers),l=true,a.data.chunks){let e=new Float32Array(a.data.chunks);s=new Float32Array(a.data.chunks,0,4*e.length/6),c.x=e[0],c.y=e[1],c.z=e[2],u.x=e[3],u.y=e[4],u.z=e[5];for(let t=0;t<e.length/6;++t){let i=e[6*t+0],n=e[6*t+1],r=e[6*t+2],a=e[6*t+3],o=e[6*t+4],l=e[6*t+5];s[4*t+0]=(i+a)*.5,s[4*t+1]=(n+o)*.5,s[4*t+2]=(r+l)*.5,s[4*t+3]=.5*Math.sqrt((a-i)**2+(o-n)**2+(l-r)**2),i<c.x&&(c.x=i),n<c.y&&(c.y=n),r<c.z&&(c.z=r),a>u.x&&(u.x=a),o>u.y&&(u.y=o),l>u.z&&(u.z=l);}}else {let e,i,n,r,a,o;let l=t.length/3,h=Math.ceil(l/256);s=new Float32Array(4*h),c.x=c.y=c.z=1/0,u.x=u.y=u.z=-1/0;for(let d=0;d<h;++d){e=i=n=1/0,r=a=o=-1/0;let h=256*d,p=Math.min(l,(d+1)*256);for(let s=h;s<p;++s){let l=t[3*s+0],h=t[3*s+1],d=t[3*s+2],p=Number.isFinite(l),f=Number.isFinite(h),m=Number.isFinite(d);p||(t[3*s+0]=0),f||(t[3*s+1]=0),m||(t[3*s+2]=0),p&&f&&m&&(l<e?e=l:l>r&&(r=l),h<i?i=h:h>a&&(a=h),d<n?n=d:d>o&&(o=d),l<c.x?c.x=l:l>u.x&&(u.x=l),h<c.y?c.y=h:h>u.y&&(u.y=h),d<c.z?c.z=d:d>u.z&&(u.z=d));}s[4*d+0]=(e+r)*.5,s[4*d+1]=(i+a)*.5,s[4*d+2]=(n+o)*.5,s[4*d+3]=.5*Math.sqrt((r-e)**2+(a-i)**2+(o-n)**2);}}}a.data.hasOwnProperty("mapping")&&(i=a.data.mapping?new Uint32Array(a.data.mapping):null,l=true),a.data.cameraPosition&&(n=a.data.cameraPosition),a.data.cameraDirection&&(r=a.data.cameraDirection),g();};}class c5 extends Y{destroy(){this.worker.terminate(),this.worker=null;}init(e,t,s){this.orderTexture=e,this.centers=t.slice();let i=this.orderTexture.lock({mode:1}).slice();this.orderTexture.unlock();for(let e=0;e<i.length;++e)i[e]=e;let n={order:i.buffer,centers:t.buffer,chunks:null==s?void 0:s.buffer},r=[i.buffer,t.buffer].concat(s?[s.buffer]:[]);this.worker.postMessage(n,r);}setMapping(e){if(e){let t=new Float32Array(3*e.length);for(let s=0;s<e.length;++s){let i=3*e[s],n=3*s;t[n+0]=this.centers[i+0],t[n+1]=this.centers[i+1],t[n+2]=this.centers[i+2];}this.worker.postMessage({centers:t.buffer,mapping:e.buffer},[t.buffer,e.buffer]);}else {let e=this.centers.slice();this.worker.postMessage({centers:e.buffer,mapping:null},[e.buffer]);}}setCamera(e,t){this.worker.postMessage({cameraPosition:{x:e.x,y:e.y,z:e.z},cameraDirection:{x:t.x,y:t.y,z:t.z}});}constructor(){super(),this.worker=new Worker(URL.createObjectURL(new Blob(["("+c4.toString()+")()"],{type:"application/javascript"}))),this.worker.onmessage=e=>{let t=e.data.order,s=this.orderTexture._levels[0].buffer;this.worker.postMessage({order:s},[s]),this.orderTexture._levels[0]=new Uint32Array(t),this.orderTexture.upload(),this.fire("updated",e.data.count);};}}let c6=new ex,c8=new eu,c9=new eu,c7=[0,0];class ue{destroy(){var e,t,s;null==(e=this.material)||e.destroy(),null==(t=this.meshInstance)||t.destroy(),null==(s=this.sorter)||s.destroy();}clone(){return new ue(this.splat,this.options)}createMaterial(e){this.material=this.splat.createMaterial(e),this.material.setParameter("splatOrder",this.orderTexture),this.material.setParameter("alphaClip",.3),this.meshInstance&&(this.meshInstance.material=this.material);}updateViewport(e){var t;let s=null==e?void 0:e.camera,i=null==s?void 0:s.renderTarget,{width:n,height:r}=null!=i?i:this.splat.device;c7[0]=n,c7[1]=r;let a=null==s?void 0:null==(t=s.camera)?void 0:t.xr;(null==a?void 0:a.active)&&2===a.views.list.length&&(c7[0]*=.5),this.material.setParameter("viewport",c7);}sort(e){if(this.sorter){let t=e.getWorldTransform();t.getTranslation(c8),t.getZ(c9);let s=this.meshInstance.node.getWorldTransform(),i=c6.invert(s);i.transformPoint(c8,c8),i.transformVector(c9,c9),c8.equalsApprox(this.lastCameraPosition)&&c9.equalsApprox(this.lastCameraDirection)||(this.lastCameraPosition.copy(c8),this.lastCameraDirection.copy(c9),this.sorter.setCamera(c8,c9));}this.updateViewport(e);}update(){if(this.cameras.length>0){let e=this.cameras[0];this.sort(e._node),this.cameras.length=0;}}constructor(e,t){var s;this.options={},this.sorter=null,this.lastCameraPosition=new eu,this.lastCameraDirection=new eu,this.cameras=[],this.splat=e,t=Object.assign(this.options,t);let i=e.device;this.orderTexture=this.splat.createTexture("splatOrder",37,this.splat.evalTextureSize(this.splat.numSplats)),this.createMaterial(t);let n=128*Math.ceil(e.numSplats/128)/128,r=new Uint32Array(n);for(let e=0;e<n;++e)r[e]=128*e;let a=new sA(i,[{semantic:tS,components:1,type:5,asInt:true}]),o=new sy(i,a,n,{usage:0,data:r.buffer}),l=new Float32Array(1536),h=new Uint32Array(768);for(let e=0;e<128;++e){l.set([-1,-1,e,1,-1,e,1,1,e,-1,1,e],12*e);let t=4*e;h.set([0+t,1+t,2+t,0+t,2+t,3+t],6*e);}let d=new aG(i);d.setPositions(l,3),d.setIndices(h),d.update(),this.mesh=d,this.mesh.aabb.copy(e.aabb),this.meshInstance=new a0(this.mesh,this.material),this.meshInstance.setInstancing(o,true),this.meshInstance.gsplatInstance=this,this.meshInstance.instancingCount=0;let c=e.centers.slice(),u=null==(s=e.chunks)?void 0:s.slice();t.dither&&t.dither!==ai||(this.sorter=new c5,this.sorter.init(this.orderTexture,c,u),this.sorter.on("updated",e=>{this.meshInstance.instancingCount=Math.ceil(e/128),this.material.setParameter("numSplats",e);}));}}let ut="FILL_WINDOW",us="KEEP_ASPECT",ui="AUTO",un="FIXED",ur=false,ua={app:null,createLoadingScreen(e){!ur&&(ur=true,e(n));}};class uo{addRenderPass(e){e.frameUpdate();let t=e.beforePasses;for(let e=0;e<t.length;e++){let s=t[e];s.enabled&&this.addRenderPass(s);}e.enabled&&this.renderPasses.push(e);let s=e.afterPasses;for(let e=0;e<s.length;e++){let t=s[e];t.enabled&&this.addRenderPass(t);}}reset(){this.renderPasses.length=0;}compile(){let e=this.renderTargetMap,t=this.renderPasses;for(let s=0;s<t.length;s++){let i=t[s],n=i.renderTarget;if(void 0!==n){let t=e.get(n);if(t){let e=i.colorArrayOps.length;for(let s=0;s<e;s++)i.colorArrayOps[s].clear||(t.colorArrayOps[s].store=true);i.depthStencilOps.clearDepth||(t.depthStencilOps.storeDepth=true),i.depthStencilOps.clearStencil||(t.depthStencilOps.storeStencil=true);}e.set(n,i);}}for(let e=0;e<t.length-1;e++){let s=t[e],i=s.renderTarget,n=t[e+1];!(i!==n.renderTarget||void 0===i||n.depthStencilOps.clearDepth||n.depthStencilOps.clearStencil||n.colorArrayOps.some(e=>e.clear))&&!(s.afterPasses.length>0)&&!(n.beforePasses.length>0)&&(s._skipEnd=true,n._skipStart=true);}let s=null,i=null;for(let e=0;e<t.length;e++){let n=t[e],r=n.renderTarget,a=null==r?void 0:r.colorBuffer;if(null==a?void 0:a.cubemap){if(s===a){let e=i.colorArrayOps.length;for(let t=0;t<e;t++)i.colorArrayOps[t].mipmaps=false;}s=r.colorBuffer,i=n;}else n.requiresCubemaps&&(s=null,i=null);}e.clear();}render(e){this.compile();let t=this.renderPasses;for(let e=0;e<t.length;e++)t[e].render();}constructor(){this.renderPasses=[],this.renderTargetMap=new Map;}}class ul{destroy(){var e,t;null==(e=this.texture0)||e.destroy(),null==(t=this.texture1)||t.destroy();}constructor(e,t){this.texture0=e,this.texture1=t;}}let uh=new t8;class ud{static createTexture(e,t,s,i){return void 0===i&&(i=""),new se(e,{name:"AreaLightLUT"+i,width:s,height:s,format:t,addressU:1,addressV:1,type:tb,magFilter:1,minFilter:0,anisotropy:1,mipmaps:false})}static applyTextures(e,t,s){uh.remove(e),uh.get(e,()=>new ul(t,t===s?null:s)),e.scope.resolve("areaLightsLutTex1").setValue(t),e.scope.resolve("areaLightsLutTex2").setValue(s);}static createPlaceholder(e){let t=ud.createTexture(e,12,2,"placeholder");t.lock().fill(0),t.unlock(),ud.applyTextures(e,t,t);}static set(e,t,s){function i(e,t,s){let i=ud.createTexture(e,s,64);return i.lock().set(t),i.unlock(),i}function n(e){let t=e.length,s=new Uint16Array(t),i=ed.float2Half;for(let n=0;n<t;n++)s[n]=i(e[n]);return s}let r=n(t),a=n(s),o=i(e,r,12),l=i(e,a,12);ud.applyTextures(e,o,l);}}let uc="en-US",uu={en:"en-US",es:"en-ES",zh:"zh-CN","zh-HK":"zh-TW","zh-TW":"zh-HK","zh-MO":"zh-HK",fr:"fr-FR",de:"de-DE",it:"it-IT",ru:"ru-RU",ja:"ja-JP"},up={};function uf(e,t){for(let s=0,i=e.length;s<i;s++)up[e[s]]=t;}function um(e){let t=e.indexOf("-");return -1!==t?e.substring(0,t):e}function u_(e,t){if(t[e])return e;let s=uu[e];if(s&&t[s])return s;let i=um(e);return t[s=uu[i]]?s:t[i]?i:uc}uf(["ja","ko","th","vi","zh","id"],e=>0),uf(["fa","hi"],e=>e>=0&&e<=1?0:1),uf(["fr","pt"],e=>e>=0&&e<2?0:1),uf(["da"],e=>1===e||!Number.isInteger(e)&&e>=0&&e<=1?0:1),uf(["de","en","it","el","es","tr","fi","sv","nb","no","ur"],e=>+(1!==e)),uf(["ru","uk"],e=>{if(Number.isInteger(e)){let t=e%10,s=e%100;if(1===t&&11!==s)return 0;if(t>=2&&t<=4&&(s<12||s>14))return 1;if(0===t||t>=5&&t<=9||s>=11&&s<=14)return 2}return 3}),uf(["pl"],e=>{if(Number.isInteger(e)){if(1===e)return 0;let t=e%10,s=e%100;if(t>=2&&t<=4&&(s<12||s>14))return 1;if(t>=0&&t<=1||t>=5&&t<=9||s>=12&&s<=14)return 2}return 3}),uf(["ar"],e=>{if(0===e)return 0;if(1===e)return 1;if(2===e)return 2;if(Number.isInteger(e)){let t=e%100;if(t>=3&&t<=10)return 3;if(t>=11&&t<=99)return 4}return 5});let ug=up[um(uc)],uv=RegExp("^\\s*(?:(?:[a-z]+[a-z0-9\\-+.]*:)?//|data:|blob:)","i");class uy{equals(e){return this.url===e.url&&this.filename===e.filename&&this.hash===e.hash&&this.size===e.size&&this.opt===e.opt&&this.contents===e.contents}constructor(e="",t="",s=null,i=null,n=null,r=null){this.url=e,this.filename=t,this.hash=s,this.size=i,this.opt=n,this.contents=r;}}let uS=-1,ux={pvr:"extCompressedTexturePVRTC",dxt:"extCompressedTextureS3TC",etc2:"extCompressedTextureETC",etc1:"extCompressedTextureETC1",basis:"canvas"},uT=["pvr","dxt","etc2","etc1","basis"];class ub extends Y{set name(e){if(this._name===e)return;let t=this._name;this._name=e,this.fire("name",this,this._name,t);}get name(){return this._name}set file(e){if(e&&e.variants&&-1!==["texture","textureatlas","bundle"].indexOf(this.type)){var t,s;let i=(null==(s=this.registry)?void 0:null==(t=s._loader)?void 0:t._app)||n,r=null==i?void 0:i.graphicsDevice;if(r)for(let t=0,s=uT.length;t<s;t++){let s=uT[t];if(e.variants[s]&&r[ux[s]]){e=e.variants[s];break}if(i.enableBundles){let e=i.bundles.listBundlesForAsset(this);if(e&&e.find(e=>{var t;return null==e?void 0:null==(t=e.file)?void 0:t.variants[s]}))break}}}let i=this._file,r=e?new uy(e.url,e.filename,e.hash,e.size,e.opt,e.contents):null;(!!r!=!!i||r&&!r.equals(i))&&(this._file=r,this.fire("change",this,"file",r,i),this.reload());}get file(){return this._file}set data(e){let t=this._data;this._data=e,e!==t&&(this.fire("change",this,"data",e,t),this.loaded&&this.registry._loader.patch(this,this.registry));}get data(){return this._data}set resource(e){let t=this._resources[0];this._resources[0]=e,this.fire("change",this,"resource",e,t);}get resource(){return this._resources[0]}set resources(e){let t=this._resources;this._resources=e,this.fire("change",this,"resources",e,t);}get resources(){return this._resources}set preload(e){e=!!e,this._preload!==e&&(this._preload=e,this._preload&&!this.loaded&&!this.loading&&this.registry&&this.registry.load(this));}get preload(){return this._preload}set loadFaces(e){e=!!e,(!this.hasOwnProperty("_loadFaces")||e!==this._loadFaces)&&(this._loadFaces=e,this.loaded&&this.registry._loader.patch(this,this.registry));}get loadFaces(){return this._loadFaces}getFileUrl(){let e=this.file;if(!e||!e.url)return null;let t=e.url;if(this.registry&&this.registry.prefix&&!uv.test(t)&&(t=this.registry.prefix+t),"script"!==this.type&&e.hash){let s=-1!==t.indexOf("?")?"&":"?";t+=s+"t="+e.hash;}return t}getAbsoluteUrl(e){if(e.startsWith("blob:")||e.startsWith("data:"))return e;let t=M.getDirectory(this.file.url);return M.join(t,e)}getLocalizedAssetId(e){return e=u_(e,this._i18n),this._i18n[e]||null}addLocalizedAssetId(e,t){this._i18n[e]=t,this.fire("add:localized",e,t);}removeLocalizedAssetId(e){let t=this._i18n[e];t&&(delete this._i18n[e],this.fire("remove:localized",e,t));}ready(e,t){t=t||this,this.loaded?e.call(t,this):this.once("load",s=>{e.call(t,s);});}reload(){this.loaded&&(this.loaded=false,this.registry.load(this));}unload(){if(!this.loaded&&0===this._resources.length)return;this.fire("unload",this),this.registry.fire("unload:"+this.id,this);let e=this._resources;this.urlObject&&(URL.revokeObjectURL(this.urlObject),this.urlObject=null),this.resources=[],this.loaded=false,this.file&&this.registry._loader.clearCache(this.getFileUrl(),this.type);for(let t=0;t<e.length;++t){let s=e[t];s&&s.destroy&&s.destroy();}}static fetchArrayBuffer(e,t,s,i){var n;void 0===i&&(i=0),(null==s?void 0:null==(n=s.file)?void 0:n.contents)?setTimeout(()=>{t(null,s.file.contents);}):rR.get(e,{cache:true,responseType:"arraybuffer",retry:i>0,maxRetries:i},t);}constructor(e,t,s,i={},n={}){super(),this._file=null,this._i18n={},this._preload=false,this._resources=[],this.id=uS--,this.loaded=false,this.loading=false,this.options={},this.registry=null,this.tags=new J(this),this.urlObject=null,this._name=e||"",this.type=t,this._data=i||{},this.options=n||{},s&&(this.file=s);}}ub.EVENT_LOAD="load",ub.EVENT_UNLOAD="unload",ub.EVENT_REMOVE="remove",ub.EVENT_ERROR="error",ub.EVENT_CHANGE="change",ub.EVENT_PROGRESS="progress",ub.EVENT_ADDLOCALIZED="add:localized",ub.EVENT_REMOVELOCALIZED="remove:localized";class uE{addItem(e){for(let t of e.tags._list)this.add(t,e);}removeItem(e){for(let t of e.tags._list)this.remove(t,e);}add(e,t){(!this._index[e]||-1===this._index[e].list.indexOf(t))&&(!this._index[e]&&(this._index[e]={list:[]},this._key&&(this._index[e].keys={})),this._index[e].list.push(t),this._key&&(this._index[e].keys[t[this._key]]=t));}remove(e,t){if(!this._index[e]||this._key&&!this._index[e].keys[t[this._key]])return;let s=this._index[e].list.indexOf(t);-1!==s&&(this._index[e].list.splice(s,1),this._key&&delete this._index[e].keys[t[this._key]],0===this._index[e].list.length&&delete this._index[e]);}find(e){let t,s,i,n,r;let a={},o=[],l=(e,t)=>this._index[e].list.length-this._index[t].list.length;for(let h=0;h<e.length;h++){if((s=e[h])instanceof Array){if(0===s.length)continue;if(1===s.length)s=s[0];else {r=false;for(let e=0;e<s.length;e++)if(!this._index[s[e]]){r=true;break}if(r)continue;1===(n=(i=s.slice(0).sort(l)).slice(1)).length&&(n=n[0]);for(let e=0;e<this._index[i[0]].list.length;e++)t=this._index[i[0]].list[e],(this._key?!a[t[this._key]]:-1===o.indexOf(t))&&t.tags.has(n)&&(this._key&&(a[t[this._key]]=true),o.push(t));continue}}if(s&&"string"==typeof s&&this._index[s])for(let e=0;e<this._index[s].list.length;e++)t=this._index[s].list[e],this._key?a[t[this._key]]||(a[t[this._key]]=true,o.push(t)):-1===o.indexOf(t)&&o.push(t);}return o}constructor(e=null){this._index={},this._key=e;}}class uA extends Y{list(e){ void 0===e&&(e={});let t=Array.from(this._assets);return void 0!==e.preload?t.filter(t=>t.preload===e.preload):t}add(e){var t,s;!this._assets.has(e)&&(this._assets.add(e),this._idToAsset.set(e.id,e),(null==(t=e.file)?void 0:t.url)&&this._urlToAsset.set(e.file.url,e),this._nameToAsset.has(e.name)||this._nameToAsset.set(e.name,new Set),this._nameToAsset.get(e.name).add(e),e.on("name",this._onNameChange,this),e.registry=this,this._tags.addItem(e),e.tags.on("add",this._onTagAdd,this),e.tags.on("remove",this._onTagRemove,this),this.fire("add",e),this.fire("add:"+e.id,e),(null==(s=e.file)?void 0:s.url)&&this.fire("add:url:"+e.file.url,e),e.preload&&this.load(e));}remove(e){var t,s;if(!this._assets.has(e))return  false;if(this._assets.delete(e),this._idToAsset.delete(e.id),(null==(t=e.file)?void 0:t.url)&&this._urlToAsset.delete(e.file.url),e.off("name",this._onNameChange,this),this._nameToAsset.has(e.name)){let t=this._nameToAsset.get(e.name);t.delete(e),0===t.size&&this._nameToAsset.delete(e.name);}return this._tags.removeItem(e),e.tags.off("add",this._onTagAdd,this),e.tags.off("remove",this._onTagRemove,this),e.fire("remove",e),this.fire("remove",e),this.fire("remove:"+e.id,e),(null==(s=e.file)?void 0:s.url)&&this.fire("remove:url:"+e.file.url,e),true}get(e){return this._idToAsset.get(Number(e))}getByUrl(e){return this._urlToAsset.get(e)}load(e,t){if((e.loading||e.loaded)&&!(null==t?void 0:t.force))return;let s=e.file,i=()=>{this.fire("load",e),this.fire("load:"+e.id,e),s&&s.url&&this.fire("load:url:"+s.url,e),e.fire("load",e);},n=t=>{if(t instanceof Array?e.resources=t:e.resource=t,this._loader.patch(e,this),"bundle"===e.type){let t=e.data.assets;for(let e=0;e<t.length;e++){let s=this._idToAsset.get(t[e]);s&&!s.loaded&&this.load(s,{force:true});}e.resource.loaded?i():(this.fire("load:start",e),this.fire("load:start:"+e.id,e),s&&s.url&&this.fire("load:start:url:"+s.url,e),e.fire("load:start",e),e.resource.on("load",i));}else i();};if(s||"cubemap"===e.type){this.fire("load:start",e),this.fire("load:"+e.id+":start",e),e.loading=true;let s=e.getFileUrl();if("bundle"===e.type){let t=e.data.assets;for(let e=0;e<t.length;e++){let s=this._idToAsset.get(t[e]);s&&!s.loaded&&!s.resource&&!s.loading&&(s.loading=true);}}this._loader.load(s,e.type,(t,s,i)=>{if(e.loaded=true,e.loading=false,t)this.fire("error",t,e),this.fire("error:"+e.id,t,e),e.fire("error",t,e);else {if("script"===e.type){let t=this._loader.getHandler("script");t._cache[e.id]&&t._cache[e.id].parentNode===document.head&&document.head.removeChild(t._cache[e.id]),t._cache[e.id]=i;}n(s);}},e,t);}else {let t=this._loader.open(e.type,e.data);e.loaded=true,n(t);}}loadFromUrl(e,t,s){this.loadFromUrlAndFilename(e,null,t,s);}loadFromUrlAndFilename(e,t,s,i){let n=M.getBasename(t||e),r=this.getByUrl(e);if(r){if(r.loaded){i(r.loadFromUrlError||null,r);return}}else r=new ub(n,s,{filename:t||n,url:e}),this.add(r);let a=e=>{e.once("load",e=>{"material"===s?this._loadTextures(e,(t,s)=>{i(t,e);}):i(null,e);}),e.once("error",t=>{t&&(this.loadFromUrlError=t),i(t,e);}),this.load(e);};r.resource?i(null,r):"model"===s?this._loadModel(r,a):a(r);}_loadModel(e,t){let s=e.getFileUrl(),i=M.getExtension(s);if(".json"===i||".glb"===i){let n=M.getDirectory(s),r=M.getBasename(s),a=M.join(n,r.replace(i,".mapping.json"));this._loader.load(a,"json",(s,i)=>{s?(e.data={mapping:[]},t(e)):this._loadMaterials(e,i,(s,n)=>{e.data=i,t(e);});});}else t(e);}_loadMaterials(e,t,s){let i=[],n=0,r=(e,t)=>{this._loadTextures(t,(e,r)=>{i.push(t),i.length===n&&s(null,i);});};for(let s=0;s<t.mapping.length;s++){let i=t.mapping[s].path;if(i){n++;let t=e.getAbsoluteUrl(i);this.loadFromUrl(t,"material",r);}}0===n&&s(null,i);}_loadTextures(e,t){let s=[],i=0,n=e.data;if("path"!==n.mappingFormat){t(null,s);return}let r=(e,n)=>{s.push(n),s.length===i&&t(null,s);};for(let t=0;t<cx.length;t++){let s=n[cx[t]];if(s&&"string"==typeof s){i++;let t=e.getAbsoluteUrl(s);this.loadFromUrl(t,"texture",r);}}0===i&&t(null,s);}_onTagAdd(e,t){this._tags.add(e,t);}_onTagRemove(e,t){this._tags.remove(e,t);}_onNameChange(e,t,s){if(this._nameToAsset.has(s)){let t=this._nameToAsset.get(s);t.delete(e),0===t.size&&this._nameToAsset.delete(s);}this._nameToAsset.has(e.name)||this._nameToAsset.set(e.name,new Set),this._nameToAsset.get(e.name).add(e);}findByTag(){for(var e=arguments.length,t=Array(e),s=0;s<e;s++)t[s]=arguments[s];return this._tags.find(t)}filter(e){return Array.from(this._assets).filter(t=>e(t))}find(e,t){let s=this._nameToAsset.get(e);if(!s)return null;for(let e of s)if(!t||e.type===t)return e;return null}findAll(e,t){let s=this._nameToAsset.get(e);if(!s)return [];let i=Array.from(s);return t?i.filter(e=>e.type===t):i}constructor(e){super(),this._assets=new Set,this._idToAsset=new Map,this._urlToAsset=new Map,this._nameToAsset=new Map,this._tags=new uE("_id"),this.prefix=null,this.bundles=null,this._loader=e;}}uA.EVENT_LOAD="load",uA.EVENT_ADD="add",uA.EVENT_REMOVE="remove",uA.EVENT_ERROR="error";class uw{_onAssetAdd(e){if("bundle"===e.type){this._idToBundle.set(e.id,e),this._assets.on("load:start:"+e.id,this._onBundleLoadStart,this),this._assets.on("load:"+e.id,this._onBundleLoad,this),this._assets.on("error:"+e.id,this._onBundleError,this);let t=e.data.assets;for(let s=0;s<t.length;s++)this._indexAssetInBundle(t[s],e);}else this._assetToBundles.has(e.id)&&this._indexAssetFileUrls(e);}_unbindAssetEvents(e){this._assets.off("load:start:"+e,this._onBundleLoadStart,this),this._assets.off("load:"+e,this._onBundleLoad,this),this._assets.off("error:"+e,this._onBundleError,this);}_indexAssetInBundle(e,t){let s=this._assetToBundles.get(e);s||(s=new Set,this._assetToBundles.set(e,s)),s.add(t);let i=this._assets.get(e);i&&this._indexAssetFileUrls(i);}_indexAssetFileUrls(e){let t=this._getAssetFileUrls(e);if(t)for(let s=0;s<t.length;s++){let i=this._assetToBundles.get(e.id);i&&this._urlsToBundles.set(t[s],i);}}_getAssetFileUrls(e){let t=e.getFileUrl();if(!t)return null;let s=[t=t.split("?")[0]];if("font"===e.type){let i=e.data.info.maps.length;for(let e=1;e<i;e++)s.push(t.replace(".png",""+e+".png"));}return s}_onAssetRemove(e){if("bundle"===e.type){this._idToBundle.delete(e.id),this._unbindAssetEvents(e.id);let t=e.data.assets;for(let s=0;s<t.length;s++){let i=this._assetToBundles.get(t[s]);if(i&&(i.delete(e),0===i.size))for(let[e,n]of(this._assetToBundles.delete(t[s]),this._urlsToBundles))n===i&&this._urlsToBundles.delete(e);}this._onBundleError("Bundle "+e.id+" was removed");}else {if(!this._assetToBundles.get(e.id))return;this._assetToBundles.delete(e.id);let t=this._getAssetFileUrls(e);if(!t)return;for(let e=0;e<t.length;e++)this._urlsToBundles.delete(t[e]);}}_onBundleLoadStart(e){e.resource.on("add",(e,t)=>{let s=this._fileRequests.get(e);if(s){for(let e=0;e<s.length;e++)s[e](null,t);this._fileRequests.delete(e);}});}_onBundleLoad(e){if(!e.resource){this._onBundleError("Bundle "+e.id+" failed to load");return}if(this._fileRequests)for(let[t,s]of this._fileRequests){let i,n;let r=this._urlsToBundles.get(t);if(!r||!r.has(e))continue;let a=decodeURIComponent(t);if(e.resource.has(a))n=e.resource.get(a);else {if(!e.resource.loaded)continue;i="Bundle "+e.id+" does not contain URL "+t;}for(let e=0;e<s.length;e++)s[e](i,i||n);this._fileRequests.delete(t);}}_onBundleError(e){for(let[t,s]of this._fileRequests)if(!this._findLoadedOrLoadingBundleForUrl(t)){for(let t=0;t<s.length;t++)s[t](e);this._fileRequests.delete(t);}}_findLoadedOrLoadingBundleForUrl(e){let t=this._urlsToBundles.get(e);if(!t)return null;let s=null;for(let e of t){if(e.loaded&&e.resource)return e;e.loading&&(s=e);}return s}listBundlesForAsset(e){let t=this._assetToBundles.get(e.id);return t?Array.from(t):null}list(){return Array.from(this._idToBundle.values())}hasUrl(e){return this._urlsToBundles.has(e)}urlIsLoadedOrLoading(e){return !!this._findLoadedOrLoadingBundleForUrl(e)}loadUrl(e,t){let s=this._findLoadedOrLoadingBundleForUrl(e);if(!s){t("URL "+e+" not found in any bundles");return}if(s.loaded){let i=decodeURIComponent(e);if(s.resource.has(i)){t(null,s.resource.get(i));return}if(s.resource.loaded){t("Bundle "+s.id+" does not contain URL "+e);return}}let i=this._fileRequests.get(e);i||(i=[],this._fileRequests.set(e,i)),i.push(t);}destroy(){for(let e of(this._assets.off("add",this._onAssetAdd,this),this._assets.off("remove",this._onAssetRemove,this),this._idToBundle.keys()))this._unbindAssetEvents(e);this._assets=null,this._idToBundle.clear(),this._idToBundle=null,this._assetToBundles.clear(),this._assetToBundles=null,this._urlsToBundles.clear(),this._urlsToBundles=null,this._fileRequests.clear(),this._fileRequests=null;}constructor(e){this._idToBundle=new Map,this._assetToBundles=new Map,this._urlsToBundles=new Map,this._fileRequests=new Map,this._assets=e,this._assets.bundles=this,this._assets.on("add",this._onAssetAdd,this),this._assets.on("remove",this._onAssetRemove,this);}}class uC extends Y{add(e){let t=e.id;if(this[t])throw Error("ComponentSystem name '"+t+"' already registered or not allowed");this[t]=e,this.list.push(e);}remove(e){let t=e.id;if(!this[t])throw Error("No ComponentSystem named '"+t+"' registered");delete this[t];let s=this.list.indexOf(this[t]);-1!==s&&this.list.splice(s,1);}destroy(){this.off();for(let e=0;e<this.list.length;e++)this.list[e].destroy();}constructor(){super(),this.list=[];}}class uP extends Y{addFile(e,t){!this._index.has(e)&&(this._index.set(e,t),this.fire("add",e,t));}has(e){return this._index.has(e)}get(e){return this._index.get(e)||null}destroy(){this._index.clear();}set loaded(e){e&&!this._loaded&&(this._loaded=true,this.fire("load"));}get loaded(){return this._loaded}constructor(...e){super(...e),this._index=new Map,this._loaded=false;}}uP.EVENT_ADD="add",uP.EVENT_LOAD="load";class uM extends Y{pump(e,t){if(e)return this.fire("done"),null;this.bytesReceived+=t.byteLength;let s=new Uint8Array(this.data.length+t.length);for(s.set(this.data),s.set(t,this.data.length),this.data=s;this.readFile(););return this.reader.read().then(e=>{this.pump(e.done,e.value);}).catch(e=>{this.fire("error",e);})}readFile(){if(!this.headerRead&&this.bytesReceived>this.bytesRead+this.headerSize){this.headerRead=true;let t=new DataView(this.data.buffer,this.bytesRead,this.headerSize);null!=this.decoder||(this.decoder=new TextDecoder("windows-1252"));let s=this.decoder.decode(t);if(this.fileName=s.substring(0,100).replace(/\0/g,""),this.fileSize=parseInt(s.substring(124,136),8),this.fileType=s.substring(156,157),this.ustarFormat=s.substring(257,263),-1!==this.ustarFormat.indexOf("ustar")){let e=s.substring(345,500).replace(/\0/g,"");e.length>0&&(this.fileName=e.trim()+this.fileName.trim());}this.bytesRead+=512;}if(this.headerRead){if(this.bytesReceived<this.bytesRead+this.fileSize)return  false;if(""===this.fileType||"0"===this.fileType){let e=new DataView(this.data.buffer,this.bytesRead,this.fileSize),t={name:this.prefix+this.fileName,size:this.fileSize,data:e};this.fire("file",t);}this.bytesRead+=this.fileSize,this.headerRead=false;let e=this.bytesRead%this.paddingSize;return 0!==e&&(this.bytesRead+=this.paddingSize-e),true}return  false}constructor(e,t=""){super(),this.headerSize=512,this.paddingSize=512,this.bytesRead=0,this.bytesReceived=0,this.headerRead=false,this.reader=null,this.data=new Uint8Array(0),this.decoder=null,this.prefix="",this.fileName="",this.fileSize=0,this.fileType="",this.ustarFormat="",this.prefix=t||"",this.reader=e.body.getReader(),this.reader.read().then(e=>{this.pump(e.done,e.value);}).catch(e=>{this.fire("error",e);});}}class uI{set maxRetries(e){this._maxRetries=e;}get maxRetries(){return this._maxRetries}load(e,t,s){}open(e,t,s){return t}patch(e,t){}constructor(e,t){this.handlerType="",this._maxRetries=0,this._app=e,this.handlerType=t;}}class uR extends uI{_fetchRetries(e,t,s){return void 0===s&&(s=0),new Promise((i,n)=>{let r=()=>{fetch(e,t).then(i).catch(e=>{++s<this.maxRetries?r():n(e);});};r();})}load(e,t){"string"==typeof e&&(e={load:e,original:e}),this._fetchRetries(e.load,{mode:"cors",credentials:"include"},this.maxRetries).then(e=>{let s=new uP;t(null,s);let i=new uM(e,this._assets.prefix);i.on("file",e=>{s.addFile(e.name,e.data);}),i.on("done",()=>{s.loaded=true;}),i.on("error",e=>{t(e);});}).catch(e=>{t(e);});}open(e,t){return t}constructor(e){super(e,"bundle"),this._assets=e.assets;}}class uL{addHandler(e,t){this._handlers[e]=t,t._loader=this;}removeHandler(e){delete this._handlers[e];}getHandler(e){return this._handlers[e]}static makeKey(e,t){return e+"-"+t}load(e,t,s,i,n){let r=this._handlers[t];if(!r){s("No resource handler for asset type: '"+t+"' when loading ["+e+"]");return}if(!e){this._loadNull(r,s,i);return}let a=uL.makeKey(e,t);if(void 0!==this._cache[a])s(null,this._cache[a]);else if(this._requests[a])this._requests[a].push(s);else {this._requests[a]=[s];let t=this,l=function(e,s){if(e){t._onFailure(a,e);return}if(s.load instanceof DataView){if(r.openBinary){if(!t._requests[a])return;try{let e=r.openBinary(s.load);t._onSuccess(a,e);}catch(e){t._onFailure(a,e);}return}s.load=URL.createObjectURL(new Blob([s.load])),i&&(i.urlObject&&URL.revokeObjectURL(i.urlObject),i.urlObject=s.load);}r.load(s,(e,n,o)=>{if(t._requests[a]){if(e){t._onFailure(a,e);return}try{t._onSuccess(a,r.open(s.original,n,i),o);}catch(e){t._onFailure(a,e);}}},i);},h=e.split("?")[0];if(this._app.enableBundles&&this._app.bundles.hasUrl(h)&&!(n&&n.bundlesIgnore)){if(!this._app.bundles.urlIsLoadedOrLoading(h)){var o;let e;let t=this._app.bundles.listBundlesForAsset(i);n&&n.bundlesFilter&&(e=n.bundlesFilter(t)),e||(null==t||t.sort((e,t)=>e.file.size-t.file.size),e=null==t?void 0:t[0]),e&&(null==(o=this._app.assets)||o.load(e));}this._app.bundles.loadUrl(h,(e,t)=>{l(e,{load:t,original:h});});}else l(null,{load:e,original:i&&i.file.filename||e});}}_loadNull(e,t,s){e.load(null,function(i,n,r){if(i)t(i);else try{t(null,e.open(null,n,s),r);}catch(e){t(e);}},s);}_onSuccess(e,t,s){null!==t?this._cache[e]=t:delete this._cache[e];for(let i=0;i<this._requests[e].length;i++)this._requests[e][i](null,t,s);delete this._requests[e];}_onFailure(e,t){if(this._requests[e]){for(let s=0;s<this._requests[e].length;s++)this._requests[e][s](t);delete this._requests[e];}}open(e,t){let s=this._handlers[e];return s?s.open(null,t):t}patch(e,t){let s=this._handlers[e.type];s&&s.patch&&s.patch(e,t);}clearCache(e,t){let s=uL.makeKey(e,t);delete this._cache[s];}getFromCache(e,t){let s=uL.makeKey(e,t);if(this._cache[s])return this._cache[s]}enableRetry(e){for(let t in void 0===e&&(e=5),e=Math.max(0,e)||0,this._handlers)this._handlers[t].maxRetries=e;}disableRetry(){for(let e in this._handlers)this._handlers[e].maxRetries=0;}destroy(){this._handlers={},this._requests={},this._cache={};}constructor(e){this._handlers={},this._requests={},this._cache={},this._app=e;}}class uD{_validate(e){if(!e.header)throw Error('pc.I18n#addData: Missing "header" field');if(!e.header.version)throw Error('pc.I18n#addData: Missing "header.version" field');if(1!==e.header.version)throw Error('pc.I18n#addData: Invalid "header.version" field');if(e.data){if(!Array.isArray(e.data))throw Error('pc.I18n#addData: "data" field must be an array')}else throw Error('pc.I18n#addData: Missing "data" field');for(let t=0,s=e.data.length;t<s;t++){let s=e.data[t];if(!s.info)throw Error('pc.I18n#addData: missing "data['+t+'].info" field');if(!s.info.locale)throw Error('pc.I18n#addData: missing "data['+t+'].info.locale" field');if("string"!=typeof s.info.locale)throw Error('pc.I18n#addData: "data['+t+'].info.locale" must be a string');if(!s.messages)throw Error('pc.I18n#addData: missing "data['+t+'].messages" field')}}parse(e){return e.data}}class uO extends Y{set assets(e){let t={};for(let s=0,i=e.length;s<i;s++)t[e[s]instanceof ub?e[s].id:e[s]]=true;let s=this._assets.length;for(;s--;){let e=this._assets[s];if(!t[e]){this._app.assets.off("add:"+e,this._onAssetAdd,this);let t=this._app.assets.get(e);t&&this._onAssetRemove(t),this._assets.splice(s,1);}}for(let e in t){let t=parseInt(e,10);if(-1!==this._assets.indexOf(t))continue;this._assets.push(t);let s=this._app.assets.get(t);s?this._onAssetAdd(s):this._app.assets.once("add:"+t,this._onAssetAdd,this);}}get assets(){return this._assets}set locale(e){if(this._locale===e)return;let t=um(e);if("in"===t&&(e=function(e,t){let s=e.indexOf("-");return -1!==s?t+e.substring(s):t}(e,t="id"),this._locale===e))return;let s=this._locale;this._locale=e,this._lang=t,this._pluralFn=up[this._lang]||ug,this.fire("set:locale",e,s);}get locale(){return this._locale}static findAvailableLocale(e,t){return u_(e,t)}findAvailableLocale(e){if(this._translations[e])return e;let t=um(e);return this._findFallbackLocale(e,t)}getText(e,t){let s,i=e;t||(t=this._locale,s=this._lang);let n=this._translations[t];return n||(s||(s=um(t)),t=this._findFallbackLocale(t,s),n=this._translations[t]),n&&n.hasOwnProperty(e)&&(Array.isArray(i=n[e])&&(i=i[0]),null==i&&(i=e)),i}getPluralText(e,t,s){let i,n,r=e;s?n=up[i=um(s)]||ug:(s=this._locale,i=this._lang,n=this._pluralFn);let a=this._translations[s];if(!a&&(n=up[i=um(s=this._findFallbackLocale(s,i))]||ug,a=this._translations[s]),a&&a[e]&&n){let s=n(t);null==(r=a[e][s])&&(r=e);}return r}addData(e){let t;try{t=this._parser.parse(e);}catch(e){return}for(let e=0,s=t.length;e<s;e++){let s=t[e],i=s.info.locale,n=s.messages;if(!this._translations[i]){this._translations[i]={};let e=um(i);this._availableLangs[e]||(this._availableLangs[e]=i);}Object.assign(this._translations[i],n),this.fire("data:add",i,n);}}removeData(e){let t;try{t=this._parser.parse(e);}catch(e){return}for(let e=0,s=t.length;e<s;e++){let s=t[e],i=s.info.locale,n=this._translations[i];if(!n)continue;let r=s.messages;for(let e in r)delete n[e];0===Object.keys(n).length&&(delete this._translations[i],delete this._availableLangs[um(i)]),this.fire("data:remove",i,r);}}destroy(){this._translations=null,this._availableLangs=null,this._assets=null,this._parser=null,this.off();}_findFallbackLocale(e,t){let s=uu[e];return s&&this._translations[s]||(s=uu[t])&&this._translations[s]||(s=this._availableLangs[t])&&this._translations[s]?s:uc}_onAssetAdd(e){e.on("load",this._onAssetLoad,this),e.on("change",this._onAssetChange,this),e.on("remove",this._onAssetRemove,this),e.on("unload",this._onAssetUnload,this),e.resource&&this._onAssetLoad(e);}_onAssetLoad(e){this.addData(e.resource);}_onAssetChange(e){e.resource&&this.addData(e.resource);}_onAssetRemove(e){e.off("load",this._onAssetLoad,this),e.off("change",this._onAssetChange,this),e.off("remove",this._onAssetRemove,this),e.off("unload",this._onAssetUnload,this),e.resource&&this.removeData(e.resource),this._app.assets.once("add:"+e.id,this._onAssetAdd,this);}_onAssetUnload(e){e.resource&&this.removeData(e.resource);}constructor(e){super(),this.locale=uc,this._translations={},this._availableLangs={},this._app=e,this._assets=[],this._parser=new uD;}}class uF extends Y{destroy(){this.app=null,this.off();}addSchema(e,t){t&&this._scriptSchemas.set(e,t);}getSchema(e){return this._scriptSchemas.get(e)}add(e){let t=e.__name;return this._scripts.hasOwnProperty(t)?(setTimeout(()=>{if(e.prototype.swap){let s=this._scripts[t],i=this._list.indexOf(s);this._list[i]=e,this._scripts[t]=e,this.fire("swap",t,e),this.fire("swap:"+t,e);}}),false):(this._scripts[t]=e,this._list.push(e),this.fire("add",t,e),this.fire("add:"+t,e),setTimeout(()=>{let e;if(!this._scripts.hasOwnProperty(t)||!this.app||!this.app.systems||!this.app.systems.script)return;let s=this.app.systems.script._components,i=[],n=[];for(s.loopIndex=0;s.loopIndex<s.length;s.loopIndex++){let n=s.items[s.loopIndex];if(n._scriptsIndex[t]&&n._scriptsIndex[t].awaiting){n._scriptsData&&n._scriptsData[t]&&(e=n._scriptsData[t].attributes);let s=n.create(t,{preloading:true,ind:n._scriptsIndex[t].ind,attributes:e});for(let e of(s&&i.push(s),n.scripts))n.initializeAttributes(e);}}for(let e=0;e<i.length;e++)i[e].enabled&&(i[e]._initialized=true,n.push(i[e]),i[e].initialize&&i[e].initialize());for(let e=0;e<n.length;e++)n[e].enabled&&!n[e]._postInitialized&&(n[e]._postInitialized=true,n[e].postInitialize&&n[e].postInitialize());}),true)}remove(e){let t=e,s=e;if("string"!=typeof s?s=t.__name:t=this.get(s),this.get(s)!==t)return  false;delete this._scripts[s];let i=this._list.indexOf(t);return this._list.splice(i,1),this.fire("remove",s,t),this.fire("remove:"+s,t),true}get(e){return this._scripts[e]||null}has(e){if("string"==typeof e)return this._scripts.hasOwnProperty(e);if(!e)return  false;let t=e.__name;return this._scripts[t]===e}list(){return this._list}constructor(e){super(),this._scripts={},this._list=[],this._scriptSchemas=new Map,this.app=e;}}let uN=(e,t)=>e.constructor.order-t.constructor.order,uB=e=>e.sort(uN),uU=[],uk=[],uz=()=>{var e;return null!=(e=uk.pop())?e:[]},uV=e=>{e.length=0,uk.push(e);};class uG extends oE{addComponent(e,t){let s=this._app.systems[e];return !s||this.c[e]?null:s.addComponent(this,t)}removeComponent(e){let t=this._app.systems[e];t&&this.c[e]&&t.removeComponent(this);}findComponent(e){let t=this.findOne(t=>{var s;return null==(s=t.c)?void 0:s[e]});return t&&t.c[e]}findComponents(e){return this.find(t=>{var s;return null==(s=t.c)?void 0:s[e]}).map(t=>t.c[e])}findScript(e){let t=this.findOne(t=>{var s,i;return null==(i=t.c)?void 0:null==(s=i.script)?void 0:s.has(e)});return null==t?void 0:t.c.script.get(e)}findScripts(e){return this.find(t=>{var s,i;return null==(i=t.c)?void 0:null==(s=i.script)?void 0:s.has(e)}).map(t=>t.c.script.get(e))}getGuid(){return this._guid||this.setGuid(P.create()),this._guid}setGuid(e){let t=this._app._entityIndex;this._guid&&delete t[this._guid],this._guid=e,t[this._guid]=this;}_notifyHierarchyStateChanged(e,t){let s=false;e===this&&0===uU.length&&(s=true),e._beingEnabled=true,e._onHierarchyStateChanged(t),e._onHierarchyStatePostChanged&&uU.push(e);let i=e._children;for(let e=0,s=i.length;e<s;e++)i[e]._enabled&&this._notifyHierarchyStateChanged(i[e],t);if(e._beingEnabled=false,s){for(let e=0;e<uU.length;e++)uU[e]._onHierarchyStatePostChanged();uU.length=0;}}_onHierarchyStateChanged(e){super._onHierarchyStateChanged(e);let t=this._getSortedComponents();for(let s=0;s<t.length;s++){let i=t[s];i.enabled&&(e?i.onEnable():i.onDisable());}uV(t);}_onHierarchyStatePostChanged(){let e=this._getSortedComponents();for(let t=0;t<e.length;t++)e[t].onPostStateChange();uV(e);}findByGuid(e){if(this._guid===e)return this;let t=this._app._entityIndex[e];return t&&(t===this||t.isDescendantOf(this))?t:null}destroy(){for(let e in this._destroying=true,this.c)this.c[e].enabled=false;for(let e in this.c)this.c[e].system.removeComponent(this);super.destroy(),this._guid&&delete this._app._entityIndex[this._guid],this._destroying=false;}clone(){let e={},t=this._cloneRecursively(e);return e[this.getGuid()]=t,function e(t,s,i,n){if(s instanceof uG){let r=s.c;for(let e in r){let s=r[e],a=s.system.getPropertiesOfType("entity");for(let r=0,o=a.length;r<o;r++){let o=a[r].name,l=s[o];if(t.findByGuid(l)){let t=n[l].getGuid();t&&(i.c[e][o]=t);}}}r.script&&i.script.resolveDuplicatedEntityReferenceProperties(r.script,n),r.render&&i.render.resolveDuplicatedEntityReferenceProperties(r.render,n),r.button&&i.button.resolveDuplicatedEntityReferenceProperties(r.button,n),r.scrollview&&i.scrollview.resolveDuplicatedEntityReferenceProperties(r.scrollview,n),r.scrollbar&&i.scrollbar.resolveDuplicatedEntityReferenceProperties(r.scrollbar,n),r.anim&&i.anim.resolveDuplicatedEntityReferenceProperties(r.anim,n);let a=s.children.filter(e=>e instanceof uG),o=i.children.filter(e=>e instanceof uG);for(let s=0,i=a.length;s<i;s++)e(t,a[s],o[s],n);}}(this,this,t,e),t}_getSortedComponents(){let e=this.c,t=uz(),s=0;for(let i in e)if(e.hasOwnProperty(i)){let n=e[i];s|=0!==n.constructor.order,t.push(n);}return s&&t.length>1&&uB(t),t}_cloneRecursively(e){let t=new this.constructor(void 0,this._app);for(let e in super._cloneInternal(t),this.c)this.c[e].system.cloneComponent(this,t);for(let s=0;s<this._children.length;s++){let i=this._children[s];if(i instanceof uG){let s=i._cloneRecursively(e);t.addChild(s),e[i.getGuid()]=s;}}return t}constructor(e,t=n){super(e),this.c={},this._destroying=false,this._guid=null,this._template=false,this._app=t;}}uG.EVENT_DESTROY="destroy";class uH{get loaded(){return !!this.data}get loading(){return this._loading}constructor(e,t){this.data=null,this._loading=false,this._onLoadedCallbacks=[],this.name=e,this.url=t;}}class uW{destroy(){this._app=null;}list(){return this._list}add(e,t){if(this._index.hasOwnProperty(e))return  false;let s=new uH(e,t),i=this._list.push(s);return this._index[s.name]=i-1,this._urlIndex[s.url]=i-1,true}find(e){return this._index.hasOwnProperty(e)?this._list[this._index[e]]:null}findByUrl(e){return this._urlIndex.hasOwnProperty(e)?this._list[this._urlIndex[e]]:null}remove(e){if(this._index.hasOwnProperty(e)){let t=this._index[e],s=this._list[t];delete this._urlIndex[s.url],delete this._index[e],this._list.splice(t,1);for(let e=0;e<this._list.length;e++)s=this._list[e],this._index[s.name]=e,this._urlIndex[s.url]=e;}}_loadSceneData(e,t,s){let i=this._app,n=e;if("string"==typeof e&&(e=this.findByUrl(n)||this.find(n)||new uH("Untitled",n)),!(n=e.url)){s("Cannot find scene to load");return}if(e.loaded){s(null,e);return}i.assets&&i.assets.prefix&&!uv.test(n)&&(n=M.join(i.assets.prefix,n)),e._onLoadedCallbacks.push(s),e._loading||i.loader.getHandler("hierarchy").load(n,(s,i)=>{e.data=i,e._loading=false;for(let t=0;t<e._onLoadedCallbacks.length;t++)e._onLoadedCallbacks[t](s,e);t||(e.data=null),e._onLoadedCallbacks.length=0;}),e._loading=true;}loadSceneData(e,t){this._loadSceneData(e,true,t);}unloadSceneData(e){"string"==typeof e&&(e=this.findByUrl(e)),e&&(e.data=null);}_loadSceneHierarchy(e,t,s){this._loadSceneData(e,false,(e,i)=>{if(e){s&&s(e);return}t&&t(i);let n=this._app;n._preloadScripts(i.data,()=>{let e=n.loader.getHandler("hierarchy");n.systems.script.preloading=true;let t=e.open(i.url,i.data);n.systems.script.preloading=false,n.loader.clearCache(i.url,"hierarchy"),n.root.addChild(t),n.systems.fire("initialize",t),n.systems.fire("postInitialize",t),n.systems.fire("postPostInitialize",t),s&&s(null,t);});});}loadSceneHierarchy(e,t){this._loadSceneHierarchy(e,null,t);}loadSceneSettings(e,t){this._loadSceneData(e,false,(e,s)=>{e?t&&t(e):(this._app.applySceneSettings(s.data.settings),t&&t(null));});}changeScene(e,t){let s=this._app;this._loadSceneHierarchy(e,e=>{let{children:t}=s.root;for(;t.length;)t[0].destroy();s.applySceneSettings(e.data.settings);},t);}loadScene(e,t){let s=this._app,i=s.loader.getHandler("scene");s.assets&&s.assets.prefix&&!uv.test(e)&&(e=M.join(s.assets.prefix,e)),i.load(e,(n,r)=>{n?t&&t(n):s._preloadScripts(r,()=>{s.systems.script.preloading=true;let n=i.open(e,r),a=this.findByUrl(e);a&&!a.loaded&&(a.data=r),s.systems.script.preloading=false,s.loader.clearCache(e,"scene"),s.loader.patch({resource:n,type:"scene"},s.assets),s.root.addChild(n.root),s.systems.rigidbody&&"undefined"!=typeof Ammo&&s.systems.rigidbody.gravity.set(n._gravity.x,n._gravity.y,n._gravity.z),t&&t(null,n);});});}constructor(e){this._list=[],this._index={},this._urlIndex={},this._app=e;}}class uX{get scene(){return n.scene._stats}get lightmapper(){var e;return null==(e=n.lightmapper)?void 0:e.stats}get batcher(){let e=n._batcher;return e?e._stats:null}constructor(e){this.frame={fps:0,ms:0,dt:0,updateStart:0,updateTime:0,renderStart:0,renderTime:0,physicsStart:0,physicsTime:0,cullTime:0,sortTime:0,skinTime:0,morphTime:0,instancingTime:0,triangles:0,otherPrimitives:0,shaders:0,materials:0,cameras:0,shadowMapUpdates:0,shadowMapTime:0,depthMapTime:0,forwardTime:0,lightClustersTime:0,lightClusters:0,_timeToCountFrames:0,_fpsAccum:0},this.drawCalls={forward:0,depth:0,shadow:0,immediate:0,misc:0,total:0,skinned:0,instanced:0,removedByInstancing:0},this.misc={renderTargetCreationTime:0},this.particles={updatesPerFrame:0,_updatesPerFrame:0,frameTime:0,_frameTime:0},this.shaders=e._shaderStats,this.vram=e._vram,Object.defineProperty(this.vram,"totalUsed",{get:function(){return this.tex+this.vb+this.ib}}),Object.defineProperty(this.vram,"geom",{get:function(){return this.vb+this.ib}});}}e.app=null;class uY extends Y{init(e){let{assetPrefix:t,batchManager:s,componentSystems:i,elementInput:n,gamepads:r,graphicsDevice:a,keyboard:o,lightmapper:l,mouse:h,resourceHandlers:d,scriptsOrder:c,scriptPrefix:u,soundManager:p,touch:f,xr:m}=e;this.graphicsDevice=a,this._initDefaultMaterial(),this._initProgramLibrary(),this.stats=new uX(a),this._soundManager=p,this.scene=new dK(a),this._registerSceneImmediate(this.scene),this.assets=new uA(this.loader),t&&(this.assets.prefix=t),this.bundles=new uw(this.assets),this.scriptsOrder=c||[],this.defaultLayerWorld=new l2({name:"World",id:0}),this.defaultLayerDepth=new l2({name:"Depth",id:1,enabled:false,opaqueSortMode:0}),this.defaultLayerSkybox=new l2({name:"Skybox",id:2,opaqueSortMode:0}),this.defaultLayerUi=new l2({name:"UI",id:4,transparentSortMode:1}),this.defaultLayerImmediate=new l2({name:"Immediate",id:3,opaqueSortMode:0});let _=new l5("default");_.pushOpaque(this.defaultLayerWorld),_.pushOpaque(this.defaultLayerDepth),_.pushOpaque(this.defaultLayerSkybox),_.pushTransparent(this.defaultLayerWorld),_.pushOpaque(this.defaultLayerImmediate),_.pushTransparent(this.defaultLayerImmediate),_.pushTransparent(this.defaultLayerUi),this.scene.layers=_,ud.createPlaceholder(a),this.renderer=new lZ(a),this.renderer.scene=this.scene,l&&(this.lightmapper=new l(a,this.root,this.scene,this.renderer,this.assets),this.once("prerender",this._firstBake,this)),s&&(this._batcher=new s(a,this.root,this.scene),this.once("prerender",this._firstBatch,this)),this.keyboard=o||null,this.mouse=h||null,this.touch=f||null,this.gamepads=r||null,n&&(this.elementInput=n,this.elementInput.app=this),this.xr=m?new m(this):null,this.elementInput&&this.elementInput.attachSelectEvents(),this._scriptPrefix=u||"",this.enableBundles&&this.loader.addHandler("bundle",new uR(this)),d.forEach(e=>{let t=new e(this);this.loader.addHandler(t.handlerType,t);}),i.forEach(e=>{this.systems.add(new e(this));}),this._visibilityChangeHandler=this.onVisibilityChange.bind(this),"undefined"!=typeof document&&(void 0!==document.hidden?(this._hiddenAttr="hidden",document.addEventListener("visibilitychange",this._visibilityChangeHandler,false)):void 0!==document.mozHidden?(this._hiddenAttr="mozHidden",document.addEventListener("mozvisibilitychange",this._visibilityChangeHandler,false)):void 0!==document.msHidden?(this._hiddenAttr="msHidden",document.addEventListener("msvisibilitychange",this._visibilityChangeHandler,false)):void 0!==document.webkitHidden&&(this._hiddenAttr="webkitHidden",document.addEventListener("webkitvisibilitychange",this._visibilityChangeHandler,false))),this.tick=uq(this);}static getApplication(e){return e?uY._applications[e]:n}_initDefaultMaterial(){var e;let t=new cP;t.name="Default Material",e=this.graphicsDevice,aH.get(e,()=>t);}_initProgramLibrary(){var e;let t=new cX(this.graphicsDevice,new cP);e=this.graphicsDevice,a_.get(e,()=>t);}get soundManager(){return this._soundManager}get batcher(){return this._batcher}get fillMode(){return this._fillMode}get resolutionMode(){return this._resolutionMode}configure(e,t){rR.get(e,(e,s)=>{if(e){t(e);return}let i=s.application_properties,n=s.scenes,r=s.assets;this._parseApplicationProperties(i,e=>{this._parseScenes(n),this._parseAssets(r),e?t(e):t(null);});});}preload(e){this.fire("preload:start");let t=this.assets.list({preload:true});if(0===t.length){this.fire("preload:end"),e();return}let s=0,i=()=>{s++,this.fire("preload:progress",s/t.length),s===t.length&&(this.fire("preload:end"),e());};t.forEach(e=>{e.loaded?i():(e.once("load",i),e.once("error",i),this.assets.load(e));});}_preloadScripts(e,t){t();}_parseApplicationProperties(e,t){if("number"==typeof e.maxAssetRetries&&e.maxAssetRetries>0&&this.loader.enableRetry(e.maxAssetRetries),e.useDevicePixelRatio||(e.useDevicePixelRatio=e.use_device_pixel_ratio),e.resolutionMode||(e.resolutionMode=e.resolution_mode),e.fillMode||(e.fillMode=e.fill_mode),this._width=e.width,this._height=e.height,e.useDevicePixelRatio&&(this.graphicsDevice.maxPixelRatio=window.devicePixelRatio),this.setCanvasResolution(e.resolutionMode,this._width,this._height),this.setCanvasFillMode(e.fillMode,this._width,this._height),e.layers&&e.layerOrder){let t=new l5("application"),s={};for(let t in e.layers){let i=e.layers[t];i.id=parseInt(t,10),i.enabled=1!==i.id,s[t]=new l2(i);}for(let i=0,n=e.layerOrder.length;i<n;i++){let n=e.layerOrder[i],r=s[n.layer];r&&(n.transparent?t.pushTransparent(r):t.pushOpaque(r),t.subLayerEnabled[i]=n.enabled);}this.scene.layers=t;}if(e.batchGroups){let t=this.batcher;if(t)for(let s=0,i=e.batchGroups.length;s<i;s++){let i=e.batchGroups[s];t.addGroup(i.name,i.dynamic,i.maxAabbSize,i.id,i.layers);}}e.i18nAssets&&(this.i18n.assets=e.i18nAssets),this._loadLibraries(e.libraries,t);}_loadLibraries(e,t){let s=e.length,i=s,n=/^https?:\/\//;if(s){let r=(e,s)=>{i--,e?t(e):0===i&&(this.onLibrariesLoaded(),t(null));};for(let t=0;t<s;++t){let s=e[t];!n.test(s.toLowerCase())&&this._scriptPrefix&&(s=M.join(this._scriptPrefix,s)),this.loader.load(s,"script",r);}}else this.onLibrariesLoaded(),t(null);}_parseScenes(e){if(e)for(let t=0;t<e.length;t++)this.scenes.add(e[t].name,e[t].url);}_parseAssets(e){let t=[],s={},i={};for(let i=0;i<this.scriptsOrder.length;i++){let n=this.scriptsOrder[i];e[n]&&(s[n]=true,t.push(e[n]));}if(this.enableBundles)for(let s in e)"bundle"===e[s].type&&(i[s]=true,t.push(e[s]));for(let n in e)!s[n]&&!i[n]&&t.push(e[n]);for(let e=0;e<t.length;e++){let s=t[e],i=new ub(s.name,s.type,s.file,s.data);if(i.id=parseInt(s.id,10),i.preload=!!s.preload&&s.preload,i.loaded="script"===s.type&&s.data&&s.data.loadingType>0,i.tags.add(s.tags),s.i18n)for(let e in s.i18n)i.addLocalizedAssetId(e,s.i18n[e]);this.assets.add(i);}}start(){this.frame=0,this.fire("start",{timestamp:$(),target:this}),this._librariesLoaded||this.onLibrariesLoaded(),this.systems.fire("initialize",this.root),this.fire("initialize"),this.systems.fire("postInitialize",this.root),this.systems.fire("postPostInitialize",this.root),this.fire("postinitialize"),this.tick();}inputUpdate(e){this.controller&&this.controller.update(e),this.mouse&&this.mouse.update(),this.keyboard&&this.keyboard.update(),this.gamepads&&this.gamepads.update();}update(e){this.frame++,this.graphicsDevice.updateClientRect(),this.systems.fire(this._inTools?"toolsUpdate":"update",e),this.systems.fire("animationUpdate",e),this.systems.fire("postUpdate",e),this.fire("update",e),this.inputUpdate(e);}frameStart(){this.graphicsDevice.frameStart();}frameEnd(){this.graphicsDevice.frameEnd();}render(){this.fire("prerender"),this.root.syncHierarchy(),this._batcher&&this._batcher.updateAll(),this.renderComposition(this.scene.layers),this.fire("postrender");}renderComposition(e){this.renderer.update(e),this.renderer.buildFrameGraph(this.frameGraph,e),this.frameGraph.render(this.graphicsDevice);}_fillFrameStatsBasic(e,t,s){let i=this.stats.frame;i.dt=t,i.ms=s,e>i._timeToCountFrames?(i.fps=i._fpsAccum,i._fpsAccum=0,i._timeToCountFrames=e+1e3):i._fpsAccum++,this.stats.drawCalls.total=this.graphicsDevice._drawCallsPerFrame,this.graphicsDevice._drawCallsPerFrame=0;}_fillFrameStats(){let e=this.stats.frame;e.cameras=this.renderer._camerasRendered,e.materials=this.renderer._materialSwitches,e.shaders=this.graphicsDevice._shaderSwitchesPerFrame,e.shadowMapUpdates=this.renderer._shadowMapUpdates,e.shadowMapTime=this.renderer._shadowMapTime,e.depthMapTime=this.renderer._depthMapTime,e.forwardTime=this.renderer._forwardTime;let t=this.graphicsDevice._primsPerFrame;e.triangles=t[4]/3+Math.max(t[5]-2,0)+Math.max(t[6]-2,0),e.cullTime=this.renderer._cullTime,e.sortTime=this.renderer._sortTime,e.skinTime=this.renderer._skinTime,e.morphTime=this.renderer._morphTime,e.lightClusters=this.renderer._lightClusters,e.lightClustersTime=this.renderer._lightClustersTime,e.otherPrimitives=0;for(let s=0;s<t.length;s++)s<4&&(e.otherPrimitives+=t[s]),t[s]=0;this.renderer._camerasRendered=0,this.renderer._materialSwitches=0,this.renderer._shadowMapUpdates=0,this.graphicsDevice._shaderSwitchesPerFrame=0,this.renderer._cullTime=0,this.renderer._layerCompositionUpdateTime=0,this.renderer._lightClustersTime=0,this.renderer._sortTime=0,this.renderer._skinTime=0,this.renderer._morphTime=0,this.renderer._shadowMapTime=0,this.renderer._depthMapTime=0,this.renderer._forwardTime=0,(e=this.stats.drawCalls).forward=this.renderer._forwardDrawCalls,e.culled=this.renderer._numDrawCallsCulled,e.depth=0,e.shadow=this.renderer._shadowDrawCalls,e.skinned=this.renderer._skinDrawCalls,e.immediate=0,e.instanced=0,e.removedByInstancing=0,e.misc=e.total-(e.forward+e.shadow),this.renderer._depthDrawCalls=0,this.renderer._shadowDrawCalls=0,this.renderer._forwardDrawCalls=0,this.renderer._numDrawCallsCulled=0,this.renderer._skinDrawCalls=0,this.renderer._immediateRendered=0,this.renderer._instancedDrawCalls=0,this.stats.misc.renderTargetCreationTime=this.graphicsDevice.renderTargetCreationTime,(e=this.stats.particles).updatesPerFrame=e._updatesPerFrame,e.frameTime=e._frameTime,e._updatesPerFrame=0,e._frameTime=0;}setCanvasFillMode(e,t,s){this._fillMode=e,this.resizeCanvas(t,s);}setCanvasResolution(e,t,s){this._resolutionMode=e,e===ui&&void 0===t&&(t=this.graphicsDevice.canvas.clientWidth,s=this.graphicsDevice.canvas.clientHeight),this.graphicsDevice.resizeCanvas(t,s);}isHidden(){return document[this._hiddenAttr]}onVisibilityChange(){this.isHidden()?this._soundManager&&this._soundManager.suspend():this._soundManager&&this._soundManager.resume();}resizeCanvas(e,t){if(!this._allowResize||this.xr&&this.xr.session)return;let s=window.innerWidth,i=window.innerHeight;if(this._fillMode===us){let n=this.graphicsDevice.canvas.width/this.graphicsDevice.canvas.height;n>s/i?t=(e=s)/n:e=(t=i)*n;}else this._fillMode===ut&&(e=s,t=i);return this.graphicsDevice.canvas.style.width=""+e+"px",this.graphicsDevice.canvas.style.height=""+t+"px",this.updateCanvasSize(),{width:e,height:t}}updateCanvasSize(){var e;if(this._allowResize&&(null==(e=this.xr)||!e.active)&&this._resolutionMode===ui){let e=this.graphicsDevice.canvas;this.graphicsDevice.resizeCanvas(e.clientWidth,e.clientHeight);}}onLibrariesLoaded(){this._librariesLoaded=true,this.systems.rigidbody&&this.systems.rigidbody.onLibraryLoaded();}applySceneSettings(e){let t;if(this.systems.rigidbody&&"undefined"!=typeof Ammo){let[t,s,i]=e.physics.gravity;this.systems.rigidbody.gravity.set(t,s,i);}this.scene.applySettings(e),e.render.hasOwnProperty("skybox")&&(e.render.skybox?(t=this.assets.get(e.render.skybox))?this.setSkybox(t):this.assets.once("add:"+e.render.skybox,this.setSkybox,this):this.setSkybox(null));}setAreaLightLuts(e,t){e&&t&&ud.set(this.graphicsDevice,e,t);}setSkybox(e){if(e!==this._skyboxAsset){let t=()=>{this.setSkybox(null);},s=()=>{this.scene.setSkybox(this._skyboxAsset?this._skyboxAsset.resources:null);};this._skyboxAsset&&(this.assets.off("load:"+this._skyboxAsset.id,s,this),this.assets.off("remove:"+this._skyboxAsset.id,t,this),this._skyboxAsset.off("change",s,this)),this._skyboxAsset=e,this._skyboxAsset&&(this.assets.on("load:"+this._skyboxAsset.id,s,this),this.assets.once("remove:"+this._skyboxAsset.id,t,this),this._skyboxAsset.on("change",s,this),0!==this.scene.skyboxMip||this._skyboxAsset.loadFaces||(this._skyboxAsset.loadFaces=true),this.assets.load(this._skyboxAsset)),s();}}_firstBake(){var e;null==(e=this.lightmapper)||e.bake(null,this.scene.lightmapMode);}_firstBatch(){var e;null==(e=this.batcher)||e.generate();}_processTimestamp(e){return e}drawLine(e,t,s,i,n){this.scene.drawLine(e,t,s,i,n);}drawLines(e,t,s,i){ void 0===s&&(s=true),void 0===i&&(i=this.scene.defaultDrawLayer),this.scene.drawLines(e,t,s,i);}drawLineArrays(e,t,s,i){ void 0===s&&(s=true),void 0===i&&(i=this.scene.defaultDrawLayer),this.scene.drawLineArrays(e,t,s,i);}drawWireSphere(e,t,s,i,n,r){ void 0===s&&(s=en.WHITE),void 0===i&&(i=20),void 0===n&&(n=true),void 0===r&&(r=this.scene.defaultDrawLayer),this.scene.immediate.drawWireSphere(e,t,s,i,n,r);}drawWireAlignedBox(e,t,s,i,n,r){ void 0===s&&(s=en.WHITE),void 0===i&&(i=true),void 0===n&&(n=this.scene.defaultDrawLayer),this.scene.immediate.drawWireAlignedBox(e,t,s,i,n,r);}drawMeshInstance(e,t){ void 0===t&&(t=this.scene.defaultDrawLayer),this.scene.immediate.drawMesh(null,null,null,e,t);}drawMesh(e,t,s,i){ void 0===i&&(i=this.scene.defaultDrawLayer),this.scene.immediate.drawMesh(t,s,e,null,i);}drawQuad(e,t,s){ void 0===s&&(s=this.scene.defaultDrawLayer),this.scene.immediate.drawMesh(t,e,this.scene.immediate.getQuadMesh(),null,s);}drawTexture(e,t,s,i,n,r,a,o){if(void 0===a&&(a=this.scene.defaultDrawLayer),void 0===o&&(o=true),false===o&&!this.graphicsDevice.isWebGPU)return;let l=new ex;l.setTRS(new eu(e,t,0),eT.IDENTITY,new eu(s,-i,0)),r||((r=new h9).cull=0,r.setParameter("colorMap",n),r.shaderDesc=o?this.scene.immediate.getTextureShaderDesc(n.encoding):this.scene.immediate.getUnfilterableTextureShaderDesc(),r.update()),this.drawQuad(l,r,a);}drawDepthTexture(e,t,s,i,n){ void 0===n&&(n=this.scene.defaultDrawLayer);let r=new h9;r.cull=0,r.shaderDesc=this.scene.immediate.getDepthTextureShaderDesc(),r.update(),this.drawTexture(e,t,s,i,null,r,n);}destroy(){var e,t,s,i;if(this._inFrameUpdate){this._destroyRequested=true;return}let r=this.graphicsDevice.canvas.id;this.fire("destroy",this),this.off("librariesloaded"),"undefined"!=typeof document&&(document.removeEventListener("visibilitychange",this._visibilityChangeHandler,false),document.removeEventListener("mozvisibilitychange",this._visibilityChangeHandler,false),document.removeEventListener("msvisibilitychange",this._visibilityChangeHandler,false),document.removeEventListener("webkitvisibilitychange",this._visibilityChangeHandler,false)),this._visibilityChangeHandler=null,this.root.destroy(),this.root=null,this.mouse&&(this.mouse.off(),this.mouse.detach(),this.mouse=null),this.keyboard&&(this.keyboard.off(),this.keyboard.detach(),this.keyboard=null),this.touch&&(this.touch.off(),this.touch.detach(),this.touch=null),this.elementInput&&(this.elementInput.detach(),this.elementInput=null),this.gamepads&&(this.gamepads.destroy(),this.gamepads=null),this.controller&&(this.controller=null),this.systems.destroy(),this.scene.layers&&this.scene.layers.destroy();let a=this.assets.list();for(let e=0;e<a.length;e++)a[e].unload(),a[e].off();this.assets.off(),this.bundles.destroy(),this.bundles=null,this.i18n.destroy(),this.i18n=null;let o=this.loader.getHandler("script");null==o||o.clearCache(),this.loader.destroy(),this.loader=null,this.scene.destroy(),this.scene=null,this.systems=null,this.context=null,this.scripts.destroy(),this.scripts=null,this.scenes.destroy(),this.scenes=null,null==(e=this.lightmapper)||e.destroy(),this.lightmapper=null,this._batcher&&(this._batcher.destroy(),this._batcher=null),this._entityIndex={},this.defaultLayerDepth.onDisable=null,this.defaultLayerDepth.onEnable=null,this.defaultLayerDepth=null,this.defaultLayerWorld=null,null==(t=this.xr)||t.end(),null==(s=this.xr)||s.destroy(),this.renderer.destroy(),this.renderer=null,this.graphicsDevice.destroy(),this.graphicsDevice=null,this.tick=null,this.off(),null==(i=this._soundManager)||i.destroy(),this._soundManager=null,ua.app=null,uY._applications[r]=null,n===this&&(n=null),uY.cancelTick(this);}static cancelTick(e){e.frameRequestId&&(window.cancelAnimationFrame(e.frameRequestId),e.frameRequestId=void 0);}getEntityFromIndex(e){return this._entityIndex[e]}_registerSceneImmediate(e){this.on("postrender",e.immediate.onPostRender,e.immediate);}constructor(t){super(),this._batcher=null,this._destroyRequested=false,this._inFrameUpdate=false,this._librariesLoaded=false,this._fillMode=us,this._resolutionMode=un,this._allowResize=true,this._skyboxAsset=null,this._entityIndex={},this._inTools=false,this._scriptPrefix="",this._time=0,this.enableBundles="undefined"!=typeof TextDecoder,this.timeScale=1,this.maxDeltaTime=.1,this.frame=0,this.frameGraph=new uo,this.scriptsOrder=[],this.autoRender=true,this.renderNextFrame=false,this.lightmapper=null,this.loader=new uL(this),this.scenes=new uW(this),this.scripts=new uF(this),this.systems=new uC,this.i18n=new uO(this),this.keyboard=null,this.mouse=null,this.touch=null,this.gamepads=null,this.elementInput=null,this.xr=null,uY._applications[t.id]=this,n=this,e.app=this,this.root=new uG,this.root._enabledInHierarchy=true;}}uY._applications={};let uj={},uq=function(t){return function(s,i){var r,a,o,l;if(!t.graphicsDevice)return;t.frameRequestId&&(null==(o=t.xr)||null==(a=o.session)||a.cancelAnimationFrame(t.frameRequestId),cancelAnimationFrame(t.frameRequestId),t.frameRequestId=null),t._inFrameUpdate=true,n=t,e.app=t;let h=t._processTimestamp(s)||$(),d=h-(t._time||h),c=d/1e3;if(c=ei.clamp(c,0,t.maxDeltaTime)*t.timeScale,t._time=h,(null==(r=t.xr)?void 0:r.session)?t.frameRequestId=t.xr.session.requestAnimationFrame(t.tick):t.frameRequestId=k.browser||k.worker?requestAnimationFrame(t.tick):null,t.graphicsDevice.contextLost)return;t._fillFrameStatsBasic(h,c,d),t.fire("frameupdate",d);let u=true;i?(u=null==(l=t.xr)?void 0:l.update(i),t.graphicsDevice.defaultFramebuffer=i.session.renderState.baseLayer.framebuffer):t.graphicsDevice.defaultFramebuffer=null,u&&(t.update(c),t.fire("framerender"),(t.autoRender||t.renderNextFrame)&&(t.updateCanvasSize(),t.frameStart(),t.render(),t.frameEnd(),t.renderNextFrame=false),uj.timestamp=$(),uj.target=t,t.fire("frameend",uj)),t._inFrameUpdate=false,t._destroyRequested&&t.destroy();}};class uK{constructor(){this.componentSystems=[],this.resourceHandlers=[];}}let uZ=new eR;class uQ{store(){this.mask=this.light.mask,this.shadowUpdateMode=this.light.shadowUpdateMode,this.enabled=this.light.enabled,this.intensity=this.light.intensity,this.rotation=this.light._node.getLocalRotation().clone(),this.numCascades=this.light.numCascades,this.castShadows=this.light._castShadows;}restore(){let e=this.light;e.mask=this.mask,e.shadowUpdateMode=this.shadowUpdateMode,e.enabled=this.enabled,e.intensity=this.intensity,e._node.setLocalRotation(this.rotation),e.numCascades=this.numCascades,e._castShadows=this.castShadows;}startBake(){this.light.enabled=true,this.light._destroyShadowMap(),this.light.beginFrame();}endBake(e){let t=this.light;t.enabled=false,t.shadowMap&&(t.shadowMap.cached&&e.add(t,t.shadowMap),t.shadowMap=null);}constructor(e,t,s){this.scene=e,this.light=t,this.store(),t.numCascades=1,this.scene.clusteredLightingEnabled&&!s.shadowsEnabled&&(t.castShadows=false),0!==t.type&&(t._node.getWorldTransform(),t.getBoundingSphere(uZ),this.lightBounds=new eP,this.lightBounds.center.copy(uZ.center),this.lightBounds.halfExtents.set(uZ.radius,uZ.radius,uZ.radius));}}let uJ=new ef;class u$ extends uQ{get numVirtualLights(){return 0===this.light.type?this.light.bakeNumSamples:1}prepareVirtualLight(e,t){let s=this.light;if(s._node.setLocalRotation(this.rotation),e>0){let i=s.bakeArea;dy.circlePointDeterministic(uJ,e,t),uJ.mulScalar(.5*i),s._node.rotateLocal(uJ.x,0,uJ.y);}s._node.getWorldTransform(),s.intensity=Math.pow(Math.pow(this.intensity,2.2)/t,.45454545454545453);}constructor(e,t){super(e.scene,t,e.lightingParams);}}let u0=new eu;class u1 extends uQ{get numVirtualLights(){return this.light.bakeNumSamples}prepareVirtualLight(e,t){dy.spherePointDeterministic(u0,e,t,0,this.scene.ambientBakeSpherePart),this.light._node.lookAt(u0.mulScalar(-1)),this.light._node.rotateLocal(90,0,0);let s=Math.pow(2*Math.PI*this.scene.ambientBakeSpherePart,2.2);this.light.intensity=Math.pow(s/t,.45454545454545453);}constructor(e){let t=e.scene,s=new uG("AmbientLight");s.addComponent("light",{type:"directional",affectDynamic:true,affectLightmapped:false,bake:true,bakeNumSamples:t.ambientBakeNumSamples,castShadows:true,normalOffsetBias:.05,shadowBias:.2,shadowDistance:1,shadowResolution:2048,shadowType:0,color:en.WHITE,intensity:1,bakeDir:false}),super(t,s.light.light,e.lightingParams);}}class u2{store(){this.castShadows=this.component.castShadows;}restore(){this.component.castShadows=this.castShadows;}constructor(e,t=null){this.node=e,this.component=e.render||e.model,t=t||this.component.meshInstances,this.store(),this.meshInstances=t,this.bounds=null,this.renderTargets=[];}}class u3{setSourceTexture(e){this.constantTexSource.setValue(e);}prepare(e,t){this.pixelOffset[0]=1/e,this.pixelOffset[1]=1/t,this.constantPixelOffset.setValue(this.pixelOffset);}prepareDenoise(e,t,s){let i=+!s;this.shaderDenoise[i]||(this.shaderDenoise[i]=ab(this.device,am.fullscreenQuadVS,(s?"#define HDR\n":"")+cY.bilateralDeNoisePS,"lmBilateralDeNoise-"+(s?"hdr":"rgbm")),this.sigmas=new Float32Array(2),this.constantSigmas=this.device.scope.resolve("sigmas"),this.constantKernel=this.device.scope.resolve("kernel[0]"),this.bZnorm=this.device.scope.resolve("bZnorm")),this.sigmas[0]=e,this.sigmas[1]=t,this.constantSigmas.setValue(this.sigmas),this.evaluateDenoiseUniforms(e,t);}getDenoise(e){return this.shaderDenoise[+!e]}getDilate(e,t){let s=+!t;return this.shaderDilate[s]||(this.shaderDilate[s]=ab(e,am.fullscreenQuadVS,(t?"#define HDR\n":"")+cY.dilatePS,"lmDilate-"+(t?"hdr":"rgbm"))),this.shaderDilate[s]}evaluateDenoiseUniforms(e,t){function s(e,t){return .39894*Math.exp(-0.5*e*e/(t*t))/t}this.kernel=this.kernel||new Float32Array(15);let i=this.kernel,n=Math.floor(7);for(let t=0;t<=n;++t){let r=s(t,e);i[n+t]=r,i[n-t]=r;}this.constantKernel.setValue(this.kernel);let r=1/s(0,t);this.bZnorm.setValue(r);}constructor(e){this.device=e,this.shaderDilate=ab(e,am.fullscreenQuadVS,cY.dilatePS,"lmDilate"),this.constantTexSource=e.scope.resolve("source"),this.constantPixelOffset=e.scope.resolve("pixelOffset"),this.pixelOffset=new Float32Array(2),this.shaderDenoise=[],this.sigmas=null,this.constantSigmas=null,this.kernel=null;}}class u4 extends nK{destroy(){this.viewBindGroups.forEach(e=>{e.defaultUniformBuffer.destroy(),e.destroy();}),this.viewBindGroups.length=0;}execute(){this.device;let{renderer:e,camera:t,receivers:s,renderTarget:i,worldClusters:n,lightArray:r}=this;e.renderForwardLayer(t,i,null,void 0,0,this.viewBindGroups,{meshInstances:s,splitLights:r,lightClusters:n});}constructor(e,t,s,i,n,r){super(e),this.viewBindGroups=[],this.renderer=t,this.camera=s,this.worldClusters=i,this.receivers=n,this.lightArray=r;}}let u5=new eu;class u6{destroy(){var e;aX.decRef(this.blackTex),this.blackTex=null,aX.destroy(),this.device=null,this.root=null,this.scene=null,this.renderer=null,this.assets=null,null==(e=this.camera)||e.destroy(),this.camera=null;}initBake(e){if(this.bakeHDR=7!==this.scene.lightmapPixelFormat,!this._initCalled){this._initCalled=true,this.lightmapFilters=new u3(e),this.constantBakeDir=e.scope.resolve("bakeDir"),this.materials=[],this.blackTex=new se(this.device,{width:4,height:4,format:7,type:tE,name:"lightmapBlack"}),aX.incRef(this.blackTex);let t=new oo;t.clearColor.set(0,0,0,0),t.clearColorBuffer=true,t.clearDepthBuffer=false,t.clearStencilBuffer=false,t.frustumCulling=false,t.projection=1,t.aspectRatio=1,t.node=new oE,this.camera=t,this.camera.shaderParams.gammaCorrection=0,this.camera.shaderParams.toneMapping=0;}if(this.scene.clusteredLightingEnabled){let t=new ha(e.supportsAreaLights,e.maxTextureSize,()=>{});this.lightingParams=t;let s=this.scene.lighting;t.shadowsEnabled=s.shadowsEnabled,t.shadowAtlasResolution=s.shadowAtlasResolution,t.cookiesEnabled=s.cookiesEnabled,t.cookieAtlasResolution=s.cookieAtlasResolution,t.areaLightsEnabled=s.areaLightsEnabled,t.cells=new eu(3,3,3),t.maxLightsPerCell=4,this.worldClusters=new oG(e),this.worldClusters.name="ClusterLightmapper";}}finishBake(e){function t(e){aX.decRef(e.colorBuffer),e.destroy();}this.materials=[],this.renderTargets.forEach(e=>{t(e);}),this.renderTargets.clear(),e.forEach(e=>{e.renderTargets.forEach(e=>{t(e);}),e.renderTargets.length=0;}),this.ambientAOMaterial=null,this.worldClusters&&(this.worldClusters.destroy(),this.worldClusters=null);}createMaterialForPass(e,t,s,i){let n=new cP;if(n.name="lmMaterial-pass:"+s+"-ambient:"+i,n.chunks.APIVersion=t$,n.setDefine("UV1LAYOUT",""),0===s){let e=cY.bakeLmEndPS;i?e="\n                    dDiffuseLight = ((dDiffuseLight - 0.5) * max("+t.ambientBakeOcclusionContrast.toFixed(1)+" + 1.0, 0.0)) + 0.5;\n                    dDiffuseLight += vec3("+t.ambientBakeOcclusionBrightness.toFixed(1)+");\n                    dDiffuseLight = saturate(dDiffuseLight);\n                    dDiffuseLight *= dAmbientLight;\n                    "+e+"\n                ":n.ambient=new en(0,0,0),n.chunks.basePS=am.basePS+(this.bakeHDR?"":"\n#define LIGHTMAP_RGBM\n"),n.chunks.endPS=e,n.lightMap=this.blackTex;}else n.chunks.basePS="\n                #define STD_LIGHTMAP_DIR\n                "+am.basePS+"\n                uniform float bakeDir;\n            ",n.chunks.endPS=cY.bakeDirLmEndPS;return n.chunks.outputAlphaPS="\n",n.cull=0,n.forceUv1=true,n.update(),n}createMaterials(e,t,s){for(let i=0;i<s;i++)this.passMaterials[i]||(this.passMaterials[i]=this.createMaterialForPass(e,t,i,false));this.ambientAOMaterial||(this.ambientAOMaterial=this.createMaterialForPass(e,t,0,true),this.ambientAOMaterial.onUpdateShader=function(e){return e.litOptions.lightMapWithoutAmbient=true,e.litOptions.separateAmbient=true,e});}createTexture(e,t){return new se(this.device,{width:e,height:e,format:this.scene.lightmapPixelFormat,mipmaps:false,type:this.bakeHDR?tb:tE,minFilter:0,magFilter:0,addressU:1,addressV:1,name:t})}collectModels(e,t,s){var i,n,r;let a;if(e.enabled){if((null==(i=e.model)?void 0:i.model)&&(null==(n=e.model)?void 0:n.enabled)&&(s&&s.push(new u2(e)),e.model.lightmapped&&t&&(a=e.model.model.meshInstances)),(null==(r=e.render)?void 0:r.enabled)&&(s&&s.push(new u2(e)),e.render.lightmapped&&t&&(a=e.render.meshInstances)),a){let s=true;for(let e=0;e<a.length;e++)if(!a[e].mesh.vertexBuffer.format.hasUv1){s=false;break}if(s){let s=[];for(let i=0;i<a.length;i++){let n=a[i].mesh;this._tempSet.has(n)?t.push(new u2(e,[a[i]])):s.push(a[i]),this._tempSet.add(n);}this._tempSet.clear(),s.length>0&&t.push(new u2(e,s));}}for(let i=0;i<e._children.length;i++)this.collectModels(e._children[i],t,s);}}prepareShadowCasters(e){let t=[];for(let s=0;s<e.length;s++){let i=e[s].component;if(i.castShadows=i.castShadowsLightmap,i.castShadowsLightmap){let i=e[s].meshInstances;for(let e=0;e<i.length;e++)i[e].visibleThisFrame=true,t.push(i[e]);}}return t}updateTransforms(e){for(let t=0;t<e.length;t++){let s=e[t].meshInstances;for(let e=0;e<s.length;e++)s[e].node.getWorldTransform();}}calculateLightmapSize(e){let t,s,i;let n=this.scene.lightmapSizeMultiplier||16;e.model?(i=e.model.lightmapSizeMultiplier,e.model.asset?(t=this.assets.get(e.model.asset).data).area&&(s=t.area):e.model._area&&(t=e.model)._area&&(s=t._area)):e.render&&(i=e.render.lightmapSizeMultiplier,"asset"!==e.render.type&&e.render._area&&(t=e.render)._area&&(s=t._area));let r={x:1,y:1,z:1,uv:1};s&&(r.x=s.x,r.y=s.y,r.z=s.z,r.uv=s.uv);let a=i||1;r.x*=a,r.y*=a,r.z*=a;let o=e.render||e.model,l=this.computeNodeBounds(o.meshInstances);u5.copy(l.halfExtents);let h=r.x*u5.y*u5.z+r.y*u5.x*u5.z+r.z*u5.x*u5.y;return h/=r.uv,h=Math.sqrt(h),Math.min(ei.nextPowerOfTwo(h*n),this.scene.lightmapMaxResolution||2048)}setLightmapping(e,t,s,i){for(let n=0;n<e.length;n++){let r=e[n],a=r.meshInstances;for(let e=0;e<a.length;e++){let n=a[e];if(n.setLightmapped(t),t){i&&(n._shaderDefs|=i),n.mask=2;for(let e=0;e<s;e++){let t=r.renderTargets[e].colorBuffer;t.minFilter=1,t.magFilter=1,n.setRealtimeLightmap(a0.lightmapParamNames[e],t);}}}}}bake(e,t){ void 0===t&&(t=1);let s=this.device,i=$();this.scene._updateSkyMesh(),this.stats.renderPasses=0,this.stats.shadowMapTime=0,this.stats.forwardTime=0;let n=s._shaderStats.linked,r=s._renderTargetCreationTime,a=s._shaderStats.compileTime,o=[],l=[];if(e){for(let t=0;t<e.length;t++)this.collectModels(e[t],o,null);this.collectModels(this.root,null,l);}else this.collectModels(this.root,o,l);if(o.length>0){this.renderer.shadowRenderer.frameUpdate();let e=1===t?2:1;this.setLightmapping(o,false,e),this.initBake(s),this.bakeInternal(e,o,l);let i=64;1===t&&(i|=128),this.scene.ambientBake&&(i|=4096),this.setLightmapping(o,true,e,i),this.finishBake(o);}let h=$();this.stats.totalRenderTime=h-i,this.stats.shadersLinked=s._shaderStats.linked-n,this.stats.compileTime=s._shaderStats.compileTime-a,this.stats.fboTime=s._renderTargetCreationTime-r,this.stats.lightmapCount=o.length;}allocateTextures(e,t){for(let s=0;s<e.length;s++){let i=e[s],n=this.calculateLightmapSize(i.node);for(let e=0;e<t;e++){let t=this.createTexture(n,"lightmapper_lightmap_"+s);aX.incRef(t),i.renderTargets[e]=new sR({colorBuffer:t,depth:false});}if(!this.renderTargets.has(n)){let e=this.createTexture(n,"lightmapper_temp_lightmap_"+n);aX.incRef(e),this.renderTargets.set(n,new sR({colorBuffer:e,depth:false}));}}}prepareLightsToBake(e,t){if(this.scene.ambientBake){let e=new u1(this);t.push(e);}let s=this.renderer.lights;for(let i=0;i<s.length;i++){let n=s[i],r=new u$(this,n);e.push(r),n.enabled&&(4&n.mask)!=0&&(n.mask=7,n.shadowUpdateMode=0===n.type?2:1,t.push(r));}t.sort();}restoreLights(e){for(let t=0;t<e.length;t++)e[t].restore();}setupScene(){this.ambientLight.copy(this.scene.ambientLight),this.scene.ambientBake||this.scene.ambientLight.set(0,0,0),this.renderer.setSceneConstants();}restoreScene(){this.scene.ambientLight.copy(this.ambientLight);}computeNodeBounds(e){let t=new eP;if(e.length>0){t.copy(e[0].aabb);for(let s=1;s<e.length;s++)t.add(e[s].aabb);}return t}computeNodesBounds(e){for(let t=0;t<e.length;t++){let s=e[t].meshInstances;e[t].bounds=this.computeNodeBounds(s);}}computeBounds(e){let t=new eP;for(let s=0;s<e.length;s++){t.copy(e[0].aabb);for(let s=1;s<e.length;s++)t.add(e[s].aabb);}return t}backupMaterials(e){for(let t=0;t<e.length;t++)this.materials[t]=e[t].material;}restoreMaterials(e){for(let t=0;t<e.length;t++)e[t].material=this.materials[t];}lightCameraPrepare(e,t){let s;let i=t.light;return 2===i.type&&((s=i.getRenderData(null,0).shadowCamera)._node.setPosition(i._node.getPosition()),s._node.setRotation(i._node.getRotation()),s._node.rotateLocal(-90,0,0),s.projection=0,s.nearClip=i.attenuationEnd/1e3,s.farClip=i.attenuationEnd,s.aspectRatio=1,s.fov=2*i._outerConeAngle,this.renderer.updateCameraFrustum(s)),s}lightCameraPrepareAndCull(e,t,s,i){let n=e.light,r=true;if(0===n.type){u5.copy(i.center),u5.y+=i.halfExtents.y,this.camera.node.setPosition(u5),this.camera.node.setEulerAngles(-90,0,0),this.camera.nearClip=0,this.camera.farClip=2*i.halfExtents.y;let e=Math.max(i.halfExtents.x,i.halfExtents.z);this.camera.orthoHeight=e;}else e.lightBounds.intersects(t.bounds)||(r=false);if(2===n.type){let e=false,i=t.meshInstances;for(let t=0;t<i.length;t++)if(i[t]._isVisible(s)){e=true;break}e||(r=false);}return r}setupLightArray(e,t){e[0].length=0,e[1].length=0,e[2].length=0,e[t.type][0]=t,t.visibleThisFrame=true;}renderShadowMap(e,t,s,i){let n=i.light,r=this.scene.clusteredLightingEnabled,a=n.castShadows&&(!r||this.scene.lighting.shadowsEnabled);if(!t&&a){if(n.shadowMap||r||(n.shadowMap=this.shadowMapCache.get(this.device,n)),0===n.type){this.renderer._shadowRendererDirectional.cull(n,e,this.camera,s);let t=this.renderer._shadowRendererDirectional.getLightRenderPass(n,this.camera);null==t||t.render();}else {if(this.device.isWebGPU)return  true;this.renderer._shadowRendererLocal.cull(n,e,s),this.renderer.shadowRenderer.render(n,this.camera,false);}}return  true}postprocessTextures(e,t,s){let i;let n=this.lightmapFilters.getDilate(e,this.bakeHDR),r=this.scene.lightmapFilterEnabled;r&&(this.lightmapFilters.prepareDenoise(this.scene.lightmapFilterRange,this.scene.lightmapFilterSmoothness,this.bakeHDR),i=this.lightmapFilters.getDenoise(this.bakeHDR)),e.setBlendState(sh.NOBLEND),e.setDepthState(su.NODEPTH),e.setStencilState(null,null);for(let a=0;a<t.length;a++){let o=t[a];for(let t=0;t<s;t++){let s=o.renderTargets[t],a=s.colorBuffer,l=this.renderTargets.get(a.width),h=l.colorBuffer;this.lightmapFilters.prepare(a.width,a.height);for(let o=0;o<1;o++)this.lightmapFilters.setSourceTexture(a),aD(e,l,r&&0===t&&0===o?i:n),this.lightmapFilters.setSourceTexture(h),aD(e,s,n);}}}bakeInternal(e,t,s){let i,n,r,a,o,l;let h=this.scene,d=h.layers,c=this.device,u=h.clusteredLightingEnabled;this.createMaterials(c,h,e),this.setupScene(),d._update(),this.computeNodesBounds(t),this.allocateTextures(t,e),this.renderer.collectLights(d);let p=[],f=[];this.prepareLightsToBake(p,f),this.updateTransforms(s);let m=this.prepareShadowCasters(s);this.renderer.updateCpuSkinMatrices(m),this.renderer.gpuUpdate(m);let _=this.computeBounds(m);for(i=0;i<t.length;i++)for(n=0,r=t[i].meshInstances;n<r.length;n++)(a=r[n]).setLightmapped(false),a.mask=4,a.setRealtimeLightmap(a0.lightmapParamNames[0],this.blackTex),a.setRealtimeLightmap(a0.lightmapParamNames[1],this.blackTex);for(n=0;n<f.length;n++)f[n].light.enabled=false;let g=[[],[],[]],v=false;for(i=0;i<f.length;i++){let s=f[i],p=s instanceof u1,y=0===s.light.type,S=s.numVirtualLights;e>1&&S>1&&s.light.bakeDir&&(S=1);for(let i=0;i<S;i++){S>1&&s.prepareVirtualLight(i,S),s.startBake();let f=false,x=this.lightCameraPrepare(c,s);for(l=0;l<t.length;l++){let T=t[l];if(r=T.meshInstances,!this.lightCameraPrepareAndCull(s,T,x,_))continue;this.setupLightArray(g,s.light);let b=y?[]:[s.light];for(u&&this.renderer.lightTextureAtlas.update(b,this.lightingParams),f=this.renderShadowMap(d,f,m,s),u&&this.worldClusters.update(b,this.lightingParams),this.backupMaterials(r),o=0;o<e&&(!(o>0)||!(i>0))&&(!p||!(o>0));o++){let e=T.renderTargets[o],t=T.renderTargets[o].colorBuffer.width,l=this.renderTargets.get(t),d=l.colorBuffer;0===o?v=h.updateShaders:v&&(h.updateShaders=true);let f=this.passMaterials[o];for(p&&i+1===S&&0===o&&(f=this.ambientAOMaterial),n=0;n<r.length;n++)r[n].material=f;if(this.renderer.updateShaders(r),1===o&&this.constantBakeDir.setValue(+!!s.light.bakeDir),c.isWebGPU){let e=new u4(c,this.renderer,this.camera,u?this.worldClusters:null,r,g);e.init(l),e.render(),e.destroy();}else this.renderer.setCamera(this.camera,l,true),u&&this.worldClusters.activate(),this.renderer._forwardTime=0,this.renderer._shadowMapTime=0,this.renderer.renderForward(this.camera,l,r,g,0),c.updateEnd();for(T.renderTargets[o]=l,this.renderTargets.set(t,e),n=0;n<r.length;n++)(a=r[n]).setRealtimeLightmap(a0.lightmapParamNames[o],d),a._shaderDefs|=64;}this.restoreMaterials(r);}s.endBake(this.shadowMapCache);}}for(this.postprocessTextures(c,t,e),l=0;l<s.length;l++)s[l].restore();this.restoreLights(p),this.restoreScene(),u||this.shadowMapCache.clear();}constructor(e,t,s,i,n){this.device=e,this.root=t,this.scene=s,this.renderer=i,this.assets=n,this.shadowMapCache=i.shadowMapCache,this._tempSet=new Set,this._initCalled=false,this.passMaterials=[],this.ambientAOMaterial=null,this.fog="",this.ambientLight=new en,this.renderTargets=new Map,this.stats={renderPasses:0,lightmapCount:0,totalRenderTime:0,forwardTime:0,fboTime:0,shadowMapTime:0,compileTime:0,shadersLinked:0};}}class u8 extends Y{static _buildAccessors(e,t){t.forEach(t=>{let s="object"==typeof t?t.name:t;Object.defineProperty(e,s,{get:function(){return this.data[s]},set:function(e){let t=this.data,i=t[s];t[s]=e,this.fire("set",s,i,e);},configurable:true});}),e._accessorsBuilt=true;}buildAccessors(e){u8._buildAccessors(this,e);}onSetEnabled(e,t,s){t!==s&&this.entity.enabled&&(s?this.onEnable():this.onDisable());}onEnable(){}onDisable(){}onPostStateChange(){}get data(){let e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){}get enabled(){return  true}constructor(e,t){super(),this.system=e,this.entity=t,this.system.schema&&!this._accessorsBuilt&&this.buildAccessors(this.system.schema),this.on("set",function(e,t,s){this.fire("set_"+e,e,t,s);}),this.on("set_enabled",this.onSetEnabled,this);}}u8.order=0;class u9 extends Y{addComponent(e,t){ void 0===t&&(t={});let s=new this.ComponentType(this,e),i=new this.DataType;return this.store[e.getGuid()]={entity:e,data:i},e[this.id]=s,e.c[this.id]=s,this.initializeComponentData(s,t,[]),this.fire("add",e,s),s}removeComponent(e){let t=this.id,s=this.store[e.getGuid()],i=e.c[t];i.fire("beforeremove"),this.fire("beforeremove",e,i),delete this.store[e.getGuid()],e[t]=void 0,delete e.c[t],this.fire("remove",e,s.data);}cloneComponent(e,t){let s=this.store[e.getGuid()];return this.addComponent(t,s.data)}initializeComponentData(e,t,s){ void 0===t&&(t={});for(let i=0,n=s.length;i<n;i++){let n,r;let a=s[i];"object"==typeof a?(n=a.name,r=a.type):(n=a,r=void 0);let o=t[n];void 0!==o?(void 0!==r&&(o=function(e,t){if(!e)return e;switch(t){case "rgb":if(e instanceof en)return e.clone();return new en(e[0],e[1],e[2]);case "rgba":if(e instanceof en)return e.clone();return new en(e[0],e[1],e[2],e[3]);case "vec2":if(e instanceof ef)return e.clone();return new ef(e[0],e[1]);case "vec3":if(e instanceof eu)return e.clone();return new eu(e[0],e[1],e[2]);case "vec4":if(e instanceof em)return e.clone();return new em(e[0],e[1],e[2],e[3]);case "boolean":case "number":case "string":case "entity":return e;default:throw Error("Could not convert unhandled type: "+t)}}(o,r)),e[n]=o):e[n]=e.data[n];}e.enabled&&e.entity.enabled&&e.onEnable();}getPropertiesOfType(e){let t=[];return (this.schema||[]).forEach(s=>{s&&"object"==typeof s&&s.type===e&&t.push(s);}),t}destroy(){this.off();}constructor(e){super(),this.app=e,this.store={},this.schema=[];}}class u7{update(e,t){if(e<this._left||e>=this._right){let s=t.length;if(s){if(e<t[0])this._left=-1/0,this._right=t[0],this._len=0,this._recip=0,this._p0=this._p1=0;else if(e>=t[s-1])this._left=t[s-1],this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=s-1;else {let s=this._findKey(e,t);this._left=t[s],this._right=t[s+1],this._len=this._right-this._left;let i=1/this._len;this._recip=isFinite(i)?i:0,this._p0=s,this._p1=s+1;}}else this._left=-1/0,this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=0;}this._t=0===this._recip?0:(e-this._left)*this._recip,this._hermite.valid=false;}_findKey(e,t){let s=0;for(;e>=t[s+1];)s++;return s}eval(e,t,s){let i=s._data,n=s._components,r=this._p0*n;if(0===t)for(let t=0;t<n;++t)e[t]=i[r+t];else {let s=this._t,a=this._p1*n;switch(t){case 1:for(let t=0;t<n;++t)e[t]=ei.lerp(i[r+t],i[a+t],s);break;case 2:{let t=this._hermite;if(!t.valid){let e=s*s,i=s+s,n=1-s,r=n*n;t.valid=true,t.p0=(1+i)*r,t.m0=s*r,t.p1=e*(3-i),t.m1=e*(s-1);}let r=(3*this._p0+1)*n,a=(3*this._p0+2)*n,o=(3*this._p1+1)*n,l=(3*this._p1+0)*n;for(let s=0;s<n;++s)e[s]=t.p0*i[r+s]+t.m0*i[a+s]*this._len+t.p1*i[o+s]+t.m1*i[l+s]*this._len;}}}}constructor(){this._left=1/0,this._right=-1/0,this._len=0,this._recip=0,this._p0=0,this._p1=0,this._t=0,this._hermite={valid:false,p0:0,m0:0,p1:0,m1:0};}}class pe{constructor(e){this._name=""+e.name+"Snapshot",this._time=-1,this._cache=[],this._results=[];for(let t=0;t<e._inputs.length;++t)this._cache[t]=new u7;let t=e._curves,s=e._outputs;for(let e=0;e<t.length;++e){let i=s[t[e]._output],n=[];for(let e=0;e<i._components;++e)n[e]=0;this._results[e]=n;}}}function pt(){return (pt=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i]);}return e}).apply(this,arguments)}class ps{set name(e){this._name=e;}get name(){return this._name}set track(e){this._track=e,this._snapshot=new pe(e);}get track(){return this._track}get snapshot(){return this._snapshot}set time(e){this._time=e,this.alignCursorToCurrentTime();}get time(){return this._time}set speed(e){let t=Math.sign(e)!==Math.sign(this._speed);this._speed=e,t&&this.alignCursorToCurrentTime();}get speed(){return this._speed}set loop(e){this._loop=e;}get loop(){return this._loop}set blendWeight(e){this._blendWeight=e;}get blendWeight(){return this._blendWeight}set blendOrder(e){this._blendOrder=e;}get blendOrder(){return this._blendOrder}set eventCursor(e){this._eventCursor=e;}get eventCursor(){return this._eventCursor}get eventCursorEnd(){return this.isReverse?0:this._track.events.length-1}get nextEvent(){return this._track.events[this._eventCursor]}get isReverse(){return this._speed<0}nextEventAheadOfTime(e){return !!this.nextEvent&&(this.isReverse?this.nextEvent.time<=e:this.nextEvent.time>=e)}nextEventBehindTime(e){return !!this.nextEvent&&(e===this.track.duration?this.isReverse?this.nextEvent.time>=e:this.nextEvent.time<=e:this.isReverse?this.nextEvent.time>e:this.nextEvent.time<e)}resetEventCursor(){this._eventCursor=this.isReverse?this._track.events.length-1:0;}moveEventCursor(){this._eventCursor+=this.isReverse?-1:1,this._eventCursor>=this.track.events.length?this._eventCursor=0:this._eventCursor<0&&(this._eventCursor=this.track.events.length-1);}clipFrameTime(e){let t=ps.eventFrame;t.start=0,t.end=e,t.residual=0,this.isReverse?e<0&&(t.start=this.track.duration,t.end=0,t.residual=e+this.track.duration):e>this.track.duration&&(t.start=0,t.end=this.track.duration,t.residual=e-this.track.duration);}alignCursorToCurrentTime(){for(this.resetEventCursor();this.nextEventBehindTime(this._time)&&this._eventCursor!==this.eventCursorEnd;)this.moveEventCursor();}fireNextEvent(){this._eventHandler.fire(this.nextEvent.name,pt({track:this.track},this.nextEvent)),this.moveEventCursor();}fireNextEventInFrame(e,t){return !!(this.nextEventAheadOfTime(e)&&this.nextEventBehindTime(t))&&(this.fireNextEvent(),true)}activeEventsForFrame(e,t){let s=ps.eventFrame;this.clipFrameTime(t);let i=this.eventCursor;for(;this.fireNextEventInFrame(e,s.end)&&i!==this.eventCursor;);this.loop&&Math.abs(s.residual)>0&&this.activeEventsForFrame(s.start,s.residual);}progressForTime(e){return e*this._speed/this._track.duration}_update(e){if(this._playing){let t=this._time,s=this._track.duration,i=this._speed,n=this._loop;this._track.events.length>0&&s>0&&this.activeEventsForFrame(t,t+i*e),t+=i*e,i>=0?t>s&&(n?t=t%s||0:(t=this._track.duration,this.pause())):t<0&&(n?t=s+(t%s||0):(t=0,this.pause())),this._time=t;}this._time!==this._snapshot._time&&this._track.eval(this._time,this._snapshot);}play(){this._playing=true,this._time=0;}stop(){this._playing=false,this._time=0;}pause(){this._playing=false;}resume(){this._playing=true;}reset(){this._time=0;}constructor(e,t,s,i,n,r){this._name=e.name,this._track=e,this._snapshot=new pe(e),this._playing=i,this._time=t,this._speed=s,this._loop=n,this._blendWeight=1,this._blendOrder=0,this._eventHandler=r,this.alignCursorToCurrentTime();}}ps.eventFrame={start:0,end:0,residual:0};let pi="NONE",pn="PREV_STATE",pr="NEXT_STATE",pa="PREV_STATE_NEXT_STATE",po="NEXT_STATE_PREV_STATE",pl="GREATER_THAN",ph="LESS_THAN",pd="GREATER_THAN_EQUAL_TO",pc="LESS_THAN_EQUAL_TO",pu="EQUAL_TO",pp="NOT_EQUAL_TO",pf="INTEGER",pm="FLOAT",p_="BOOLEAN",pg="TRIGGER",pv="2D_DIRECTIONAL",py="2D_CARTESIAN",pS="DIRECT",px="START",pT=[px,"END","ANY"],pb="OVERWRITE",pE="ADDITIVE";class pA{static dot(e,t){let s=e.length,i=0;for(let n=0;n<s;++n)i+=e[n]*t[n];return i}static normalize(e){let t=pA.dot(e,e);if(t>0){t=1/Math.sqrt(t);let s=e.length;for(let i=0;i<s;++i)e[i]*=t;}}static set(e,t,s){let i=e.length;if("quaternion"===s){let s=pA.dot(t,t);s>0&&(s=1/Math.sqrt(s));for(let n=0;n<i;++n)e[n]=t[n]*s;}else for(let s=0;s<i;++s)e[s]=t[s];}static blendVec(e,t,s,i){let n=i?1:1-s,r=e.length;for(let i=0;i<r;++i)e[i]=e[i]*n+t[i]*s;}static blendQuat(e,t,s,i){let n=e.length,r=i?1:1-s;0>pA.dot(e,t)&&(s=-s);for(let i=0;i<n;++i)e[i]=e[i]*r+t[i]*s;i||pA.normalize(e);}static blend(e,t,s,i,n){"quaternion"===i?pA.blendQuat(e,t,s,n):pA.blendVec(e,t,s,n);}static stableSort(e,t){let s=e.length;for(let i=0;i<s-1;++i)for(let n=i+1;n<s;++n)if(t(e[n],e[i])){let t=e[i];e[i]=e[n],e[n]=t;}}}class pw{get _normalizeWeights(){return this._component.normalizeWeights}getWeight(e){return (this.dirty&&this.updateWeights(),this._normalizeWeights&&0===this.totalWeight||!this.mask[e])?0:this._normalizeWeights?this.weights[e]/this.totalWeight:ei.clamp(this.weights[e],0,1)}_layerBlendType(e){return this._component.layers[e].blendType}setMask(e,t){this.mask[e]=t,this._normalizeWeights&&(this._component.layers[e].blendType===pb&&(this.mask=this.mask.fill(0,0,e)),this.dirty=true);}updateWeights(){this.totalWeight=0;for(let e=0;e<this.weights.length;e++)this.weights[e]=this._component.layers[e].weight,this.totalWeight+=this.mask[e]*this.weights[e];this.dirty=false;}updateValue(e,t){if(0!==this.counter||(pA.set(this.value,pw.IDENTITY_QUAT_ARR,this.valueType),this._normalizeWeights||pA.blend(this.value,this.baseValue,1,this.valueType)),this.mask[e]&&0!==this.getWeight(e)){if(this._layerBlendType(e)!==pE||this._normalizeWeights)pA.blend(this.value,t,this.getWeight(e),this.valueType);else if(this.valueType===pw.TYPE_QUAT){let s=pw.q1.set(this.value[0],this.value[1],this.value[2],this.value[3]),i=pw.q2.set(this.baseValue[0],this.baseValue[1],this.baseValue[2],this.baseValue[3]),n=pw.q3.set(t[0],t[1],t[2],t[3]),r=i.invert().mul(n);r.slerp(eT.IDENTITY,r,this.getWeight(e)),s.mul(r),pw.quatArr[0]=s.x,pw.quatArr[1]=s.y,pw.quatArr[2]=s.z,pw.quatArr[3]=s.w,pA.set(this.value,pw.quatArr,this.valueType);}else pw.vecArr[0]=t[0]-this.baseValue[0],pw.vecArr[1]=t[1]-this.baseValue[1],pw.vecArr[2]=t[2]-this.baseValue[2],pA.blend(this.value,pw.vecArr,this.getWeight(e),this.valueType,true);this.setter&&this.setter(this.value);}}unbind(){this.setter&&this.setter(this.baseValue);}constructor(e,t){this._component=e,this.mask=new Int8Array(e.layers.length),this.weights=new Float32Array(e.layers.length),this.totalWeight=0,this.counter=0,this.layerCounter=0,this.valueType=t,this.dirty=true,this.value=t===pw.TYPE_QUAT?[0,0,0,1]:[0,0,0],this.baseValue=null,this.setter=null;}}pw.TYPE_QUAT="quaternion",pw.TYPE_VEC3="vector3",pw.q1=new eT,pw.q2=new eT,pw.q3=new eT,pw.quatArr=[0,0,0,1],pw.vecArr=[0,0,0],pw.IDENTITY_QUAT_ARR=[0,0,0,1];class pC{get clips(){return this._clips}addClip(e){let t=this._targets,s=this._binder,i=e.track.curves,n=e.snapshot,r=[],a=[];for(let e=0;e<i.length;++e){let o=i[e].paths;for(let i=0;i<o.length;++i){let l=o[i],h=s.resolve(l),d=t[h&&h.targetPath||null];if(!d&&h){d={target:h,value:[],curves:0,blendCounter:0};for(let e=0;e<d.target.components;++e)d.value.push(0);if(t[h.targetPath]=d,s.animComponent){if(!s.animComponent.targets[h.targetPath]){let e;e="localRotation"===h.targetPath.substring(h.targetPath.length-13)?pw.TYPE_QUAT:pw.TYPE_VEC3,s.animComponent.targets[h.targetPath]=new pw(s.animComponent,e);}s.animComponent.targets[h.targetPath].layerCounter++,s.animComponent.targets[h.targetPath].setMask(s.layerIndex,1);}}d&&(d.curves++,r.push(n._results[e]),a.push(d));}}this._clips.push(e),this._inputs.push(r),this._outputs.push(a);}removeClip(e){let t=this._targets,s=this._binder,i=this._clips,n=i[e].track.curves;for(let e=0;e<n.length;++e){let i=n[e].paths;for(let e=0;e<i.length;++e){let n=i[e],r=this._binder.resolve(n);r&&(r.curves--,0===r.curves&&(s.unresolve(n),delete t[r.targetPath],s.animComponent&&s.animComponent.targets[r.targetPath].layerCounter--));}}i.splice(e,1),this._inputs.splice(e,1),this._outputs.splice(e,1);}removeClips(){for(;this._clips.length>0;)this.removeClip(0);}updateClipTrack(e,t){this._clips.forEach(s=>{s.name.includes(e)&&(s.track=t);}),this.rebind();}findClip(e){let t=this._clips;for(let s=0;s<t.length;++s){let i=t[s];if(i.name===e)return i}return null}rebind(){this._binder.rebind(),this._targets={};let e=[...this.clips];this.removeClips(),e.forEach(e=>{this.addClip(e);});}assignMask(e){return this._binder.assignMask(e)}update(e,t){ void 0===t&&(t=true);let s=this._clips,i=s.map((e,t)=>t);pA.stableSort(i,(e,t)=>s[e].blendOrder<s[t].blendOrder);for(let n=0;n<i.length;++n){let r,a,o;let l=i[n],h=s[l],d=this._inputs[l],c=this._outputs[l],u=h.blendWeight;if(u>0&&h._update(e),!t)break;if(u>=1)for(let e=0;e<d.length;++e)r=d[e],o=(a=c[e]).value,pA.set(o,r,a.target.type),a.blendCounter++;else if(u>0)for(let e=0;e<d.length;++e)r=d[e],o=(a=c[e]).value,0===a.blendCounter?pA.set(o,r,a.target.type):pA.blend(o,r,u,a.target.type),a.blendCounter++;}let n=this._targets,r=this._binder;for(let e in n)if(n.hasOwnProperty(e)){let t=n[e];if(r.animComponent&&t.target.isTransform){let s=r.animComponent.targets[e];s.counter===s.layerCounter&&(s.counter=0),s.path||(s.path=e,s.baseValue=t.target.get(),s.setter=t.target.set),s.updateValue(r.layerIndex,t.value),s.counter++;}else t.target.set(t.value);t.blendCounter=0;}this._binder.update(e);}constructor(e){this._binder=e,this._clips=[],this._inputs=[],this._outputs=[],this._targets={};}}class pP{get events(){return this._events}constructor(e){this._events=[...e],this._events.sort((e,t)=>e.time-t.time);}}class pM{get name(){return this._name}get duration(){return this._duration}get inputs(){return this._inputs}get outputs(){return this._outputs}get curves(){return this._curves}set events(e){this._animEvents=e;}get events(){return this._animEvents.events}eval(e,t){t._time=e;let s=this._inputs,i=this._outputs,n=this._curves,r=t._cache,a=t._results;for(let t=0;t<s.length;++t)r[t].update(e,s[t]._data);for(let e=0;e<n.length;++e){let t=n[e],s=i[t._output],o=a[e];r[t._input].eval(o,t._interpolation,s);}}constructor(e,t,s,i,n,r=new pP([])){this._name=e,this._duration=t,this._inputs=s,this._outputs=i,this._curves=n,this._animEvents=r;}}pM.EMPTY=Object.freeze(new pM("empty",Number.MAX_VALUE,[],[],[]));class pI{static joinPath(e,t){return t=t||".",e.map(function(e){return e.replace(/\\/g,"\\\\").replace(RegExp("\\"+t,"g"),"\\"+t)}).join(t)}static splitPath(e,t){t=t||".";let s=[],i="",n=0;for(;n<e.length;){let r=e[n++];"\\"===r&&n<e.length?"\\"===(r=e[n++])||r===t?i+=r:i+="\\"+r:r===t?(s.push(i),i=""):i+=r;}return i.length>0&&s.push(i),s}static encode(e,t,s){return (Array.isArray(e)?e.join("/"):e)+"/"+t+"/"+(Array.isArray(s)?s.join("/"):s)}resolve(e){return null}unresolve(e){}update(e){}}class pR{get set(){return this._set}get get(){return this._get}get type(){return this._type}get components(){return this._components}get targetPath(){return this._targetPath}get isTransform(){return this._isTransform}constructor(e,t,s,i){e.set?(this._set=e.set,this._get=e.get):this._set=e,this._type=t,this._components=s,this._targetPath=i,this._isTransform="localRotation"===this._targetPath.substring(this._targetPath.length-13)||"localPosition"===this._targetPath.substring(this._targetPath.length-13)||"localScale"===this._targetPath.substring(this._targetPath.length-10);}}class pL{_isPathActive(e){if(!this._mask)return  true;let t=[e.entityPath[0],this.graph.name];for(let s=0;s<t.length;++s){let i=t[s];if(this._isPathInMask(i,1===e.entityPath.length))return  true;for(let t=1;t<e.entityPath.length;t++)if(i+="/"+e.entityPath[t],this._isPathInMask(i,t===e.entityPath.length-1))return  true}return  false}findNode(e){let t;return this._isPathActive(e)?(!this.graph||(t=this.graph.findByPath(e.entityPath))||(t=this.graph.findByPath(e.entityPath.slice(1))),t||(t=this.nodes[e.entityPath[e.entityPath.length-1]||""]),t):null}static createAnimTarget(e,t,s,i,n,r){return new pR(e,t,s,pI.encode(i.path,r||"entity",n))}resolve(e){let t=pI.encode(e.entityPath,e.component,e.propertyPath),s=this.targetCache[t];if(s)return s;let i=this.findNode(e);if(!i)return null;let n=this.handlers[e.propertyPath];return n&&(s=n(i))?(this.targetCache[t]=s,this.nodeCounts[i.path]?this.nodeCounts[i.path]++:(this.activeNodes.push(i),this.nodeCounts[i.path]=1),s):null}unresolve(e){if("graph"!==e.component)return;let t=this.nodes[e.entityPath[e.entityPath.length-1]||""];if(this.nodeCounts[t.path]--,0===this.nodeCounts[t.path]){let e=this.activeNodes,s=e.indexOf(t.node),i=e.length;s<i-1&&(e[s]=e[i-1]),e.pop();}}update(e){let t=this.activeNodes;for(let e=0;e<t.length;++e)t[e]._dirtifyLocal();}assignMask(e){return e!==this._mask&&(this._mask=e,true)}constructor(e){if(this._isPathInMask=(e,t)=>{let s=this._mask[e];return !!s&&(!!s.children||!!t&&false!==s.value)},this.graph=e,!e)return;this._mask=null;let t={},s=function(e){t[e.name]=e;for(let t=0;t<e.children.length;++t)s(e.children[t]);};s(e),this.nodes=t,this.targetCache={};let i=function(e){let t,s=e;for(;s&&!(s instanceof uG);)s=s.parent;return s&&(s.render?t=s.render.meshInstances:s.model&&(t=s.model.meshInstances)),t};this.nodeCounts={},this.activeNodes=[],this.handlers={localPosition:function(e){let t=e.localPosition;return pL.createAnimTarget(function(e){t.set(...e);},"vector",3,e,"localPosition")},localRotation:function(e){let t=e.localRotation;return pL.createAnimTarget(function(e){t.set(...e);},"quaternion",4,e,"localRotation")},localScale:function(e){let t=e.localScale;return pL.createAnimTarget(function(e){t.set(...e);},"vector",3,e,"localScale")},weight:function(e,t){let s;t=0===t.indexOf("name.")?t.replace("name.",""):Number(t);let n=i(e);if(n){for(let i=0;i<n.length;++i)if(n[i].node.name===e.name&&n[i].morphInstance){let e=n[i].morphInstance,r=s=>{e.setWeight(t,s[0]);};s||(s=[]),s.push(r);}}return s?pL.createAnimTarget(e=>{for(let t=0;t<s.length;++t)s[t](e);},"number",1,e,"weight."+t):null},materialTexture:(e,t)=>{let s=i(e);if(s){let i;for(let t=0;t<s.length;++t)if(s[t].node.name===e.name){i=s[t];break}if(i)return pL.createAnimTarget(e=>{let s=this.animComponent.system.app.assets.get(e[0]);s&&s.resource&&"texture"===s.type&&(i.material[t]=s.resource,i.material.update());},"vector",1,e,"materialTexture","material")}return null}};}}class pD extends u8{set animations(e){this._animations=e,this.onSetAnimations();}get animations(){return this._animations}set assets(e){let t=this._assets;if(t&&t.length){for(let e=0;e<t.length;e++)if(t[e]){let s=this.system.app.assets.get(t[e]);if(s){s.off("change",this.onAssetChanged,this),s.off("remove",this.onAssetRemoved,this);let e=this.animationsIndex[s.id];this.currAnim===e&&this._stopCurrentAnimation(),delete this.animations[e],delete this.animationsIndex[s.id];}}}this._assets=e;let s=e.map(e=>e instanceof ub?e.id:e);this.loadAnimationAssets(s);}get assets(){return this._assets}set currentTime(e){if(this.skeleton&&(this.skeleton.currentTime=e,this.skeleton.addTime(0),this.skeleton.updateGraph()),this.animEvaluator){let t=this.animEvaluator.clips;for(let s=0;s<t.length;++s)t[s].time=e;}}get currentTime(){if(this.skeleton)return this.skeleton._time;if(this.animEvaluator){let e=this.animEvaluator.clips;if(e.length>0)return e[e.length-1].time}return 0}get duration(){return this.currAnim?this.animations[this.currAnim].duration:0}set loop(e){if(this._loop=e,this.skeleton&&(this.skeleton.looping=e),this.animEvaluator)for(let t=0;t<this.animEvaluator.clips.length;++t)this.animEvaluator.clips[t].loop=e;}get loop(){return this._loop}play(e,t){if(void 0===t&&(t=0),this.enabled&&this.entity.enabled&&this.animations[e]){if(this.prevAnim=this.currAnim,this.currAnim=e,this.model){this.skeleton||this.animEvaluator||this._createAnimationController();let e=this.animations[this.prevAnim],s=this.animations[this.currAnim];if(this.blending=t>0&&!!this.prevAnim,this.blending&&(this.blend=0,this.blendSpeed=1/t),this.skeleton&&(this.blending?(this.fromSkel.animation=e,this.fromSkel.addTime(this.skeleton._time),this.toSkel.animation=s):this.skeleton.animation=s),this.animEvaluator){let e=this.animEvaluator;if(this.blending)for(;e.clips.length>1;)e.removeClip(0);else this.animEvaluator.removeClips();let t=new ps(this.animations[this.currAnim],0,1,true,this.loop);t.name=this.currAnim,t.blendWeight=+!this.blending,t.reset(),this.animEvaluator.addClip(t);}}this.playing=true;}}getAnimation(e){return this.animations[e]}setModel(e){e!==this.model&&(this._resetAnimationController(),this.model=e,this.animations&&this.currAnim&&this.animations[this.currAnim]&&this.play(this.currAnim));}onSetAnimations(){let e=this.entity.model;if(e){let t=e.model;t&&t!==this.model&&this.setModel(t);}if(!this.currAnim&&this.activate&&this.enabled&&this.entity.enabled){let e=Object.keys(this._animations);e.length>0&&this.play(e[0]);}}_resetAnimationController(){this.skeleton=null,this.fromSkel=null,this.toSkel=null,this.animEvaluator=null;}_createAnimationController(){let e=this.model,t=this.animations,s=false,i=false;for(let e in t)t.hasOwnProperty(e)&&(t[e].constructor===pM?i=true:s=true);let n=e.getGraph();s?(this.fromSkel=new d5(n),this.toSkel=new d5(n),this.skeleton=new d5(n),this.skeleton.looping=this.loop,this.skeleton.setGraph(n)):i&&(this.animEvaluator=new pC(new pL(this.entity)));}loadAnimationAssets(e){if(!e||!e.length)return;let t=this.system.app.assets,s=e=>{if(e.resources.length>1)for(let t=0;t<e.resources.length;t++)this.animations[e.resources[t].name]=e.resources[t],this.animationsIndex[e.id]=e.resources[t].name;else this.animations[e.name]=e.resource,this.animationsIndex[e.id]=e.name;this.animations=this.animations;},i=e=>{e.off("change",this.onAssetChanged,this),e.on("change",this.onAssetChanged,this),e.off("remove",this.onAssetRemoved,this),e.on("remove",this.onAssetRemoved,this),e.resource?s(e):(e.once("load",s,this),this.enabled&&this.entity.enabled&&t.load(e));};for(let s=0,n=e.length;s<n;s++){let n=t.get(e[s]);n?i(n):t.on("add:"+e[s],i);}}onAssetChanged(e,t,s,i){if("resource"===t||"resources"===t){if("resources"===t&&s&&0===s.length&&(s=null),s){let t=false;if(s.length>1){if(i&&i.length>1)for(let e=0;e<i.length;e++)delete this.animations[i[e].name];else delete this.animations[e.name];t=false;for(let e=0;e<s.length;e++)this.animations[s[e].name]=s[e],!t&&this.currAnim===s[e].name&&this.playing&&this.enabled&&this.entity.enabled&&(t=true,this.play(s[e].name));t||(this._stopCurrentAnimation(),this.onSetAnimations());}else {if(i&&i.length>1)for(let e=0;e<i.length;e++)delete this.animations[i[e].name];this.animations[e.name]=s[0]||s,t=false,this.currAnim===e.name&&this.playing&&this.enabled&&this.entity.enabled&&(t=true,this.play(e.name)),t||(this._stopCurrentAnimation(),this.onSetAnimations());}this.animationsIndex[e.id]=e.name;}else {if(i.length>1)for(let e=0;e<i.length;e++)delete this.animations[i[e].name],this.currAnim===i[e].name&&this._stopCurrentAnimation();else delete this.animations[e.name],this.currAnim===e.name&&this._stopCurrentAnimation();delete this.animationsIndex[e.id];}}}onAssetRemoved(e){if(e.off("remove",this.onAssetRemoved,this),this.animations){if(e.resources.length>1)for(let t=0;t<e.resources.length;t++)delete this.animations[e.resources[t].name],this.currAnim===e.resources[t].name&&this._stopCurrentAnimation();else delete this.animations[e.name],this.currAnim===e.name&&this._stopCurrentAnimation();delete this.animationsIndex[e.id];}}_stopCurrentAnimation(){if(this.currAnim=null,this.playing=false,this.skeleton&&(this.skeleton.currentTime=0,this.skeleton.animation=null),this.animEvaluator){for(let e=0;e<this.animEvaluator.clips.length;++e)this.animEvaluator.clips[e].stop();this.animEvaluator.update(0),this.animEvaluator.removeClips();}}onEnable(){super.onEnable();let e=this.assets,t=this.system.app.assets;if(e)for(let s=0,i=e.length;s<i;s++){let i=e[s];i instanceof ub||(i=t.get(i)),i&&!i.resource&&t.load(i);}if(this.activate&&!this.currAnim){let e=Object.keys(this.animations);e.length>0&&this.play(e[0]);}}onBeforeRemove(){for(let e=0;e<this.assets.length;e++){let t=this.assets[e];"number"==typeof t&&(t=this.system.app.assets.get(t)),t&&(t.off("change",this.onAssetChanged,this),t.off("remove",this.onAssetRemoved,this));}this.skeleton=null,this.fromSkel=null,this.toSkel=null,this.animEvaluator=null;}update(e){if(this.blending&&(this.blend+=e*this.blendSpeed,this.blend>=1&&(this.blend=1)),this.playing){let t=this.skeleton;if(null!==t&&null!==this.model){if(this.blending)t.blend(this.fromSkel,this.toSkel,this.blend);else {let s=e*this.speed;t.addTime(s),this.speed>0&&t._time===t.animation.duration&&!this.loop?this.playing=false:this.speed<0&&0===t._time&&!this.loop&&(this.playing=false);}this.blending&&1===this.blend&&(t.animation=this.toSkel.animation),t.updateGraph();}}let t=this.animEvaluator;if(t){for(let e=0;e<t.clips.length;++e){let s=t.clips[e];s.speed=this.speed,this.playing?s.resume():s.pause();}this.blending&&t.clips.length>1&&(t.clips[1].blendWeight=this.blend),t.update(e);}this.blending&&1===this.blend&&(this.blending=false);}constructor(...e){super(...e),this._animations={},this._assets=[],this._loop=true,this.animEvaluator=null,this.model=null,this.skeleton=null,this.fromSkel=null,this.toSkel=null,this.animationsIndex={},this.prevAnim=null,this.currAnim=null,this.blend=0,this.blending=false,this.blendSpeed=0,this.activate=true,this.speed=1;}}class pO{constructor(){this.enabled=true;}}let pF=["enabled"];class pN extends u9{initializeComponentData(e,t,s){for(let s of ["activate","enabled","loop","speed","assets"])t.hasOwnProperty(s)&&(e[s]=t[s]);super.initializeComponentData(e,t,pF);}cloneComponent(e,t){this.addComponent(t,{}),t.animation.assets=e.animation.assets.slice(),t.animation.speed=e.animation.speed,t.animation.loop=e.animation.loop,t.animation.activate=e.animation.activate,t.animation.enabled=e.animation.enabled;let s={},i=e.animation.animations;for(let e in i)i.hasOwnProperty(e)&&(s[e]=i[e]);t.animation.animations=s;let n={},r=e.animation.animationsIndex;for(let e in r)r.hasOwnProperty(e)&&(n[e]=r[e]);return t.animation.animationsIndex=n,t.animation}onBeforeRemove(e,t){t.onBeforeRemove();}onUpdate(e){let t=this.store;for(let s in t)if(t.hasOwnProperty(s)){let i=t[s];i.data.enabled&&i.entity.enabled&&i.entity.animation.update(e);}}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this);}constructor(e){super(e),this.id="animation",this.ComponentType=pD,this.DataType=pO,this.schema=pF,this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("update",this.onUpdate,this);}}u8._buildAccessors(pD.prototype,pF);class pB{get parent(){return this._parent}get name(){return this._name}get path(){return this._parent?this._parent.path+"."+this._name:this._name}get point(){return this._point}get pointLength(){return this._pointLength}set weight(e){this._weight=e;}get weight(){return this._parent?this._parent.weight*this._weight:this._weight}get normalizedWeight(){let e=this._state.totalWeight;return 0===e?0:this.weight/e}get speed(){return this._weightedSpeed*this._speed}get absoluteSpeed(){return Math.abs(this._speed)}set weightedSpeed(e){this._weightedSpeed=e;}get weightedSpeed(){return this._weightedSpeed}set animTrack(e){this._animTrack=e;}get animTrack(){return this._animTrack}constructor(e,t,s,i,n=1){this._state=e,this._parent=t,this._name=s,Array.isArray(i)?(this._point=new ef(i[0],i[1]),this._pointLength=this._point.length()):(this._point=i,this._pointLength=i),this._speed=n,this._weightedSpeed=1,this._weight=1,this._animTrack=null;}}class pU extends pB{get weight(){return this.calculateWeights(),this._parent?this._parent.weight*this._weight:this._weight}get syncAnimations(){return this._syncAnimations}getChild(e){for(let t=0;t<this._children.length;t++)if(this._children[t].name===e)return this._children[t];return null}updateParameterValues(){let e=true;for(let t=0;t<this._parameterValues.length;t++){let s=this._findParameter(this._parameters[t]).value;this._parameterValues[t]!==s&&(this._parameterValues[t]=s,e=false);}return e}getNodeWeightedDuration(e){return this._children[e].animTrack.duration/this._children[e].speedMultiplier*this._children[e].weight}getNodeCount(){let e=0;for(let t=0;t<this._children.length;t++)this._children[t].constructor===pU?e+=this._children[t].getNodeCount():e++;return e}constructor(e,t,s,i,n,r,a,o,l){super(e,t,s,i),this._parameters=n,this._parameterValues=Array(n.length),this._children=[],this._findParameter=l,this._syncAnimations=false!==a,this._pointCache={};for(let t=0;t<r.length;t++){let s=r[t];s.children?this._children.push(o(s.type,e,this,s.name,1,s.parameter?[s.parameter]:s.parameters,s.children,s.syncAnimations,o,l)):this._children.push(new pB(e,this,s.name,s.point,s.speed));}}}class pk extends pU{calculateWeights(){if(this.updateParameterValues())return;let e=0;this._children[0].weight=0;for(let t=0;t<this._children.length;t++){let s=this._children[t];if(t!==this._children.length-1){let e=this._children[t+1];if(s.point===e.point)s.weight=.5,e.weight=.5;else if(ei.between(this._parameterValues[0],s.point,e.point,true)){let t=Math.abs(s.point-e.point),i=(t-Math.abs(s.point-this._parameterValues[0]))/t;s.weight=i,e.weight=1-i;}else e.weight=0;}this._syncAnimations&&(e+=s.animTrack.duration/s.absoluteSpeed*s.weight);}if(this._syncAnimations)for(let t=0;t<this._children.length;t++){let s=this._children[t];s.weightedSpeed=s.animTrack.duration/s.absoluteSpeed/e;}}constructor(e,t,s,i,n,r,a,o,l){r.sort((e,t)=>e.point-t.point),super(e,t,s,i,n,r,a,o,l);}}class pz extends pU{pointDistanceCache(e,t){let s=""+e+t;return this._pointCache[s]||(this._pointCache[s]=this._children[t].point.clone().sub(this._children[e].point)),this._pointCache[s]}calculateWeights(){let e,t;if(!this.updateParameterValues()){pz._p.set(...this._parameterValues),e=0,t=0;for(let s=0;s<this._children.length;s++){let i=this._children[s],n=i.point;pz._pip.set(pz._p.x,pz._p.y).sub(n);let r=Number.MAX_VALUE;for(let e=0;e<this._children.length;e++){if(s===e)continue;let t=this.pointDistanceCache(s,e),i=ei.clamp(1-pz._pip.dot(t)/t.lengthSq(),0,1);i<r&&(r=i);}i.weight=r,e+=r,this._syncAnimations&&(t+=i.animTrack.duration/i.absoluteSpeed*i.weight);}for(let s=0;s<this._children.length;s++){let i=this._children[s];i.weight=i._weight/e,this._syncAnimations&&(i.weightedSpeed=i.animTrack.duration/i.absoluteSpeed/t);}}}}pz._p=new ef,pz._pip=new ef;class pV extends pU{pointCache(e,t){let s=""+e+t;return this._pointCache[s]||(this._pointCache[s]=new ef((this._children[t].pointLength-this._children[e].pointLength)/((this._children[t].pointLength+this._children[e].pointLength)/2),2*ef.angleRad(this._children[e].point,this._children[t].point))),this._pointCache[s]}calculateWeights(){let e,t;if(this.updateParameterValues())return;pV._p.set(...this._parameterValues);let s=pV._p.length();e=0,t=0;for(let i=0;i<this._children.length;i++){let n=this._children[i],r=n.point,a=n.pointLength,o=Number.MAX_VALUE;for(let e=0;e<this._children.length;e++){if(i===e)continue;let t=this.pointCache(i,e),n=this._children[e].pointLength;pV._pip.set((s-a)/((n+a)/2),2*ef.angleRad(r,pV._p));let l=ei.clamp(1-Math.abs(pV._pip.dot(t)/t.lengthSq()),0,1);l<o&&(o=l);}n.weight=o,e+=o,this._syncAnimations&&(t+=n.animTrack.duration/n.absoluteSpeed*n.weight);}for(let s=0;s<this._children.length;s++){let i=this._children[s];if(i.weight=i._weight/e,this._syncAnimations){let s=i.animTrack.duration/t*e;i.weightedSpeed=i.absoluteSpeed*s;}}}}pV._p=new ef,pV._pip=new ef;class pG extends pU{calculateWeights(){if(this.updateParameterValues())return;let e=0,t=0;for(let s=0;s<this._children.length;s++)if(e+=Math.max(this._parameterValues[s],0),this._syncAnimations){let e=this._children[s];t+=e.animTrack.duration/e.absoluteSpeed*e.weight;}for(let s=0;s<this._children.length;s++){let i=this._children[s],n=Math.max(this._parameterValues[s],0);e?(i.weight=n/e,this._syncAnimations&&(i.weightedSpeed=i.animTrack.duration/i.absoluteSpeed/t)):(i.weight=0,this._syncAnimations&&(i.weightedSpeed=0));}}}class pH{_createTree(e,t,s,i,n,r,a,o,l,h){switch(e){case "1D":return new pk(t,s,i,n,r,a,o,l,h);case py:return new pz(t,s,i,n,r,a,o,l,h);case pv:return new pV(t,s,i,n,r,a,o,l,h);case pS:return new pG(t,s,i,n,r,a,o,l,h)}}_getNodeFromPath(e){let t=this._blendTree;for(let s=1;s<e.length;s++)t=t.getChild(e[s]);return t}addAnimation(e,t){let s=e.join("."),i=this._animationList.findIndex(e=>e.path===s);if(i>=0)this._animationList[i].animTrack=t;else {let s=this._getNodeFromPath(e);s.animTrack=t,this._animationList.push(s);}this._updateHasAnimations();}_updateHasAnimations(){this._hasAnimations=this._animationList.length>0&&this._animationList.every(e=>e.animTrack&&e.animTrack!==pM.EMPTY);}get name(){return this._name}set animations(e){this._animationList=e,this._updateHasAnimations();}get animations(){return this._animationList}get hasAnimations(){return this._hasAnimations}set speed(e){this._speed=e;}get speed(){return this._speed}set loop(e){this._loop=e;}get loop(){return this._loop}get nodeCount(){return this._blendTree&&this._blendTree.constructor!==pB?this._blendTree.getNodeCount():1}get playable(){return -1!==pT.indexOf(this.name)||this.animations.length===this.nodeCount}get looping(){if(this.animations.length>0){let e=this.name+"."+this.animations[0].animTrack.name,t=this._controller.animEvaluator.findClip(e);if(t)return t.loop}return  false}get totalWeight(){let e=0;for(let t=0;t<this.animations.length;t++)e+=this.animations[t].weight;return e}get timelineDuration(){let e=0;for(let t=0;t<this.animations.length;t++){let s=this.animations[t];s.animTrack.duration>e&&(e=s.animTrack.duration);}return e}constructor(e,t,s=1,i=true,n){this._animations={},this._animationList=[],this._controller=e,this._name=t,this._speed=s,this._loop=i,this._hasAnimations=false,n?this._blendTree=this._createTree(n.type,this,null,t,1,n.parameter?[n.parameter]:n.parameters,n.children,n.syncAnimations,this._createTree,this._controller.findParameter):this._blendTree=new pB(this,null,t,1,s);}}class pW{get from(){return this._from}set to(e){this._to=e;}get to(){return this._to}get time(){return this._time}get priority(){return this._priority}get conditions(){return this._conditions}get exitTime(){return this._exitTime}get transitionOffset(){return this._transitionOffset}get interruptionSource(){return this._interruptionSource}get hasExitTime(){return !!this.exitTime}constructor({from:e,to:t,time:s=0,priority:i=0,conditions:n=[],exitTime:r=null,transitionOffset:a=null,interruptionSource:o=pi}){this._from=e,this._to=t,this._time=s,this._priority=i,this._conditions=n,this._exitTime=r,this._transitionOffset=a,this._interruptionSource=o;}}function pX(){return (pX=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i]);}return e}).apply(this,arguments)}class pY{get animEvaluator(){return this._animEvaluator}set activeState(e){this._activeStateName=e;}get activeState(){return this._findState(this._activeStateName)}get activeStateName(){return this._activeStateName}get activeStateAnimations(){return this.activeState.animations}set previousState(e){this._previousStateName=e;}get previousState(){return this._findState(this._previousStateName)}get previousStateName(){return this._previousStateName}get playable(){let e=true;for(let t=0;t<this._stateNames.length;t++)this._states[this._stateNames[t]].playable||(e=false);return e}set playing(e){this._playing=e;}get playing(){return this._playing}get activeStateProgress(){return this._getActiveStateProgressForTime(this._timeInState)}get activeStateDuration(){if(this._activeStateDurationDirty){let e=0;for(let t=0;t<this.activeStateAnimations.length;t++){let s=this._animEvaluator.findClip(this.activeStateAnimations[t].name);s&&(e=Math.max(e,s.track.duration));}this._activeStateDuration=e,this._activeStateDurationDirty=false;}return this._activeStateDuration}set activeStateCurrentTime(e){this._timeInStateBefore=e,this._timeInState=e;for(let t=0;t<this.activeStateAnimations.length;t++){let s=this.animEvaluator.findClip(this.activeStateAnimations[t].name);s&&(s.time=e);}}get activeStateCurrentTime(){return this._timeInState}get transitioning(){return this._isTransitioning}get transitionProgress(){return this._currTransitionTime/this._totalTransitionTime}get states(){return this._stateNames}assignMask(e){return this._animEvaluator.assignMask(e)}_findState(e){return this._states[e]}_getActiveStateProgressForTime(e){if(this.activeStateName===px||"END"===this.activeStateName||"ANY"===this.activeStateName)return 1;let t=this._animEvaluator.findClip(this.activeStateAnimations[0].name);return t?t.progressForTime(e):null}_findTransitionsFromState(e){let t=this._findTransitionsFromStateCache[e];return t||(l4(t=this._transitions.filter(t=>t.from===e)),this._findTransitionsFromStateCache[e]=t),t}_findTransitionsBetweenStates(e,t){let s=this._findTransitionsBetweenStatesCache[e+"->"+t];return s||(l4(s=this._transitions.filter(s=>s.from===e&&s.to===t)),this._findTransitionsBetweenStatesCache[e+"->"+t]=s),s}_transitionHasConditionsMet(e){let t=e.conditions;for(let e=0;e<t.length;e++){let s=t[e],i=this._findParameter(s.parameterName);switch(s.predicate){case pl:if(!(i.value>s.value))return  false;break;case ph:if(!(i.value<s.value))return  false;break;case pd:if(!(i.value>=s.value))return  false;break;case pc:if(!(i.value<=s.value))return  false;break;case pu:if(i.value!==s.value)return  false;break;case pp:if(i.value===s.value)return  false}}return  true}_findTransition(e,t){let s=[];if(e&&t)s=s.concat(this._findTransitionsBetweenStates(e,t));else if(this._isTransitioning)switch(this._transitionInterruptionSource){case pn:s=(s=s.concat(this._findTransitionsFromState(this._previousStateName))).concat(this._findTransitionsFromState("ANY"));break;case pr:s=(s=s.concat(this._findTransitionsFromState(this._activeStateName))).concat(this._findTransitionsFromState("ANY"));break;case pa:s=(s=(s=s.concat(this._findTransitionsFromState(this._previousStateName))).concat(this._findTransitionsFromState(this._activeStateName))).concat(this._findTransitionsFromState("ANY"));break;case po:s=(s=(s=s.concat(this._findTransitionsFromState(this._activeStateName))).concat(this._findTransitionsFromState(this._previousStateName))).concat(this._findTransitionsFromState("ANY"));}else s=(s=s.concat(this._findTransitionsFromState(this._activeStateName))).concat(this._findTransitionsFromState("ANY"));if((s=s.filter(e=>{if(e.to===this.activeStateName)return  false;if(e.hasExitTime){let t=this._getActiveStateProgressForTime(this._timeInStateBefore),s=this._getActiveStateProgressForTime(this._timeInState);if(e.exitTime<1&&this.activeState.loop&&(t-=Math.floor(t),s-=Math.floor(s)),s===t){if(s!==e.exitTime)return null}else if(!(e.exitTime>t&&e.exitTime<=s))return null}return this._transitionHasConditionsMet(e)})).length>0){let e=s[0];return "END"===e.to&&(e.to=this._findTransitionsFromState(px)[0].to),e}return null}updateStateFromTransition(e){let t,s,i;this.previousState=e.from?this.activeStateName:null,this.activeState=e.to,this._activeStateDurationDirty=true;for(let t=0;t<e.conditions.length;t++){let s=e.conditions[t];this._findParameter(s.parameterName).type===pg&&this._consumeTrigger(s.parameterName);}if(this.previousState){this._isTransitioning||(this._transitionPreviousStates=[]),this._transitionPreviousStates.push({name:this._previousStateName,weight:1});let e=Math.min(0!==this._totalTransitionTime?this._currTransitionTime/this._totalTransitionTime:1,1);for(let n=0;n<this._transitionPreviousStates.length;n++){this._isTransitioning?n!==this._transitionPreviousStates.length-1?this._transitionPreviousStates[n].weight*=1-e:this._transitionPreviousStates[n].weight=e:this._transitionPreviousStates[n].weight=1,t=this._findState(this._transitionPreviousStates[n].name);for(let e=0;e<t.animations.length;e++)s=t.animations[e],(i=this._animEvaluator.findClip(s.name+".previous."+n))||((i=this._animEvaluator.findClip(s.name)).name=s.name+".previous."+n),n!==this._transitionPreviousStates.length-1&&i.pause();}}this._isTransitioning=true,this._totalTransitionTime=e.time,this._currTransitionTime=0,this._transitionInterruptionSource=e.interruptionSource;let n=this.activeState,r=e.transitionOffset&&e.transitionOffset>0&&e.transitionOffset<1,a=0,o=0;if(r){let t=n.timelineDuration*e.transitionOffset;a=t,o=t;}this._timeInState=a,this._timeInStateBefore=o;for(let t=0;t<n.animations.length;t++){if(i=this._animEvaluator.findClip(n.animations[t].name))i.reset();else {let e=Number.isFinite(n.animations[t].speed)?n.animations[t].speed:n.speed;(i=new ps(n.animations[t].animTrack,this._timeInState,e,true,n.loop,this._eventHandler)).name=n.animations[t].name,this._animEvaluator.addClip(i);}if(e.time>0?i.blendWeight=0:i.blendWeight=n.animations[t].normalizedWeight,i.play(),r)i.time=n.timelineDuration*e.transitionOffset;else {let e=n.speed>=0?0:this.activeStateDuration;i.time=e;}}}_transitionToState(e){if(!this._findState(e))return;let t=this._findTransition(this._activeStateName,e);t||(this._animEvaluator.removeClips(),t=new pW({from:null,to:e})),this.updateStateFromTransition(t);}assignAnimation(e,t,s,i){let n=e.split("."),r=this._findState(n[0]);r||(r=new pH(this,n[0],s),this._states[n[0]]=r,this._stateNames.push(n[0])),r.addAnimation(n,t),this._animEvaluator.updateClipTrack(r.name,t),void 0!==s&&(r.speed=s),void 0!==i&&(r.loop=i),!this._playing&&this._activate&&this.playable&&this.play(),this._activeStateDurationDirty=true;}removeNodeAnimations(e){if(-1!==pT.indexOf(e))return  false;let t=this._findState(e);return !!t&&(t.animations=[],true)}play(e){e&&this._transitionToState(e),this._playing=true;}pause(){this._playing=false;}reset(){this._previousStateName=null,this._activeStateName=px,this._playing=false,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=false,this._timeInState=0,this._timeInStateBefore=0,this._animEvaluator.removeClips();}rebind(){this._animEvaluator.rebind();}update(e){let t,s,i;if(!this._playing)return;(this.activeState.loop||this._timeInState<this.activeStateDuration)&&(this._timeInStateBefore=this._timeInState,this._timeInState+=e*this.activeState.speed,!this.activeState.loop&&this._timeInState>this.activeStateDuration&&(this._timeInState=this.activeStateDuration,e=this.activeStateDuration-this._timeInStateBefore));let n=this._findTransition(this._activeStateName);if(n&&this.updateStateFromTransition(n),this._isTransitioning){if(this._currTransitionTime+=e,this._currTransitionTime<=this._totalTransitionTime){let e=0!==this._totalTransitionTime?this._currTransitionTime/this._totalTransitionTime:1;for(let n=0;n<this._transitionPreviousStates.length;n++){t=this._findState(this._transitionPreviousStates[n].name);let r=this._transitionPreviousStates[n].weight;for(let a=0;a<t.animations.length;a++)s=t.animations[a],(i=this._animEvaluator.findClip(s.name+".previous."+n))&&(i.blendWeight=(1-e)*s.normalizedWeight*r);}t=this.activeState;for(let i=0;i<t.animations.length;i++)s=t.animations[i],this._animEvaluator.findClip(s.name).blendWeight=e*s.normalizedWeight;}else {this._isTransitioning=false;let e=this.activeStateAnimations.length,n=this._animEvaluator.clips.length;for(let t=0;t<n-e;t++)this._animEvaluator.removeClip(0);this._transitionPreviousStates=[],t=this.activeState;for(let e=0;e<t.animations.length;e++)s=t.animations[e],(i=this._animEvaluator.findClip(s.name))&&(i.blendWeight=s.normalizedWeight);}}else if(this.activeState._blendTree.constructor!==pB){t=this.activeState;for(let e=0;e<t.animations.length;e++)s=t.animations[e],(i=this._animEvaluator.findClip(s.name))&&(i.blendWeight=s.normalizedWeight,s.parent.syncAnimations&&(i.speed=s.speed));}this._animEvaluator.update(e,this.activeState.hasAnimations);}constructor(e,t,s,i,n,r,a){this._states={},this._stateNames=[],this._findTransitionsFromStateCache={},this._findTransitionsBetweenStatesCache={},this._previousStateName=null,this._activeStateName=px,this._activeStateDuration=0,this._activeStateDurationDirty=true,this._playing=false,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=false,this._transitionInterruptionSource=pi,this._transitionPreviousStates=[],this._timeInState=0,this._timeInStateBefore=0,this.findParameter=e=>this._findParameter(e),this._animEvaluator=e,this._eventHandler=n,this._findParameter=r,this._consumeTrigger=a;for(let e=0;e<t.length;e++)this._states[t[e].name]=new pH(this,t[e].name,t[e].speed,t[e].loop,t[e].blendTree),this._stateNames.push(t[e].name);this._transitions=s.map(e=>new pW(pX({},e))),this._activate=i;}}let pj=new ef,pq=new eu,pK=new em,pZ=new en,pQ=new eT;class pJ extends pL{static _packFloat(e){return e[0]}static _packBoolean(e){return !!e[0]}static _packVec2(e){return pj.x=e[0],pj.y=e[1],pj}static _packVec3(e){return pq.x=e[0],pq.y=e[1],pq.z=e[2],pq}static _packVec4(e){return pK.x=e[0],pK.y=e[1],pK.z=e[2],pK.w=e[3],pK}static _packColor(e){return pZ.r=e[0],pZ.g=e[1],pZ.b=e[2],pZ.a=e[3],pZ}static _packQuat(e){return pQ.x=e[0],pQ.y=e[1],pQ.z=e[2],pQ.w=e[3],pQ}resolve(e){let t,s,i;let n=pI.encode(e.entityPath,e.component,e.propertyPath),r=this.targetCache[n];if(r)return r;switch(e.component){case "entity":t=this._getEntityFromHierarchy(e.entityPath),i=pI.encode(t.path,"entity",e.propertyPath),s=t;break;case "graph":if(!(s=this.findNode(e)))return null;i=pI.encode(s.path,"graph",e.propertyPath);break;default:if(!(s=(t=this._getEntityFromHierarchy(e.entityPath)).findComponent(e.component)))return null;i=pI.encode(t.path,e.component,e.propertyPath);}return r=this._createAnimTargetForProperty(s,e.propertyPath,i),this.targetCache[n]=r,r}update(e){let t=this.activeNodes;if(t)for(let e=0;e<t.length;e++)t[e]._dirtifyLocal();}_getEntityFromHierarchy(e){if(!this.animComponent.entity.name===e[0])return null;let t=this.animComponent.entity;return 1===e.length?t:t._parent.findByPath(e)}_resolvePath(e,t,s){let i=t.length-+!s;for(let s=0;s<i;s++)e=e[t[s]];return e}_setter(e,t,s){let i=this._resolvePath(e,t),n=t[t.length-1],r="set"+n.substring(0,1).toUpperCase()+n.substring(1);if(i[r]){let e=i["get"+n.substring(0,1).toUpperCase()+n.substring(1)].bind(i)();e=[e.x,e.y,e.z,e.w];let t=i[r].bind(i);return {set:e=>{t(s(e));},get:()=>e}}let a=i[n];if("object"==typeof a&&a.hasOwnProperty("copy"))return function(e){a.copy(s(e));};if(-1!==[ef,eu,em,en,eT].indexOf(i.constructor)&&t.length>1){let r=t.length>2?this._resolvePath(e,t.slice(0,-1)):e,a=t[t.length-2];return function(e){i[n]=s(e),r[a]=i;}}return function(e){i[n]=s(e);}}_createAnimTargetForProperty(e,t,s){let i,n,r;if(this.handlers&&t[0].startsWith("weight."))return this.handlers.weight(e,t[0].replace("weight.",""));if(this.handlers&&"material"===t[0]&&2===t.length){let s=t[1];if(s.endsWith("Map"))return this.handlers.materialTexture(e,s)}let a=this._resolvePath(e,t,true);if(void 0===a)return null;if("number"==typeof a)i=this._setter(e,t,pJ._packFloat),n="vector",r=1;else if("boolean"==typeof a)i=this._setter(e,t,pJ._packBoolean),n="vector",r=1;else if("object"==typeof a)switch(a.constructor){case ef:i=this._setter(e,t,pJ._packVec2),n="vector",r=2;break;case eu:i=this._setter(e,t,pJ._packVec3),n="vector",r=3;break;case em:i=this._setter(e,t,pJ._packVec4),n="vector",r=4;break;case en:i=this._setter(e,t,pJ._packColor),n="vector",r=4;break;case eT:i=this._setter(e,t,pJ._packQuat),n="quaternion",r=4;break;default:return null}return -1!==t.indexOf("material")?new pR(t=>{i(t),e.material.update();},n,r,s):new pR(i,n,r,s)}rebind(){this.targetCache={},this.animComponent.rootBone?this.graph=this.animComponent.rootBone:this.graph=this.animComponent.entity;let e={},t=function(s){e[s.name]=s;for(let e=0;e<s.children.length;++e)t(s.children[e]);};t(this.graph),this.nodes=e;}constructor(e,t,s,i,n){super(t),this.animComponent=e,this._mask=i,this.layerName=s,this.layerIndex=n;}}class p${get name(){return this._name}set playing(e){this._controller.playing=e;}get playing(){return this._controller.playing}get playable(){return this._controller.playable}get activeState(){return this._controller.activeStateName}get previousState(){return this._controller.previousStateName}get activeStateProgress(){return this._controller.activeStateProgress}get activeStateDuration(){return this._controller.activeStateDuration}set activeStateCurrentTime(e){let t=this._controller,s=t.playing;t.playing=true,t.activeStateCurrentTime=e,s||t.update(0),t.playing=s;}get activeStateCurrentTime(){return this._controller.activeStateCurrentTime}get transitioning(){return this._controller.transitioning}get transitionProgress(){return this.transitioning?this._controller.transitionProgress:null}get states(){return this._controller.states}set weight(e){this._weight=e,this._component.dirtifyTargets();}get weight(){return this._weight}set blendType(e){e!==this._blendType&&(this._blendType=e,this._controller.normalizeWeights&&this._component.rebind());}get blendType(){return this._blendType}set mask(e){this._controller.assignMask(e)&&this._component.rebind(),this._mask=e;}get mask(){return this._mask}play(e){this._controller.play(e);}pause(){this._controller.pause();}reset(){this._controller.reset();}rebind(){this._controller.rebind();}update(e){this._blendTime&&(this._blendTimeElapsed<this._blendTime?(this.weight=ei.lerp(this._startingWeight,this._targetWeight,this._blendTimeElapsed/this._blendTime),this._blendTimeElapsed+=e):(this.weight=this._targetWeight,this._blendTime=0,this._blendTimeElapsed=0,this._startingWeight=0,this._targetWeight=0)),this._controller.update(e);}blendToWeight(e,t){this._startingWeight=this.weight,this._targetWeight=e,this._blendTime=Math.max(0,t),this._blendTimeElapsed=0;}assignAnimation(e,t,s,i){t instanceof pM&&(this._controller.assignAnimation(e,t,s,i),0===this._controller._transitions.length&&this._controller._transitions.push(new pW({from:"START",to:e})),this._component.activate&&this._component.playable&&(this._component.playing=true));}removeNodeAnimations(e){this._controller.removeNodeAnimations(e)&&(this._component.playing=false);}getAnimationAsset(e){return this._component.animationAssets[this.name+":"+e]}transition(e,t,s){ void 0===t&&(t=0),void 0===s&&(s=null),this._controller.updateStateFromTransition(new pW({from:this._controller.activeStateName,to:e,time:t,transitionOffset:s}));}constructor(e,t,s,i=1,n=pb){this._mask=null,this._blendTime=0,this._blendTimeElapsed=0,this._startingWeight=0,this._targetWeight=0,this._name=e,this._controller=t,this._component=s,this._weight=i,this._blendType=n;}}class p0{get parameters(){return Object.assign({},this._parameters)}get layers(){return this._layers}constructor(e){if(this._layers=[],this._parameters={},Array.isArray(e.layers))this._layers=e.layers;else for(let t in e.layers){let s=e.layers[t],i={name:s.name,blendType:s.blendType,weight:s.weight,states:[],transitions:[]};for(let t=0;t<s.states.length;t++)i.states.push(e.states[s.states[t]]);for(let t=0;t<s.transitions.length;t++){let n=e.transitions[s.transitions[t]];if(n.conditions&&!Array.isArray(n.conditions)){let e=Object.keys(n.conditions),t=[];for(let s=0;s<e.length;s++){let i=n.conditions[e[s]];i.parameterName&&t.push(i);}n.conditions=t;}Number.isInteger(n.from)&&(n.from=e.states[n.from].name),Number.isInteger(n.to)&&(n.to=e.states[n.to].name),i.transitions.push(n);}this._layers.push(i);}for(let t in e.parameters){let s=e.parameters[t];this._parameters[s.name]={type:s.type,value:s.value};}}}function p1(){return (p1=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i]);}return e}).apply(this,arguments)}class p2 extends u8{set stateGraphAsset(e){let t,s;if(null===e){this.removeStateGraph();return}this._stateGraphAsset&&this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this),e instanceof ub?(t=e.id,(s=this.system.app.assets.get(t))||(this.system.app.assets.add(e),s=this.system.app.assets.get(t))):(t=e,s=this.system.app.assets.get(t)),s&&this._stateGraphAsset!==t&&(s.resource?(this._stateGraph=s.resource,this.loadStateGraph(this._stateGraph),s.on("change",this._onStateGraphAssetChangeEvent,this)):(s.once("load",e=>{this._stateGraph=e.resource,this.loadStateGraph(this._stateGraph);}),s.on("change",this._onStateGraphAssetChangeEvent,this),this.system.app.assets.load(s)),this._stateGraphAsset=t);}get stateGraphAsset(){return this._stateGraphAsset}set normalizeWeights(e){this._normalizeWeights=e,this.unbind();}get normalizeWeights(){return this._normalizeWeights}set animationAssets(e){this._animationAssets=e,this.loadAnimationAssets();}get animationAssets(){return this._animationAssets}set speed(e){this._speed=e;}get speed(){return this._speed}set activate(e){this._activate=e;}get activate(){return this._activate}set playing(e){this._playing=e;}get playing(){return this._playing}set rootBone(e){if("string"==typeof e){let t=this.entity.root.findByGuid(e);this._rootBone=t;}else e instanceof uG?this._rootBone=e:this._rootBone=null;this.rebind();}get rootBone(){return this._rootBone}set stateGraph(e){this._stateGraph=e;}get stateGraph(){return this._stateGraph}get layers(){return this._layers}set layerIndices(e){this._layerIndices=e;}get layerIndices(){return this._layerIndices}set parameters(e){this._parameters=e;}get parameters(){return this._parameters}set targets(e){this._targets=e;}get targets(){return this._targets}get playable(){for(let e=0;e<this._layers.length;e++)if(!this._layers[e].playable)return  false;return  true}get baseLayer(){return this._layers.length>0?this._layers[0]:null}_onStateGraphAssetChangeEvent(e){let t=this.animationAssets,s=this.layers.map(e=>e.mask);this.removeStateGraph(),this._stateGraph=new p0(e._data),this.loadStateGraph(this._stateGraph),this.animationAssets=t,this.loadAnimationAssets(),this.layers.forEach((e,t)=>{e.mask=s[t];}),this.rebind();}dirtifyTargets(){let e=Object.values(this._targets);for(let t=0;t<e.length;t++)e[t].dirty=true;}_addLayer(e){let t,{name:s,states:i,transitions:n,weight:r,mask:a,blendType:o}=e;t=this.rootBone?this.rootBone:this.entity;let l=this._layers.length,h=new pY(new pC(new pJ(this,t,s,a,l)),i,n,this._activate,this,this.findParameter,this.consumeTrigger);return this._layers.push(new p$(s,h,this,r,o)),this._layerIndices[s]=l,this._layers[l]}addLayer(e,t,s,i){let n=this.findAnimationLayer(e);return n||this._addLayer({name:e,states:[{name:"START",speed:1}],transitions:[],weight:t,mask:s,blendType:i})}_assignParameters(e){this._parameters={};let t=Object.keys(e.parameters);for(let s=0;s<t.length;s++){let i=t[s];this._parameters[i]={type:e.parameters[i].type,value:e.parameters[i].value};}}loadStateGraph(e){this._stateGraph=e,this._assignParameters(e),this._layers=[];let t=false;for(let s=0;s<e.layers.length;s++){let i=e.layers[s];this._addLayer(p1({},i)),i.states.some(e=>e.blendTree)&&(t=true);}t||this.setupAnimationAssets();}setupAnimationAssets(){for(let e=0;e<this._layers.length;e++){let t=this._layers[e],s=t.name;for(let e=0;e<t.states.length;e++){let i=t.states[e];if(-1===pT.indexOf(i)){let e=s+":"+i;this._animationAssets[e]||(this._animationAssets[e]={asset:null});}}}this.loadAnimationAssets();}loadAnimationAssets(){for(let e=0;e<this._layers.length;e++){let t=this._layers[e];for(let e=0;e<t.states.length;e++){let s=t.states[e];if(-1!==pT.indexOf(s))continue;let i=this._animationAssets[t.name+":"+s];if(!i||!i.asset){this.findAnimationLayer(t.name).assignAnimation(s,pM.EMPTY);continue}let n=i.asset,r=this.system.app.assets.get(n);r&&(r.resource?this.onAnimationAssetLoaded(t.name,s,r):(r.once("load",(function(e,t){return (function(s){this.onAnimationAssetLoaded(e,t,s);}).bind(this)}).bind(this)(t.name,s)),this.system.app.assets.load(r)));}}}onAnimationAssetLoaded(e,t,s){this.findAnimationLayer(e).assignAnimation(t,s.resource);}removeStateGraph(){this._stateGraph=null,this._stateGraphAsset=null,this._animationAssets={},this._layers=[],this._layerIndices={},this._parameters={},this._playing=false,this.unbind(),this._targets={};}reset(){this._assignParameters(this._stateGraph);for(let e=0;e<this._layers.length;e++){let t=this._layers[e].playing;this._layers[e].reset(),this._layers[e].playing=t;}}unbind(){this._normalizeWeights||Object.keys(this._targets).forEach(e=>{this._targets[e].unbind();});}rebind(){this._targets={};for(let e=0;e<this._layers.length;e++)this._layers[e].rebind();}findAnimationLayer(e){let t=this._layerIndices[e];return this._layers[t]||null}addAnimationState(e,t,s,i,n){ void 0===s&&(s=1),void 0===i&&(i=true),void 0===n&&(n="Base"),this._stateGraph||this.loadStateGraph(new p0({layers:[{name:n,states:[{name:"START",speed:1},{name:e,speed:s,loop:i,defaultState:true}],transitions:[{from:"START",to:e}]}],parameters:{}}));let r=this.findAnimationLayer(n);if(r)r.assignAnimation(e,t,s,i);else {var a;null==(a=this.addLayer(n))||a.assignAnimation(e,t,s,i);}}assignAnimation(e,t,s,i,n){if(void 0===i&&(i=1),void 0===n&&(n=true),!this._stateGraph&&-1===e.indexOf(".")){this.loadStateGraph(new p0({layers:[{name:"Base",states:[{name:"START",speed:1},{name:e,speed:i,loop:n,defaultState:true}],transitions:[{from:"START",to:e}]}],parameters:{}})),this.baseLayer.assignAnimation(e,t);return}let r=s?this.findAnimationLayer(s):this.baseLayer;r&&r.assignAnimation(e,t,i,n);}removeNodeAnimations(e,t){let s=t?this.findAnimationLayer(t):this.baseLayer;s&&s.removeNodeAnimations(e);}getParameterValue(e,t){let s=this._parameters[e];if(s&&s.type===t)return s.value}setParameterValue(e,t,s){let i=this._parameters[e];if(i&&i.type===t){i.value=s;return}}getFloat(e){return this.getParameterValue(e,pm)}setFloat(e,t){this.setParameterValue(e,pm,t);}getInteger(e){return this.getParameterValue(e,pf)}setInteger(e,t){"number"==typeof t&&t%1==0&&this.setParameterValue(e,pf,t);}getBoolean(e){return this.getParameterValue(e,p_)}setBoolean(e,t){this.setParameterValue(e,p_,!!t);}getTrigger(e){return this.getParameterValue(e,pg)}setTrigger(e,t){ void 0===t&&(t=false),this.setParameterValue(e,pg,true),t&&this._consumedTriggers.add(e);}resetTrigger(e){this.setParameterValue(e,pg,false);}onBeforeRemove(){Number.isFinite(this._stateGraphAsset)&&this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this);}update(e){for(let t=0;t<this.layers.length;t++)this.layers[t].update(e*this.speed);this._consumedTriggers.forEach(e=>{this.parameters[e].value=false;}),this._consumedTriggers.clear();}resolveDuplicatedEntityReferenceProperties(e,t){e.rootBone&&t[e.rootBone.getGuid()]?this.rootBone=t[e.rootBone.getGuid()]:this.rebind();}constructor(...e){super(...e),this._stateGraphAsset=null,this._animationAssets={},this._speed=1,this._activate=true,this._playing=false,this._rootBone=null,this._stateGraph=null,this._layers=[],this._layerIndices={},this._parameters={},this._targets={},this._consumedTriggers=new Set,this._normalizeWeights=false,this.findParameter=e=>this._parameters[e],this.consumeTrigger=e=>{this._consumedTriggers.add(e);};}}class p3{constructor(){this.enabled=true;}}let p4=["enabled"];class p5 extends u9{initializeComponentData(e,t,s){super.initializeComponentData(e,t,p4);let i=["animationAssets","stateGraph","layers","masks"];Object.keys(t).forEach(s=>{i.includes(s)||(e[s]=t[s]);}),t.stateGraph&&(e.stateGraph=t.stateGraph,e.loadStateGraph(e.stateGraph)),t.layers&&t.layers.forEach((t,s)=>{t._controller.states.forEach(i=>{t._controller._states[i]._animationList.forEach(i=>{if(i.animTrack&&i.animTrack!==pM.EMPTY)e.layers[s].assignAnimation(i.name,i.animTrack);else {let n=this.app.assets.get(t._component._animationAssets[t.name+":"+i.name].asset);n&&!n.loaded&&n.once("load",()=>{e.layers[s].assignAnimation(i.name,n.resource);});}});});}),t.animationAssets&&(e.animationAssets=Object.assign(e.animationAssets,t.animationAssets)),t.masks&&Object.keys(t.masks).forEach(s=>{if(e.layers[s]){let i=t.masks[s].mask,n={};Object.keys(i).forEach(e=>{n[decodeURI(e)]=i[e];}),e.layers[s].mask=n;}});}onAnimationUpdate(e){let t=this.store;for(let s in t)if(t.hasOwnProperty(s)){let i=t[s].entity.anim;i.data.enabled&&i.entity.enabled&&i.playing&&i.update(e);}}cloneComponent(e,t){let s;e.anim.rootBone&&e.anim.rootBone!==e||(s={},e.anim.layers.forEach((e,i)=>{if(e.mask){let n={};Object.keys(e.mask).forEach(s=>{let i=s.split("/");i.shift(),n[[t.name,...i].join("/")]=e.mask[s];}),s[i]={mask:n};}}));let i={enabled:e.anim.enabled,stateGraphAsset:e.anim.stateGraphAsset,animationAssets:e.anim.animationAssets,speed:e.anim.speed,activate:e.anim.activate,playing:e.anim.playing,rootBone:e.anim.rootBone,stateGraph:e.anim.stateGraph,layers:e.anim.layers,layerIndices:e.anim.layerIndices,parameters:e.anim.parameters,normalizeWeights:e.anim.normalizeWeights,masks:s};return this.addComponent(t,i)}onBeforeRemove(e,t){t.onBeforeRemove();}destroy(){super.destroy(),this.app.systems.off("animationUpdate",this.onAnimationUpdate,this);}constructor(e){super(e),this.id="anim",this.ComponentType=p2,this.DataType=p3,this.schema=p4,this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("animationUpdate",this.onAnimationUpdate,this);}}u8._buildAccessors(p2.prototype,p4);class p6 extends u8{setCurrentListener(){if(this.enabled&&this.entity.audiolistener&&this.entity.enabled){this.system.current=this.entity;let e=this.system.current.getPosition();this.system.manager.listener.setPosition(e);}}onEnable(){this.setCurrentListener();}onDisable(){this.system.current===this.entity&&(this.system.current=null);}}class p8{constructor(){this.enabled=true;}}let p9=["enabled"];class p7 extends u9{initializeComponentData(e,t,s){s=["enabled"],super.initializeComponentData(e,t,s);}onUpdate(e){if(this.current){let e=this.current.getPosition();this.manager.listener.setPosition(e);let t=this.current.getWorldTransform();this.manager.listener.setOrientation(t);}}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this);}constructor(e){super(e),this.id="audiolistener",this.ComponentType=p6,this.DataType=p8,this.schema=p9,this.manager=e.soundManager,this.current=null,this.app.systems.on("update",this.onUpdate,this);}}u8._buildAccessors(p6.prototype,p9);let fe="group",ft="image",fs="text",fi="stretch",fn="contain",fr="cover",fa={DEFAULT:"DEFAULT",HOVER:"HOVER",PRESSED:"PRESSED",INACTIVE:"INACTIVE"},fo={};fo[fa.DEFAULT]="_defaultTint",fo[fa.HOVER]="hoverTint",fo[fa.PRESSED]="pressedTint",fo[fa.INACTIVE]="inactiveTint";let fl={};fl[fa.DEFAULT]="_defaultSpriteAsset",fl[fa.HOVER]="hoverSpriteAsset",fl[fa.PRESSED]="pressedSpriteAsset",fl[fa.INACTIVE]="inactiveSpriteAsset";let fh={};fh[fa.DEFAULT]="_defaultSpriteFrame",fh[fa.HOVER]="hoverSpriteFrame",fh[fa.PRESSED]="pressedSpriteFrame",fh[fa.INACTIVE]="inactiveSpriteFrame";class fd extends u8{get data(){let e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){this._setValue("enabled",e);}get enabled(){return this.data.enabled}set active(e){this._setValue("active",e);}get active(){return this.data.active}set imageEntity(e){if(this._imageEntity!==e){let t="string"==typeof e;(!this._imageEntity||!t||this._imageEntity.getGuid()!==e)&&(this._imageEntity&&this._imageEntityUnsubscribe(),e instanceof oE?this._imageEntity=e:t?this._imageEntity=this.system.app.getEntityFromIndex(e)||null:this._imageEntity=null,this._imageEntity&&this._imageEntitySubscribe(),this._imageEntity?this.data.imageEntity=this._imageEntity.getGuid():t&&e&&(this.data.imageEntity=e));}}get imageEntity(){return this._imageEntity}set hitPadding(e){this._setValue("hitPadding",e);}get hitPadding(){return this.data.hitPadding}set transitionMode(e){this._setValue("transitionMode",e);}get transitionMode(){return this.data.transitionMode}set hoverTint(e){this._setValue("hoverTint",e);}get hoverTint(){return this.data.hoverTint}set pressedTint(e){this._setValue("pressedTint",e);}get pressedTint(){return this.data.pressedTint}set inactiveTint(e){this._setValue("inactiveTint",e);}get inactiveTint(){return this.data.inactiveTint}set fadeDuration(e){this._setValue("fadeDuration",e);}get fadeDuration(){return this.data.fadeDuration}set hoverSpriteAsset(e){this._setValue("hoverSpriteAsset",e);}get hoverSpriteAsset(){return this.data.hoverSpriteAsset}set hoverSpriteFrame(e){this._setValue("hoverSpriteFrame",e);}get hoverSpriteFrame(){return this.data.hoverSpriteFrame}set pressedSpriteAsset(e){this._setValue("pressedSpriteAsset",e);}get pressedSpriteAsset(){return this.data.pressedSpriteAsset}set pressedSpriteFrame(e){this._setValue("pressedSpriteFrame",e);}get pressedSpriteFrame(){return this.data.pressedSpriteFrame}set inactiveSpriteAsset(e){this._setValue("inactiveSpriteAsset",e);}get inactiveSpriteAsset(){return this.data.inactiveSpriteAsset}set inactiveSpriteFrame(e){this._setValue("inactiveSpriteFrame",e);}get inactiveSpriteFrame(){return this.data.inactiveSpriteFrame}_setValue(e,t){let s=this.data,i=s[e];s[e]=t,this.fire("set",e,i,t);}_toggleLifecycleListeners(e,t){if(this[e]("set_active",this._onSetActive,this),this[e]("set_transitionMode",this._onSetTransitionMode,this),this[e]("set_hoverTint",this._onSetTransitionValue,this),this[e]("set_pressedTint",this._onSetTransitionValue,this),this[e]("set_inactiveTint",this._onSetTransitionValue,this),this[e]("set_hoverSpriteAsset",this._onSetTransitionValue,this),this[e]("set_hoverSpriteFrame",this._onSetTransitionValue,this),this[e]("set_pressedSpriteAsset",this._onSetTransitionValue,this),this[e]("set_pressedSpriteFrame",this._onSetTransitionValue,this),this[e]("set_inactiveSpriteAsset",this._onSetTransitionValue,this),this[e]("set_inactiveSpriteFrame",this._onSetTransitionValue,this),"on"===e)this._evtElementAdd=this.entity.on("element:add",this._onElementComponentAdd,this);else {var s;null==(s=this._evtElementAdd)||s.off(),this._evtElementAdd=null;}}_onSetActive(e,t,s){t!==s&&this._updateVisualState();}_onSetTransitionMode(e,t,s){t!==s&&(this._cancelTween(),this._resetToDefaultVisualState(t),this._forceReapplyVisualState());}_onSetTransitionValue(e,t,s){t!==s&&this._forceReapplyVisualState();}_imageEntitySubscribe(){this._evtImageEntityElementAdd=this._imageEntity.on("element:add",this._onImageElementGain,this),this._imageEntity.element&&this._onImageElementGain();}_imageEntityUnsubscribe(){var e,t;null==(e=this._evtImageEntityElementAdd)||e.off(),this._evtImageEntityElementAdd=null,(null==(t=this._imageEntity)?void 0:t.element)&&this._onImageElementLose();}_imageEntityElementSubscribe(){let e=this._imageEntity.element;this._evtImageEntityElementRemove=e.once("beforeremove",this._onImageElementLose,this),this._evtImageEntityElementColor=e.on("set:color",this._onSetColor,this),this._evtImageEntityElementOpacity=e.on("set:opacity",this._onSetOpacity,this),this._evtImageEntityElementSpriteAsset=e.on("set:spriteAsset",this._onSetSpriteAsset,this),this._evtImageEntityElementSpriteFrame=e.on("set:spriteFrame",this._onSetSpriteFrame,this);}_imageEntityElementUnsubscribe(){var e,t,s,i,n;null==(e=this._evtImageEntityElementRemove)||e.off(),this._evtImageEntityElementRemove=null,null==(t=this._evtImageEntityElementColor)||t.off(),this._evtImageEntityElementColor=null,null==(s=this._evtImageEntityElementOpacity)||s.off(),this._evtImageEntityElementOpacity=null,null==(i=this._evtImageEntityElementSpriteAsset)||i.off(),this._evtImageEntityElementSpriteAsset=null,null==(n=this._evtImageEntityElementSpriteFrame)||n.off(),this._evtImageEntityElementSpriteFrame=null;}_onElementComponentRemove(){this._toggleHitElementListeners("off");}_onElementComponentAdd(){this._toggleHitElementListeners("on");}_onImageElementLose(){this._imageEntityElementUnsubscribe(),this._cancelTween(),this._resetToDefaultVisualState(this.transitionMode);}_onImageElementGain(){this._imageEntityElementSubscribe(),this._storeDefaultVisualState(),this._forceReapplyVisualState();}_toggleHitElementListeners(e){if(this.entity.element){let t="on"===e;(!t||!this._hasHitElementListeners)&&(this.entity.element[e]("beforeremove",this._onElementComponentRemove,this),this.entity.element[e]("mouseenter",this._onMouseEnter,this),this.entity.element[e]("mouseleave",this._onMouseLeave,this),this.entity.element[e]("mousedown",this._onMouseDown,this),this.entity.element[e]("mouseup",this._onMouseUp,this),this.entity.element[e]("touchstart",this._onTouchStart,this),this.entity.element[e]("touchend",this._onTouchEnd,this),this.entity.element[e]("touchleave",this._onTouchLeave,this),this.entity.element[e]("touchcancel",this._onTouchCancel,this),this.entity.element[e]("selectstart",this._onSelectStart,this),this.entity.element[e]("selectend",this._onSelectEnd,this),this.entity.element[e]("selectenter",this._onSelectEnter,this),this.entity.element[e]("selectleave",this._onSelectLeave,this),this.entity.element[e]("click",this._onClick,this),this._hasHitElementListeners=t);}}_storeDefaultVisualState(){var e;let t=null==(e=this._imageEntity)?void 0:e.element;t&&t.type!==fe&&(this._storeDefaultColor(t.color),this._storeDefaultOpacity(t.opacity),this._storeDefaultSpriteAsset(t.spriteAsset),this._storeDefaultSpriteFrame(t.spriteFrame));}_storeDefaultColor(e){this._defaultTint.r=e.r,this._defaultTint.g=e.g,this._defaultTint.b=e.b;}_storeDefaultOpacity(e){this._defaultTint.a=e;}_storeDefaultSpriteAsset(e){this._defaultSpriteAsset=e;}_storeDefaultSpriteFrame(e){this._defaultSpriteFrame=e;}_onSetColor(e){this._isApplyingTint||(this._storeDefaultColor(e),this._forceReapplyVisualState());}_onSetOpacity(e){this._isApplyingTint||(this._storeDefaultOpacity(e),this._forceReapplyVisualState());}_onSetSpriteAsset(e){this._isApplyingSprite||(this._storeDefaultSpriteAsset(e),this._forceReapplyVisualState());}_onSetSpriteFrame(e){this._isApplyingSprite||(this._storeDefaultSpriteFrame(e),this._forceReapplyVisualState());}_onMouseEnter(e){this._isHovering=true,this._updateVisualState(),this._fireIfActive("mouseenter",e);}_onMouseLeave(e){this._isHovering=false,this._isPressed=false,this._updateVisualState(),this._fireIfActive("mouseleave",e);}_onMouseDown(e){this._isPressed=true,this._updateVisualState(),this._fireIfActive("mousedown",e);}_onMouseUp(e){this._isPressed=false,this._updateVisualState(),this._fireIfActive("mouseup",e);}_onTouchStart(e){this._isPressed=true,this._updateVisualState(),this._fireIfActive("touchstart",e);}_onTouchEnd(e){e.event.preventDefault(),this._isPressed=false,this._updateVisualState(),this._fireIfActive("touchend",e);}_onTouchLeave(e){this._isPressed=false,this._updateVisualState(),this._fireIfActive("touchleave",e);}_onTouchCancel(e){this._isPressed=false,this._updateVisualState(),this._fireIfActive("touchcancel",e);}_onSelectStart(e){this._isPressed=true,this._updateVisualState(),this._fireIfActive("selectstart",e);}_onSelectEnd(e){this._isPressed=false,this._updateVisualState(),this._fireIfActive("selectend",e);}_onSelectEnter(e){this._hoveringCounter++,1===this._hoveringCounter&&(this._isHovering=true,this._updateVisualState()),this._fireIfActive("selectenter",e);}_onSelectLeave(e){this._hoveringCounter--,0===this._hoveringCounter&&(this._isHovering=false,this._isPressed=false,this._updateVisualState()),this._fireIfActive("selectleave",e);}_onClick(e){this._fireIfActive("click",e);}_fireIfActive(e,t){this.data.active&&this.fire(e,t);}_updateVisualState(e){let t=this._visualState,s=this._determineVisualState();if((t!==s||e)&&this.enabled)switch(this._visualState=s,t===fa.HOVER&&this._fireIfActive("hoverend"),t===fa.PRESSED&&this._fireIfActive("pressedend"),s===fa.HOVER&&this._fireIfActive("hoverstart"),s===fa.PRESSED&&this._fireIfActive("pressedstart"),this.transitionMode){case 0:{let e=this[fo[this._visualState]];this._applyTint(e);break}case 1:{let e=fl[this._visualState],t=fh[this._visualState],s=this[e],i=this[t];this._applySprite(s,i);}}}_forceReapplyVisualState(){this._updateVisualState(true);}_resetToDefaultVisualState(e){var t;if(null==(t=this._imageEntity)?void 0:t.element)switch(e){case 0:this._cancelTween(),this._applyTintImmediately(this._defaultTint);break;case 1:this._applySprite(this._defaultSpriteAsset,this._defaultSpriteFrame);}}_determineVisualState(){return this.active?this._isPressed?fa.PRESSED:this._isHovering?fa.HOVER:fa.DEFAULT:fa.INACTIVE}_applySprite(e,t){var s;let i=null==(s=this._imageEntity)?void 0:s.element;i&&(t=t||0,this._isApplyingSprite=true,i.spriteAsset!==e&&(i.spriteAsset=e),i.spriteFrame!==t&&(i.spriteFrame=t),this._isApplyingSprite=false);}_applyTint(e){this._cancelTween(),0===this.fadeDuration?this._applyTintImmediately(e):this._applyTintWithTween(e);}_applyTintImmediately(e){var t;let s=null==(t=this._imageEntity)?void 0:t.element;if(!e||!s||s.type===fe)return;let i=fc(e);this._isApplyingTint=true,i.equals(s.color)||(s.color=i),s.opacity!==e.a&&(s.opacity=e.a),this._isApplyingTint=false;}_applyTintWithTween(e){var t;let s=null==(t=this._imageEntity)?void 0:t.element;if(!e||!s||s.type===fe)return;let i=fc(e),n=s.color,r=s.opacity;i.equals(n)&&e.a===r||(this._tweenInfo={startTime:$(),from:new en(n.r,n.g,n.b,r),to:e.clone(),lerpColor:new en});}_updateTintTween(){let e=$()-this._tweenInfo.startTime,t=0===this.fadeDuration?1:e/this.fadeDuration;if(Math.abs((t=ei.clamp(t,0,1))-1)>1e-5){let e=this._tweenInfo.lerpColor;e.lerp(this._tweenInfo.from,this._tweenInfo.to,t),this._applyTintImmediately(new en(e.r,e.g,e.b,e.a));}else this._applyTintImmediately(this._tweenInfo.to),this._cancelTween();}_cancelTween(){delete this._tweenInfo;}onUpdate(){this._tweenInfo&&this._updateTintTween();}onEnable(){this._isHovering=false,this._hoveringCounter=0,this._isPressed=false,this._toggleHitElementListeners("on"),this._forceReapplyVisualState();}onDisable(){this._toggleHitElementListeners("off"),this._resetToDefaultVisualState(this.transitionMode);}onRemove(){this._imageEntityUnsubscribe(),this._toggleLifecycleListeners("off",this.system),this.onDisable();}resolveDuplicatedEntityReferenceProperties(e,t){e.imageEntity&&(this.imageEntity=t[e.imageEntity.getGuid()]);}constructor(e,t){super(e,t),this._visualState=fa.DEFAULT,this._isHovering=false,this._hoveringCounter=0,this._isPressed=false,this._defaultTint=new en(1,1,1,1),this._defaultSpriteAsset=null,this._defaultSpriteFrame=0,this._imageEntity=null,this._evtElementAdd=null,this._evtImageEntityElementAdd=null,this._evtImageEntityElementRemove=null,this._evtImageEntityElementColor=null,this._evtImageEntityElementOpacity=null,this._evtImageEntityElementSpriteAsset=null,this._evtImageEntityElementSpriteFrame=null,this._visualState=fa.DEFAULT,this._isHovering=false,this._hoveringCounter=0,this._isPressed=false,this._defaultTint=new en(1,1,1,1),this._defaultSpriteAsset=null,this._defaultSpriteFrame=0,this._toggleLifecycleListeners("on",e);}}function fc(e){return new en(e.r,e.g,e.b)}fd.EVENT_MOUSEDOWN="mousedown",fd.EVENT_MOUSEUP="mouseup",fd.EVENT_MOUSEENTER="mouseenter",fd.EVENT_MOUSELEAVE="mouseleave",fd.EVENT_CLICK="click",fd.EVENT_TOUCHSTART="touchstart",fd.EVENT_TOUCHEND="touchend",fd.EVENT_TOUCHCANCEL="touchcancel",fd.EVENT_TOUCHLEAVE="touchleave",fd.EVENT_SELECTSTART="selectstart",fd.EVENT_SELECTEND="selectend",fd.EVENT_SELECTENTER="selectenter",fd.EVENT_SELECTLEAVE="selectleave",fd.EVENT_HOVERSTART="hoverstart",fd.EVENT_HOVEREND="hoverend",fd.EVENT_PRESSEDSTART="pressedstart",fd.EVENT_PRESSEDEND="pressedend";class fu{constructor(){this.enabled=true,this.active=true,this.imageEntity=null,this.hitPadding=new em,this.transitionMode=0,this.hoverTint=new en(.75,.75,.75),this.pressedTint=new en(.5,.5,.5),this.inactiveTint=new en(.25,.25,.25),this.fadeDuration=0,this.hoverSpriteAsset=null,this.hoverSpriteFrame=0,this.pressedSpriteAsset=null,this.pressedSpriteFrame=0,this.inactiveSpriteAsset=null,this.inactiveSpriteFrame=0;}}let fp=["enabled","active",{name:"hitPadding",type:"vec4"},"transitionMode",{name:"hoverTint",type:"rgba"},{name:"pressedTint",type:"rgba"},{name:"inactiveTint",type:"rgba"},"fadeDuration","hoverSpriteAsset","hoverSpriteFrame","pressedSpriteAsset","pressedSpriteFrame","inactiveSpriteAsset","inactiveSpriteFrame"];class ff extends u9{initializeComponentData(e,t,s){e.imageEntity=t.imageEntity,super.initializeComponentData(e,t,fp);}onUpdate(e){let t=this.store;for(let e in t){let s=t[e].entity,i=s.button;i.enabled&&s.enabled&&i.onUpdate();}}_onRemoveComponent(e,t){t.onRemove();}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this);}constructor(e){super(e),this.id="button",this.ComponentType=fd,this.DataType=fu,this.schema=fp,this.on("beforeremove",this._onRemoveComponent,this),this.app.systems.on("update",this.onUpdate,this);}}let fm=new eu,f_=new eT;class fg extends u8{get data(){let e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){this._setValue("enabled",e);}get enabled(){return this.data.enabled}set type(e){this._setValue("type",e);}get type(){return this.data.type}set halfExtents(e){this._setValue("halfExtents",e);}get halfExtents(){return this.data.halfExtents}set linearOffset(e){this._setValue("linearOffset",e);}get linearOffset(){return this.data.linearOffset}set angularOffset(e){this._setValue("angularOffset",e);}get angularOffset(){return this.data.angularOffset}set radius(e){this._setValue("radius",e);}get radius(){return this.data.radius}set axis(e){this._setValue("axis",e);}get axis(){return this.data.axis}set height(e){this._setValue("height",e);}get height(){return this.data.height}set asset(e){this._setValue("asset",e);}get asset(){return this.data.asset}set renderAsset(e){this._setValue("renderAsset",e);}get renderAsset(){return this.data.renderAsset}set convexHull(e){this._setValue("convexHull",e);}get convexHull(){return this.data.convexHull}set shape(e){this._setValue("shape",e);}get shape(){return this.data.shape}set model(e){this._setValue("model",e);}get model(){return this.data.model}set render(e){this._setValue("render",e);}get render(){return this.data.render}set checkVertexDuplicates(e){this._setValue("checkVertexDuplicates",e);}get checkVertexDuplicates(){return this.data.checkVertexDuplicates}_setValue(e,t){let s=this.data,i=s[e];s[e]=t,this.fire("set",e,i,t);}onSetType(e,t,s){t!==s&&this.system.changeType(this,t,s);}onSetHalfExtents(e,t,s){let i=this.data.type;this.data.initialized&&"box"===i&&this.system.recreatePhysicalShapes(this);}onSetOffset(e,t,s){this._hasOffset=!this.data.linearOffset.equals(eu.ZERO)||!this.data.angularOffset.equals(eT.IDENTITY),this.data.initialized&&this.system.recreatePhysicalShapes(this);}onSetRadius(e,t,s){let i=this.data.type;this.data.initialized&&("sphere"===i||"capsule"===i||"cylinder"===i||"cone"===i)&&this.system.recreatePhysicalShapes(this);}onSetHeight(e,t,s){let i=this.data.type;this.data.initialized&&("capsule"===i||"cylinder"===i||"cone"===i)&&this.system.recreatePhysicalShapes(this);}onSetAxis(e,t,s){let i=this.data.type;this.data.initialized&&("capsule"===i||"cylinder"===i||"cone"===i)&&this.system.recreatePhysicalShapes(this);}onSetAsset(e,t,s){let i=this.system.app.assets;if(t){let e=i.get(t);e&&e.off("remove",this.onAssetRemoved,this);}if(s){s instanceof ub&&(this.data.asset=s.id);let e=i.get(this.data.asset);e&&(e.off("remove",this.onAssetRemoved,this),e.on("remove",this.onAssetRemoved,this));}this.data.initialized&&"mesh"===this.data.type&&(s||(this.data.model=null),this.system.recreatePhysicalShapes(this));}onSetRenderAsset(e,t,s){let i=this.system.app.assets;if(t){let e=i.get(t);e&&e.off("remove",this.onRenderAssetRemoved,this);}if(s){s instanceof ub&&(this.data.renderAsset=s.id);let e=i.get(this.data.renderAsset);e&&(e.off("remove",this.onRenderAssetRemoved,this),e.on("remove",this.onRenderAssetRemoved,this));}this.data.initialized&&"mesh"===this.data.type&&(s||(this.data.render=null),this.system.recreatePhysicalShapes(this));}onSetModel(e,t,s){this.data.initialized&&"mesh"===this.data.type&&this.system.implementations.mesh.doRecreatePhysicalShape(this);}onSetRender(e,t,s){this.onSetModel(e,t,s);}onAssetRemoved(e){e.off("remove",this.onAssetRemoved,this),this.data.asset===e.id&&(this.asset=null);}onRenderAssetRemoved(e){e.off("remove",this.onRenderAssetRemoved,this),this.data.renderAsset===e.id&&(this.renderAsset=null);}getCompoundChildShapeIndex(e){let t=this.data.shape,s=t.getNumChildShapes();for(let i=0;i<s;i++){let s=t.getChildShape(i);if(Ammo.getPointer(s)===Ammo.getPointer(e))return i}return null}_onInsert(e){if("undefined"!=typeof Ammo){if(this._compoundParent)this.system.recreatePhysicalShapes(this);else if(!this.entity.rigidbody){let e=this.entity.parent;for(;e;){if(e.collision&&"compound"===e.collision.type){0===e.collision.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(e.collision):this.system.recreatePhysicalShapes(this);break}e=e.parent;}}}}_updateCompound(){let e=this.entity;if(e._dirtyWorld){let t=e._dirtyLocal,s=e;for(;s&&!t&&(!s.collision||s.collision!==this._compoundParent);)s._dirtyLocal&&(t=true),s=s.parent;if(t){e.forEach(this.system.implementations.compound._updateEachDescendantTransform,e);let t=this._compoundParent.entity.rigidbody;t&&t.activate();}}}getShapePosition(){let e=this.entity.getPosition();if(this._hasOffset){let t=this.entity.getRotation(),s=this.data.linearOffset;return f_.copy(t).transformVector(s,fm),fm.add(e)}return e}getShapeRotation(){let e=this.entity.getRotation();return this._hasOffset?f_.copy(e).mul(this.data.angularOffset):e}onEnable(){if("mesh"===this.data.type&&(this.data.asset||this.data.renderAsset)&&this.data.initialized){let e=this.system.app.assets.get(this.data.asset||this.data.renderAsset);if(e&&(!e.resource||!this.data.shape)){this.system.recreatePhysicalShapes(this);return}}if(this.entity.rigidbody)this.entity.rigidbody.enabled&&this.entity.rigidbody.enableSimulation();else if(this._compoundParent&&this!==this._compoundParent){if(0===this._compoundParent.shape.getNumChildShapes())this.system.recreatePhysicalShapes(this._compoundParent);else {let e=this.system._getNodeTransform(this.entity,this._compoundParent.entity);this._compoundParent.shape.addChildShape(e,this.data.shape),Ammo.destroy(e),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate();}}else this.entity.trigger&&this.entity.trigger.enable();}onDisable(){this.entity.rigidbody?this.entity.rigidbody.disableSimulation():this._compoundParent&&this!==this._compoundParent?!this._compoundParent.entity._destroying&&(this.system._removeCompoundChild(this._compoundParent,this.data.shape),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()):this.entity.trigger&&this.entity.trigger.disable();}onBeforeRemove(){this.asset&&(this.asset=null),this.renderAsset&&(this.renderAsset=null),this.entity.off("insert",this._onInsert,this),this.off();}constructor(e,t){super(e,t),this._compoundParent=null,this._hasOffset=false,this.entity.on("insert",this._onInsert,this),this.on("set_type",this.onSetType,this),this.on("set_convexHull",this.onSetModel,this),this.on("set_halfExtents",this.onSetHalfExtents,this),this.on("set_linearOffset",this.onSetOffset,this),this.on("set_angularOffset",this.onSetOffset,this),this.on("set_radius",this.onSetRadius,this),this.on("set_height",this.onSetHeight,this),this.on("set_axis",this.onSetAxis,this),this.on("set_asset",this.onSetAsset,this),this.on("set_renderAsset",this.onSetRenderAsset,this),this.on("set_model",this.onSetModel,this),this.on("set_render",this.onSetRender,this);}}fg.EVENT_CONTACT="contact",fg.EVENT_COLLISIONSTART="collisionstart",fg.EVENT_COLLISIONEND="collisionend",fg.EVENT_TRIGGERENTER="triggerenter",fg.EVENT_TRIGGERLEAVE="triggerleave";class fv{constructor(){this.enabled=true,this.type="box",this.halfExtents=new eu(.5,.5,.5),this.linearOffset=new eu,this.angularOffset=new eT,this.radius=.5,this.axis=1,this.height=2,this.convexHull=false,this.asset=null,this.renderAsset=null,this.checkVertexDuplicates=true,this.shape=null,this.model=null,this.render=null,this.initialized=false;}}let fy="static",fS="dynamic",fx="kinematic";class fT{initialize(e){let t=this.entity,s=e.shape;if(s&&"undefined"!=typeof Ammo){t.trigger&&t.trigger.destroy();let e=this.component;if(e){let t=e.getShapePosition(),s=e.getShapeRotation();r.setValue(t.x,t.y,t.z),a.setValue(s.x,s.y,s.z,s.w);}else {let e=t.getPosition(),s=t.getRotation();r.setValue(e.x,e.y,e.z),a.setValue(s.x,s.y,s.z,s.w);}o.setOrigin(r),o.setRotation(a);let i=this.app.systems.rigidbody.createBody(1,s,o);i.setRestitution(0),i.setFriction(0),i.setDamping(0,0),r.setValue(0,0,0),i.setLinearFactor(r),i.setAngularFactor(r),i.setCollisionFlags(4|i.getCollisionFlags()),i.entity=t,this.body=i,this.component.enabled&&t.enabled&&this.enable();}}destroy(){this.body&&(this.disable(),this.app.systems.rigidbody.destroyBody(this.body),this.body=null);}_getEntityTransform(e){let t=this.component;if(t){let e=t.getShapePosition(),s=t.getShapeRotation();r.setValue(e.x,e.y,e.z),a.setValue(s.x,s.y,s.z,s.w);}else {let e=this.entity.getPosition(),t=this.entity.getRotation();r.setValue(e.x,e.y,e.z),a.setValue(t.x,t.y,t.z,t.w);}e.setOrigin(r),e.setRotation(a);}updateTransform(){this._getEntityTransform(o);let e=this.body;e.setWorldTransform(o),e.activate();}enable(){let e=this.body;if(!e)return;let t=this.app.systems.rigidbody;0>t._triggers.indexOf(this)&&(t.addBody(e,16,65517),t._triggers.push(this)),e.forceActivationState(1),this.updateTransform();}disable(){let e=this.body;if(!e)return;let t=this.app.systems.rigidbody,s=t._triggers.indexOf(this);s>-1&&(t.removeBody(e),t._triggers.splice(s,1)),e.forceActivationState(5);}constructor(e,t,s){this.entity=t.entity,this.component=t,this.app=e,"undefined"==typeof Ammo||r||(r=new Ammo.btVector3,a=new Ammo.btQuaternion,o=new Ammo.btTransform),this.initialize(s);}}let fb=new ex,fE=new eu,fA=new eu,fw=new eT,fC=new oE,fP=["enabled","type","halfExtents","linearOffset","angularOffset","radius","axis","height","convexHull","asset","renderAsset","shape","model","render","checkVertexDuplicates"];class fM{beforeInitialize(e,t){t.shape=null,t.model=new hh,t.model.graph=new oE;}afterInitialize(e,t){this.recreatePhysicalShapes(e),e.data.initialized=true;}reset(e,t){this.beforeInitialize(e,t),this.afterInitialize(e,t);}recreatePhysicalShapes(e){let t=e.entity,s=e.data;if("undefined"!=typeof Ammo){t.trigger&&(t.trigger.destroy(),delete t.trigger),s.shape&&(e._compoundParent&&(e!==e._compoundParent&&this.system._removeCompoundChild(e._compoundParent,s.shape),e._compoundParent.entity.rigidbody&&e._compoundParent.entity.rigidbody.activate()),this.destroyShape(s)),s.shape=this.createPhysicalShape(e.entity,s);let i=!e._compoundParent;if("compound"!==s.type||e._compoundParent&&e!==e._compoundParent){if("compound"!==s.type&&!e.rigidbody){e._compoundParent=null;let s=t.parent;for(;s;){if(s.collision&&"compound"===s.collision.type){e._compoundParent=s.collision;break}s=s.parent;}}}else e._compoundParent=e,t.forEach(this._addEachDescendant,e);e._compoundParent&&e!==e._compoundParent&&(i&&0===e._compoundParent.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(e._compoundParent):(this.system.updateCompoundChildTransform(t,true),e._compoundParent.entity.rigidbody&&e._compoundParent.entity.rigidbody.activate())),t.rigidbody?(t.rigidbody.disableSimulation(),t.rigidbody.createBody(),t.enabled&&t.rigidbody.enabled&&t.rigidbody.enableSimulation()):e._compoundParent||(t.trigger?t.trigger.initialize(s):t.trigger=new fT(this.system.app,e,s));}}createPhysicalShape(e,t){}updateTransform(e,t,s,i){e.entity.trigger&&e.entity.trigger.updateTransform();}destroyShape(e){e.shape&&(Ammo.destroy(e.shape),e.shape=null);}beforeRemove(e,t){t.data.shape&&(t._compoundParent&&!t._compoundParent.entity._destroying&&(this.system._removeCompoundChild(t._compoundParent,t.data.shape),t._compoundParent.entity.rigidbody&&t._compoundParent.entity.rigidbody.activate()),t._compoundParent=null,this.destroyShape(t.data));}remove(e,t){e.rigidbody&&e.rigidbody.body&&e.rigidbody.disableSimulation(),e.trigger&&(e.trigger.destroy(),delete e.trigger);}clone(e,t){let s=this.system.store[e.getGuid()],i={enabled:s.data.enabled,type:s.data.type,halfExtents:[s.data.halfExtents.x,s.data.halfExtents.y,s.data.halfExtents.z],linearOffset:[s.data.linearOffset.x,s.data.linearOffset.y,s.data.linearOffset.z],angularOffset:[s.data.angularOffset.x,s.data.angularOffset.y,s.data.angularOffset.z,s.data.angularOffset.w],radius:s.data.radius,axis:s.data.axis,height:s.data.height,convexHull:s.data.convexHull,asset:s.data.asset,renderAsset:s.data.renderAsset,model:s.data.model,render:s.data.render,checkVertexDuplicates:s.data.checkVertexDuplicates};return this.system.addComponent(t,i)}constructor(e){this.system=e;}}class fI extends fM{createPhysicalShape(e,t){if("undefined"!=typeof Ammo){let e=t.halfExtents,s=new Ammo.btVector3(e?e.x:.5,e?e.y:.5,e?e.z:.5),i=new Ammo.btBoxShape(s);return Ammo.destroy(s),i}}}class fR extends fM{createPhysicalShape(e,t){if("undefined"!=typeof Ammo)return new Ammo.btSphereShape(t.radius)}}class fL extends fM{createPhysicalShape(e,t){var s,i,n;let r=null!=(s=t.axis)?s:1,a=null!=(i=t.radius)?i:.5,o=Math.max((null!=(n=t.height)?n:2)-2*a,0),l=null;if("undefined"!=typeof Ammo)switch(r){case 0:l=new Ammo.btCapsuleShapeX(a,o);break;case 1:l=new Ammo.btCapsuleShape(a,o);break;case 2:l=new Ammo.btCapsuleShapeZ(a,o);}return l}}class fD extends fM{createPhysicalShape(e,t){var s,i,n;let r=null!=(s=t.axis)?s:1,a=null!=(i=t.radius)?i:.5,o=null!=(n=t.height)?n:1,l=null,h=null;if("undefined"!=typeof Ammo)switch(r){case 0:l=new Ammo.btVector3(.5*o,a,a),h=new Ammo.btCylinderShapeX(l);break;case 1:l=new Ammo.btVector3(a,.5*o,a),h=new Ammo.btCylinderShape(l);break;case 2:l=new Ammo.btVector3(a,a,.5*o),h=new Ammo.btCylinderShapeZ(l);}return l&&Ammo.destroy(l),h}}class fO extends fM{createPhysicalShape(e,t){var s,i,n;let r=null!=(s=t.axis)?s:1,a=null!=(i=t.radius)?i:.5,o=null!=(n=t.height)?n:1,l=null;if("undefined"!=typeof Ammo)switch(r){case 0:l=new Ammo.btConeShapeX(a,o);break;case 1:l=new Ammo.btConeShape(a,o);break;case 2:l=new Ammo.btConeShapeZ(a,o);}return l}}class fF extends fM{beforeInitialize(e,t){}createAmmoHull(e,t,s,i){let n=new Ammo.btConvexHullShape,r=new Ammo.btVector3,a=[];e.getPositions(a);for(let e=0;e<a.length;e+=3)r.setValue(a[e]*i.x,a[e+1]*i.y,a[e+2]*i.z),n.addPoint(r,false);Ammo.destroy(r),n.recalcLocalAabb(),n.setMargin(.01);let o=this.system._getNodeTransform(t);s.addChildShape(o,n),Ammo.destroy(o);}createAmmoMesh(e,t,s,i,n){let r;void 0===n&&(n=true);let a=this.system;if(a._triMeshCache[e.id])r=a._triMeshCache[e.id];else {let t,s,o,l,h;let d=e.vertexBuffer,c=d.getFormat();for(let e=0;e<c.elements.length;e++){let i=c.elements[e];if(i.name===e2){s=new Float32Array(d.lock(),i.offset),t=i.stride/4;break}}let u=[];e.getIndices(u);let p=e.primitive[0].count/3,f=new Ammo.btVector3,m=e.primitive[0].base;r=new Ammo.btTriangleMesh,a._triMeshCache[e.id]=r;let _=new Map;r.getIndexedMeshArray().at(0).m_numTriangles=p;let g=i?i.x:1,v=i?i.y:1,y=i?i.z:1,S=e=>{let i;let a=s[e*t]*g,o=s[e*t+1]*v,l=s[e*t+2]*y;if(n){let e=a+":"+o+":"+l;if(void 0!==(i=_.get(e)))return i;f.setValue(a,o,l),i=r.findOrAddVertex(f,false),_.set(e,i);}else f.setValue(a,o,l),i=r.findOrAddVertex(f,false);return i};for(let e=0;e<p;e++)o=S(u[m+3*e]),l=S(u[m+3*e+1]),h=S(u[m+3*e+2]),r.addIndex(o),r.addIndex(l),r.addIndex(h);Ammo.destroy(f);}let o=new Ammo.btBvhTriangleMeshShape(r,true);if(!i){let e=a._getNodeScaling(t);o.setLocalScaling(e),Ammo.destroy(e);}let l=a._getNodeTransform(t);s.addChildShape(l,o),Ammo.destroy(l);}createPhysicalShape(e,t){if("undefined"!=typeof Ammo&&(t.model||t.render)){let s=new Ammo.btCompoundShape,i=e.getWorldTransform().getScale();if(t.render){let e=t.render.meshes;for(let n=0;n<e.length;n++)t.convexHull?this.createAmmoHull(e[n],fC,s,i):this.createAmmoMesh(e[n],fC,s,i,t.checkVertexDuplicates);}else if(t.model){let e=t.model.meshInstances;for(let i=0;i<e.length;i++)this.createAmmoMesh(e[i].mesh,e[i].node,s,null,t.checkVertexDuplicates);let n=new Ammo.btVector3(i.x,i.y,i.z);s.setLocalScaling(n),Ammo.destroy(n);}return s}}recreatePhysicalShapes(e){let t=e.data;if((t.renderAsset||t.asset)&&e.enabled&&e.entity.enabled){this.loadAsset(e,t.renderAsset||t.asset,t.renderAsset?"render":"model");return}this.doRecreatePhysicalShape(e);}loadAsset(e,t,s){let i=e.data,n=this.system.app.assets,r=i[s],a=t=>{i[s]===r&&(i[s]=t.resource,this.doRecreatePhysicalShape(e));},o=e=>{e.ready(e=>{if(e.data.containerAsset){let t=n.get(e.data.containerAsset);t.loaded?a(e):(t.ready(()=>{a(e);}),n.load(t));}else a(e);}),n.load(e);},l=n.get(t);l?o(l):n.once("add:"+t,o);}doRecreatePhysicalShape(e){let t=e.entity,s=e.data;s.model||s.render?(this.destroyShape(s),s.shape=this.createPhysicalShape(t,s),t.rigidbody?(t.rigidbody.disableSimulation(),t.rigidbody.createBody(),t.enabled&&t.rigidbody.enabled&&t.rigidbody.enableSimulation()):t.trigger?t.trigger.initialize(s):t.trigger=new fT(this.system.app,e,s)):(this.beforeRemove(t,e),this.remove(t,s));}updateTransform(e,t,s,i){if(e.shape){let t=e.entity.getWorldTransform().getScale(),s=e.shape.getLocalScaling();(t.x!==s.x()||t.y!==s.y()||t.z!==s.z())&&this.doRecreatePhysicalShape(e);}super.updateTransform(e,t,s,i);}destroyShape(e){if(!e.shape)return;let t=e.shape.getNumChildShapes();for(let s=0;s<t;s++){let t=e.shape.getChildShape(s);Ammo.destroy(t);}Ammo.destroy(e.shape),e.shape=null;}}class fN extends fM{createPhysicalShape(e,t){if("undefined"!=typeof Ammo)return new Ammo.btCompoundShape}_addEachDescendant(e){e.collision&&!e.rigidbody&&(e.collision._compoundParent=this,e!==this.entity&&e.collision.system.recreatePhysicalShapes(e.collision));}_updateEachDescendant(e){e.collision&&e.collision._compoundParent===this&&(e.collision._compoundParent=null,e===this.entity||e.rigidbody||e.collision.system.recreatePhysicalShapes(e.collision));}_updateEachDescendantTransform(e){e.collision&&e.collision._compoundParent===this.collision._compoundParent&&this.collision.system.updateCompoundChildTransform(e,false);}}class fB extends u9{initializeComponentData(e,t,s){let i;s=["type","halfExtents","radius","axis","height","convexHull","shape","model","asset","render","renderAsset","enabled","linearOffset","angularOffset","checkVertexDuplicates"];let n={};for(let e=0,i=s.length;e<i;e++){let i=s[e];n[i]=t[i];}if(t.hasOwnProperty("asset")?(-1!==(i=s.indexOf("model"))&&s.splice(i,1),-1!==(i=s.indexOf("render"))&&s.splice(i,1)):t.hasOwnProperty("model")&&-1!==(i=s.indexOf("asset"))&&s.splice(i,1),n.type||(n.type=e.data.type),e.data.type=n.type,Array.isArray(n.halfExtents)&&(n.halfExtents=new eu(n.halfExtents)),Array.isArray(n.linearOffset)&&(n.linearOffset=new eu(n.linearOffset)),Array.isArray(n.angularOffset)){let e=n.angularOffset;3===e.length?n.angularOffset=new eT().setFromEulerAngles(e[0],e[1],e[2]):n.angularOffset=new eT(n.angularOffset);}let r=this._createImplementation(n.type);r.beforeInitialize(e,n),super.initializeComponentData(e,n,s),r.afterInitialize(e,n);}_createImplementation(e){if(void 0===this.implementations[e]){let t;switch(e){case "box":t=new fI(this);break;case "sphere":t=new fR(this);break;case "capsule":t=new fL(this);break;case "cylinder":t=new fD(this);break;case "cone":t=new fO(this);break;case "mesh":t=new fF(this);break;case "compound":t=new fN(this);}this.implementations[e]=t;}return this.implementations[e]}_getImplementation(e){return this.implementations[e.collision.data.type]}cloneComponent(e,t){return this._getImplementation(e).clone(e,t)}onBeforeRemove(e,t){this.implementations[t.data.type].beforeRemove(e,t),t.onBeforeRemove();}onRemove(e,t){this.implementations[t.type].remove(e,t);}updateCompoundChildTransform(e,t){let s=e.collision._compoundParent;if(s!==e.collision&&e.enabled&&e.collision.enabled&&(e._dirtyLocal||t)){let t=this._getNodeTransform(e,s.entity),i=s.getCompoundChildShapeIndex(e.collision.shape);null===i?s.shape.addChildShape(t,e.collision.data.shape):s.shape.updateChildTransform(i,t,true),Ammo.destroy(t);}}_removeCompoundChild(e,t){if(0!==e.shape.getNumChildShapes()){if(e.shape.removeChildShape)e.shape.removeChildShape(t);else {let s=e.getCompoundChildShapeIndex(t);null!==s&&e.shape.removeChildShapeByIndex(s);}}}onTransformChanged(e,t,s,i){this.implementations[e.data.type].updateTransform(e,t,s,i);}changeType(e,t,s){this.implementations[t].beforeRemove(e.entity,e),this.implementations[t].remove(e.entity,e.data),this._createImplementation(s).reset(e,e.data);}recreatePhysicalShapes(e){this.implementations[e.data.type].recreatePhysicalShapes(e);}_calculateNodeRelativeTransform(e,t){if(e===t){let t=e.getWorldTransform().getScale();fb.setScale(t.x,t.y,t.z);}else this._calculateNodeRelativeTransform(e.parent,t),fb.mul(e.getLocalTransform());}_getNodeScaling(e){let t=e.getWorldTransform().getScale();return new Ammo.btVector3(t.x,t.y,t.z)}_getNodeTransform(e,t){let s,i;t?(this._calculateNodeRelativeTransform(e,t),s=fE,i=fw,fb.getTranslation(s),i.setFromMat4(fb)):(s=e.getPosition(),i=e.getRotation());let n=new Ammo.btQuaternion,r=new Ammo.btTransform;r.setIdentity();let a=r.getOrigin(),o=e.collision;if(o&&o._hasOffset){let e=o.data.linearOffset,t=o.data.angularOffset;fw.copy(i).transformVector(e,fA),fA.add(s),fw.copy(i).mul(t),a.setValue(fA.x,fA.y,fA.z),n.setValue(fw.x,fw.y,fw.z,fw.w);}else a.setValue(s.x,s.y,s.z),n.setValue(i.x,i.y,i.z,i.w);return r.setRotation(n),Ammo.destroy(n),r}destroy(){for(let e in this._triMeshCache)Ammo.destroy(this._triMeshCache[e]);this._triMeshCache=null,super.destroy();}constructor(e){super(e),this.id="collision",this.ComponentType=fg,this.DataType=fv,this.schema=fP,this.implementations={},this._triMeshCache={},this.on("beforeremove",this.onBeforeRemove,this),this.on("remove",this.onRemove,this);}}let fU=new en,fk=new t8;class fz{destroy(){var e,t;this.setMaterial(null),this._element.removeModelFromLayers(this.model),this.model.destroy(),this.model=null,this.node=null,this.mesh=null,null==(e=this.meshInstance)||e.destroy(),this.meshInstance=null,null==(t=this.unmaskMeshInstance)||t.destroy(),this.unmaskMeshInstance=null,this._entity=null,this._element=null;}setMesh(e){this.meshInstance&&(this.mesh=e,this.meshInstance.mesh=e,this.meshInstance.visible=!!e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.mesh=e),this.forceUpdateAabb());}setMask(e){if(this.meshInstance){if(this._entity.enabled&&this._element.enabled&&this._element.removeModelFromLayers(this.model),e)for(let e in this.unmaskMeshInstance=new a0(this.mesh,this.meshInstance.material,this.node),this.unmaskMeshInstance.name="Unmask: "+this._entity.name,this.unmaskMeshInstance.castShadow=false,this.unmaskMeshInstance.receiveShadow=false,this.unmaskMeshInstance.pick=false,this.model.meshInstances.push(this.unmaskMeshInstance),this.meshInstance.parameters)this.unmaskMeshInstance.setParameter(e,this.meshInstance.parameters[e].data);else {let e=this.model.meshInstances.indexOf(this.unmaskMeshInstance);e>=0&&this.model.meshInstances.splice(e,1);}if(this._entity.enabled&&this._element.enabled&&this._element.addModelToLayers(this.model),!e){var t;null==(t=this.unmaskMeshInstance)||t.destroy(),this.unmaskMeshInstance=null;}}}setMaterial(e){this.meshInstance&&(this.meshInstance.material=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.material=e));}setParameter(e,t){this.meshInstance&&(this.meshInstance.setParameter(e,t),this.unmaskMeshInstance&&this.unmaskMeshInstance.setParameter(e,t));}deleteParameter(e){this.meshInstance&&(this.meshInstance.deleteParameter(e),this.unmaskMeshInstance&&this.unmaskMeshInstance.deleteParameter(e));}setUnmaskDrawOrder(){if(!this.meshInstance)return;let e=function(t){let s;let i=t.children,n=i.length;if(n){for(let e=0;e<n;e++)i[e].element&&(s=i[e]);if(!s)return null;let t=e(s);return t||s}return null};if(this.unmaskMeshInstance){let t=e(this._entity);t&&t.element?this.unmaskMeshInstance.drawOrder=t.element.drawOrder+t.element.getMaskOffset():this.unmaskMeshInstance.drawOrder=this.meshInstance.drawOrder+this._element.getMaskOffset();}}setDrawOrder(e){this.meshInstance&&(this.meshInstance.drawOrder=e);}setCull(e){if(!this.meshInstance)return;let t=this._element,s=null;e&&t._isScreenSpace()&&(s=function(e){return t.isVisibleForCamera(e)}),this.meshInstance.cull=e,this.meshInstance.isVisibleFunc=s,this.unmaskMeshInstance&&(this.unmaskMeshInstance.cull=e,this.unmaskMeshInstance.isVisibleFunc=s);}setScreenSpace(e){this.meshInstance&&(this.meshInstance.screenSpace=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.screenSpace=e));}setLayer(e){this.meshInstance&&(this.meshInstance.layer=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.layer=e));}forceUpdateAabb(e){this.meshInstance&&(this.meshInstance._aabbVer=-1,this.unmaskMeshInstance&&(this.unmaskMeshInstance._aabbVer=-1));}setAabbFunc(e){this.meshInstance&&(this.meshInstance._updateAabbFunc=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance._updateAabbFunc=e));}constructor(e,t,s){this._entity=e,this._element=e.element,this.model=new hh,this.node=new oE,this.model.graph=this.node,this.mesh=t,this.meshInstance=new a0(this.mesh,s,this.node),this.meshInstance.name="ImageElement: "+e.name,this.meshInstance.castShadow=false,this.meshInstance.receiveShadow=false,this._meshDirty=false,this.model.meshInstances.push(this.meshInstance),this._entity.addChild(this.model.graph),this.model._entity=this._entity,this.unmaskMeshInstance=null;}}class fV{destroy(){this.textureAsset=null,this.spriteAsset=null,this.materialAsset=null,this._renderable.setMesh(this._defaultMesh),this._renderable.destroy(),this._defaultMesh=null,this._element.off("resize",this._onParentResizeOrPivotChange,this),this._element.off("set:pivot",this._onParentResizeOrPivotChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("screen:set:resolution",this._onResolutionChange,this);}_onResolutionChange(e){}_onParentResizeOrPivotChange(){this._renderable.mesh&&this._updateMesh(this._renderable.mesh);}_onScreenSpaceChange(e){this._updateMaterial(e);}_onScreenChange(e,t){e?this._updateMaterial(e.screen.screenSpace):this._updateMaterial(false);}_onDrawOrderChange(e){this._renderable.setDrawOrder(e),this.mask&&this._element.screen&&this._element.screen.screen.once("syncdraworder",function(){this._renderable.setUnmaskDrawOrder();},this);}_hasUserMaterial(){return !!this._materialAsset||!!this._material&&-1===this._system.defaultImageMaterials.indexOf(this._material)}_use9Slicing(){return this.sprite&&(1===this.sprite.renderMode||2===this.sprite.renderMode)}_updateMaterial(e){let t=!!this._mask,s=!!(this.sprite&&1===this.sprite.renderMode),i=!!(this.sprite&&2===this.sprite.renderMode);this._hasUserMaterial()||(this._material=this._system.getImageElementMaterial(e,t,s,i)),this._renderable&&(this._renderable.setCull(!this._element._isScreenSpace()||this._element._isScreenCulled()),this._renderable.setMaterial(this._material),this._renderable.setScreenSpace(e),this._renderable.setLayer(15*!e));}_createMesh(){let e=this._element,t=e.calculatedWidth,s=e.calculatedHeight,i=this._rect,n=this._system.app.graphicsDevice,r=new Float32Array([t,0,0,0,0,1,i.x+i.z,1-i.y,t,s,0,0,0,1,i.x+i.z,1-(i.y+i.w),0,0,0,0,0,1,i.x,1-i.y,0,s,0,0,0,1,i.x,1-(i.y+i.w)]),a=fk.get(n,()=>new sA(n,[{semantic:e2,components:3,type:6},{semantic:e3,components:3,type:6},{semantic:e7,components:2,type:6}])),o=new sy(n,a,4,{data:r.buffer}),l=new aG(n);return l.vertexBuffer=o,l.primitive[0].type=5,l.primitive[0].base=0,l.primitive[0].count=4,l.primitive[0].indexed=false,l.aabb.setMinMax(eu.ZERO,new eu(t,s,0)),this._updateMesh(l),l}_updateMesh(e){let t=this._element,s=t.calculatedWidth,i=t.calculatedHeight;if(t.fitMode!==fi&&this._targetAspectRatio>0){let e=t.calculatedWidth/t.calculatedHeight;t.fitMode===fn&&e>this._targetAspectRatio||t.fitMode===fr&&e<this._targetAspectRatio?s=t.calculatedHeight*this._targetAspectRatio:i=t.calculatedWidth/this._targetAspectRatio;}let n=t._isScreenSpace();if(this._updateMaterial(n),this._renderable&&this._renderable.forceUpdateAabb(),this.sprite&&(1===this.sprite.renderMode||2===this.sprite.renderMode)){let e=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]],n=2/e.rect.z,r=2/e.rect.w;this._innerOffset.set(e.border.x*n,e.border.y*r,e.border.z*n,e.border.w*r);let a=this.sprite.atlas.texture;this._atlasRect.set(e.rect.x/a.width,e.rect.y/a.height,e.rect.z/a.width,e.rect.w/a.height);let o=null!==this._pixelsPerUnit?this._pixelsPerUnit:this.sprite.pixelsPerUnit,l=e.rect.z/o,h=e.rect.w/o;this._outerScale.set(Math.max(s,this._innerOffset.x*l),Math.max(i,this._innerOffset.y*h));let d=l,c=h;this._outerScale.x/=l,this._outerScale.y/=h,d*=ei.clamp(s/(this._innerOffset.x*l),1e-4,1),c*=ei.clamp(i/(this._innerOffset.y*h),1e-4,1),this._renderable&&(this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._renderable.setParameter("innerOffset",this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._renderable.setParameter("atlasRect",this._atlasRectUniform),this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._renderable.setParameter("outerScale",this._outerScaleUniform),this._renderable.setAabbFunc(this._updateAabbFunc),this._renderable.node.setLocalScale(d,c,1),this._renderable.node.setLocalPosition((.5-t.pivot.x)*s,(.5-t.pivot.y)*i,0));}else {let n=e.vertexBuffer,r=new Float32Array(n.lock()),a=t.pivot.x,o=t.pivot.y;r[0]=s-a*s,r[1]=0-o*i,r[8]=s-a*s,r[9]=i-o*i,r[16]=0-a*s,r[17]=0-o*i,r[24]=0-a*s,r[25]=i-o*i;let l=1,h=1,d=this._rect;if(this._sprite&&this._sprite.frameKeys[this._spriteFrame]&&this._sprite.atlas){let e=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]];e&&(d=e.rect,l=this._sprite.atlas.texture.width,h=this._sprite.atlas.texture.height);}r[6]=(d.x+d.z)/l,r[7]=1-d.y/h,r[14]=(d.x+d.z)/l,r[15]=1-(d.y+d.w)/h,r[22]=d.x/l,r[23]=1-d.y/h,r[30]=d.x/l,r[31]=1-(d.y+d.w)/h,n.unlock();let c=new eu(0-a*s,0-o*i,0),u=new eu(s-a*s,i-o*i,0);e.aabb.setMinMax(c,u),this._renderable&&(this._renderable.node.setLocalScale(1,1,1),this._renderable.node.setLocalPosition(0,0,0),this._renderable.setAabbFunc(null));}this._meshDirty=false;}_updateSprite(){let e=false,t=null;if(this._targetAspectRatio=-1,this._sprite&&this._sprite.atlas){t=this._sprite.meshes[this.spriteFrame],e=1===this._sprite.renderMode||2===this._sprite.renderMode;let s=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]];(null==s?void 0:s.rect.w)>0&&(this._targetAspectRatio=s.rect.z/s.rect.w);}this.mesh=e?t:this._defaultMesh,this.refreshMesh();}refreshMesh(){this.mesh&&(this._element._beingInitialized?this._meshDirty=true:this._updateMesh(this.mesh));}_updateAabb(e){return e.center.set(0,0,0),e.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001),e.setFromTransformedAabb(e,this._renderable.node.getWorldTransform()),e}_toggleMask(){this._element._dirtifyMask();let e=this._element._isScreenSpace();this._updateMaterial(e),this._renderable.setMask(!!this._mask);}_onMaterialLoad(e){this.material=e.resource;}_onMaterialAdded(e){this._system.app.assets.off("add:"+e.id,this._onMaterialAdded,this),this._materialAsset===e.id&&this._bindMaterialAsset(e);}_bindMaterialAsset(e){this._entity.enabled&&(e.on("load",this._onMaterialLoad,this),e.on("change",this._onMaterialChange,this),e.on("remove",this._onMaterialRemove,this),e.resource?this._onMaterialLoad(e):this._system.app.assets.load(e));}_unbindMaterialAsset(e){e.off("load",this._onMaterialLoad,this),e.off("change",this._onMaterialChange,this),e.off("remove",this._onMaterialRemove,this);}_onMaterialChange(){}_onMaterialRemove(){}_onTextureAdded(e){this._system.app.assets.off("add:"+e.id,this._onTextureAdded,this),this._textureAsset===e.id&&this._bindTextureAsset(e);}_bindTextureAsset(e){this._entity.enabled&&(e.on("load",this._onTextureLoad,this),e.on("change",this._onTextureChange,this),e.on("remove",this._onTextureRemove,this),e.resource?this._onTextureLoad(e):this._system.app.assets.load(e));}_unbindTextureAsset(e){e.off("load",this._onTextureLoad,this),e.off("change",this._onTextureChange,this),e.off("remove",this._onTextureRemove,this);}_onTextureLoad(e){this.texture=e.resource;}_onTextureChange(e){}_onTextureRemove(e){}_onSpriteAssetAdded(e){this._system.app.assets.off("add:"+e.id,this._onSpriteAssetAdded,this),this._spriteAsset===e.id&&this._bindSpriteAsset(e);}_bindSpriteAsset(e){this._entity.enabled&&(e.on("load",this._onSpriteAssetLoad,this),e.on("change",this._onSpriteAssetChange,this),e.on("remove",this._onSpriteAssetRemove,this),e.resource?this._onSpriteAssetLoad(e):this._system.app.assets.load(e));}_unbindSpriteAsset(e){e.off("load",this._onSpriteAssetLoad,this),e.off("change",this._onSpriteAssetChange,this),e.off("remove",this._onSpriteAssetRemove,this),e.data.textureAtlasAsset&&this._system.app.assets.off("load:"+e.data.textureAtlasAsset,this._onTextureAtlasLoad,this);}_onSpriteAssetLoad(e){if(e&&e.resource){if(e.resource.atlas)this.sprite=e.resource;else {let t=e.data.textureAtlasAsset;if(t){let e=this._system.app.assets;e.off("load:"+t,this._onTextureAtlasLoad,this),e.once("load:"+t,this._onTextureAtlasLoad,this);}}}else this.sprite=null;}_onSpriteAssetChange(e){this._onSpriteAssetLoad(e);}_onSpriteAssetRemove(e){}_bindSprite(e){this._evtSetMeshes=e.on("set:meshes",this._onSpriteMeshesChange,this),e.on("set:pixelsPerUnit",this._onSpritePpuChange,this),e.on("set:atlas",this._onAtlasTextureChange,this),e.atlas&&e.atlas.on("set:texture",this._onAtlasTextureChange,this);}_unbindSprite(e){var t;null==(t=this._evtSetMeshes)||t.off(),this._evtSetMeshes=null,e.off("set:pixelsPerUnit",this._onSpritePpuChange,this),e.off("set:atlas",this._onAtlasTextureChange,this),e.atlas&&e.atlas.off("set:texture",this._onAtlasTextureChange,this);}_onSpriteMeshesChange(){this._sprite&&(this._spriteFrame=ei.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite();}_onSpritePpuChange(){0!==this.sprite.renderMode&&null===this._pixelsPerUnit&&this._updateSprite();}_onAtlasTextureChange(){this.sprite&&this.sprite.atlas&&this.sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"));}_onTextureAtlasLoad(e){let t=this._spriteAsset;t instanceof ub?this._onSpriteAssetLoad(t):this._onSpriteAssetLoad(this._system.app.assets.get(t));}onEnable(){if(this._materialAsset){let e=this._system.app.assets.get(this._materialAsset);e&&e.resource!==this._material&&this._bindMaterialAsset(e);}if(this._textureAsset){let e=this._system.app.assets.get(this._textureAsset);e&&e.resource!==this._texture&&this._bindTextureAsset(e);}if(this._spriteAsset){let e=this._system.app.assets.get(this._spriteAsset);e&&e.resource!==this._sprite&&this._bindSpriteAsset(e);}this._element.addModelToLayers(this._renderable.model);}onDisable(){this._element.removeModelFromLayers(this._renderable.model);}_setStencil(e){this._renderable.meshInstance.stencilFront=e,this._renderable.meshInstance.stencilBack=e;let t=0;if(this._element.maskedBy&&(t=this._element.maskedBy.element._image._maskRef),this._renderable.unmaskMeshInstance){let e=new sC({ref:t+1,func:2,zpass:5});this._renderable.unmaskMeshInstance.stencilFront=e,this._renderable.unmaskMeshInstance.stencilBack=e;}}_updateRenderableEmissive(){fU.linear(this._color),this._colorUniform[0]=fU.r,this._colorUniform[1]=fU.g,this._colorUniform[2]=fU.b,this._renderable.setParameter("material_emissive",this._colorUniform);}set color(e){let{r:t,g:s,b:i}=e;(this._color.r!==t||this._color.g!==s||this._color.b!==i)&&(this._color.r=t,this._color.g=s,this._color.b=i,this._updateRenderableEmissive()),this._element&&this._element.fire("set:color",this._color);}get color(){return this._color}set opacity(e){e!==this._color.a&&(this._color.a=e,this._renderable.setParameter("material_opacity",e)),this._element&&this._element.fire("set:opacity",e);}get opacity(){return this._color.a}set rect(e){let t,s,i,n;e instanceof em?(t=e.x,s=e.y,i=e.z,n=e.w):(t=e[0],s=e[1],i=e[2],n=e[3]),(t!==this._rect.x||s!==this._rect.y||i!==this._rect.z||n!==this._rect.w)&&(this._rect.set(t,s,i,n),this._renderable.mesh&&(this._element._beingInitialized?this._meshDirty=true:this._updateMesh(this._renderable.mesh)));}get rect(){return this._rect}_removeMaterialAssetEvents(){if(this._materialAsset){let e=this._system.app.assets;e.off("add:"+this._materialAsset,this._onMaterialAdded,this);let t=e.get(this._materialAsset);t&&(t.off("load",this._onMaterialLoad,this),t.off("change",this._onMaterialChange,this),t.off("remove",this._onMaterialRemove,this));}}set material(e){if(this._material!==e){if(!e){let t=this._element._isScreenSpace();e=this.mask?t?this._system.defaultScreenSpaceImageMaskMaterial:this._system.defaultImageMaskMaterial:t?this._system.defaultScreenSpaceImageMaterial:this._system.defaultImageMaterial;}if(this._material=e,this._materialAsset){let t=this._system.app.assets.get(this._materialAsset);t&&t.resource===e||(this._removeMaterialAssetEvents(),this._materialAsset=null);}e&&(this._renderable.setMaterial(e),this._hasUserMaterial()?(this._renderable.deleteParameter("material_opacity"),this._renderable.deleteParameter("material_emissive")):(this._updateRenderableEmissive(),this._renderable.setParameter("material_opacity",this._color.a)));}}get material(){return this._material}set materialAsset(e){let t=this._system.app.assets,s=e;if(e instanceof ub&&(s=e.id),this._materialAsset!==s){if(this._removeMaterialAssetEvents(),this._materialAsset=s,this._materialAsset){let e=t.get(this._materialAsset);e?this._bindMaterialAsset(e):(this._materialAsset=null,this.material=null,this._materialAsset=s,t.on("add:"+this._materialAsset,this._onMaterialAdded,this));}else this._materialAsset=null,this.material=null,this._materialAsset=s;}}get materialAsset(){return this._materialAsset}set texture(e){if(this._texture!==e){if(this._textureAsset){let t=this._system.app.assets.get(this._textureAsset);t&&t.resource!==e&&(this.textureAsset=null);}if(this._texture=e,e){this._spriteAsset&&(this.spriteAsset=null),this._renderable.setParameter("texture_emissiveMap",this._texture),this._renderable.setParameter("texture_opacityMap",this._texture),this._updateRenderableEmissive(),this._renderable.setParameter("material_opacity",this._color.a);let e=this._texture.width/this._texture.height;e!==this._targetAspectRatio&&(this._targetAspectRatio=e,this._element.fitMode!==fi&&this.refreshMesh());}else this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"),this._targetAspectRatio=-1,this._element.fitMode!==fi&&this.refreshMesh();}}get texture(){return this._texture}set textureAsset(e){let t=this._system.app.assets,s=e;if(e instanceof ub&&(s=e.id),this._textureAsset!==s){if(this._textureAsset){t.off("add:"+this._textureAsset,this._onTextureAdded,this);let e=t.get(this._textureAsset);e&&(e.off("load",this._onTextureLoad,this),e.off("change",this._onTextureChange,this),e.off("remove",this._onTextureRemove,this));}if(this._textureAsset=s,this._textureAsset){let e=t.get(this._textureAsset);e?this._bindTextureAsset(e):(this.texture=null,t.on("add:"+this._textureAsset,this._onTextureAdded,this));}else this.texture=null;}}get textureAsset(){return this._textureAsset}set spriteAsset(e){let t=this._system.app.assets,s=e;if(e instanceof ub&&(s=e.id),this._spriteAsset!==s){if(this._spriteAsset){t.off("add:"+this._spriteAsset,this._onSpriteAssetAdded,this);let e=t.get(this._spriteAsset);e&&this._unbindSpriteAsset(e);}if(this._spriteAsset=s,this._spriteAsset){let e=t.get(this._spriteAsset);e?this._bindSpriteAsset(e):(this.sprite=null,t.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this));}else this.sprite=null;}this._element&&this._element.fire("set:spriteAsset",s);}get spriteAsset(){return this._spriteAsset}set sprite(e){if(this._sprite!==e){if(this._sprite&&this._unbindSprite(this._sprite),this._spriteAsset){let t=this._system.app.assets.get(this._spriteAsset);t&&t.resource!==e&&(this.spriteAsset=null);}this._sprite=e,this._sprite&&(this._bindSprite(this._sprite),this._textureAsset&&(this.textureAsset=null)),this._sprite&&this._sprite.atlas&&this._sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap")),this._sprite&&(this._spriteFrame=ei.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite();}}get sprite(){return this._sprite}set spriteFrame(e){let t=this._spriteFrame;this._sprite?this._spriteFrame=ei.clamp(e,0,this._sprite.frameKeys.length-1):this._spriteFrame=e,this._spriteFrame!==t&&this._updateSprite(),this._element&&this._element.fire("set:spriteFrame",e);}get spriteFrame(){return this._spriteFrame}set mesh(e){this._renderable.setMesh(e),this._defaultMesh===e?this._renderable.setAabbFunc(null):this._renderable.setAabbFunc(this._updateAabbFunc);}get mesh(){return this._renderable.mesh}set mask(e){this._mask!==e&&(this._mask=e,this._toggleMask());}get mask(){return this._mask}set pixelsPerUnit(e){this._pixelsPerUnit!==e&&(this._pixelsPerUnit=e,this._sprite&&(1===this._sprite.renderMode||2===this._sprite.renderMode)&&this._updateSprite());}get pixelsPerUnit(){return this._pixelsPerUnit}get aabb(){return this._renderable.meshInstance?this._renderable.meshInstance.aabb:null}constructor(e){this._evtSetMeshes=null,this._element=e,this._entity=e.entity,this._system=e.system,this._textureAsset=null,this._texture=null,this._materialAsset=null,this._material=null,this._spriteAsset=null,this._sprite=null,this._spriteFrame=0,this._pixelsPerUnit=null,this._targetAspectRatio=-1,this._rect=new em(0,0,1,1),this._mask=false,this._maskRef=0,this._outerScale=new ef,this._outerScaleUniform=new Float32Array(2),this._innerOffset=new em,this._innerOffsetUniform=new Float32Array(4),this._atlasRect=new em,this._atlasRectUniform=new Float32Array(4),this._defaultMesh=this._createMesh(),this._renderable=new fz(this._entity,this._defaultMesh,this._material),this._color=new en(1,1,1,1),this._colorUniform=new Float32Array([1,1,1]),this._updateRenderableEmissive(),this._renderable.setParameter("material_opacity",1),this._updateAabbFunc=this._updateAabb.bind(this),this._onScreenChange(this._element.screen),this._element.on("resize",this._onParentResizeOrPivotChange,this),this._element.on("set:pivot",this._onParentResizeOrPivotChange,this),this._element.on("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.on("set:screen",this._onScreenChange,this),this._element.on("set:draworder",this._onDrawOrderChange,this),this._element.on("screen:set:resolution",this._onResolutionChange,this);}}class fG extends Y{set defaultAsset(e){let t=e instanceof ub?e.id:e;this._defaultAsset!==t&&(this._defaultAsset&&this._unbindDefaultAsset(),this._defaultAsset=t,this._defaultAsset&&this._bindDefaultAsset(),this._onSetLocale(this._app.i18n.locale));}get defaultAsset(){return this._defaultAsset}set localizedAsset(e){let t=e instanceof ub?e.id:e;this._localizedAsset!==t&&(this._localizedAsset&&(this._app.assets.off("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this),this._unbindLocalizedAsset()),this._localizedAsset=t,this._localizedAsset&&(this._app.assets.get(this._localizedAsset)?this._bindLocalizedAsset():this._app.assets.once("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this)));}get localizedAsset(){return this._localizedAsset}set autoLoad(e){this._autoLoad!==e&&(this._autoLoad=e,this._autoLoad&&this._localizedAsset&&(this._unbindLocalizedAsset(),this._bindLocalizedAsset()));}get autoLoad(){return this._autoLoad}set disableLocalization(e){this._disableLocalization!==e&&(this._disableLocalization=e,this._onSetLocale(this._app.i18n.locale));}get disableLocalization(){return this._disableLocalization}_bindDefaultAsset(){let e=this._app.assets.get(this._defaultAsset);e?this._onDefaultAssetAdd(e):this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this);}_unbindDefaultAsset(){if(!this._defaultAsset)return;this._app.assets.off("add:"+this._defaultAsset,this._onDefaultAssetAdd,this);let e=this._app.assets.get(this._defaultAsset);e&&(e.off("add:localized",this._onLocaleAdd,this),e.off("remove:localized",this._onLocaleRemove,this),e.off("remove",this._onDefaultAssetRemove,this));}_onDefaultAssetAdd(e){this._defaultAsset===e.id&&(e.on("add:localized",this._onLocaleAdd,this),e.on("remove:localized",this._onLocaleRemove,this),e.once("remove",this._onDefaultAssetRemove,this));}_onDefaultAssetRemove(e){this._defaultAsset===e.id&&(e.off("add:localized",this._onLocaleAdd,this),e.off("remove:localized",this._onLocaleAdd,this),this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this));}_bindLocalizedAsset(){if(!this._autoLoad)return;let e=this._app.assets.get(this._localizedAsset);e&&(e.on("load",this._onLocalizedAssetLoad,this),e.on("change",this._onLocalizedAssetChange,this),e.on("remove",this._onLocalizedAssetRemove,this),e.resource?this._onLocalizedAssetLoad(e):this._app.assets.load(e));}_unbindLocalizedAsset(){let e=this._app.assets.get(this._localizedAsset);e&&(e.off("load",this._onLocalizedAssetLoad,this),e.off("change",this._onLocalizedAssetChange,this),e.off("remove",this._onLocalizedAssetRemove,this));}_onLocalizedAssetAdd(e){this._localizedAsset===e.id&&this._bindLocalizedAsset();}_onLocalizedAssetLoad(e){this.fire("load",e);}_onLocalizedAssetChange(e,t,s,i){this.fire("change",e,t,s,i);}_onLocalizedAssetRemove(e){this._localizedAsset===e.id&&(this.localizedAsset=this._defaultAsset),this.fire("remove",e);}_onLocaleAdd(e,t){this._app.i18n.locale===e&&this._onSetLocale(e);}_onLocaleRemove(e,t){this._app.i18n.locale===e&&this._onSetLocale(e);}_onSetLocale(e){if(!this._defaultAsset){this.localizedAsset=null;return}let t=this._app.assets.get(this._defaultAsset);if(!t||this._disableLocalization){this.localizedAsset=this._defaultAsset;return}let s=t.getLocalizedAssetId(e);if(!s){this.localizedAsset=this._defaultAsset;return}this.localizedAsset=s;}destroy(){this.defaultAsset=null,this._app.i18n.off("set:locale",this._onSetLocale,this),this.off();}constructor(e){super(),this._app=e,e.i18n.on("set:locale",this._onSetLocale,this),this._autoLoad=false,this._disableLocalization=false,this._defaultAsset=null,this._localizedAsset=null;}}let fH="msdf",fW="bitmap",fX=/[\w|/]/;class fY{read(){let e=this._read();for(;8===e;)e=this._read();return 0!==e&&1!==e&&(this._last=this._index),e}buf(){return this._buf}last(){return this._last}error(){return this._error}debugPrint(){let e=["EOF","ERROR","TEXT","OPEN_BRACKET","CLOSE_BRACKET","EQUALS","STRING","IDENTIFIER","WHITESPACE"],t=this.read(),s="";for(;s+=(s.length>0?"\n":"")+e[t]+" '"+this.buf().join("")+"'",0!==t&&1!==t;)t=this.read();return s}_read(){return (this._buf=[],this._eof())?0:"text"===this._mode?this._text():this._tag()}_text(){for(;;)switch(this._cur){case null:return 2*(this._buf.length>0);case "[":return this._mode="tag",this._buf.length>0?2:this._tag();case "\\":(this._next(),"["===this._cur)?this._store():this._output("\\");break;default:this._store();}}_tag(){switch(this._cur){case null:return this._error="unexpected end of input reading tag",1;case "[":return this._store(),3;case "]":return this._store(),this._mode="text",4;case "=":return this._store(),5;case " ":case "	":case "\n":case "\r":case "\v":case "\f":return this._whitespace();case '"':return this._string();default:if(!this._isIdentifierSymbol(this._cur))return this._error="unrecognized character",1;return this._identifier()}}_whitespace(){for(this._store();-1!==" 	\n\r\v\f".indexOf(this._cur);)this._store();return 8}_string(){for(this._next();;)switch(this._cur){case null:return this._error="unexpected end of input reading string",1;case '"':return this._next(),6;default:this._store();}}_identifier(){for(this._store();null!==this._cur&&this._isIdentifierSymbol(this._cur);)this._store();return 7}_isIdentifierSymbol(e){return 1===e.length&&null!==e.match(fX)}_eof(){return null===this._cur}_next(){return this._eof()||(this._index++,this._cur=this._index<this._symbols.length?this._symbols[this._index]:null),this._cur}_store(){return this._buf.push(this._cur),this._next()}_output(e){this._buf.push(e);}constructor(e){this._symbols=e,this._index=0,this._last=0,this._cur=this._symbols.length>0?this._symbols[0]:null,this._buf=[],this._mode="text",this._error=null;}}class fj{parse(e,t){for(;;)switch(this._scanner.read()){case 0:return  true;case 1:default:return  false;case 2:Array.prototype.push.apply(e,this._scanner.buf());break;case 3:if(!this._parseTag(e,t))return  false}}error(){return "Error evaluating markup at #"+this._scanner.last().toString()+" ("+(this._scanner.error()||this._error)+")"}_parseTag(e,t){let s=this._scanner.read();if(7!==s)return this._error="expected identifier",false;let i=this._scanner.buf().join("");if("/"===i[0]){for(let n=t.length-1;n>=0;--n)if(i==="/"+t[n].name&&null===t[n].end){if(t[n].end=e.length,4!==(s=this._scanner.read()))return this._error="expected close bracket",false;return  true}return this._error="failed to find matching tag",false}let n={name:i,value:null,attributes:{},start:e.length,end:null};if(5===(s=this._scanner.read())){if(6!==(s=this._scanner.read()))return this._error="expected string",false;n.value=this._scanner.buf().join(""),s=this._scanner.read();}for(;;){switch(s){case 4:return t.push(n),true;case 7:{let e=this._scanner.buf().join("");if(5!==(s=this._scanner.read()))return this._error="expected equals",false;if(6!==(s=this._scanner.read()))return this._error="expected string",false;let t=this._scanner.buf().join("");n.attributes[e]=t;break}default:return this._error="expected close bracket or identifier",false}s=this._scanner.read();}}constructor(e){this._scanner=new fY(e),this._error=null;}}class fq{static evaluate(e){return function(e){let t=new fj(e),s=[],i=[];if(!t.parse(s,i)||i.find(e=>null===e.end))return {symbols:e,tags:null};let n=function(e,t){if(0===e.length)return null;let s={};for(let t=0;t<e.length;++t){let i=e[t];s.hasOwnProperty(i.start)?null===s[i.start].open?s[i.start].open=[i]:s[i.start].open.push(i):s[i.start]={open:[i],close:null},s.hasOwnProperty(i.end)?null===s[i.end].close?s[i.end].close=[i]:s[i.end].close.push(i):s[i.end]={open:null,close:[i]};}let i=[],n=Object.keys(s).sort((e,t)=>e-t),r=[];for(let e=0;e<n.length;++e){let t=s[n[e]];null!==t.close&&function(e){i=i.filter(t=>void 0===e.find(e=>e===t));}(t.close),null!==t.open&&function(e){for(let t=0;t<e.length;++t)i.push(e[t]);}(t.open),r.push({start:n[e],tags:function(e){if(0===e.length)return null;let t={};for(let s=0;s<e.length;++s){let i=e[s],n={};n[i.name]={value:i.value,attributes:i.attributes},function e(t,s){for(let i in s){if(!s.hasOwnProperty(i))continue;let n=s[i];n instanceof Object?(t.hasOwnProperty(i)||(t[i]={}),e(t[i],s[i])):t[i]=n;}}(t,n);}return t}(i)});}let a=[],o=null;for(let e=0;e<r.length;++e){let t=r[e];for(;a.length<t.start;)a.push(o?o.tags:null);o=t;}for(;a.length<t;)a.push(null);return a}(i,s.length);return {symbols:s,tags:n}}(e)}}class fK{constructor(){this.count=0,this.quad=0,this.lines={},this.positions=[],this.normals=[],this.uvs=[],this.colors=[],this.indices=[],this.outlines=[],this.shadows=[],this.meshInstance=null;}}let fZ=/^[\r\n]$/,fQ=/^[ \t]$/,fJ=/^[ \t\-]|\u200b$/,f$=/^[a-z0-9]$/i,f0=/^[\u1100-\u11ff]|[\u3000-\u9fff\ua960-\ua97f]|[\uac00-\ud7ff]$/,f1=/^[〕〉》」』】〙〗〟ヽヾーァィゥェォッャュョヮヵヶぁぃぅぇぉっゃゅょゎゕゖㇰㇱㇲㇳㇴㇵㇶㇷㇸㇹㇺㇻㇼㇽㇾㇿ々〻]$/,f2=["​","؜","‎","‏","‪","‫","‬","‭","‮","⁦","⁧","⁨","⁩"],f3={width:0,height:0,xadvance:0,xoffset:0,yoffset:0},f4=new en,f5=new ef,f6=new en;class f8{destroy(){this._setMaterial(null),this._model&&(this._element.removeModelFromLayers(this._model),this._model.destroy(),this._model=null),this._fontAsset.destroy(),this.font=null,this._element.off("resize",this._onParentResize,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("set:pivot",this._onPivotChange,this),this._system.app.i18n.off("set:locale",this._onLocaleSet,this),this._system.app.i18n.off("data:add",this._onLocalizationData,this),this._system.app.i18n.off("data:remove",this._onLocalizationData,this);}_onParentResize(e,t){!this._noResize&&this._font&&this._updateText();}_onScreenChange(e){e?this._updateMaterial(e.screen.screenSpace):this._updateMaterial(false);}_onScreenSpaceChange(e){this._updateMaterial(e);}_onDrawOrderChange(e){if(this._drawOrder=e,this._model)for(let t=0,s=this._model.meshInstances.length;t<s;t++)this._model.meshInstances[t].drawOrder=e;}_onPivotChange(e){this._font&&this._updateText();}_onLocaleSet(e){if(this._i18nKey){if(this.fontAsset){let e=this._system.app.assets.get(this.fontAsset);e&&e.resource&&e.resource===this._font||(this.font=null);}this._resetLocalizedText();}}_onLocalizationData(e,t){this._i18nKey&&t[this._i18nKey]&&this._resetLocalizedText();}_resetLocalizedText(){this._setText(this._system.app.i18n.getText(this._i18nKey));}_setText(e){if(this.unicodeConverter){let t=this._system.getUnicodeConverter();t&&(e=t(e));}this._text!==e&&(this._font&&this._updateText(e),this._text=e);}_updateText(e){let t;if(void 0===e&&(e=this._text),this._symbols=W.getSymbols(e.normalize?e.normalize("NFC"):e),0===this._symbols.length&&(this._symbols=[" "]),this._enableMarkup){let e=fq.evaluate(this._symbols);this._symbols=e.symbols,t=e.tags||[];}if(this._rtlReorder){let e=this._system.app.systems.element.getRtlReorder();if(e){let s=e(this._symbols);this._rtl=s.rtl,this._symbols=s.mapping.map(function(e){return this._symbols[e]},this),t&&(t=s.mapping.map(e=>t[e]));}}else this._rtl=false;let s=(e,t)=>e.toString(true).toLowerCase()+":"+t.toFixed(2),i=(e,t)=>e.toString(true).toLowerCase()+":"+t.x.toFixed(2)+":"+t.y.toFixed(2);if(t){let e={},n={},r={};this._colorPalette=[Math.round(255*this._color.r),Math.round(255*this._color.g),Math.round(255*this._color.b)],this._outlinePalette=[Math.round(255*this._outlineColor.r),Math.round(255*this._outlineColor.g),Math.round(255*this._outlineColor.b),Math.round(255*this._outlineColor.a),Math.round(255*this._outlineThickness)],this._shadowPalette=[Math.round(255*this._shadowColor.r),Math.round(255*this._shadowColor.g),Math.round(255*this._shadowColor.b),Math.round(255*this._shadowColor.a),Math.round(127*this._shadowOffset.x),Math.round(127*this._shadowOffset.y)],this._symbolColors=[],this._symbolOutlineParams=[],this._symbolShadowParams=[],e[this._color.toString(false).toLowerCase()]=0,n[s(this._outlineColor,this._outlineThickness)]=0,r[i(this._shadowColor,this._shadowOffset)]=0;for(let a=0,o=this._symbols.length;a<o;++a){let o=t[a],l=0;if(o&&o.color&&o.color.value){let t=o.color.value;if(7===t.length&&"#"===t[0]){let s=t.substring(1).toLowerCase();e.hasOwnProperty(s)?l=e[s]:/^[0-9a-f]{6}$/.test(s)&&(l=this._colorPalette.length/3,e[s]=l,this._colorPalette.push(parseInt(s.substring(0,2),16)),this._colorPalette.push(parseInt(s.substring(2,4),16)),this._colorPalette.push(parseInt(s.substring(4,6),16)));}}this._symbolColors.push(l);let h=0;if(o&&o.outline&&(o.outline.attributes.color||o.outline.attributes.thickness)){let e=o.outline.attributes.color?f4.fromString(o.outline.attributes.color):this._outlineColor,t=Number(o.outline.attributes.thickness);(Number.isNaN(e.r)||Number.isNaN(e.g)||Number.isNaN(e.b)||Number.isNaN(e.a))&&(e=this._outlineColor),Number.isNaN(t)&&(t=this._outlineThickness);let i=s(e,t);n.hasOwnProperty(i)?h=n[i]:(h=this._outlinePalette.length/5,n[i]=h,this._outlinePalette.push(Math.round(255*e.r),Math.round(255*e.g),Math.round(255*e.b),Math.round(255*e.a),Math.round(255*t)));}this._symbolOutlineParams.push(h);let d=0;if(o&&o.shadow&&(o.shadow.attributes.color||o.shadow.attributes.offset||o.shadow.attributes.offsetX||o.shadow.attributes.offsetY)){let e=o.shadow.attributes.color?f4.fromString(o.shadow.attributes.color):this._shadowColor,t=Number(o.shadow.attributes.offset),s=Number(o.shadow.attributes.offsetX),n=Number(o.shadow.attributes.offsetY);(Number.isNaN(e.r)||Number.isNaN(e.g)||Number.isNaN(e.b)||Number.isNaN(e.a))&&(e=this._shadowColor);let a=f5.set(Number.isNaN(s)?Number.isNaN(t)?this._shadowOffset.x:t:s,Number.isNaN(n)?Number.isNaN(t)?this._shadowOffset.y:t:n),l=i(e,a);r.hasOwnProperty(l)?d=r[l]:(d=this._shadowPalette.length/6,r[l]=d,this._shadowPalette.push(Math.round(255*e.r),Math.round(255*e.g),Math.round(255*e.b),Math.round(255*e.a),Math.round(127*a.x),Math.round(127*a.y)));}this._symbolShadowParams.push(d);}}else this._colorPalette=[],this._symbolColors=null,this._symbolOutlineParams=null,this._symbolShadowParams=null;this._updateMaterialEmissive(),this._updateMaterialOutline(),this._updateMaterialShadow();let n=this._calculateCharsPerTexture(),r=false,a=this._element,o=a._isScreenSpace(),l=a._isScreenCulled(),h=function(e){return a.isVisibleForCamera(e)};for(let e=0,t=this._meshInfo.length;e<t;e++){let t=n[e]||0,s=this._meshInfo[e];if(s.count!==t){if(r||(a.removeModelFromLayers(this._model),r=true),s.count=t,s.positions.length=s.normals.length=12*t,s.indices.length=6*t,s.uvs.length=8*t,s.colors.length=16*t,s.outlines.length=12*t,s.shadows.length=12*t,s.meshInstance&&this._removeMeshInstance(s.meshInstance),0===t){s.meshInstance=null;continue}for(let e=0;e<t;e++)s.indices[6*e+0]=4*e,s.indices[6*e+1]=4*e+1,s.indices[6*e+2]=4*e+3,s.indices[6*e+3]=4*e+2,s.indices[6*e+4]=4*e+3,s.indices[6*e+5]=4*e+1,s.normals[12*e+0]=0,s.normals[12*e+1]=0,s.normals[12*e+2]=-1,s.normals[12*e+3]=0,s.normals[12*e+4]=0,s.normals[12*e+5]=-1,s.normals[12*e+6]=0,s.normals[12*e+7]=0,s.normals[12*e+8]=-1,s.normals[12*e+9]=0,s.normals[12*e+10]=0,s.normals[12*e+11]=-1;let i=new a0(function(e,t){let s=new aG(e);return s.setPositions(t.positions),s.setNormals(t.normals),s.setColors32(t.colors),s.setUvs(0,t.uvs),s.setIndices(t.indices),s.setVertexStream(tm,t.outlines,3,void 0,6,false),s.setVertexStream(t_,t.shadows,3,void 0,6,false),s.update(),s}(this._system.app.graphicsDevice,s),this._material,this._node);if(i.name="Text Element: "+this._entity.name,i.castShadow=false,i.receiveShadow=false,i.cull=!o,i.screenSpace=o,i.drawOrder=this._drawOrder,l&&(i.cull=true,i.isVisibleFunc=h),this._setTextureParams(i,this._font.textures[e]),i.setParameter("material_emissive",this._colorUniform),i.setParameter("material_opacity",this._color.a),i.setParameter("font_sdfIntensity",this._font.intensity),i.setParameter("font_pxrange",this._getPxRange(this._font)),i.setParameter("font_textureWidth",this._font.data.info.maps[e].width),i.setParameter("outline_color",this._outlineColorUniform),i.setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness),i.setParameter("shadow_color",this._shadowColorUniform),this._symbolShadowParams)this._shadowOffsetUniform[0]=0,this._shadowOffsetUniform[1]=0;else {let t=-this._font.data.info.maps[e].width/this._font.data.info.maps[e].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=t*this._shadowOffsetScale*this._shadowOffset.y;}i.setParameter("shadow_offset",this._shadowOffsetUniform),s.meshInstance=i,this._model.meshInstances.push(i);}}this._element.maskedBy&&this._element._setMaskedBy(this._element.maskedBy),r&&this._element.enabled&&this._entity.enabled&&this._element.addModelToLayers(this._model),this._updateMeshes(),this._rangeStart=0,this._rangeEnd=this._symbols.length,this._updateRenderRange();}_removeMeshInstance(e){e.destroy();let t=this._model.meshInstances.indexOf(e);-1!==t&&this._model.meshInstances.splice(t,1);}_setMaterial(e){if(this._material=e,this._model)for(let t=0,s=this._model.meshInstances.length;t<s;t++)this._model.meshInstances[t].material=e;}_updateMaterial(e){let t=this._element,s=t._isScreenCulled(),i=function(e){return t.isVisibleForCamera(e)},n=this._font&&this._font.type===fH;if(this._material=this._system.getTextElementMaterial(e,n,this._enableMarkup),this._model)for(let t=0,n=this._model.meshInstances.length;t<n;t++){let n=this._model.meshInstances[t];n.cull=!e,n.material=this._material,n.screenSpace=e,s?(n.cull=true,n.isVisibleFunc=i):n.isVisibleFunc=null;}}_updateMaterialEmissive(){this._symbolColors?(this._colorUniform[0]=1,this._colorUniform[1]=1,this._colorUniform[2]=1):(f6.linear(this._color),this._colorUniform[0]=f6.r,this._colorUniform[1]=f6.g,this._colorUniform[2]=f6.b);}_updateMaterialOutline(){this._symbolOutlineParams?(this._outlineColorUniform[0]=0,this._outlineColorUniform[1]=0,this._outlineColorUniform[2]=0,this._outlineColorUniform[3]=1):(f6.linear(this._outlineColor),this._outlineColorUniform[0]=f6.r,this._outlineColorUniform[1]=f6.g,this._outlineColorUniform[2]=f6.b,this._outlineColorUniform[3]=f6.a);}_updateMaterialShadow(){this._symbolOutlineParams?(this._shadowColorUniform[0]=0,this._shadowColorUniform[1]=0,this._shadowColorUniform[2]=0,this._shadowColorUniform[3]=0):(f6.linear(this._shadowColor),this._shadowColorUniform[0]=f6.r,this._shadowColorUniform[1]=f6.g,this._shadowColorUniform[2]=f6.b,this._shadowColorUniform[3]=f6.a);}_isWordBoundary(e){return fJ.test(e)}_isValidNextChar(e){return null!==e&&!f1.test(e)}_isNextCJKBoundary(e,t){return f0.test(e)&&(fJ.test(t)||f$.test(t))}_isNextCJKWholeWord(e){return f0.test(e)}_updateMeshes(){let e,t,s,i;let n=this._font.data,r=this,a=Math.min(this._minFontSize,this._maxFontSize),o=this._maxFontSize,l=this._shouldAutoFit();l&&(this._fontSize=this._maxFontSize);let h=this._symbols.length,d=0,c=0,u=0,p=0,f=1,m=0,_=0,g=0,v=0,y=0,S=0,x=Math.abs(this._element.anchor.x-this._element.anchor.z)>=1e-4,T=this._element.calculatedWidth;(!this.autoWidth||x)&&this._wrapLines||(T=Number.POSITIVE_INFINITY);let b=0,E=0;function A(e,t,s){r._lineWidths.push(Math.abs(s));let i=g>t?t+1:g,n=g>t?g+1:t,a=e.slice(i,n);if(S){let e=a.length;for(;e--&&S>0;)fZ.test(a[e])&&(a.splice(e,1),S--);}r._lineContents.push(a.join("")),d=0,c-=r._scaledLineHeight,f++,v=0,y=0,S=0,m=0,g=t;}let w=true;for(;w;){w=false,l?this._scaledLineHeight=this._lineHeight*this._fontSize/(this._maxFontSize||1e-4):this._scaledLineHeight=this._lineHeight,this.width=0,this.height=0,this._lineWidths=[],this._lineContents=[],d=0,c=0,u=0,p=0,f=1,m=0,_=0,g=0,v=0,y=0,S=0;let r=this._fontSize/32;b=this._fontMinY*r,E=this._fontMaxY*r;for(let e=0;e<this._meshInfo.length;e++)this._meshInfo[e].quad=0,this._meshInfo[e].lines={};let x=255,C=255,P=255,M=65535,I=65535,R=0,L=65535,D=65535,O=32639;for(let l=0;l<h;l++){let F,N;if(e=this._symbols[l],i=l+1>=h?null:this._symbols[l+1],fZ.test(e)){S++,(!this._wrapLines||this._maxLines<0||f<this._maxLines)&&(A(this._symbols,l,p),_=l+1,g=l+1);continue}let B=0,U=0,k=0,z=1;if(!(t=n.chars[e])){if(-1!==f2.indexOf(e))t=f3;else if(n.chars[" "])t=n.chars[" "];else for(let e in n.chars){t=n.chars[e];break}}if(t){let e=0;if(y>0){let t=this._font.data.kerning;if(t){let s=t[W.getCodePoint(this._symbols[l-1])||0];s&&(e=s[W.getCodePoint(this._symbols[l])||0]||0);}}F=t.scale||1,z=r*((t.width+t.height)/2)/F,k=(t.xadvance+e)*r,B=(t.xoffset-e)*r,U=t.yoffset*r;}let V=fQ.test(e),G=t&&t.map||0,H=-this._font.data.info.maps[G].width/this._font.data.info.maps[G].height,X=this._meshInfo[G],Y=d+this._spacing*k;if(Y>T&&y>0&&!V&&(this._maxLines<0||f<this._maxLines)){if(0===v)_=l,A(this._symbols,l,p);else {let e=Math.max(l-_,0);if(this._meshInfo.length<=1)X.lines[f-1]-=e,X.quad-=e;else {let e=_,t=l;for(let s=e;s<t;s++){let e=this._symbols[s],t=n.chars[e],i=this._meshInfo[t&&t.map||0];i.lines[f-1]-=1,i.quad-=1;}}l-=e+1,A(this._symbols,_,m);continue}}s=X.quad,X.lines[f-1]=s;let j=d-B,q=j+z,K=c-U,Z=K+z;if(this._rtl){let e=z-B-this._spacing*k-B;j-=e,q-=e;}if(X.positions[12*s+0]=j,X.positions[12*s+1]=K,X.positions[12*s+2]=u,X.positions[12*s+3]=q,X.positions[12*s+4]=K,X.positions[12*s+5]=u,X.positions[12*s+6]=q,X.positions[12*s+7]=Z,X.positions[12*s+8]=u,X.positions[12*s+9]=j,X.positions[12*s+10]=Z,X.positions[12*s+11]=u,this.width=Math.max(this.width,Y),this._shouldAutoFitWidth()&&this.width>this._element.calculatedWidth&&(N=Math.floor(this._element.fontSize*this._element.calculatedWidth/(this.width||1e-4)),(N=ei.clamp(N,a,o))!==this._element.fontSize)||(this.height=Math.max(this.height,E-(c+b)),this._shouldAutoFitHeight()&&this.height>this._element.calculatedHeight&&(N=ei.clamp(this._fontSize-1,a,o))!==this._element.fontSize)){this._fontSize=N,w=true;break}d+=this._spacing*k,V||(p=d),(this._isWordBoundary(e)||this._isValidNextChar(i)&&(this._isNextCJKBoundary(e,i)||this._isNextCJKWholeWord(i)))&&(v++,m=p,_=l+1),y++;let Q=this._getUv(e);if(X.uvs[8*s+0]=Q[0],X.uvs[8*s+1]=1-Q[1],X.uvs[8*s+2]=Q[2],X.uvs[8*s+3]=1-Q[1],X.uvs[8*s+4]=Q[2],X.uvs[8*s+5]=1-Q[3],X.uvs[8*s+6]=Q[0],X.uvs[8*s+7]=1-Q[3],this._symbolColors){let e=3*this._symbolColors[l];x=this._colorPalette[e],C=this._colorPalette[e+1],P=this._colorPalette[e+2];}if(X.colors[16*s+0]=x,X.colors[16*s+1]=C,X.colors[16*s+2]=P,X.colors[16*s+3]=255,X.colors[16*s+4]=x,X.colors[16*s+5]=C,X.colors[16*s+6]=P,X.colors[16*s+7]=255,X.colors[16*s+8]=x,X.colors[16*s+9]=C,X.colors[16*s+10]=P,X.colors[16*s+11]=255,X.colors[16*s+12]=x,X.colors[16*s+13]=C,X.colors[16*s+14]=P,X.colors[16*s+15]=255,this._symbolOutlineParams){let e=5*this._symbolOutlineParams[l];M=this._outlinePalette[e]+256*this._outlinePalette[e+1],I=this._outlinePalette[e+2]+256*this._outlinePalette[e+3],R=this._outlinePalette[e+4];}if(X.outlines[12*s+0]=M,X.outlines[12*s+1]=I,X.outlines[12*s+2]=R,X.outlines[12*s+3]=M,X.outlines[12*s+4]=I,X.outlines[12*s+5]=R,X.outlines[12*s+6]=M,X.outlines[12*s+7]=I,X.outlines[12*s+8]=R,X.outlines[12*s+9]=M,X.outlines[12*s+10]=I,X.outlines[12*s+11]=R,this._symbolShadowParams){let e=6*this._symbolShadowParams[l];L=this._shadowPalette[e]+256*this._shadowPalette[e+1],D=this._shadowPalette[e+2]+256*this._shadowPalette[e+3],O=this._shadowPalette[e+4]+127+256*Math.round(H*this._shadowPalette[e+5]+127);}X.shadows[12*s+0]=L,X.shadows[12*s+1]=D,X.shadows[12*s+2]=O,X.shadows[12*s+3]=L,X.shadows[12*s+4]=D,X.shadows[12*s+5]=O,X.shadows[12*s+6]=L,X.shadows[12*s+7]=D,X.shadows[12*s+8]=O,X.shadows[12*s+9]=L,X.shadows[12*s+10]=D,X.shadows[12*s+11]=O,X.quad++;}!w&&g<h&&A(this._symbols,h,d);}this._noResize=true,this.autoWidth=this._autoWidth,this.autoHeight=this._autoHeight,this._noResize=false;let C=this._element.pivot.x,P=this._element.pivot.y,M=this._alignment.x,I=this._alignment.y;for(let e=0;e<this._meshInfo.length;e++){if(0===this._meshInfo[e].count)continue;let t=0;for(let s in this._meshInfo[e].lines){let i=this._meshInfo[e].lines[s],n=this._lineWidths[parseInt(s,10)],r=-C*this._element.calculatedWidth+M*(this._element.calculatedWidth-n)*(this._rtl?-1:1),a=(1-P)*this._element.calculatedHeight-E-(1-I)*(this._element.calculatedHeight-this.height);for(let s=t;s<=i;s++)this._meshInfo[e].positions[12*s]+=r,this._meshInfo[e].positions[12*s+3]+=r,this._meshInfo[e].positions[12*s+6]+=r,this._meshInfo[e].positions[12*s+9]+=r,this._meshInfo[e].positions[12*s+1]+=a,this._meshInfo[e].positions[12*s+4]+=a,this._meshInfo[e].positions[12*s+7]+=a,this._meshInfo[e].positions[12*s+10]+=a;if(this._rtl)for(let s=t;s<=i;s++){let t=12*s;for(let s=0;s<4;++s)this._meshInfo[e].positions[t+3*s]=this._element.calculatedWidth-this._meshInfo[e].positions[t+3*s]+2*r;let i=this._meshInfo[e].positions[t+3],n=this._meshInfo[e].positions[t+6];this._meshInfo[e].positions[t+3]=this._meshInfo[e].positions[t+0],this._meshInfo[e].positions[t+6]=this._meshInfo[e].positions[t+9],this._meshInfo[e].positions[t+0]=i,this._meshInfo[e].positions[t+9]=n;}t=i+1;}let s=4*this._meshInfo[e].count,i=4*this._meshInfo[e].quad,n=new re(this._meshInfo[e].meshInstance.mesh.vertexBuffer);for(let t=0;t<s;t++)t>=i?(n.element[e2].set(0,0,0),n.element[e7].set(0,0),n.element[e8].set(0,0,0,0),n.element[tm].set(0,0,0,0),n.element[t_].set(0,0,0,0)):(n.element[e2].set(this._meshInfo[e].positions[3*t+0],this._meshInfo[e].positions[3*t+1],this._meshInfo[e].positions[3*t+2]),n.element[e7].set(this._meshInfo[e].uvs[2*t+0],this._meshInfo[e].uvs[2*t+1]),n.element[e8].set(this._meshInfo[e].colors[4*t+0],this._meshInfo[e].colors[4*t+1],this._meshInfo[e].colors[4*t+2],this._meshInfo[e].colors[4*t+3]),n.element[tm].set(this._meshInfo[e].outlines[3*t+0],this._meshInfo[e].outlines[3*t+1],this._meshInfo[e].outlines[3*t+2]),n.element[t_].set(this._meshInfo[e].shadows[3*t+0],this._meshInfo[e].shadows[3*t+1],this._meshInfo[e].shadows[3*t+2])),n.next();n.end(),this._meshInfo[e].meshInstance.mesh.aabb.compute(this._meshInfo[e].positions),this._meshInfo[e].meshInstance._aabbVer=-1;}this._aabbDirty=true;}_onFontRender(){this.font=this._font;}_onFontLoad(e){this.font!==e.resource&&(this.font=e.resource);}_onFontChange(e,t,s,i){if("data"===t){this._font.data=s;let e=this._font.data.info.maps.length;for(let t=0;t<e;t++){if(!this._meshInfo[t])continue;let e=this._meshInfo[t].meshInstance;e&&(e.setParameter("font_sdfIntensity",this._font.intensity),e.setParameter("font_pxrange",this._getPxRange(this._font)),e.setParameter("font_textureWidth",this._font.data.info.maps[t].width));}}}_onFontRemove(e){}_setTextureParams(e,t){this._font&&(this._font.type===fH?(e.deleteParameter("texture_emissiveMap"),e.deleteParameter("texture_opacityMap"),e.setParameter("texture_msdfMap",t)):this._font.type===fW&&(e.deleteParameter("texture_msdfMap"),e.setParameter("texture_emissiveMap",t),e.setParameter("texture_opacityMap",t)));}_getPxRange(e){let t=Object.keys(this._font.data.chars);for(let e=0;e<t.length;e++){let s=this._font.data.chars[t[e]];if(s.range)return (s.scale||1)*s.range}return 2}_getUv(e){let t=this._font.data;if(!t.chars[e])return t.chars[" "]?this._getUv(" "):[0,0,0,0];let s=t.chars[e].map,i=t.info.maps[s].width,n=t.info.maps[s].height,r=t.chars[e].x,a=t.chars[e].y,o=r+t.chars[e].width,l=a-t.chars[e].height,h=1-t.chars[e].height/n;return [r/i,h-a/n,o/i,h-l/n]}onEnable(){this._fontAsset.autoLoad=true,this._model&&this._element.addModelToLayers(this._model);}onDisable(){this._fontAsset.autoLoad=false,this._model&&this._element.removeModelFromLayers(this._model);}_setStencil(e){if(this._model){let t=this._model.meshInstances;for(let s=0;s<t.length;s++)t[s].stencilFront=e,t[s].stencilBack=e;}}_shouldAutoFitWidth(){return this._autoFitWidth&&!this._autoWidth}_shouldAutoFitHeight(){return this._autoFitHeight&&!this._autoHeight}_shouldAutoFit(){return this._autoFitWidth&&!this._autoWidth||this._autoFitHeight&&!this._autoHeight}_calculateCharsPerTexture(e){let t={};void 0===e&&(e=this._symbols.length);for(let s=0,i=e;s<i;s++){let e=this._symbols[s],i=this._font.data.chars[e];i||(i=this._font.data.chars[" "])||(i=this._font.data.chars[Object.keys(this._font.data.chars)[0]]);let n=i.map;t[n]?t[n]++:t[n]=1;}return t}_updateRenderRange(){let e=0===this._rangeStart?0:this._calculateCharsPerTexture(this._rangeStart),t=0===this._rangeEnd?0:this._calculateCharsPerTexture(this._rangeEnd);for(let s=0,i=this._meshInfo.length;s<i;s++){let i=e[s]||0,n=t[s]||0,r=this._meshInfo[s].meshInstance;if(r){let e=r.mesh;e&&(e.primitive[0].base=6*i,e.primitive[0].count=(n-i)*6);}}}set text(e){this._i18nKey=null;let t=null!=e&&e.toString()||"";this._setText(t);}get text(){return this._text}set key(e){let t=null!==e?e.toString():null;this._i18nKey!==t&&(this._i18nKey=t,t?(this._fontAsset.disableLocalization=false,this._resetLocalizedText()):this._fontAsset.disableLocalization=true);}get key(){return this._i18nKey}set color(e){let t=e.r,s=e.g,i=e.b;if(this._color.r!==t||this._color.g!==s||this._color.b!==i){if(this._color.r=t,this._color.g=s,this._color.b=i,this._model){if(this._symbolColors)this._font&&this._updateText();else {f6.linear(this._color),this._colorUniform[0]=f6.r,this._colorUniform[1]=f6.g,this._colorUniform[2]=f6.b;for(let e=0,t=this._model.meshInstances.length;e<t;e++)this._model.meshInstances[e].setParameter("material_emissive",this._colorUniform);}this._element&&this._element.fire("set:color",this._color);}}}get color(){return this._color}set opacity(e){if(this._color.a!==e&&(this._color.a=e,this._model))for(let t=0,s=this._model.meshInstances.length;t<s;t++)this._model.meshInstances[t].setParameter("material_opacity",e);this._element&&this._element.fire("set:opacity",e);}get opacity(){return this._color.a}set lineHeight(e){let t=this._lineHeight;this._lineHeight=e,this._scaledLineHeight=e,t!==e&&this._font&&this._updateText();}get lineHeight(){return this._lineHeight}set wrapLines(e){let t=this._wrapLines;this._wrapLines=e,t!==e&&this._font&&this._updateText();}get wrapLines(){return this._wrapLines}get lines(){return this._lineContents}set spacing(e){let t=this._spacing;this._spacing=e,t!==e&&this._font&&this._updateText();}get spacing(){return this._spacing}set fontSize(e){let t=this._fontSize;this._fontSize=e,this._originalFontSize=e,t!==e&&this._font&&this._updateText();}get fontSize(){return this._fontSize}set fontAsset(e){this._fontAsset.defaultAsset=e;}get fontAsset(){return this._fontAsset.localizedAsset}set font(e){let t;if(this._font&&(t=this._font.type,this._font.off&&this._font.off("render",this._onFontRender,this)),this._font=e,this._fontMinY=0,this._fontMaxY=0,!e)return;let s=this._font.data;for(let e in s.chars){let t=s.chars[e];t.bounds&&(this._fontMinY=Math.min(this._fontMinY,t.bounds[1]),this._fontMaxY=Math.max(this._fontMaxY,t.bounds[3]));}if(this._font.on&&this._font.on("render",this._onFontRender,this),this._fontAsset.localizedAsset&&this._system.app.assets.get(this._fontAsset.localizedAsset).resource!==this._font&&(this._fontAsset.defaultAsset=null),e.type!==t){let e=this._element._isScreenSpace();this._updateMaterial(e);}for(let e=0,t=this._font.textures.length;e<t;e++)if(this._meshInfo[e]){let t=this._meshInfo[e].meshInstance;t&&(t.setParameter("font_sdfIntensity",this._font.intensity),t.setParameter("font_pxrange",this._getPxRange(this._font)),t.setParameter("font_textureWidth",this._font.data.info.maps[e].width),this._setTextureParams(t,this._font.textures[e]));}else this._meshInfo[e]=new fK;let i=false;for(let e=this._font.textures.length;e<this._meshInfo.length;e++)this._meshInfo[e].meshInstance&&(i||(this._element.removeModelFromLayers(this._model),i=true),this._removeMeshInstance(this._meshInfo[e].meshInstance));this._meshInfo.length>this._font.textures.length&&(this._meshInfo.length=this._font.textures.length),this._updateText();}get font(){return this._font}set alignment(e){e instanceof ef?this._alignment.set(e.x,e.y):this._alignment.set(e[0],e[1]),this._font&&this._updateText();}get alignment(){return this._alignment}set autoWidth(e){let t=this._autoWidth;if(this._autoWidth=e,e&&1e-4>Math.abs(this._element.anchor.x-this._element.anchor.z)&&(this._element.width=this.width),t!==e){let e=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize;e!==this._fontSize&&(this._fontSize=e,this._font&&this._updateText());}}get autoWidth(){return this._autoWidth}set autoHeight(e){let t=this._autoHeight;if(this._autoHeight=e,e&&1e-4>Math.abs(this._element.anchor.y-this._element.anchor.w)&&(this._element.height=this.height),t!==e){let e=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize;e!==this._fontSize&&(this._fontSize=e,this._font&&this._updateText());}}get autoHeight(){return this._autoHeight}set rtlReorder(e){this._rtlReorder!==e&&(this._rtlReorder=e,this._font&&this._updateText());}get rtlReorder(){return this._rtlReorder}set unicodeConverter(e){this._unicodeConverter!==e&&(this._unicodeConverter=e,this._setText(this._text));}get unicodeConverter(){return this._unicodeConverter}get aabb(){if(this._aabbDirty){let e=false;for(let t=0;t<this._meshInfo.length;t++)this._meshInfo[t].meshInstance&&(e?this._aabb.add(this._meshInfo[t].meshInstance.aabb):(this._aabb.copy(this._meshInfo[t].meshInstance.aabb),e=true));this._aabbDirty=false;}return this._aabb}set outlineColor(e){let t=e instanceof en?e.r:e[0],s=e instanceof en?e.g:e[1],i=e instanceof en?e.b:e[2],n=e instanceof en?e.a:e[3];if(this._outlineColor.r!==t||this._outlineColor.g!==s||this._outlineColor.b!==i||this._outlineColor.a!==n){if(this._outlineColor.r=t,this._outlineColor.g=s,this._outlineColor.b=i,this._outlineColor.a=n,this._model){if(this._symbolOutlineParams)this._font&&this._updateText();else {f6.linear(this._outlineColor),this._outlineColorUniform[0]=f6.r,this._outlineColorUniform[1]=f6.g,this._outlineColorUniform[2]=f6.b,this._outlineColorUniform[3]=f6.a;for(let e=0,t=this._model.meshInstances.length;e<t;e++)this._model.meshInstances[e].setParameter("outline_color",this._outlineColorUniform);}this._element&&this._element.fire("set:outline",this._color);}}}get outlineColor(){return this._outlineColor}set outlineThickness(e){let t=this._outlineThickness;if(this._outlineThickness=e,t!==e&&this._font){if(!this._model)return;if(this._symbolOutlineParams)this._font&&this._updateText();else for(let e=0,t=this._model.meshInstances.length;e<t;e++)this._model.meshInstances[e].setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness);}}get outlineThickness(){return this._outlineThickness}set shadowColor(e){let t=e instanceof en?e.r:e[0],s=e instanceof en?e.g:e[1],i=e instanceof en?e.b:e[2],n=e instanceof en?e.a:e[3];if(this._shadowColor.r!==t||this._shadowColor.g!==s||this._shadowColor.b!==i||this._shadowColor.a!==n){if(this._shadowColor.r=t,this._shadowColor.g=s,this._shadowColor.b=i,this._shadowColor.a=n,this._model){if(this._symbolShadowParams)this._font&&this._updateText();else {f6.linear(this._shadowColor),this._shadowColorUniform[0]=f6.r,this._shadowColorUniform[1]=f6.g,this._shadowColorUniform[2]=f6.b,this._shadowColorUniform[3]=f6.a;for(let e=0,t=this._model.meshInstances.length;e<t;e++)this._model.meshInstances[e].setParameter("shadow_color",this._shadowColorUniform);}}}}get shadowColor(){return this._shadowColor}set shadowOffset(e){let t=e instanceof ef?e.x:e[0],s=e instanceof ef?e.y:e[1];if((this._shadowOffset.x!==t||this._shadowOffset.y!==s)&&(this._shadowOffset.set(t,s),this._font&&this._model)){if(this._symbolShadowParams)this._updateText();else for(let e=0,t=this._model.meshInstances.length;e<t;e++){let t=-this._font.data.info.maps[e].width/this._font.data.info.maps[e].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=t*this._shadowOffsetScale*this._shadowOffset.y,this._model.meshInstances[e].setParameter("shadow_offset",this._shadowOffsetUniform);}}}get shadowOffset(){return this._shadowOffset}set minFontSize(e){this._minFontSize!==e&&(this._minFontSize=e,this.font&&this._shouldAutoFit()&&this._updateText());}get minFontSize(){return this._minFontSize}set maxFontSize(e){this._maxFontSize!==e&&(this._maxFontSize=e,this.font&&this._shouldAutoFit()&&this._updateText());}get maxFontSize(){return this._maxFontSize}set autoFitWidth(e){this._autoFitWidth!==e&&(this._autoFitWidth=e,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText());}get autoFitWidth(){return this._autoFitWidth}set autoFitHeight(e){this._autoFitHeight!==e&&(this._autoFitHeight=e,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText());}get autoFitHeight(){return this._autoFitHeight}set maxLines(e){this._maxLines!==e&&(null!==e||-1!==this._maxLines)&&(this._maxLines=null===e?-1:e,this.font&&this._wrapLines&&this._updateText());}get maxLines(){return this._maxLines}set enableMarkup(e){if(e=!!e,this._enableMarkup===e)return;this._enableMarkup=e,this.font&&this._updateText();let t=this._element._isScreenSpace();this._updateMaterial(t);}get enableMarkup(){return this._enableMarkup}get symbols(){return this._symbols}get symbolColors(){return null===this._symbolColors?null:this._symbolColors.map(function(e){return this._colorPalette.slice(3*e,3*e+3)},this)}get symbolOutlineParams(){return null===this._symbolOutlineParams?null:this._symbolOutlineParams.map(function(e){return this._outlinePalette.slice(5*e,5*e+5)},this)}get symbolShadowParams(){return null===this._symbolShadowParams?null:this._symbolShadowParams.map(function(e){return this._shadowPalette.slice(6*e,6*e+6)},this)}get rtl(){return this._rtl}set rangeStart(e){(e=Math.max(0,Math.min(e,this._symbols.length)))!==this._rangeStart&&(this._rangeStart=e,this._updateRenderRange());}get rangeStart(){return this._rangeStart}set rangeEnd(e){(e=Math.max(this._rangeStart,Math.min(e,this._symbols.length)))!==this._rangeEnd&&(this._rangeEnd=e,this._updateRenderRange());}get rangeEnd(){return this._rangeEnd}constructor(e){this._element=e,this._system=e.system,this._entity=e.entity,this._text="",this._symbols=[],this._colorPalette=[],this._outlinePalette=[],this._shadowPalette=[],this._symbolColors=null,this._symbolOutlineParams=null,this._symbolShadowParams=null,this._i18nKey=null,this._fontAsset=new fG(this._system.app),this._fontAsset.disableLocalization=true,this._fontAsset.on("load",this._onFontLoad,this),this._fontAsset.on("change",this._onFontChange,this),this._fontAsset.on("remove",this._onFontRemove,this),this._font=null,this._color=new en(1,1,1,1),this._colorUniform=new Float32Array(3),this._spacing=1,this._fontSize=32,this._fontMinY=0,this._fontMaxY=0,this._originalFontSize=32,this._maxFontSize=32,this._minFontSize=8,this._autoFitWidth=false,this._autoFitHeight=false,this._maxLines=-1,this._lineHeight=32,this._scaledLineHeight=32,this._wrapLines=false,this._drawOrder=0,this._alignment=new ef(.5,.5),this._autoWidth=true,this._autoHeight=true,this.width=0,this.height=0,this._node=new oE,this._model=new hh,this._model.graph=this._node,this._entity.addChild(this._node),this._meshInfo=[],this._material=null,this._aabbDirty=true,this._aabb=new eP,this._noResize=false,this._currentMaterialType=null,this._maskedMaterialSrc=null,this._rtlReorder=false,this._unicodeConverter=false,this._rtl=false,this._outlineColor=new en(0,0,0,1),this._outlineColorUniform=new Float32Array(4),this._outlineThicknessScale=.2,this._outlineThickness=0,this._shadowColor=new en(0,0,0,1),this._shadowColorUniform=new Float32Array(4),this._shadowOffsetScale=.005,this._shadowOffset=new ef(0,0),this._shadowOffsetUniform=new Float32Array(2),this._enableMarkup=false,this._onScreenChange(this._element.screen),e.on("resize",this._onParentResize,this),e.on("set:screen",this._onScreenChange,this),e.on("screen:set:screenspace",this._onScreenSpaceChange,this),e.on("set:draworder",this._onDrawOrderChange,this),e.on("set:pivot",this._onPivotChange,this),this._system.app.i18n.on("set:locale",this._onLocaleSet,this),this._system.app.i18n.on("data:add",this._onLocalizationData,this),this._system.app.i18n.on("data:remove",this._onLocalizationData,this),this._rangeStart=0,this._rangeEnd=0;}}let f9=new eu,f7=new ex,me=new eu,mt=new eu,ms=new ex,mi=new ex,mn=new ex,mr=new ex;class ma extends u8{get data(){let e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){let t=this.data,s=t.enabled;t.enabled=e,this.fire("set","enabled",s,e);}get enabled(){return this.data.enabled}get _absLeft(){return this._localAnchor.x+this._margin.x}get _absRight(){return this._localAnchor.z-this._margin.z}get _absTop(){return this._localAnchor.w-this._margin.w}get _absBottom(){return this._localAnchor.y+this._margin.y}get _hasSplitAnchorsX(){return Math.abs(this._anchor.x-this._anchor.z)>.001}get _hasSplitAnchorsY(){return Math.abs(this._anchor.y-this._anchor.w)>.001}get aabb(){return this._image?this._image.aabb:this._text?this._text.aabb:null}set anchor(e){e instanceof em?this._anchor.copy(e):this._anchor.set(...e),this.entity._parent||this.screen?this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY):this._calculateLocalAnchors(),this._anchorDirty=true,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:anchor",this._anchor);}get anchor(){return this._anchor}set batchGroupId(e){var t,s;this._batchGroupId!==e&&(this.entity.enabled&&this._batchGroupId>=0&&(null==(t=this.system.app.batcher)||t.remove(aF.ELEMENT,this.batchGroupId,this.entity)),this.entity.enabled&&e>=0&&(null==(s=this.system.app.batcher)||s.insert(aF.ELEMENT,e,this.entity)),e<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&(this._image&&this._image._renderable.model?this.addModelToLayers(this._image._renderable.model):this._text&&this._text._model&&this.addModelToLayers(this._text._model)),this._batchGroupId=e);}get batchGroupId(){return this._batchGroupId}set bottom(e){this._margin.y=e;let t=this.entity.getLocalPosition(),s=this._absTop,i=this._localAnchor.y+e;this._setHeight(s-i),t.y=e+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(t);}get bottom(){return this._margin.y}set calculatedWidth(e){this._setCalculatedWidth(e,true);}get calculatedWidth(){return this._calculatedWidth}set calculatedHeight(e){this._setCalculatedHeight(e,true);}get calculatedHeight(){return this._calculatedHeight}get canvasCorners(){if(!this._canvasCornersDirty||!this.screen||!this.screen.screen.screenSpace)return this._canvasCorners;let e=this.system.app.graphicsDevice,t=this.screenCorners,s=e.canvas.clientWidth/e.width,i=e.canvas.clientHeight/e.height;for(let n=0;n<4;n++)this._canvasCorners[n].set(t[n].x*s,(e.height-t[n].y)*i);return this._canvasCornersDirty=false,this._canvasCorners}set drawOrder(e){let t=0;this.screen&&(t=this.screen.screen.priority),e>0xffffff&&(e=0xffffff),this._drawOrder=(t<<24)+e,this.fire("set:draworder",this._drawOrder);}get drawOrder(){return this._drawOrder}set height(e){this._height=e,this._hasSplitAnchorsY||this._setCalculatedHeight(e,true),this.fire("set:height",this._height);}get height(){return this._height}set layers(e){if(this._addedModels.length)for(let e=0;e<this._layers.length;e++){let t=this.system.app.scene.layers.getLayerById(this._layers[e]);if(t)for(let e=0;e<this._addedModels.length;e++)t.removeMeshInstances(this._addedModels[e].meshInstances);}if(this._layers=e,this.enabled&&this.entity.enabled&&this._addedModels.length)for(let e=0;e<this._layers.length;e++){let t=this.system.app.scene.layers.getLayerById(this._layers[e]);if(t)for(let e=0;e<this._addedModels.length;e++)t.addMeshInstances(this._addedModels[e].meshInstances);}}get layers(){return this._layers}set left(e){this._margin.x=e;let t=this.entity.getLocalPosition(),s=this._absRight,i=this._localAnchor.x+e;this._setWidth(s-i),t.x=e+this._calculatedWidth*this._pivot.x,this.entity.setLocalPosition(t);}get left(){return this._margin.x}set margin(e){this._margin.copy(e),this._calculateSize(true,true),this.fire("set:margin",this._margin);}get margin(){return this._margin}get maskedBy(){return this._maskedBy}set pivot(e){let{pivot:t,margin:s}=this,i=t.x,n=t.y;e instanceof ef?t.copy(e):t.set(...e);let r=s.x+s.z,a=t.x-i;s.x+=r*a,s.z-=r*a;let o=s.y+s.w,l=t.y-n;s.y+=o*l,s.w-=o*l,this._anchorDirty=true,this._cornersDirty=true,this._worldCornersDirty=true,this._calculateSize(false,false),this._flagChildrenAsDirty(),this.fire("set:pivot",t);}get pivot(){return this._pivot}set right(e){this._margin.z=e;let t=this.entity.getLocalPosition(),s=this._absLeft,i=this._localAnchor.z-e;this._setWidth(i-s),t.x=this._localAnchor.z-this._localAnchor.x-e-this._calculatedWidth*(1-this._pivot.x),this.entity.setLocalPosition(t);}get right(){return this._margin.z}get screenCorners(){if(!this._cornersDirty||!this.screen)return this._screenCorners;let e=this.entity.parent&&this.entity.parent.element&&this.entity.parent.element.screenCorners[0];this._screenCorners[0].set(this._absLeft,this._absBottom,0),this._screenCorners[1].set(this._absRight,this._absBottom,0),this._screenCorners[2].set(this._absRight,this._absTop,0),this._screenCorners[3].set(this._absLeft,this._absTop,0);let t=this.screen.screen.screenSpace;for(let s=0;s<4;s++)this._screenTransform.transformPoint(this._screenCorners[s],this._screenCorners[s]),t&&this._screenCorners[s].mulScalar(this.screen.screen.scale),e&&this._screenCorners[s].add(e);return this._cornersDirty=false,this._canvasCornersDirty=true,this._worldCornersDirty=true,this._screenCorners}get textWidth(){return this._text?this._text.width:0}get textHeight(){return this._text?this._text.height:0}set top(e){this._margin.w=e;let t=this.entity.getLocalPosition(),s=this._absBottom,i=this._localAnchor.w-e;this._setHeight(i-s),t.y=this._localAnchor.w-this._localAnchor.y-e-this._calculatedHeight*(1-this._pivot.y),this.entity.setLocalPosition(t);}get top(){return this._margin.w}set type(e){e!==this._type&&(this._type=e,this._image&&(this._image.destroy(),this._image=null),this._text&&(this._text.destroy(),this._text=null),e===ft?this._image=new fV(this):e===fs&&(this._text=new f8(this)));}get type(){return this._type}set useInput(e){this._useInput!==e&&(this._useInput=e,this.system.app.elementInput?e?this.enabled&&this.entity.enabled&&this.system.app.elementInput.addElement(this):this.system.app.elementInput.removeElement(this):this._useInput,this.fire("set:useInput",e));}get useInput(){return this._useInput}set fitMode(e){this._fitMode=e,this._calculateSize(true,true),this._image&&this._image.refreshMesh();}get fitMode(){return this._fitMode}set width(e){this._width=e,this._hasSplitAnchorsX||this._setCalculatedWidth(e,true),this.fire("set:width",this._width);}get width(){return this._width}get worldCorners(){if(!this._worldCornersDirty)return this._worldCorners;if(this.screen){let e=this.screenCorners;if(!this.screen.screen.screenSpace){ms.copy(this.screen.screen._screenMatrix),ms.data[13]=-ms.data[13],ms.mul2(this.screen.getWorldTransform(),ms);for(let t=0;t<4;t++)ms.transformPoint(e[t],this._worldCorners[t]);}}else {let e=this.entity.getLocalPosition();ms.setTranslate(-e.x,-e.y,-e.z),mi.setTRS(eu.ZERO,this.entity.getLocalRotation(),this.entity.getLocalScale()),mn.setTranslate(e.x,e.y,e.z);let t=this.entity.parent?this.entity.parent:this.entity;mr.copy(t.getWorldTransform()),mr.mul(mn).mul(mi).mul(ms),me.set(e.x-this.pivot.x*this.calculatedWidth,e.y-this.pivot.y*this.calculatedHeight,e.z),mr.transformPoint(me,this._worldCorners[0]),me.set(e.x+(1-this.pivot.x)*this.calculatedWidth,e.y-this.pivot.y*this.calculatedHeight,e.z),mr.transformPoint(me,this._worldCorners[1]),me.set(e.x+(1-this.pivot.x)*this.calculatedWidth,e.y+(1-this.pivot.y)*this.calculatedHeight,e.z),mr.transformPoint(me,this._worldCorners[2]),me.set(e.x-this.pivot.x*this.calculatedWidth,e.y+(1-this.pivot.y)*this.calculatedHeight,e.z),mr.transformPoint(me,this._worldCorners[3]);}return this._worldCornersDirty=false,this._worldCorners}set fontSize(e){this._setValue("fontSize",e);}get fontSize(){return this._text?this._text.fontSize:null}set minFontSize(e){this._setValue("minFontSize",e);}get minFontSize(){return this._text?this._text.minFontSize:null}set maxFontSize(e){this._setValue("maxFontSize",e);}get maxFontSize(){return this._text?this._text.maxFontSize:null}set maxLines(e){this._setValue("maxLines",e);}get maxLines(){return this._text?this._text.maxLines:null}set autoFitWidth(e){this._setValue("autoFitWidth",e);}get autoFitWidth(){return this._text?this._text.autoFitWidth:null}set autoFitHeight(e){this._setValue("autoFitHeight",e);}get autoFitHeight(){return this._text?this._text.autoFitHeight:null}set color(e){this._setValue("color",e);}get color(){return this._text?this._text.color:this._image?this._image.color:null}set font(e){this._setValue("font",e);}get font(){return this._text?this._text.font:null}set fontAsset(e){this._setValue("fontAsset",e);}get fontAsset(){return this._text&&"number"==typeof this._text.fontAsset?this._text.fontAsset:null}set spacing(e){this._setValue("spacing",e);}get spacing(){return this._text?this._text.spacing:null}set lineHeight(e){this._setValue("lineHeight",e);}get lineHeight(){return this._text?this._text.lineHeight:null}set wrapLines(e){this._setValue("wrapLines",e);}get wrapLines(){return this._text?this._text.wrapLines:null}set lines(e){this._setValue("lines",e);}get lines(){return this._text?this._text.lines:null}set alignment(e){this._setValue("alignment",e);}get alignment(){return this._text?this._text.alignment:null}set autoWidth(e){this._setValue("autoWidth",e);}get autoWidth(){return this._text?this._text.autoWidth:null}set autoHeight(e){this._setValue("autoHeight",e);}get autoHeight(){return this._text?this._text.autoHeight:null}set rtlReorder(e){this._setValue("rtlReorder",e);}get rtlReorder(){return this._text?this._text.rtlReorder:null}set unicodeConverter(e){this._setValue("unicodeConverter",e);}get unicodeConverter(){return this._text?this._text.unicodeConverter:null}set text(e){this._setValue("text",e);}get text(){return this._text?this._text.text:null}set key(e){this._setValue("key",e);}get key(){return this._text?this._text.key:null}set texture(e){this._setValue("texture",e);}get texture(){return this._image?this._image.texture:null}set textureAsset(e){this._setValue("textureAsset",e);}get textureAsset(){return this._image?this._image.textureAsset:null}set material(e){this._setValue("material",e);}get material(){return this._image?this._image.material:null}set materialAsset(e){this._setValue("materialAsset",e);}get materialAsset(){return this._image?this._image.materialAsset:null}set sprite(e){this._setValue("sprite",e);}get sprite(){return this._image?this._image.sprite:null}set spriteAsset(e){this._setValue("spriteAsset",e);}get spriteAsset(){return this._image?this._image.spriteAsset:null}set spriteFrame(e){this._setValue("spriteFrame",e);}get spriteFrame(){return this._image?this._image.spriteFrame:null}set pixelsPerUnit(e){this._setValue("pixelsPerUnit",e);}get pixelsPerUnit(){return this._image?this._image.pixelsPerUnit:null}set opacity(e){this._setValue("opacity",e);}get opacity(){return this._text?this._text.opacity:this._image?this._image.opacity:null}set rect(e){this._setValue("rect",e);}get rect(){return this._image?this._image.rect:null}set mask(e){this._setValue("mask",e);}get mask(){return this._image?this._image.mask:null}set outlineColor(e){this._setValue("outlineColor",e);}get outlineColor(){return this._text?this._text.outlineColor:null}set outlineThickness(e){this._setValue("outlineThickness",e);}get outlineThickness(){return this._text?this._text.outlineThickness:null}set shadowColor(e){this._setValue("shadowColor",e);}get shadowColor(){return this._text?this._text.shadowColor:null}set shadowOffset(e){this._setValue("shadowOffset",e);}get shadowOffset(){return this._text?this._text.shadowOffset:null}set enableMarkup(e){this._setValue("enableMarkup",e);}get enableMarkup(){return this._text?this._text.enableMarkup:null}set rangeStart(e){this._setValue("rangeStart",e);}get rangeStart(){return this._text?this._text.rangeStart:null}set rangeEnd(e){this._setValue("rangeEnd",e);}get rangeEnd(){return this._text?this._text.rangeEnd:null}_setValue(e,t){this._text?(this._text[e]!==t&&this._dirtyBatch(),this._text[e]=t):this._image&&(this._image[e]!==t&&this._dirtyBatch(),this._image[e]=t);}_patch(){this.entity._sync=this._sync,this.entity.setPosition=this._setPosition,this.entity.setLocalPosition=this._setLocalPosition;}_unpatch(){this.entity._sync=uG.prototype._sync,this.entity.setPosition=uG.prototype.setPosition,this.entity.setLocalPosition=uG.prototype.setLocalPosition;}_setPosition(e,t,s){if(!this.element.screen){uG.prototype.setPosition.call(this,e,t,s);return}e instanceof eu?f9.copy(e):f9.set(e,t,s),this.getWorldTransform(),f7.copy(this.element._screenToWorld).invert(),f7.transformPoint(f9,this.localPosition),this._dirtyLocal||this._dirtifyLocal();}_setLocalPosition(e,t,s){e instanceof eu?this.localPosition.copy(e):this.localPosition.set(e,t,s);let i=this.element,n=this.localPosition,r=i._pivot;i._margin.x=n.x-i._calculatedWidth*r.x,i._margin.z=i._localAnchor.z-i._localAnchor.x-i._calculatedWidth-i._margin.x,i._margin.y=n.y-i._calculatedHeight*r.y,i._margin.w=i._localAnchor.w-i._localAnchor.y-i._calculatedHeight-i._margin.y,this._dirtyLocal||this._dirtifyLocal();}_sync(){let e=this.element,t=e.screen;if(t){if(e._anchorDirty){let s=0,i=0,n=0,r=1;if(this._parent&&this._parent.element)s=this._parent.element.calculatedWidth,i=this._parent.element.calculatedHeight,n=this._parent.element.pivot.x,r=this._parent.element.pivot.y;else {let e=t.screen.resolution;s=e.x/t.screen.scale,i=e.y/t.screen.scale;}e._anchorTransform.setTranslate(s*(e.anchor.x-n),-(i*(r-e.anchor.y)),0),e._anchorDirty=false,e._calculateLocalAnchors();}e._sizeDirty&&e._calculateSize(false,false);}if(this._dirtyLocal){this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale);let t=this.localPosition,s=e._pivot;e._margin.x=t.x-e._calculatedWidth*s.x,e._margin.z=e._localAnchor.z-e._localAnchor.x-e._calculatedWidth-e._margin.x,e._margin.y=t.y-e._calculatedHeight*s.y,e._margin.w=e._localAnchor.w-e._localAnchor.y-e._calculatedHeight-e._margin.y,this._dirtyLocal=false;}if(!t){this._dirtyWorld&&(e._cornersDirty=true,e._canvasCornersDirty=true,e._worldCornersDirty=true),uG.prototype._sync.call(this);return}if(this._dirtyWorld){if(null===this._parent)this.worldTransform.copy(this.localTransform);else if(this._parent.element?e._screenToWorld.mul2(this._parent.element._modelTransform,e._anchorTransform):e._screenToWorld.copy(e._anchorTransform),e._modelTransform.mul2(e._screenToWorld,this.localTransform),t){e._screenToWorld.mul2(t.screen._screenMatrix,e._screenToWorld),t.screen.screenSpace||e._screenToWorld.mul2(t.worldTransform,e._screenToWorld),this.worldTransform.mul2(e._screenToWorld,this.localTransform);let s=e._parentWorldTransform;s.setIdentity();let i=this._parent;i&&i.element&&i!==t&&(ms.setTRS(eu.ZERO,i.getLocalRotation(),i.getLocalScale()),s.mul2(i.element._parentWorldTransform,ms)),me.set(0,0,this.localPosition.z),mt.set(e._absLeft+e._pivot.x*e.calculatedWidth,e._absBottom+e._pivot.y*e.calculatedHeight,0),ms.setTranslate(-mt.x,-mt.y,-mt.z),mi.setTRS(me,this.getLocalRotation(),this.getLocalScale()),mn.setTranslate(mt.x,mt.y,mt.z),e._screenTransform.mul2(e._parentWorldTransform,mn).mul(mi).mul(ms),e._cornersDirty=true,e._canvasCornersDirty=true,e._worldCornersDirty=true;}else this.worldTransform.copy(e._modelTransform);this._dirtyWorld=false;}}_onInsert(e){let t=this._parseUpToScreen();this.entity._dirtifyWorld(),this._updateScreen(t.screen),this._dirtifyMask();}_dirtifyMask(){let e=this.entity;for(;e;){let t=e.parent;if((null===t||t.screen)&&e.element){this.system._prerender&&this.system._prerender.length||(this.system._prerender=[],this.system.app.once("prerender",this._onPrerender,this));let t=this.system._prerender.indexOf(this.entity);t>=0&&this.system._prerender.splice(t,1),0>this.system._prerender.indexOf(e)&&this.system._prerender.push(e);}e=t;}}_onPrerender(){for(let e=0;e<this.system._prerender.length;e++){let t=this.system._prerender[e];t.element&&t.element.syncMask(1);}this.system._prerender.length=0;}_bindScreen(e){e._bindElement(this);}_unbindScreen(e){e._unbindElement(this);}_updateScreen(e){this.screen&&this.screen!==e&&this._unbindScreen(this.screen.screen);let t=this.screen;this.screen=e,this.screen&&this._bindScreen(this.screen.screen),this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("set:screen",this.screen,t),this._anchorDirty=true;let s=this.entity.children;for(let t=0,i=s.length;t<i;t++)s[t].element&&s[t].element._updateScreen(e);this.screen&&this.screen.screen.syncDrawOrder();}syncMask(e){let t=this._parseUpToScreen();this._updateMask(t.mask,e);}_setMaskedBy(e){let t=this._image||this._text;if(e){let s=e.element._image._maskRef;null==t||t._setStencil(new sC({ref:s,func:2})),this._maskedBy=e;}else null==t||t._setStencil(null),this._maskedBy=null;}_updateMask(e,t){var s,i;if(e){if(this._setMaskedBy(e),this.mask){let s=new sC({ref:e.element._image._maskRef,func:2,zpass:3});this._image._setStencil(s),this._image._maskRef=t,t++,e=this.entity;}let i=this.entity.children;for(let n=0,r=i.length;n<r;n++)null==(s=i[n].element)||s._updateMask(e,t);this.mask&&t--;}else {if(this._setMaskedBy(null),this.mask){let s=new sC({ref:t,func:7,zpass:2});this._image._setStencil(s),this._image._maskRef=t,t++,e=this.entity;}let s=this.entity.children;for(let n=0,r=s.length;n<r;n++)null==(i=s[n].element)||i._updateMask(e,t);this.mask&&t--;}}_parseUpToScreen(){let e={screen:null,mask:null},t=this.entity._parent;for(;t&&!t.screen;)t.element&&t.element.mask&&!e.mask&&(e.mask=t),t=t.parent;return t&&t.screen&&(e.screen=t),e}_onScreenResize(e){this._anchorDirty=true,this._cornersDirty=true,this._worldCornersDirty=true,this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("screen:set:resolution",e);}_onScreenSpaceChange(){this.fire("screen:set:screenspace",this.screen.screen.screenSpace);}_onScreenRemove(){this.screen&&(this.screen._destroying?this.screen=null:this._updateScreen(null));}_calculateLocalAnchors(){let e=1e3,t=1e3,s=this.entity._parent;if(s&&s.element)e=s.element.calculatedWidth,t=s.element.calculatedHeight;else if(this.screen){let s=this.screen.screen.resolution,i=this.screen.screen.scale;e=s.x/i,t=s.y/i;}this._localAnchor.set(this._anchor.x*e,this._anchor.y*t,this._anchor.z*e,this._anchor.w*t);}getOffsetPosition(e,t){let s=this.entity.getLocalPosition().clone();return s.x+=e,s.y+=t,this._screenToWorld.transformPoint(s,s),s}onLayersChanged(e,t){this.addModelToLayers(this._image?this._image._renderable.model:this._text._model),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this);}onLayerAdded(e){!(0>this.layers.indexOf(e.id))&&(this._image?e.addMeshInstances(this._image._renderable.model.meshInstances):this._text&&e.addMeshInstances(this._text._model.meshInstances));}onLayerRemoved(e){!(0>this.layers.indexOf(e.id))&&(this._image?e.removeMeshInstances(this._image._renderable.model.meshInstances):this._text&&e.removeMeshInstances(this._text._model.meshInstances));}onEnable(){let e=this.system.app.scene,t=e.layers;if(this._image&&this._image.onEnable(),this._text&&this._text.onEnable(),this._group&&this._group.onEnable(),this.useInput&&this.system.app.elementInput&&this.system.app.elementInput.addElement(this),this._evtLayersChanged=e.on("set:layers",this.onLayersChanged,this),t&&(this._evtLayerAdded=t.on("add",this.onLayerAdded,this),this._evtLayerRemoved=t.on("remove",this.onLayerRemoved,this)),this._batchGroupId>=0){var s;null==(s=this.system.app.batcher)||s.insert(aF.ELEMENT,this.batchGroupId,this.entity);}this.fire("enableelement");}onDisable(){var e,t,s,i;let n=this.system.app.scene.layers;null==(e=this._evtLayersChanged)||e.off(),this._evtLayersChanged=null,n&&(null==(t=this._evtLayerAdded)||t.off(),this._evtLayerAdded=null,null==(s=this._evtLayerRemoved)||s.off(),this._evtLayerRemoved=null),this._image&&this._image.onDisable(),this._text&&this._text.onDisable(),this._group&&this._group.onDisable(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),this._batchGroupId>=0&&(null==(i=this.system.app.batcher)||i.remove(aF.ELEMENT,this.batchGroupId,this.entity)),this.fire("disableelement");}onRemove(){this.entity.off("insert",this._onInsert,this),this._unpatch(),this._image&&this._image.destroy(),this._text&&this._text.destroy(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),this.screen&&this.screen.screen&&(this._unbindScreen(this.screen.screen),this.screen.screen.syncDrawOrder()),this.off();}_calculateSize(e,t){if(!this.entity._parent&&!this.screen)return;this._calculateLocalAnchors();let s=this._absRight-this._absLeft,i=this._absTop-this._absBottom;e?this._setWidth(s):this._setCalculatedWidth(s,false),t?this._setHeight(i):this._setCalculatedHeight(i,false);let n=this.entity.getLocalPosition();n.x=this._margin.x+this._calculatedWidth*this._pivot.x,n.y=this._margin.y+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(n),this._sizeDirty=false;}_setWidth(e){this._width=e,this._setCalculatedWidth(e,false),this.fire("set:width",this._width);}_setHeight(e){this._height=e,this._setCalculatedHeight(e,false),this.fire("set:height",this._height);}_setCalculatedWidth(e,t){if(!(1e-4>=Math.abs(e-this._calculatedWidth))){if(this._calculatedWidth=e,this.entity._dirtifyLocal(),t){let e=this.entity.getLocalPosition(),t=this._pivot;this._margin.x=e.x-this._calculatedWidth*t.x,this._margin.z=this._localAnchor.z-this._localAnchor.x-this._calculatedWidth-this._margin.x;}this._flagChildrenAsDirty(),this.fire("set:calculatedWidth",this._calculatedWidth),this.fire("resize",this._calculatedWidth,this._calculatedHeight);}}_setCalculatedHeight(e,t){if(!(1e-4>=Math.abs(e-this._calculatedHeight))){if(this._calculatedHeight=e,this.entity._dirtifyLocal(),t){let e=this.entity.getLocalPosition(),t=this._pivot;this._margin.y=e.y-this._calculatedHeight*t.y,this._margin.w=this._localAnchor.w-this._localAnchor.y-this._calculatedHeight-this._margin.y;}this._flagChildrenAsDirty(),this.fire("set:calculatedHeight",this._calculatedHeight),this.fire("resize",this._calculatedWidth,this._calculatedHeight);}}_flagChildrenAsDirty(){let e=this.entity._children;for(let t=0,s=e.length;t<s;t++)e[t].element&&(e[t].element._anchorDirty=true,e[t].element._sizeDirty=true);}addModelToLayers(e){this._addedModels.push(e);for(let t=0;t<this.layers.length;t++){let s=this.system.app.scene.layers.getLayerById(this.layers[t]);s&&s.addMeshInstances(e.meshInstances);}}removeModelFromLayers(e){let t=this._addedModels.indexOf(e);t>=0&&this._addedModels.splice(t,1);for(let t=0;t<this.layers.length;t++){let s=this.system.app.scene.layers.getLayerById(this.layers[t]);s&&s.removeMeshInstances(e.meshInstances);}}getMaskOffset(){let e=this.system.app.frame;this._offsetReadAt!==e&&(this._maskOffset=.5,this._offsetReadAt=e);let t=this._maskOffset;return this._maskOffset-=.001,t}isVisibleForCamera(e){let t,s,i,n;if(this.maskedBy){let e=this.maskedBy.element.screenCorners;t=Math.min(Math.min(e[0].x,e[1].x),Math.min(e[2].x,e[3].x)),s=Math.max(Math.max(e[0].x,e[1].x),Math.max(e[2].x,e[3].x)),n=Math.min(Math.min(e[0].y,e[1].y),Math.min(e[2].y,e[3].y)),i=Math.max(Math.max(e[0].y,e[1].y),Math.max(e[2].y,e[3].y));}else {let r=this.system.app.graphicsDevice.width,a=this.system.app.graphicsDevice.height,o=e._rect.z*r,l=e._rect.w*a;s=(t=e._rect.x*r)+o,n=(i=(1-e._rect.y)*a)-l;}let r=this.screenCorners,a=Math.min(Math.min(r[0].x,r[1].x),Math.min(r[2].x,r[3].x)),o=Math.max(Math.max(r[0].x,r[1].x),Math.max(r[2].x,r[3].x)),l=Math.min(Math.min(r[0].y,r[1].y),Math.min(r[2].y,r[3].y)),h=Math.max(Math.max(r[0].y,r[1].y),Math.max(r[2].y,r[3].y));return !(o<t)&&!(a>s)&&!(l>i)&&!(h<n)}_isScreenSpace(){return !!this.screen&&!!this.screen.screen&&this.screen.screen.screenSpace}_isScreenCulled(){return !!this.screen&&!!this.screen.screen&&this.screen.screen.cull}_dirtyBatch(){if(-1!==this.batchGroupId){var e;null==(e=this.system.app.batcher)||e.markGroupDirty(this.batchGroupId);}}constructor(e,t){super(e,t),this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._beingInitialized=false,this._anchor=new em,this._localAnchor=new em,this._pivot=new ef,this._width=this._calculatedWidth=32,this._height=this._calculatedHeight=32,this._margin=new em(0,0,-32,-32),this._modelTransform=new ex,this._screenToWorld=new ex,this._anchorTransform=new ex,this._anchorDirty=true,this._parentWorldTransform=new ex,this._screenTransform=new ex,this._screenCorners=[new eu,new eu,new eu,new eu],this._canvasCorners=[new ef,new ef,new ef,new ef],this._worldCorners=[new eu,new eu,new eu,new eu],this._cornersDirty=true,this._canvasCornersDirty=true,this._worldCornersDirty=true,this.entity.on("insert",this._onInsert,this),this._patch(),this.screen=null,this._type=fe,this._image=null,this._text=null,this._group=null,this._drawOrder=0,this._fitMode=fi,this._useInput=false,this._layers=[4],this._addedModels=[],this._batchGroupId=-1,this._offsetReadAt=0,this._maskOffset=.5,this._maskedBy=null;}}ma.EVENT_MOUSEDOWN="mousedown",ma.EVENT_MOUSEUP="mouseup",ma.EVENT_MOUSEENTER="mouseenter",ma.EVENT_MOUSELEAVE="mouseleave",ma.EVENT_MOUSEMOVE="mousemove",ma.EVENT_MOUSEWHEEL="mousewheel",ma.EVENT_CLICK="click",ma.EVENT_TOUCHSTART="touchstart",ma.EVENT_TOUCHEND="touchend",ma.EVENT_TOUCHMOVE="touchmove",ma.EVENT_TOUCHCANCEL="touchcancel";class mo{constructor(){this.enabled=true;}}let ml=["enabled"];class mh extends u9{destroy(){super.destroy(),this._defaultTexture.destroy();}initializeComponentData(e,t,s){let i;e._beingInitialized=true,void 0!==t.anchor&&(t.anchor instanceof em?e.anchor.copy(t.anchor):e.anchor.set(t.anchor[0],t.anchor[1],t.anchor[2],t.anchor[3])),void 0!==t.pivot&&(t.pivot instanceof ef?e.pivot.copy(t.pivot):e.pivot.set(t.pivot[0],t.pivot[1]));let n=Math.abs(e.anchor.x-e.anchor.z)>.001,r=Math.abs(e.anchor.y-e.anchor.w)>.001,a=false;void 0!==t.margin&&(t.margin instanceof em?e.margin.copy(t.margin):e._margin.set(t.margin[0],t.margin[1],t.margin[2],t.margin[3]),a=true),void 0!==t.left&&(e._margin.x=t.left,a=true),void 0!==t.bottom&&(e._margin.y=t.bottom,a=true),void 0!==t.right&&(e._margin.z=t.right,a=true),void 0!==t.top&&(e._margin.w=t.top,a=true),a&&(e.margin=e._margin);let o=false;void 0===t.width||n?n&&(o=true):e.width=t.width,void 0===t.height||r?r&&(o=true):e.height=t.height,o&&(e.anchor=e.anchor),void 0!==t.enabled&&(e.enabled=t.enabled),void 0!==t.useInput&&(e.useInput=t.useInput),void 0!==t.fitMode&&(e.fitMode=t.fitMode),e.batchGroupId=void 0===t.batchGroupId||null===t.batchGroupId?-1:t.batchGroupId,t.layers&&Array.isArray(t.layers)&&(e.layers=t.layers.slice(0)),void 0!==t.type&&(e.type=t.type),e.type===ft?(void 0!==t.rect&&(e.rect=t.rect),void 0!==t.color&&((i=t.color)instanceof en||(i=new en(t.color[0],t.color[1],t.color[2])),e.color=i),void 0!==t.opacity&&(e.opacity=t.opacity),void 0!==t.textureAsset&&(e.textureAsset=t.textureAsset),t.texture&&(e.texture=t.texture),void 0!==t.spriteAsset&&(e.spriteAsset=t.spriteAsset),t.sprite&&(e.sprite=t.sprite),void 0!==t.spriteFrame&&(e.spriteFrame=t.spriteFrame),void 0!==t.pixelsPerUnit&&null!==t.pixelsPerUnit&&(e.pixelsPerUnit=t.pixelsPerUnit),void 0!==t.materialAsset&&(e.materialAsset=t.materialAsset),t.material&&(e.material=t.material),void 0!==t.mask&&(e.mask=t.mask)):e.type===fs&&(void 0!==t.autoWidth&&(e.autoWidth=t.autoWidth),void 0!==t.autoHeight&&(e.autoHeight=t.autoHeight),void 0!==t.rtlReorder&&(e.rtlReorder=t.rtlReorder),void 0!==t.unicodeConverter&&(e.unicodeConverter=t.unicodeConverter),null!==t.text&&void 0!==t.text?e.text=t.text:null!==t.key&&void 0!==t.key&&(e.key=t.key),void 0!==t.color&&((i=t.color)instanceof en||(i=new en(i[0],i[1],i[2])),e.color=i),void 0!==t.opacity&&(e.opacity=t.opacity),void 0!==t.spacing&&(e.spacing=t.spacing),void 0===t.fontSize||(e.fontSize=t.fontSize,t.lineHeight||(e.lineHeight=t.fontSize)),void 0!==t.lineHeight&&(e.lineHeight=t.lineHeight),void 0!==t.maxLines&&(e.maxLines=t.maxLines),void 0!==t.wrapLines&&(e.wrapLines=t.wrapLines),void 0!==t.minFontSize&&(e.minFontSize=t.minFontSize),void 0!==t.maxFontSize&&(e.maxFontSize=t.maxFontSize),t.autoFitWidth&&(e.autoFitWidth=t.autoFitWidth),t.autoFitHeight&&(e.autoFitHeight=t.autoFitHeight),void 0!==t.fontAsset&&(e.fontAsset=t.fontAsset),void 0!==t.font&&(e.font=t.font),void 0!==t.alignment&&(e.alignment=t.alignment),void 0!==t.outlineColor&&(e.outlineColor=t.outlineColor),void 0!==t.outlineThickness&&(e.outlineThickness=t.outlineThickness),void 0!==t.shadowColor&&(e.shadowColor=t.shadowColor),void 0!==t.shadowOffset&&(e.shadowOffset=t.shadowOffset),void 0!==t.enableMarkup&&(e.enableMarkup=t.enableMarkup));let l=e._parseUpToScreen();l.screen&&e._updateScreen(l.screen),super.initializeComponentData(e,t,s),e._beingInitialized=false,e.type===ft&&e._image._meshDirty&&e._image._updateMesh(e._image.mesh);}onAddComponent(e,t){e.fire("element:add");}onRemoveComponent(e,t){t.onRemove();}cloneComponent(e,t){let s=e.element,i={enabled:s.enabled,width:s.width,height:s.height,anchor:s.anchor.clone(),pivot:s.pivot.clone(),margin:s.margin.clone(),alignment:s.alignment&&s.alignment.clone()||s.alignment,autoWidth:s.autoWidth,autoHeight:s.autoHeight,type:s.type,rect:s.rect&&s.rect.clone()||s.rect,rtlReorder:s.rtlReorder,unicodeConverter:s.unicodeConverter,materialAsset:s.materialAsset,material:s.material,color:s.color&&s.color.clone()||s.color,opacity:s.opacity,textureAsset:s.textureAsset,texture:s.texture,spriteAsset:s.spriteAsset,sprite:s.sprite,spriteFrame:s.spriteFrame,pixelsPerUnit:s.pixelsPerUnit,spacing:s.spacing,lineHeight:s.lineHeight,wrapLines:s.wrapLines,layers:s.layers,fontSize:s.fontSize,minFontSize:s.minFontSize,maxFontSize:s.maxFontSize,autoFitWidth:s.autoFitWidth,autoFitHeight:s.autoFitHeight,maxLines:s.maxLines,fontAsset:s.fontAsset,font:s.font,useInput:s.useInput,fitMode:s.fitMode,batchGroupId:s.batchGroupId,mask:s.mask,outlineColor:s.outlineColor&&s.outlineColor.clone()||s.outlineColor,outlineThickness:s.outlineThickness,shadowColor:s.shadowColor&&s.shadowColor.clone()||s.shadowColor,shadowOffset:s.shadowOffset&&s.shadowOffset.clone()||s.shadowOffset,enableMarkup:s.enableMarkup};return void 0!==s.key&&null!==s.key?i.key=s.key:i.text=s.text,this.addComponent(t,i)}getTextElementMaterial(e,t,s){let i=(e&&1)|(t&&2)|(s&&4),n=this._defaultTextMaterials[i];if(n)return n;let r="TextMaterial";return n=new cP,t?(n.msdfMap=this._defaultTexture,n.msdfTextAttribute=s,n.emissive.set(1,1,1)):(r="Bitmap"+r,n.emissive.set(1,1,1),n.emissiveMap=this._defaultTexture,n.opacityMap=this._defaultTexture,n.opacityMapChannel="a"),e&&(r="ScreenSpace"+r,n.depthTest=false),n.name="default"+r,n.useLighting=false,n.useTonemap=false,n.useFog=false,n.useSkybox=false,n.diffuse.set(0,0,0),n.opacity=.5,n.blendType=4,n.depthWrite=false,n.emissiveVertexColor=true,n.update(),this._defaultTextMaterials[i]=n,n}_createBaseImageMaterial(){let e=new cP;return e.diffuse.set(0,0,0),e.emissive.set(1,1,1),e.emissiveMap=this._defaultTexture,e.opacityMap=this._defaultTexture,e.opacityMapChannel="a",e.useLighting=false,e.useTonemap=false,e.useFog=false,e.useSkybox=false,e.blendType=4,e.depthWrite=false,e}getImageElementMaterial(e,t,s,i){if(e)return t?s?(this.defaultScreenSpaceImageMask9SlicedMaterial||(this.defaultScreenSpaceImageMask9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMask9SlicedMaterial.name="defaultScreenSpaceImageMask9SlicedMaterial",this.defaultScreenSpaceImageMask9SlicedMaterial.nineSlicedMode=1,this.defaultScreenSpaceImageMask9SlicedMaterial.depthTest=false,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9SlicedMaterial.redWrite=false,this.defaultScreenSpaceImageMask9SlicedMaterial.greenWrite=false,this.defaultScreenSpaceImageMask9SlicedMaterial.blueWrite=false,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaWrite=false,this.defaultScreenSpaceImageMask9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9SlicedMaterial)),this.defaultScreenSpaceImageMask9SlicedMaterial):i?(this.defaultScreenSpaceImageMask9TiledMaterial||(this.defaultScreenSpaceImageMask9TiledMaterial=this.defaultScreenSpaceImage9TiledMaterial.clone(),this.defaultScreenSpaceImageMask9TiledMaterial.name="defaultScreenSpaceImageMask9TiledMaterial",this.defaultScreenSpaceImageMask9TiledMaterial.nineSlicedMode=2,this.defaultScreenSpaceImageMask9TiledMaterial.depthTest=false,this.defaultScreenSpaceImageMask9TiledMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9TiledMaterial.redWrite=false,this.defaultScreenSpaceImageMask9TiledMaterial.greenWrite=false,this.defaultScreenSpaceImageMask9TiledMaterial.blueWrite=false,this.defaultScreenSpaceImageMask9TiledMaterial.alphaWrite=false,this.defaultScreenSpaceImageMask9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9TiledMaterial)),this.defaultScreenSpaceImageMask9TiledMaterial):(this.defaultScreenSpaceImageMaskMaterial||(this.defaultScreenSpaceImageMaskMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaskMaterial.name="defaultScreenSpaceImageMaskMaterial",this.defaultScreenSpaceImageMaskMaterial.depthTest=false,this.defaultScreenSpaceImageMaskMaterial.alphaTest=1,this.defaultScreenSpaceImageMaskMaterial.redWrite=false,this.defaultScreenSpaceImageMaskMaterial.greenWrite=false,this.defaultScreenSpaceImageMaskMaterial.blueWrite=false,this.defaultScreenSpaceImageMaskMaterial.alphaWrite=false,this.defaultScreenSpaceImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaskMaterial)),this.defaultScreenSpaceImageMaskMaterial):s?(this.defaultScreenSpaceImage9SlicedMaterial||(this.defaultScreenSpaceImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9SlicedMaterial.name="defaultScreenSpaceImage9SlicedMaterial",this.defaultScreenSpaceImage9SlicedMaterial.nineSlicedMode=1,this.defaultScreenSpaceImage9SlicedMaterial.depthTest=false,this.defaultScreenSpaceImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9SlicedMaterial)),this.defaultScreenSpaceImage9SlicedMaterial):i?(this.defaultScreenSpaceImage9TiledMaterial||(this.defaultScreenSpaceImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9TiledMaterial.name="defaultScreenSpaceImage9TiledMaterial",this.defaultScreenSpaceImage9TiledMaterial.nineSlicedMode=2,this.defaultScreenSpaceImage9TiledMaterial.depthTest=false,this.defaultScreenSpaceImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9TiledMaterial)),this.defaultScreenSpaceImage9TiledMaterial):(this.defaultScreenSpaceImageMaterial||(this.defaultScreenSpaceImageMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaterial.name="defaultScreenSpaceImageMaterial",this.defaultScreenSpaceImageMaterial.depthTest=false,this.defaultScreenSpaceImageMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaterial)),this.defaultScreenSpaceImageMaterial);return t?s?(this.defaultImage9SlicedMaskMaterial||(this.defaultImage9SlicedMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaskMaterial.name="defaultImage9SlicedMaskMaterial",this.defaultImage9SlicedMaskMaterial.nineSlicedMode=1,this.defaultImage9SlicedMaskMaterial.alphaTest=1,this.defaultImage9SlicedMaskMaterial.redWrite=false,this.defaultImage9SlicedMaskMaterial.greenWrite=false,this.defaultImage9SlicedMaskMaterial.blueWrite=false,this.defaultImage9SlicedMaskMaterial.alphaWrite=false,this.defaultImage9SlicedMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaskMaterial)),this.defaultImage9SlicedMaskMaterial):i?(this.defaultImage9TiledMaskMaterial||(this.defaultImage9TiledMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaskMaterial.name="defaultImage9TiledMaskMaterial",this.defaultImage9TiledMaskMaterial.nineSlicedMode=2,this.defaultImage9TiledMaskMaterial.alphaTest=1,this.defaultImage9TiledMaskMaterial.redWrite=false,this.defaultImage9TiledMaskMaterial.greenWrite=false,this.defaultImage9TiledMaskMaterial.blueWrite=false,this.defaultImage9TiledMaskMaterial.alphaWrite=false,this.defaultImage9TiledMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaskMaterial)),this.defaultImage9TiledMaskMaterial):(this.defaultImageMaskMaterial||(this.defaultImageMaskMaterial=this._createBaseImageMaterial(),this.defaultImageMaskMaterial.name="defaultImageMaskMaterial",this.defaultImageMaskMaterial.alphaTest=1,this.defaultImageMaskMaterial.redWrite=false,this.defaultImageMaskMaterial.greenWrite=false,this.defaultImageMaskMaterial.blueWrite=false,this.defaultImageMaskMaterial.alphaWrite=false,this.defaultImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaskMaterial)),this.defaultImageMaskMaterial):s?(this.defaultImage9SlicedMaterial||(this.defaultImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaterial.name="defaultImage9SlicedMaterial",this.defaultImage9SlicedMaterial.nineSlicedMode=1,this.defaultImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaterial)),this.defaultImage9SlicedMaterial):i?(this.defaultImage9TiledMaterial||(this.defaultImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaterial.name="defaultImage9TiledMaterial",this.defaultImage9TiledMaterial.nineSlicedMode=2,this.defaultImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaterial)),this.defaultImage9TiledMaterial):(this.defaultImageMaterial||(this.defaultImageMaterial=this._createBaseImageMaterial(),this.defaultImageMaterial.name="defaultImageMaterial",this.defaultImageMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaterial)),this.defaultImageMaterial)}registerUnicodeConverter(e){this._unicodeConverter=e;}registerRtlReorder(e){this._rtlReorder=e;}getUnicodeConverter(){return this._unicodeConverter}getRtlReorder(){return this._rtlReorder}constructor(e){super(e),this.id="element",this.ComponentType=ma,this.DataType=mo,this.schema=ml,this._unicodeConverter=null,this._rtlReorder=null,this._defaultTexture=new se(e.graphicsDevice,{width:1,height:1,format:20,name:"element-system"});let t=this._defaultTexture.lock(),s=new Uint8Array(4);s[0]=255,s[1]=255,s[2]=255,s[3]=255,t.set(s),this._defaultTexture.unlock(),this.defaultImageMaterial=null,this.defaultImage9SlicedMaterial=null,this.defaultImage9TiledMaterial=null,this.defaultImageMaskMaterial=null,this.defaultImage9SlicedMaskMaterial=null,this.defaultImage9TiledMaskMaterial=null,this.defaultScreenSpaceImageMaterial=null,this.defaultScreenSpaceImage9SlicedMaterial=null,this.defaultScreenSpaceImage9TiledMaterial=null,this.defaultScreenSpaceImageMask9SlicedMaterial=null,this.defaultScreenSpaceImageMask9TiledMaterial=null,this.defaultScreenSpaceImageMaskMaterial=null,this._defaultTextMaterials={},this.defaultImageMaterials=[],this.on("add",this.onAddComponent,this),this.on("beforeremove",this.onRemoveComponent,this);}}let md="free",mc="limited",mu="locked",mp=["angularDampingX","angularDampingY","angularDampingZ","angularEquilibriumX","angularEquilibriumY","angularEquilibriumZ","angularLimitsX","angularLimitsY","angularLimitsZ","angularMotionX","angularMotionY","angularMotionZ","angularSpringX","angularSpringY","angularSpringZ","angularStiffnessX","angularStiffnessY","angularStiffnessZ","breakForce","enableCollision","enabled","entityA","entityB","linearDampingX","linearDampingY","linearDampingZ","linearEquilibriumX","linearEquilibriumY","linearEquilibriumZ","linearLimitsX","linearLimitsY","linearLimitsZ","linearMotionX","linearMotionY","linearMotionZ","linearSpringX","linearSpringY","linearSpringZ","linearStiffnessX","linearStiffnessY","linearStiffnessZ"];class mf extends u8{set entityA(e){this._destroyConstraint(),this._entityA=e,this._createConstraint();}get entityA(){return this._entityA}set entityB(e){this._destroyConstraint(),this._entityB=e,this._createConstraint();}get entityB(){return this._entityB}set breakForce(e){this._constraint&&this._breakForce!==e&&(this._constraint.setBreakingImpulseThreshold(e),this._breakForce=e);}get breakForce(){return this._breakForce}set enableCollision(e){this._destroyConstraint(),this._enableCollision=e,this._createConstraint();}get enableCollision(){return this._enableCollision}set angularLimitsX(e){this._angularLimitsX.equals(e)||(this._angularLimitsX.copy(e),this._updateAngularLimits());}get angularLimitsX(){return this._angularLimitsX}set angularMotionX(e){this._angularMotionX!==e&&(this._angularMotionX=e,this._updateAngularLimits());}get angularMotionX(){return this._angularMotionX}set angularLimitsY(e){this._angularLimitsY.equals(e)||(this._angularLimitsY.copy(e),this._updateAngularLimits());}get angularLimitsY(){return this._angularLimitsY}set angularMotionY(e){this._angularMotionY!==e&&(this._angularMotionY=e,this._updateAngularLimits());}get angularMotionY(){return this._angularMotionY}set angularLimitsZ(e){this._angularLimitsZ.equals(e)||(this._angularLimitsZ.copy(e),this._updateAngularLimits());}get angularLimitsZ(){return this._angularLimitsZ}set angularMotionZ(e){this._angularMotionZ!==e&&(this._angularMotionZ=e,this._updateAngularLimits());}get angularMotionZ(){return this._angularMotionZ}set linearLimitsX(e){this._linearLimitsX.equals(e)||(this._linearLimitsX.copy(e),this._updateLinearLimits());}get linearLimitsX(){return this._linearLimitsX}set linearMotionX(e){this._linearMotionX!==e&&(this._linearMotionX=e,this._updateLinearLimits());}get linearMotionX(){return this._linearMotionX}set linearLimitsY(e){this._linearLimitsY.equals(e)||(this._linearLimitsY.copy(e),this._updateLinearLimits());}get linearLimitsY(){return this._linearLimitsY}set linearMotionY(e){this._linearMotionY!==e&&(this._linearMotionY=e,this._updateLinearLimits());}get linearMotionY(){return this._linearMotionY}set linearLimitsZ(e){this._linearLimitsZ.equals(e)||(this._linearLimitsZ.copy(e),this._updateLinearLimits());}get linearLimitsZ(){return this._linearLimitsZ}set linearMotionZ(e){this._linearMotionZ!==e&&(this._linearMotionZ=e,this._updateLinearLimits());}get linearMotionZ(){return this._linearMotionZ}_convertTransform(e,t){let s=e.getTranslation(),i=new eT;i.setFromMat4(e);let n=new Ammo.btVector3(s.x,s.y,s.z),r=new Ammo.btQuaternion(i.x,i.y,i.z,i.w);t.setOrigin(n),t.setRotation(r),Ammo.destroy(n),Ammo.destroy(r);}_updateAngularLimits(){let e=this._constraint;if(e){let t,s,i,n,r,a;this._angularMotionX===mc?(t=this._angularLimitsX.x*ei.DEG_TO_RAD,n=this._angularLimitsX.y*ei.DEG_TO_RAD):this._angularMotionX===md?(t=1,n=0):t=n=0,this._angularMotionY===mc?(s=this._angularLimitsY.x*ei.DEG_TO_RAD,r=this._angularLimitsY.y*ei.DEG_TO_RAD):this._angularMotionY===md?(s=1,r=0):s=r=0,this._angularMotionZ===mc?(i=this._angularLimitsZ.x*ei.DEG_TO_RAD,a=this._angularLimitsZ.y*ei.DEG_TO_RAD):this._angularMotionZ===md?(i=1,a=0):i=a=0;let o=new Ammo.btVector3(t,s,i);e.setAngularLowerLimit(o),o.setValue(n,r,a),e.setAngularUpperLimit(o),Ammo.destroy(o);}}_updateLinearLimits(){let e=this._constraint;if(e){let t,s,i,n,r,a;this._linearMotionX===mc?(t=this._linearLimitsX.x,n=this._linearLimitsX.y):this._linearMotionX===md?(t=1,n=0):t=n=0,this._linearMotionY===mc?(s=this._linearLimitsY.x,r=this._linearLimitsY.y):this._linearMotionY===md?(s=1,r=0):s=r=0,this._linearMotionZ===mc?(i=this._linearLimitsZ.x,a=this._linearLimitsZ.y):this._linearMotionZ===md?(i=1,a=0):i=a=0;let o=new Ammo.btVector3(t,s,i);e.setLinearLowerLimit(o),o.setValue(n,r,a),e.setLinearUpperLimit(o),Ammo.destroy(o);}}_createConstraint(){if(this._entityA&&this._entityA.rigidbody){this._destroyConstraint();let e=new ex,t=this._entityA.rigidbody.body;t.activate();let s=this.entity.getWorldTransform(),i=this._entityA.getWorldTransform().clone().invert();e.mul2(i,s);let n=new Ammo.btTransform;if(this._convertTransform(e,n),this._entityB&&this._entityB.rigidbody){let i=this._entityB.rigidbody.body;i.activate();let r=this._entityB.getWorldTransform().clone().invert();e.mul2(r,s);let a=new Ammo.btTransform;this._convertTransform(e,a),this._constraint=new Ammo.btGeneric6DofSpringConstraint(t,i,n,a,!this._enableCollision),Ammo.destroy(a);}else this._constraint=new Ammo.btGeneric6DofSpringConstraint(t,n,!this._enableCollision);Ammo.destroy(n);let r=["X","Y","Z","X","Y","Z"];for(let e=0;e<6;e++){let t=e<3?"_linear":"_angular";this._constraint.enableSpring(e,this[t+"Spring"+r[e]]),this._constraint.setDamping(e,this[t+"Damping"+r[e]]),this._constraint.setEquilibriumPoint(e,this[t+"Equilibrium"+r[e]]),this._constraint.setStiffness(e,this[t+"Stiffness"+r[e]]);}this._constraint.setBreakingImpulseThreshold(this._breakForce),this._updateLinearLimits(),this._updateAngularLimits(),this.system.app.systems.rigidbody.dynamicsWorld.addConstraint(this._constraint,!this._enableCollision);}}_destroyConstraint(){this._constraint&&(this.system.app.systems.rigidbody.dynamicsWorld.removeConstraint(this._constraint),Ammo.destroy(this._constraint),this._constraint=null);}initFromData(e){for(let t of mp)e.hasOwnProperty(t)&&(e[t]instanceof ef?this["_"+t].copy(e[t]):this["_"+t]=e[t]);this._createConstraint();}onEnable(){this._createConstraint();}onDisable(){this._destroyConstraint();}_onSetEnabled(e,t,s){}_onBeforeRemove(){this.fire("remove");}constructor(e,t){super(e,t),this._constraint=null,this._entityA=null,this._entityB=null,this._breakForce=34e37,this._enableCollision=true,this._linearMotionX=mu,this._linearLimitsX=new ef(0,0),this._linearSpringX=false,this._linearStiffnessX=0,this._linearDampingX=1,this._linearEquilibriumX=0,this._linearMotionY=mu,this._linearLimitsY=new ef(0,0),this._linearSpringY=false,this._linearStiffnessY=0,this._linearDampingY=1,this._linearEquilibriumY=0,this._linearMotionZ=mu,this._linearLimitsZ=new ef(0,0),this._linearSpringZ=false,this._linearStiffnessZ=0,this._linearDampingZ=1,this._linearEquilibriumZ=0,this._angularMotionX=mu,this._angularLimitsX=new ef(0,0),this._angularSpringX=false,this._angularStiffnessX=0,this._angularDampingX=1,this._angularEquilibriumX=0,this._angularMotionY=mu,this._angularLimitsY=new ef(0,0),this._angularSpringY=false,this._angularStiffnessY=0,this._angularDampingY=1,this._angularEquilibriumY=0,this._angularMotionZ=mu,this._angularLimitsZ=new ef(0,0),this._angularSpringZ=false,this._angularEquilibriumZ=0,this._angularDampingZ=1,this._angularStiffnessZ=0,this.on("set_enabled",this._onSetEnabled,this);}}let mm={Damping:"setDamping",Equilibrium:"setEquilibriumPoint",Spring:"enableSpring",Stiffness:"setStiffness"};["linear","angular"].forEach(e=>{["Damping","Equilibrium","Spring","Stiffness"].forEach(t=>{["X","Y","Z"].forEach(s=>{let i=e+t+s,n="_"+i,r=3*("linear"!==e);"Y"===s&&(r+=1),"Z"===s&&(r+=2),Object.defineProperty(mf.prototype,i,{get:function(){return this[n]},set:function(e){this[n]!==e&&(this[n]=e,this._constraint[mm[t]](r,e));}});});});});class m_{constructor(){this.enabled=true;}}let mg=["enabled"];class mv extends u9{initializeComponentData(e,t,s){e.initFromData(t),super.initializeComponentData(e,t,mg);}constructor(e){super(e),this.id="joint",this.app=e,this.ComponentType=mf,this.DataType=m_,this.schema=mg;}}u8._buildAccessors(mf.prototype,mg);class my extends u8{set minWidth(e){e!==this._minWidth&&(this._minWidth=e,this.fire("resize"));}get minWidth(){return this._minWidth}set minHeight(e){e!==this._minHeight&&(this._minHeight=e,this.fire("resize"));}get minHeight(){return this._minHeight}set maxWidth(e){e!==this._maxWidth&&(this._maxWidth=e,this.fire("resize"));}get maxWidth(){return this._maxWidth}set maxHeight(e){e!==this._maxHeight&&(this._maxHeight=e,this.fire("resize"));}get maxHeight(){return this._maxHeight}set fitWidthProportion(e){e!==this._fitWidthProportion&&(this._fitWidthProportion=e,this.fire("resize"));}get fitWidthProportion(){return this._fitWidthProportion}set fitHeightProportion(e){e!==this._fitHeightProportion&&(this._fitHeightProportion=e,this.fire("resize"));}get fitHeightProportion(){return this._fitHeightProportion}set excludeFromLayout(e){e!==this._excludeFromLayout&&(this._excludeFromLayout=e,this.fire("resize"));}get excludeFromLayout(){return this._excludeFromLayout}constructor(...e){super(...e),this._minWidth=0,this._minHeight=0,this._maxWidth=null,this._maxHeight=null,this._fitWidthProportion=0,this._fitHeightProportion=0,this._excludeFromLayout=false;}}class mS{constructor(){this.enabled=true;}}let mx=["enabled"];class mT extends u9{initializeComponentData(e,t,s){ void 0!==t.enabled&&(e.enabled=t.enabled),void 0!==t.minWidth&&(e.minWidth=t.minWidth),void 0!==t.minHeight&&(e.minHeight=t.minHeight),void 0!==t.maxWidth&&(e.maxWidth=t.maxWidth),void 0!==t.maxHeight&&(e.maxHeight=t.maxHeight),void 0!==t.fitWidthProportion&&(e.fitWidthProportion=t.fitWidthProportion),void 0!==t.fitHeightProportion&&(e.fitHeightProportion=t.fitHeightProportion),void 0!==t.excludeFromLayout&&(e.excludeFromLayout=t.excludeFromLayout),super.initializeComponentData(e,t,s);}cloneComponent(e,t){let s=e.layoutchild;return this.addComponent(t,{enabled:s.enabled,minWidth:s.minWidth,minHeight:s.minHeight,maxWidth:s.maxWidth,maxHeight:s.maxHeight,fitWidthProportion:s.fitWidthProportion,fitHeightProportion:s.fitHeightProportion,excludeFromLayout:s.excludeFromLayout})}constructor(e){super(e),this.id="layoutchild",this.ComponentType=my,this.DataType=mS,this.schema=mx;}}u8._buildAccessors(my.prototype,mx);let mb={};mb[0]={axis:"x",size:"width",calculatedSize:"calculatedWidth",minSize:"minWidth",maxSize:"maxWidth",fitting:"widthFitting",fittingProportion:"fitWidthProportion"},mb[1]={axis:"y",size:"height",calculatedSize:"calculatedHeight",minSize:"minHeight",maxSize:"maxHeight",fitting:"heightFitting",fittingProportion:"fitHeightProportion"};let mE={};mE[0]=1,mE[1]=0;let mA={minWidth:0,minHeight:0,maxWidth:Number.POSITIVE_INFINITY,maxHeight:Number.POSITIVE_INFINITY,width:null,height:null,fitWidthProportion:0,fitHeightProportion:0},mw={NONE:"NONE",APPLY_STRETCHING:"APPLY_STRETCHING",APPLY_SHRINKING:"APPLY_SHRINKING"},mC=new ef;function mP(e){let t;let s=mb[e],i=mb[mE[e]];function n(e,t){return -t[i.size]*e.pivot[i.axis]}function r(e){let t=e.entity.layoutchild;return !t||!t.enabled||!t.excludeFromLayout}function a(e,t,s){switch(e){case 0:return mw.NONE;case 1:if(t<s)return mw.APPLY_STRETCHING;return mw.NONE;case 2:if(t>=s)return mw.APPLY_SHRINKING;return mw.NONE;case 3:if(t<s)return mw.APPLY_STRETCHING;return mw.APPLY_SHRINKING;default:throw Error("Unrecognized fitting mode: "+e)}}function o(e,s){return f(e,s.size)+(e.length-1)*t.spacing[s.axis]}function l(e,t,s){let i=_(e,s.maxSize),n=m(e,s.fittingProportion),r=y(n,i),a=mC[s.axis]-t;for(let t=0;t<e.length;++t){let o=i[t],l=d(o,a,n,r),h=e[o][s.size]+l,c=Math.min(h,e[o][s.maxSize]);e[o][s.size]=c,a-=l-Math.max(h-c,0);}}function h(e,t,s){let i=_(e,s.minSize,true),n=function(e){if(1===e.length)return [1];let t=[],s=e.length;for(let i=0;i<s;++i)t.push((1-e[i])/(s-1));return t}(m(e,s.fittingProportion)),r=y(n,i),a=t-mC[s.axis];for(let t=0;t<e.length;++t){let o=i[t],l=d(o,a,n,r),h=e[o][s.size]-l,c=Math.max(h,e[o][s.minSize]);e[o][s.size]=c,a-=l-Math.max(c-h,0);}}function d(e,t,s,i){let n=s[e],r=i[e];return 1e-5>Math.abs(n)&&1e-5>Math.abs(r)?t:t*n/r}function c(e){let t=[];for(let s=0;s<e.length;++s){let i=e[s],n=Math.max(u(i,"minWidth"),0),r=Math.max(u(i,"minHeight"),0),a=Math.max(u(i,"maxWidth"),n),o=Math.max(u(i,"maxHeight"),r),l=p(u(i,"width"),n,a),h=p(u(i,"height"),r,o),d=u(i,"fitWidthProportion"),c=u(i,"fitHeightProportion");t.push({minWidth:n,minHeight:r,maxWidth:a,maxHeight:o,width:l,height:h,fitWidthProportion:d,fitHeightProportion:c});}return t}function u(e,t){let s=e.entity.layoutchild;return s&&s.enabled&&void 0!==s[t]&&null!==s[t]?s[t]:void 0!==e[t]?e[t]:mA[t]}function p(e,t,s){return Math.min(Math.max(e,t),s)}function f(e,t){return e.reduce((e,s)=>e+s[t],0)}function m(e,t){let s=f(e,t),i=[],n=e.length;if(0===s)for(let e=0;e<n;++e)i.push(1/n);else for(let r=0;r<n;++r)i.push(e[r][t]/s);return i}function _(e,t,s){return e.forEach(g),e.slice().sort((e,i)=>s?i[t]-e[t]:e[t]-i[t]).map(v)}function g(e,t){e.index=t;}function v(e){return e.index}function y(e,t){let s=[];s[t[e.length-1]]=e[t[e.length-1]];for(let i=e.length-2;i>=0;--i)s[t[i]]=s[t[i+1]]+e[t[i]];return s}return function(e,d){e=e.filter(r),mC.x=(t=d).containerSize.x-t.padding.x-t.padding.z,mC.y=t.containerSize.y-t.padding.y-t.padding.w,function(e){for(let t=0;t<e.length;++t){let s=e[t],i=s.anchor;(0!==i.x||0!==i.y||0!==i.z||0!==i.w)&&(s.anchor=em.ZERO);}}(e);let u=function(e){let s=0===t.orientation&&t.reverseX||1===t.orientation&&t.reverseY,i=0===t.orientation&&t.reverseY||1===t.orientation&&t.reverseX;if(s)for(let t=0;t<e.length;++t)s&&e[t].reverse();return i&&e.reverse(),e}(function(e){if(!t.wrap)return [e];let i=[[]],n=c(e),r=0,a=2===t[s.fitting];for(let o=0;o<e.length;++o){i[i.length-1].length>0&&(r+=t.spacing[s.axis]);let l=n[o][s.size];r+=l,!a&&r>mC[s.axis]&&0!==i[i.length-1].length&&(r=l,i.push([])),i[i.length-1].push(e[o]),a&&r>mC[s.axis]&&o!==e.length-1&&(r=0,i.push([]));}return i}(e)),p=function(e,s){let n=[],r=[];for(let t=0;t<e.length;++t){let a=e[t];a.largestElement=null,a.largestSize={width:Number.NEGATIVE_INFINITY,height:Number.NEGATIVE_INFINITY};for(let e=0;e<a.length;++e){let n=s[t][e];n[i.size]>a.largestSize[i.size]&&(a.largestElement=a[e],a.largestSize=n);}n.push(a.largestElement),r.push(a.largestSize);}let d=o(r,i),c=a(t[i.fitting],d,mC[i.axis]);c===mw.APPLY_STRETCHING?l(r,d,i):c===mw.APPLY_SHRINKING&&h(r,d,i);for(let n=0;n<e.length;++n){let r=e[n];for(let o=0;o<r.length;++o){let l=s[n][o],h=l[i.size],d=1===e.length?mC[i.axis]:r.largestSize[i.size],c=a(t[i.fitting],h,d);c===mw.APPLY_STRETCHING?l[i.size]=Math.min(d,l[i.maxSize]):c===mw.APPLY_SHRINKING&&(l[i.size]=Math.max(d,l[i.minSize]));}}return s}(u,function(e){let i=[];for(let n=0;n<e.length;++n){let r=c(e[n]),d=o(r,s),u=a(t[s.fitting],d,mC[s.axis]);u===mw.APPLY_STRETCHING?l(r,d,s):u===mw.APPLY_SHRINKING&&h(r,d,s),i.push(r);}return i}(u)),f=function(e,r){let a={};a[s.axis]=0,a[i.axis]=0,e[s.size]=Number.NEGATIVE_INFINITY;let o=[];for(let l=0;l<e.length;++l){let h=e[l];if(0===h.length){o.push([]);continue}let d=[],c=r[l];for(let e=0;e<h.length;++e){let r=h[e],o=c[e];a[i.axis]-=n(r,o),a[s.axis]-=-o[s.size]*r.pivot[s.axis],d[e]={},d[e][s.axis]=a[s.axis],d[e][i.axis]=a[i.axis],a[i.axis]+=n(r,o),a[s.axis]+=o[s.size]*(1-r.pivot[s.axis])+t.spacing[s.axis];}h[s.size]=a[s.axis]-t.spacing[s.axis],h[i.size]=h.largestSize[i.size],e[s.size]=Math.max(e[s.size],h[s.size]),a[s.axis]=0,a[i.axis]+=h[i.size]+t.spacing[i.axis],o.push(d);}return e[i.size]=a[i.axis]-t.spacing[i.axis],o}(u,p);return function(e,n,r){let a=t.alignment[s.axis],o=t.alignment[i.axis],l=t.padding[s.axis],h=t.padding[i.axis];for(let d=0;d<e.length;++d){let c=e[d],u=n[d],p=r[d],f=(mC[s.axis]-c[s.size])*a+l,m=(mC[i.axis]-e[i.size])*o+h;for(let e=0;e<c.length;++e){let n=(c[i.size]-u[e][i.size])*t.alignment[i.axis];p[e][s.axis]+=f,p[e][i.axis]+=m+n;}}}(u,p,f),function(e,n,r){for(let a=0;a<e.length;++a){let o=e[a],l=n[a],h=r[a];for(let e=0;e<o.length;++e){let n=o[e];n[s.calculatedSize]=l[e][s.size],n[i.calculatedSize]=l[e][i.size],0===t.orientation?n.entity.setLocalPosition(h[e][s.axis],h[e][i.axis],n.entity.getLocalPosition().z):n.entity.setLocalPosition(h[e][i.axis],h[e][s.axis],n.entity.getLocalPosition().z);}}}(u,p,f),function(e){let s=e.width,i=e.height;return {bounds:new em((mC.x-s)*t.alignment.x+t.padding.x,(mC.y-i)*t.alignment.y+t.padding.y,s,i)}}(u)}}let mM={};mM[0]=mP(0),mM[1]=mP(1);class mI{calculateLayout(e,t){let s=mM[t.orientation];if(s)return s(e,t);throw Error("Unrecognized orientation value: "+t.orientation)}}function mR(e){return e.element}function mL(e){return e.enabled&&e.element&&e.element.enabled}class mD extends u8{set orientation(e){e!==this._orientation&&(this._orientation=e,this._scheduleReflow());}get orientation(){return this._orientation}set reverseX(e){e!==this._reverseX&&(this._reverseX=e,this._scheduleReflow());}get reverseX(){return this._reverseX}set reverseY(e){e!==this._reverseY&&(this._reverseY=e,this._scheduleReflow());}get reverseY(){return this._reverseY}set alignment(e){e.equals(this._alignment)||(this._alignment.copy(e),this._scheduleReflow());}get alignment(){return this._alignment}set padding(e){e.equals(this._padding)||(this._padding.copy(e),this._scheduleReflow());}get padding(){return this._padding}set spacing(e){e.equals(this._spacing)||(this._spacing.copy(e),this._scheduleReflow());}get spacing(){return this._spacing}set widthFitting(e){e!==this._widthFitting&&(this._widthFitting=e,this._scheduleReflow());}get widthFitting(){return this._widthFitting}set heightFitting(e){e!==this._heightFitting&&(this._heightFitting=e,this._scheduleReflow());}get heightFitting(){return this._heightFitting}set wrap(e){e!==this._wrap&&(this._wrap=e,this._scheduleReflow());}get wrap(){return this._wrap}_isSelfOrChild(e){return e===this.entity||-1!==this.entity.children.indexOf(e)}_listenForReflowEvents(e,t){e.element&&(e.element[t]("enableelement",this._scheduleReflow,this),e.element[t]("disableelement",this._scheduleReflow,this),e.element[t]("resize",this._scheduleReflow,this),e.element[t]("set:pivot",this._scheduleReflow,this)),e.layoutchild&&(e.layoutchild[t]("set_enabled",this._scheduleReflow,this),e.layoutchild[t]("resize",this._scheduleReflow,this));}_onElementOrLayoutComponentAdd(e){this._isSelfOrChild(e)&&(this._listenForReflowEvents(e,"on"),this._scheduleReflow());}_onElementOrLayoutComponentRemove(e){this._isSelfOrChild(e)&&(this._listenForReflowEvents(e,"off"),this._scheduleReflow());}_onChildInsert(e){this._listenForReflowEvents(e,"on"),this._scheduleReflow();}_onChildRemove(e){this._listenForReflowEvents(e,"off"),this._scheduleReflow();}_scheduleReflow(){this.enabled&&this.entity&&this.entity.enabled&&!this._isPerformingReflow&&this.system.scheduleReflow(this);}reflow(){let e=mR(this.entity),t=this.entity.children.filter(mL).map(mR);if(!e||0===t.length)return;let s=Math.max(e.calculatedWidth,0),i=Math.max(e.calculatedHeight,0),n={orientation:this._orientation,reverseX:this._reverseX,reverseY:this._reverseY,alignment:this._alignment,padding:this._padding,spacing:this._spacing,widthFitting:this._widthFitting,heightFitting:this._heightFitting,wrap:this._wrap,containerSize:new ef(s,i)};this._isPerformingReflow=true;let r=this._layoutCalculator.calculateLayout(t,n);this._isPerformingReflow=false,this.fire("reflow",r);}onEnable(){this._scheduleReflow();}onRemove(){this.entity.off("childinsert",this._onChildInsert,this),this.entity.off("childremove",this._onChildRemove,this),this._listenForReflowEvents(this.entity,"off"),this.entity.children.forEach(e=>{this._listenForReflowEvents(e,"off");}),this.system.app.systems.element.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.element.off("beforeremove",this._onElementOrLayoutComponentRemove,this),this.system.app.systems.layoutchild.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.layoutchild.off("beforeremove",this._onElementOrLayoutComponentRemove,this);}constructor(e,t){super(e,t),this._orientation=0,this._reverseX=false,this._reverseY=true,this._alignment=new ef(0,1),this._padding=new em,this._spacing=new ef,this._widthFitting=0,this._heightFitting=0,this._wrap=false,this._layoutCalculator=new mI,this._listenForReflowEvents(this.entity,"on"),this.entity.children.forEach(e=>{this._listenForReflowEvents(e,"on");}),this.entity.on("childinsert",this._onChildInsert,this),this.entity.on("childremove",this._onChildRemove,this),e.app.systems.element.on("add",this._onElementOrLayoutComponentAdd,this),e.app.systems.element.on("beforeremove",this._onElementOrLayoutComponentRemove,this),e.app.systems.layoutchild.on("add",this._onElementOrLayoutComponentAdd,this),e.app.systems.layoutchild.on("beforeremove",this._onElementOrLayoutComponentRemove,this);}}class mO{constructor(){this.enabled=true;}}let mF=["enabled"];class mN extends u9{initializeComponentData(e,t,s){ void 0!==t.enabled&&(e.enabled=t.enabled),void 0!==t.orientation&&(e.orientation=t.orientation),void 0!==t.reverseX&&(e.reverseX=t.reverseX),void 0!==t.reverseY&&(e.reverseY=t.reverseY),void 0!==t.alignment&&(e.alignment=Array.isArray(t.alignment)?new ef(t.alignment):t.alignment),void 0!==t.padding&&(e.padding=Array.isArray(t.padding)?new em(t.padding):t.padding),void 0!==t.spacing&&(e.spacing=Array.isArray(t.spacing)?new ef(t.spacing):t.spacing),void 0!==t.widthFitting&&(e.widthFitting=t.widthFitting),void 0!==t.heightFitting&&(e.heightFitting=t.heightFitting),void 0!==t.wrap&&(e.wrap=t.wrap),super.initializeComponentData(e,t,s);}cloneComponent(e,t){let s=e.layoutgroup;return this.addComponent(t,{enabled:s.enabled,orientation:s.orientation,reverseX:s.reverseX,reverseY:s.reverseY,alignment:s.alignment,padding:s.padding,spacing:s.spacing,widthFitting:s.widthFitting,heightFitting:s.heightFitting,wrap:s.wrap})}scheduleReflow(e){ -1===this._reflowQueue.indexOf(e)&&this._reflowQueue.push(e);}_onPostUpdate(){this._processReflowQueue();}_processReflowQueue(){if(0===this._reflowQueue.length)return;let e=0;for(;this._reflowQueue.length>0;){let t=this._reflowQueue.slice();this._reflowQueue.length=0,t.sort((e,t)=>e.entity.graphDepth-t.entity.graphDepth);for(let e=0;e<t.length;++e)t[e].reflow();if(++e>=100)break}}_onRemoveComponent(e,t){t.onRemove();}destroy(){super.destroy(),this.app.systems.off("postUpdate",this._onPostUpdate,this);}constructor(e){super(e),this.id="layoutgroup",this.ComponentType=mD,this.DataType=mO,this.schema=mF,this._reflowQueue=[],this.on("beforeremove",this._onRemoveComponent,this),this.app.systems.on("postUpdate",this._onPostUpdate,this);}}u8._buildAccessors(mD.prototype,mF);class mB{destroy(e){this.map.forEach(e=>e.mesh.destroy());}constructor(){this.map=new Map;}}let mU=new t8,mk=(e,t)=>{let s=mU.get(e,()=>new mB),i=s.map.get(t);if(!i){let n,r;switch(t){case "box":n=aG.fromGeometry(e,new dr),r={x:2,y:2,z:2,uv:2/3};break;case "capsule":n=aG.fromGeometry(e,new cz({radius:.5,height:2})),r={x:2*Math.PI,y:Math.PI,z:2*Math.PI,uv:1/3+1/3/3*2};break;case "cone":n=aG.fromGeometry(e,new cV({baseRadius:.5,peakRadius:0,height:1})),r={x:2.54,y:2.54,z:2.54,uv:1/3+1/3/3};break;case "cylinder":n=aG.fromGeometry(e,new cG({radius:.5,height:1})),r={x:Math.PI,y:1.58,z:Math.PI,uv:1/3+1/3/3*2};break;case "plane":n=aG.fromGeometry(e,new cH({halfExtents:new ef(.5,.5),widthSegments:1,lengthSegments:1})),r={x:0,y:1,z:0,uv:1};break;case "sphere":n=aG.fromGeometry(e,new da({radius:.5})),r={x:Math.PI,y:Math.PI,z:Math.PI,uv:1};break;case "torus":n=aG.fromGeometry(e,new cW({tubeRadius:.2,ringRadius:.3})),r={x:.25*Math.PI-.1*Math.PI*.1,y:.4,z:.4,uv:1};break;default:throw Error("Invalid primitive type: "+t)}n.incRefCount(),i={mesh:n,area:r},s.map.set(t,i);}return i};class mz extends u8{set meshInstances(e){this._model&&(this._model.meshInstances=e);}get meshInstances(){return this._model?this._model.meshInstances:null}set customAabb(e){if(this._customAabb=e,this._model){let e=this._model.meshInstances;if(e)for(let t=0;t<e.length;t++)e[t].setCustomAabb(this._customAabb);}}get customAabb(){return this._customAabb}set type(e){if(this._type!==e){if(this._area=null,this._type=e,"asset"===e)null!==this._asset?this._bindModelAsset(this._asset):this.model=null;else {let t=mk(this.system.app.graphicsDevice,e);this._area=t.area;let s=t.mesh,i=new oE,n=new hh;n.graph=i,n.meshInstances=[new a0(s,this._material,i)],this.model=n,this._asset=null;}}}get type(){return this._type}set asset(e){let t=this.system.app.assets,s=e;if(e instanceof ub&&(s=e.id),this._asset!==s){if(this._asset){t.off("add:"+this._asset,this._onModelAssetAdded,this);let e=t.get(this._asset);e&&this._unbindModelAsset(e);}if(this._asset=s,this._asset){let e=t.get(this._asset);e?this._bindModelAsset(e):(this.model=null,t.on("add:"+this._asset,this._onModelAssetAdded,this));}else this.model=null;}}get asset(){return this._asset}set model(e){if(this._model!==e&&(!e||!e._immutable)&&(this._model&&(this._model._immutable=false,this.removeModelFromLayers(),this._model.getGraph().destroy(),delete this._model._entity,this._clonedModel&&(this._model.destroy(),this._clonedModel=false)),this._model=e,this._model)){this._model._immutable=true;let e=this._model.meshInstances;for(let t=0;t<e.length;t++)e[t].castShadow=this._castShadows,e[t].receiveShadow=this._receiveShadows,e[t].setCustomAabb(this._customAabb);this.lightmapped=this._lightmapped,this.entity.addChild(this._model.graph),this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._model._entity=this.entity,this.entity.animation&&this.entity.animation.setModel(this._model),this.entity.anim&&this.entity.anim.rebind(),"asset"===this.type?this.mapping=this._mapping:this._unsetMaterialEvents();}}get model(){return this._model}set lightmapped(e){if(e!==this._lightmapped&&(this._lightmapped=e,this._model)){let t=this._model.meshInstances;for(let s=0;s<t.length;s++)t[s].setLightmapped(e);}}get lightmapped(){return this._lightmapped}set castShadows(e){if(this._castShadows===e)return;let t=this._model;if(t){let s=this.layers,i=this.system.app.scene;if(this._castShadows&&!e)for(let e=0;e<s.length;e++){let s=this.system.app.scene.layers.getLayerById(this.layers[e]);s&&s.removeShadowCasters(t.meshInstances);}let n=t.meshInstances;for(let t=0;t<n.length;t++)n[t].castShadow=e;if(!this._castShadows&&e)for(let e=0;e<s.length;e++){let n=i.layers.getLayerById(s[e]);n&&n.addShadowCasters(t.meshInstances);}}this._castShadows=e;}get castShadows(){return this._castShadows}set receiveShadows(e){if(this._receiveShadows!==e&&(this._receiveShadows=e,this._model)){let t=this._model.meshInstances;for(let s=0,i=t.length;s<i;s++)t[s].receiveShadow=e;}}get receiveShadows(){return this._receiveShadows}set castShadowsLightmap(e){this._castShadowsLightmap=e;}get castShadowsLightmap(){return this._castShadowsLightmap}set lightmapSizeMultiplier(e){this._lightmapSizeMultiplier=e;}get lightmapSizeMultiplier(){return this._lightmapSizeMultiplier}set layers(e){let t=this.system.app.scene.layers;if(this.meshInstances)for(let e=0;e<this._layers.length;e++){let s=t.getLayerById(this._layers[e]);s&&s.removeMeshInstances(this.meshInstances);}this._layers.length=0;for(let t=0;t<e.length;t++)this._layers[t]=e[t];if(this.enabled&&this.entity.enabled&&this.meshInstances)for(let e=0;e<this._layers.length;e++){let s=t.getLayerById(this._layers[e]);s&&s.addMeshInstances(this.meshInstances);}}get layers(){return this._layers}set batchGroupId(e){var t,s;this._batchGroupId!==e&&(this.entity.enabled&&this._batchGroupId>=0&&(null==(t=this.system.app.batcher)||t.remove(aF.MODEL,this.batchGroupId,this.entity)),this.entity.enabled&&e>=0&&(null==(s=this.system.app.batcher)||s.insert(aF.MODEL,e,this.entity)),e<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._batchGroupId=e);}get batchGroupId(){return this._batchGroupId}set materialAsset(e){let t=e;e instanceof ub&&(t=e.id);let s=this.system.app.assets;if(t!==this._materialAsset){if(this._materialAsset){s.off("add:"+this._materialAsset,this._onMaterialAssetAdd,this);let e=s.get(this._materialAsset);e&&this._unbindMaterialAsset(e);}if(this._materialAsset=t,this._materialAsset){let e=s.get(this._materialAsset);e?this._bindMaterialAsset(e):(this._setMaterial(this.system.defaultMaterial),s.on("add:"+this._materialAsset,this._onMaterialAssetAdd,this));}else this._setMaterial(this.system.defaultMaterial);}}get materialAsset(){return this._materialAsset}set material(e){this._material!==e&&(this.materialAsset=null,this._setMaterial(e));}get material(){return this._material}set mapping(e){if("asset"!==this._type||(this._unsetMaterialEvents(),e||(e={}),this._mapping=e,!this._model))return;let t=this._model.meshInstances,s=this.asset?this.system.app.assets.get(this.asset):null,i=s?s.data.mapping:null,n=null;for(let s=0,r=t.length;s<r;s++)if(void 0!==e[s])e[s]?(n=this.system.app.assets.get(e[s]),this._loadAndSetMeshInstanceMaterial(n,t[s],s)):t[s].material=this.system.defaultMaterial;else if(i){if(i[s]&&(i[s].material||i[s].path)){if(void 0!==i[s].material)n=this.system.app.assets.get(i[s].material);else if(void 0!==i[s].path){let e=this._getMaterialAssetUrl(i[s].path);e&&(n=this.system.app.assets.getByUrl(e));}this._loadAndSetMeshInstanceMaterial(n,t[s],s);}else t[s].material=this.system.defaultMaterial;}}get mapping(){return this._mapping}addModelToLayers(){let e=this.system.app.scene.layers;for(let t=0;t<this._layers.length;t++){let s=e.getLayerById(this._layers[t]);s&&s.addMeshInstances(this.meshInstances);}}removeModelFromLayers(){let e=this.system.app.scene.layers;for(let t=0;t<this._layers.length;t++){let s=e.getLayerById(this._layers[t]);s&&s.removeMeshInstances(this.meshInstances);}}onRemoveChild(){this._model&&this.removeModelFromLayers();}onInsertChild(){this._model&&this.enabled&&this.entity.enabled&&this.addModelToLayers();}onRemove(){this.asset=null,this.model=null,this.materialAsset=null,this._unsetMaterialEvents(),this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this);}onLayersChanged(e,t){this.addModelToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this);}onLayerAdded(e){0>this.layers.indexOf(e.id)||e.addMeshInstances(this.meshInstances);}onLayerRemoved(e){0>this.layers.indexOf(e.id)||e.removeMeshInstances(this.meshInstances);}_setMaterialEvent(e,t,s,i){let n=t+":"+s;this.system.app.assets.on(n,i,this),this._materialEvents||(this._materialEvents=[]),this._materialEvents[e]||(this._materialEvents[e]={}),this._materialEvents[e][n]={id:s,handler:i};}_unsetMaterialEvents(){let e=this.system.app.assets,t=this._materialEvents;if(t){for(let s=0,i=t.length;s<i;s++){if(!t[s])continue;let i=t[s];for(let t in i)e.off(t,i[t].handler,this);}this._materialEvents=null;}}_getAssetByIdOrPath(e){let t=null;if(isNaN(parseInt(e,10))){if(this.asset){let s=this._getMaterialAssetUrl(e);s&&(t=this.system.app.assets.getByUrl(s));}}else t=this.system.app.assets.get(e);return t}_getMaterialAssetUrl(e){if(!this.asset)return null;let t=this.system.app.assets.get(this.asset);return t?t.getAbsoluteUrl(e):null}_loadAndSetMeshInstanceMaterial(e,t,s){let i=this.system.app.assets;e&&(e.resource?(t.material=e.resource,this._setMaterialEvent(s,"remove",e.id,function(){t.material=this.system.defaultMaterial;})):(this._setMaterialEvent(s,"load",e.id,function(i){t.material=i.resource,this._setMaterialEvent(s,"remove",e.id,function(){t.material=this.system.defaultMaterial;});}),this.enabled&&this.entity.enabled&&i.load(e)));}onEnable(){let e;let t=this.system.app,s=t.scene,i=null==s?void 0:s.layers;this._evtLayersChanged=s.on("set:layers",this.onLayersChanged,this),i&&(this._evtLayerAdded=i.on("add",this.onLayerAdded,this),this._evtLayerRemoved=i.on("remove",this.onLayerRemoved,this));let n="asset"===this._type;if(this._model?this.addModelToLayers():n&&this._asset&&(e=t.assets.get(this._asset))&&e.resource!==this._model&&this._bindModelAsset(e),this._materialAsset&&(e=t.assets.get(this._materialAsset))&&e.resource!==this._material&&this._bindMaterialAsset(e),n&&this._mapping)for(let s in this._mapping)this._mapping[s]&&(e=this._getAssetByIdOrPath(this._mapping[s]))&&!e.resource&&t.assets.load(e);if(this._batchGroupId>=0){var r;null==(r=t.batcher)||r.insert(aF.MODEL,this.batchGroupId,this.entity);}}onDisable(){var e,t,s,i;let n=this.system.app,r=n.scene.layers;null==(e=this._evtLayersChanged)||e.off(),this._evtLayersChanged=null,r&&(null==(t=this._evtLayerAdded)||t.off(),this._evtLayerAdded=null,null==(s=this._evtLayerRemoved)||s.off(),this._evtLayerRemoved=null),this._batchGroupId>=0&&(null==(i=n.batcher)||i.remove(aF.MODEL,this.batchGroupId,this.entity)),this._model&&this.removeModelFromLayers();}hide(){if(this._model){let e=this._model.meshInstances;for(let t=0,s=e.length;t<s;t++)e[t].visible=false;}}show(){if(this._model){let e=this._model.meshInstances;for(let t=0,s=e.length;t<s;t++)e[t].visible=true;}}_bindMaterialAsset(e){if(e.on("load",this._onMaterialAssetLoad,this),e.on("unload",this._onMaterialAssetUnload,this),e.on("remove",this._onMaterialAssetRemove,this),e.on("change",this._onMaterialAssetChange,this),e.resource)this._onMaterialAssetLoad(e);else {if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e);}}_unbindMaterialAsset(e){e.off("load",this._onMaterialAssetLoad,this),e.off("unload",this._onMaterialAssetUnload,this),e.off("remove",this._onMaterialAssetRemove,this),e.off("change",this._onMaterialAssetChange,this);}_onMaterialAssetAdd(e){this.system.app.assets.off("add:"+e.id,this._onMaterialAssetAdd,this),this._materialAsset===e.id&&this._bindMaterialAsset(e);}_onMaterialAssetLoad(e){this._setMaterial(e.resource);}_onMaterialAssetUnload(e){this._setMaterial(this.system.defaultMaterial);}_onMaterialAssetRemove(e){this._onMaterialAssetUnload(e);}_onMaterialAssetChange(e){}_bindModelAsset(e){if(this._unbindModelAsset(e),e.on("load",this._onModelAssetLoad,this),e.on("unload",this._onModelAssetUnload,this),e.on("change",this._onModelAssetChange,this),e.on("remove",this._onModelAssetRemove,this),e.resource)this._onModelAssetLoad(e);else {if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e);}}_unbindModelAsset(e){e.off("load",this._onModelAssetLoad,this),e.off("unload",this._onModelAssetUnload,this),e.off("change",this._onModelAssetChange,this),e.off("remove",this._onModelAssetRemove,this);}_onModelAssetAdded(e){this.system.app.assets.off("add:"+e.id,this._onModelAssetAdded,this),e.id===this._asset&&this._bindModelAsset(e);}_onModelAssetLoad(e){this.model=e.resource.clone(),this._clonedModel=true;}_onModelAssetUnload(e){this.model=null;}_onModelAssetChange(e,t,s,i){"data"===t&&(this.mapping=this._mapping);}_onModelAssetRemove(e){this.model=null;}_setMaterial(e){if(this._material===e)return;this._material=e;let t=this._model;if(t&&"asset"!==this._type){let s=t.meshInstances;for(let t=0,i=s.length;t<i;t++)s[t].material=e;}}constructor(e,t){super(e,t),this._type="asset",this._asset=null,this._model=null,this._mapping={},this._castShadows=true,this._receiveShadows=true,this._materialAsset=null,this._castShadowsLightmap=true,this._lightmapped=false,this._lightmapSizeMultiplier=1,this.isStatic=false,this._layers=[0],this._batchGroupId=-1,this._customAabb=null,this._area=null,this._materialEvents=null,this._clonedModel=false,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._material=e.defaultMaterial,t.on("remove",this.onRemoveChild,this),t.on("removehierarchy",this.onRemoveChild,this),t.on("insert",this.onInsertChild,this),t.on("inserthierarchy",this.onInsertChild,this);}}class mV{constructor(){this.enabled=true;}}let mG=["enabled"];class mH extends u9{initializeComponentData(e,t,s){s=["material","materialAsset","asset","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","type","mapping","layers","isStatic","batchGroupId"],(null===t.batchGroupId||void 0===t.batchGroupId)&&(t.batchGroupId=-1),t.layers&&t.layers.length&&(t.layers=t.layers.slice(0));for(let i=0;i<s.length;i++)t.hasOwnProperty(s[i])&&(e[s[i]]=t[s[i]]);t.aabbCenter&&t.aabbHalfExtents&&(e.customAabb=new eP(new eu(t.aabbCenter),new eu(t.aabbHalfExtents))),super.initializeComponentData(e,t,["enabled"]);}cloneComponent(e,t){let s={type:e.model.type,asset:e.model.asset,castShadows:e.model.castShadows,receiveShadows:e.model.receiveShadows,castShadowsLightmap:e.model.castShadowsLightmap,lightmapped:e.model.lightmapped,lightmapSizeMultiplier:e.model.lightmapSizeMultiplier,isStatic:e.model.isStatic,enabled:e.model.enabled,layers:e.model.layers,batchGroupId:e.model.batchGroupId,mapping:C({},e.model.mapping)},i=e.model.materialAsset;i instanceof ub||null==i||(i=this.app.assets.get(i));let n=e.model.material;n&&n!==this.defaultMaterial&&i&&n!==i.resource||(s.materialAsset=i);let r=this.addComponent(t,s);if(e.model.model&&"asset"===e.model.type&&!e.model.asset&&(r.model=e.model.model.clone(),r._clonedModel=true),s.materialAsset||(r.material=n),e.model.model){let t=e.model.model.meshInstances,s=r.model.meshInstances;for(let e=0;e<t.length;e++)s[e].mask=t[e].mask,s[e].material=t[e].material,s[e].layer=t[e].layer,s[e].receiveShadow=t[e].receiveShadow;}return e.model.customAabb&&(r.customAabb=e.model.customAabb.clone()),r}onRemove(e,t){t.onRemove();}constructor(e){super(e),this.id="model",this.ComponentType=mz,this.DataType=mV,this.schema=mG,this.defaultMaterial=aW(e.graphicsDevice),this.on("beforeremove",this.onRemove,this);}}u8._buildAccessors(mz.prototype,mG);let mW=["emitterExtents","emitterRadius","emitterExtentsInner","emitterRadiusInner","loop","initialVelocity","animSpeed","normalMap","particleNormal"],mX=["numParticles","lifetime","rate","rate2","startAngle","startAngle2","lighting","halfLambert","intensity","wrap","wrapBounds","depthWrite","noFog","sort","stretch","alignToMotion","preWarm","emitterShape","animTilesX","animTilesY","animStartFrame","animNumFrames","animNumAnimations","animIndex","randomizeAnimIndex","animLoop","colorMap","localSpace","screenSpace","orientation"],mY=["scaleGraph","scaleGraph2","colorGraph","colorGraph2","alphaGraph","alphaGraph2","velocityGraph","velocityGraph2","localVelocityGraph","localVelocityGraph2","rotationSpeedGraph","rotationSpeedGraph2","radialSpeedGraph","radialSpeedGraph2"],mj=["colorMapAsset","normalMapAsset","meshAsset","renderAsset"];class mq extends u8{get data(){let e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){this._setValue("enabled",e);}get enabled(){return this.data.enabled}set autoPlay(e){this._setValue("autoPlay",e);}get autoPlay(){return this.data.autoPlay}set numParticles(e){this._setValue("numParticles",e);}get numParticles(){return this.data.numParticles}set lifetime(e){this._setValue("lifetime",e);}get lifetime(){return this.data.lifetime}set rate(e){this._setValue("rate",e);}get rate(){return this.data.rate}set rate2(e){this._setValue("rate2",e);}get rate2(){return this.data.rate2}set startAngle(e){this._setValue("startAngle",e);}get startAngle(){return this.data.startAngle}set startAngle2(e){this._setValue("startAngle2",e);}get startAngle2(){return this.data.startAngle2}set loop(e){this._setValue("loop",e);}get loop(){return this.data.loop}set preWarm(e){this._setValue("preWarm",e);}get preWarm(){return this.data.preWarm}set lighting(e){this._setValue("lighting",e);}get lighting(){return this.data.lighting}set halfLambert(e){this._setValue("halfLambert",e);}get halfLambert(){return this.data.halfLambert}set intensity(e){this._setValue("intensity",e);}get intensity(){return this.data.intensity}set depthWrite(e){this._setValue("depthWrite",e);}get depthWrite(){return this.data.depthWrite}set noFog(e){this._setValue("noFog",e);}get noFog(){return this.data.noFog}set depthSoftening(e){this._setValue("depthSoftening",e);}get depthSoftening(){return this.data.depthSoftening}set sort(e){this._setValue("sort",e);}get sort(){return this.data.sort}set blendType(e){this._setValue("blendType",e);}get blendType(){return this.data.blendType}set stretch(e){this._setValue("stretch",e);}get stretch(){return this.data.stretch}set alignToMotion(e){this._setValue("alignToMotion",e);}get alignToMotion(){return this.data.alignToMotion}set emitterShape(e){this._setValue("emitterShape",e);}get emitterShape(){return this.data.emitterShape}set emitterExtents(e){this._setValue("emitterExtents",e);}get emitterExtents(){return this.data.emitterExtents}set emitterExtentsInner(e){this._setValue("emitterExtentsInner",e);}get emitterExtentsInner(){return this.data.emitterExtentsInner}set emitterRadius(e){this._setValue("emitterRadius",e);}get emitterRadius(){return this.data.emitterRadius}set emitterRadiusInner(e){this._setValue("emitterRadiusInner",e);}get emitterRadiusInner(){return this.data.emitterRadiusInner}set initialVelocity(e){this._setValue("initialVelocity",e);}get initialVelocity(){return this.data.initialVelocity}set wrap(e){this._setValue("wrap",e);}get wrap(){return this.data.wrap}set wrapBounds(e){this._setValue("wrapBounds",e);}get wrapBounds(){return this.data.wrapBounds}set localSpace(e){this._setValue("localSpace",e);}get localSpace(){return this.data.localSpace}set screenSpace(e){this._setValue("screenSpace",e);}get screenSpace(){return this.data.screenSpace}set colorMapAsset(e){this._setValue("colorMapAsset",e);}get colorMapAsset(){return this.data.colorMapAsset}set normalMapAsset(e){this._setValue("normalMapAsset",e);}get normalMapAsset(){return this.data.normalMapAsset}set mesh(e){this._setValue("mesh",e);}get mesh(){return this.data.mesh}set meshAsset(e){this._setValue("meshAsset",e);}get meshAsset(){return this.data.meshAsset}set renderAsset(e){this._setValue("renderAsset",e);}get renderAsset(){return this.data.renderAsset}set orientation(e){this._setValue("orientation",e);}get orientation(){return this.data.orientation}set particleNormal(e){this._setValue("particleNormal",e);}get particleNormal(){return this.data.particleNormal}set localVelocityGraph(e){this._setValue("localVelocityGraph",e);}get localVelocityGraph(){return this.data.localVelocityGraph}set localVelocityGraph2(e){this._setValue("localVelocityGraph2",e);}get localVelocityGraph2(){return this.data.localVelocityGraph2}set velocityGraph(e){this._setValue("velocityGraph",e);}get velocityGraph(){return this.data.velocityGraph}set velocityGraph2(e){this._setValue("velocityGraph2",e);}get velocityGraph2(){return this.data.velocityGraph2}set rotationSpeedGraph(e){this._setValue("rotationSpeedGraph",e);}get rotationSpeedGraph(){return this.data.rotationSpeedGraph}set rotationSpeedGraph2(e){this._setValue("rotationSpeedGraph2",e);}get rotationSpeedGraph2(){return this.data.rotationSpeedGraph2}set radialSpeedGraph(e){this._setValue("radialSpeedGraph",e);}get radialSpeedGraph(){return this.data.radialSpeedGraph}set radialSpeedGraph2(e){this._setValue("radialSpeedGraph2",e);}get radialSpeedGraph2(){return this.data.radialSpeedGraph2}set scaleGraph(e){this._setValue("scaleGraph",e);}get scaleGraph(){return this.data.scaleGraph}set scaleGraph2(e){this._setValue("scaleGraph2",e);}get scaleGraph2(){return this.data.scaleGraph2}set colorGraph(e){this._setValue("colorGraph",e);}get colorGraph(){return this.data.colorGraph}set colorGraph2(e){this._setValue("colorGraph2",e);}get colorGraph2(){return this.data.colorGraph2}set alphaGraph(e){this._setValue("alphaGraph",e);}get alphaGraph(){return this.data.alphaGraph}set alphaGraph2(e){this._setValue("alphaGraph2",e);}get alphaGraph2(){return this.data.alphaGraph2}set colorMap(e){this._setValue("colorMap",e);}get colorMap(){return this.data.colorMap}set normalMap(e){this._setValue("normalMap",e);}get normalMap(){return this.data.normalMap}set animTilesX(e){this._setValue("animTilesX",e);}get animTilesX(){return this.data.animTilesX}set animTilesY(e){this._setValue("animTilesY",e);}get animTilesY(){return this.data.animTilesY}set animStartFrame(e){this._setValue("animStartFrame",e);}get animStartFrame(){return this.data.animStartFrame}set animNumFrames(e){this._setValue("animNumFrames",e);}get animNumFrames(){return this.data.animNumFrames}set animNumAnimations(e){this._setValue("animNumAnimations",e);}get animNumAnimations(){return this.data.animNumAnimations}set animIndex(e){this._setValue("animIndex",e);}get animIndex(){return this.data.animIndex}set randomizeAnimIndex(e){this._setValue("randomizeAnimIndex",e);}get randomizeAnimIndex(){return this.data.randomizeAnimIndex}set animSpeed(e){this._setValue("animSpeed",e);}get animSpeed(){return this.data.animSpeed}set animLoop(e){this._setValue("animLoop",e);}get animLoop(){return this.data.animLoop}set layers(e){this._setValue("layers",e);}get layers(){return this.data.layers}set drawOrder(e){this._drawOrder=e,this.emitter&&(this.emitter.drawOrder=e);}get drawOrder(){return this._drawOrder}_setValue(e,t){let s=this.data,i=s[e];s[e]=t,this.fire("set",e,i,t);}addMeshInstanceToLayers(){if(this.emitter)for(let e=0;e<this.layers.length;e++){let t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&(t.addMeshInstances([this.emitter.meshInstance]),this.emitter._layer=t);}}removeMeshInstanceFromLayers(){if(this.emitter)for(let e=0;e<this.layers.length;e++){let t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&t.removeMeshInstances([this.emitter.meshInstance]);}}onSetLayers(e,t,s){if(this.emitter){for(let e=0;e<t.length;e++){let s=this.system.app.scene.layers.getLayerById(t[e]);s&&s.removeMeshInstances([this.emitter.meshInstance]);}if(this.enabled&&this.entity.enabled)for(let e=0;e<s.length;e++){let t=this.system.app.scene.layers.getLayerById(s[e]);t&&t.addMeshInstances([this.emitter.meshInstance]);}}}onLayersChanged(e,t){this.addMeshInstanceToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this);}onLayerAdded(e){this.emitter&&(0>this.layers.indexOf(e.id)||e.addMeshInstances([this.emitter.meshInstance]));}onLayerRemoved(e){this.emitter&&(0>this.layers.indexOf(e.id)||e.removeMeshInstances([this.emitter.meshInstance]));}_bindColorMapAsset(e){if(e.on("load",this._onColorMapAssetLoad,this),e.on("unload",this._onColorMapAssetUnload,this),e.on("remove",this._onColorMapAssetRemove,this),e.on("change",this._onColorMapAssetChange,this),e.resource)this._onColorMapAssetLoad(e);else {if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e);}}_unbindColorMapAsset(e){e.off("load",this._onColorMapAssetLoad,this),e.off("unload",this._onColorMapAssetUnload,this),e.off("remove",this._onColorMapAssetRemove,this),e.off("change",this._onColorMapAssetChange,this);}_onColorMapAssetLoad(e){this.colorMap=e.resource;}_onColorMapAssetUnload(e){this.colorMap=null;}_onColorMapAssetRemove(e){this._onColorMapAssetUnload(e);}_onColorMapAssetChange(e){}onSetColorMapAsset(e,t,s){let i=this.system.app.assets;if(t){let e=i.get(t);e&&this._unbindColorMapAsset(e);}if(s){s instanceof ub&&(this.data.colorMapAsset=s.id,s=s.id);let e=i.get(s);e?this._bindColorMapAsset(e):i.once("add:"+s,e=>{this._bindColorMapAsset(e);});}else this.colorMap=null;}_bindNormalMapAsset(e){if(e.on("load",this._onNormalMapAssetLoad,this),e.on("unload",this._onNormalMapAssetUnload,this),e.on("remove",this._onNormalMapAssetRemove,this),e.on("change",this._onNormalMapAssetChange,this),e.resource)this._onNormalMapAssetLoad(e);else {if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e);}}_unbindNormalMapAsset(e){e.off("load",this._onNormalMapAssetLoad,this),e.off("unload",this._onNormalMapAssetUnload,this),e.off("remove",this._onNormalMapAssetRemove,this),e.off("change",this._onNormalMapAssetChange,this);}_onNormalMapAssetLoad(e){this.normalMap=e.resource;}_onNormalMapAssetUnload(e){this.normalMap=null;}_onNormalMapAssetRemove(e){this._onNormalMapAssetUnload(e);}_onNormalMapAssetChange(e){}onSetNormalMapAsset(e,t,s){let i=this.system.app.assets;if(t){let e=i.get(t);e&&this._unbindNormalMapAsset(e);}if(s){s instanceof ub&&(this.data.normalMapAsset=s.id,s=s.id);let e=i.get(s);e?this._bindNormalMapAsset(e):i.once("add:"+s,e=>{this._bindNormalMapAsset(e);});}else this.normalMap=null;}_bindMeshAsset(e){if(e.on("load",this._onMeshAssetLoad,this),e.on("unload",this._onMeshAssetUnload,this),e.on("remove",this._onMeshAssetRemove,this),e.on("change",this._onMeshAssetChange,this),e.resource)this._onMeshAssetLoad(e);else {if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e);}}_unbindMeshAsset(e){e.off("load",this._onMeshAssetLoad,this),e.off("unload",this._onMeshAssetUnload,this),e.off("remove",this._onMeshAssetRemove,this),e.off("change",this._onMeshAssetChange,this);}_onMeshAssetLoad(e){this._onMeshChanged(e.resource);}_onMeshAssetUnload(e){this.mesh=null;}_onMeshAssetRemove(e){this._onMeshAssetUnload(e);}_onMeshAssetChange(e){}onSetMeshAsset(e,t,s){let i=this.system.app.assets;if(t){let e=i.get(t);e&&this._unbindMeshAsset(e);}if(s){s instanceof ub&&(this.data.meshAsset=s.id,s=s.id);let e=i.get(s);e&&this._bindMeshAsset(e);}else this._onMeshChanged(null);}onSetMesh(e,t,s){!s||s instanceof ub||"number"==typeof s?this.meshAsset=s:this._onMeshChanged(s);}_onMeshChanged(e){!e||e instanceof aG||(e=e.meshInstances[0]?e.meshInstances[0].mesh:null),this.data.mesh=e,this.emitter&&(this.emitter.mesh=e,this.emitter.resetMaterial(),this.rebuild());}onSetRenderAsset(e,t,s){let i=this.system.app.assets;if(t){let e=i.get(t);e&&this._unbindRenderAsset(e);}if(s){s instanceof ub&&(this.data.renderAsset=s.id,s=s.id);let e=i.get(s);e&&this._bindRenderAsset(e);}else this._onRenderChanged(null);}_bindRenderAsset(e){if(e.on("load",this._onRenderAssetLoad,this),e.on("unload",this._onRenderAssetUnload,this),e.on("remove",this._onRenderAssetRemove,this),e.resource)this._onRenderAssetLoad(e);else {if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e);}}_unbindRenderAsset(e){var t;e.off("load",this._onRenderAssetLoad,this),e.off("unload",this._onRenderAssetUnload,this),e.off("remove",this._onRenderAssetRemove,this),null==(t=this._evtSetMeshes)||t.off(),this._evtSetMeshes=null;}_onRenderAssetLoad(e){this._onRenderChanged(e.resource);}_onRenderAssetUnload(e){this._onRenderChanged(null);}_onRenderAssetRemove(e){this._onRenderAssetUnload(e);}_onRenderChanged(e){var t;if(!e){this._onMeshChanged(null);return}null==(t=this._evtSetMeshes)||t.off(),this._evtSetMeshes=e.on("set:meshes",this._onRenderSetMeshes,this),e.meshes&&this._onRenderSetMeshes(e.meshes);}_onRenderSetMeshes(e){this._onMeshChanged(e&&e[0]);}onSetLoop(e,t,s){this.emitter&&(this.emitter[e]=s,this.emitter.resetTime());}onSetBlendType(e,t,s){this.emitter&&(this.emitter[e]=s,this.emitter.material.blendType=s,this.emitter.resetMaterial(),this.rebuild());}_requestDepth(){!this._requestedDepth&&(l||(l=this.system.app.scene.layers.getLayerById(1)),l&&(l.incrementCounter(),this._requestedDepth=true));}_releaseDepth(){this._requestedDepth&&l&&(l.decrementCounter(),this._requestedDepth=false);}onSetDepthSoftening(e,t,s){t!==s&&(s?this.enabled&&this.entity.enabled&&this._requestDepth():this.enabled&&this.entity.enabled&&this._releaseDepth(),this.emitter&&(this.emitter[e]=s),this.emitter&&(this.reset(),this.emitter.resetMaterial(),this.rebuild()));}onSetSimpleProperty(e,t,s){this.emitter&&(this.emitter[e]=s,this.emitter.resetMaterial());}onSetComplexProperty(e,t,s){this.emitter&&(this.emitter[e]=s,this.emitter.resetMaterial(),this.rebuild(),this.reset());}onSetGraphProperty(e,t,s){this.emitter&&(this.emitter[e]=s,this.emitter.rebuildGraphs(),this.emitter.resetMaterial());}onEnable(){let e=this.system.app.scene,t=e.layers,s=this.data;for(let e=0,t=mj.length;e<t;e++){let t=s[mj[e]];if(t){if(!(t instanceof ub)){if(!(parseInt(t,10)>=0))continue;t=this.system.app.assets.get(t);}t&&!t.resource&&this.system.app.assets.load(t);}}if(!this.system.app.graphicsDevice.disableParticleSystem){if(!this.emitter){let e=s.mesh;e instanceof aG||(e=null),this.emitter=new h5(this.system.app.graphicsDevice,{numParticles:s.numParticles,emitterExtents:s.emitterExtents,emitterExtentsInner:s.emitterExtentsInner,emitterRadius:s.emitterRadius,emitterRadiusInner:s.emitterRadiusInner,emitterShape:s.emitterShape,initialVelocity:s.initialVelocity,wrap:s.wrap,localSpace:s.localSpace,screenSpace:s.screenSpace,wrapBounds:s.wrapBounds,lifetime:s.lifetime,rate:s.rate,rate2:s.rate2,orientation:s.orientation,particleNormal:s.particleNormal,animTilesX:s.animTilesX,animTilesY:s.animTilesY,animStartFrame:s.animStartFrame,animNumFrames:s.animNumFrames,animNumAnimations:s.animNumAnimations,animIndex:s.animIndex,randomizeAnimIndex:s.randomizeAnimIndex,animSpeed:s.animSpeed,animLoop:s.animLoop,startAngle:s.startAngle,startAngle2:s.startAngle2,scaleGraph:s.scaleGraph,scaleGraph2:s.scaleGraph2,colorGraph:s.colorGraph,colorGraph2:s.colorGraph2,alphaGraph:s.alphaGraph,alphaGraph2:s.alphaGraph2,localVelocityGraph:s.localVelocityGraph,localVelocityGraph2:s.localVelocityGraph2,velocityGraph:s.velocityGraph,velocityGraph2:s.velocityGraph2,rotationSpeedGraph:s.rotationSpeedGraph,rotationSpeedGraph2:s.rotationSpeedGraph2,radialSpeedGraph:s.radialSpeedGraph,radialSpeedGraph2:s.radialSpeedGraph2,colorMap:s.colorMap,normalMap:s.normalMap,loop:s.loop,preWarm:s.preWarm,sort:s.sort,stretch:s.stretch,alignToMotion:s.alignToMotion,lighting:s.lighting,halfLambert:s.halfLambert,intensity:s.intensity,depthSoftening:s.depthSoftening,scene:this.system.app.scene,mesh:e,depthWrite:s.depthWrite,noFog:s.noFog,node:this.entity,blendType:s.blendType}),this.emitter.meshInstance.node=this.entity,this.emitter.drawOrder=this.drawOrder,s.autoPlay||(this.pause(),this.emitter.meshInstance.visible=false);}this.emitter.colorMap&&this.addMeshInstanceToLayers(),this._evtLayersChanged=e.on("set:layers",this.onLayersChanged,this),t&&(this._evtLayerAdded=t.on("add",this.onLayerAdded,this),this._evtLayerRemoved=t.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&s.depthSoftening&&this._requestDepth();}}onDisable(){var e,t,s;let i=this.system.app.scene.layers;null==(e=this._evtLayersChanged)||e.off(),this._evtLayersChanged=null,i&&(null==(t=this._evtLayerAdded)||t.off(),this._evtLayerAdded=null,null==(s=this._evtLayerRemoved)||s.off(),this._evtLayerRemoved=null),this.emitter&&(this.removeMeshInstanceFromLayers(),this.data.depthSoftening&&this._releaseDepth(),this.emitter.camera=null);}onBeforeRemove(){this.enabled&&(this.enabled=false),this.emitter&&(this.emitter.destroy(),this.emitter=null);for(let e=0;e<mj.length;e++){let t=mj[e];this.data[t]&&(this[t]=null);}this.off();}reset(){this.emitter&&this.emitter.reset();}stop(){this.emitter&&(this.emitter.loop=false,this.emitter.resetTime(),this.emitter.addTime(0,true));}pause(){this.data.paused=true;}unpause(){this.data.paused=false;}play(){this.data.paused=false,this.emitter&&(this.emitter.meshInstance.visible=true,this.emitter.loop=this.data.loop,this.emitter.resetTime());}isPlaying(){return !this.data.paused&&(!!this.emitter&&!!this.emitter.loop||Date.now()<=this.emitter.endTime)}setInTools(){let{emitter:e}=this;e&&!e.inTools&&(e.inTools=true,this.rebuild());}rebuild(){let e=this.enabled;this.enabled=false,this.emitter&&this.emitter.rebuild(),this.enabled=e;}constructor(e,t){super(e,t),this._requestedDepth=false,this._drawOrder=0,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._evtSetMeshes=null,this.on("set_colorMapAsset",this.onSetColorMapAsset,this),this.on("set_normalMapAsset",this.onSetNormalMapAsset,this),this.on("set_meshAsset",this.onSetMeshAsset,this),this.on("set_mesh",this.onSetMesh,this),this.on("set_renderAsset",this.onSetRenderAsset,this),this.on("set_loop",this.onSetLoop,this),this.on("set_blendType",this.onSetBlendType,this),this.on("set_depthSoftening",this.onSetDepthSoftening,this),this.on("set_layers",this.onSetLayers,this),mW.forEach(e=>{this.on("set_"+e,this.onSetSimpleProperty,this);}),mX.forEach(e=>{this.on("set_"+e,this.onSetComplexProperty,this);}),mY.forEach(e=>{this.on("set_"+e,this.onSetGraphProperty,this);});}}class mK{constructor(){this.numParticles=1,this.rate=1,this.rate2=null,this.startAngle=0,this.startAngle2=null,this.lifetime=50,this.emitterExtents=new eu,this.emitterExtentsInner=new eu,this.emitterRadius=0,this.emitterRadiusInner=0,this.emitterShape=0,this.initialVelocity=0,this.wrap=false,this.wrapBounds=new eu,this.localSpace=false,this.screenSpace=false,this.colorMap=null,this.colorMapAsset=null,this.normalMap=null,this.normalMapAsset=null,this.loop=true,this.preWarm=false,this.sort=0,this.mode=0,this.scene=null,this.lighting=false,this.halfLambert=false,this.intensity=1,this.stretch=0,this.alignToMotion=false,this.depthSoftening=0,this.renderAsset=null,this.meshAsset=null,this.mesh=null,this.depthWrite=false,this.noFog=false,this.orientation=0,this.particleNormal=new eu(0,1,0),this.animTilesX=1,this.animTilesY=1,this.animStartFrame=0,this.animNumFrames=1,this.animNumAnimations=1,this.animIndex=0,this.randomizeAnimIndex=false,this.animSpeed=1,this.animLoop=true,this.scaleGraph=null,this.scaleGraph2=null,this.colorGraph=null,this.colorGraph2=null,this.alphaGraph=null,this.alphaGraph2=null,this.localVelocityGraph=null,this.localVelocityGraph2=null,this.velocityGraph=null,this.velocityGraph2=null,this.rotationSpeedGraph=null,this.rotationSpeedGraph2=null,this.radialSpeedGraph=null,this.radialSpeedGraph2=null,this.blendType=2,this.enabled=true,this.paused=false,this.autoPlay=true,this.layers=[0];}}let mZ=["enabled","autoPlay","numParticles","lifetime","rate","rate2","startAngle","startAngle2","loop","preWarm","lighting","halfLambert","intensity","depthWrite","noFog","depthSoftening","sort","blendType","stretch","alignToMotion","emitterShape","emitterExtents","emitterExtentsInner","emitterRadius","emitterRadiusInner","initialVelocity","wrap","wrapBounds","localSpace","screenSpace","colorMapAsset","normalMapAsset","mesh","meshAsset","renderAsset","orientation","particleNormal","localVelocityGraph","localVelocityGraph2","velocityGraph","velocityGraph2","rotationSpeedGraph","rotationSpeedGraph2","radialSpeedGraph","radialSpeedGraph2","scaleGraph","scaleGraph2","colorGraph","colorGraph2","alphaGraph","alphaGraph2","colorMap","normalMap","animTilesX","animTilesY","animStartFrame","animNumFrames","animNumAnimations","animIndex","randomizeAnimIndex","animSpeed","animLoop","layers"];class mQ extends u9{initializeComponentData(e,t,s){let i={};s=[];let n=this.propertyTypes;for(let e in (t.mesh instanceof ub||"number"==typeof t.mesh)&&(t.meshAsset=t.mesh,delete t.mesh),t){if(t.hasOwnProperty(e)&&(s.push(e),i[e]=t[e]),"vec3"===n[e])Array.isArray(i[e])&&(i[e]=new eu(i[e][0],i[e][1],i[e][2]));else if("curve"===n[e]){if(!(i[e]instanceof ea)){let t=i[e].type;i[e]=new ea(i[e].keys),i[e].type=t;}}else if("curveset"===n[e]&&!(i[e]instanceof eo)){let t=i[e].type;i[e]=new eo(i[e].keys),i[e].type=t;}i.layers&&Array.isArray(i.layers)&&(i.layers=i.layers.slice(0));}super.initializeComponentData(e,i,s);}cloneComponent(e,t){let s=e.particlesystem.data,i=this.schema,n={};for(let e=0,t=i.length;e<t;e++){let t=i[e],r=s[t];r instanceof eu||r instanceof ea||r instanceof eo?(r=r.clone(),n[t]=r):"layers"===t?n.layers=s.layers.slice(0):null!=r&&(n[t]=r);}return this.addComponent(t,n)}onUpdate(e){let t;let s=this.store,i=this.app.stats.particles,n=this.app.scene.layers;for(let e=0;e<n.layerList.length;e++)n.layerList[e].requiresLightCube=false;for(let r in s)if(s.hasOwnProperty(r)){let a=s[r],o=a.entity,l=a.data;if(l.enabled&&o.enabled){let s=o.particlesystem.emitter;if(!(null==s?void 0:s.meshInstance.visible))continue;if(s.lighting){let e=l.layers;for(let t=0;t<e.length;t++){let s=n.getLayerById(e[t]);s&&(s.requiresLightCube=true);}}if(!l.paused){if(s.simTime+=e,s.simTime>s.fixedTimeStep&&(t=Math.floor(s.simTime/s.fixedTimeStep),s.simTime-=t*s.fixedTimeStep),t){t=Math.min(t,s.maxSubSteps);for(let e=0;e<t;e++)s.addTime(s.fixedTimeStep,false);i._updatesPerFrame+=t,i._frameTime+=s._addTimeTime,s._addTimeTime=0;}s.finishFrame();}}}}onBeforeRemove(e,t){t.onBeforeRemove();}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this);}constructor(e){super(e),this.id="particlesystem",this.ComponentType=mq,this.DataType=mK,this.schema=mZ,this.propertyTypes={emitterExtents:"vec3",emitterExtentsInner:"vec3",particleNormal:"vec3",wrapBounds:"vec3",localVelocityGraph:"curveset",localVelocityGraph2:"curveset",velocityGraph:"curveset",velocityGraph2:"curveset",colorGraph:"curveset",colorGraph2:"curveset",alphaGraph:"curve",alphaGraph2:"curve",rotationSpeedGraph:"curve",rotationSpeedGraph2:"curve",radialSpeedGraph:"curve",radialSpeedGraph2:"curve",scaleGraph:"curve",scaleGraph2:"curve"},this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("update",this.onUpdate,this);}}class mJ extends s2{constructor(e,t){super(),this.skin=e,this.skinInstance=t;}}class m${static createCachedSkinInstance(e,t,s){let i=m$.getCachedSkinInstance(e,t);return i||((i=new aB(e)).resolve(t,s),m$.addCachedSkinInstance(e,t,i)),i}static getCachedSkinInstance(e,t){let s=null,i=m$._skinInstanceCache.get(t);if(i){let t=i.find(t=>t.skin===e);t&&(t.incRefCount(),s=t.skinInstance);}return s}static addCachedSkinInstance(e,t,s){let i=m$._skinInstanceCache.get(t);i||(i=[],m$._skinInstanceCache.set(t,i));let n=i.find(t=>t.skin===e);n||(n=new mJ(e,s),i.push(n)),n.incRefCount();}static removeCachedSkinInstance(e){if(e){let t=e.rootBone;if(t){let s=m$._skinInstanceCache.get(t);if(s){let i=s.findIndex(t=>t.skinInstance===e);if(i>=0){let n=s[i];n.decRefCount(),0===n.refCount&&(s.splice(i,1),s.length||m$._skinInstanceCache.delete(t),e&&(e.destroy(),n.skinInstance=null));}}}}}}m$._skinInstanceCache=new Map;class m0{set id(e){if(this.url)throw Error("Can't set id and url");this._unbind(),this._id=e,this.asset=this._registry.get(this._id),this._bind();}get id(){return this._id}set url(e){if(this.id)throw Error("Can't set id and url");this._unbind(),this._url=e,this.asset=this._registry.getByUrl(this._url),this._bind();}get url(){return this._url}_bind(){this.id&&(this._onAssetLoad&&(this._evtLoadById=this._registry.on("load:"+this.id,this._onLoad,this)),this._onAssetAdd&&(this._evtAddById=this._registry.once("add:"+this.id,this._onAdd,this)),this._onAssetRemove&&(this._evtRemoveById=this._registry.on("remove:"+this.id,this._onRemove,this)),this._onAssetUnload&&(this._evtUnloadById=this._registry.on("unload:"+this.id,this._onUnload,this))),this.url&&(this._onAssetLoad&&(this._evtLoadByUrl=this._registry.on("load:url:"+this.url,this._onLoad,this)),this._onAssetAdd&&(this._evtAddByUrl=this._registry.once("add:url:"+this.url,this._onAdd,this)),this._onAssetRemove&&(this._evtRemoveByUrl=this._registry.on("remove:url:"+this.url,this._onRemove,this)));}_unbind(){var e,t,s,i,n,r,a;this.id&&(null==(e=this._evtLoadById)||e.off(),this._evtLoadById=null,null==(t=this._evtAddById)||t.off(),this._evtAddById=null,null==(s=this._evtRemoveById)||s.off(),this._evtRemoveById=null,null==(i=this._evtUnloadById)||i.off(),this._evtUnloadById=null),this.url&&(null==(n=this._evtLoadByUrl)||n.off(),this._evtLoadByUrl=null,null==(r=this._evtAddByUrl)||r.off(),this._evtAddByUrl=null,null==(a=this._evtRemoveByUrl)||a.off(),this._evtRemoveByUrl=null);}_onLoad(e){this._onAssetLoad.call(this._scope,this.propertyName,this.parent,e);}_onAdd(e){this.asset=e,this._onAssetAdd.call(this._scope,this.propertyName,this.parent,e);}_onRemove(e){this._onAssetRemove.call(this._scope,this.propertyName,this.parent,e),this.asset=null;}_onUnload(e){this._onAssetUnload.call(this._scope,this.propertyName,this.parent,e);}constructor(e,t,s,i,n){this._evtLoadById=null,this._evtUnloadById=null,this._evtAddById=null,this._evtRemoveById=null,this._evtLoadByUrl=null,this._evtAddByUrl=null,this._evtRemoveByUrl=null,this.propertyName=e,this.parent=t,this._scope=n,this._registry=s,this.id=null,this.url=null,this.asset=null,this._onAssetLoad=i.load,this._onAssetAdd=i.add,this._onAssetRemove=i.remove,this._onAssetUnload=i.unload;}}class m1 extends u8{set renderStyle(e){this._renderStyle!==e&&(this._renderStyle=e,a0._prepareRenderStyleForArray(this._meshInstances,e));}get renderStyle(){return this._renderStyle}set customAabb(e){this._customAabb=e;let t=this._meshInstances;if(t)for(let e=0;e<t.length;e++)t[e].setCustomAabb(this._customAabb);}get customAabb(){return this._customAabb}set type(e){if(this._type!==e&&(this._area=null,this._type=e,this.destroyMeshInstances(),"asset"!==e)){let t=this._material;t&&t!==this.system.defaultMaterial||(t=this._materialReferences[0]&&this._materialReferences[0].asset&&this._materialReferences[0].asset.resource);let s=mk(this.system.app.graphicsDevice,e);this._area=s.area,this.meshInstances=[new a0(s.mesh,t||this.system.defaultMaterial,this.entity)];}}get type(){return this._type}set meshInstances(e){if(this.destroyMeshInstances(),this._meshInstances=e,this._meshInstances){let e=this._meshInstances;for(let t=0;t<e.length;t++)e[t].node||(e[t].node=this.entity),e[t].castShadow=this._castShadows,e[t].receiveShadow=this._receiveShadows,e[t].renderStyle=this._renderStyle,e[t].setLightmapped(this._lightmapped),e[t].setCustomAabb(this._customAabb);this.enabled&&this.entity.enabled&&this.addToLayers();}}get meshInstances(){return this._meshInstances}set lightmapped(e){if(e!==this._lightmapped){this._lightmapped=e;let t=this._meshInstances;if(t)for(let s=0;s<t.length;s++)t[s].setLightmapped(e);}}get lightmapped(){return this._lightmapped}set castShadows(e){if(this._castShadows!==e){let t=this._meshInstances;if(t){let s=this.layers,i=this.system.app.scene;if(this._castShadows&&!e)for(let e=0;e<s.length;e++){let s=i.layers.getLayerById(this.layers[e]);s&&s.removeShadowCasters(t);}for(let s=0;s<t.length;s++)t[s].castShadow=e;if(!this._castShadows&&e)for(let e=0;e<s.length;e++){let n=i.layers.getLayerById(s[e]);n&&n.addShadowCasters(t);}}this._castShadows=e;}}get castShadows(){return this._castShadows}set receiveShadows(e){if(this._receiveShadows!==e){this._receiveShadows=e;let t=this._meshInstances;if(t)for(let s=0;s<t.length;s++)t[s].receiveShadow=e;}}get receiveShadows(){return this._receiveShadows}set castShadowsLightmap(e){this._castShadowsLightmap=e;}get castShadowsLightmap(){return this._castShadowsLightmap}set lightmapSizeMultiplier(e){this._lightmapSizeMultiplier=e;}get lightmapSizeMultiplier(){return this._lightmapSizeMultiplier}set layers(e){let t;let s=this.system.app.scene.layers;if(this._meshInstances)for(let e=0;e<this._layers.length;e++)(t=s.getLayerById(this._layers[e]))&&t.removeMeshInstances(this._meshInstances);this._layers.length=0;for(let t=0;t<e.length;t++)this._layers[t]=e[t];if(this.enabled&&this.entity.enabled&&this._meshInstances)for(let e=0;e<this._layers.length;e++)(t=s.getLayerById(this._layers[e]))&&t.addMeshInstances(this._meshInstances);}get layers(){return this._layers}set batchGroupId(e){if(this._batchGroupId!==e){var t,s;this.entity.enabled&&this._batchGroupId>=0&&(null==(t=this.system.app.batcher)||t.remove(aF.RENDER,this.batchGroupId,this.entity)),this.entity.enabled&&e>=0&&(null==(s=this.system.app.batcher)||s.insert(aF.RENDER,e,this.entity)),e<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addToLayers(),this._batchGroupId=e;}}get batchGroupId(){return this._batchGroupId}set material(e){if(this._material!==e&&(this._material=e,this._meshInstances&&"asset"!==this._type))for(let t=0;t<this._meshInstances.length;t++)this._meshInstances[t].material=e;}get material(){return this._material}set materialAssets(e){if(void 0===e&&(e=[]),this._materialReferences.length>e.length){for(let t=e.length;t<this._materialReferences.length;t++)this._materialReferences[t].id=null;this._materialReferences.length=e.length;}for(let t=0;t<e.length;t++)if(this._materialReferences[t]||this._materialReferences.push(new m0(t,this,this.system.app.assets,{add:this._onMaterialAdded,load:this._onMaterialLoad,remove:this._onMaterialRemove,unload:this._onMaterialUnload},this)),e[t]){let s=e[t]instanceof ub?e[t].id:e[t];this._materialReferences[t].id!==s&&(this._materialReferences[t].id=s),this._materialReferences[t].asset&&this._onMaterialAdded(t,this,this._materialReferences[t].asset);}else this._materialReferences[t].id=null,this._meshInstances[t]&&(this._meshInstances[t].material=this.system.defaultMaterial);}get materialAssets(){return this._materialReferences.map(e=>e.id)}set asset(e){let t=e instanceof ub?e.id:e;this._assetReference.id!==t&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onRenderAssetRemove(),this._assetReference.id=t,this._assetReference.asset&&this._onRenderAssetAdded());}get asset(){return this._assetReference.id}assignAsset(e){let t=e instanceof ub?e.id:e;this._assetReference.id=t;}set rootBone(e){if(this._rootBone!==e){let t="string"==typeof e;(!this._rootBone||!t||this._rootBone.getGuid()!==e)&&(this._rootBone&&this._clearSkinInstances(),e instanceof oE?this._rootBone=e:t?(this._rootBone=this.system.app.getEntityFromIndex(e)||null,this._rootBone):this._rootBone=null,this._rootBone&&this._cloneSkinInstances());}}get rootBone(){return this._rootBone}destroyMeshInstances(){let e=this._meshInstances;if(e){this.removeFromLayers(),this._clearSkinInstances();for(let t=0;t<e.length;t++)e[t].destroy();this._meshInstances.length=0;}}addToLayers(){let e=this.system.app.scene.layers;for(let t=0;t<this._layers.length;t++){let s=e.getLayerById(this._layers[t]);s&&s.addMeshInstances(this._meshInstances);}}removeFromLayers(){if(this._meshInstances&&this._meshInstances.length){let e=this.system.app.scene.layers;for(let t=0;t<this._layers.length;t++){let s=e.getLayerById(this._layers[t]);s&&s.removeMeshInstances(this._meshInstances);}}}onRemoveChild(){this.removeFromLayers();}onInsertChild(){this._meshInstances&&this.enabled&&this.entity.enabled&&this.addToLayers();}onRemove(){this.destroyMeshInstances(),this.asset=null,this.materialAsset=null,this._assetReference.id=null;for(let e=0;e<this._materialReferences.length;e++)this._materialReferences[e].id=null;this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this);}onLayersChanged(e,t){this.addToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this);}onLayerAdded(e){0>this.layers.indexOf(e.id)||e.addMeshInstances(this._meshInstances);}onLayerRemoved(e){0>this.layers.indexOf(e.id)||e.removeMeshInstances(this._meshInstances);}onEnable(){let e=this.system.app,t=e.scene,s=t.layers;this._rootBone&&this._cloneSkinInstances(),this._evtLayersChanged=t.on("set:layers",this.onLayersChanged,this),s&&(this._evtLayerAdded=s.on("add",this.onLayerAdded,this),this._evtLayerRemoved=s.on("remove",this.onLayerRemoved,this));let i="asset"===this._type;this._meshInstances&&this._meshInstances.length?this.addToLayers():i&&this.asset&&this._onRenderAssetAdded();for(let e=0;e<this._materialReferences.length;e++)this._materialReferences[e].asset&&this.system.app.assets.load(this._materialReferences[e].asset);if(this._batchGroupId>=0){var n;null==(n=e.batcher)||n.insert(aF.RENDER,this.batchGroupId,this.entity);}}onDisable(){var e,t,s,i;let n=this.system.app,r=n.scene.layers;null==(e=this._evtLayersChanged)||e.off(),this._evtLayersChanged=null,this._rootBone&&this._clearSkinInstances(),r&&(null==(t=this._evtLayerAdded)||t.off(),this._evtLayerAdded=null,null==(s=this._evtLayerRemoved)||s.off(),this._evtLayerRemoved=null),this._batchGroupId>=0&&(null==(i=n.batcher)||i.remove(aF.RENDER,this.batchGroupId,this.entity)),this.removeFromLayers();}hide(){if(this._meshInstances)for(let e=0;e<this._meshInstances.length;e++)this._meshInstances[e].visible=false;}show(){if(this._meshInstances)for(let e=0;e<this._meshInstances.length;e++)this._meshInstances[e].visible=true;}_onRenderAssetAdded(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onRenderAssetLoad():this.enabled&&this.entity.enabled&&this.system.app.assets.load(this._assetReference.asset));}_onRenderAssetLoad(){if(this.destroyMeshInstances(),this._assetReference.asset){var e;let t=this._assetReference.asset.resource;null==(e=this._evtSetMeshes)||e.off(),this._evtSetMeshes=t.on("set:meshes",this._onSetMeshes,this),t.meshes&&this._onSetMeshes(t.meshes);}}_onSetMeshes(e){this._cloneMeshes(e);}_clearSkinInstances(){for(let e=0;e<this._meshInstances.length;e++){let t=this._meshInstances[e];m$.removeCachedSkinInstance(t.skinInstance),t.skinInstance=null;}}_cloneSkinInstances(){if(this._meshInstances.length&&this._rootBone instanceof oE)for(let e=0;e<this._meshInstances.length;e++){let t=this._meshInstances[e],s=t.mesh;s.skin&&!t.skinInstance&&(t.skinInstance=m$.createCachedSkinInstance(s.skin,this._rootBone,this.entity));}}_cloneMeshes(e){if(e&&e.length){let t=[];for(let s=0;s<e.length;s++){let i=e[s],n=new a0(i,this._materialReferences[s]&&this._materialReferences[s].asset&&this._materialReferences[s].asset.resource||this.system.defaultMaterial,this.entity);t.push(n),i.morph&&(n.morphInstance=new hl(i.morph));}this.meshInstances=t,this._cloneSkinInstances();}}_onRenderAssetUnload(){"asset"===this._type&&this.destroyMeshInstances();}_onRenderAssetRemove(){var e;null==(e=this._evtSetMeshes)||e.off(),this._evtSetMeshes=null,this._onRenderAssetUnload();}_onMaterialAdded(e,t,s){s.resource?this._onMaterialLoad(e,t,s):this.enabled&&this.entity.enabled&&this.system.app.assets.load(s);}_updateMainMaterial(e,t){0===e&&(this.material=t);}_onMaterialLoad(e,t,s){this._meshInstances[e]&&(this._meshInstances[e].material=s.resource),this._updateMainMaterial(e,s.resource);}_onMaterialRemove(e,t,s){this._meshInstances[e]&&(this._meshInstances[e].material=this.system.defaultMaterial),this._updateMainMaterial(e,this.system.defaultMaterial);}_onMaterialUnload(e,t,s){this._meshInstances[e]&&(this._meshInstances[e].material=this.system.defaultMaterial),this._updateMainMaterial(e,this.system.defaultMaterial);}resolveDuplicatedEntityReferenceProperties(e,t){e.rootBone&&(this.rootBone=t[e.rootBone.getGuid()]);}constructor(e,t){super(e,t),this._type="asset",this._castShadows=true,this._receiveShadows=true,this._castShadowsLightmap=true,this._lightmapped=false,this._lightmapSizeMultiplier=1,this.isStatic=false,this._batchGroupId=-1,this._layers=[0],this._renderStyle=0,this._meshInstances=[],this._customAabb=null,this._area=null,this._materialReferences=[],this._rootBone=null,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._evtSetMeshes=null,this._assetReference=new m0("asset",this,e.app.assets,{add:this._onRenderAssetAdded,load:this._onRenderAssetLoad,remove:this._onRenderAssetRemove,unload:this._onRenderAssetUnload},this),this._material=e.defaultMaterial,t.on("remove",this.onRemoveChild,this),t.on("removehierarchy",this.onRemoveChild,this),t.on("insert",this.onInsertChild,this),t.on("inserthierarchy",this.onInsertChild,this);}}class m2{constructor(){this.enabled=true;}}let m3=["enabled"],m4=["material","meshInstances","asset","materialAssets","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","renderStyle","type","layers","isStatic","batchGroupId","rootBone"];class m5 extends u9{initializeComponentData(e,t,s){(null===t.batchGroupId||void 0===t.batchGroupId)&&(t.batchGroupId=-1),t.layers&&t.layers.length&&(t.layers=t.layers.slice(0));for(let s=0;s<m4.length;s++)t.hasOwnProperty(m4[s])&&(e[m4[s]]=t[m4[s]]);t.aabbCenter&&t.aabbHalfExtents&&(e.customAabb=new eP(new eu(t.aabbCenter),new eu(t.aabbHalfExtents))),super.initializeComponentData(e,t,m3);}cloneComponent(e,t){let s={};for(let t=0;t<m4.length;t++)s[m4[t]]=e.render[m4[t]];s.enabled=e.render.enabled,delete s.meshInstances;let i=this.addComponent(t,s),n=e.render.meshInstances,r=n.map(e=>e.mesh);i._onSetMeshes(r);for(let e=0;e<n.length;e++)i.meshInstances[e].material=n[e].material;return e.render.customAabb&&(i.customAabb=e.render.customAabb.clone()),i}onRemove(e,t){t.onRemove();}constructor(e){super(e),this.id="render",this.ComponentType=m1,this.DataType=m2,this.schema=m3,this.defaultMaterial=aW(e.graphicsDevice),this.on("beforeremove",this.onRemove,this);}}u8._buildAccessors(m1.prototype,m3);class m6{_resize(e){if(e>this._pool.length)for(let t=this._pool.length;t<e;t++)this._pool[t]=new this._constructor;}allocate(){return this._count>=this._pool.length&&this._resize(2*this._pool.length),this._pool[this._count++]}freeAll(){this._count=0;}constructor(e,t){this._pool=[],this._count=0,this._constructor=e,this._resize(t);}}let m8=new eT,m9=new eT,m7=new eu;class _e extends u8{static onLibraryLoaded(){"undefined"!=typeof Ammo&&(h=new Ammo.btTransform,d=new Ammo.btVector3,c=new Ammo.btVector3,u=new Ammo.btQuaternion);}static onAppDestroy(){Ammo.destroy(h),Ammo.destroy(d),Ammo.destroy(c),Ammo.destroy(u),h=null,d=null,c=null,u=null;}set angularDamping(e){this._angularDamping!==e&&(this._angularDamping=e,this._body&&this._body.setDamping(this._linearDamping,e));}get angularDamping(){return this._angularDamping}set angularFactor(e){!this._angularFactor.equals(e)&&(this._angularFactor.copy(e),this._body&&this._type===fS&&(d.setValue(e.x,e.y,e.z),this._body.setAngularFactor(d)));}get angularFactor(){return this._angularFactor}set angularVelocity(e){this._body&&this._type===fS&&(this._body.activate(),d.setValue(e.x,e.y,e.z),this._body.setAngularVelocity(d),this._angularVelocity.copy(e));}get angularVelocity(){if(this._body&&this._type===fS){let e=this._body.getAngularVelocity();this._angularVelocity.set(e.x(),e.y(),e.z());}return this._angularVelocity}set body(e){this._body!==e&&(this._body=e,e&&this._simulationEnabled&&e.activate());}get body(){return this._body}set friction(e){this._friction!==e&&(this._friction=e,this._body&&this._body.setFriction(e));}get friction(){return this._friction}set group(e){this._group!==e&&(this._group=e,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()));}get group(){return this._group}set linearDamping(e){this._linearDamping!==e&&(this._linearDamping=e,this._body&&this._body.setDamping(e,this._angularDamping));}get linearDamping(){return this._linearDamping}set linearFactor(e){!this._linearFactor.equals(e)&&(this._linearFactor.copy(e),this._body&&this._type===fS&&(d.setValue(e.x,e.y,e.z),this._body.setLinearFactor(d)));}get linearFactor(){return this._linearFactor}set linearVelocity(e){this._body&&this._type===fS&&(this._body.activate(),d.setValue(e.x,e.y,e.z),this._body.setLinearVelocity(d),this._linearVelocity.copy(e));}get linearVelocity(){if(this._body&&this._type===fS){let e=this._body.getLinearVelocity();this._linearVelocity.set(e.x(),e.y(),e.z());}return this._linearVelocity}set mask(e){this._mask!==e&&(this._mask=e,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()));}get mask(){return this._mask}set mass(e){if(this._mass!==e&&(this._mass=e,this._body&&this._type===fS)){let t=this.enabled&&this.entity.enabled;t&&this.disableSimulation(),this._body.getCollisionShape().calculateLocalInertia(e,d),this._body.setMassProps(e,d),this._body.updateInertiaTensor(),t&&this.enableSimulation();}}get mass(){return this._mass}set restitution(e){this._restitution!==e&&(this._restitution=e,this._body&&this._body.setRestitution(e));}get restitution(){return this._restitution}set rollingFriction(e){this._rollingFriction!==e&&(this._rollingFriction=e,this._body&&this._body.setRollingFriction(e));}get rollingFriction(){return this._rollingFriction}set type(e){if(this._type!==e){switch(this._type=e,this.disableSimulation(),e){case fS:this._group=1,this._mask=65535;break;case fx:this._group=4,this._mask=65535;break;default:this._group=2,this._mask=65533;}this.createBody();}}get type(){return this._type}createBody(){let e;let t=this.entity;if(t.collision&&(e=t.collision.shape,t.trigger&&(t.trigger.destroy(),delete t.trigger)),e){this._body&&(this.system.removeBody(this._body),this.system.destroyBody(this._body),this._body=null);let s=this._type===fS?this._mass:0;this._getEntityTransform(h);let i=this.system.createBody(s,e,h);if(i.setRestitution(this._restitution),i.setFriction(this._friction),i.setRollingFriction(this._rollingFriction),i.setDamping(this._linearDamping,this._angularDamping),this._type===fS){let e=this._linearFactor;d.setValue(e.x,e.y,e.z),i.setLinearFactor(d);let t=this._angularFactor;d.setValue(t.x,t.y,t.z),i.setAngularFactor(d);}else this._type===fx&&(i.setCollisionFlags(2|i.getCollisionFlags()),i.setActivationState(4));i.entity=t,this.body=i,this.enabled&&t.enabled&&this.enableSimulation();}}isActive(){return !!this._body&&this._body.isActive()}activate(){this._body&&this._body.activate();}enableSimulation(){let e=this.entity;if(e.collision&&e.collision.enabled&&!this._simulationEnabled){let t=this._body;if(t){switch(this.system.addBody(t,this._group,this._mask),this._type){case fS:this.system._dynamic.push(this),t.forceActivationState(1),this.syncEntityToBody();break;case fx:this.system._kinematic.push(this),t.forceActivationState(4);break;case fy:t.forceActivationState(1),this.syncEntityToBody();}"compound"===e.collision.type&&this.system._compounds.push(e.collision),t.activate(),this._simulationEnabled=true;}}}disableSimulation(){let e=this._body;if(e&&this._simulationEnabled){let t=this.system,s=t._compounds.indexOf(this.entity.collision);s>-1&&t._compounds.splice(s,1),(s=t._dynamic.indexOf(this))>-1&&t._dynamic.splice(s,1),(s=t._kinematic.indexOf(this))>-1&&t._kinematic.splice(s,1),t.removeBody(e),e.forceActivationState(5),this._simulationEnabled=false;}}applyForce(e,t,s,i,n,r){let a=this._body;a&&(a.activate(),e instanceof eu?d.setValue(e.x,e.y,e.z):d.setValue(e,t,s),t instanceof eu?c.setValue(t.x,t.y,t.z):void 0!==i?c.setValue(i,n,r):c.setValue(0,0,0),a.applyForce(d,c));}applyTorque(e,t,s){let i=this._body;i&&(i.activate(),e instanceof eu?d.setValue(e.x,e.y,e.z):d.setValue(e,t,s),i.applyTorque(d));}applyImpulse(e,t,s,i,n,r){let a=this._body;a&&(a.activate(),e instanceof eu?d.setValue(e.x,e.y,e.z):d.setValue(e,t,s),t instanceof eu?c.setValue(t.x,t.y,t.z):void 0!==i?c.setValue(i,n,r):c.setValue(0,0,0),a.applyImpulse(d,c));}applyTorqueImpulse(e,t,s){let i=this._body;i&&(i.activate(),e instanceof eu?d.setValue(e.x,e.y,e.z):d.setValue(e,t,s),i.applyTorqueImpulse(d));}isStatic(){return this._type===fy}isStaticOrKinematic(){return this._type===fy||this._type===fx}isKinematic(){return this._type===fx}_getEntityTransform(e){let t=this.entity,s=t.collision;if(s){let e=s.getShapePosition(),t=s.getShapeRotation();d.setValue(e.x,e.y,e.z),u.setValue(t.x,t.y,t.z,t.w);}else {let e=t.getPosition(),s=t.getRotation();d.setValue(e.x,e.y,e.z),u.setValue(s.x,s.y,s.z,s.w);}e.setOrigin(d),e.setRotation(u);}syncEntityToBody(){let e=this._body;if(e){if(this._getEntityTransform(h),e.setWorldTransform(h),this._type===fx){let t=e.getMotionState();t&&t.setWorldTransform(h);}e.activate();}}_updateDynamic(){let e=this._body;if(e.isActive()){let t=e.getMotionState();if(t){let e=this.entity;t.getWorldTransform(h);let s=h.getOrigin(),i=h.getRotation(),n=e.collision;if(n&&n._hasOffset){let t=n.data.linearOffset,r=n.data.angularOffset,a=m9.copy(r).invert(),o=m8.set(i.x(),i.y(),i.z(),i.w()).mul(a);o.transformVector(t,m7),e.setPosition(s.x()-m7.x,s.y()-m7.y,s.z()-m7.z),e.setRotation(o);}else e.setPosition(s.x(),s.y(),s.z()),e.setRotation(i.x(),i.y(),i.z(),i.w());}}}_updateKinematic(){let e=this._body.getMotionState();e&&(this._getEntityTransform(h),e.setWorldTransform(h));}teleport(e,t,s,i,n,r){e instanceof eu?this.entity.setPosition(e):this.entity.setPosition(e,t,s),t instanceof eT?this.entity.setRotation(t):t instanceof eu?this.entity.setEulerAngles(t):void 0!==i&&this.entity.setEulerAngles(i,n,r),this.syncEntityToBody();}onEnable(){this._body||this.createBody(),this.enableSimulation();}onDisable(){this.disableSimulation();}constructor(...e){super(...e),this._angularDamping=0,this._angularFactor=new eu(1,1,1),this._angularVelocity=new eu,this._body=null,this._friction=.5,this._group=2,this._linearDamping=0,this._linearFactor=new eu(1,1,1),this._linearVelocity=new eu,this._mask=65533,this._mass=1,this._restitution=0,this._rollingFriction=0,this._simulationEnabled=false,this._type=fy;}}_e.EVENT_CONTACT="contact",_e.EVENT_COLLISIONSTART="collisionstart",_e.EVENT_COLLISIONEND="collisionend",_e.EVENT_TRIGGERENTER="triggerenter",_e.EVENT_TRIGGERLEAVE="triggerleave",_e.order=-1;class _t{constructor(){this.enabled=true;}}class _s{constructor(e,t,s,i){this.entity=e,this.point=t,this.normal=s,this.hitFraction=i;}}class _i{constructor(e,t,s){0!=arguments.length?(this.a=e,this.b=t,this.impulse=s.impulse,this.localPointA=s.localPoint,this.localPointB=s.localPointOther,this.pointA=s.point,this.pointB=s.pointOther,this.normal=s.normal):(this.a=null,this.b=null,this.impulse=0,this.localPointA=new eu,this.localPointB=new eu,this.pointA=new eu,this.pointB=new eu,this.normal=new eu);}}class _n{constructor(e=new eu,t=new eu,s=new eu,i=new eu,n=new eu,r=0){this.localPoint=e,this.localPointOther=t,this.point=s,this.pointOther=i,this.normal=n,this.impulse=r;}}class _r{constructor(e,t){this.other=e,this.contacts=t;}}let _a=["enabled"];class _o extends u9{onLibraryLoaded(){if("undefined"!=typeof Ammo){if(this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration,this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration),this.overlappingPairCache=new Ammo.btDbvtBroadphase,this.solver=new Ammo.btSequentialImpulseConstraintSolver,this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration),this.dynamicsWorld.setInternalTickCallback){let e=Ammo.addFunction(this._checkForCollisions.bind(this),"vif");this.dynamicsWorld.setInternalTickCallback(e);}p=new Ammo.btVector3,f=new Ammo.btVector3,_e.onLibraryLoaded(),this.contactPointPool=new m6(_n,1),this.contactResultPool=new m6(_r,1),this.singleContactResultPool=new m6(_i,1),this.app.systems.on("update",this.onUpdate,this);}else this.app.systems.off("update",this.onUpdate,this);}initializeComponentData(e,t,s){for(let s of ["mass","linearDamping","angularDamping","linearFactor","angularFactor","friction","rollingFriction","restitution","type","group","mask"])if(t.hasOwnProperty(s)){let i=t[s];Array.isArray(i)?e[s]=new eu(i[0],i[1],i[2]):e[s]=i;}super.initializeComponentData(e,t,["enabled"]);}cloneComponent(e,t){let s=e.rigidbody,i={enabled:s.enabled,mass:s.mass,linearDamping:s.linearDamping,angularDamping:s.angularDamping,linearFactor:[s.linearFactor.x,s.linearFactor.y,s.linearFactor.z],angularFactor:[s.angularFactor.x,s.angularFactor.y,s.angularFactor.z],friction:s.friction,rollingFriction:s.rollingFriction,restitution:s.restitution,type:s.type,group:s.group,mask:s.mask};return this.addComponent(t,i)}onBeforeRemove(e,t){t.enabled&&(t.enabled=false),t.body&&(this.destroyBody(t.body),t.body=null);}addBody(e,t,s){ void 0!==t&&void 0!==s?this.dynamicsWorld.addRigidBody(e,t,s):this.dynamicsWorld.addRigidBody(e);}removeBody(e){this.dynamicsWorld.removeRigidBody(e);}createBody(e,t,s){let i=new Ammo.btVector3(0,0,0);0!==e&&t.calculateLocalInertia(e,i);let n=new Ammo.btDefaultMotionState(s),r=new Ammo.btRigidBodyConstructionInfo(e,n,t,i),a=new Ammo.btRigidBody(r);return Ammo.destroy(r),Ammo.destroy(i),a}destroyBody(e){let t=e.getMotionState();t&&Ammo.destroy(t),Ammo.destroy(e);}raycastFirst(e,t,s){if(void 0===s&&(s={}),s.filterTags||s.filterCallback)return s.sort=true,this.raycastAll(e,t,s)[0]||null;let i=null;p.setValue(e.x,e.y,e.z),f.setValue(t.x,t.y,t.z);let n=new Ammo.ClosestRayResultCallback(p,f);if("number"==typeof s.filterCollisionGroup&&n.set_m_collisionFilterGroup(s.filterCollisionGroup),"number"==typeof s.filterCollisionMask&&n.set_m_collisionFilterMask(s.filterCollisionMask),this.dynamicsWorld.rayTest(p,f,n),n.hasHit()){let e=n.get_m_collisionObject(),t=Ammo.castObject(e,Ammo.btRigidBody);if(t){let e=n.get_m_hitPointWorld(),s=n.get_m_hitNormalWorld();i=new _s(t.entity,new eu(e.x(),e.y(),e.z()),new eu(s.x(),s.y(),s.z()),n.get_m_closestHitFraction());}}return Ammo.destroy(n),i}raycastAll(e,t,s){ void 0===s&&(s={});let i=[];p.setValue(e.x,e.y,e.z),f.setValue(t.x,t.y,t.z);let n=new Ammo.AllHitsRayResultCallback(p,f);if("number"==typeof s.filterCollisionGroup&&n.set_m_collisionFilterGroup(s.filterCollisionGroup),"number"==typeof s.filterCollisionMask&&n.set_m_collisionFilterMask(s.filterCollisionMask),this.dynamicsWorld.rayTest(p,f,n),n.hasHit()){let e=n.get_m_collisionObjects(),t=n.get_m_hitPointWorld(),r=n.get_m_hitNormalWorld(),a=n.get_m_hitFractions(),o=e.size();for(let n=0;n<o;n++){let o=Ammo.castObject(e.at(n),Ammo.btRigidBody);if(o&&o.entity){if(s.filterTags&&!o.entity.tags.has(...s.filterTags)||s.filterCallback&&!s.filterCallback(o.entity))continue;let e=t.at(n),l=r.at(n),h=new _s(o.entity,new eu(e.x(),e.y(),e.z()),new eu(l.x(),l.y(),l.z()),a.at(n));i.push(h);}}s.sort&&i.sort((e,t)=>e.hitFraction-t.hitFraction);}return Ammo.destroy(n),i}_storeCollision(e,t){let s=false,i=e.getGuid();return this.collisions[i]=this.collisions[i]||{others:[],entity:e},0>this.collisions[i].others.indexOf(t)&&(this.collisions[i].others.push(t),s=true),this.frameCollisions[i]=this.frameCollisions[i]||{others:[],entity:e},this.frameCollisions[i].others.push(t),s}_createContactPointFromAmmo(e){let t=e.get_m_localPointA(),s=e.get_m_localPointB(),i=e.getPositionWorldOnA(),n=e.getPositionWorldOnB(),r=e.get_m_normalWorldOnB(),a=this.contactPointPool.allocate();return a.localPoint.set(t.x(),t.y(),t.z()),a.localPointOther.set(s.x(),s.y(),s.z()),a.point.set(i.x(),i.y(),i.z()),a.pointOther.set(n.x(),n.y(),n.z()),a.normal.set(r.x(),r.y(),r.z()),a.impulse=e.getAppliedImpulse(),a}_createReverseContactPointFromAmmo(e){let t=e.get_m_localPointA(),s=e.get_m_localPointB(),i=e.getPositionWorldOnA(),n=e.getPositionWorldOnB(),r=e.get_m_normalWorldOnB(),a=this.contactPointPool.allocate();return a.localPointOther.set(t.x(),t.y(),t.z()),a.localPoint.set(s.x(),s.y(),s.z()),a.pointOther.set(i.x(),i.y(),i.z()),a.point.set(n.x(),n.y(),n.z()),a.normal.set(r.x(),r.y(),r.z()),a.impulse=e.getAppliedImpulse(),a}_createSingleContactResult(e,t,s){let i=this.singleContactResultPool.allocate();return i.a=e,i.b=t,i.localPointA=s.localPoint,i.localPointB=s.localPointOther,i.pointA=s.point,i.pointB=s.pointOther,i.normal=s.normal,i.impulse=s.impulse,i}_createContactResult(e,t){let s=this.contactResultPool.allocate();return s.other=e,s.contacts=t,s}_cleanOldCollisions(){for(let e in this.collisions)if(this.collisions.hasOwnProperty(e)){let t=this.frameCollisions[e],s=this.collisions[e],i=s.entity,n=i.collision,r=i.rigidbody,a=s.others,o=a.length;for(;o--;){let e=a[o];(!t||0>t.others.indexOf(e))&&(a.splice(o,1),i.trigger?(n&&n.fire("triggerleave",e),e.rigidbody&&e.rigidbody.fire("triggerleave",i)):!e.trigger&&(r&&r.fire("collisionend",e),n&&n.fire("collisionend",e)));}0===a.length&&delete this.collisions[e];}}_hasContactEvent(e){let t=e.collision;if(t&&(t.hasEvent("collisionstart")||t.hasEvent("collisionend")||t.hasEvent("contact")))return  true;let s=e.rigidbody;return s&&(s.hasEvent("collisionstart")||s.hasEvent("collisionend")||s.hasEvent("contact"))}_checkForCollisions(e,t){let s=Ammo.wrapPointer(e,Ammo.btDynamicsWorld).getDispatcher(),i=s.getNumManifolds();this.frameCollisions={};for(let e=0;e<i;e++){let t;let i=s.getManifoldByIndexInternal(e),n=i.getBody0(),r=i.getBody1(),a=Ammo.castObject(n,Ammo.btRigidBody),o=Ammo.castObject(r,Ammo.btRigidBody),l=a.entity,h=o.entity;if(!l||!h)continue;let d=a.getCollisionFlags(),c=o.getCollisionFlags(),u=i.getNumContacts(),p=[],f=[];if(u>0){if(4&d||4&c){let e=l.collision&&(l.collision.hasEvent("triggerenter")||l.collision.hasEvent("triggerleave")),s=h.collision&&(h.collision.hasEvent("triggerenter")||h.collision.hasEvent("triggerleave")),i=l.rigidbody&&(l.rigidbody.hasEvent("triggerenter")||l.rigidbody.hasEvent("triggerleave")),n=h.rigidbody&&(h.rigidbody.hasEvent("triggerenter")||h.rigidbody.hasEvent("triggerleave"));e&&(t=this._storeCollision(l,h))&&!(4&c)&&l.collision.fire("triggerenter",h),s&&(t=this._storeCollision(h,l))&&!(4&d)&&h.collision.fire("triggerenter",l),i&&(t||(t=this._storeCollision(h,l)),t&&l.rigidbody.fire("triggerenter",h)),n&&(t||(t=this._storeCollision(l,h)),t&&h.rigidbody.fire("triggerenter",l));}else {let e=this._hasContactEvent(l),s=this._hasContactEvent(h),n=this.hasEvent("contact");if(n||e||s){for(let t=0;t<u;t++){let r=i.getContactPoint(t),a=this._createContactPointFromAmmo(r);if(e||s){p.push(a);let e=this._createReverseContactPointFromAmmo(r);f.push(e);}if(n){let e=this._createSingleContactResult(l,h,a);this.fire("contact",e);}}if(e){let e=this._createContactResult(h,p);t=this._storeCollision(l,h),l.collision&&(l.collision.fire("contact",e),t&&l.collision.fire("collisionstart",e)),l.rigidbody&&(l.rigidbody.fire("contact",e),t&&l.rigidbody.fire("collisionstart",e));}if(s){let e=this._createContactResult(l,f);t=this._storeCollision(h,l),h.collision&&(h.collision.fire("contact",e),t&&h.collision.fire("collisionstart",e)),h.rigidbody&&(h.rigidbody.fire("contact",e),t&&h.rigidbody.fire("collisionstart",e));}}}}}this._cleanOldCollisions(),this.contactPointPool.freeAll(),this.contactResultPool.freeAll(),this.singleContactResultPool.freeAll();}onUpdate(e){let t,s;this._gravityFloat32[0]=this.gravity.x,this._gravityFloat32[1]=this.gravity.y,this._gravityFloat32[2]=this.gravity.z;let i=this.dynamicsWorld.getGravity();(i.x()!==this._gravityFloat32[0]||i.y()!==this._gravityFloat32[1]||i.z()!==this._gravityFloat32[2])&&(i.setValue(this.gravity.x,this.gravity.y,this.gravity.z),this.dynamicsWorld.setGravity(i));let n=this._triggers;for(t=0,s=n.length;t<s;t++)n[t].updateTransform();let r=this._compounds;for(t=0,s=r.length;t<s;t++)r[t]._updateCompound();let a=this._kinematic;for(t=0,s=a.length;t<s;t++)a[t]._updateKinematic();this.dynamicsWorld.stepSimulation(e,this.maxSubSteps,this.fixedTimeStep);let o=this._dynamic;for(t=0,s=o.length;t<s;t++)o[t]._updateDynamic();this.dynamicsWorld.setInternalTickCallback||this._checkForCollisions(Ammo.getPointer(this.dynamicsWorld),e);}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this),"undefined"!=typeof Ammo&&(Ammo.destroy(this.dynamicsWorld),Ammo.destroy(this.solver),Ammo.destroy(this.overlappingPairCache),Ammo.destroy(this.dispatcher),Ammo.destroy(this.collisionConfiguration),Ammo.destroy(p),Ammo.destroy(f),this.dynamicsWorld=null,this.solver=null,this.overlappingPairCache=null,this.dispatcher=null,this.collisionConfiguration=null,p=null,f=null,_e.onAppDestroy());}constructor(e){super(e),this.maxSubSteps=10,this.fixedTimeStep=1/60,this.gravity=new eu(0,-9.81,0),this._gravityFloat32=new Float32Array(3),this._dynamic=[],this._kinematic=[],this._triggers=[],this._compounds=[],this.id="rigidbody",this._stats=e.stats.frame,this.ComponentType=_e,this.DataType=_t,this.contactPointPool=null,this.contactResultPool=null,this.singleContactResultPool=null,this.schema=_a,this.collisions={},this.frameCollisions={},this.on("beforeremove",this.onBeforeRemove,this);}}_o.EVENT_CONTACT="contact",u8._buildAccessors(_e.prototype,_a);let _l="none",_h="blend",_d=new ex;class _c extends u8{syncDrawOrder(){this.system.queueDrawOrderSync(this.entity.getGuid(),this._processDrawOrderSync,this);}_recurseDrawOrderSync(e,t){if(!(e instanceof uG))return t;if(e.element){let i=e.element.drawOrder;if(e.element.drawOrder=t++,e.element._batchGroupId>=0&&i!==e.element.drawOrder){var s;null==(s=this.system.app.batcher)||s.markGroupDirty(e.element._batchGroupId);}}e.particlesystem&&(e.particlesystem.drawOrder=t++);let i=e.children;for(let e=0;e<i.length;e++)t=this._recurseDrawOrderSync(i[e],t);return t}_processDrawOrderSync(){this._recurseDrawOrderSync(this.entity,1),this.fire("syncdraworder");}_calcProjectionMatrix(){let e=this._resolution.x/this.scale,t=this._resolution.y/this.scale;this._screenMatrix.setOrtho(0,e,-t,0,1,-1),this._screenSpace||(_d.setScale(.5*e,.5*t,1),this._screenMatrix.mul2(_d,this._screenMatrix));}_updateScale(){this.scale=this._calcScale(this._resolution,this.referenceResolution);}_calcScale(e,t){let s=Math.log2((e.x||1)/t.x),i=Math.log2((e.y||1)/t.y);return Math.pow(2,s*(1-this._scaleBlend)+i*this._scaleBlend)}_onResize(e,t){this._screenSpace&&(this._resolution.set(e,t),this.resolution=this._resolution);}_bindElement(e){this._elements.add(e);}_unbindElement(e){this._elements.delete(e);}onRemove(){this.system.app.graphicsDevice.off("resizecanvas",this._onResize,this),this.fire("remove"),this._elements.forEach(e=>e._onScreenRemove()),this._elements.clear(),this.off();}set resolution(e){this._screenSpace?this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height):this._resolution.set(e.x,e.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:resolution",this._resolution),this._elements.forEach(e=>e._onScreenResize(this._resolution));}get resolution(){return this._resolution}set referenceResolution(e){this._referenceResolution.set(e.x,e.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:referenceresolution",this._resolution),this._elements.forEach(e=>e._onScreenResize(this._resolution));}get referenceResolution(){return this._scaleMode===_l?this._resolution:this._referenceResolution}set screenSpace(e){this._screenSpace=e,this._screenSpace&&this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height),this.resolution=this._resolution,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:screenspace",this._screenSpace),this._elements.forEach(e=>e._onScreenSpaceChange());}get screenSpace(){return this._screenSpace}set scaleMode(e){e!==_l&&e!==_h&&(e=_l),this._screenSpace||e===_l||(e=_l),this._scaleMode=e,this.resolution=this._resolution,this.fire("set:scalemode",this._scaleMode);}get scaleMode(){return this._scaleMode}set scaleBlend(e){this._scaleBlend=e,this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:scaleblend",this._scaleBlend),this._elements.forEach(e=>e._onScreenResize(this._resolution));}get scaleBlend(){return this._scaleBlend}set priority(e){e>255&&(e=255),this._priority!==e&&(this._priority=e,this.syncDrawOrder());}get priority(){return this._priority}constructor(e,t){super(e,t),this._resolution=new ef(640,320),this._referenceResolution=new ef(640,320),this._scaleMode=_l,this.scale=1,this._scaleBlend=.5,this._priority=0,this._screenSpace=false,this.cull=this._screenSpace,this._screenMatrix=new ex,this._elements=new Set,e.app.graphicsDevice.on("resizecanvas",this._onResize,this);}}class _u{constructor(){this.enabled=true;}}let _p=["enabled"];class _f extends u9{initializeComponentData(e,t,s){ void 0!==t.priority&&(e.priority=t.priority),void 0!==t.screenSpace&&(e.screenSpace=t.screenSpace),e.cull=e.screenSpace,void 0!==t.scaleMode&&(e.scaleMode=t.scaleMode),void 0!==t.scaleBlend&&(e.scaleBlend=t.scaleBlend),void 0!==t.resolution&&(t.resolution instanceof ef?e._resolution.copy(t.resolution):e._resolution.set(t.resolution[0],t.resolution[1]),e.resolution=e._resolution),void 0!==t.referenceResolution&&(t.referenceResolution instanceof ef?e._referenceResolution.copy(t.referenceResolution):e._referenceResolution.set(t.referenceResolution[0],t.referenceResolution[1]),e.referenceResolution=e._referenceResolution),e.syncDrawOrder(),super.initializeComponentData(e,t,_p);}destroy(){super.destroy(),this.app.graphicsDevice.off("resizecanvas",this._onResize,this),this.app.systems.off("update",this._onUpdate,this);}_onUpdate(e){let t=this.store;for(let s in t)t[s].entity.screen.update&&t[s].entity.screen.update(e);}_onResize(e,t){this.windowResolution.x=e,this.windowResolution.y=t;}cloneComponent(e,t){let s=e.screen;return this.addComponent(t,{enabled:s.enabled,screenSpace:s.screenSpace,scaleMode:s.scaleMode,resolution:s.resolution.clone(),referenceResolution:s.referenceResolution.clone()})}onRemoveComponent(e,t){t.onRemove();}processDrawOrderSyncQueue(){let e=this._drawOrderSyncQueue.list();for(let t=0;t<e.length;t++){let s=e[t];s.callback.call(s.scope);}this._drawOrderSyncQueue.clear();}queueDrawOrderSync(e,t,s){this._drawOrderSyncQueue.list().length||this.app.once("prerender",this.processDrawOrderSyncQueue,this),this._drawOrderSyncQueue.has(e)||this._drawOrderSyncQueue.push(e,{callback:t,scope:s});}constructor(e){super(e),this.id="screen",this.ComponentType=_c,this.DataType=_u,this.schema=_p,this.windowResolution=new ef,this._drawOrderSyncQueue=new j,this.app.graphicsDevice.on("resizecanvas",this._onResize,this),this.app.systems.on("update",this._onUpdate,this),this.on("beforeremove",this.onRemoveComponent,this);}}u8._buildAccessors(_c.prototype,_p);let _m=new ef,__=new eu,_g=new eO,_v=new eL,_y=new eu,_S=new eu,_x=new eT,_T={x:"y",y:"x"};class _b extends Y{_toggleLifecycleListeners(e){this._element[e]("mousedown",this._onMouseDownOrTouchStart,this),this._element[e]("touchstart",this._onMouseDownOrTouchStart,this),this._element[e]("selectstart",this._onMouseDownOrTouchStart,this);}_toggleDragListeners(e){let t="on"===e;(!this._hasDragListeners||!t)&&(this._app.mouse&&(this._element[e]("mousemove",this._onMove,this),this._element[e]("mouseup",this._onMouseUpOrTouchEnd,this)),k.touch&&(this._element[e]("touchmove",this._onMove,this),this._element[e]("touchend",this._onMouseUpOrTouchEnd,this),this._element[e]("touchcancel",this._onMouseUpOrTouchEnd,this)),this._element[e]("selectmove",this._onMove,this),this._element[e]("selectend",this._onMouseUpOrTouchEnd,this),this._hasDragListeners=t);}_onMouseDownOrTouchStart(e){if(this._element&&!this._isDragging&&this.enabled){this._dragCamera=e.camera,this._calculateDragScale();let t=this._screenToLocal(e);t&&(this._toggleDragListeners("on"),this._isDragging=true,this._dragStartMousePosition.copy(t),this._dragStartHandlePosition.copy(this._element.entity.getLocalPosition()),this.fire("drag:start"));}}_onMouseUpOrTouchEnd(){this._isDragging&&(this._isDragging=false,this._toggleDragListeners("off"),this.fire("drag:end"));}_screenToLocal(e){return (e.inputSource?_g.set(e.inputSource.getOrigin(),e.inputSource.getDirection()):(this._determineInputPosition(e),this._chooseRayOriginAndDirection()),_y.copy(this._element.entity.forward).mulScalar(-1),_v.setFromPointNormal(this._element.entity.getPosition(),_y),_v.intersectsRay(_g,_S))?(_x.copy(this._element.entity.getRotation()).invert().transformVector(_S,_S),_S.mul(this._dragScale),_S):null}_determineInputPosition(e){let t=this._app.graphicsDevice.maxPixelRatio;void 0!==e.x&&void 0!==e.y?(_m.x=e.x*t,_m.y=e.y*t):e.changedTouches&&(_m.x=e.changedTouches[0].x*t,_m.y=e.changedTouches[0].y*t);}_chooseRayOriginAndDirection(){this._element.screen&&this._element.screen.screen.screenSpace?(_g.origin.set(_m.x,-_m.y,0),_g.direction.copy(eu.FORWARD)):(__.copy(this._dragCamera.screenToWorld(_m.x,_m.y,1)),_g.origin.copy(this._dragCamera.entity.getPosition()),_g.direction.copy(__).sub(_g.origin).normalize());}_calculateDragScale(){let e=this._element.entity.parent,t=this._element.screen&&this._element.screen.screen,s=t&&t.screenSpace,i=s?t.scale:1,n=this._dragScale;for(n.set(i,i,i);e&&(n.mul(e.getLocalScale()),e=e.parent,!s||!e.screen););n.x=1/n.x,n.y=1/n.y,n.z=0;}_onMove(e){let{_element:t,_deltaMousePosition:s,_deltaHandlePosition:i,_axis:n}=this;if(t&&this._isDragging&&this.enabled&&t.enabled&&t.entity.enabled){let r=this._screenToLocal(e);if(r){if(s.sub2(r,this._dragStartMousePosition),i.add2(this._dragStartHandlePosition,s),n){let e=t.entity.getLocalPosition(),s=_T[n];i[s]=e[s];}t.entity.setLocalPosition(i),this.fire("drag:move",i);}}}destroy(){this._toggleLifecycleListeners("off"),this._toggleDragListeners("off");}set enabled(e){this._enabled=e;}get enabled(){return this._enabled}get isDragging(){return this._isDragging}constructor(e,t){if(super(),!e||!(e instanceof ma))throw Error("Element was null or not an ElementComponent");if(t&&"x"!==t&&"y"!==t)throw Error("Unrecognized axis: "+t);this._element=e,this._app=e.system.app,this._axis=t||null,this._enabled=true,this._dragScale=new eu,this._dragStartMousePosition=new eu,this._dragStartHandlePosition=new eu,this._deltaMousePosition=new eu,this._deltaHandlePosition=new eu,this._isDragging=false,this._toggleLifecycleListeners("on");}}_b.EVENT_DRAGSTART="drag:start",_b.EVENT_DRAGEND="drag:end",_b.EVENT_DRAGMOVE="drag:move";let _E=new ef;class _A extends u8{get data(){let e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){this._setValue("enabled",e);}get enabled(){return this.data.enabled}set horizontal(e){this._setValue("horizontal",e);}get horizontal(){return this.data.horizontal}set vertical(e){this._setValue("vertical",e);}get vertical(){return this.data.vertical}set scrollMode(e){this._setValue("scrollMode",e);}get scrollMode(){return this.data.scrollMode}set bounceAmount(e){this._setValue("bounceAmount",e);}get bounceAmount(){return this.data.bounceAmount}set friction(e){this._setValue("friction",e);}get friction(){return this.data.friction}set dragThreshold(e){this._setValue("dragThreshold",e);}get dragThreshold(){return this.data.dragThreshold}set useMouseWheel(e){this._setValue("useMouseWheel",e);}get useMouseWheel(){return this.data.useMouseWheel}set mouseWheelSensitivity(e){this._setValue("mouseWheelSensitivity",e);}get mouseWheelSensitivity(){return this.data.mouseWheelSensitivity}set horizontalScrollbarVisibility(e){this._setValue("horizontalScrollbarVisibility",e);}get horizontalScrollbarVisibility(){return this.data.horizontalScrollbarVisibility}set verticalScrollbarVisibility(e){this._setValue("verticalScrollbarVisibility",e);}get verticalScrollbarVisibility(){return this.data.verticalScrollbarVisibility}set viewportEntity(e){if(this._viewportEntity===e)return;let t="string"==typeof e;(!this._viewportEntity||!t||this._viewportEntity.getGuid()!==e)&&(this._viewportEntity&&this._viewportEntityUnsubscribe(),e instanceof oE?this._viewportEntity=e:t?this._viewportEntity=this.system.app.getEntityFromIndex(e)||null:this._viewportEntity=null,this._viewportEntity&&this._viewportEntitySubscribe(),this._viewportEntity?this.data.viewportEntity=this._viewportEntity.getGuid():t&&e&&(this.data.viewportEntity=e));}get viewportEntity(){return this._viewportEntity}set contentEntity(e){if(this._contentEntity===e)return;let t="string"==typeof e;(!this._contentEntity||!t||this._contentEntity.getGuid()!==e)&&(this._contentEntity&&this._contentEntityUnsubscribe(),e instanceof oE?this._contentEntity=e:t?this._contentEntity=this.system.app.getEntityFromIndex(e)||null:this._contentEntity=null,this._contentEntity&&this._contentEntitySubscribe(),this._contentEntity?this.data.contentEntity=this._contentEntity.getGuid():t&&e&&(this.data.contentEntity=e));}get contentEntity(){return this._contentEntity}set horizontalScrollbarEntity(e){if(this._horizontalScrollbarEntity===e)return;let t="string"==typeof e;(!this._horizontalScrollbarEntity||!t||this._horizontalScrollbarEntity.getGuid()!==e)&&(this._horizontalScrollbarEntity&&this._horizontalScrollbarEntityUnsubscribe(),e instanceof oE?this._horizontalScrollbarEntity=e:t?this._horizontalScrollbarEntity=this.system.app.getEntityFromIndex(e)||null:this._horizontalScrollbarEntity=null,this._scrollbarEntities[0]=this._horizontalScrollbarEntity,this._horizontalScrollbarEntity&&this._horizontalScrollbarEntitySubscribe(),this._horizontalScrollbarEntity?this.data.horizontalScrollbarEntity=this._horizontalScrollbarEntity.getGuid():t&&e&&(this.data.horizontalScrollbarEntity=e));}get horizontalScrollbarEntity(){return this._horizontalScrollbarEntity}set verticalScrollbarEntity(e){if(this._verticalScrollbarEntity===e)return;let t="string"==typeof e;(!this._verticalScrollbarEntity||!t||this._verticalScrollbarEntity.getGuid()!==e)&&(this._verticalScrollbarEntity&&this._verticalScrollbarEntityUnsubscribe(),e instanceof oE?this._verticalScrollbarEntity=e:t?this._verticalScrollbarEntity=this.system.app.getEntityFromIndex(e)||null:this._verticalScrollbarEntity=null,this._scrollbarEntities[1]=this._verticalScrollbarEntity,this._verticalScrollbarEntity&&this._verticalScrollbarEntitySubscribe(),this._verticalScrollbarEntity?this.data.verticalScrollbarEntity=this._verticalScrollbarEntity.getGuid():t&&e&&(this.data.verticalScrollbarEntity=e));}get verticalScrollbarEntity(){return this._verticalScrollbarEntity}set scroll(e){this._onSetScroll(e.x,e.y);}get scroll(){return this._scroll}_setValue(e,t){let s=this.data,i=s[e];s[e]=t,this.fire("set",e,i,t);}_toggleLifecycleListeners(e){this[e]("set_horizontal",this._onSetHorizontalScrollingEnabled,this),this[e]("set_vertical",this._onSetVerticalScrollingEnabled,this),this.entity[e]("element:add",this._onElementComponentAdd,this);}_toggleElementListeners(e){this.entity.element&&("on"!==e||!this._hasElementListeners)&&(this.entity.element[e]("resize",this._syncAll,this),this.entity.element[e]("mousewheel",this._onMouseWheel,this),this._hasElementListeners="on"===e);}_onElementComponentAdd(e){this._evtElementRemove=this.entity.element.once("beforeremove",this._onElementComponentRemove,this),this._toggleElementListeners("on");}_onElementComponentRemove(e){var t;null==(t=this._evtElementRemove)||t.off(),this._evtElementRemove=null,this._toggleElementListeners("off");}_viewportEntitySubscribe(){this._evtViewportEntityElementAdd=this._viewportEntity.on("element:add",this._onViewportElementGain,this),this._viewportEntity.element&&this._onViewportElementGain();}_viewportEntityUnsubscribe(){var e,t;null==(e=this._evtViewportEntityElementAdd)||e.off(),this._evtViewportEntityElementAdd=null,(null==(t=this._viewportEntity)?void 0:t.element)&&this._onViewportElementLose();}_viewportEntityElementSubscribe(){let e=this._viewportEntity.element;this._evtViewportElementRemove=e.once("beforeremove",this._onViewportElementLose,this),this._evtViewportResize=e.on("resize",this._syncAll,this);}_viewportEntityElementUnsubscribe(){var e,t;null==(e=this._evtViewportElementRemove)||e.off(),this._evtViewportElementRemove=null,null==(t=this._evtViewportResize)||t.off(),this._evtViewportResize=null;}_onViewportElementGain(){this._viewportEntityElementSubscribe(),this._syncAll();}_onViewportElementLose(){this._viewportEntityElementUnsubscribe();}_contentEntitySubscribe(){this._evtContentEntityElementAdd=this._contentEntity.on("element:add",this._onContentElementGain,this),this._contentEntity.element&&this._onContentElementGain();}_contentEntityUnsubscribe(){var e,t;null==(e=this._evtContentEntityElementAdd)||e.off(),this._evtContentEntityElementAdd=null,(null==(t=this._contentEntity)?void 0:t.element)&&this._onContentElementLose();}_contentEntityElementSubscribe(){let e=this._contentEntity.element;this._evtContentElementRemove=e.once("beforeremove",this._onContentElementLose,this),this._evtContentResize=e.on("resize",this._syncAll,this);}_contentEntityElementUnsubscribe(){var e,t;null==(e=this._evtContentElementRemove)||e.off(),this._evtContentElementRemove=null,null==(t=this._evtContentResize)||t.off(),this._evtContentResize=null;}_onContentElementGain(){this._contentEntityElementSubscribe(),this._destroyDragHelper(),this._contentDragHelper=new _b(this._contentEntity.element),this._contentDragHelper.on("drag:start",this._onContentDragStart,this),this._contentDragHelper.on("drag:end",this._onContentDragEnd,this),this._contentDragHelper.on("drag:move",this._onContentDragMove,this),this._prevContentSizes[0]=null,this._prevContentSizes[1]=null,this._syncAll();}_onContentElementLose(){this._contentEntityElementUnsubscribe(),this._destroyDragHelper();}_onContentDragStart(){this._contentEntity&&this.enabled&&this.entity.enabled&&this._dragStartPosition.copy(this._contentEntity.getLocalPosition());}_onContentDragEnd(){this._prevContentDragPosition=null,this._enableContentInput();}_onContentDragMove(e){if(this._contentEntity&&this.enabled&&this.entity.enabled&&(this._wasDragged=true,this._setScrollFromContentPosition(e),this._setVelocityFromContentPositionDelta(e),!this._disabledContentInput)){let t=e.x-this._dragStartPosition.x,s=e.y-this._dragStartPosition.y;(Math.abs(t)>this.dragThreshold||Math.abs(s)>this.dragThreshold)&&this._disableContentInput();}}_horizontalScrollbarEntitySubscribe(){this._evtHorizontalScrollbarAdd=this._horizontalScrollbarEntity.on("scrollbar:add",this._onHorizontalScrollbarGain,this),this._horizontalScrollbarEntity.scrollbar&&this._onHorizontalScrollbarGain();}_verticalScrollbarEntitySubscribe(){this._evtVerticalScrollbarAdd=this._verticalScrollbarEntity.on("scrollbar:add",this._onVerticalScrollbarGain,this),this._verticalScrollbarEntity.scrollbar&&this._onVerticalScrollbarGain();}_horizontalScrollbarEntityUnsubscribe(){var e;null==(e=this._evtHorizontalScrollbarAdd)||e.off(),this._evtHorizontalScrollbarAdd=null,this._horizontalScrollbarEntity.scrollbar&&this._onHorizontalScrollbarLose();}_verticalScrollbarEntityUnsubscribe(){var e;null==(e=this._evtVerticalScrollbarAdd)||e.off(),this._evtVerticalScrollbarAdd=null,this._verticalScrollbarEntity.scrollbar&&this._onVerticalScrollbarLose();}_onSetHorizontalScrollbarValue(e){!this._scrollbarUpdateFlags[0]&&this.enabled&&this.entity.enabled&&this._onSetScroll(e,null);}_onSetVerticalScrollbarValue(e){!this._scrollbarUpdateFlags[1]&&this.enabled&&this.entity.enabled&&this._onSetScroll(null,e);}_onHorizontalScrollbarGain(){var e;let t=null==(e=this._horizontalScrollbarEntity)?void 0:e.scrollbar;this._evtHorizontalScrollbarRemove=t.on("beforeremove",this._onHorizontalScrollbarLose,this),this._evtHorizontalScrollbarValue=t.on("set:value",this._onSetHorizontalScrollbarValue,this),this._syncScrollbarEnabledState(0),this._syncScrollbarPosition(0);}_onVerticalScrollbarGain(){var e;let t=null==(e=this._verticalScrollbarEntity)?void 0:e.scrollbar;this._evtVerticalScrollbarRemove=t.on("beforeremove",this._onVerticalScrollbarLose,this),this._evtVerticalScrollbarValue=t.on("set:value",this._onSetVerticalScrollbarValue,this),this._syncScrollbarEnabledState(1),this._syncScrollbarPosition(1);}_onHorizontalScrollbarLose(){var e,t;null==(e=this._evtHorizontalScrollbarRemove)||e.off(),this._evtHorizontalScrollbarRemove=null,null==(t=this._evtHorizontalScrollbarValue)||t.off(),this._evtHorizontalScrollbarValue=null;}_onVerticalScrollbarLose(){var e,t;null==(e=this._evtVerticalScrollbarRemove)||e.off(),this._evtVerticalScrollbarRemove=null,null==(t=this._evtVerticalScrollbarValue)||t.off(),this._evtVerticalScrollbarValue=null;}_onSetHorizontalScrollingEnabled(){this._syncScrollbarEnabledState(0);}_onSetVerticalScrollingEnabled(){this._syncScrollbarEnabledState(1);}_onSetScroll(e,t,s){ false!==s&&this._velocity.set(0,0,0);let i=this._updateAxis(e,"x",0),n=this._updateAxis(t,"y",1);(i||n)&&this.fire("set:scroll",this._scroll);}_updateAxis(e,t,s){let i=null!==e&&Math.abs(e-this._scroll[t])>1e-5;return (i||this._isDragging()||0===e)&&(this._scroll[t]=this._determineNewScrollValue(e,t,s),this._syncContentPosition(s),this._syncScrollbarPosition(s)),i}_determineNewScrollValue(e,t,s){if(!this._getScrollingEnabled(s))return this._scroll[t];switch(this.scrollMode){case 0:return ei.clamp(e,0,this._getMaxScrollValue(s));case 1:return this._setVelocityFromOvershoot(e,t,s),e;default:return e}}_syncAll(){this._syncContentPosition(0),this._syncContentPosition(1),this._syncScrollbarPosition(0),this._syncScrollbarPosition(1),this._syncScrollbarEnabledState(0),this._syncScrollbarEnabledState(1);}_syncContentPosition(e){if(!this._contentEntity)return;let t=this._getAxis(e),s=this._getSign(e),i=this._prevContentSizes[e],n=this._getContentSize(e);if(null!==i&&Math.abs(i-n)>1e-4){let s=this._getMaxOffset(e,i),r=this._getMaxOffset(e,n);0===r?this._scroll[t]=1:this._scroll[t]=ei.clamp(this._scroll[t]*s/r,0,1);}let r=this._scroll[t]*this._getMaxOffset(e),a=this._contentEntity.getLocalPosition();a[t]=r*s,this._contentEntity.setLocalPosition(a),this._prevContentSizes[e]=n;}_syncScrollbarPosition(e){let t=this._scrollbarEntities[e];if(!(null==t?void 0:t.scrollbar))return;let s=this._getAxis(e);this._scrollbarUpdateFlags[e]=true,t.scrollbar.value=this._scroll[s],t.scrollbar.handleSize=this._getScrollbarHandleSize(s,e),this._scrollbarUpdateFlags[e]=false;}_syncScrollbarEnabledState(e){let t=this._scrollbarEntities[e];if(!t)return;let s=this._getScrollingEnabled(e);switch(this._getScrollbarVisibility(e)){case 0:t.enabled=s;return;case 1:t.enabled=s&&this._contentIsLargerThanViewport(e);return;default:t.enabled=s;}}_contentIsLargerThanViewport(e){return this._getContentSize(e)>this._getViewportSize(e)}_contentPositionToScrollValue(e){let t=this._getMaxOffset(0),s=this._getMaxOffset(1);return 0===t?_E.x=0:_E.x=e.x/t,0===s?_E.y=0:_E.y=-(e.y/s),_E}_getMaxOffset(e,t){t=void 0===t?this._getContentSize(e):t;let s=this._getViewportSize(e);return t<s?-this._getViewportSize(e):s-t}_getMaxScrollValue(e){return +!!this._contentIsLargerThanViewport(e)}_getScrollbarHandleSize(e,t){let s=this._getViewportSize(t),i=this._getContentSize(t);if(.001>Math.abs(i))return 1;let n=Math.min(s/i,1),r=this._toOvershoot(this._scroll[e],t);return 0===r?n:n/(1+Math.abs(r))}_getViewportSize(e){return this._getSize(e,this._viewportEntity)}_getContentSize(e){return this._getSize(e,this._contentEntity)}_getSize(e,t){return (null==t?void 0:t.element)?t.element[this._getCalculatedDimension(e)]:0}_getScrollingEnabled(e){return 0===e?this.horizontal:1===e?this.vertical:void 0}_getScrollbarVisibility(e){return 0===e?this.horizontalScrollbarVisibility:1===e?this.verticalScrollbarVisibility:void 0}_getSign(e){return 0===e?1:-1}_getAxis(e){return 0===e?"x":"y"}_getCalculatedDimension(e){return 0===e?"calculatedWidth":"calculatedHeight"}_destroyDragHelper(){this._contentDragHelper&&this._contentDragHelper.destroy();}onUpdate(){this._contentEntity&&(this._updateVelocity(),this._syncScrollbarEnabledState(0),this._syncScrollbarEnabledState(1));}_updateVelocity(){if(!this._isDragging()){if(1===this.scrollMode&&(this._hasOvershoot("x",0)&&this._setVelocityFromOvershoot(this.scroll.x,"x",0),this._hasOvershoot("y",1)&&this._setVelocityFromOvershoot(this.scroll.y,"y",1)),Math.abs(this._velocity.x)>1e-4||Math.abs(this._velocity.y)>1e-4){let e=this._contentEntity.getLocalPosition();e.x+=this._velocity.x,e.y+=this._velocity.y,this._contentEntity.setLocalPosition(e),this._setScrollFromContentPosition(e);}this._velocity.x*=1-this.friction,this._velocity.y*=1-this.friction;}}_hasOvershoot(e,t){return Math.abs(this._toOvershoot(this.scroll[e],t))>.001}_toOvershoot(e,t){let s=this._getMaxScrollValue(t);return e<0?e:e>s?e-s:0}_setVelocityFromOvershoot(e,t,s){let i=this._toOvershoot(e,s)*this._getMaxOffset(s)*this._getSign(s);Math.abs(i)>0&&(this._velocity[t]=-i/(50*this.bounceAmount+1));}_setVelocityFromContentPositionDelta(e){this._prevContentDragPosition?(this._velocity.sub2(e,this._prevContentDragPosition),this._prevContentDragPosition.copy(e)):(this._velocity.set(0,0,0),this._prevContentDragPosition=e.clone());}_setScrollFromContentPosition(e){let t=this._contentPositionToScrollValue(e);this._isDragging()&&(t=this._applyScrollValueTension(t)),this._onSetScroll(t.x,t.y,false);}_applyScrollValueTension(e){let t=this._getMaxScrollValue(0),s=this._toOvershoot(e.x,0);return s>0?e.x=t+ +Math.log10(1+s):s<0&&(e.x=-1*Math.log10(1-s)),t=this._getMaxScrollValue(1),(s=this._toOvershoot(e.y,1))>0?e.y=t+ +Math.log10(1+s):s<0&&(e.y=-1*Math.log10(1-s)),e}_isDragging(){return this._contentDragHelper&&this._contentDragHelper.isDragging}_setScrollbarComponentsEnabled(e){var t,s;(null==(t=this._horizontalScrollbarEntity)?void 0:t.scrollbar)&&(this._horizontalScrollbarEntity.scrollbar.enabled=e),(null==(s=this._verticalScrollbarEntity)?void 0:s.scrollbar)&&(this._verticalScrollbarEntity.scrollbar.enabled=e);}_setContentDraggingEnabled(e){this._contentDragHelper&&(this._contentDragHelper.enabled=e);}_onMouseWheel(e){var t;if(!this.useMouseWheel||!(null==(t=this._contentEntity)?void 0:t.element))return;let s=e.event,i=s.deltaX/this._contentEntity.element.calculatedWidth*this.mouseWheelSensitivity.x,n=s.deltaY/this._contentEntity.element.calculatedHeight*this.mouseWheelSensitivity.y,r=ei.clamp(this._scroll.x+i,0,this._getMaxScrollValue(0)),a=ei.clamp(this._scroll.y+n,0,this._getMaxScrollValue(1));this.scroll=new ef(r,a);}_enableContentInput(){for(;this._disabledContentInputEntities.length;){let e=this._disabledContentInputEntities.pop();e.element&&(e.element.useInput=true);}this._disabledContentInput=false;}_disableContentInput(){let e=t=>{t.element&&t.element.useInput&&(this._disabledContentInputEntities.push(t),t.element.useInput=false);let s=t.children;for(let t=0,i=s.length;t<i;t++)e(s[t]);};if(this._contentEntity){let t=this._contentEntity.children;for(let s=0,i=t.length;s<i;s++)e(t[s]);}this._disabledContentInput=true;}onEnable(){this._setScrollbarComponentsEnabled(true),this._setContentDraggingEnabled(true),this._syncAll();}onDisable(){this._setScrollbarComponentsEnabled(false),this._setContentDraggingEnabled(false);}onRemove(){this._toggleLifecycleListeners("off"),this._toggleElementListeners("off"),this._destroyDragHelper();}resolveDuplicatedEntityReferenceProperties(e,t){e.viewportEntity&&(this.viewportEntity=t[e.viewportEntity.getGuid()]),e.contentEntity&&(this.contentEntity=t[e.contentEntity.getGuid()]),e.horizontalScrollbarEntity&&(this.horizontalScrollbarEntity=t[e.horizontalScrollbarEntity.getGuid()]),e.verticalScrollbarEntity&&(this.verticalScrollbarEntity=t[e.verticalScrollbarEntity.getGuid()]);}constructor(e,t){super(e,t),this._viewportEntity=null,this._contentEntity=null,this._horizontalScrollbarEntity=null,this._verticalScrollbarEntity=null,this._evtElementRemove=null,this._evtViewportElementRemove=null,this._evtViewportResize=null,this._evtContentEntityElementAdd=null,this._evtContentElementRemove=null,this._evtContentResize=null,this._evtHorizontalScrollbarAdd=null,this._evtHorizontalScrollbarRemove=null,this._evtHorizontalScrollbarValue=null,this._evtVerticalScrollbarAdd=null,this._evtVerticalScrollbarRemove=null,this._evtVerticalScrollbarValue=null,this._scrollbarUpdateFlags={},this._scrollbarEntities={},this._prevContentSizes={},this._prevContentSizes[0]=null,this._prevContentSizes[1]=null,this._scroll=new ef,this._velocity=new eu,this._dragStartPosition=new eu,this._disabledContentInput=false,this._disabledContentInputEntities=[],this._toggleLifecycleListeners("on"),this._toggleElementListeners("on");}}_A.EVENT_SETSCROLL="set:scroll";class _w{constructor(){this.enabled=true,this.dragThreshold=10,this.useMouseWheel=true,this.mouseWheelSensitivity=new ef(1,1),this.horizontalScrollbarVisibility=0,this.verticalScrollbarVisibility=0,this.viewportEntity=null,this.contentEntity=null,this.horizontalScrollbarEntity=null,this.verticalScrollbarEntity=null;}}let _C=[{name:"enabled",type:"boolean"},{name:"horizontal",type:"boolean"},{name:"vertical",type:"boolean"},{name:"scrollMode",type:"number"},{name:"bounceAmount",type:"number"},{name:"friction",type:"number"},{name:"dragThreshold",type:"number"},{name:"useMouseWheel",type:"boolean"},{name:"mouseWheelSensitivity",type:"vec2"},{name:"horizontalScrollbarVisibility",type:"number"},{name:"verticalScrollbarVisibility",type:"number"}];class _P extends u9{initializeComponentData(e,t,s){ void 0===t.dragThreshold&&(t.dragThreshold=10),void 0===t.useMouseWheel&&(t.useMouseWheel=true),void 0===t.mouseWheelSensitivity&&(t.mouseWheelSensitivity=new ef(1,1)),super.initializeComponentData(e,t,_C),e.viewportEntity=t.viewportEntity,e.contentEntity=t.contentEntity,e.horizontalScrollbarEntity=t.horizontalScrollbarEntity,e.verticalScrollbarEntity=t.verticalScrollbarEntity;}onUpdate(e){let t=this.store;for(let e in t){let s=t[e].entity,i=s.scrollview;i.enabled&&s.enabled&&i.onUpdate();}}_onRemoveComponent(e,t){t.onRemove();}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this);}constructor(e){super(e),this.id="scrollview",this.ComponentType=_A,this.DataType=_w,this.schema=_C,this.on("beforeremove",this._onRemoveComponent,this),this.app.systems.on("update",this.onUpdate,this);}}class _M extends u8{get data(){let e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){this._setValue("enabled",e);}get enabled(){return this.data.enabled}set orientation(e){this._setValue("orientation",e);}get orientation(){return this.data.orientation}set value(e){this._setValue("value",e);}get value(){return this.data.value}set handleSize(e){this._setValue("handleSize",e);}get handleSize(){return this.data.handleSize}set handleEntity(e){if(this._handleEntity===e)return;let t="string"==typeof e;(!this._handleEntity||!t||this._handleEntity.getGuid()!==e)&&(this._handleEntity&&this._handleEntityUnsubscribe(),e instanceof oE?this._handleEntity=e:t?this._handleEntity=this.system.app.getEntityFromIndex(e)||null:this._handleEntity=null,this._handleEntity&&this._handleEntitySubscribe(),this._handleEntity?this.data.handleEntity=this._handleEntity.getGuid():t&&e&&(this.data.handleEntity=e));}get handleEntity(){return this._handleEntity}_setValue(e,t){let s=this.data,i=s[e];s[e]=t,this.fire("set",e,i,t);}_toggleLifecycleListeners(e){this[e]("set_value",this._onSetValue,this),this[e]("set_handleSize",this._onSetHandleSize,this),this[e]("set_orientation",this._onSetOrientation,this);}_handleEntitySubscribe(){this._evtHandleEntityElementAdd=this._handleEntity.on("element:add",this._onHandleElementGain,this),this._handleEntity.element&&this._onHandleElementGain();}_handleEntityUnsubscribe(){var e,t;null==(e=this._evtHandleEntityElementAdd)||e.off(),this._evtHandleEntityElementAdd=null,(null==(t=this._handleEntity)?void 0:t.element)&&this._onHandleElementLose();}_handleEntityElementSubscribe(){let e=this._handleEntity.element,t=this._evtHandleEntityChanges;t.push(e.once("beforeremove",this._onHandleElementLose,this)),t.push(e.on("set:anchor",this._onSetHandleAlignment,this)),t.push(e.on("set:margin",this._onSetHandleAlignment,this)),t.push(e.on("set:pivot",this._onSetHandleAlignment,this));}_handleEntityElementUnsubscribe(){for(let e=0;e<this._evtHandleEntityChanges.length;e++)this._evtHandleEntityChanges[e].off();this._evtHandleEntityChanges.length=0;}_onHandleElementGain(){this._handleEntityElementSubscribe(),this._destroyDragHelper(),this._handleDragHelper=new _b(this._handleEntity.element,this._getAxis()),this._handleDragHelper.on("drag:move",this._onHandleDrag,this),this._updateHandlePositionAndSize();}_onHandleElementLose(){this._handleEntityElementUnsubscribe(),this._destroyDragHelper();}_onHandleDrag(e){this._handleEntity&&this.enabled&&this.entity.enabled&&(this.value=this._handlePositionToScrollValue(e[this._getAxis()]));}_onSetValue(e,t,s){Math.abs(s-t)>1e-5&&(this.data.value=ei.clamp(s,0,1),this._updateHandlePositionAndSize(),this.fire("set:value",this.data.value));}_onSetHandleSize(e,t,s){Math.abs(s-t)>1e-5&&(this.data.handleSize=ei.clamp(s,0,1),this._updateHandlePositionAndSize());}_onSetHandleAlignment(){this._updateHandlePositionAndSize();}_onSetOrientation(e,t,s){var i;s!==t&&(null==(i=this._handleEntity)?void 0:i.element)&&(this._handleEntity.element[this._getOppositeDimension()]=0);}_updateHandlePositionAndSize(){let e=this._handleEntity,t=null==e?void 0:e.element;if(e){let t=e.getLocalPosition();t[this._getAxis()]=this._getHandlePosition(),e.setLocalPosition(t);}t&&(t[this._getDimension()]=this._getHandleLength());}_handlePositionToScrollValue(e){return e*this._getSign()/this._getUsableTrackLength()}_scrollValueToHandlePosition(e){return e*this._getSign()*this._getUsableTrackLength()}_getUsableTrackLength(){return Math.max(this._getTrackLength()-this._getHandleLength(),.001)}_getTrackLength(){return this.entity.element?0===this.orientation?this.entity.element.calculatedWidth:this.entity.element.calculatedHeight:0}_getHandleLength(){return this._getTrackLength()*this.handleSize}_getHandlePosition(){return this._scrollValueToHandlePosition(this.value)}_getSign(){return 0===this.orientation?1:-1}_getAxis(){return 0===this.orientation?"x":"y"}_getDimension(){return 0===this.orientation?"width":"height"}_getOppositeDimension(){return 0===this.orientation?"height":"width"}_destroyDragHelper(){this._handleDragHelper&&this._handleDragHelper.destroy();}_setHandleDraggingEnabled(e){this._handleDragHelper&&(this._handleDragHelper.enabled=e);}onEnable(){this._setHandleDraggingEnabled(true);}onDisable(){this._setHandleDraggingEnabled(false);}onRemove(){this._destroyDragHelper(),this._toggleLifecycleListeners("off");}resolveDuplicatedEntityReferenceProperties(e,t){e.handleEntity&&(this.handleEntity=t[e.handleEntity.getGuid()]);}constructor(e,t){super(e,t),this._handleEntity=null,this._evtHandleEntityElementAdd=null,this._evtHandleEntityChanges=[],this._toggleLifecycleListeners("on");}}_M.EVENT_SETVALUE="set:value";class _I{constructor(){this.enabled=true,this.orientation=0,this.value=0,this.handleSize=0,this.handleEntity=null;}}let _R=[{name:"enabled",type:"boolean"},{name:"orientation",type:"number"},{name:"value",type:"number"},{name:"handleSize",type:"number"}];class _L extends u9{initializeComponentData(e,t,s){super.initializeComponentData(e,t,_R),e.handleEntity=t.handleEntity;}_onAddComponent(e){e.fire("scrollbar:add");}_onRemoveComponent(e,t){t.onRemove();}constructor(e){super(e),this.id="scrollbar",this.ComponentType=_M,this.DataType=_I,this.schema=_R,this.on("add",this._onAddComponent,this),this.on("beforeremove",this._onRemoveComponent,this);}}let _D={volume:0,pitch:0,loop:false,startTime:0,duration:0,position:new eu,maxDistance:0,refDistance:0,rollOffFactor:0,distanceModel:0,onPlay:null,onPause:null,onResume:null,onStop:null,onEnd:null};class _O extends Y{play(){if(this.overlap||this.stop(),!this.isLoaded&&!this._hasAsset())return;let e=this._createInstance();if(this.instances.push(e),this.isLoaded)e.play();else {let t=function(t){let s=e._playWhenLoaded;e.sound=t,s&&e.play();};this.off("load",t),this.once("load",t),this.load();}return e}pause(){let e=false,t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].pause()&&(e=true);return e}resume(){let e=false,t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].resume()&&(e=true);return e}stop(){let e=false,t=this.instances,s=t.length;for(;s--;)t[s].stop(),e=true;return t.length=0,e}load(){if(!this._hasAsset())return;let e=this._assets.get(this._asset);if(!e){this._assets.off("add:"+this._asset,this._onAssetAdd,this),this._assets.once("add:"+this._asset,this._onAssetAdd,this);return}if(e.off("remove",this._onAssetRemoved,this),e.on("remove",this._onAssetRemoved,this),!e.resource){e.off("load",this._onAssetLoad,this),e.once("load",this._onAssetLoad,this),this._assets.load(e);return}this.fire("load",e.resource);}setExternalNodes(e,t){if(e&&(t||(t=e),this._firstNode=e,this._lastNode=t,!this._overlap)){let s=this.instances;for(let i=0,n=s.length;i<n;i++)s[i].setExternalNodes(e,t);}}clearExternalNodes(){if(this._firstNode=null,this._lastNode=null,!this._overlap){let e=this.instances;for(let t=0,s=e.length;t<s;t++)e[t].clearExternalNodes();}}getExternalNodes(){return [this._firstNode,this._lastNode]}_hasAsset(){return null!=this._asset}_createInstance(){let e=null,t=this._component,s=null;if(this._hasAsset()){let e=this._assets.get(this._asset);e&&(s=e.resource);}return _D.volume=this._volume*t.volume,_D.pitch=this._pitch*t.pitch,_D.loop=this._loop,_D.startTime=this._startTime,_D.duration=this._duration,_D.onPlay=this._onInstancePlayHandler,_D.onPause=this._onInstancePauseHandler,_D.onResume=this._onInstanceResumeHandler,_D.onStop=this._onInstanceStopHandler,_D.onEnd=this._onInstanceEndHandler,t.positional?(_D.position.copy(t.entity.getPosition()),_D.maxDistance=t.maxDistance,_D.refDistance=t.refDistance,_D.rollOffFactor=t.rollOffFactor,_D.distanceModel=t.distanceModel,e=new rV(this._manager,s,_D)):e=new rz(this._manager,s,_D),this._firstNode&&e.setExternalNodes(this._firstNode,this._lastNode),e}_onInstancePlay(e){this.fire("play",e),this._component.fire("play",this,e);}_onInstancePause(e){this.fire("pause",e),this._component.fire("pause",this,e);}_onInstanceResume(e){this.fire("resume",e),this._component.fire("resume",this,e);}_onInstanceStop(e){let t=this.instances.indexOf(e);-1!==t&&this.instances.splice(t,1),this.fire("stop",e),this._component.fire("stop",this,e);}_onInstanceEnd(e){let t=this.instances.indexOf(e);-1!==t&&this.instances.splice(t,1),this.fire("end",e),this._component.fire("end",this,e);}_onAssetAdd(e){this.load();}_onAssetLoad(e){this.load();}_onAssetRemoved(e){e.off("remove",this._onAssetRemoved,this),this._assets.off("add:"+e.id,this._onAssetAdd,this),this.stop();}updatePosition(e){let t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].position=e;}set asset(e){let t=this._asset;if(t){this._assets.off("add:"+t,this._onAssetAdd,this);let e=this._assets.get(t);e&&e.off("remove",this._onAssetRemoved,this);}this._asset=e,this._asset instanceof ub&&(this._asset=this._asset.id),this._hasAsset()&&this._component.enabled&&this._component.entity.enabled&&this.load();}get asset(){return this._asset}set autoPlay(e){this._autoPlay=!!e;}get autoPlay(){return this._autoPlay}set duration(e){if(this._duration=Math.max(0,Number(e)||0)||null,!this._overlap){let e=this.instances;for(let t=0,s=e.length;t<s;t++)e[t].duration=this._duration;}}get duration(){let e=0;if(this._hasAsset()){let t=this._assets.get(this._asset);e=(null==t?void 0:t.resource)?t.resource.duration:0;}return null!=this._duration?this._duration%(e||1):e}get isLoaded(){if(this._hasAsset()){let e=this._assets.get(this._asset);if(e)return !!e.resource}return  false}get isPaused(){let e=this.instances,t=e.length;if(0===t)return  false;for(let s=0;s<t;s++)if(!e[s].isPaused)return  false;return  true}get isPlaying(){let e=this.instances;for(let t=0,s=e.length;t<s;t++)if(e[t].isPlaying)return  true;return  false}get isStopped(){let e=this.instances;for(let t=0,s=e.length;t<s;t++)if(!e[t].isStopped)return  false;return  true}set loop(e){this._loop=!!e;let t=this.instances;for(let e=0,s=t.length;e<s;e++)t[e].loop=this._loop;}get loop(){return this._loop}set overlap(e){this._overlap=!!e;}get overlap(){return this._overlap}set pitch(e){if(this._pitch=Math.max(Number(e)||0,.01),!this._overlap){let e=this.instances;for(let t=0,s=e.length;t<s;t++)e[t].pitch=this.pitch*this._component.pitch;}}get pitch(){return this._pitch}set startTime(e){if(this._startTime=Math.max(0,Number(e)||0),!this._overlap){let e=this.instances;for(let t=0,s=e.length;t<s;t++)e[t].startTime=this._startTime;}}get startTime(){return this._startTime}set volume(e){if(this._volume=ei.clamp(Number(e)||0,0,1),!this._overlap){let e=this.instances;for(let t=0,s=e.length;t<s;t++)e[t].volume=this._volume*this._component.volume;}}get volume(){return this._volume}constructor(e,t="Untitled",s={}){super(),this.instances=[],this._component=e,this._assets=e.system.app.assets,this._manager=e.system.manager,this.name=t,this._volume=void 0!==s.volume?ei.clamp(Number(s.volume)||0,0,1):1,this._pitch=void 0!==s.pitch?Math.max(.01,Number(s.pitch)||0):1,this._loop=!!(void 0!==s.loop&&s.loop),this._duration=s.duration>0?s.duration:null,this._startTime=Math.max(0,Number(s.startTime)||0),this._overlap=!!s.overlap,this._autoPlay=!!s.autoPlay,this._firstNode=null,this._lastNode=null,this._asset=s.asset,this._asset instanceof ub&&(this._asset=this._asset.id),this._onInstancePlayHandler=this._onInstancePlay.bind(this),this._onInstancePauseHandler=this._onInstancePause.bind(this),this._onInstanceResumeHandler=this._onInstanceResume.bind(this),this._onInstanceStopHandler=this._onInstanceStop.bind(this),this._onInstanceEndHandler=this._onInstanceEnd.bind(this);}}_O.EVENT_PLAY="play",_O.EVENT_PAUSE="pause",_O.EVENT_RESUME="resume",_O.EVENT_STOP="stop",_O.EVENT_LOAD="load";class _F extends u8{_updateSoundInstances(e,t,s){let i=this._slots;for(let n in i){let r=i[n];if(!r.overlap){let i=r.instances;for(let n=0,a=i.length;n<a;n++)i[n][e]=s?r[e]*t:t;}}}set distanceModel(e){this._distanceModel=e,this._updateSoundInstances("distanceModel",e,false);}get distanceModel(){return this._distanceModel}set maxDistance(e){this._maxDistance=e,this._updateSoundInstances("maxDistance",e,false);}get maxDistance(){return this._maxDistance}set refDistance(e){this._refDistance=e,this._updateSoundInstances("refDistance",e,false);}get refDistance(){return this._refDistance}set rollOffFactor(e){this._rollOffFactor=e,this._updateSoundInstances("rollOffFactor",e,false);}get rollOffFactor(){return this._rollOffFactor}set pitch(e){this._pitch=e,this._updateSoundInstances("pitch",e,true);}get pitch(){return this._pitch}set volume(e){this._volume=e,this._updateSoundInstances("volume",e,true);}get volume(){return this._volume}set positional(e){this._positional=e;let t=this._slots;for(let e in t){let s=t[e];if(!s.overlap){let e=s.instances,t=e.length;for(let i=t-1;i>=0;i--){let t=e[i].isPlaying||e[i].isSuspended,n=e[i].currentTime;t&&e[i].stop();let r=s._createInstance();t&&(r.play(),r.currentTime=n),e.push(r);}}}}get positional(){return this._positional}set slots(e){let t=this._slots;if(t)for(let e in t)t[e].stop();let s={};for(let t in e)e[t]instanceof _O?s[e[t].name]=e[t]:e[t].name&&(s[e[t].name]=new _O(this,e[t].name,e[t]));this._slots=s,this.enabled&&this.entity.enabled&&this.onEnable();}get slots(){return this._slots}onEnable(){if(this.system._inTools)return;let e=this._slots,t=this._playingBeforeDisable;for(let s in e){let i=e[s];i.autoPlay&&i.isStopped?i.play():t[s]?i.resume():i.isLoaded||i.load();}}onDisable(){let e=this._slots,t={};for(let s in e)!e[s].overlap&&e[s].isPlaying&&(e[s].pause(),t[s]=true);this._playingBeforeDisable=t;}onRemove(){this.off();}addSlot(e,t){let s=this._slots;if(s[e])return null;let i=new _O(this,e,t);return s[e]=i,i.autoPlay&&this.enabled&&this.entity.enabled&&i.play(),i}removeSlot(e){let t=this._slots;t[e]&&(t[e].stop(),delete t[e]);}slot(e){return this._slots[e]}_getSlotProperty(e,t){if(!this.enabled||!this.entity.enabled)return;let s=this._slots[e];if(s)return s[t]}isPlaying(e){return this._getSlotProperty(e,"isPlaying")||false}isLoaded(e){return this._getSlotProperty(e,"isLoaded")||false}isPaused(e){return this._getSlotProperty(e,"isPaused")||false}isStopped(e){return this._getSlotProperty(e,"isStopped")||false}play(e){if(!this.enabled||!this.entity.enabled)return null;let t=this._slots[e];return t?t.play():null}pause(e){let t=this._slots;if(e){let s=t[e];if(!s)return;s.pause();}else for(let e in t)t[e].pause();}resume(e){let t=this._slots;if(e){let s=t[e];if(!s)return;s.isPaused&&s.resume();}else for(let e in t)t[e].resume();}stop(e){let t=this._slots;if(e){let s=t[e];if(!s)return;s.stop();}else for(let e in t)t[e].stop();}constructor(...e){super(...e),this._volume=1,this._pitch=1,this._positional=true,this._refDistance=1,this._maxDistance=1e4,this._rollOffFactor=1,this._distanceModel=eX,this._slots={},this._playingBeforeDisable={};}}_F.EVENT_PLAY="play",_F.EVENT_PAUSE="pause",_F.EVENT_RESUME="resume",_F.EVENT_STOP="stop",_F.EVENT_END="end";class _N{constructor(){this.enabled=true;}}let _B=["enabled"];class _U extends u9{set volume(e){this.manager.volume=e;}get volume(){return this.manager.volume}get context(){return rL()?this.manager.context:null}initializeComponentData(e,t,s){s=["volume","pitch","positional","refDistance","maxDistance","rollOffFactor","distanceModel","slots"];for(let i=0;i<s.length;i++)t.hasOwnProperty(s[i])&&(e[s[i]]=t[s[i]]);super.initializeComponentData(e,t,["enabled"]);}cloneComponent(e,t){let s=e.sound,i=s.slots,n={};for(let e in i){let t=i[e];n[e]={name:t.name,volume:t.volume,pitch:t.pitch,loop:t.loop,duration:t.duration,startTime:t.startTime,overlap:t.overlap,autoPlay:t.autoPlay,asset:t.asset};}let r={distanceModel:s.distanceModel,enabled:s.enabled,maxDistance:s.maxDistance,pitch:s.pitch,positional:s.positional,refDistance:s.refDistance,rollOffFactor:s.rollOffFactor,slots:n,volume:s.volume};return this.addComponent(t,r)}onUpdate(e){let t=this.store;for(let e in t)if(t.hasOwnProperty(e)){let s=t[e].entity;if(s.enabled){let e=s.sound;if(e.enabled&&e.positional){let t=s.getPosition(),i=e.slots;for(let e in i)i[e].updatePosition(t);}}}}onBeforeRemove(e,t){let s=t.slots;for(let e in s)s[e].overlap||s[e].stop();t.onRemove();}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this);}constructor(e){super(e),this.id="sound",this.ComponentType=_F,this.DataType=_N,this.schema=_B,this.manager=e.soundManager,this.app.systems.on("update",this.onUpdate,this),this.on("beforeremove",this.onBeforeRemove,this);}}u8._buildAccessors(_F.prototype,_B);let _k="simple",_z="animated";class _V extends Y{get duration(){if(this._sprite){let e=this.fps||Number.MIN_VALUE;return this._sprite.frameKeys.length/Math.abs(e)}return 0}set frame(e){this._setFrame(e);let t=this.fps||Number.MIN_VALUE;this._setTime(this._frame/t);}get frame(){return this._frame}get isPaused(){return this._paused}get isPlaying(){return this._playing}set sprite(e){if(this._sprite){var t;null==(t=this._evtSetMeshes)||t.off(),this._evtSetMeshes=null,this._sprite.off("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.off("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.off("set:texture",this._onSpriteMeshesChange,this);}if(this._sprite=e,this._sprite&&(this._evtSetMeshes=this._sprite.on("set:meshes",this._onSpriteMeshesChange,this),this._sprite.on("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.on("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.on("set:texture",this._onSpriteMeshesChange,this)),this._component.currentClip===this){let t;e&&e.atlas?(e.atlas.texture&&((t=this._component._meshInstance)&&(t.setParameter("texture_emissiveMap",e.atlas.texture),t.setParameter("texture_opacityMap",e.atlas.texture)),this._component.enabled&&this._component.entity.enabled&&this._component._showModel()),this.time&&this.fps?this.time=this.time:this.frame=this.frame):((t=this._component._meshInstance)&&(t.deleteParameter("texture_emissiveMap"),t.deleteParameter("texture_opacityMap")),this._component._hideModel());}}get sprite(){return this._sprite}set spriteAsset(e){let t=this._component.system.app.assets,s=e;if(e instanceof ub&&(s=e.id),this._spriteAsset!==s){if(this._spriteAsset){let e=t.get(this._spriteAsset);e&&this._unbindSpriteAsset(e);}if(this._spriteAsset=s,this._spriteAsset){let e=t.get(this._spriteAsset);e?this._bindSpriteAsset(e):(this.sprite=null,t.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this));}else this.sprite=null;}}get spriteAsset(){return this._spriteAsset}set time(e){this._setTime(e),this._sprite?this.frame=Math.min(this._sprite.frameKeys.length-1,Math.floor(this._time*Math.abs(this.fps))):this.frame=0;}get time(){return this._time}_onSpriteAssetAdded(e){this._component.system.app.assets.off("add:"+e.id,this._onSpriteAssetAdded,this),this._spriteAsset===e.id&&this._bindSpriteAsset(e);}_bindSpriteAsset(e){e.on("load",this._onSpriteAssetLoad,this),e.on("remove",this._onSpriteAssetRemove,this),e.resource?this._onSpriteAssetLoad(e):this._component.system.app.assets.load(e);}_unbindSpriteAsset(e){e&&(e.off("load",this._onSpriteAssetLoad,this),e.off("remove",this._onSpriteAssetRemove,this),e.resource&&!e.resource.atlas&&this._component.system.app.assets.off("load:"+e.data.textureAtlasAsset,this._onTextureAtlasLoad,this));}_onSpriteAssetLoad(e){if(e.resource){if(e.resource.atlas)this.sprite=e.resource;else {let t=e.data.textureAtlasAsset,s=this._component.system.app.assets;s.off("load:"+t,this._onTextureAtlasLoad,this),s.once("load:"+t,this._onTextureAtlasLoad,this);}}else this.sprite=null;}_onTextureAtlasLoad(e){let t=this._spriteAsset;t instanceof ub?this._onSpriteAssetLoad(t):this._onSpriteAssetLoad(this._component.system.app.assets.get(t));}_onSpriteAssetRemove(e){this.sprite=null;}_onSpriteMeshesChange(){this._component.currentClip===this&&this._component._showFrame(this.frame);}_onSpritePpuChanged(){this._component.currentClip===this&&0!==this.sprite.renderMode&&this._component._showFrame(this.frame);}_update(e){if(0===this.fps||!this._playing||this._paused||!this._sprite)return;let t=this.fps<0?-1:1,s=this._time+e*this._component.speed*t,i=this.duration,n=s>i||s<0;this._setTime(s);let r=this.frame;(r=this._sprite?Math.floor(this._sprite.frameKeys.length*this._time/i):0)!==this._frame&&this._setFrame(r),n&&(this.loop?(this.fire("loop"),this._component.fire("loop",this)):(this._playing=false,this._paused=false,this.fire("end"),this._component.fire("end",this)));}_setTime(e){this._time=e;let t=this.duration;this._time<0?this.loop?this._time=this._time%t+t:this._time=0:this._time>t&&(this.loop?this._time%=t:this._time=t);}_setFrame(e){this._sprite?this._frame=ei.clamp(e,0,this._sprite.frameKeys.length-1):this._frame=e,this._component.currentClip===this&&this._component._showFrame(this._frame);}_destroy(){if(this._spriteAsset){let e=this._component.system.app.assets;this._unbindSpriteAsset(e.get(this._spriteAsset));}this._sprite&&(this.sprite=null),this._spriteAsset&&(this.spriteAsset=null);}play(){!this._playing&&(this._playing=true,this._paused=false,this.frame=0,this.fire("play"),this._component.fire("play",this));}pause(){this._playing&&!this._paused&&(this._paused=true,this.fire("pause"),this._component.fire("pause",this));}resume(){this._paused&&(this._paused=false,this.fire("resume"),this._component.fire("resume",this));}stop(){this._playing&&(this._playing=false,this._paused=false,this._time=0,this.frame=0,this.fire("stop"),this._component.fire("stop",this));}constructor(e,t){super(),this._evtSetMeshes=null,this._component=e,this._frame=0,this._sprite=null,this._spriteAsset=null,this.spriteAsset=t.spriteAsset,this.name=t.name,this.fps=t.fps||0,this.loop=t.loop||false,this._playing=false,this._paused=false,this._time=0;}}_V.EVENT_PLAY="play",_V.EVENT_PAUSE="pause",_V.EVENT_RESUME="resume",_V.EVENT_STOP="stop",_V.EVENT_END="end",_V.EVENT_LOOP="loop";let _G="texture_emissiveMap",_H="texture_opacityMap",_W="material_emissive",_X="material_opacity";class _Y extends u8{set type(e){this._type!==e&&(this._type=e,this._type===_k?(this.stop(),this._currentClip=this._defaultClip,this.enabled&&this.entity.enabled&&(this._currentClip.frame=this.frame,this._currentClip.sprite?this._showModel():this._hideModel())):this._type===_z&&(this.stop(),this._autoPlayClip&&this._tryAutoPlay(),this._currentClip&&this._currentClip.isPlaying&&this.enabled&&this.entity.enabled?this._showModel():this._hideModel()));}get type(){return this._type}set frame(e){this._currentClip.frame=e;}get frame(){return this._currentClip.frame}set spriteAsset(e){this._defaultClip.spriteAsset=e;}get spriteAsset(){return this._defaultClip._spriteAsset}set sprite(e){this._currentClip.sprite=e;}get sprite(){return this._currentClip.sprite}set material(e){this._material=e,this._meshInstance&&(this._meshInstance.material=e);}get material(){return this._material}set color(e){this._color.r=e.r,this._color.g=e.g,this._color.b=e.b,this._meshInstance&&(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter(_W,this._colorUniform));}get color(){return this._color}set opacity(e){this._color.a=e,this._meshInstance&&this._meshInstance.setParameter(_X,e);}get opacity(){return this._color.a}set clips(e){if(!e){for(let e in this._clips)this.removeClip(e);return}for(let t in this._clips){let s=false;for(let i in e)if(e[i].name===t){s=true,this._clips[t].fps=e[i].fps,this._clips[t].loop=e[i].loop,e[i].hasOwnProperty("sprite")?this._clips[t].sprite=e[i].sprite:e[i].hasOwnProperty("spriteAsset")&&(this._clips[t].spriteAsset=e[i].spriteAsset);break}s||this.removeClip(t);}for(let t in e)this._clips[e[t].name]||this.addClip(e[t]);this._autoPlayClip&&this._tryAutoPlay(),this._currentClip&&this._currentClip.sprite||this._hideModel();}get clips(){return this._clips}get currentClip(){return this._currentClip}set speed(e){this._speed=e;}get speed(){return this._speed}set flipX(e){this._flipX!==e&&(this._flipX=e,this._updateTransform());}get flipX(){return this._flipX}set flipY(e){this._flipY!==e&&(this._flipY=e,this._updateTransform());}get flipY(){return this._flipY}set width(e){e!==this._width&&(this._width=e,this._outerScale.x=this._width,this.sprite&&(2===this.sprite.renderMode||1===this.sprite.renderMode)&&this._updateTransform());}get width(){return this._width}set height(e){e!==this._height&&(this._height=e,this._outerScale.y=this.height,this.sprite&&(2===this.sprite.renderMode||1===this.sprite.renderMode)&&this._updateTransform());}get height(){return this._height}set batchGroupId(e){var t,s;if(this._batchGroupId===e)return;let i=this._batchGroupId;this._batchGroupId=e,this.entity.enabled&&i>=0&&(null==(t=this.system.app.batcher)||t.remove(aF.SPRITE,i,this.entity)),this.entity.enabled&&e>=0?null==(s=this.system.app.batcher)||s.insert(aF.SPRITE,e,this.entity):i>=0&&this._currentClip&&this._currentClip.sprite&&this.enabled&&this.entity.enabled&&this._showModel();}get batchGroupId(){return this._batchGroupId}set autoPlayClip(e){this._autoPlayClip=e instanceof _V?e.name:e,this._tryAutoPlay();}get autoPlayClip(){return this._autoPlayClip}set drawOrder(e){this._drawOrder=e,this._meshInstance&&(this._meshInstance.drawOrder=e);}get drawOrder(){return this._drawOrder}set layers(e){this._addedModel&&this._hideModel(),this._layers=e,this._meshInstance&&this.enabled&&this.entity.enabled&&this._showModel();}get layers(){return this._layers}get aabb(){return this._meshInstance?this._meshInstance.aabb:null}onEnable(){let e=this.system.app,t=e.scene,s=t.layers;if(this._evtLayersChanged=t.on("set:layers",this._onLayersChanged,this),s&&(this._evtLayerAdded=s.on("add",this._onLayerAdded,this),this._evtLayerRemoved=s.on("remove",this._onLayerRemoved,this)),this._showModel(),this._autoPlayClip&&this._tryAutoPlay(),this._batchGroupId>=0){var i;null==(i=e.batcher)||i.insert(aF.SPRITE,this._batchGroupId,this.entity);}}onDisable(){var e,t,s,i;let n=this.system.app,r=n.scene.layers;null==(e=this._evtLayersChanged)||e.off(),this._evtLayersChanged=null,r&&(null==(t=this._evtLayerAdded)||t.off(),this._evtLayerAdded=null,null==(s=this._evtLayerRemoved)||s.off(),this._evtLayerRemoved=null),this.stop(),this._hideModel(),this._batchGroupId>=0&&(null==(i=n.batcher)||i.remove(aF.SPRITE,this._batchGroupId,this.entity));}onDestroy(){var e;for(let e in this._currentClip=null,this._defaultClip&&(this._defaultClip._destroy(),this._defaultClip=null),this._clips)this._clips[e]._destroy();this._clips=null,this._hideModel(),this._model=null,null==(e=this._node)||e.remove(),this._node=null,this._meshInstance&&(this._meshInstance.material=null,this._meshInstance.mesh=null,this._meshInstance=null);}_showModel(){if(this._addedModel||!this._meshInstance)return;let e=[this._meshInstance];for(let t=0,s=this._layers.length;t<s;t++){let s=this.system.app.scene.layers.getLayerById(this._layers[t]);s&&s.addMeshInstances(e);}this._addedModel=true;}_hideModel(){if(!this._addedModel||!this._meshInstance)return;let e=[this._meshInstance];for(let t=0,s=this._layers.length;t<s;t++){let s=this.system.app.scene.layers.getLayerById(this._layers[t]);s&&s.removeMeshInstances(e);}this._addedModel=false;}_showFrame(e){let t;if(!this.sprite)return;let s=this.sprite.meshes[e];if(!s){this._meshInstance&&(this._meshInstance.mesh=null,this._meshInstance.visible=false);return}if(t=1===this.sprite.renderMode?this.system.default9SlicedMaterialSlicedMode:2===this.sprite.renderMode?this.system.default9SlicedMaterialTiledMode:this.system.defaultMaterial,!this._meshInstance&&(this._meshInstance=new a0(s,this._material,this._node),this._meshInstance.castShadow=false,this._meshInstance.receiveShadow=false,this._meshInstance.drawOrder=this._drawOrder,this._model.meshInstances.push(this._meshInstance),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter(_W,this._colorUniform),this._meshInstance.setParameter(_X,this._color.a),this.enabled&&this.entity.enabled&&this._showModel()),this._meshInstance.material!==t&&(this._meshInstance.material=t),this._meshInstance.mesh!==s&&(this._meshInstance.mesh=s,this._meshInstance.visible=true,this._meshInstance._aabbVer=-1),this.sprite.atlas&&this.sprite.atlas.texture?(this._meshInstance.setParameter(_G,this.sprite.atlas.texture),this._meshInstance.setParameter(_H,this.sprite.atlas.texture)):(this._meshInstance.deleteParameter(_G),this._meshInstance.deleteParameter(_H)),this.sprite.atlas&&(1===this.sprite.renderMode||2===this.sprite.renderMode)){this._meshInstance._updateAabbFunc=this._updateAabbFunc;let t=this.sprite.atlas.frames[this.sprite.frameKeys[e]];if(t){let e=2/t.rect.z,s=2/t.rect.w;this._innerOffset.set(t.border.x*e,t.border.y*s,t.border.z*e,t.border.w*s);let i=this.sprite.atlas.texture;this._atlasRect.set(t.rect.x/i.width,t.rect.y/i.height,t.rect.z/i.width,t.rect.w/i.height);}else this._innerOffset.set(0,0,0,0);this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._meshInstance.setParameter("innerOffset",this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._meshInstance.setParameter("atlasRect",this._atlasRectUniform);}else this._meshInstance._updateAabbFunc=null;this._updateTransform();}_updateTransform(){let e=this.flipX?-1:1,t=this.flipY?-1:1,s=0,i=0;if(this.sprite&&(1===this.sprite.renderMode||2===this.sprite.renderMode)){let n=1,r=1;if(this.sprite.atlas){let e=this.sprite.atlas.frames[this.sprite.frameKeys[this.frame]];e&&(n=e.rect.z,r=e.rect.w,s=(.5-e.pivot.x)*this._width,i=(.5-e.pivot.y)*this._height);}let a=n/this.sprite.pixelsPerUnit,o=r/this.sprite.pixelsPerUnit;this._outerScale.set(Math.max(this._width,this._innerOffset.x*a),Math.max(this._height,this._innerOffset.y*o)),e*=a,t*=o,this._outerScale.x/=a,this._outerScale.y/=o,e*=ei.clamp(this._width/(this._innerOffset.x*a),1e-4,1),t*=ei.clamp(this._height/(this._innerOffset.y*o),1e-4,1),this._meshInstance&&(this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._meshInstance.setParameter("outerScale",this._outerScaleUniform));}this._node.setLocalScale(e,t,1),this._node.setLocalPosition(s,i,0);}_updateAabb(e){return e.center.set(0,0,0),e.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001),e.setFromTransformedAabb(e,this._node.getWorldTransform()),e}_tryAutoPlay(){if(!this._autoPlayClip||this.type!==_z)return;let e=this._clips[this._autoPlayClip];e&&!e.isPlaying&&(!this._currentClip||!this._currentClip.isPlaying)&&this.enabled&&this.entity.enabled&&this.play(e.name);}_onLayersChanged(e,t){e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this),this.enabled&&this.entity.enabled&&this._showModel();}_onLayerAdded(e){!(0>this.layers.indexOf(e.id))&&this._addedModel&&this.enabled&&this.entity.enabled&&this._meshInstance&&e.addMeshInstances([this._meshInstance]);}_onLayerRemoved(e){this._meshInstance&&(0>this.layers.indexOf(e.id)||e.removeMeshInstances([this._meshInstance]));}removeModelFromLayers(){for(let e=0;e<this.layers.length;e++){let t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&t.removeMeshInstances([this._meshInstance]);}}addClip(e){let t=new _V(this,{name:e.name,fps:e.fps,loop:e.loop,spriteAsset:e.spriteAsset});return this._clips[e.name]=t,t.name&&t.name===this._autoPlayClip&&this._tryAutoPlay(),t}removeClip(e){delete this._clips[e];}clip(e){return this._clips[e]}play(e){let t=this._clips[e],s=this._currentClip;return s&&s!==t&&(s._playing=false),this._currentClip=t,this._currentClip&&(this._currentClip=t,this._currentClip.play()),t}pause(){this._currentClip!==this._defaultClip&&this._currentClip.isPlaying&&this._currentClip.pause();}resume(){this._currentClip!==this._defaultClip&&this._currentClip.isPaused&&this._currentClip.resume();}stop(){this._currentClip!==this._defaultClip&&this._currentClip.stop();}constructor(e,t){super(e,t),this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._type=_k,this._material=e.defaultMaterial,this._color=new en(1,1,1,1),this._colorUniform=new Float32Array(3),this._speed=1,this._flipX=false,this._flipY=false,this._width=1,this._height=1,this._drawOrder=0,this._layers=[0],this._outerScale=new ef(1,1),this._outerScaleUniform=new Float32Array(2),this._innerOffset=new em,this._innerOffsetUniform=new Float32Array(4),this._atlasRect=new em,this._atlasRectUniform=new Float32Array(4),this._batchGroupId=-1,this._batchGroup=null,this._node=new oE,this._model=new hh,this._model.graph=this._node,this._meshInstance=null,t.addChild(this._model.graph),this._model._entity=t,this._updateAabbFunc=this._updateAabb.bind(this),this._addedModel=false,this._autoPlayClip=null,this._clips={},this._defaultClip=new _V(this,{name:this.entity.name,fps:0,loop:false,spriteAsset:null}),this._currentClip=this._defaultClip;}}_Y.EVENT_PLAY="play",_Y.EVENT_PAUSE="pause",_Y.EVENT_RESUME="resume",_Y.EVENT_STOP="stop",_Y.EVENT_END="end",_Y.EVENT_LOOP="loop";class _j{constructor(){this.enabled=true;}}let _q=["enabled"];class _K extends u9{set defaultMaterial(e){this._defaultMaterial=e;}get defaultMaterial(){if(!this._defaultMaterial){let e=new se(this.app.graphicsDevice,{width:1,height:1,format:20,name:"sprite"}),t=new Uint8Array(e.lock());t[0]=t[1]=t[2]=t[3]=255,e.unlock();let s=new cP;s.diffuse.set(0,0,0),s.emissive.set(1,1,1),s.emissiveMap=e,s.opacityMap=e,s.opacityMapChannel="a",s.useLighting=false,s.useTonemap=false,s.useFog=false,s.useSkybox=false,s.blendType=4,s.depthWrite=false,s.pixelSnap=false,s.cull=0,s.update(),this._defaultTexture=e,this._defaultMaterial=s;}return this._defaultMaterial}set default9SlicedMaterialSlicedMode(e){this._default9SlicedMaterialSlicedMode=e;}get default9SlicedMaterialSlicedMode(){if(!this._default9SlicedMaterialSlicedMode){let e=this.defaultMaterial.clone();e.nineSlicedMode=1,e.update(),this._default9SlicedMaterialSlicedMode=e;}return this._default9SlicedMaterialSlicedMode}set default9SlicedMaterialTiledMode(e){this._default9SlicedMaterialTiledMode=e;}get default9SlicedMaterialTiledMode(){if(!this._default9SlicedMaterialTiledMode){let e=this.defaultMaterial.clone();e.nineSlicedMode=2,e.update(),this._default9SlicedMaterialTiledMode=e;}return this._default9SlicedMaterialTiledMode}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this),this._defaultTexture&&(this._defaultTexture.destroy(),this._defaultTexture=null);}initializeComponentData(e,t,s){if(void 0!==t.enabled&&(e.enabled=t.enabled),e.type=t.type,t.layers&&Array.isArray(t.layers)&&(e.layers=t.layers.slice(0)),void 0!==t.drawOrder&&(e.drawOrder=t.drawOrder),void 0!==t.color){var i,n;t.color instanceof en?e.color.set(t.color.r,t.color.g,t.color.b,null!=(i=t.opacity)?i:1):e.color.set(t.color[0],t.color[1],t.color[2],null!=(n=t.opacity)?n:1),e.color=e.color;}if(void 0!==t.opacity&&(e.opacity=t.opacity),void 0!==t.flipX&&(e.flipX=t.flipX),void 0!==t.flipY&&(e.flipY=t.flipY),void 0!==t.width&&(e.width=t.width),void 0!==t.height&&(e.height=t.height),void 0!==t.spriteAsset&&(e.spriteAsset=t.spriteAsset),t.sprite&&(e.sprite=t.sprite),void 0!==t.frame&&(e.frame=t.frame),t.clips)for(let s in t.clips)e.addClip(t.clips[s]);void 0!==t.speed&&(e.speed=t.speed),t.autoPlayClip&&(e.autoPlayClip=t.autoPlayClip),e.batchGroupId=void 0===t.batchGroupId||null===t.batchGroupId?-1:t.batchGroupId,super.initializeComponentData(e,t,s);}cloneComponent(e,t){let s=e.sprite;return this.addComponent(t,{enabled:s.enabled,type:s.type,spriteAsset:s.spriteAsset,sprite:s.sprite,width:s.width,height:s.height,frame:s.frame,color:s.color.clone(),opacity:s.opacity,flipX:s.flipX,flipY:s.flipY,speed:s.speed,clips:s.clips,autoPlayClip:s.autoPlayClip,batchGroupId:s.batchGroupId,drawOrder:s.drawOrder,layers:s.layers.slice(0)})}onUpdate(e){let t=this.store;for(let s in t)if(t.hasOwnProperty(s)){let i=t[s];if(i.data.enabled&&i.entity.enabled){let t=i.entity.sprite;t._currentClip&&t._currentClip._update(e);}}}onBeforeRemove(e,t){t.onDestroy();}constructor(e){super(e),this.id="sprite",this.ComponentType=_Y,this.DataType=_j,this.schema=_q,this._defaultTexture=null,this._defaultMaterial=null,this._default9SlicedMaterialSlicedMode=null,this._default9SlicedMaterialTiledMode=null,this.app.systems.on("update",this.onUpdate,this),this.on("beforeremove",this.onBeforeRemove,this);}}u8._buildAccessors(_Y.prototype,_q);class _Z extends u8{set size(e){e instanceof eu?this._size.copy(e):e instanceof Array&&e.length>=3&&this.size.set(e[0],e[1],e[2]);}get size(){return this._size}onEnable(){this._checkState();}onDisable(){this._checkState();}_onSetEnabled(e,t,s){this._checkState();}_checkState(){let e=this.enabled&&this.entity.enabled;e!==this._oldState&&(this._oldState=e,this.fire("enable"),this.fire("state",this.enabled));}_onBeforeRemove(){this.fire("remove");}constructor(e,t){super(e,t),this._oldState=true,this._size=new eu,this.on("set_enabled",this._onSetEnabled,this);}}_Z.EVENT_ENABLE="enable",_Z.EVENT_DISABLE="disable",_Z.EVENT_STATE="state",_Z.EVENT_REMOVE="remove";class _Q{constructor(){this.enabled=true;}}let _J=["enabled"];class _$ extends u9{initializeComponentData(e,t,s){e.enabled=!t.hasOwnProperty("enabled")||!!t.enabled,t.size&&(t.size instanceof eu?e.size.copy(t.size):t.size instanceof Array&&t.size.length>=3&&e.size.set(t.size[0],t.size[1],t.size[2]));}cloneComponent(e,t){let s={enabled:e.zone.enabled,size:e.zone.size};return this.addComponent(t,s)}_onBeforeRemove(e,t){t._onBeforeRemove();}constructor(e){super(e),this.id="zone",this.ComponentType=_Z,this.DataType=_Q,this.schema=_J,this.on("beforeremove",this._onBeforeRemove,this);}}u8._buildAccessors(_Z.prototype,_J);class _0{constructor(e,t){this.effect=e,this.inputTarget=t,this.outputTarget=null,this.name=e.constructor.name;}}class _1{_allocateColorBuffer(e,t){var s,i;let n=this.camera.rect,r=this.destinationRenderTarget,a=this.app.graphicsDevice,o=Math.floor(n.z*(null!=(s=null==r?void 0:r.width)?s:a.width)),l=Math.floor(n.w*(null!=(i=null==r?void 0:r.height)?i:a.height));return new se(a,{name:t,format:e,width:o,height:l,mipmaps:false,minFilter:0,magFilter:0,addressU:1,addressV:1})}_createOffscreenTarget(e,t){var s,i;let n=this.app.graphicsDevice,r=(null!=(s=this.destinationRenderTarget)?s:n.backBuffer).isColorBufferSrgb(0),a=null!=(i=t&&n.getRenderableHdrFormat([12,14],true))?i:r?20:7,o=this.camera.entity.name+"-posteffect-"+this.effects.length;return new sR({colorBuffer:this._allocateColorBuffer(a,o),depth:e,stencil:e&&this.app.graphicsDevice.supportsStencil,samples:e?n.samples:1})}_resizeOffscreenTarget(e){let t=e.colorBuffer.format,s=e.colorBuffer.name;e.destroyFrameBuffers(),e.destroyTextureBuffers(),e._colorBuffer=this._allocateColorBuffer(t,s),e._colorBuffers=[e._colorBuffer];}_destroyOffscreenTarget(e){e.destroyTextureBuffers(),e.destroy();}addEffect(e){let t=this.effects,s=0===t.length,i=this._createOffscreenTarget(s,e.hdr),n=new _0(e,i);t.push(n),this._sourceTarget=n.inputTarget,t.length>1&&(t[t.length-2].outputTarget=n.inputTarget),this._newPostEffect=e,e.needsDepthBuffer&&this._requestDepthMap(),this.enable(),this._newPostEffect=void 0;}removeEffect(e){let t=-1;for(let s=0,i=this.effects.length;s<i;s++)if(this.effects[s].effect===e){t=s;break}t>=0&&(t>0?this.effects[t-1].outputTarget=t+1<this.effects.length?this.effects[t+1].inputTarget:null:this.effects.length>1&&(this.effects[1].inputTarget._depth||(this._destroyOffscreenTarget(this.effects[1].inputTarget),this.effects[1].inputTarget=this._createOffscreenTarget(true,this.effects[1].hdr),this._sourceTarget=this.effects[1].inputTarget),this.camera.renderTarget=this.effects[1].inputTarget),this._destroyOffscreenTarget(this.effects[t].inputTarget),this.effects.splice(t,1)),this.enabled&&e.needsDepthBuffer&&this._releaseDepthMap(),0===this.effects.length&&this.disable();}_requestDepthMaps(){for(let e=0,t=this.effects.length;e<t;e++){let t=this.effects[e].effect;this._newPostEffect!==t&&t.needsDepthBuffer&&this._requestDepthMap();}}_releaseDepthMaps(){for(let e=0,t=this.effects.length;e<t;e++)this.effects[e].effect.needsDepthBuffer&&this._releaseDepthMap();}_requestDepthMap(){let e=this.app.scene.layers.getLayerById(1);e&&(e.incrementCounter(),this.camera.requestSceneDepthMap(true));}_releaseDepthMap(){let e=this.app.scene.layers.getLayerById(1);e&&(e.decrementCounter(),this.camera.requestSceneDepthMap(false));}destroy(){for(let e=0,t=this.effects.length;e<t;e++)this.effects[e].inputTarget.destroy();this.effects.length=0,this.disable();}enable(){!this.enabled&&this.effects.length&&(this.enabled=true,this._requestDepthMaps(),this.app.graphicsDevice.on("resizecanvas",this._onCanvasResized,this),this.destinationRenderTarget=this.camera.renderTarget,this.camera.renderTarget=this.effects[0].inputTarget,this.camera.onPostprocessing=()=>{if(this.enabled){let e=null,t=this.effects.length;if(t)for(let s=0;s<t;s++){let i=this.effects[s],n=i.outputTarget;s===t-1&&(e=this.camera.rect,this.destinationRenderTarget&&(n=this.destinationRenderTarget)),i.effect.render(i.inputTarget,n,e);}}});}disable(){this.enabled&&(this.enabled=false,this.app.graphicsDevice.off("resizecanvas",this._onCanvasResized,this),this._releaseDepthMaps(),this._destroyOffscreenTarget(this._sourceTarget),this.camera.renderTarget=this.destinationRenderTarget,this.camera.onPostprocessing=null);}_onCanvasResized(e,t){var s,i;let n=this.camera.rect,r=this.destinationRenderTarget;e=null!=(s=null==r?void 0:r.width)?s:e,t=null!=(i=null==r?void 0:r.height)?i:t,this.camera.camera.aspectRatio=e*n.z/(t*n.w),this.resizeRenderTargets();}resizeRenderTargets(){var e,t;let s=this.app.graphicsDevice,i=this.destinationRenderTarget,n=null!=(e=null==i?void 0:i.width)?e:s.width,r=null!=(t=null==i?void 0:i.height)?t:s.height,a=this.camera.rect,o=Math.floor(a.z*n),l=Math.floor(a.w*r),h=this.effects;for(let e=0,t=h.length;e<t;e++){let t=h[e];(t.inputTarget.width!==o||t.inputTarget.height!==l)&&this._resizeOffscreenTarget(t.inputTarget);}}onCameraRectChanged(e,t,s){this.enabled&&this.resizeRenderTargets();}constructor(e,t){this.app=e,this.camera=t,this.destinationRenderTarget=null,this.effects=[],this.enabled=false,this.depthTarget=null,t.on("set:rect",this.onCameraRectChanged,this);}}class _2 extends u8{setShaderPass(e){let t=ax.get(this.system.app.graphicsDevice),s=e?t.allocate(e,{isForward:true}):null;return this._camera.shaderPassInfo=s,s.index}getShaderPass(){var e;return null==(e=this._camera.shaderPassInfo)?void 0:e.name}set renderPasses(e){this._camera.renderPasses=e||[],this.dirtyLayerCompositionCameras(),this.system.app.scene.updateShaders=true;}get renderPasses(){return this._camera.renderPasses}get shaderParams(){return this._camera.shaderParams}set gammaCorrection(e){this.camera.shaderParams.gammaCorrection=e;}get gammaCorrection(){return this.camera.shaderParams.gammaCorrection}set toneMapping(e){this.camera.shaderParams.toneMapping=e;}get toneMapping(){return this.camera.shaderParams.toneMapping}set fog(e){this._camera.fogParams=e;}get fog(){return this._camera.fogParams}set aperture(e){this._camera.aperture=e;}get aperture(){return this._camera.aperture}set aspectRatio(e){this._camera.aspectRatio=e;}get aspectRatio(){return this._camera.aspectRatio}set aspectRatioMode(e){this._camera.aspectRatioMode=e;}get aspectRatioMode(){return this._camera.aspectRatioMode}set calculateProjection(e){this._camera.calculateProjection=e;}get calculateProjection(){return this._camera.calculateProjection}set calculateTransform(e){this._camera.calculateTransform=e;}get calculateTransform(){return this._camera.calculateTransform}get camera(){return this._camera}set clearColor(e){this._camera.clearColor=e;}get clearColor(){return this._camera.clearColor}set clearColorBuffer(e){this._camera.clearColorBuffer=e,this.dirtyLayerCompositionCameras();}get clearColorBuffer(){return this._camera.clearColorBuffer}set clearDepthBuffer(e){this._camera.clearDepthBuffer=e,this.dirtyLayerCompositionCameras();}get clearDepthBuffer(){return this._camera.clearDepthBuffer}set clearStencilBuffer(e){this._camera.clearStencilBuffer=e,this.dirtyLayerCompositionCameras();}get clearStencilBuffer(){return this._camera.clearStencilBuffer}set cullFaces(e){this._camera.cullFaces=e;}get cullFaces(){return this._camera.cullFaces}set disablePostEffectsLayer(e){this._disablePostEffectsLayer=e,this.dirtyLayerCompositionCameras();}get disablePostEffectsLayer(){return this._disablePostEffectsLayer}set farClip(e){this._camera.farClip=e;}get farClip(){return this._camera.farClip}set flipFaces(e){this._camera.flipFaces=e;}get flipFaces(){return this._camera.flipFaces}set fov(e){this._camera.fov=e;}get fov(){return this._camera.fov}get frustum(){return this._camera.frustum}set frustumCulling(e){this._camera.frustumCulling=e;}get frustumCulling(){return this._camera.frustumCulling}set horizontalFov(e){this._camera.horizontalFov=e;}get horizontalFov(){return this._camera.horizontalFov}set layers(e){let t=this._camera.layers,s=this.system.app.scene;t.forEach(e=>{let t=s.layers.getLayerById(e);null==t||t.removeCamera(this);}),this._camera.layers=e,this.enabled&&this.entity.enabled&&e.forEach(e=>{let t=s.layers.getLayerById(e);null==t||t.addCamera(this);});}get layers(){return this._camera.layers}get layersSet(){return this._camera.layersSet}set jitter(e){this._camera.jitter=e;}get jitter(){return this._camera.jitter}set nearClip(e){this._camera.nearClip=e;}get nearClip(){return this._camera.nearClip}set orthoHeight(e){this._camera.orthoHeight=e;}get orthoHeight(){return this._camera.orthoHeight}get postEffects(){return this._postEffects}get postEffectsEnabled(){return this._postEffects.enabled}set priority(e){this._priority=e,this.dirtyLayerCompositionCameras();}get priority(){return this._priority}set projection(e){this._camera.projection=e;}get projection(){return this._camera.projection}get projectionMatrix(){return this._camera.projectionMatrix}set rect(e){this._camera.rect=e,this.fire("set:rect",this._camera.rect);}get rect(){return this._camera.rect}set renderSceneColorMap(e){e&&!this._sceneColorMapRequested?(this.requestSceneColorMap(true),this._sceneColorMapRequested=true):this._sceneColorMapRequested&&(this.requestSceneColorMap(false),this._sceneColorMapRequested=false);}get renderSceneColorMap(){return this._renderSceneColorMap>0}set renderSceneDepthMap(e){e&&!this._sceneDepthMapRequested?(this.requestSceneDepthMap(true),this._sceneDepthMapRequested=true):this._sceneDepthMapRequested&&(this.requestSceneDepthMap(false),this._sceneDepthMapRequested=false);}get renderSceneDepthMap(){return this._renderSceneDepthMap>0}set renderTarget(e){this._camera.renderTarget=e,this.dirtyLayerCompositionCameras();}get renderTarget(){return this._camera.renderTarget}set scissorRect(e){this._camera.scissorRect=e;}get scissorRect(){return this._camera.scissorRect}set sensitivity(e){this._camera.sensitivity=e;}get sensitivity(){return this._camera.sensitivity}set shutter(e){this._camera.shutter=e;}get shutter(){return this._camera.shutter}get viewMatrix(){return this._camera.viewMatrix}_enableDepthLayer(e){if(this.layers.find(e=>1===e)){let t=this.system.app.scene.layers.getLayerById(1);e?null==t||t.incrementCounter():null==t||t.decrementCounter();}else if(e)return  false;return  true}requestSceneColorMap(e){this._renderSceneColorMap+=e?1:-1,this._enableDepthLayer(e),this.camera._enableRenderPassColorGrab(this.system.app.graphicsDevice,this.renderSceneColorMap),this.system.app.scene.layers.markDirty();}requestSceneDepthMap(e){this._renderSceneDepthMap+=e?1:-1,this._enableDepthLayer(e),this.camera._enableRenderPassDepthGrab(this.system.app.graphicsDevice,this.system.app.renderer,this.renderSceneDepthMap),this.system.app.scene.layers.markDirty();}dirtyLayerCompositionCameras(){this.system.app.scene.layers._dirty=true;}screenToWorld(e,t,s,i){let{width:n,height:r}=this.system.app.graphicsDevice.clientRect;return this._camera.screenToWorld(e,t,s,n,r,i)}worldToScreen(e,t){let{width:s,height:i}=this.system.app.graphicsDevice.clientRect;return this._camera.worldToScreen(e,s,i,t)}onAppPrerender(){this._camera._viewMatDirty=true,this._camera._viewProjMatDirty=true;}addCameraToLayers(){let e=this.layers;for(let t=0;t<e.length;t++){let s=this.system.app.scene.layers.getLayerById(e[t]);s&&s.addCamera(this);}}removeCameraFromLayers(){let e=this.layers;for(let t=0;t<e.length;t++){let s=this.system.app.scene.layers.getLayerById(e[t]);s&&s.removeCamera(this);}}onLayersChanged(e,t){this.addCameraToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this);}onLayerAdded(e){0>this.layers.indexOf(e.id)||e.addCamera(this);}onLayerRemoved(e){0>this.layers.indexOf(e.id)||e.removeCamera(this);}onEnable(){var e,t,s;let i=this.system.app.scene,n=i.layers;this.system.addCamera(this),null==(e=this._evtLayersChanged)||e.off(),this._evtLayersChanged=i.on("set:layers",this.onLayersChanged,this),n&&(null==(t=this._evtLayerAdded)||t.off(),this._evtLayerAdded=n.on("add",this.onLayerAdded,this),null==(s=this._evtLayerRemoved)||s.off(),this._evtLayerRemoved=n.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addCameraToLayers(),this.postEffects.enable();}onDisable(){var e,t,s;let i=this.system.app.scene.layers;this.postEffects.disable(),this.removeCameraFromLayers(),null==(e=this._evtLayersChanged)||e.off(),this._evtLayersChanged=null,i&&(null==(t=this._evtLayerAdded)||t.off(),this._evtLayerAdded=null,null==(s=this._evtLayerRemoved)||s.off(),this._evtLayerRemoved=null),this.system.removeCamera(this);}onRemove(){this.onDisable(),this.off(),this.camera.destroy();}calculateAspectRatio(e){let t=this.system.app.graphicsDevice,s=e?e.width:t.width,i=e?e.height:t.height;return s*this.rect.z/(i*this.rect.w)}frameUpdate(e){0===this.aspectRatioMode&&(this.aspectRatio=this.calculateAspectRatio(e));}startXr(e,t,s){this.system.app.xr.start(this,e,t,s);}endXr(e){if(!this._camera.xr){e&&e(Error("Camera is not in XR"));return}this._camera.xr.end(e);}copy(e){this.aperture=e.aperture,this.aspectRatio=e.aspectRatio,this.aspectRatioMode=e.aspectRatioMode,this.calculateProjection=e.calculateProjection,this.calculateTransform=e.calculateTransform,this.clearColor=e.clearColor,this.clearColorBuffer=e.clearColorBuffer,this.clearDepthBuffer=e.clearDepthBuffer,this.clearStencilBuffer=e.clearStencilBuffer,this.cullFaces=e.cullFaces,this.disablePostEffectsLayer=e.disablePostEffectsLayer,this.farClip=e.farClip,this.flipFaces=e.flipFaces,this.fov=e.fov,this.frustumCulling=e.frustumCulling,this.horizontalFov=e.horizontalFov,this.layers=e.layers,this.nearClip=e.nearClip,this.orthoHeight=e.orthoHeight,this.priority=e.priority,this.projection=e.projection,this.rect=e.rect,this.renderTarget=e.renderTarget,this.scissorRect=e.scissorRect,this.sensitivity=e.sensitivity,this.shutter=e.shutter;}constructor(e,t){super(e,t),this.onPostprocessing=null,this._renderSceneDepthMap=0,this._renderSceneColorMap=0,this._sceneDepthMapRequested=false,this._sceneColorMapRequested=false,this._priority=0,this._disablePostEffectsLayer=4,this._camera=new oo,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._camera.node=t,this._postEffects=new _1(e.app,this);}}class _3{constructor(){this.enabled=true;}}let _4=["enabled"];class _5 extends u9{initializeComponentData(e,t,s){s=["aspectRatio","aspectRatioMode","calculateProjection","calculateTransform","clearColor","clearColorBuffer","clearDepthBuffer","clearStencilBuffer","renderSceneColorMap","renderSceneDepthMap","cullFaces","farClip","flipFaces","fog","fov","frustumCulling","horizontalFov","layers","renderTarget","nearClip","orthoHeight","projection","priority","rect","scissorRect","aperture","shutter","sensitivity","gammaCorrection","toneMapping"];for(let i=0;i<s.length;i++){let n=s[i];if(t.hasOwnProperty(n)){let s=t[n];switch(n){case "rect":case "scissorRect":Array.isArray(s)?e[n]=new em(s[0],s[1],s[2],s[3]):e[n]=s;break;case "clearColor":Array.isArray(s)?e[n]=new en(s[0],s[1],s[2],s[3]):e[n]=s;break;default:e[n]=s;}}}super.initializeComponentData(e,t,["enabled"]);}cloneComponent(e,t){let s=e.camera;return this.addComponent(t,{aspectRatio:s.aspectRatio,aspectRatioMode:s.aspectRatioMode,calculateProjection:s.calculateProjection,calculateTransform:s.calculateTransform,clearColor:s.clearColor,clearColorBuffer:s.clearColorBuffer,clearDepthBuffer:s.clearDepthBuffer,clearStencilBuffer:s.clearStencilBuffer,renderSceneDepthMap:s.renderSceneDepthMap,renderSceneColorMap:s.renderSceneColorMap,cullFaces:s.cullFaces,enabled:s.enabled,farClip:s.farClip,flipFaces:s.flipFaces,fov:s.fov,frustumCulling:s.frustumCulling,horizontalFov:s.horizontalFov,layers:s.layers,renderTarget:s.renderTarget,nearClip:s.nearClip,orthoHeight:s.orthoHeight,projection:s.projection,priority:s.priority,rect:s.rect,scissorRect:s.scissorRect,aperture:s.aperture,sensitivity:s.sensitivity,shutter:s.shutter,gammaCorrection:s.gammaCorrection,toneMapping:s.toneMapping})}onBeforeRemove(e,t){this.removeCamera(t),t.onRemove();}onAppPrerender(){for(let e=0,t=this.cameras.length;e<t;e++)this.cameras[e].onAppPrerender();}addCamera(e){this.cameras.push(e),l4(this.cameras);}removeCamera(e){let t=this.cameras.indexOf(e);t>=0&&(this.cameras.splice(t,1),l4(this.cameras));}destroy(){this.app.off("prerender",this.onAppPrerender,this),super.destroy();}constructor(e){super(e),this.cameras=[],this.id="camera",this.ComponentType=_2,this.DataType=_3,this.schema=_4,this.on("beforeremove",this.onBeforeRemove,this),this.app.on("prerender",this.onAppPrerender,this);}}u8._buildAccessors(_2.prototype,_4);class _6{constructor(){this.enabled=true,this.type="directional",this.color=new en(1,1,1),this.intensity=1,this.luminance=0,this.shape=0,this.affectSpecularity=true,this.castShadows=false,this.shadowDistance=40,this.shadowIntensity=1,this.shadowResolution=1024,this.shadowBias=.05,this.numCascades=1,this.cascadeBlend=0,this.bakeNumSamples=1,this.bakeArea=0,this.cascadeDistribution=.5,this.normalOffsetBias=0,this.range=10,this.innerConeAngle=40,this.outerConeAngle=45,this.falloffMode=0,this.shadowType=0,this.vsmBlurSize=11,this.vsmBlurMode=1,this.vsmBias=.0025,this.cookieAsset=null,this.cookie=null,this.cookieIntensity=1,this.cookieFalloff=true,this.cookieChannel="rgb",this.cookieAngle=0,this.cookieScale=null,this.cookieOffset=null,this.shadowUpdateMode=2,this.mask=1,this.affectDynamic=true,this.affectLightmapped=false,this.bake=false,this.bakeDir=true,this.isStatic=false,this.layers=[0],this.penumbraSize=1,this.penumbraFalloff=1,this.shadowSamples=16,this.shadowBlockerSamples=16;}}let _8=Object.keys(new _6);class _9 extends u8{get data(){let e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){this._setValue("enabled",e,function(e,t){this.onSetEnabled(null,t,e);});}get enabled(){return this.data.enabled}set light(e){this._setValue("light",e);}get light(){return this.data.light}set type(e){this._setValue("type",e,function(e,t){this.system.changeType(this,t,e),this.refreshProperties();});}get type(){return this.data.type}set color(e){this._setValue("color",e,function(e,t){this.light.setColor(e);},true);}get color(){return this.data.color}set intensity(e){this._setValue("intensity",e,function(e,t){this.light.intensity=e;});}get intensity(){return this.data.intensity}set luminance(e){this._setValue("luminance",e,function(e,t){this.light.luminance=e;});}get luminance(){return this.data.luminance}set shape(e){this._setValue("shape",e,function(e,t){this.light.shape=e;});}get shape(){return this.data.shape}set affectSpecularity(e){this._setValue("affectSpecularity",e,function(e,t){this.light.affectSpecularity=e;});}get affectSpecularity(){return this.data.affectSpecularity}set castShadows(e){this._setValue("castShadows",e,function(e,t){this.light.castShadows=e;});}get castShadows(){return this.data.castShadows}set shadowDistance(e){this._setValue("shadowDistance",e,function(e,t){this.light.shadowDistance=e;});}get shadowDistance(){return this.data.shadowDistance}set shadowIntensity(e){this._setValue("shadowIntensity",e,function(e,t){this.light.shadowIntensity=e;});}get shadowIntensity(){return this.data.shadowIntensity}set shadowResolution(e){this._setValue("shadowResolution",e,function(e,t){this.light.shadowResolution=e;});}get shadowResolution(){return this.data.shadowResolution}set shadowBias(e){this._setValue("shadowBias",e,function(e,t){this.light.shadowBias=-0.01*ei.clamp(e,0,1);});}get shadowBias(){return this.data.shadowBias}set numCascades(e){this._setValue("numCascades",e,function(e,t){this.light.numCascades=ei.clamp(Math.floor(e),1,4);});}get numCascades(){return this.data.numCascades}set cascadeBlend(e){this._setValue("cascadeBlend",e,function(e,t){this.light.cascadeBlend=ei.clamp(e,0,1);});}get cascadeBlend(){return this.data.cascadeBlend}set bakeNumSamples(e){this._setValue("bakeNumSamples",e,function(e,t){this.light.bakeNumSamples=ei.clamp(Math.floor(e),1,255);});}get bakeNumSamples(){return this.data.bakeNumSamples}set bakeArea(e){this._setValue("bakeArea",e,function(e,t){this.light.bakeArea=ei.clamp(e,0,180);});}get bakeArea(){return this.data.bakeArea}set cascadeDistribution(e){this._setValue("cascadeDistribution",e,function(e,t){this.light.cascadeDistribution=ei.clamp(e,0,1);});}get cascadeDistribution(){return this.data.cascadeDistribution}set normalOffsetBias(e){this._setValue("normalOffsetBias",e,function(e,t){this.light.normalOffsetBias=ei.clamp(e,0,1);});}get normalOffsetBias(){return this.data.normalOffsetBias}set range(e){this._setValue("range",e,function(e,t){this.light.attenuationEnd=e;});}get range(){return this.data.range}set innerConeAngle(e){this._setValue("innerConeAngle",e,function(e,t){this.light.innerConeAngle=e;});}get innerConeAngle(){return this.data.innerConeAngle}set outerConeAngle(e){this._setValue("outerConeAngle",e,function(e,t){this.light.outerConeAngle=e;});}get outerConeAngle(){return this.data.outerConeAngle}set falloffMode(e){this._setValue("falloffMode",e,function(e,t){this.light.falloffMode=e;});}get falloffMode(){return this.data.falloffMode}set shadowType(e){this._setValue("shadowType",e,function(e,t){this.light.shadowType=e;});}get shadowType(){return this.data.shadowType}set vsmBlurSize(e){this._setValue("vsmBlurSize",e,function(e,t){this.light.vsmBlurSize=e;});}get vsmBlurSize(){return this.data.vsmBlurSize}set vsmBlurMode(e){this._setValue("vsmBlurMode",e,function(e,t){this.light.vsmBlurMode=e;});}get vsmBlurMode(){return this.data.vsmBlurMode}set vsmBias(e){this._setValue("vsmBias",e,function(e,t){this.light.vsmBias=ei.clamp(e,0,1);});}get vsmBias(){return this.data.vsmBias}set cookieAsset(e){this._setValue("cookieAsset",e,function(e,t){if(!this._cookieAssetId||(!(e instanceof ub)||e.id!==this._cookieAssetId)&&e!==this._cookieAssetId){if(this.onCookieAssetRemove(),this._cookieAssetId=null,e instanceof ub)this.data.cookieAsset=e.id,this._cookieAssetId=e.id,this.onCookieAssetAdd(e);else if("number"==typeof e){this._cookieAssetId=e;let t=this.system.app.assets.get(e);t?this.onCookieAssetAdd(t):(this._cookieAssetAdd=true,this.system.app.assets.on("add:"+this._cookieAssetId,this.onCookieAssetAdd,this));}}});}get cookieAsset(){return this.data.cookieAsset}set cookie(e){this._setValue("cookie",e,function(e,t){this.light.cookie=e;});}get cookie(){return this.data.cookie}set cookieIntensity(e){this._setValue("cookieIntensity",e,function(e,t){this.light.cookieIntensity=ei.clamp(e,0,1);});}get cookieIntensity(){return this.data.cookieIntensity}set cookieFalloff(e){this._setValue("cookieFalloff",e,function(e,t){this.light.cookieFalloff=e;});}get cookieFalloff(){return this.data.cookieFalloff}set cookieChannel(e){this._setValue("cookieChannel",e,function(e,t){this.light.cookieChannel=e;});}get cookieChannel(){return this.data.cookieChannel}set cookieAngle(e){this._setValue("cookieAngle",e,function(e,t){if(0!==e||null!==this.cookieScale){this._cookieMatrix||(this._cookieMatrix=new em);let t=1,s=1;this.cookieScale&&(t=this.cookieScale.x,s=this.cookieScale.y);let i=Math.cos(e*ei.DEG_TO_RAD),n=Math.sin(e*ei.DEG_TO_RAD);this._cookieMatrix.set(i/t,-n/t,n/s,i/s),this.light.cookieTransform=this._cookieMatrix;}else this.light.cookieTransform=null;});}get cookieAngle(){return this.data.cookieAngle}set cookieScale(e){this._setValue("cookieScale",e,function(e,t){if(null!==e||0!==this.cookieAngle){this._cookieMatrix||(this._cookieMatrix=new em);let t=e.x,s=e.y,i=Math.cos(this.cookieAngle*ei.DEG_TO_RAD),n=Math.sin(this.cookieAngle*ei.DEG_TO_RAD);this._cookieMatrix.set(i/t,-n/t,n/s,i/s),this.light.cookieTransform=this._cookieMatrix;}else this.light.cookieTransform=null;},true);}get cookieScale(){return this.data.cookieScale}set cookieOffset(e){this._setValue("cookieOffset",e,function(e,t){this.light.cookieOffset=e;},true);}get cookieOffset(){return this.data.cookieOffset}set shadowUpdateMode(e){this._setValue("shadowUpdateMode",e,function(e,t){this.light.shadowUpdateMode=e;},true);}get shadowUpdateMode(){return this.data.shadowUpdateMode}set mask(e){this._setValue("mask",e,function(e,t){this.light.mask=e;});}get mask(){return this.data.mask}set affectDynamic(e){this._setValue("affectDynamic",e,function(e,t){e?this.light.mask|=1:this.light.mask&=-2,this.light.layersDirty();});}get affectDynamic(){return this.data.affectDynamic}set affectLightmapped(e){this._setValue("affectLightmapped",e,function(e,t){e?(this.light.mask|=2,this.bake&&(this.light.mask&=-5)):(this.light.mask&=-3,this.bake&&(this.light.mask|=4));});}get affectLightmapped(){return this.data.affectLightmapped}set bake(e){this._setValue("bake",e,function(e,t){e?(this.light.mask|=4,this.affectLightmapped&&(this.light.mask&=-3)):(this.light.mask&=-5,this.affectLightmapped&&(this.light.mask|=2)),this.light.layersDirty();});}get bake(){return this.data.bake}set bakeDir(e){this._setValue("bakeDir",e,function(e,t){this.light.bakeDir=e;});}get bakeDir(){return this.data.bakeDir}set isStatic(e){this._setValue("isStatic",e,function(e,t){this.light.isStatic=e;});}get isStatic(){return this.data.isStatic}set layers(e){this._setValue("layers",e,function(e,t){for(let e=0;e<t.length;e++){let s=this.system.app.scene.layers.getLayerById(t[e]);s&&(s.removeLight(this),this.light.removeLayer(s));}for(let t=0;t<e.length;t++){let s=this.system.app.scene.layers.getLayerById(e[t]);s&&this.enabled&&this.entity.enabled&&(s.addLight(this),this.light.addLayer(s));}});}get layers(){return this.data.layers}set shadowUpdateOverrides(e){this.light.shadowUpdateOverrides=e;}get shadowUpdateOverrides(){return this.light.shadowUpdateOverrides}set shadowSamples(e){this.light.shadowSamples=e;}get shadowSamples(){return this.light.shadowSamples}set shadowBlockerSamples(e){this.light.shadowBlockerSamples=e;}get shadowBlockerSamples(){return this.light.shadowBlockerSamples}set penumbraSize(e){this.light.penumbraSize=e;}get penumbraSize(){return this.light.penumbraSize}set penumbraFalloff(e){this.light.penumbraFalloff=e;}get penumbraFalloff(){return this.light.penumbraFalloff}_setValue(e,t,s,i){let n=this.data,r=n[e];(i||r!==t)&&(n[e]=t,s&&s.call(this,t,r));}addLightToLayers(){for(let e=0;e<this.layers.length;e++){let t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&(t.addLight(this),this.light.addLayer(t));}}removeLightFromLayers(){for(let e=0;e<this.layers.length;e++){let t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&(t.removeLight(this),this.light.removeLayer(t));}}onLayersChanged(e,t){this.enabled&&this.entity.enabled&&this.addLightToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this);}onLayerAdded(e){this.layers.indexOf(e.id)>=0&&this.enabled&&this.entity.enabled&&(e.addLight(this),this.light.addLayer(e));}onLayerRemoved(e){this.layers.indexOf(e.id)>=0&&(e.removeLight(this),this.light.removeLayer(e));}refreshProperties(){for(let e=0;e<_8.length;e++){let t=_8[e];this[t]=this[t];}this.enabled&&this.entity.enabled&&this.onEnable();}onCookieAssetSet(){let e=false;"cubemap"!==this._cookieAsset.type||this._cookieAsset.loadFaces||(this._cookieAsset.loadFaces=true,e=true),(!this._cookieAsset.resource||e)&&this.system.app.assets.load(this._cookieAsset),this._cookieAsset.resource&&this.onCookieAssetLoad();}onCookieAssetAdd(e){this._cookieAssetId===e.id&&(this._cookieAsset=e,this.light.enabled&&this.onCookieAssetSet(),this._cookieAsset.on("load",this.onCookieAssetLoad,this),this._cookieAsset.on("remove",this.onCookieAssetRemove,this));}onCookieAssetLoad(){this._cookieAsset&&this._cookieAsset.resource&&(this.cookie=this._cookieAsset.resource);}onCookieAssetRemove(){this._cookieAssetId&&(this._cookieAssetAdd&&(this.system.app.assets.off("add:"+this._cookieAssetId,this.onCookieAssetAdd,this),this._cookieAssetAdd=false),this._cookieAsset&&(this._cookieAsset.off("load",this.onCookieAssetLoad,this),this._cookieAsset.off("remove",this.onCookieAssetRemove,this),this._cookieAsset=null),this.cookie=null);}onEnable(){let e=this.system.app.scene,t=e.layers;this.light.enabled=true,this._evtLayersChanged=e.on("set:layers",this.onLayersChanged,this),t&&(this._evtLayerAdded=t.on("add",this.onLayerAdded,this),this._evtLayerRemoved=t.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addLightToLayers(),this._cookieAsset&&!this.cookie&&this.onCookieAssetSet();}onDisable(){var e,t,s;let i=this.system.app.scene.layers;this.light.enabled=false,null==(e=this._evtLayersChanged)||e.off(),this._evtLayersChanged=null,i&&(null==(t=this._evtLayerAdded)||t.off(),this._evtLayerAdded=null,null==(s=this._evtLayerRemoved)||s.off(),this._evtLayerRemoved=null),this.removeLightFromLayers();}onRemove(){this.onDisable(),this.light.destroy(),this.cookieAsset=null;}constructor(...e){super(...e),this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._cookieAsset=null,this._cookieAssetId=null,this._cookieAssetAdd=false,this._cookieMatrix=null;}}function _7(){return (_7=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i]);}return e}).apply(this,arguments)}class ge extends u9{initializeComponentData(e,t){let s=_7({},t);s.type||(s.type=e.data.type),e.data.type=s.type,s.layers&&Array.isArray(s.layers)&&(s.layers=s.layers.slice(0)),s.color&&Array.isArray(s.color)&&(s.color=new en(s.color[0],s.color[1],s.color[2])),s.cookieOffset&&s.cookieOffset instanceof Array&&(s.cookieOffset=new ef(s.cookieOffset[0],s.cookieOffset[1])),s.cookieScale&&s.cookieScale instanceof Array&&(s.cookieScale=new ef(s.cookieScale[0],s.cookieScale[1])),s.enable&&(s.enabled=s.enable),s.shape||(s.shape=0);let i=new hr(this.app.graphicsDevice,this.app.scene.clusteredLightingEnabled);i.type=he[s.type],i._node=e.entity,e.data.light=i,super.initializeComponentData(e,s,_8);}_onRemoveComponent(e,t){t.onRemove();}cloneComponent(e,t){let s;let i=e.light,n=[];for(let e=0;e<_8.length;e++)"light"!==(s=_8[e])&&(i[s]&&i[s].clone?n[s]=i[s].clone():n[s]=i[s]);return this.addComponent(t,n)}changeType(e,t,s){t!==s&&(e.light.type=he[s]);}constructor(e){super(e),this.id="light",this.ComponentType=_9,this.DataType=_6,this.on("beforeremove",this._onRemoveComponent,this);}}let gt=["x","y","z","w"],gs=[void 0,void 0,ef,eu,em];function gi(e,t,s,i){switch(t.type){case "boolean":return !!s;case "number":if("number"==typeof s)break;if("string"==typeof s){let e=parseInt(s,10);if(isNaN(e))return null;return e}if("boolean"==typeof s)return 0+s;return null;case "json":{let i={};if(Array.isArray(t.schema)){s&&"object"==typeof s||(s={});for(let n=0;n<t.schema.length;n++){let r=t.schema[n];if(r.name){if(r.array){i[r.name]=[];let t=Array.isArray(s[r.name])?s[r.name]:[];for(let s=0;s<t.length;s++)i[r.name].push(gi(e,r,t[s]));}else {let t=s.hasOwnProperty(r.name)?s[r.name]:r.default;i[r.name]=gi(e,r,t);}}}}return i}case "asset":if(s instanceof ub)break;if("number"==typeof s)return e.assets.get(s)||null;if("string"==typeof s)return e.assets.get(parseInt(s,10))||null;return null;case "entity":if(s instanceof oE)break;if("string"==typeof s)return e.getEntityFromIndex(s);return null;case "rgb":case "rgba":if(s instanceof en){if(i instanceof en)return i.copy(s),i;return s.clone()}if(s instanceof Array&&s.length>=3&&s.length<=4){for(let e=0;e<s.length;e++)if("number"!=typeof s[e])return null;return i||(i=new en),i.r=s[0],i.g=s[1],i.b=s[2],i.a=3===s.length?1:s[3],i}if("string"==typeof s&&/#(?:[0-9a-f]{2}){3,4}/i.test(s))return i||(i=new en),i.fromString(s),i;return null;case "vec2":case "vec3":case "vec4":{let e=parseInt(t.type.slice(3),10),n=gs[e];if(s instanceof n){if(i instanceof n)return i.copy(s),i;return s.clone()}if(s instanceof Array&&s.length===e){for(let e=0;e<s.length;e++)if("number"!=typeof s[e])return null;i||(i=new n);for(let t=0;t<e;t++)i[gt[t]]=s[t];return i}return null}case "curve":if(s){let e;return s instanceof ea||s instanceof eo?e=s.clone():(e=new(s.keys[0]instanceof Array?eo:ea)(s.keys)).type=s.type,e}}return s}function gn(e,t,s,i){return t.array?s.map((s,n)=>gi(e,t,s,i?i[n]:null)):gi(e,t,s,i)}function gr(e,t,s,i){if(s)for(let n in t){let r=t[n],a=s[n];void 0!==a&&(i[n]=gn(e,r,a,i[n]));}}class ga{add(e,t){if(!this.index[e])!ga.reservedNames.has(e)&&(this.index[e]=t,Object.defineProperty(this.scriptType.prototype,e,{get:function(){return this.__attributes[e]},set:function(s){let i="attr",n="attr:"+e,r=this.__attributes[e],a=r;if(r&&"json"!==t.type&&"entity"!==t.type&&r.clone&&(this.hasEvent(i)||this.hasEvent(n))&&(a=r.clone()),t.array){if(this.__attributes[e]=[],s)for(let i=0,n=s.length;i<n;i++)this.__attributes[e].push(gi(this.app,t,s[i],r?r[i]:null));}else this.__attributes[e]=gi(this.app,t,s,r);this.fire(i,e,this.__attributes[e],a),this.fire(n,this.__attributes[e],a);}}));}remove(e){return !!this.index[e]&&(delete this.index[e],delete this.scriptType.prototype[e],true)}has(e){return !!this.index[e]}get(e){return this.index[e]||null}constructor(e){this.scriptType=e,this.index={};}}ga.assignAttributesToScript=gr,ga.attributeToValue=gn,ga.reservedNames=new Set(["app","entity","enabled","_enabled","_enabledOld","_destroyed","__attributes","__attributesRaw","__scriptType","__executionOrder","_callbacks","_callbackActive","has","get","on","off","fire","once","hasEvent"]);let go="initialize",gl="postInitialize";class gh extends Y{set enabled(e){this._enabled=!!e,this.enabled!==this._enabledOld&&(this._enabledOld=this.enabled,this.fire(this.enabled?"enable":"disable"),this.fire("state",this.enabled),!this._initialized&&this.enabled&&(this._initialized=true,this.fire("preInitialize"),this.initialize&&this.entity.script._scriptMethod(this,go)),this._initialized&&!this._postInitialized&&this.enabled&&!this.entity.script._beingEnabled&&(this._postInitialized=true,this.postInitialize&&this.entity.script._scriptMethod(this,gl)));}get enabled(){return this._enabled&&!this._destroyed&&this.entity.script.enabled&&this.entity.enabled}initScript(e){let t=this.constructor;this.app=e.app,this.entity=e.entity,this._enabled="boolean"!=typeof e.enabled||e.enabled,this._enabledOld=this.enabled,this.__destroyed=false,this.__scriptType=t,this.__executionOrder=-1;}static get scriptName(){return this.__name}constructor(e){super(),this.initScript(e);}}gh.EVENT_ENABLE="enable",gh.EVENT_DISABLE="disable",gh.EVENT_STATE="state",gh.EVENT_DESTROY="destroy",gh.EVENT_ATTR="attr",gh.EVENT_ERROR="error",gh.__name=null,gh.__getScriptName=gc;let gd=/^\s*function(?:\s|\s*\/\*.*\*\/\s*)+([^(\s\/]*)\s*/;function gc(e){if("function"!=typeof e)return;if("name"in Function.prototype)return e.name;if(e===Function||e===Function.prototype.constructor)return "Function";let t=(""+e).match(gd);return t?t[1]:void 0}class gu extends gh{static get attributes(){return this.hasOwnProperty("__attributes")||(this.__attributes=new ga(this)),this.__attributes}initScript(e){gh.prototype.initScript.call(this,e),this.__attributes={},this.__attributesRaw=e.attributes||{};}initScriptType(e){this.initScript(e);}__initializeAttributes(e){if(e||this.__attributesRaw){for(let e in this.__scriptType.attributes.index)this.__attributesRaw&&this.__attributesRaw.hasOwnProperty(e)?this[e]=this.__attributesRaw[e]:this.__attributes.hasOwnProperty(e)||(this.__scriptType.attributes.index[e].hasOwnProperty("default")?this[e]=this.__scriptType.attributes.index[e].default:this[e]=null);this.__attributesRaw=null;}}static extend(e){for(let t in e)e.hasOwnProperty(t)&&(this.prototype[t]=e[t]);}constructor(e){super(e),this.initScriptType(e);}}let gp=e=>e[0].toLowerCase()+e.substring(1);class gf extends u8{set scripts(e){for(let t in this._scriptsData=e,e){if(!e.hasOwnProperty(t))continue;let s=this._scriptsIndex[t];if(s&&("boolean"==typeof e[t].enabled&&(s.once("preInitialize",()=>{this.initializeAttributes(s);}),s.enabled=!!e[t].enabled),"object"==typeof e[t].attributes)){for(let i in e[t].attributes)if(!ga.reservedNames.has(i)){if(!s.__attributes.hasOwnProperty(i)){let e=this.system.app.scripts.get(t);e&&e.attributes.add(i,{});}s[i]=e[t].attributes[i];}}}}get scripts(){return this._scripts}set enabled(e){let t=this._enabled;this._enabled=e,this.fire("set","enabled",t,e);}get enabled(){return this._enabled}onEnable(){this._beingEnabled=true,this._checkState(),this.entity._beingEnabled||this.onPostStateChange(),this._beingEnabled=false;}onDisable(){this._checkState();}onPostStateChange(){let e=this._beginLooping();for(let e=0,t=this.scripts.length;e<t;e++){let t=this.scripts[e];t._initialized&&!t._postInitialized&&t.enabled&&(t._postInitialized=true,t.postInitialize&&this._scriptMethod(t,gl));}this._endLooping(e);}_beginLooping(){let e=this._isLoopingThroughScripts;return this._isLoopingThroughScripts=true,e}_endLooping(e){this._isLoopingThroughScripts=e,this._isLoopingThroughScripts||this._removeDestroyedScripts();}_onSetEnabled(e,t,s){this._beingEnabled=true,this._checkState(),this._beingEnabled=false;}_checkState(){let e=this.enabled&&this.entity.enabled;if(e===this._oldState)return;this._oldState=e,this.fire(e?"enable":"disable"),this.fire("state",e),e?this.system._addComponentToEnabled(this):this.system._removeComponentFromEnabled(this);let t=this._beginLooping();for(let e=0,t=this.scripts.length;e<t;e++){let t=this.scripts[e];t.once("preInitialize",()=>{this.initializeAttributes(t);}),t.enabled=t._enabled;}this._endLooping(t);}_onBeforeRemove(){this.fire("remove");let e=this._beginLooping();for(let e=0;e<this.scripts.length;e++){let t=this.scripts[e];t&&this.destroy(t.__scriptType.__name);}this._endLooping(e);}_removeDestroyedScripts(){let e=this._destroyedScripts.length;if(e){for(let t=0;t<e;t++){let e=this._destroyedScripts[t];this._removeScriptInstance(e);}this._destroyedScripts.length=0,this._resetExecutionOrder(0,this._scripts.length);}}_onInitializeAttributes(){for(let e=0,t=this.scripts.length;e<t;e++){let t=this.scripts[e];this.initializeAttributes(t);}}initializeAttributes(e){if(e instanceof gu)e.__initializeAttributes();else {var t;let s=e.__scriptType.__name,i=this._attributeDataMap.get(s);if(!i)return;let n=null==(t=this.system.app.scripts)?void 0:t.getSchema(s);gr(this.system.app,n.attributes,i,e);}}_scriptMethod(e,t,s){e[t](s);}_onInitialize(){let e=this._scripts,t=this._beginLooping();for(let t=0,s=e.length;t<s;t++){let s=e[t];!s._initialized&&s.enabled&&(s._initialized=true,s.initialize&&this._scriptMethod(s,go));}this._endLooping(t);}_onPostInitialize(){this.onPostStateChange();}_onUpdate(e){let t=this._updateList;if(!t.length)return;let s=this._beginLooping();for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++){let s=t.items[t.loopIndex];s.enabled&&this._scriptMethod(s,"update",e);}this._endLooping(s);}_onPostUpdate(e){let t=this._postUpdateList;if(!t.length)return;let s=this._beginLooping();for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++){let s=t.items[t.loopIndex];s.enabled&&this._scriptMethod(s,"postUpdate",e);}this._endLooping(s);}_insertScriptInstance(e,t,s){ -1===t?(this._scripts.push(e),e.__executionOrder=s,e.update&&this._updateList.append(e),e.postUpdate&&this._postUpdateList.append(e)):(this._scripts.splice(t,0,e),e.__executionOrder=t,this._resetExecutionOrder(t+1,s+1),e.update&&this._updateList.insert(e),e.postUpdate&&this._postUpdateList.insert(e));}_removeScriptInstance(e){let t=this._scripts.indexOf(e);return -1===t||(this._scripts.splice(t,1),e.update&&this._updateList.remove(e),e.postUpdate&&this._postUpdateList.remove(e)),t}_resetExecutionOrder(e,t){for(let s=e;s<t;s++)this._scripts[s].__executionOrder=s;}_resolveEntityScriptAttribute(e,t,s,i,n,r){if(e.array){let e=s.length;if(!e)return;let a=s.slice();for(let t=0;t<e;t++){let e=a[t]instanceof uG?a[t].getGuid():a[t];r[e]&&(a[t]=i?r[e].getGuid():r[e]);}n[t]=a;}else {if(s instanceof uG)s=s.getGuid();else if("string"!=typeof s)return;r[s]&&(n[t]=r[s]);}}has(e){if("string"==typeof e)return !!this._scriptsIndex[e];if(!e)return  false;let t=e.__name,s=this._scriptsIndex[t];return (s&&s.instance)instanceof e}get(e){if("string"==typeof e){let t=this._scriptsIndex[e];return t?t.instance:null}if(!e)return null;let t=e.__name,s=this._scriptsIndex[t],i=s&&s.instance;return i instanceof e?i:null}create(e,t){ void 0===t&&(t={});let s=this,i=e,n=e;if("string"==typeof i)i=this.system.app.scripts.get(i);else if(i){var r,a;n=null!=(a=(r=i).__name)?a:r.__name=gp(gc(i));}if(i){if(!this._scriptsIndex[n]||!this._scriptsIndex[n].instance){let e=new i({app:this.system.app,entity:this.entity,enabled:!t.hasOwnProperty("enabled")||t.enabled,attributes:t.attributes||{}});t.properties&&"object"==typeof t.properties&&Object.assign(e,t.properties),e instanceof gu||this._attributeDataMap.set(n,t.attributes);let r=this._scripts.length,a=-1;return "number"==typeof t.ind&&-1!==t.ind&&r>t.ind&&(a=t.ind),this._insertScriptInstance(e,a,r),this._scriptsIndex[n]={instance:e,onSwap:function(){s.swap(n);}},this[n]=e,t.preloading||this.initializeAttributes(e),this.fire("create",n,e),this.fire("create:"+n,e),this.system.app.scripts.on("swap:"+n,this._scriptsIndex[n].onSwap),!t.preloading&&(e.enabled&&!e._initialized&&(e._initialized=true,e.initialize&&this._scriptMethod(e,go)),e.enabled&&!e._postInitialized&&(e._postInitialized=true,e.postInitialize&&this._scriptMethod(e,gl))),e}}else this._scriptsIndex[n]={awaiting:true,ind:this._scripts.length};return null}destroy(e){let t=e,s=e;"string"==typeof s?s=this.system.app.scripts.get(s):s&&(t=s.__name);let i=this._scriptsIndex[t];if(delete this._scriptsIndex[t],!i)return  false;this._attributeDataMap.delete(t);let n=i.instance;if(n&&!n._destroyed){if(n.enabled=false,n._destroyed=true,this._isLoopingThroughScripts)this._destroyedScripts.push(n);else {let e=this._removeScriptInstance(n);e>=0&&this._resetExecutionOrder(e,this._scripts.length);}}return this.system.app.scripts.off("swap:"+t,i.onSwap),delete this[t],this.fire("destroy",t,n||null),this.fire("destroy:"+t,n||null),n&&n.fire("destroy"),true}swap(e){let t=e,s=e;"string"==typeof s?s=this.system.app.scripts.get(s):s&&(t=s.__name);let i=this._scriptsIndex[t];if(!i||!i.instance)return  false;let n=i.instance,r=this._scripts.indexOf(n),a=new s({app:this.system.app,entity:this.entity,enabled:n.enabled,attributes:n.__attributes});return !!a.swap&&(this.initializeAttributes(a),this._scripts[r]=a,this._scriptsIndex[t].instance=a,this[t]=a,a.__executionOrder=r,n.update&&this._updateList.remove(n),n.postUpdate&&this._postUpdateList.remove(n),a.update&&this._updateList.insert(a),a.postUpdate&&this._postUpdateList.insert(a),this._scriptMethod(a,"swap",n),this.fire("swap",t,a),this.fire("swap:"+t,a),true)}resolveDuplicatedEntityReferenceProperties(e,t){let s=this.entity.script;for(let i in e._scriptsIndex){let n=this.system.app.scripts.get(i);if(!n)continue;let r=e._scriptsIndex[i];if(!r||!r.instance)continue;let a=s[i].__attributesRaw,o=s[i].__attributes;if(!a&&!o)continue;let l=!!a,h=r.instance.__attributes;for(let e in h){if(!h[e])continue;let s=n.attributes.get(e);if(s){if("entity"===s.type)this._resolveEntityScriptAttribute(s,e,h[e],l,a||o,t);else if("json"===s.type&&Array.isArray(s.schema)){let i=h[e],n=a?a[e]:o[e];for(let e=0;e<s.schema.length;e++){let r=s.schema[e];if("entity"===r.type){if(s.array)for(let e=0;e<i.length;e++)this._resolveEntityScriptAttribute(r,r.name,i[e][r.name],l,n[e],t);else this._resolveEntityScriptAttribute(r,r.name,i[r.name],l,n,t);}}}}}}}move(e,t){let s=this._scripts.length;if(t>=s||t<0)return  false;let i=e,n=e;"string"!=typeof n?n=e.__name:i=null;let r=this._scriptsIndex[n];if(!r||!r.instance)return  false;let a=r.instance;if(i&&!(a instanceof i))return  false;let o=this._scripts.indexOf(a);return -1!==o&&o!==t&&(this._scripts.splice(t,0,this._scripts.splice(o,1)[0]),this._resetExecutionOrder(0,s),this._updateList.sort(),this._postUpdateList.sort(),this.fire("move",n,a,t,o),this.fire("move:"+n,a,t,o),true)}constructor(e,t){super(e,t),this._attributeDataMap=new Map,this._scripts=[],this._updateList=new Q({sortBy:"__executionOrder"}),this._postUpdateList=new Q({sortBy:"__executionOrder"}),this._scriptsIndex={},this._destroyedScripts=[],this._destroyed=false,this._scriptsData=null,this._oldState=true,this._enabled=true,this._beingEnabled=false,this._isLoopingThroughScripts=false,this._executionOrder=-1,this.on("set_enabled",this._onSetEnabled,this);}}gf.EVENT_CREATE="create",gf.EVENT_DESTROY="destroy",gf.EVENT_ENABLE="enable",gf.EVENT_DISABLE="disable",gf.EVENT_REMOVE="remove",gf.EVENT_STATE="state",gf.EVENT_MOVE="move",gf.EVENT_ERROR="error";class gm{constructor(){this.enabled=true;}}let g_=0;class gg extends u9{initializeComponentData(e,t){if(e._executionOrder=g_++,this._components.append(e),g_>Number.MAX_SAFE_INTEGER&&this._resetExecutionOrder(),e.enabled=!t.hasOwnProperty("enabled")||!!t.enabled,e.enabled&&e.entity.enabled&&this._enabledComponents.append(e),t.hasOwnProperty("order")&&t.hasOwnProperty("scripts")){e._scriptsData=t.scripts;for(let s=0;s<t.order.length;s++)e.create(t.order[s],{enabled:t.scripts[t.order[s]].enabled,attributes:t.scripts[t.order[s]].attributes,preloading:this.preloading});}}cloneComponent(e,t){let s=[],i={};for(let t=0;t<e.script._scripts.length;t++){var n;let r=e.script._scripts[t],a=r.__scriptType.__name;s.push(a);let o=(null==(n=e.script._attributeDataMap)?void 0:n.get(a))||{};for(let e in r.__attributes)o[e]=r.__attributes[e];i[a]={enabled:r._enabled,attributes:o};}for(let t in e.script._scriptsIndex)t.awaiting&&s.splice(t.ind,0,t);let r={enabled:e.script.enabled,order:s,scripts:i};return this.addComponent(t,r)}_resetExecutionOrder(){g_=0;for(let e=0,t=this._components.length;e<t;e++)this._components.items[e]._executionOrder=g_++;}_callComponentMethod(e,t,s){for(e.loopIndex=0;e.loopIndex<e.length;e.loopIndex++)e.items[e.loopIndex][t](s);}_onInitialize(){this.preloading=false,this._callComponentMethod(this._components,"_onInitializeAttributes"),this._callComponentMethod(this._enabledComponents,"_onInitialize");}_onPostInitialize(){this._callComponentMethod(this._enabledComponents,"_onPostInitialize");}_onUpdate(e){this._callComponentMethod(this._enabledComponents,"_onUpdate",e);}_onPostUpdate(e){this._callComponentMethod(this._enabledComponents,"_onPostUpdate",e);}_addComponentToEnabled(e){this._enabledComponents.insert(e);}_removeComponentFromEnabled(e){this._enabledComponents.remove(e);}_onBeforeRemove(e,t){this._components.items.indexOf(t)>=0&&t._onBeforeRemove(),this._removeComponentFromEnabled(t),this._components.remove(t);}destroy(){super.destroy(),this.app.systems.off("initialize",this._onInitialize,this),this.app.systems.off("postInitialize",this._onPostInitialize,this),this.app.systems.off("update",this._onUpdate,this),this.app.systems.off("postUpdate",this._onPostUpdate,this);}constructor(e){super(e),this.id="script",this.ComponentType=gf,this.DataType=gm,this._components=new Q({sortBy:"_executionOrder"}),this._enabledComponents=new Q({sortBy:"_executionOrder"}),this.preloading=true,this.on("beforeremove",this._onBeforeRemove,this),this.app.systems.on("initialize",this._onInitialize,this),this.app.systems.on("postInitialize",this._onPostInitialize,this),this.app.systems.on("update",this._onUpdate,this),this.app.systems.on("postUpdate",this._onPostUpdate,this);}}class gv extends u8{set customAabb(e){var t,s;this._customAabb=e,null==(s=this._instance)||null==(t=s.meshInstance)||t.setCustomAabb(this._customAabb);}get customAabb(){return this._customAabb}set instance(e){var t;if(this.destroyInstance(),this._instance=e,null==(t=this._instance)?void 0:t.meshInstance){let e=this._instance.meshInstance;e.node||(e.node=this.entity),e.castShadow=this._castShadows,e.setCustomAabb(this._customAabb),this._materialOptions&&this._instance.createMaterial(this._materialOptions),this.enabled&&this.entity.enabled&&this.addToLayers();}}get instance(){return this._instance}set materialOptions(e){this._materialOptions=Object.assign({},e),this._instance&&this._instance.createMaterial(this._materialOptions);}get materialOptions(){return this._materialOptions}get material(){var e;return null==(e=this._instance)?void 0:e.material}set castShadows(e){if(this._castShadows!==e){var t;let s=null==(t=this.instance)?void 0:t.meshInstance;if(s){let t=this.layers,i=this.system.app.scene;if(this._castShadows&&!e)for(let e=0;e<t.length;e++){let t=i.layers.getLayerById(this.layers[e]);t&&t.removeShadowCasters([s]);}if(s.castShadow=e,!this._castShadows&&e)for(let e=0;e<t.length;e++){let n=i.layers.getLayerById(t[e]);n&&n.addShadowCasters([s]);}}this._castShadows=e;}}get castShadows(){return this._castShadows}set layers(e){this.removeFromLayers(),this._layers.length=0;for(let t=0;t<e.length;t++)this._layers[t]=e[t];this.enabled&&this.entity.enabled&&this.addToLayers();}get layers(){return this._layers}set asset(e){let t=e instanceof ub?e.id:e;this._assetReference.id!==t&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onGSplatAssetRemove(),this._assetReference.id=t,this._assetReference.asset&&this._onGSplatAssetAdded());}get asset(){return this._assetReference.id}assignAsset(e){let t=e instanceof ub?e.id:e;this._assetReference.id=t;}destroyInstance(){if(this._instance){var e;this.removeFromLayers(),null==(e=this._instance)||e.destroy(),this._instance=null;}}addToLayers(){var e,t;let s=null==(e=this.instance)?void 0:e.meshInstance;if(s){let e=this.system.app.scene.layers;for(let i=0;i<this._layers.length;i++)null==(t=e.getLayerById(this._layers[i]))||t.addMeshInstances([s]);}}removeFromLayers(){var e,t;let s=null==(e=this.instance)?void 0:e.meshInstance;if(s){let e=this.system.app.scene.layers;for(let i=0;i<this._layers.length;i++)null==(t=e.getLayerById(this._layers[i]))||t.removeMeshInstances([s]);}}onRemoveChild(){this.removeFromLayers();}onInsertChild(){this._instance&&this.enabled&&this.entity.enabled&&this.addToLayers();}onRemove(){this.destroyInstance(),this.asset=null,this._assetReference.id=null,this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this);}onLayersChanged(e,t){this.addToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this);}onLayerAdded(e){!(0>this.layers.indexOf(e.id))&&this._instance&&e.addMeshInstances(this._instance.meshInstance);}onLayerRemoved(e){!(0>this.layers.indexOf(e.id))&&this._instance&&e.removeMeshInstances(this._instance.meshInstance);}onEnable(){let e=this.system.app.scene,t=e.layers;this._evtLayersChanged=e.on("set:layers",this.onLayersChanged,this),t&&(this._evtLayerAdded=t.on("add",this.onLayerAdded,this),this._evtLayerRemoved=t.on("remove",this.onLayerRemoved,this)),this._instance?this.addToLayers():this.asset&&this._onGSplatAssetAdded();}onDisable(){var e,t,s;let i=this.system.app.scene.layers;null==(e=this._evtLayersChanged)||e.off(),this._evtLayersChanged=null,i&&(null==(t=this._evtLayerAdded)||t.off(),this._evtLayerAdded=null,null==(s=this._evtLayerRemoved)||s.off(),this._evtLayerRemoved=null),this.removeFromLayers();}hide(){this._instance&&(this._instance.meshInstance.visible=false);}show(){this._instance&&(this._instance.meshInstance.visible=true);}_onGSplatAssetAdded(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onGSplatAssetLoad():this.enabled&&this.entity.enabled&&this.system.app.assets.load(this._assetReference.asset));}_onGSplatAssetLoad(){this.destroyInstance();let e=this._assetReference.asset;e&&(this.instance=e.resource.createInstance());}_onGSplatAssetUnload(){this.destroyInstance();}_onGSplatAssetRemove(){this._onGSplatAssetUnload();}constructor(e,t){super(e,t),this._layers=[0],this._instance=null,this._customAabb=null,this._materialOptions=null,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._castShadows=false,this._assetReference=new m0("asset",this,e.app.assets,{add:this._onGSplatAssetAdded,load:this._onGSplatAssetLoad,remove:this._onGSplatAssetRemove,unload:this._onGSplatAssetUnload},this),t.on("remove",this.onRemoveChild,this),t.on("removehierarchy",this.onRemoveChild,this),t.on("insert",this.onInsertChild,this),t.on("inserthierarchy",this.onInsertChild,this);}}class gy{constructor(){this.enabled=true;}}let gS=["enabled"],gx=["castShadows","instance","asset","layers"];class gT extends u9{initializeComponentData(e,t,s){t.layers&&t.layers.length&&(t.layers=t.layers.slice(0));for(let s=0;s<gx.length;s++)t.hasOwnProperty(gx[s])&&(e[gx[s]]=t[gx[s]]);t.aabbCenter&&t.aabbHalfExtents&&(e.customAabb=new eP(new eu(t.aabbCenter),new eu(t.aabbHalfExtents))),super.initializeComponentData(e,t,gS);}cloneComponent(e,t){let s=e.gsplat,i={};for(let e=0;e<gx.length;e++)i[gx[e]]=s[gx[e]];i.enabled=s.enabled,delete i.instance;let n=this.addComponent(t,i);return s.instance&&(n.instance=s.instance.clone()),s.customAabb&&(n.customAabb=s.customAabb.clone()),n}onRemove(e,t){t.onRemove();}constructor(e){super(e),this.id="gsplat",this.ComponentType=gv,this.DataType=gy,this.schema=gS,this.on("beforeremove",this.onRemove,this);}}u8._buildAccessors(gv.prototype,gS);class gb extends Y{set meshes(e){this.decRefMeshes(),this._meshes=e,this.incRefMeshes(),this.fire("set:meshes",e);}get meshes(){return this._meshes}destroy(){this.meshes=null;}decRefMeshes(){var e;null==(e=this._meshes)||e.forEach((e,t)=>{e&&(e.decRefCount(),e.refCount<1&&(e.destroy(),this._meshes[t]=null));});}incRefMeshes(){var e;null==(e=this._meshes)||e.forEach(e=>{null==e||e.incRefCount();});}constructor(...e){super(...e),this._meshes=null;}}function gE(e){if(!this.resource)return;let t=e.resource,s=t.renders&&t.renders[this.data.renderIndex];s&&(this.resource.meshes=s.resource.meshes);}function gA(e){this.registry.off("load:"+e.id,gE,this),this.registry.on("load:"+e.id,gE,this),this.registry.off("remove:"+e.id,gw,this),this.registry.once("remove:"+e.id,gw,this),e.resource?gE.call(this,e):this.registry.load(e);}function gw(e){this.registry.off("load:"+e.id,gE,this),this.resource&&this.resource.destroy();}gb.EVENT_SETMESHES="set:meshes";class gC extends uI{open(e,t){return new gb}patch(e,t){if(!e.data.containerAsset)return;let s=t.get(e.data.containerAsset);if(!s){t.once("add:"+e.data.containerAsset,gA,e);return}gA.call(e,s);}constructor(e){super(e,"render"),this._registry=e.assets;}}class gP{get paths(){return this._paths}get input(){return this._input}get output(){return this._output}get interpolation(){return this._interpolation}constructor(e,t,s,i){this._paths=e,this._input=t,this._output=s,this._interpolation=i;}}class gM{get components(){return this._components}get data(){return this._data}constructor(e,t){this._components=e,this._data=t;}}function gI(e,t){let s;let i=(e,t)=>{switch(t){case s.DT_INT8:return new Int8Array(e.buffer,e.byteOffset,e.byteLength);case s.DT_INT16:return new Int16Array(e.buffer,e.byteOffset,e.byteLength/2);case s.DT_INT32:return new Int32Array(e.buffer,e.byteOffset,e.byteLength/4);case s.DT_UINT8:return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);case s.DT_UINT16:return new Uint16Array(e.buffer,e.byteOffset,e.byteLength/2);case s.DT_UINT32:return new Uint32Array(e.buffer,e.byteOffset,e.byteLength/4);case s.DT_FLOAT32:return new Float32Array(e.buffer,e.byteOffset,e.byteLength/4)}return null},n=e=>{switch(e){case s.DT_INT8:break;case s.DT_INT16:return 2;case s.DT_INT32:return 4;case s.DT_UINT8:break;case s.DT_UINT16:return 2;case s.DT_UINT32:case s.DT_FLOAT32:return 4}return 1},r=e=>e.num_components()*n(e.data_type()),a={0:0,1:1,5:2,2:3,7:4,8:5,4:6,3:7},o=(e,t)=>{let s=(e,t,s)=>{e[0]=t[0]-s[0],e[1]=t[1]-s[1],e[2]=t[2]-s[2];},i=(e,t,s)=>{e[0]=t[1]*s[2]-s[1]*t[2],e[1]=t[2]*s[0]-s[2]*t[0],e[2]=t[0]*s[1]-s[0]*t[1];},n=(e,t)=>{let s=e[t+0],i=e[t+1],n=e[t+2],r=1/Math.sqrt(s*s+i*i+n*n);e[t+0]*=r,e[t+1]*=r,e[t+2]*=r;},r=(e,t,s)=>{for(let i=0;i<3;++i)e[i]=t[s+i];},a=t.length/3,o=e.length/3,l=new Float32Array(e.length),h=[0,0,0],d=[0,0,0],c=[0,0,0],u=[0,0,0],p=[0,0,0],f=[0,0,0];for(let o=0;o<a;++o){let a=3*t[3*o+0],m=3*t[3*o+1],_=3*t[3*o+2];r(h,e,a),r(d,e,m),r(c,e,_),s(u,d,h),s(p,c,h),i(f,u,p),n(f,0);for(let e=0;e<3;++e)l[a+e]+=f[e],l[m+e]+=f[e],l[_+e]+=f[e];}for(let e=0;e<o;++e)n(l,3*e);return new Uint8Array(l.buffer)},l=e=>{let t={},n=new s.DecoderBuffer;n.Init(e,e.length);let l=new s.Decoder;if(l.GetEncodedGeometryType(n)!==s.TRIANGULAR_MESH)return t.error="Failed to decode draco mesh: not a mesh",t;let h=new s.Mesh,d=l.DecodeBufferToMesh(n,h);if(!d||!d.ok()||0===s.getPointer(h))return t.error="Failed to decode draco asset",t;let c=3*h.num_faces(),u=65535>=h.num_points(),p=c*(u?2:4),f=s._malloc(p);u?(l.GetTrianglesUInt16Array(h,p,f),t.indices=new Uint16Array(s.HEAPU16.buffer,f,c).slice().buffer):(l.GetTrianglesUInt32Array(h,p,f),t.indices=new Uint32Array(s.HEAPU32.buffer,f,c).slice().buffer),s._free(f);let m=[];for(let e=0;e<h.num_attributes();++e)m.push(l.GetAttribute(h,e));m.sort((e,t)=>{var s,i;return (null!=(s=a[e.attribute_type()])?s:a.length)-(null!=(i=a[t.attribute_type()])?i:a.length)}),t.attributes=m.map(e=>e.unique_id());let _=0,g=m.map(e=>{let t=_;return _+=4*Math.ceil(r(e)/4),t}),v=m.some(e=>1===e.attribute_type()),y=g[1];if(!v){for(let e=1;e<g.length;++e)g[e]+=12;_+=12;}t.vertices=new ArrayBuffer(h.num_points()*_);let S=new Uint8Array(t.vertices);for(let e=0;e<h.num_attributes();++e){let n=m[e],a=r(n),d=h.num_points()*a,c=s._malloc(d);l.GetAttributeDataArrayForAllPoints(h,n,n.data_type(),d,c);let p=new Uint8Array(s.HEAPU8.buffer,c,d);for(let t=0;t<h.num_points();++t)for(let s=0;s<a;++s)S[t*_+g[e]+s]=p[t*a+s];if(!v&&0===n.attribute_type()){let e=o(i(p,n.data_type()),u?new Uint16Array(t.indices):new Uint32Array(t.indices));for(let t=0;t<h.num_points();++t)for(let s=0;s<12;++s)S[t*_+y+s]=e[12*t+s];}s._free(c);}return s.destroy(h),s.destroy(l),s.destroy(n),t},h=e=>{let t=l(new Uint8Array(e.buffer));self.postMessage({jobId:e.jobId,error:t.error,indices:t.indices,vertices:t.vertices,attributes:t.attributes},[t.indices,t.vertices].filter(e=>null!=e));},d=[];self.onmessage=e=>{let t=e.data;switch(t.type){case "init":self.DracoDecoderModule({instantiateWasm:(e,s)=>(WebAssembly.instantiate(t.module,e).then(e=>s(e)).catch(e=>void 0),{})}).then(e=>{s=e,d.forEach(e=>h(e));});break;case "decodeMesh":s?h(t):d.push(t);}};}class gR{init(e){for(e.forEach(e=>{e.addEventListener("message",t=>{let s=t.data,i=this.jobCallbacks.get(s.jobId);if(i&&i(s.error,{indices:s.indices,vertices:s.vertices,attributes:s.attributes}),this.jobCallbacks.delete(s.jobId),this.jobQueue.length>0){let t=this.jobQueue.shift();this.run(e,t);}else {let t=this.workers[2].indexOf(e);if(-1!==t)this.workers[2].splice(t,1),this.workers[1].push(e);else {let t=this.workers[1].indexOf(e);-1!==t&&(this.workers[1].splice(t,1),this.workers[0].push(e));}}});}),this.workers[0]=e;this.jobQueue.length&&(this.workers[0].length||this.workers[1].length);){let e=this.jobQueue.shift();if(this.workers[0].length>0){let t=this.workers[0].shift();this.workers[1].push(t),this.run(t,e);}else {let t=this.workers[1].shift();this.workers[2].push(t),this.run(t,e);}}}enqueueJob(e,t){let s={jobId:this.jobId++,buffer:e};if(this.jobCallbacks.set(s.jobId,t),this.workers[0].length>0){let e=this.workers[0].shift();this.workers[1].push(e),this.run(e,s);}else if(this.workers[1].length>0){let e=this.workers[1].shift();this.workers[2].push(e),this.run(e,s);}else this.jobQueue.push(s);}constructor(){this.workers=[[],[],[]],this.jobId=0,this.jobQueue=[],this.jobCallbacks=new Map,this.run=(e,t)=>{e.postMessage({type:"decodeMesh",jobId:t.jobId,buffer:t.buffer},[t.buffer]);};}}let gL=e=>new Promise((t,s)=>{rR.get(e,{cache:true,responseType:"text",retry:true,maxRetries:3},(e,i)=>{e?s(e):t(i);});}),gD=e=>{let t=()=>fetch(e).then(e=>e.arrayBuffer()).then(e=>WebAssembly.compile(e));return WebAssembly.compileStreaming?WebAssembly.compileStreaming(fetch(e)).catch(e=>t()):t()},gO=e=>{if(m)return  true;if(!e){if(_)e=_;else {let t=K.getConfig("DracoDecoderModule");e=t?{jsUrl:t.glueUrl,wasmUrl:t.wasmUrl,numWorkers:t.numWorkers}:{jsUrl:"draco.wasm.js",wasmUrl:"draco.wasm.wasm",numWorkers:1};}}return !!e.jsUrl&&!!e.wasmUrl&&(m=new gR,Promise.all([gL(e.jsUrl),gD(e.wasmUrl)]).then(t=>{let[s,i]=t,n=new Blob([["/* draco */",s,"/* worker */","(\n"+gI.toString()+"\n)()\n\n"].join("\n")],{type:"application/javascript"}),r=URL.createObjectURL(n),a=Math.max(1,Math.min(16,e.numWorkers||1)),o=[];for(let e=0;e<a;++e){let e=new Worker(r);e.postMessage({type:"init",module:i}),o.push(e);}m.init(o);}),true)},gF=(e,t)=>!!gO()&&(m.enqueueJob(e,t),true);class gN{destroy(){this.renders&&this.renders.forEach(e=>{e.meshes=null;});}}let gB=e=>/^data:[^\n\r,\u2028\u2029]*,.*$/i.test(e),gU=e=>e.substring(e.indexOf(":")+1,e.indexOf(";")),gk=e=>{switch(e){case "SCALAR":return 1;case "VEC2":return 2;case "VEC3":default:return 3;case "VEC4":case "MAT2":return 4;case "MAT3":return 9;case "MAT4":return 16}},gz=e=>{switch(e){case 5120:default:return 0;case 5121:return 1;case 5122:return 2;case 5123:return 3;case 5124:return 4;case 5125:return 5;case 5126:return 6}},gV=e=>{switch(e){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4;default:return 0}},gG=e=>{switch(e){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:return null}},gH={POSITION:e2,NORMAL:e3,TANGENT:e4,COLOR_0:e8,JOINTS_0:e6,WEIGHTS_0:e5,TEXCOORD_0:e7,TEXCOORD_1:te,TEXCOORD_2:tt,TEXCOORD_3:ts,TEXCOORD_4:ti,TEXCOORD_5:tn,TEXCOORD_6:tr,TEXCOORD_7:ta},gW={[e2]:0,[e3]:1,[e4]:2,[e8]:3,[e6]:4,[e5]:5,[e7]:6,[te]:7,[tt]:8,[ts]:9,[ti]:10,[tn]:11,[tr]:12,[ta]:13},gX=e=>{switch(e){case 0:return e=>Math.max(e/127,-1);case 1:return e=>e/255;case 2:return e=>Math.max(e/32767,-1);case 3:return e=>e/65535;default:return e=>e}},gY=(e,t,s)=>{let i=gX(s),n=t.length;for(let s=0;s<n;++s)e[s]=i(t[s]);return e},gj=(e,t,s)=>{let i;void 0===s&&(s=false);let n=gk(e.type),r=gG(e.componentType);if(!r)return null;if(e.sparse){let s=e.sparse,a=gj(Object.assign({count:s.count,type:"SCALAR"},s.indices),t,true),o=gj(Object.assign({count:s.count,type:e.type,componentType:e.componentType},s.values),t,true);i=e.hasOwnProperty("bufferView")?gj({bufferView:e.bufferView,byteOffset:e.byteOffset,componentType:e.componentType,count:e.count,type:e.type},t,true).slice():new r(e.count*n);for(let e=0;e<s.count;++e){let t=a[e];for(let s=0;s<n;++s)i[t*n+s]=o[e*n+s];}}else if(e.hasOwnProperty("bufferView")){let a=t[e.bufferView];if(s&&a.hasOwnProperty("byteStride")){let t=n*r.BYTES_PER_ELEMENT,s=new ArrayBuffer(e.count*t),o=new Uint8Array(s),l=0;for(let s=0;s<e.count;++s){let i=(e.byteOffset||0)+s*a.byteStride;for(let e=0;e<t;++e)o[l++]=a[i++];}i=new r(s);}else i=new r(a.buffer,a.byteOffset+(e.byteOffset||0),e.count*n);}else i=new r(e.count*n);return i},gq=(e,t)=>{let s=gj(e,t,true);if(s instanceof Float32Array||!e.normalized)return s;let i=new Float32Array(s.length);return gY(i,s,gz(e.componentType)),i},gK=e=>{let t=e.min,s=e.max;if(!t||!s)return null;if(e.normalized){let i=gz(e.componentType);t=gY([],t,i),s=gY([],s,i);}return new eP(new eu((s[0]+t[0])*.5,(s[1]+t[1])*.5,(s[2]+t[2])*.5),new eu((s[0]-t[0])*.5,(s[1]-t[1])*.5,(s[2]-t[2])*.5))},gZ=e=>{if(!e.hasOwnProperty("mode"))return 4;switch(e.mode){case 0:return 0;case 1:return 1;case 2:return 2;case 3:return 3;case 4:default:return 4;case 5:return 5;case 6:return 6}},gQ=e=>{let t=new Uint16Array(e);for(let s=0;s<e;s++)t[s]=s;return t},gJ=(e,t)=>{let s;let i=e[e2];if(!i||3!==i.components)return;if(i.size!==i.stride){let e=i.stride/tK[i.type],t=new tq[i.type](i.buffer,i.offset,i.count*e);s=new tq[i.type](3*i.count);for(let n=0;n<i.count;++n)s[3*n+0]=t[n*e+0],s[3*n+1]=t[n*e+1],s[3*n+2]=t[n*e+2];}else s=new tq[i.type](i.buffer,i.offset,3*i.count);let n=i.count;t||(t=gQ(n));let r=ds(s,t),a=new Float32Array(r.length);a.set(r),e[e3]={buffer:a.buffer,size:12,offset:0,stride:12,count:n,components:3,type:6};},g$=e=>{let t=new se(e.device,e);return t._levels=(e=>{let t=[];for(let s=0;s<e._levels.length;++s){let i=[];if(e.cubemap)for(let t=0;t<6;++t)i.push(e._levels[s][t]);else i=e._levels[s];t.push(i);}return t})(e),t},g0=e=>{let t=new ub(""+e.name+"_clone",e.type,e.file,e.data,e.options);return t.loaded=true,t.resource=g$(e.resource),e.registry.add(t),t},g1=(e,t)=>{let s,i,n,r,a,o,l;let h=t[e2];if(!h)return null;let d=h.count,c=[];for(let s in t)if(t.hasOwnProperty(s)){let i={semantic:s,components:t[s].components,type:t[s].type,normalize:!!t[s].normalize};!sA.isElementValid(e,i)&&i.components++,c.push(i);}c.sort((e,t)=>gW[e.semantic]-gW[t.semantic]);let u=new sA(e,c),p=true;for(s=0;s<u.elements.length;++s)if(o=(r=t[(a=u.elements[s]).name]).offset-h.offset,r.buffer!==h.buffer||r.stride!==a.stride||r.size!==a.size||o!==a.offset){p=false;break}let f=new sy(e,u,d),m=new Uint32Array(f.lock());if(p)l=new Uint32Array(h.buffer,h.offset,d*f.format.size/4),m.set(l);else {let e,o;for(s=0;s<f.format.elements.length;++s){e=(a=f.format.elements[s]).stride/4,o=(r=t[a.name]).stride/4,l=new Uint32Array(r.buffer,r.offset,(r.count-1)*o+(r.size+3)/4);let h=0,c=a.offset/4,u=Math.floor((r.size+3)/4);for(i=0;i<d;++i){for(n=0;n<u;++n)m[c+n]=l[h+n];h+=o,c+=e;}}}return f.unlock(),f},g2=(e,t,s,i,n,r)=>{let a={},o=[];for(let e in t)t.hasOwnProperty(e)&&gH.hasOwnProperty(e)&&(a[e]=t[e],o.push(e+":"+t[e]));o.sort();let l=o.join(),h=r[l];if(!h){let o={};for(let e in a){let s=i[t[e]],r=gj(s,n),a=n[s.bufferView],l=gH[e],h=gk(s.type)*gV(s.componentType),d=a&&a.hasOwnProperty("byteStride")?a.byteStride:h;o[l]={buffer:r.buffer,size:h,offset:r.byteOffset,stride:d,count:s.count,components:gk(s.type),type:gz(s.componentType),normalize:s.normalized};}o.hasOwnProperty(e3)||gJ(o,s),h=g1(e,o),r[l]=h;}return h},g3=(e,t,s,i,n,r)=>{let a,o,l;let h=t.joints,d=h.length,c=[];if(t.hasOwnProperty("inverseBindMatrices")){let e=gj(s[t.inverseBindMatrices],i,true),n=[];for(a=0;a<d;a++){for(o=0;o<16;o++)n[o]=e[16*a+o];(l=new ex).set(n),c.push(l);}}else for(a=0;a<d;a++)l=new ex,c.push(l);let u=[];for(a=0;a<d;a++)u[a]=n[h[a]].name;let p=u.join("#"),f=r.get(p);return f||(f=new dZ(e,c,u),r.set(p,f)),f},g4=(e,t,s,i,n,r,a)=>{var o,l;let h=new aG(e);h.aabb=gK(s[t.attributes.POSITION]);let d=[];for(let[e,i]of Object.entries(t.attributes)){let t=s[i],n=gH[e],r=gz(t.componentType);d.push({semantic:n,components:gk(t.type),type:r,normalize:null!=(l=t.normalized)?l:n===e8&&(1===r||3===r)});}if(a.push(new Promise((s,n)=>{let r=t.extensions.KHR_draco_mesh_compression;gF(i[r.bufferView].slice().buffer,(i,a)=>{if(i)n(i);else {var o;let i={};for(let[e,t]of Object.entries(r.attributes))i[gH[e]]=a.attributes.indexOf(t);d.sort((e,t)=>i[e.semantic]-i[t.semantic]),(null==(o=t.attributes)?void 0:o.NORMAL)||d.splice(1,0,{semantic:"NORMAL",components:3,type:6});let n=new sA(e,d),l=a.vertices.byteLength/n.size,c=a.indices.byteLength/(l<=65535?2:4),u=new sy(e,n,l,{data:a.vertices}),p=new nY(e,l<=65535?1:2,c,0,a.indices);h.vertexBuffer=u,h.indexBuffer[0]=p,h.primitive[0].type=gZ(t),h.primitive[0].base=0,h.primitive[0].count=p?c:l,h.primitive[0].indexed=!!p,s();}});})),null==t?void 0:null==(o=t.extensions)?void 0:o.KHR_materials_variants){let e=t.extensions.KHR_materials_variants,s={};e.mappings.forEach(e=>{e.variants.forEach(t=>{s[t]=e.material;});}),n[h.id]=s;}return r[h.id]=t.material,h},g5=(e,t,s,i,n,r,a,o,l)=>{let h=[];return t.primitives.forEach(d=>{var c;if(null==(c=d.extensions)?void 0:c.KHR_draco_mesh_compression)h.push(g4(e,d,s,i,r,a,l));else {let l=d.hasOwnProperty("indices")?gj(s[d.indices],i,true):null,c=g2(e,d.attributes,l,s,i,n),u=gZ(d),p=new aG(e);if(p.vertexBuffer=c,p.primitive[0].type=u,p.primitive[0].base=0,p.primitive[0].indexed=null!==l,null!==l){let t;0==(t=l instanceof Uint8Array?0:l instanceof Uint16Array?1:2)&&e.isWebGPU&&(t=1,l=new Uint16Array(l));let s=new nY(e,t,l.length,0,l);p.indexBuffer[0]=s,p.primitive[0].count=l.length;}else p.primitive[0].count=c.numVertices;if(d.hasOwnProperty("extensions")&&d.extensions.hasOwnProperty("KHR_materials_variants")){let e=d.extensions.KHR_materials_variants,t={};e.mappings.forEach(e=>{e.variants.forEach(s=>{t[s]=e.material;});}),r[p.id]=t;}a[p.id]=d.material;let f=s[d.attributes.POSITION];if(p.aabb=gK(f),d.hasOwnProperty("targets")){let n=[];d.targets.forEach((e,r)=>{let a={};e.hasOwnProperty("POSITION")&&(a.deltaPositions=gq(f=s[e.POSITION],i),a.aabb=gK(f)),e.hasOwnProperty("NORMAL")&&(a.deltaNormals=gq(f=s[e.NORMAL],i)),t.hasOwnProperty("extras")&&t.extras.hasOwnProperty("targetNames")?a.name=t.extras.targetNames[r]:a.name=r.toString(10),t.hasOwnProperty("weights")&&(a.defaultWeight=t.weights[r]),a.preserveData=o.morphPreserveData,n.push(new hc(a));}),p.morph=new hd(n,e,{preferHighPrecision:o.morphPreferHighPrecision});}h.push(p);}}),h},g6=(e,t,s)=>{var i;let n;let r=e.texCoord;if(r)for(n=0;n<s.length;++n)t[""+s[n]+"MapUv"]=r;let a=null==(i=e.extensions)?void 0:i.KHR_texture_transform;if(a){let e=a.offset||[0,0],i=a.scale||[1,1],r=a.rotation?-a.rotation*ei.RAD_TO_DEG:0,o=new ef(i[0],i[1]),l=new ef(e[0],1-i[1]-e[1]);for(n=0;n<s.length;++n)t[""+s[n]+"MapTiling"]=o,t[""+s[n]+"MapOffset"]=l,t[""+s[n]+"MapRotation"]=r;}},g8=(e,t,s)=>{let i,n;if(e.hasOwnProperty("diffuseFactor")?(i=e.diffuseFactor,t.diffuse.set(Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2)),t.opacity=i[3]):(t.diffuse.set(1,1,1),t.opacity=1),e.hasOwnProperty("diffuseTexture")){let i=e.diffuseTexture;t.diffuseMap=n=s[i.index],t.diffuseMapChannel="rgb",t.opacityMap=n,t.opacityMapChannel="a",g6(i,t,["diffuse","opacity"]);}if(t.useMetalness=false,e.hasOwnProperty("specularFactor")?(i=e.specularFactor,t.specular.set(Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2))):t.specular.set(1,1,1),e.hasOwnProperty("glossinessFactor")?t.gloss=e.glossinessFactor:t.gloss=1,e.hasOwnProperty("specularGlossinessTexture")){let i=e.specularGlossinessTexture;t.specularMap=t.glossMap=s[i.index],t.specularMapChannel="rgb",t.glossMapChannel="a",g6(i,t,["gloss","metalness"]);}},g9=(e,t,s)=>{if(e.hasOwnProperty("clearcoatFactor")?t.clearCoat=.25*e.clearcoatFactor:t.clearCoat=0,e.hasOwnProperty("clearcoatTexture")){let i=e.clearcoatTexture;t.clearCoatMap=s[i.index],t.clearCoatMapChannel="r",g6(i,t,["clearCoat"]);}if(e.hasOwnProperty("clearcoatRoughnessFactor")?t.clearCoatGloss=e.clearcoatRoughnessFactor:t.clearCoatGloss=0,e.hasOwnProperty("clearcoatRoughnessTexture")){let i=e.clearcoatRoughnessTexture;t.clearCoatGlossMap=s[i.index],t.clearCoatGlossMapChannel="g",g6(i,t,["clearCoatGloss"]);}if(e.hasOwnProperty("clearcoatNormalTexture")){let i=e.clearcoatNormalTexture;t.clearCoatNormalMap=s[i.index],g6(i,t,["clearCoatNormal"]),i.hasOwnProperty("scale")?t.clearCoatBumpiness=i.scale:t.clearCoatBumpiness=1;}t.clearCoatGlossInvert=true;},g7=(e,t,s)=>{t.useLighting=false,t.emissive.copy(t.diffuse),t.emissiveMap=t.diffuseMap,t.emissiveMapUv=t.diffuseMapUv,t.emissiveMapTiling.copy(t.diffuseMapTiling),t.emissiveMapOffset.copy(t.diffuseMapOffset),t.emissiveMapRotation=t.diffuseMapRotation,t.emissiveMapChannel=t.diffuseMapChannel,t.emissiveVertexColor=t.diffuseVertexColor,t.emissiveVertexColorChannel=t.diffuseVertexColorChannel,t.useLighting=false,t.useSkybox=false,t.diffuse.set(1,1,1),t.diffuseMap=null,t.diffuseVertexColor=false;},ve=(e,t,s)=>{if(t.useMetalnessSpecularColor=true,e.hasOwnProperty("specularColorTexture")&&(t.specularMap=s[e.specularColorTexture.index],t.specularMapChannel="rgb",g6(e.specularColorTexture,t,["specular"])),e.hasOwnProperty("specularColorFactor")){let s=e.specularColorFactor;t.specular.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2));}else t.specular.set(1,1,1);e.hasOwnProperty("specularFactor")?t.specularityFactor=e.specularFactor:t.specularityFactor=1,e.hasOwnProperty("specularTexture")&&(t.specularityFactorMapChannel="a",t.specularityFactorMap=s[e.specularTexture.index],g6(e.specularTexture,t,["specularityFactor"]));},vt=(e,t,s)=>{e.hasOwnProperty("ior")&&(t.refractionIndex=1/e.ior);},vs=(e,t,s)=>{e.hasOwnProperty("dispersion")&&(t.dispersion=e.dispersion);},vi=(e,t,s)=>{t.blendType=2,t.useDynamicRefraction=true,e.hasOwnProperty("transmissionFactor")&&(t.refraction=e.transmissionFactor),e.hasOwnProperty("transmissionTexture")&&(t.refractionMapChannel="r",t.refractionMap=s[e.transmissionTexture.index],g6(e.transmissionTexture,t,["refraction"]));},vn=(e,t,s)=>{if(t.useSheen=true,e.hasOwnProperty("sheenColorFactor")){let s=e.sheenColorFactor;t.sheen.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2));}else t.sheen.set(1,1,1);e.hasOwnProperty("sheenColorTexture")&&(t.sheenMap=s[e.sheenColorTexture.index],g6(e.sheenColorTexture,t,["sheen"])),t.sheenGloss=e.hasOwnProperty("sheenRoughnessFactor")?e.sheenRoughnessFactor:0,e.hasOwnProperty("sheenRoughnessTexture")&&(t.sheenGlossMap=s[e.sheenRoughnessTexture.index],t.sheenGlossMapChannel="a",g6(e.sheenRoughnessTexture,t,["sheenGloss"])),t.sheenGlossInvert=true;},vr=(e,t,s)=>{if(t.blendType=2,t.useDynamicRefraction=true,e.hasOwnProperty("thicknessFactor")&&(t.thickness=e.thicknessFactor),e.hasOwnProperty("thicknessTexture")&&(t.thicknessMap=s[e.thicknessTexture.index],t.thicknessMapChannel="g",g6(e.thicknessTexture,t,["thickness"])),e.hasOwnProperty("attenuationDistance")&&(t.attenuationDistance=e.attenuationDistance),e.hasOwnProperty("attenuationColor")){let s=e.attenuationColor;t.attenuation.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2));}},va=(e,t,s)=>{e.hasOwnProperty("emissiveStrength")&&(t.emissiveIntensity=e.emissiveStrength);},vo=(e,t,s)=>{t.useIridescence=true,e.hasOwnProperty("iridescenceFactor")&&(t.iridescence=e.iridescenceFactor),e.hasOwnProperty("iridescenceTexture")&&(t.iridescenceMapChannel="r",t.iridescenceMap=s[e.iridescenceTexture.index],g6(e.iridescenceTexture,t,["iridescence"])),e.hasOwnProperty("iridescenceIor")&&(t.iridescenceRefractionIndex=e.iridescenceIor),e.hasOwnProperty("iridescenceThicknessMinimum")&&(t.iridescenceThicknessMin=e.iridescenceThicknessMinimum),e.hasOwnProperty("iridescenceThicknessMaximum")&&(t.iridescenceThicknessMax=e.iridescenceThicknessMaximum),e.hasOwnProperty("iridescenceThicknessTexture")&&(t.iridescenceThicknessMapChannel="g",t.iridescenceThicknessMap=s[e.iridescenceThicknessTexture.index],g6(e.iridescenceThicknessTexture,t,["iridescenceThickness"]));},vl=(e,t)=>{let s,i;let n=new cP;if(e.hasOwnProperty("name")&&(n.name=e.name),n.occludeSpecular=1,n.diffuseVertexColor=true,n.specularTint=true,n.specularVertexColor=true,n.specular.set(1,1,1),n.gloss=1,n.glossInvert=true,n.useMetalness=true,e.hasOwnProperty("pbrMetallicRoughness")){let r=e.pbrMetallicRoughness;if(r.hasOwnProperty("baseColorFactor")&&(s=r.baseColorFactor,n.diffuse.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2)),n.opacity=s[3]),r.hasOwnProperty("baseColorTexture")){let e=r.baseColorTexture;n.diffuseMap=i=t[e.index],n.diffuseMapChannel="rgb",n.opacityMap=i,n.opacityMapChannel="a",g6(e,n,["diffuse","opacity"]);}if(r.hasOwnProperty("metallicFactor")&&(n.metalness=r.metallicFactor),r.hasOwnProperty("roughnessFactor")&&(n.gloss=r.roughnessFactor),r.hasOwnProperty("metallicRoughnessTexture")){let e=r.metallicRoughnessTexture;n.metalnessMap=n.glossMap=t[e.index],n.metalnessMapChannel="b",n.glossMapChannel="g",g6(e,n,["gloss","metalness"]);}}if(e.hasOwnProperty("normalTexture")){let s=e.normalTexture;n.normalMap=t[s.index],g6(s,n,["normal"]),s.hasOwnProperty("scale")&&(n.bumpiness=s.scale);}if(e.hasOwnProperty("occlusionTexture")){let s=e.occlusionTexture;n.aoMap=t[s.index],n.aoMapChannel="r",g6(s,n,["ao"]);}if(e.hasOwnProperty("emissiveFactor")&&(s=e.emissiveFactor,n.emissive.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2))),e.hasOwnProperty("emissiveTexture")){let s=e.emissiveTexture;n.emissiveMap=t[s.index],g6(s,n,["emissive"]);}if(e.hasOwnProperty("alphaMode"))switch(e.alphaMode){case "MASK":n.blendType=3,e.hasOwnProperty("alphaCutoff")?n.alphaTest=e.alphaCutoff:n.alphaTest=.5;break;case "BLEND":n.blendType=2,n.depthWrite=false;break;default:n.blendType=3;}else n.blendType=3;e.hasOwnProperty("doubleSided")?(n.twoSidedLighting=e.doubleSided,n.cull=+!e.doubleSided):(n.twoSidedLighting=false,n.cull=1);let r={KHR_materials_clearcoat:g9,KHR_materials_emissive_strength:va,KHR_materials_ior:vt,KHR_materials_dispersion:vs,KHR_materials_iridescence:vo,KHR_materials_pbrSpecularGlossiness:g8,KHR_materials_sheen:vn,KHR_materials_specular:ve,KHR_materials_transmission:vi,KHR_materials_unlit:g7,KHR_materials_volume:vr};if(e.hasOwnProperty("extensions"))for(let s in e.extensions){let i=r[s];void 0!==i&&i(e.extensions[s],n,t);}return n.update(),n},vh=(e,t,s,i,n,r,a)=>{let o,l;let h=e=>new gM(gk(e.type),gq(e,i)),d={STEP:0,LINEAR:1,CUBICSPLINE:2},c={},u={},p={},f=1;for(o=0;o<e.samplers.length;++o){let t=e.samplers[o];c.hasOwnProperty(t.input)||(c[t.input]=h(s[t.input])),u.hasOwnProperty(t.output)||(u[t.output]=h(s[t.output]));let i=t.hasOwnProperty("interpolation")&&d.hasOwnProperty(t.interpolation)?d[t.interpolation]:1,n={paths:[],input:t.input,output:t.output,interpolation:i};p[o]=n;}let m=[],_={translation:"localPosition",rotation:"localRotation",scale:"localScale"},g=e=>{let t=[];for(;e;)t.unshift(e.name),e=e.parent;return t},v=(e,t,s)=>{let i;let n=u[e.output];if(!n)return;if(r&&r[t.mesh]){let e=r[t.mesh];e.hasOwnProperty("extras")&&e.extras.hasOwnProperty("targetNames")&&(i=e.extras.targetNames);}let a=n.data,l=a.length/c[e.input].data.length,h=a.length/l,d=4*h,m=new ArrayBuffer(d*l);for(let t=0;t<l;t++){let n=new Float32Array(m,d*t,h);for(let e=0;e<h;e++)n[e]=a[e*l+t];let r=new gM(1,n),c=(null==i?void 0:i[t])?"name."+i[t]:t;u[-f]=r;let _={paths:[{entityPath:s,component:"graph",propertyPath:["weight."+c]}],input:e.input,output:-f,interpolation:e.interpolation};f++,p["morphCurve-"+o+"-"+t]=_;}};for(o=0;o<e.channels.length;++o){let t=e.channels[o],s=t.target,i=p[t.sampler],r=n[s.node],l=a[s.node],h=g(r);s.path.startsWith("weights")?(v(i,l,h),p[t.sampler].morphCurve=true):i.paths.push({entityPath:h,component:"graph",propertyPath:[_[s.path]]});}let y=[],S=[],x=[];for(let e in c)y.push(c[e]),c[e]=y.length-1;for(let e in u)S.push(u[e]),u[e]=S.length-1;for(let e in p){let t=p[e];!t.morphCurve&&(x.push(new gP(t.paths,c[t.input],u[t.output],t.interpolation)),t.paths.length>0&&"localRotation"===t.paths[0].propertyPath[0]&&2!==t.interpolation&&m.push(x[x.length-1].output));}m.sort();let T=null;for(o=0;o<m.length;++o){let e=m[o];if(0===o||e!==T){if(4===(l=S[e]).components){let e=l.data,t=e.length-4;for(let s=0;s<t;s+=4)e[s+0]*e[s+4]+e[s+1]*e[s+5]+e[s+2]*e[s+6]+e[s+3]*e[s+7]<0&&(e[s+4]*=-1,e[s+5]*=-1,e[s+6]*=-1,e[s+7]*=-1);}T=e;}}let b=0;for(o=0;o<y.length;o++)b=Math.max(b,0===(l=y[o]._data).length?0:l[l.length-1]);return new pM(e.hasOwnProperty("name")?e.name:"animation_"+t,b,y,S,x)},vd=new ex,vc=new eu,vu=(e,t,s)=>{let i=new oE;if(e.hasOwnProperty("name")&&e.name.length>0?i.name=e.name:i.name="node_"+t,e.hasOwnProperty("matrix")&&(vd.data.set(e.matrix),vd.getTranslation(vc),i.setLocalPosition(vc),vd.getEulerAngles(vc),i.setLocalEulerAngles(vc),vd.getScale(vc),i.setLocalScale(vc)),e.hasOwnProperty("rotation")){let t=e.rotation;i.setLocalRotation(t[0],t[1],t[2],t[3]);}if(e.hasOwnProperty("translation")){let t=e.translation;i.setLocalPosition(t[0],t[1],t[2]);}if(e.hasOwnProperty("scale")){let t=e.scale;i.setLocalScale(t[0],t[1],t[2]);}return e.hasOwnProperty("extensions")&&e.extensions.EXT_mesh_gpu_instancing&&s.set(e,{ext:e.extensions.EXT_mesh_gpu_instancing}),i},vp=(e,t)=>{let s=+("orthographic"===e.type),i=1===s?e.orthographic:e.perspective,n={enabled:false,projection:s,nearClip:i.znear,aspectRatioMode:0};i.zfar&&(n.farClip=i.zfar),1===s?(n.orthoHeight=.5*i.ymag,i.ymag&&(n.aspectRatioMode=1,n.aspectRatio=i.xmag/i.ymag)):(n.fov=i.yfov*ei.RAD_TO_DEG,i.aspectRatio&&(n.aspectRatioMode=1,n.aspectRatio=i.aspectRatio));let r=new uG(e.name);return r.addComponent("camera",n),r},vf=(e,t)=>{let s={enabled:false,type:"point"===e.type?"omni":e.type,color:e.hasOwnProperty("color")?new en(e.color):en.WHITE,range:e.hasOwnProperty("range")?e.range:9999,falloffMode:1,intensity:e.hasOwnProperty("intensity")?ei.clamp(e.intensity,0,2):1};e.hasOwnProperty("spot")&&(s.innerConeAngle=e.spot.hasOwnProperty("innerConeAngle")?e.spot.innerConeAngle*ei.RAD_TO_DEG:0,s.outerConeAngle=e.spot.hasOwnProperty("outerConeAngle")?e.spot.outerConeAngle*ei.RAD_TO_DEG:Math.PI/4),e.hasOwnProperty("intensity")&&(s.luminance=e.intensity*hr.getLightUnitConversion(he[s.type],s.outerConeAngle,s.innerConeAngle));let i=new uG(t.name);return i.rotateLocal(90,0,0),i.addComponent("light",s),i},vm=(e,t,s,i)=>{if(!t.hasOwnProperty("skins")||0===t.skins.length)return [];let n=new Map;return t.skins.map(r=>g3(e,r,t.accessors,i,s,n))},v_=(e,t,s,i)=>{var n,r,a;let o={},l={},h={},d=[];return {meshes:!i.skipMeshes&&(null==t?void 0:null==(n=t.meshes)?void 0:n.length)&&(null==t?void 0:null==(r=t.accessors)?void 0:r.length)&&(null==t?void 0:null==(a=t.bufferViews)?void 0:a.length)?t.meshes.map(n=>g5(e,n,t.accessors,s,o,l,h,i,d)):[],meshVariants:l,meshDefaultMaterials:h,promises:d}},vg=(e,t,s)=>{var i,n,r,a;if(!e.hasOwnProperty("materials")||0===e.materials.length)return [];let o=null==s?void 0:null==(i=s.material)?void 0:i.preprocess,l=null!=(a=null==s?void 0:null==(n=s.material)?void 0:n.process)?a:vl,h=null==s?void 0:null==(r=s.material)?void 0:r.postprocess;return e.materials.map(e=>{o&&o(e);let s=l(e,t);return h&&h(e,s),s})},vv=e=>{if(!e.hasOwnProperty("extensions")||!e.extensions.hasOwnProperty("KHR_materials_variants"))return null;let t=e.extensions.KHR_materials_variants.variants,s={};for(let e=0;e<t.length;e++)s[t[e].name]=e;return s},vy=(e,t,s,i)=>{var n,r;if(!e.hasOwnProperty("animations")||0===e.animations.length)return [];let a=null==i?void 0:null==(n=i.animation)?void 0:n.preprocess,o=null==i?void 0:null==(r=i.animation)?void 0:r.postprocess;return e.animations.map((i,n)=>{a&&a(i);let r=vh(i,n,e.accessors,s,t,e.meshes,e.nodes);return o&&o(i,r),r})},vS=(e,t,s,i)=>{let n=t.accessors;s.forEach((e,t)=>{let s,r,a;let o=e.ext.attributes;o.hasOwnProperty("TRANSLATION")&&(s=gq(n[o.TRANSLATION],i)),o.hasOwnProperty("ROTATION")&&(r=gq(n[o.ROTATION],i)),o.hasOwnProperty("SCALE")&&(a=gq(n[o.SCALE],i));let l=(s?s.length/3:0)||(r?r.length/4:0)||(a?a.length/3:0);if(l){let t=new Float32Array(16*l),i=new eu,n=new eT,o=new eu(1,1,1),h=new ex,d=0;for(let e=0;e<l;e++){let l=3*e;if(s&&i.set(s[l],s[l+1],s[l+2]),r){let t=4*e;n.set(r[t],r[t+1],r[t+2],r[t+3]);}a&&o.set(a[l],a[l+1],a[l+2]),h.setTRS(i,n,o);for(let e=0;e<16;e++)t[d++]=h.data[e];}e.matrices=t;}});},vx=(e,t,s)=>{var i,n,r,a;if(!e.hasOwnProperty("nodes")||0===e.nodes.length)return [];let o=null==t?void 0:null==(i=t.node)?void 0:i.preprocess,l=null!=(a=null==t?void 0:null==(n=t.node)?void 0:n.process)?a:vu,h=null==t?void 0:null==(r=t.node)?void 0:r.postprocess,d=e.nodes.map((e,t)=>{o&&o(e);let i=l(e,t,s);return h&&h(e,i),i});for(let t=0;t<e.nodes.length;++t){let s=e.nodes[t];if(s.hasOwnProperty("children")){let e=d[t],i={};for(let t=0;t<s.children.length;++t){let n=d[s.children[t]];n.parent||(i.hasOwnProperty(n.name)?n.name+=i[n.name]++:i[n.name]=1,e.addChild(n));}}}return d},vT=(e,t)=>{var s;let i=[],n=e.scenes.length;if(1===n&&(null==(s=e.scenes[0].nodes)?void 0:s.length)===1){let s=e.scenes[0].nodes[0];i.push(t[s]);}else for(let s=0;s<n;s++){let n=e.scenes[s];if(n.nodes){let e=new oE(n.name);for(let s=0;s<n.nodes.length;s++){let i=t[n.nodes[s]];e.addChild(i);}i.push(e);}}return i},vb=(e,t,s)=>{let i=null;if(e.hasOwnProperty("nodes")&&e.hasOwnProperty("cameras")&&e.cameras.length>0){var n,r,a,o;let l=null==s?void 0:null==(n=s.camera)?void 0:n.preprocess,h=null!=(o=null==s?void 0:null==(r=s.camera)?void 0:r.process)?o:vp,d=null==s?void 0:null==(a=s.camera)?void 0:a.postprocess;e.nodes.forEach((s,n)=>{if(s.hasOwnProperty("camera")){let r=e.cameras[s.camera];if(r){l&&l(r);let e=h(r,t[n]);d&&d(r,e),e&&(i||(i=new Map),i.set(s,e));}}});}return i},vE=(e,t,s)=>{let i=null;if(e.hasOwnProperty("nodes")&&e.hasOwnProperty("extensions")&&e.extensions.hasOwnProperty("KHR_lights_punctual")&&e.extensions.KHR_lights_punctual.hasOwnProperty("lights")){let l=e.extensions.KHR_lights_punctual.lights;if(l.length){var n,r,a,o;let h=null==s?void 0:null==(n=s.light)?void 0:n.preprocess,d=null!=(o=null==s?void 0:null==(r=s.light)?void 0:r.process)?o:vf,c=null==s?void 0:null==(a=s.light)?void 0:a.postprocess;e.nodes.forEach((e,s)=>{if(e.hasOwnProperty("extensions")&&e.extensions.hasOwnProperty("KHR_lights_punctual")&&e.extensions.KHR_lights_punctual.hasOwnProperty("light")){let n=l[e.extensions.KHR_lights_punctual.light];if(n){h&&h(n);let r=d(n,t[s]);c&&c(n,r),r&&(i||(i=new Map),i.set(e,r));}}});}}return i},vA=(e,t,s)=>{e.nodes.forEach(e=>{e.hasOwnProperty("mesh")&&e.hasOwnProperty("skin")&&t[e.mesh].meshes.forEach(t=>{t.skin=s[e.skin];});});},vw=async(e,t,s,i,n)=>{var r,a;let o=null==n?void 0:null==(r=n.global)?void 0:r.preprocess,l=null==n?void 0:null==(a=n.global)?void 0:a.postprocess;o&&o(t),t.asset&&t.asset.generator;let h=new Map,d=vx(t,n,h),c=vT(t,d),u=vE(t,d,n),p=vb(t,d,n),f=vv(t),m=await Promise.all(s),{meshes:_,meshVariants:g,meshDefaultMaterials:v,promises:y}=v_(e,t,m,n),S=vy(t,d,m,n);vS(e,t,h,m);let x=await Promise.all(i),T=vg(t,x.map(e=>e.resource),n),b=vm(e,t,d,m),E=[];for(let e=0;e<_.length;e++)E[e]=new gb,E[e].meshes=_[e];vA(t,E,b);let A=new gN;return A.gltf=t,A.nodes=d,A.scenes=c,A.animations=S,A.textures=x,A.materials=T,A.variants=f,A.meshVariants=g,A.meshDefaultMaterials=v,A.renders=E,A.skins=b,A.lights=u,A.cameras=p,A.nodeInstancingMap=h,l&&l(t,A),await Promise.all(y),A},vC=(e,t)=>{let s=(e,t)=>{switch(e){case 9728:return 0;case 9729:return 1;case 9984:return 2;case 9985:return 4;case 9986:return 3;case 9987:return 5;default:return t}},i=(e,t)=>{switch(e){case 33071:return 1;case 33648:return 2;case 10497:return 0;default:return t}};e&&(e.minFilter=s((t=null!=t?t:{}).minFilter,5),e.magFilter=s(t.magFilter,1),e.addressU=i(t.wrapS,0),e.addressV=i(t.wrapT,0));},vP=0,vM=e=>{var t,s,i,n,r,a;return null!=(a=null!=(r=null==(s=e.extensions)?void 0:null==(t=s.KHR_texture_basisu)?void 0:t.source)?r:null==(n=e.extensions)?void 0:null==(i=n.EXT_texture_webp)?void 0:i.source)?a:e.source},vI=(e,t,s,i,n)=>{var r,a,o;if(!e.images||0===e.images.length)return [];let l=null==n?void 0:null==(r=n.image)?void 0:r.preprocess,h=null==n?void 0:null==(a=n.image)?void 0:a.processAsync,d=null==n?void 0:null==(o=n.image)?void 0:o.postprocess,c={"image/png":"png","image/jpeg":"jpg","image/basis":"basis","image/ktx":"ktx","image/ktx2":"ktx2","image/vnd-ms.dds":"dds"},u=(e,t,s,n,r,a)=>new Promise((o,l)=>{let h=s=>{let h=(e.name||"gltf-texture")+"-"+vP++,d={url:t||h};if(s&&(d.contents=s.slice(0).buffer),n){let e=c[n];e&&(d.filename=d.url+"."+e);}let u=new ub(h,"texture",d,{srgb:a},r);u.on("load",e=>o(e)),u.on("error",e=>l(e)),i.add(u),i.load(u);};s?s.then(e=>h(e)):h(null);}),p=(e=>{let t=new Set;return e.hasOwnProperty("materials")&&e.materials.forEach(s=>{if(s.hasOwnProperty("pbrMetallicRoughness")){let i=s.pbrMetallicRoughness;if(i.hasOwnProperty("baseColorTexture")){let s=e.textures[i.baseColorTexture.index];t.add(vM(s));}}if(s.hasOwnProperty("emissiveTexture")){let i=e.textures[s.emissiveTexture.index];t.add(vM(i));}if(s.hasOwnProperty("extensions")){let i=s.extensions.KHR_materials_sheen;if(i&&i.hasOwnProperty("sheenColorTexture")){let s=e.textures[i.sheenColorTexture.index];t.add(vM(s));}let n=s.extensions.KHR_materials_pbrSpecularGlossiness;if(n&&n.hasOwnProperty("specularGlossinessTexture")){let s=e.textures[n.specularGlossinessTexture.index];t.add(vM(s));}let r=s.extensions.KHR_materials_specular;if(r&&r.hasOwnProperty("specularColorTexture")){let s=e.textures[r.specularColorTexture.index];t.add(vM(s));}}}),t})(e);return e.images.map((e,i)=>{let n;return l&&l(e),n=(n=new Promise(h?(t,s)=>{h(e,(e,i)=>{e?s(e):t(i);});}:e=>{e(null);})).then(n=>{let r=p.has(i);return n?n:e.hasOwnProperty("uri")?gB(e.uri)?u(e,e.uri,null,gU(e.uri),null,r):u(e,uv.test(e.uri)?e.uri:M.join(s,e.uri),null,null,{crossOrigin:"anonymous"},r):e.hasOwnProperty("bufferView")&&e.hasOwnProperty("mimeType")?u(e,null,t[e.bufferView],e.mimeType,null,r):Promise.reject(Error("Invalid image found in gltf (neither uri or bufferView found). index="+i))}),d&&(n=n.then(t=>(d(e,t),t))),n})},vR=(e,t,s)=>{var i,n,r,a,o;if(!(null==e?void 0:null==(i=e.images)?void 0:i.length)||!(null==e?void 0:null==(n=e.textures)?void 0:n.length))return [];let l=null==s?void 0:null==(r=s.texture)?void 0:r.preprocess,h=null==s?void 0:null==(a=s.texture)?void 0:a.processAsync,d=null==s?void 0:null==(o=s.texture)?void 0:o.postprocess,c=new Set;return e.textures.map(s=>{let i;return l&&l(s),i=(i=new Promise(h?(t,i)=>{h(s,e.images,(e,s)=>{e?i(e):t(s);});}:e=>{e(null);})).then(i=>{i=null!=i?i:vM(s);let n=c.has(i);return c.add(i),t[i].then(t=>{var i;let r=n?g0(t):t;return vC(r.resource,(null!=(i=e.samplers)?i:[])[s.sampler]),r})}),d&&(i=i.then(e=>(d(s,e),e))),i})},vL=(e,t,s,i)=>{var n,r,a;if(!e.buffers||0===e.buffers.length)return [];let o=null==i?void 0:null==(n=i.buffer)?void 0:n.preprocess,l=null==i?void 0:null==(r=i.buffer)?void 0:r.processAsync,h=null==i?void 0:null==(a=i.buffer)?void 0:a.postprocess;return e.buffers.map((i,n)=>{let r;return o&&o(i),r=(r=new Promise(l?(e,t)=>{l(i,(s,i)=>{s?t(s):e(i);});}:e=>{e(null);})).then(e=>{if(e)return e;if(i.hasOwnProperty("uri")){if(gB(i.uri)){let e=atob(i.uri.split(",")[1]),t=new Uint8Array(e.length);for(let s=0;s<e.length;s++)t[s]=e.charCodeAt(s);return t}return new Promise((e,t)=>{rR.get(uv.test(i.uri)?i.uri:M.join(s,i.uri),{cache:true,responseType:"arraybuffer",retry:false},(s,i)=>{s?t(s):e(new Uint8Array(i));});})}return t}),h&&(r=r.then(t=>(h(e.buffers[n],t),t))),r})},vD=(e,t)=>{let s=JSON.parse((e=>{if("undefined"!=typeof TextDecoder)return new TextDecoder().decode(e);let t="";for(let s=0;s<e.length;s++)t+=String.fromCharCode(e[s]);return decodeURIComponent(escape(t))})(e));if(s.asset&&s.asset.version&&2>parseFloat(s.asset.version)){t("Invalid gltf version. Expected version 2.0 or above but found version '"+s.asset.version+"'.");return}t(null,s);},vO=(e,t)=>{let s=e instanceof ArrayBuffer?new DataView(e):new DataView(e.buffer,e.byteOffset,e.byteLength),i=s.getUint32(0,true),n=s.getUint32(4,true),r=s.getUint32(8,true);if(0x46546c67!==i){t("Invalid magic number found in glb header. Expected 0x46546C67, found 0x"+i.toString(16));return}if(2!==n){t("Invalid version number found in glb header. Expected 2, found "+n);return}if(r<=0||r>s.byteLength){t("Invalid length found in glb header. Found "+r);return}let a=[],o=12;for(;o<r;){let e=s.getUint32(o,true);o+e+8>s.byteLength&&t("Invalid chunk length found in glb. Found "+e);let i=s.getUint32(o+4,true),n=new Uint8Array(s.buffer,s.byteOffset+o+8,e);a.push({length:e,type:i,data:n}),o+=e+8;}if(1!==a.length&&2!==a.length){t("Invalid number of chunks found in glb file.");return}if(0x4e4f534a!==a[0].type){t("Invalid chunk type found in glb file. Expected 0x4E4F534A, found 0x"+a[0].type.toString(16));return}if(a.length>1&&5130562!==a[1].type){t("Invalid chunk type found in glb file. Expected 0x004E4942, found 0x"+a[1].type.toString(16));return}t(null,{gltfChunk:a[0].data,binaryChunk:2===a.length?a[1].data:null});},vF=(e,t,s)=>{e&&e.toLowerCase().endsWith(".glb")||(()=>{let e=new Uint8Array(t);return 103===e[0]&&108===e[1]&&84===e[2]&&70===e[3]})()?vO(t,s):s(null,{gltfChunk:t,binaryChunk:null});},vN=(e,t,s)=>{var i,n,r,a;let o=[],l=null==s?void 0:null==(i=s.bufferView)?void 0:i.preprocess,h=null==s?void 0:null==(n=s.bufferView)?void 0:n.processAsync,d=null==s?void 0:null==(r=s.bufferView)?void 0:r.postprocess;if(!(null==(a=e.bufferViews)?void 0:a.length))return o;for(let s=0;s<e.bufferViews.length;++s){let i;let n=e.bufferViews[s];l&&l(n),i=(i=new Promise(h?(e,s)=>{h(n,t,(t,i)=>{t?s(t):e(i);});}:e=>{e(null);})).then(e=>e||t[n.buffer].then(e=>new Uint8Array(e.buffer,e.byteOffset+(n.byteOffset||0),n.byteLength))),n.hasOwnProperty("byteStride")&&(i=i.then(e=>(e.byteStride=n.byteStride,e))),d&&(i=i.then(e=>(d(n,e),e))),o.push(i);}return o};class vB{static parse(e,t,s,i,n,r,a){vF(e,s,(e,s)=>{if(e){a(e);return}vD(s.gltfChunk,(e,o)=>{if(e){a(e);return}let l=vL(o,s.binaryChunk,t,r),h=vN(o,l,r),d=vI(o,h,t,n,r),c=vR(o,d,r);vw(i,o,h,c,r).then(e=>a(null,e)).catch(e=>a(e));});});}static createDefaultMaterial(){return vl({name:"defaultGlbMaterial"},[])}}class vU extends uI{load(e,t,s){"string"==typeof e&&(e={load:e,original:e});let i={retry:this.maxRetries>0,maxRetries:this.maxRetries};(e.load.startsWith("blob:")||e.load.startsWith("data:"))&&(".glb"===M.getExtension(e.original).toLowerCase()?i.responseType=rI.ResponseType.ARRAY_BUFFER:i.responseType=rI.ResponseType.JSON),rR.get(e.load,i,(i,n)=>{if(i)t("Error loading animation resource: "+e.original+" ["+i+"]");else if(".glb"===M.getExtension(e.original).toLowerCase()){var r;vB.parse("filename.glb","",n,this.device,this.assets,null!=(r=null==s?void 0:s.options)?r:{},(e,i)=>{if(e)t(e);else {var n;let e=i.animations;if(null==s?void 0:null==(n=s.data)?void 0:n.events)for(let t=0;t<e.length;t++)e[t].events=new pP(Object.values(s.data.events));i.destroy(),t(null,e);}});}else t(null,this["_parseAnimationV"+n.animation.version](n));});}open(e,t,s){return t}_parseAnimationV3(e){let t=e.animation,s=new d3;s.name=t.name,s.duration=t.duration;for(let e=0;e<t.nodes.length;e++){let i=new d2,n=t.nodes[e];i._name=n.name;for(let e=0;e<n.keys.length;e++){let t=n.keys[e],s=t.time,r=t.pos,a=t.rot,o=t.scale,l=new eu(r[0],r[1],r[2]),h=new d1(s,l,new eT().setFromEulerAngles(a[0],a[1],a[2]),new eu(o[0],o[1],o[2]));i._keys.push(h);}s.addNode(i);}return s}_parseAnimationV4(e){let t=e.animation,s=new d3;s.name=t.name,s.duration=t.duration;for(let e=0;e<t.nodes.length;e++){let i=new d2,n=t.nodes[e];i._name=n.name;let r=n.defaults.p,a=n.defaults.r,o=n.defaults.s;for(let e=0;e<n.keys.length;e++){let t=n.keys[e],s=t.t,l=r||t.p,h=a||t.r,d=o||t.s,c=new eu(l[0],l[1],l[2]),u=new d1(s,c,new eT().setFromEulerAngles(h[0],h[1],h[2]),new eu(d[0],d[1],d[2]));i._keys.push(u);}s.addNode(i);}return s}constructor(e){super(e,"animation"),this.device=e.graphicsDevice,this.assets=e.assets;}}class vk extends uI{load(e,t){"string"==typeof e&&(e={load:e,original:e});let s={retry:this.maxRetries>0,maxRetries:this.maxRetries};e.load.startsWith("blob:")&&(s.responseType=rI.ResponseType.JSON),rR.get(e.load,s,(s,i)=>{s?t("Error loading animation clip resource: "+e.original+" ["+s+"]"):t(null,i);});}open(e,t){let s=t.name,i=t.duration,n=t.inputs.map(e=>new gM(1,e));return new pM(s,i,n,t.outputs.map(e=>new gM(e.components,e.data)),t.curves.map(e=>new gP([e.path],e.inputIndex,e.outputIndex,e.interpolation)))}constructor(e){super(e,"animclip");}}class vz extends uI{load(e,t){"string"==typeof e&&(e={load:e,original:e});let s={retry:this.maxRetries>0,maxRetries:this.maxRetries};e.load.startsWith("blob:")&&(s.responseType=rI.ResponseType.JSON),rR.get(e.load,s,(s,i)=>{s?t("Error loading animation state graph resource: "+e.original+" ["+s+"]"):t(null,i);});}open(e,t){return new p0(t)}constructor(e){super(e,"animstategraph");}}let vV=function(){if("undefined"==typeof window)return  false;let e=window.navigator.userAgent,t=e.indexOf("MSIE ");if(t>0)return parseInt(e.substring(t+5,e.indexOf(".",t)),10);if(e.indexOf("Trident/")>0){let t=e.indexOf("rv:");return parseInt(e.substring(t+3,e.indexOf(".",t)),10)}return  false}(),vG=[".ogg",".mp3",".wav",".mp4a",".m4a",".mp4",".aac",".opus"];class vH extends uI{_isSupported(e){let t=M.getExtension(e);return vG.indexOf(t)>-1}load(e,t){"string"==typeof e&&(e={load:e,original:e});let s=function(s){let i="Error loading audio url: "+e.original;s&&(i+=": "+(s.message||s)),t(i);};if(this._createSound){if(!this._isSupported(e.original)){s("Audio format for "+e.original+" not supported");return}this._createSound(e.load,function(e){t(null,new rk(e));},s);}else s(null);}_createSound(e,t,s){if(rL()){let i=this.manager;if(!i.context){s("Audio manager has no audio context");return}let n={retry:this.maxRetries>0,maxRetries:this.maxRetries};(e.startsWith("blob:")||e.startsWith("data:"))&&(n.responseType=rI.ResponseType.ARRAY_BUFFER),rR.get(e,n,(e,n)=>{if(e){s(e);return}i.context.decodeAudioData(n,t,s);});}else {let i=null;try{i=new Audio;}catch(e){s("No support for Audio element");return}vV&&document.body.appendChild(i);let n=function(){i.removeEventListener("canplaythrough",n),vV&&document.body.removeChild(i),t(i);};i.onerror=function(){i.onerror=null,vV&&document.body.removeChild(i),s();},i.addEventListener("canplaythrough",n),i.src=e;}}constructor(e){super(e,"audio"),this.manager=e.soundManager;}}class vW extends uI{load(e,t){"string"==typeof e&&(e={load:e,original:e}),rR.get(e.load,{responseType:rI.ResponseType.ARRAY_BUFFER,retry:this.maxRetries>0,maxRetries:this.maxRetries},(s,i)=>{s?t("Error loading binary resource: "+e.original+" ["+s+"]"):t(null,i);});}openBinary(e){return e.buffer}constructor(e){super(e,"binary");}}class vX{get model(){if(!this._model){let e=vX.createModel(this.data,this._defaultMaterial),t=vX.createAsset(this._assetName,"model",e,0);this._assets.add(t),this._model=t;}return this._model}static createAsset(e,t,s,i){let n=new ub(e+"/"+t+"/"+i,t,{url:""});return n.resource=s,n.loaded=true,n}instantiateModelEntity(e){let t=new uG(void 0,this._assets._loader._app);return t.addComponent("model",Object.assign({type:"asset",asset:this.model},e)),t}instantiateRenderEntity(e){let t=this._defaultMaterial,s=[],i=function(e,i,n,r,a,o,l,h){let d=a[n.id],c=new a0(n,void 0===d?t:r[d]);n.morph&&(c.morphInstance=new hl(n.morph)),l.hasOwnProperty("skin")&&s.push({meshInstance:c,rootBone:e,entity:i});let u=h.get(l);if(u){let e=u.matrices,t=sA.getDefaultInstancingFormat(n.device),s=new sy(n.device,t,e.length/16,{data:e});c.setInstancing(s),c.instancingData._destroyVertexBuffer=true;}return c},n=(t,s,r)=>{let a=new uG(void 0,this._assets._loader._app);s._cloneInternal(a),t||(t=a);let o=null,l=null;for(let e=0;e<r.nodes.length;e++)if(r.nodes[e]===s){let s=r.gltf.nodes[e];if(s.hasOwnProperty("mesh")){let e=r.renders[s.mesh].meshes;l=this.renders[s.mesh];for(let n=0;n<e.length;n++){let l=e[n];if(l){let e=i(t,a,l,r.materials,r.meshDefaultMaterials,r.skins,s,r.nodeInstancingMap);o||(o=[]),o.push(e);}}}if(r.lights){let e=r.lights.get(s);e&&a.addChild(e.clone());}if(r.cameras){let e=r.cameras.get(s);e&&e.camera.system.cloneComponent(e,a);}}o&&(a.addComponent("render",Object.assign({type:"asset",meshInstances:o},e)),a.render.assignAsset(l));let h=s.children;for(let e=0;e<h.length;e++){let s=n(t,h[e],r);a.addChild(s);}return a},r=[];for(let e of this.data.scenes)r.push(n(null,e,this.data));return s.forEach(e=>{e.meshInstance.skinInstance=m$.createCachedSkinInstance(e.meshInstance.mesh.skin,e.rootBone,e.entity),e.meshInstance.node.render.rootBone=e.rootBone;}),vX.createSceneHierarchy(r,uG)}getMaterialVariants(){return this.data.variants?Object.keys(this.data.variants):[]}applyMaterialVariant(e,t){let s=t?this.data.variants[t]:null;if(void 0===s)return;let i=e.findComponents("render");for(let e=0;e<i.length;e++){let t=i[e];this._applyMaterialVariant(s,t.meshInstances);}}applyMaterialVariantInstances(e,t){let s=t?this.data.variants[t]:null;void 0!==s&&this._applyMaterialVariant(s,e);}_applyMaterialVariant(e,t){t.forEach(t=>{if(null===e)t.material=this._defaultMaterial;else {let s=this.data.meshVariants[t.mesh.id];s&&(t.material=this.data.materials[s[e]]);}});}static createSceneHierarchy(e,t){let s=null;if(1===e.length)s=e[0];else for(let i of(s=new t("SceneGroup"),e))s.addChild(i);return s}static createModel(e,t){let s=new hh,i=[];for(let t of e.skins){let e=new aB(t);e.bones=t.bones,i.push(e);}s.graph=vX.createSceneHierarchy(e.scenes,oE);for(let n=0;n<e.nodes.length;n++){let r=e.nodes[n];if(r.root===s.graph){let a=e.gltf.nodes[n];if(a.hasOwnProperty("mesh")){let n=e.renders[a.mesh].meshes;for(let o=0;o<n.length;o++){let l=n[o];l&&function(s,i,n,r,a,o,l){let h=e.meshDefaultMaterials[i.id],d=new a0(i,void 0===h?t:a[h],o);if(i.morph){let e=new hl(i.morph);d.morphInstance=e,s.morphInstances.push(e);}if(l.hasOwnProperty("skin")){let e=l.skin;i.skin=n[e];let t=r[e];d.skinInstance=t,s.skinInstances.push(t);}s.meshInstances.push(d);}(s,l,e.skins,i,e.materials,r,a);}}}}return s}destroy(){let e=this._assets,t=function(t){e.remove(t),t.unload();},s=function(e){e.forEach(e=>{t(e);});};this.animations&&(s(this.animations),this.animations=null),this.textures&&(s(this.textures),this.textures=null),this.materials&&(s(this.materials),this.materials=null),this.renders&&(s(this.renders),this.renders=null),this._model&&(t(this._model),this._model=null),this.data=null,this.assets=null;}constructor(e,t,s,i){let n=function(e,i,n){let r=vX.createAsset(t.name,e,i,n);return s.add(r),r},r=[];for(let t=0;t<e.renders.length;++t)r.push(n("render",e.renders[t],t));let a=[];for(let t=0;t<e.materials.length;++t)a.push(n("material",e.materials[t],t));let o=[];for(let t=0;t<e.animations.length;++t)o.push(n("animation",e.animations[t],t));this.data=e,this._model=null,this._assetName=t.name,this._assets=s,this._defaultMaterial=i,this.renders=r,this.materials=a,this.textures=e.textures,this.animations=o;}}class vY{_getUrlWithoutParams(e){return e.indexOf("?")>=0?e.split("?")[0]:e}load(e,t,s){ub.fetchArrayBuffer(e.load,(i,n)=>{i?t(i):vB.parse(this._getUrlWithoutParams(e.original),M.extractPath(e.load),n,this._device,s.registry,s.options,(e,i)=>{e?t(e):t(null,new vX(i,s,this._assets,this._defaultMaterial));});},s,this.maxRetries);}open(e,t,s){return t}patch(e,t){}constructor(e,t,s){this._device=e,this._assets=t,this._defaultMaterial=vB.createDefaultMaterial(),this.maxRetries=s;}}class vj extends uI{set maxRetries(e){for(let t in this.glbContainerParser.maxRetries=e,this.parsers)this.parsers.hasOwnProperty(t)&&(this.parsers[t].maxRetries=e);}get maxRetries(){return this.glbContainerParser.maxRetries}_getUrlWithoutParams(e){return e.indexOf("?")>=0?e.split("?")[0]:e}_getParser(e){let t=e?M.getExtension(this._getUrlWithoutParams(e)).toLowerCase().replace(".",""):null;return this.parsers[t]||this.glbContainerParser}load(e,t,s){"string"==typeof e&&(e={load:e,original:e}),this._getParser(e.original).load(e,t,s);}open(e,t,s){return this._getParser(e).open(e,t,s)}constructor(e){super(e,"container"),this.glbContainerParser=new vY(e.graphicsDevice,e.assets,0),this.parsers={};}}class vq extends uI{load(e,t){"string"==typeof e&&(e={load:e,original:e}),rR.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(s,i)=>{s?t("Error loading css resource: "+e.original+" ["+s+"]"):t(null,i);});}openBinary(e){return null!=this.decoder||(this.decoder=new TextDecoder("utf-8")),this.decoder.decode(e)}constructor(e){super(e,"css"),this.decoder=null;}}class vK extends uI{load(e,t,s){this.loadAssets(s,t);}open(e,t,s){return s?s.resource:null}patch(e,t){this.loadAssets(e,(s,i)=>{s&&(t.fire("error",e),t.fire("error:"+e.id,s,e),e.fire("error",e));});}getAssetIds(e){let t=[];if(t[0]=e.file,(e.loadFaces||!e.file)&&e.data&&e.data.textures)for(let s=0;s<6;++s)t[s+1]=e.data.textures[s];else t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=null;return t}compareAssetIds(e,t){return e&&t?parseInt(e,10)===e||"string"==typeof e?e===t:e.url===t.url:null!==e==(null!==t)}update(e,t,s){let i,n,r;let a=e.data||{},o=e._handlerState.assets,l=e._resources,h=[null,null,null,null,null,null,null],d=function(){return a.hasOwnProperty("type")?a.type:a.hasOwnProperty("rgbm")?a.rgbm?tE:tb:null};if(e.loaded&&s[0]===o[0])h[1]=l[1]||null,h[2]=l[2]||null,h[3]=l[3]||null,h[4]=l[4]||null,h[5]=l[5]||null,h[6]=l[6]||null;else if(s[0]){if((i=s[0].resource).cubemap)for(r=0;r<6;++r)h[r+1]=new se(this._device,{name:e.name+"_prelitCubemap"+(i.width>>r),cubemap:true,type:d()||i.type,width:i.width>>r,height:i.height>>r,format:i.format,levels:[i._levels[r]],addressU:1,addressV:1,mipmaps:0===r});else h[1]=i;}let c=s.slice(1);if(e.loaded&&this.cmpArrays(c,o.slice(1)))h[0]=l[0]||null;else if(-1===c.indexOf(null)){var u;let t=c.map(e=>e.resource),s=[];for(n=0;n<t[0]._levels.length;++n)s.push(t.map(e=>e._levels[n]));let i=t[0].format,r=new se(this._device,{name:""+e.name+"_faces",cubemap:true,type:d()||t[0].type,width:t[0].width,height:t[0].height,format:6===i?7:i,mipmaps:null==(u=a.mipmaps)||u,levels:s,minFilter:a.hasOwnProperty("minFilter")?a.minFilter:t[0].minFilter,magFilter:a.hasOwnProperty("magFilter")?a.magFilter:t[0].magFilter,anisotropy:a.hasOwnProperty("anisotropy")?a.anisotropy:1,addressU:1,addressV:1});h[0]=r;}if(!this.cmpArrays(h,l))for(r=0,e.resources=h,e._handlerState.assetIds=t,e._handlerState.assets=s;r<l.length;++r)null!==l[r]&&-1===h.indexOf(l[r])&&l[r].destroy();for(r=0;r<o.length;++r)null!==o[r]&&-1===s.indexOf(o[r])&&o[r].unload();}cmpArrays(e,t){if(e.length!==t.length)return  false;for(let s=0;s<e.length;++s)if(e[s]!==t[s])return  false;return  true}resolveId(e){let t=parseInt(e,10);return t===e||t.toString()===e?t:e}loadAssets(e,t){let s;e.hasOwnProperty("_handlerState")||(e._handlerState={assetIds:[null,null,null,null,null,null,null],assets:[null,null,null,null,null,null,null]});let i=this,n=i.getAssetIds(e),r=[null,null,null,null,null,null,null],a=e._handlerState.assetIds,o=e._handlerState.assets,l=i._registry,h=7,d=function(s,a){r[s]=a,0==--h&&(i.update(e,n,r),t(null,e.resources));},c=function(e,s,i){t(s);},u=function(e,t){t.loaded?d(e,t):(l.once("load:"+t.id,d.bind(i,e)),l.once("error:"+t.id,c.bind(i,e)),t.loading||l.load(t));};for(let t=0;t<7;++t){let r=this.resolveId(n[t]);if(r){if(i.compareAssetIds(r,a[t]))u(t,o[t]);else if(parseInt(r,10)===r)(s=l.get(r))?u(t,s):setTimeout(((e,t)=>{let s=l.get(t);s?u(e,s):c(e,"failed to find dependent cubemap asset="+t);}).bind(null,t,r));else {let i="string"==typeof r?{url:r,filename:r}:r,n=-1===i.url.search(".dds")?{type:"rgbp",addressu:"clamp",addressv:"clamp",mipmaps:false}:null;s=new ub(e.name+"_part_"+t,"texture",i,n),l.add(s),u(t,s);}}else d(t,null);}}constructor(e){super(e,"cubemap"),this._device=e.graphicsDevice,this._registry=e.assets,this._loader=e.loader;}}class vZ extends uI{load(e,t){t(null,null);}constructor(e){super(e,"folder");}}class vQ{set data(e){if(this._data=e,e&&(void 0!==this._data.intensity&&(this.intensity=this._data.intensity),this._data.info||(this._data.info={}),(!this._data.version||this._data.version<2)&&(this._data.info.maps=[{width:this._data.info.width,height:this._data.info.height}],this._data.chars)))for(let e in this._data.chars)this._data.chars[e].map=0;}get data(){return this._data}constructor(e,t){this.type=t&&t.type||fH,this.em=1,this.textures=e,this.intensity=0,this._data=null,this.data=t;}}function vJ(e){return e.version<3&&(e.version<2&&(e.info.maps=e.info.maps||[{width:e.info.width,height:e.info.height}]),e.chars=Object.keys(e.chars||{}).reduce((t,s)=>{let i=e.chars[s],n=void 0!==i.letter?i.letter:W.fromCodePoint(s);return e.version<2&&(i.map=i.map||0),t[n]=i,t},{}),e.version=3),e}class v$ extends uI{load(e,t,s){"string"==typeof e&&(e={load:e,original:e});let i=this;".json"===M.getExtension(e.original)?rR.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(s,n)=>{if(s)t("Error loading font resource: "+e.original+" ["+s+"]");else {let s=vJ(n);i._loadTextures(e.load.replace(".json",".png"),s,(e,i)=>{e?t(e):t(null,{data:s,textures:i});});}}):(s&&s.data&&(s.data=vJ(s.data)),this._loadTextures(e.load,s&&s.data,t));}_loadTextures(e,t,s){let i=t.info.maps.length,n=0,r=null,a=Array(i),o=this._loader,l=function(t){let l=function(e,o){if(!r){if(e){r=e,s(e);return}o.upload(),a[t]=o,++n===i&&s(null,a);}};0===t?o.load(e,"texture",l):o.load(e.replace(".png",""+t+".png"),"texture",l);};for(let e=0;e<i;e++)l(e);}open(e,t,s){return t.textures?new vQ(t.textures,t.data):new vQ(t,null)}patch(e,t){let s=e.resource;!s.data&&e.data?s.data=e.data:!e.data&&s.data&&(e.data=s.data),e.data&&(e.data=vJ(e.data));}constructor(e){super(e,"font"),this._loader=e.loader,this.maxRetries=0;}}class v0{constructor(e,t,s,i,n,r){let a=(e,t)=>{let s=(1<<t)-1;return (e&s)/s},o=(e,t)=>{e.x=a(t>>>21,11),e.y=a(t>>>11,10),e.z=a(t,11);},l=(e,t)=>{e.x=a(t>>>24,8),e.y=a(t>>>16,8),e.z=a(t>>>8,8),e.w=a(t,8);},h=(e,t)=>{let s=1/(.5*Math.sqrt(2)),i=(a(t>>>20,10)-.5)*s,n=(a(t>>>10,10)-.5)*s,r=(a(t,10)-.5)*s,o=Math.sqrt(1-(i*i+n*n+r*r));switch(t>>>30){case 0:e.set(i,n,r,o);break;case 1:e.set(o,n,r,i);break;case 2:e.set(n,o,r,i);break;case 3:e.set(n,r,o,i);}},d=(e,t,s)=>e*(1-s)+t*s,{chunkData:c,chunkSize:u,vertexData:p,shData0:f,shData1:m,shData2:_,shBands:g}=e,v=[3,8,15][g-1];this.read=e=>{let a=Math.floor(e/256)*u;if(t&&(o(t,p[4*e+0]),t.x=d(c[a+0],c[a+3],t.x),t.y=d(c[a+1],c[a+4],t.y),t.z=d(c[a+2],c[a+5],t.z)),s&&h(s,p[4*e+1]),i&&(o(i,p[4*e+2]),i.x=d(c[a+6],c[a+9],i.x),i.y=d(c[a+7],c[a+10],i.y),i.z=d(c[a+8],c[a+11],i.z)),n&&(l(n,p[4*e+3]),u>12&&(n.x=d(c[a+12],c[a+15],n.x),n.y=d(c[a+13],c[a+16],n.y),n.z=d(c[a+14],c[a+17],n.z))),r&&g>0){let t=[f,m,_];for(let s=0;s<3;++s)for(let i=0;i<15;++i)r[15*s+i]=i<v?t[s][16*e+i]*(8/255)-4:0;}};}}class v1{createIter(e,t,s,i,n){return new v0(this,e,t,s,i,n)}calcAabb(e){let{chunkData:t,numChunks:s,chunkSize:i}=this,n=Math.exp(Math.max(t[9],t[10],t[11])),r=t[0]-n,a=t[1]-n,o=t[2]-n,l=t[3]+n,h=t[4]+n,d=t[5]+n;for(let e=1;e<s;++e){let s=e*i;n=Math.exp(Math.max(t[s+9],t[s+10],t[s+11])),r=Math.min(r,t[s+0]-n),a=Math.min(a,t[s+1]-n),o=Math.min(o,t[s+2]-n),l=Math.max(l,t[s+3]+n),h=Math.max(h,t[s+4]+n),d=Math.max(d,t[s+5]+n);}return e.center.set((r+l)*.5,(a+h)*.5,(o+d)*.5),e.halfExtents.set((l-r)*.5,(h-a)*.5,(d-o)*.5),true}getCenters(e){let t,s,i,n,r,a;let{vertexData:o,chunkData:l,numChunks:h,chunkSize:d}=this;for(let c=0;c<h;++c){let h=c*d;t=l[h+0],s=l[h+1],i=l[h+2],n=l[h+3],r=l[h+4],a=l[h+5];let u=Math.min(this.numSplats,(c+1)*256);for(let l=256*c;l<u;++l){let h=o[4*l],d=(h>>>21)/2047,c=(h>>>11&1023)/1023,u=(2047&h)/2047;e[3*l+0]=(1-d)*t+d*n,e[3*l+1]=(1-c)*s+c*r,e[3*l+2]=(1-u)*i+u*a;}}}getChunks(e){let t,s,i,n,r,a;let{chunkData:o,numChunks:l,chunkSize:h}=this;for(let d=0;d<l;++d){let l=d*h;t=o[l+0],s=o[l+1],i=o[l+2],n=o[l+3],r=o[l+4],a=o[l+5],e[6*d+0]=t,e[6*d+1]=s,e[6*d+2]=i,e[6*d+3]=n,e[6*d+4]=r,e[6*d+5]=a;}}calcFocalPoint(e){let{chunkData:t,numChunks:s,chunkSize:i}=this;e.x=0,e.y=0,e.z=0;for(let n=0;n<s;++n){let s=n*i;e.x+=t[s+0]+t[s+3],e.y+=t[s+1]+t[s+4],e.z+=t[s+2]+t[s+5];}e.mulScalar(.5/s);}get isCompressed(){return  true}get numChunks(){return Math.ceil(this.numSplats/256)}get chunkSize(){return this.chunkData.length/this.numChunks}decompress(){let e=["x","y","z","f_dc_0","f_dc_1","f_dc_2","opacity","scale_0","scale_1","scale_2","rot_0","rot_1","rot_2","rot_3"],{shBands:t}=this;if(t>0){let t=[];for(let e=0;e<45;++e)t.push("f_rest_"+e);e.splice(e.indexOf("f_dc_0")+1,0,...t);}let s={};e.forEach(e=>{s[e]=new Float32Array(this.numSplats);});let i=new eu,n=new eT,r=new eu,a=new em,o=t>0?new Float32Array(45):null,l=this.createIter(i,n,r,a,o);for(let e=0;e<this.numSplats;++e)if(l.read(e),s.x[e]=i.x,s.y[e]=i.y,s.z[e]=i.z,s.rot_1[e]=n.x,s.rot_2[e]=n.y,s.rot_3[e]=n.z,s.rot_0[e]=n.w,s.scale_0[e]=r.x,s.scale_1[e]=r.y,s.scale_2[e]=r.z,s.f_dc_0[e]=(a.x-.5)/.28209479177387814,s.f_dc_1[e]=(a.y-.5)/.28209479177387814,s.f_dc_2[e]=(a.z-.5)/.28209479177387814,s.opacity[e]=a.w<=0?-40:a.w>=1?40:-Math.log(1/a.w-1),o)for(let t=0;t<45;++t)s["f_rest_"+t][e]=o[t];return new c0([{name:"vertex",count:this.numSplats,properties:e.map(e=>({name:e,type:"float",byteSize:4,storage:s[e]}))}])}}function v2(){return (v2=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i]);}return e}).apply(this,arguments)}let v3=(e,t,s,i,n)=>{for(let r=0;r<n;++r)for(let n=0;n<i;++n)e[r*t+n]=s[r*i+n];};class v4{destroy(){var e,t,s,i,n;null==(e=this.packedTexture)||e.destroy(),null==(t=this.chunkTexture)||t.destroy(),null==(s=this.shTexture0)||s.destroy(),null==(i=this.shTexture1)||i.destroy(),null==(n=this.shTexture2)||n.destroy();}createMaterial(e){let t=c1(e);return t.setDefine("GSPLAT_COMPRESSED_DATA",true),t.setParameter("packedTexture",this.packedTexture),t.setParameter("chunkTexture",this.chunkTexture),t.setParameter("numSplats",this.numSplatsVisible),this.shTexture0?(t.setDefine("SH_BANDS",3),t.setParameter("shTexture0",this.shTexture0),t.setParameter("shTexture1",this.shTexture1),t.setParameter("shTexture2",this.shTexture2)):t.setDefine("SH_BANDS",0),t}evalTextureSize(e){let t=Math.ceil(Math.sqrt(e)),s=Math.ceil(e/t);return new ef(t,s)}createTexture(e,t,s,i){return new se(this.device,v2({name:e,width:s.x,height:s.y,format:t,cubemap:false,mipmaps:false,minFilter:0,magFilter:0,addressU:1,addressV:1},i?{levels:[i]}:{}))}constructor(e,t){let{chunkData:s,chunkSize:i,numChunks:n,numSplats:r,vertexData:a,shBands:o}=t;this.device=e,this.numSplats=r,this.numSplatsVisible=r,this.aabb=new eP,t.calcAabb(this.aabb),this.centers=new Float32Array(3*r),t.getCenters(this.centers),this.chunks=new Float32Array(6*n),t.getChunks(this.chunks),this.packedTexture=this.createTexture("packedData",49,this.evalTextureSize(r),a);let l=this.evalTextureSize(n);l.x*=5,this.chunkTexture=this.createTexture("chunkData",14,l);let h=this.chunkTexture.lock();if(v3(h,20,s,i,n),12===i)for(let e=0;e<n;++e)h[20*e+15]=1,h[20*e+16]=1,h[20*e+17]=1;if(this.chunkTexture.unlock(),o>0){let e=this.evalTextureSize(r);this.shTexture0=this.createTexture("shTexture0",49,e,new Uint32Array(t.shData0.buffer)),this.shTexture1=this.createTexture("shTexture1",49,e,new Uint32Array(t.shData1.buffer)),this.shTexture2=this.createTexture("shTexture2",49,e,new Uint32Array(t.shData2.buffer));}else this.shTexture0=null,this.shTexture1=null,this.shTexture2=null;}}class v5{destroy(){}createMaterial(e){let{gsplatData:t}=this,s=c1(e);return s.setDefine("GSPLAT_SOGS_DATA",true),s.setDefine("SH_BANDS",this.gsplatData.shBands),["means_l","means_u","quats","scales","opacities","sh0","sh_centroids","sh_labels_u","sh_labels_l"].forEach(e=>{s.setParameter(e,t[e]);}),["means","quats","scales","opacities","sh0","shN"].forEach(e=>{let i=t.meta[e];i&&(s.setParameter(""+e+"_mins",i.mins),s.setParameter(""+e+"_maxs",i.maxs));}),s}evalTextureSize(e){return new ef(this.gsplatData.means_l.width,this.gsplatData.means_l.height)}createTexture(e,t,s){return new se(this.device,{name:e,width:s.x,height:s.y,format:t,cubemap:false,mipmaps:false,minFilter:0,magFilter:0,addressU:1,addressV:1})}constructor(e,t){this.device=e,this.gsplatData=t;let{meta:s}=t;this.numSplats=s.means.shape[0],this.numSplatsVisible=this.numSplats,this.aabb=new eP,t.calcAabb(this.aabb),this.centers=new Float32Array(3*this.numSplats),t.getCenters(this.centers);}}class v6{destroy(){var e;this.app=null,this.splatData=null,null==(e=this.splat)||e.destroy(),this.splat=null;}createSplat(){if(!this.splat){let{app:e,splatData:t}=this,s=t.isCompressed?v4:t.isSogs?v5:c3;this.splat=new s(e.graphicsDevice,t);}return this.splat}instantiate(e){ void 0===e&&(e={});let t=this.createInstance(e),s=new uG(void 0,this.app),i=s.addComponent("gsplat",{instance:t});return s.setLocalEulerAngles(0,0,180),i.customAabb=t.splat.aabb.clone(),s}createInstance(e){return void 0===e&&(e={}),new ue(this.createSplat(),e)}constructor(e,t,s){this.splat=null,this.comments=null,this.app=e,this.splatData=t,this.comments=s;}}let v8=new Uint8Array([112,108,121,10]),v9=new Uint8Array([10,101,110,100,95,104,101,97,100,101,114,10]),v7=new Map([["char",Int8Array],["uchar",Uint8Array],["short",Int16Array],["ushort",Uint16Array],["int",Int32Array],["uint",Uint32Array],["float",Float32Array],["double",Float64Array]]);class ye{async read(){let{value:e,done:t}=await this.reader.read();if(t)throw Error("Stream finished before end of header");this.push(e),null==this.progressFunc||this.progressFunc.call(this,e.byteLength);}push(e){if(this.data){let t=this.tail-this.head,s=t+e.length;if(this.data.length>=s)this.head>0?(this.data.copyWithin(0,this.head,this.tail),this.data.set(e,t),this.head=0,this.tail=s):(this.data.set(e,this.tail),this.tail+=e.length);else {let i=new Uint8Array(s);this.head>0||this.tail<this.data.length?i.set(this.data.subarray(this.head,this.tail),0):i.set(this.data,0),i.set(e,t),this.data=i,this.view=new DataView(this.data.buffer),this.head=0,this.tail=s;}}else this.data=e,this.view=new DataView(this.data.buffer),this.tail=e.length;}compact(){this.head>0&&(this.data.copyWithin(0,this.head,this.tail),this.tail-=this.head,this.head=0);}get remaining(){return this.tail-this.head}getInt8(){let e=this.view.getInt8(this.head);return this.head++,e}getUint8(){let e=this.view.getUint8(this.head);return this.head++,e}getInt16(){let e=this.view.getInt16(this.head,true);return this.head+=2,e}getUint16(){let e=this.view.getUint16(this.head,true);return this.head+=2,e}getInt32(){let e=this.view.getInt32(this.head,true);return this.head+=4,e}getUint32(){let e=this.view.getUint32(this.head,true);return this.head+=4,e}getFloat32(){let e=this.view.getFloat32(this.head,true);return this.head+=4,e}getFloat64(){let e=this.view.getFloat64(this.head,true);return this.head+=8,e}constructor(e,t){this.head=0,this.tail=0,this.reader=e,this.progressFunc=t;}}let yt=e=>{let t;let s=[],i=[];for(let n=1;n<e.length;++n){let r=e[n].split(" ");switch(r[0]){case "comment":i.push(r.slice(1).join(" "));break;case "format":t=r[1];break;case "element":s.push({name:r[1],count:parseInt(r[2],10),properties:[]});break;case "property":if(!v7.has(r[1]))throw Error("Unrecognized property data type '"+r[1]+"' in ply header");s[s.length-1].properties.push({type:r[1],name:r[2],storage:null,byteSize:v7.get(r[1]).BYTES_PER_ELEMENT});break;default:throw Error("Unrecognized header value '"+r[0]+"' in ply header")}}return {elements:s,format:t,comments:i}},ys=e=>{let t=["min_x","min_y","min_z","max_x","max_y","max_z","min_scale_x","min_scale_y","min_scale_z","max_scale_x","max_scale_y","max_scale_z","min_r","min_g","min_b","max_r","max_g","max_b"],s=["packed_position","packed_rotation","packed_scale","packed_color"],i=Array(45).fill("").map((e,t)=>"f_rest_"+t),n=()=>"chunk"===e[0].name&&e[0].properties.every((e,s)=>e.name===t[s]&&"float"===e.type)&&"vertex"===e[1].name&&e[1].properties.every((e,t)=>e.name===s[t]&&"uint"===e.type);return 2===e.length&&n()||3===e.length&&n()&&"sh"===e[2].name&&-1!==[9,24,45].indexOf(e[2].properties.length)&&e[2].properties.every((e,t)=>e.name===i[t]&&"uchar"===e.type)},yi=e=>1===e.length&&"vertex"===e[0].name&&e[0].properties.every(e=>"float"===e.type),yn=async(e,t)=>{let s=new v1,i=t[0].count,n=t[0].properties.length,r=t[1].count,a=(e=>{let t=Math.ceil(Math.sqrt(e)),s=Math.ceil(e/t);return t*s})(r);s.numSplats=r,s.chunkData=new Float32Array(i*n),s.vertexData=new Uint32Array(4*a);let o=async(t,s)=>{let i=new Uint8Array(t),n=0;for(;n<s;){for(;0===e.remaining;)await e.read();let t=Math.min(s-n,e.remaining),r=e.data;for(let s=0;s<t;++s)i[n++]=r[e.head++];}};if(await o(s.chunkData.buffer,i*n*4),await o(s.vertexData.buffer,16*r),3===t.length){let e=16*a,i=new Uint8Array(e),n=new Uint8Array(e),r=new Uint8Array(e),l=t[2].properties.length/3,h=new Uint8Array(1024*l*3);for(let e=0;e<s.numSplats;e+=1024){let t=Math.min(1024,s.numSplats-e);await o(h.buffer,t*l*3);for(let s=0;s<t;++s)for(let t=0;t<15;++t){let a=(e+s)*16+t;t<l?(i[a]=h[(3*s+0)*l+t],n[a]=h[(3*s+1)*l+t],r[a]=h[(3*s+2)*l+t]):(i[a]=127,n[a]=127,r[a]=127);}}s.shData0=i,s.shData1=n,s.shData2=r,s.shBands=({3:1,8:2,15:3})[l];}else s.shBands=0;return s},yr=async(e,t)=>{let s;let i=t[0],n=i.properties,r=n.length,a=n.map(e=>e.storage),o=n.reduce((e,t)=>e+t.byteSize,0),l=0,h=()=>{let t=e.data.buffer;(null==s?void 0:s.buffer)!==t&&(s=new Float32Array(t,0,t.byteLength/4));};for(h();l<i.count;){for(;e.remaining<o;)await e.read(),h();let t=Math.min(i.count-l,Math.floor(e.remaining/o));for(let e=0;e<r;++e){let i=a[e];for(let n=0;n<t;++n)i[n+l]=s[n*r+e];}l+=t,e.head+=t*o;}return new c0(t)},ya=async(e,t)=>{for(let s=0;s<t.length;++s){let i=t[s],n=i.properties.reduce((e,t)=>e+t.byteSize,0),r=i.properties.map(e=>{if(!e.storage)return t=>{t.head+=e.byteSize;};switch(e.type){case "char":return (t,s)=>{e.storage[s]=t.getInt8();};case "uchar":return (t,s)=>{e.storage[s]=t.getUint8();};case "short":return (t,s)=>{e.storage[s]=t.getInt16();};case "ushort":return (t,s)=>{e.storage[s]=t.getUint16();};case "int":return (t,s)=>{e.storage[s]=t.getInt32();};case "uint":return (t,s)=>{e.storage[s]=t.getUint32();};case "float":return (t,s)=>{e.storage[s]=t.getFloat32();};case "double":return (t,s)=>{e.storage[s]=t.getFloat64();};default:throw Error("Unsupported property data type '"+e.type+"' in ply header")}}),a=0;for(;a<i.count;){for(;e.remaining<n;)await e.read();let t=Math.min(i.count-a,Math.floor(e.remaining/n));for(let s=0;s<t;++s){for(let t=0;t<i.properties.length;++t)r[t](e,a);a++;}}}return new c0(t)},yo=async(e,t,s)=>{let i;void 0===t&&(t=null),void 0===s&&(s=null);let n=(e,t)=>{let s,i;let n=e.length-t.length;for(s=0;s<=n;++s){for(i=0;i<t.length&&e[s+i]===t[i];++i);if(i===t.length)return s}return -1},r=(e,t)=>{if(e.length<t.length)return  false;for(let s=0;s<t.length;++s)if(e[s]!==t[s])return  false;return  true},a=new ye(e,s);for(;;){if(await a.read(),a.tail>=v8.length&&!r(a.data,v8))throw Error("Invalid ply header");if(-1!==(i=n(a.data,v9)))break}let{elements:o,format:l,comments:h}=yt(new TextDecoder("ascii").decode(a.data.subarray(0,i)).split("\n"));if("binary_little_endian"!==l)throw Error("Unsupported ply format");a.head=i+v9.length,a.compact();let d=async()=>ys(o)?await yn(a,o):(o.forEach(e=>{e.properties.forEach(s=>{let i=v7.get(s.type);if(i){let n=!t||t(s.name)?new i(e.count):null;s.storage=n;}});}),yi(o))?await yr(a,o):await ya(a,o);return {data:await d(),comments:h}},yl=e=>true;class yh{async load(e,t,s){try{var i,n,r,a,o;let l=await (null!=(n=null==(i=s.file)?void 0:i.contents)?n:fetch(e.load));if(l&&l.body){let e=parseInt(null!=(r=l.headers.get("content-length"))?r:"0",10),i=0,{data:n,comments:h}=await yo(l.body.getReader(),null!=(a=s.data.elementFilter)?a:yl,t=>{i+=t,s&&s.fire("progress",i,e);});!n.isCompressed&&(null==(o=s.data.reorder)||o)&&n.reorderData();let d=new v6(this.app,n.isCompressed&&s.data.decompress?n.decompress():n,h);t(null,d);}else t("Error loading resource",null);}catch(e){t(e,null);}}open(e,t){return t}constructor(e,t){this.app=e,this.maxRetries=t;}}let yd=null,yc=null,yu=e=>(yd&&yd.width===e.width&&yd.height===e.height||((yc=(yd=new OffscreenCanvas(e.width,e.height)).getContext("2d")).globalCompositeOperation="copy"),yc.drawImage(e,0,0),yc.getImageData(0,0,e.width,e.height).data);class yp{constructor(e,t,s,i,n,r){let a=(e,t,s)=>e*(1-s)+t*s,{meta:o}=e,{means:l,quats:h,scales:d,opacities:c,sh0:u,shN:p}=o,f=t&&yu(e.means_l._levels[0]),m=t&&yu(e.means_u._levels[0]),_=s&&yu(e.quats._levels[0]),g=i&&yu(e.scales._levels[0]),v=n&&yu(e.opacities._levels[0]),y=n&&yu(e.sh0._levels[0]),S=r&&yu(e.sh_labels_l._levels[0]),x=r&&yu(e.sh_labels_u._levels[0]),T=r&&yu(e.sh_centroids._levels[0]);this.read=o=>{if(t){let e=a(l.mins[0],l.maxs[0],((m[4*o+0]<<8)+f[4*o+0])/65535),s=a(l.mins[1],l.maxs[1],((m[4*o+1]<<8)+f[4*o+1])/65535),i=a(l.mins[2],l.maxs[2],((m[4*o+2]<<8)+f[4*o+2])/65535);t.x=Math.sign(e)*(Math.exp(Math.abs(e))-1),t.y=Math.sign(s)*(Math.exp(Math.abs(s))-1),t.z=Math.sign(i)*(Math.exp(Math.abs(i))-1);}if(s){let e=a(h.mins[0],h.maxs[0],_[4*o+0]/255),t=a(h.mins[1],h.maxs[1],_[4*o+1]/255),i=a(h.mins[2],h.maxs[2],_[4*o+2]/255),n=Math.sqrt(Math.max(0,1-(e*e+t*t+i*i)));s.set(t,i,n,e);}if(i){let e=a(d.mins[0],d.maxs[0],g[4*o+0]/255),t=a(d.mins[1],d.maxs[1],g[4*o+1]/255),s=a(d.mins[2],d.maxs[2],g[4*o+2]/255);i.set(e,t,s);}if(n){let e=a(u.mins[0],u.maxs[0],y[4*o+0]/255),t=a(u.mins[1],u.maxs[1],y[4*o+1]/255),s=a(u.mins[2],u.maxs[2],y[4*o+2]/255),i=a(c.mins[0],c.maxs[0],v[4*o+0]/255);n.set(.5+.28209479177387814*e,.5+.28209479177387814*t,.5+.28209479177387814*s,1/(1+Math.exp(-1*i)));}if(r){let t=S[4*o+0]+(x[4*o+0]<<8),s=t%64*15,i=Math.floor(t/64);for(let t=0;t<3;++t)for(let n=0;n<15;++n)r[15*t+n]=a(p.mins,p.maxs,T[(s+n)*4+t+i*e.sh_centroids.width*4]/255);}};}}class yf{createIter(e,t,s,i,n){return new yp(this,e,t,s,i,n)}calcAabb(e){let{mins:t,maxs:s}=this.meta.means,i=e=>Math.sign(e)*(Math.exp(Math.abs(e))-1);e.center.set((i(t[0])+i(s[0]))*.5,(i(t[1])+i(s[1]))*.5,(i(t[2])+i(s[2]))*.5),e.halfExtents.set((i(s[0])-i(t[0]))*.5,(i(s[1])-i(t[1]))*.5,(i(s[2])-i(t[2]))*.5);}getCenters(e){let t=new eu,s=this.createIter(t);for(let i=0;i<this.numSplats;i++)s.read(i),e[3*i+0]=t.x,e[3*i+1]=t.y,e[3*i+2]=t.z;}calcFocalPoint(e,t){e.set(0,0,0);}get isSogs(){return  true}decompress(){let e=["x","y","z","f_dc_0","f_dc_1","f_dc_2","opacity","scale_0","scale_1","scale_2","rot_0","rot_1","rot_2","rot_3"],{shBands:t}=this;if(t>0){let t=[];for(let e=0;e<45;++e)t.push("f_rest_"+e);e.splice(e.indexOf("f_dc_0")+1,0,...t);}let s={};e.forEach(e=>{s[e]=new Float32Array(this.numSplats);});let i=new eu,n=new eT,r=new eu,a=new em,o=t>0?new Float32Array(45):null,l=this.createIter(i,n,r,a,o);for(let e=0;e<this.numSplats;++e)if(l.read(e),s.x[e]=i.x,s.y[e]=i.y,s.z[e]=i.z,s.rot_1[e]=n.x,s.rot_2[e]=n.y,s.rot_3[e]=n.z,s.rot_0[e]=n.w,s.scale_0[e]=r.x,s.scale_1[e]=r.y,s.scale_2[e]=r.z,s.f_dc_0[e]=(a.x-.5)/.28209479177387814,s.f_dc_1[e]=(a.y-.5)/.28209479177387814,s.f_dc_2[e]=(a.z-.5)/.28209479177387814,s.opacity[e]=a.w<=0?-40:a.w>=1?40:-Math.log(1/a.w-1),o)for(let t=0;t<45;++t)s["f_rest_"+t][e]=o[t];return new c0([{name:"vertex",count:this.numSplats,properties:e.map(e=>({name:e,type:"float",byteSize:4,storage:s[e]}))}])}}class ym{async loadTextures(e,t,s,i){var n,r,a,o,l,h,d,c,u,p,f;let{assets:m}=this.app,_={},g=[];["means","opacities","quats","scales","sh0","shN"].forEach(t=>{var n,r;let a=null!=(r=null==(n=i[t])?void 0:n.files)?r:[];_[t]=a.map(t=>{var i,n,r;let a=new ub(t,"texture",{url:null!=(r=null==(n=s.options)?void 0:null==(i=n.mapUrl)?void 0:i.call(n,t))?r:new URL(t,e.load).toString(),filename:t},{mipmaps:false}),o=new Promise((e,t)=>{a.on("load",()=>e(null)),a.on("error",e=>t(e));});return m.add(a),m.load(a),g.push(o),a});}),await Promise.allSettled(g);let v=new yf;v.meta=i,v.numSplats=i.means.shape[0],v.shBands=null!=(f=({192:1,512:2,960:3})[null==(a=_.shN)?void 0:null==(r=a[0])?void 0:null==(n=r.resource)?void 0:n.width])?f:0,v.means_l=_.means[0].resource,v.means_u=_.means[1].resource,v.opacities=_.opacities[0].resource,v.quats=_.quats[0].resource,v.scales=_.scales[0].resource,v.sh0=_.sh0[0].resource,v.sh_centroids=null==(l=_.shN)?void 0:null==(o=l[0])?void 0:o.resource,v.sh_labels_l=null==(d=_.shN)?void 0:null==(h=d[1])?void 0:h.resource,v.sh_labels_u=null==(u=_.shN)?void 0:null==(c=u[2])?void 0:c.resource,t(null,new v6(this.app,(null==(p=s.data)?void 0:p.decompress)?v.decompress():v,[]));}load(e,t,s){var i;if(null==(i=s.data)?void 0:i.means)this.loadTextures(e,t,s,s.data);else {"string"==typeof e&&(e={load:e,original:e});let i={retry:this.maxRetries>0,maxRetries:this.maxRetries,responseType:rI.ResponseType.JSON};rR.get(e.load,i,(i,n)=>{i?t("Error loading gsplat meta: "+e.original+" ["+i+"]"):this.loadTextures(e,t,s,n);});}}constructor(e,t){this.app=e,this.maxRetries=t;}}class y_ extends uI{_getUrlWithoutParams(e){return e.indexOf("?")>=0?e.split("?")[0]:e}_getParser(e){let t=M.getExtension(this._getUrlWithoutParams(e)).toLowerCase().replace(".","");return this.parsers[t]||this.parsers.ply}load(e,t,s){"string"==typeof e&&(e={load:e,original:e}),this._getParser(e.original).load(e,t,s);}open(e,t,s){return t}constructor(e){super(e,"gsplat"),this.parsers={ply:new yh(e,3),json:new ym(e,3)};}}class yg{static setCompressedPRS(e,t,s){let i,n;let r=s.singleVecs,a=t.___1;a||(i=s.tripleVecs,n=t.___2);let o=a?a[0]:i[n];e.setLocalPosition(r[o],r[o+1],r[o+2]),o=a?a[1]:i[n+1],e.setLocalEulerAngles(r[o],r[o+1],r[o+2]),o=a?a[2]:i[n+2],e.setLocalScale(r[o],r[o+1],r[o+2]);}static oneCharToKey(e,t){let s=e.charCodeAt(0)-t.fieldFirstCode;return t.fieldArray[s]}static multCharToKey(e,t){let s=0;for(let i=0;i<e.length;i++)s=s*t.fieldCodeBase+e.charCodeAt(i)-t.fieldFirstCode;return t.fieldArray[s]}}class yv{run(){let e=Object.prototype.toString.call(this._node);return "[object Object]"===e?this._handleMap():"[object Array]"===e?this._handleArray():this._result=this._node,this._result}_handleMap(){this._result={},Object.keys(this._node).forEach(this._handleKey,this);}_handleKey(e){let t=e,s=e.length;1===s?t=yg.oneCharToKey(e,this._data):2===s&&(t=yg.multCharToKey(e,this._data)),this._result[t]=new yv(this._node[e],this._data).run();}_handleArray(){this._result=[],this._node.forEach(this._handleArElt,this);}_handleArElt(e){let t=new yv(e,this._data).run();this._result.push(t);}constructor(e,t){this._node=e,this._data=t;}}class yy{parse(e){let t={},s=null,i=e.compressedFormat;for(let n in i&&!e.entDecompressed&&(e.entDecompressed=true,e.entities=new yv(e.entities,i).run()),e.entities){let r=e.entities[n],a=this._createEntity(r,i);t[n]=a,null===r.parent&&(s=a);}for(let s in e.entities){let i=t[s],n=e.entities[s].children,r=n.length;for(let e=0;e<r;e++){let s=t[n[e]];s&&i.addChild(s);}}return this._openComponentData(s,e.entities),s}_createEntity(e,t){var s;let i=new uG(e.name,this._app);if(i.setGuid(e.resource_id),this._setPosRotScale(i,e,t),i._enabled=null==(s=e.enabled)||s,this._isTemplate?i._template=true:i._enabledInHierarchy=i._enabled,i.template=e.template,e.tags)for(let t=0;t<e.tags.length;t++)i.tags.add(e.tags[t]);return i}_setPosRotScale(e,t,s){if(s)yg.setCompressedPRS(e,t,s);else {let s=t.position,i=t.rotation,n=t.scale;e.setLocalPosition(s[0],s[1],s[2]),e.setLocalEulerAngles(i[0],i[1],i[2]),e.setLocalScale(n[0],n[1],n[2]);}}_openComponentData(e,t){let s=this._app.systems.list,i=s.length,n=t[e.getGuid()];for(let t=0;t<i;t++){let i=s[t],r=n.components[i.id];r&&i.addComponent(e,r);}i=n.children.length;let r=e._children;for(let e=0;e<i;e++)r[e]&&(r[e]=this._openComponentData(r[e],t));return e}constructor(e,t){this._app=e,this._isTemplate=t;}}class yS{static load(e,t,s){"string"==typeof e&&(e={load:e,original:e}),rR.get(e.load,{retry:t>0,maxRetries:t},(t,i)=>{if(t){let i="Error while loading scene JSON "+e.original;t.message?(i+=": "+t.message,t.stack&&(i+="\n"+t.stack)):i+=": "+t,s(i);}else s(t,i);});}}class yx extends uI{load(e,t){yS.load(e,this.maxRetries,t);}open(e,t){this._app.systems.script.preloading=true;let s=new yy(this._app,false).parse(t);return this._app.systems.script.preloading=false,s}constructor(e){super(e,"hierarchy");}}class yT extends uI{load(e,t){"string"==typeof e&&(e={load:e,original:e}),rR.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(s,i)=>{s?t("Error loading html resource: "+e.original+" ["+s+"]"):t(null,i);});}openBinary(e){return null!=this.decoder||(this.decoder=new TextDecoder("utf-8")),this.decoder.decode(e)}constructor(e){super(e,"html"),this.decoder=null;}}class yb extends uI{load(e,t){"string"==typeof e&&(e={load:e,original:e});let s={retry:this.maxRetries>0,maxRetries:this.maxRetries};e.load.startsWith("blob:")&&(s.responseType=rI.ResponseType.JSON),rR.get(e.load,s,(s,i)=>{s?t("Error loading JSON resource: "+e.original+" ["+s+"]"):t(null,i);});}openBinary(e){return null!=this.decoder||(this.decoder=new TextDecoder("utf-8")),JSON.parse(this.decoder.decode(e))}constructor(e){super(e,"json"),this.decoder=null;}}class yE{setInvalid(e,t){this.valid=false,this.removeInvalid&&delete t[e];}validate(e){let t="path"===e.mappingFormat;for(let s in e){let i=cS[s];if(!i){cb[s]?delete e[s]:this.valid=false;continue}if(i.startsWith("enum")){let t=i.split(":")[1];this.enumValidators[t]&&!this.enumValidators[t](e[s])&&this.setInvalid(s,e);}else if("number"===i)"number"!=typeof e[s]&&this.setInvalid(s,e);else if("boolean"===i)"boolean"!=typeof e[s]&&this.setInvalid(s,e);else if("string"===i)"string"!=typeof e[s]&&this.setInvalid(s,e);else if("vec2"===i)e[s]instanceof Array&&2===e[s].length||this.setInvalid(s,e);else if("rgb"===i)e[s]instanceof Array&&3===e[s].length||this.setInvalid(s,e);else if("texture"===i)t?"string"==typeof e[s]||null===e[s]||e[s]instanceof se||this.setInvalid(s,e):"number"==typeof e[s]||null===e[s]||e[s]instanceof se||this.setInvalid(s,e);else if("boundingbox"===i)e[s].center&&e[s].center instanceof Array&&3===e[s].center.length||this.setInvalid(s,e),e[s].halfExtents&&e[s].halfExtents instanceof Array&&3===e[s].halfExtents.length||this.setInvalid(s,e);else if("cubemap"===i)"number"==typeof e[s]||null===e[s]||void 0===e[s]||e[s]instanceof se&&e[s].cubemap||this.setInvalid(s,e);else if("chunks"===i){let t=Object.keys(e[s]);for(let i=0;i<t.length;i++)"string"!=typeof e[s][t[i]]&&this.setInvalid(t[i],e[s]);}}return e.validated=true,this.valid}_createEnumValidator(e){return function(t){return e.indexOf(t)>=0}}constructor(){this.removeInvalid=true,this.valid=true,this.enumValidators={occludeSpecular:this._createEnumValidator([0,1,2]),cull:this._createEnumValidator([0,1,2,3]),blendType:this._createEnumValidator([0,1,2,3,4,5,6,7,8,9,10]),depthFunc:this._createEnumValidator([0,1,2,3,4,5,6,7])};}}function yA(){return (yA=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i]);}return e}).apply(this,arguments)}class yw{parse(e){let t=this.migrate(e),s=this._validate(t),i=new cP;return this.initialize(i,s),i}initialize(e,t){for(let s in t.validated||(t=this._validate(t)),t.chunks&&(e.chunks=yA({},t.chunks)),t){let i=cS[s],n=t[s];if("vec2"===i)e[s]=new ef(n[0],n[1]);else if("rgb"===i)e[s]=new en(n[0],n[1],n[2]);else if("texture"===i)n instanceof se?e[s]=n:e[s]instanceof se&&"number"==typeof n&&n>0||(e[s]=null);else if("cubemap"===i)n instanceof se?e[s]=n:e[s]instanceof se&&"number"==typeof n&&n>0||(e[s]=null),"cubeMap"!==s||n||(e.prefilteredCubemaps=null);else if("boundingbox"===i){let t=new eu(n.center[0],n.center[1],n.center[2]),i=new eu(n.halfExtents[0],n.halfExtents[1],n.halfExtents[2]);e[s]=new eP(t,i);}else e[s]=t[s];}e.update();}migrate(e){let t;e.shader&&delete e.shader,e.mapping_format&&(e.mappingFormat=e.mapping_format,delete e.mapping_format);let s=[["bumpMapFactor","bumpiness"],["aoUvSet","aoMapUv"],["aoMapVertexColor","aoVertexColor"],["diffuseMapVertexColor","diffuseVertexColor"],["emissiveMapVertexColor","emissiveVertexColor"],["specularMapVertexColor","specularVertexColor"],["metalnessMapVertexColor","metalnessVertexColor"],["opacityMapVertexColor","opacityVertexColor"],["glossMapVertexColor","glossVertexColor"],["lightMapVertexColor","lightVertexColor"],["specularMapTint","specularTint"],["metalnessMapTint","metalnessTint"],["clearCoatGlossiness","clearCoatGloss"]];for(t=0;t<s.length;t++){let i=s[t][0],n=s[t][1];void 0!==e[i]&&(void 0===e[n]&&(e[n]=e[i]),delete e[i]);}let i=["fresnelFactor","shadowSampleType"];for(t=0;t<i.length;t++){let s=i[t];e.hasOwnProperty(s)&&delete e[s];}return e}_validate(e){return e.validated||(this._validator||(this._validator=new yE),this._validator.validate(e)),e}constructor(){this._validator=null;}}let yC={aoMap:"white",aoDetailMap:"white",diffuseMap:"gray",diffuseDetailMap:"gray",specularMap:"gray",specularityFactorMap:"white",metalnessMap:"black",glossMap:"gray",sheenMap:"black",sheenGlossMap:"gray",clearCoatMap:"black",clearCoatGlossMap:"gray",clearCoatNormalMap:"normal",refractionMap:"white",emissiveMap:"gray",normalMap:"normal",normalDetailMap:"normal",heightMap:"gray",opacityMap:"gray",sphereMap:"gray",lightMap:"white",thicknessMap:"black",iridescenceMap:"black",iridescenceThicknessMap:"black",envAtlas:"black"};class yP extends uI{load(e,t){"string"==typeof e&&(e={load:e,original:e}),rR.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(s,i)=>{s?t&&t("Error loading material: "+e.original+" ["+s+"]"):t&&(i._engine=true,t(null,i));});}open(e,t){let s=this._parser.parse(t);return t._engine&&(s._data=t,delete t._engine),s}patch(e,t){e.resource._data&&(e._data=e.resource._data,delete e.resource._data),e.data.name=e.name,e.resource.name=e.name,this._bindAndAssignAssets(e,t),e.off("unload",this._onAssetUnload,this),e.on("unload",this._onAssetUnload,this);}_onAssetUnload(e){delete e.data.parameters,delete e.data.chunks,delete e.data.name;}_assignTexture(e,t,s){t.resource[e]=s;}_getPlaceholderTexture(e){let t=yC[e];return sn(this._device,t)}_assignPlaceholderTexture(e,t){t.resource[e]=this._getPlaceholderTexture(e);}_onTextureLoad(e,t,s){this._assignTexture(e,t,s.resource),t.resource.update();}_onTextureAdd(e,t,s){this._assets.load(s);}_onTextureRemoveOrUnload(e,t,s){let i=t.resource;i&&t.resource[e]===s.resource&&(this._assignPlaceholderTexture(e,t),i.update());}_assignCubemap(e,t,s){if(t.resource[e]=s[0],"cubeMap"===e){let e=s.slice(1);e.every(e=>e)?t.resource.prefilteredCubemaps=e:e[0]&&(t.resource.envAtlas=e[0]);}}_onCubemapLoad(e,t,s){this._assignCubemap(e,t,s.resources),this._parser.initialize(t.resource,t.data);}_onCubemapAdd(e,t,s){this._assets.load(s);}_onCubemapRemoveOrUnload(e,t,s){let i=t.resource;t.data.prefilteredCubeMap128===s.resources[1]&&(this._assignCubemap(e,t,[null,null,null,null,null,null,null]),i.update());}_bindAndAssignAssets(e,t){let s,i,n;let r=this._parser.migrate(e.data),a=e.resource,o="path"===r.mappingFormat;for(s=0;s<cx.length;s++){i=cx[s],n=a._assetReferences[i];let l=r[i],h=a[i],d=h===this._getPlaceholderTexture(i),c=r.validated;l&&(!h||!c||d)?(n||(n=new m0(i,e,t,{load:this._onTextureLoad,add:this._onTextureAdd,remove:this._onTextureRemoveOrUnload,unload:this._onTextureRemoveOrUnload},this),a._assetReferences[i]=n),o?n.url=e.getAbsoluteUrl(l):n.id=l,n.asset&&(n.asset.resource?this._assignTexture(i,e,n.asset.resource):this._assignPlaceholderTexture(i,e),t.load(n.asset))):n&&(o?n.url=null:n.id=null);}for(s=0;s<cT.length;s++)i=cT[s],n=a._assetReferences[i],r[i]&&!e.data.prefilteredCubeMap128&&(n||(n=new m0(i,e,t,{load:this._onCubemapLoad,add:this._onCubemapAdd,remove:this._onCubemapRemoveOrUnload,unload:this._onCubemapRemoveOrUnload},this),a._assetReferences[i]=n),o?n.url=r[i]:n.id=r[i],n.asset&&(n.asset.loaded&&this._assignCubemap(i,e,n.asset.resources),t.load(n.asset)));this._parser.initialize(a,r);}constructor(e){super(e,"material"),this._assets=e.assets,this._device=e.graphicsDevice,this._parser=new yw;}}class yM{parse(e,t,s){var i;vB.parse("filename.glb","",e,this._device,this._assets,null!=(i=null==s?void 0:s.options)?i:{},(e,s)=>{if(e)t(e);else {let e=vX.createModel(s,this._defaultMaterial);s.destroy(),t(null,e);}});}constructor(e){this._device=e.device,this._defaultMaterial=e.defaultMaterial,this._assets=e.assets;}}let yI={points:0,lines:1,lineloop:2,linestrip:3,triangles:4,trianglestrip:5,trianglefan:6},yR={int8:0,uint8:1,int16:2,uint16:3,int32:4,uint32:5,float32:6};class yL{parse(e,t){let s=e.model;if(!s){t(null,null);return}if(s.version<=1){t("JsonModelParser#parse: Trying to parse unsupported model format.");return}let i=this._parseNodes(e),n=this._parseSkins(e,i),r=this._parseVertexBuffers(e),a=this._parseIndexBuffers(e,r),o=this._parseMorphs(e,i,r),l=this._parseMeshes(e,n.skins,o.morphs,r,a.buffer,a.data),h=this._parseMeshInstances(e,i,l,n.skins,n.instances,o.morphs,o.instances),d=new hh;d.graph=i[0],d.meshInstances=h,d.skinInstances=n.instances,d.morphInstances=o.instances,d.getGraph().syncHierarchy(),t(null,d);}_parseNodes(e){let t;let s=e.model,i=[];for(t=0;t<s.nodes.length;t++){let e=s.nodes[t],n=new oE(e.name);n.setLocalPosition(e.position[0],e.position[1],e.position[2]),n.setLocalEulerAngles(e.rotation[0],e.rotation[1],e.rotation[2]),n.setLocalScale(e.scale[0],e.scale[1],e.scale[2]),n.scaleCompensation=!!e.scaleCompensation,i.push(n);}for(t=1;t<s.parents.length;t++)i[s.parents[t]].addChild(i[t]);return i}_parseSkins(e,t){let s,i;let n=e.model,r=[],a=[];for(s=0;s<n.skins.length;s++){let e=n.skins[s],o=[];for(i=0;i<e.inverseBindMatrices.length;i++){let t=e.inverseBindMatrices[i];o[i]=new ex().set(t);}let l=new dZ(this._device,o,e.boneNames);r.push(l);let h=new aB(l),d=[];for(i=0;i<l.boneNames.length;i++){let e=l.boneNames[i],s=t[0].findByName(e);d.push(s);}h.bones=d,a.push(h);}return {skins:r,instances:a}}_getMorphVertexCount(e,t,s){for(let i=0;i<e.meshes.length;i++){let n=e.meshes[i];if(n.morph===t)return s[n.vertices].numVertices}}_parseMorphs(e,t,s){let i,n,r,a,o,l;let h=e.model,d=[],c=[];if(h.morphs){let e=function(e,t,s){let i=new Float32Array(3*s);for(let s=0;s<t.length;s++){let n=3*t[s];i[n]=e[3*s],i[n+1]=e[3*s+1],i[n+2]=e[3*s+2];}return i};for(i=0;i<h.morphs.length;i++){for(n=0,a=h.morphs[i].targets,l=[],r=this._getMorphVertexCount(h,i,s);n<a.length;n++){let t=a[n].aabb,s=t.min,i=t.max,h=new eP(new eu((i[0]+s[0])*.5,(i[1]+s[1])*.5,(i[2]+s[2])*.5),new eu((i[0]-s[0])*.5,(i[1]-s[1])*.5,(i[2]-s[2])*.5)),d=a[n].indices,c=a[n].deltaPositions,u=a[n].deltaNormals;d&&(c=e(c,d,r),u=e(u,d,r)),o=new hc({deltaPositions:c,deltaNormals:u,name:a[n].name,aabb:h}),l.push(o);}let t=new hd(l,this._device);d.push(t);let u=new hl(t);c.push(u);}}return {morphs:d,instances:c}}_parseVertexBuffers(e){let t=e.model,s=[],i={position:e2,normal:e3,tangent:e4,blendWeight:e5,blendIndices:e6,color:e8,texCoord0:e7,texCoord1:te,texCoord2:tt,texCoord3:ts,texCoord4:ti,texCoord5:tn,texCoord6:tr,texCoord7:ta};for(let e=0;e<t.vertices.length;e++){let n=t.vertices[e],r=[];for(let e in n){let t=n[e];r.push({semantic:i[e],components:t.components,type:yR[t.type],normalize:i[e]===e8});}let a=new sA(this._device,r),o=n.position.data.length/n.position.components,l=new sy(this._device,a,o),h=new re(l);for(let e=0;e<o;e++){for(let t in n){let s=n[t];switch(s.components){case 1:h.element[i[t]].set(s.data[e]);break;case 2:h.element[i[t]].set(s.data[2*e],1-s.data[2*e+1]);break;case 3:h.element[i[t]].set(s.data[3*e],s.data[3*e+1],s.data[3*e+2]);break;case 4:h.element[i[t]].set(s.data[4*e],s.data[4*e+1],s.data[4*e+2],s.data[4*e+3]);}}h.next();}h.end(),s.push(l);}return s}_parseIndexBuffers(e,t){let s;let i=e.model,n=null,r=null,a=0;for(s=0;s<i.meshes.length;s++){let e=i.meshes[s];void 0!==e.indices&&(a+=e.indices.length);}let o=0;for(s=0;s<t.length;s++)o=Math.max(o,t[s].numVertices);return a>0&&(r=o>65535?new Uint32Array((n=new nY(this._device,2,a)).lock()):new Uint16Array((n=new nY(this._device,1,a)).lock())),{buffer:n,data:r}}_parseMeshes(e,t,s,i,n,r){let a=e.model,o=[],l=0;for(let e=0;e<a.meshes.length;e++){let h=a.meshes[e],d=h.aabb,c=d.min,u=d.max,p=new eP(new eu((u[0]+c[0])*.5,(u[1]+c[1])*.5,(u[2]+c[2])*.5),new eu((u[0]-c[0])*.5,(u[1]-c[1])*.5,(u[2]-c[2])*.5)),f=void 0!==h.indices,m=new aG(this._device);m.vertexBuffer=i[h.vertices],m.indexBuffer[0]=f?n:null,m.primitive[0].type=yI[h.type],m.primitive[0].base=f?h.base+l:h.base,m.primitive[0].count=h.count,m.primitive[0].indexed=f,m.skin=void 0!==h.skin?t[h.skin]:null,m.morph=void 0!==h.morph?s[h.morph]:null,m.aabb=p,f&&(r.set(h.indices,l),l+=h.indices.length),o.push(m);}return null!==n&&n.unlock(),o}_parseMeshInstances(e,t,s,i,n,r,a){let o;let l=e.model,h=[];for(o=0;o<l.meshInstances.length;o++){let e=l.meshInstances[o],d=t[e.node],c=s[e.mesh],u=new a0(c,this._defaultMaterial,d);c.skin&&(u.skinInstance=n[i.indexOf(c.skin)]),c.morph&&(u.morphInstance=a[r.indexOf(c.morph)]),h.push(u);}return h}constructor(e){this._device=e.device,this._defaultMaterial=e.defaultMaterial;}}class yD extends uI{load(e,t,s){"string"==typeof e&&(e={load:e,original:e});let i={retry:this.maxRetries>0,maxRetries:this.maxRetries};(e.load.startsWith("blob:")||e.load.startsWith("data:"))&&(".glb"===M.getExtension(e.original).toLowerCase()?i.responseType=rI.ResponseType.ARRAY_BUFFER:i.responseType=rI.ResponseType.JSON),rR.get(e.load,i,(i,n)=>{if(t){if(i)t("Error loading model: "+e.original+" ["+i+"]");else {for(let i=0;i<this._parsers.length;i++){let r=this._parsers[i];if(r.decider(e.original,n)){r.parser.parse(n,(e,s)=>{e?t(e):t(null,s);},s);return}}t("No parsers found");}}});}open(e,t){return t}patch(e,t){if(!e.resource)return;let s=e.data,i=this;e.resource.meshInstances.forEach((n,r)=>{if(s.mapping){let a;let o=function(e){e.resource?n.material=e.resource:(e.once("load",o),t.load(e)),e.once("remove",e=>{n.material===e.resource&&(n.material=i.defaultMaterial);});};if(!s.mapping[r]){n.material=i.defaultMaterial;return}let l=s.mapping[r].material,h=s.mapping[r].path;if(void 0!==l)l?(a=t.get(l))?o(a):t.once("add:"+l,o):n.material=i.defaultMaterial;else if(h){let i=e.getAbsoluteUrl(s.mapping[r].path);(a=t.getByUrl(i))?o(a):t.once("add:url:"+i,o);}}});}addParser(e,t){this._parsers.push({parser:e,decider:t});}constructor(e){super(e,"model"),this._parsers=[],this.device=e.graphicsDevice,this.assets=e.assets,this.defaultMaterial=aW(this.device),this.addParser(new yL(this),(e,t)=>".json"===M.getExtension(e)),this.addParser(new yM(this),(e,t)=>".glb"===M.getExtension(e));}}class yO extends uI{load(e,t){yS.load(e,this.maxRetries,t);}open(e,t){this._app.systems.script.preloading=true;let s=new yy(this._app,false).parse(t),i=this._app.scene;return i.root=s,this._app.applySceneSettings(t.settings),this._app.systems.script.preloading=false,i}constructor(e){super(e,"scene");}}class yF{static push(e){yF._types.push(e);}}yF._types=[];let yN=new Set(["system","entity","create","destroy","swap","move","data","scripts","_scripts","_scriptsIndex","_scriptsData","enabled","_oldState","onEnable","onDisable","onPostStateChange","_onSetEnabled","_checkState","_onBeforeRemove","_onInitializeAttributes","_onInitialize","_onPostInitialize","_onUpdate","_onPostUpdate","_callbacks","_callbackActive","has","get","on","off","fire","once","hasEvent"]);function yB(e,t){if(yN.has(e))throw Error("Script name '"+e+"' is reserved, please rename the script");let s=function(e){Y.prototype.initEventHandler.call(this),gu.prototype.initScriptType.call(this,e);};return s.prototype=Object.create(gu.prototype),s.prototype.constructor=s,s.extend=gu.extend,s.attributes=new ga(s),yk(s,e,t),s}let yU={};function yk(e,t,s){if("function"!=typeof e)throw Error("script class: '"+e+"' must be a constructor function (i.e. class).");if(!(e.prototype instanceof gh))throw Error("script class: '"+gu.__getScriptName(e)+"' does not extend pc.Script.");if(t=t||e.__name||gu.__getScriptName(e),yN.has(t))throw Error("script name: '"+t+"' is reserved, please change script name");e.__name=t,(s?s.scripts:uY.getApplication().scripts).add(e),yF.push(e);}ga.reservedNames.forEach((e,t,s)=>{yU[e]=1;}),yB.reservedAttributes=yU;let yz=e=>e[0].toLowerCase()+e.substring(1);class yV extends uI{clearCache(){for(let e in this._cache){let t=this._cache[e],s=t.parentNode;s&&s.removeChild(t);}this._cache={};}load(e,t){"string"==typeof e&&(e={load:e,original:e});let s=this;ua.app=this._app;let i=(e.load,(e,i,n)=>{if(e)t(e);else {let e={};for(let t=0;t<yF._types.length;t++)e[yF._types[t].name]=yF._types[t];yF._types.length=0,t(null,e,n);let r=i.split("&hash=")[0];delete s._loader._cache[uL.makeKey(r,"script")];}}),[n]=e.load.split("?");n.endsWith(".mjs")?this._loadModule(n,i):this._loadScript(e.load,i);}open(e,t){return t}patch(e,t){}_loadScript(e,t){let s=document.head,i=document.createElement("script");this._cache[e]=i,i.async=false,i.addEventListener("error",e=>{t("Script: "+e.target.src+" failed to load");},false);let n=false;i.onload=i.onreadystatechange=function(){n||this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(n=true,t(null,e,i));},i.src=e,s.appendChild(i);}_loadModule(e,t){let s=k.browser&&"null"!==window.location.origin?window.location.origin+window.location.pathname:"undefined"==typeof document&&"undefined"==typeof location?require("url").pathToFileURL(__filename).href:"undefined"==typeof document?location.href:T&&"SCRIPT"===T.tagName.toUpperCase()&&T.src||new URL("playcanvas.js",document.baseURI).href,i=new URL(e,s);Function("modulePath","return import(modulePath)")(i.toString()).then(s=>{var n,r;let a=i.pathname.split("/").pop(),o=null==(r=this._app.assets.find(a,"script"))?void 0:null==(n=r.data)?void 0:n.scripts;for(let e in s){let t=s[e];if(t.prototype instanceof gh){let e=yz(t.name);yk(t,e),o&&this._app.scripts.addSchema(e,o[e]);}}t(null,e,null);}).catch(e=>{t(e);});}constructor(e){super(e,"script"),this._scripts={},this._cache={};}}class yG extends uI{load(e,t){"string"==typeof e&&(e={load:e,original:e}),rR.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(s,i)=>{s?t("Error loading shader resource: "+e.original+" ["+s+"]"):t(null,i);});}openBinary(e){return null!=this.decoder||(this.decoder=new TextDecoder("utf-8")),this.decoder.decode(e)}constructor(e){super(e,"shader"),this.decoder=null;}}function yH(e){this.resource&&(this.resource.atlas=e.resource);}function yW(e){this.registry.load(e);}class yX extends uI{load(e,t){"string"==typeof e&&(e={load:e,original:e}),".json"===M.getExtension(e.original)&&rR.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(e,s)=>{e?t(e):t(null,s);});}open(e,t){let s=new d$(this._device);return e&&(s.__data=t),s}patch(e,t){let s=e.resource;if(s.__data&&(e.data.pixelsPerUnit=s.__data.pixelsPerUnit,e.data.renderMode=s.__data.renderMode,e.data.frameKeys=s.__data.frameKeys,s.__data.textureAtlasAsset)){let i=t.getByUrl(s.__data.textureAtlasAsset);i&&(e.data.textureAtlasAsset=i.id);}s.startUpdate(),s.renderMode=e.data.renderMode,s.pixelsPerUnit=e.data.pixelsPerUnit,s.frameKeys=e.data.frameKeys,this._updateAtlas(e),s.endUpdate(),e.off("change",this._onAssetChange,this),e.on("change",this._onAssetChange,this);}_updateAtlas(e){let t=e.resource;if(!e.data.textureAtlasAsset){t.atlas=null;return}this._assets.off("load:"+e.data.textureAtlasAsset,yH,e),this._assets.on("load:"+e.data.textureAtlasAsset,yH,e);let s=this._assets.get(e.data.textureAtlasAsset);s&&s.resource?t.atlas=s.resource:s?this._assets.load(s):(this._assets.off("add:"+e.data.textureAtlasAsset,yW,e),this._assets.on("add:"+e.data.textureAtlasAsset,yW,e));}_onAssetChange(e,t,s,i){"data"===t&&s&&s.textureAtlasAsset&&i&&s.textureAtlasAsset!==i.textureAtlasAsset&&(this._assets.off("load:"+i.textureAtlasAsset,yH,e),this._assets.off("add:"+i.textureAtlasAsset,yW,e));}constructor(e){super(e,"sprite"),this._assets=e.assets,this._device=e.graphicsDevice;}}class yY{instantiate(){return this._templateRoot||this._parseTemplate(),this._templateRoot.clone()}_parseTemplate(){let e=new yy(this._app,true);this._templateRoot=e.parse(this._data);}constructor(e,t){this._templateRoot=null,this._app=e,this._data=t;}}class yj extends uI{load(e,t){"string"==typeof e&&(e={load:e,original:e});let s={retry:this.maxRetries>0,maxRetries:this.maxRetries};rR.get(e.load,s,(s,i)=>{s?t("Error requesting template: "+e.original):t(s,i);});}open(e,t){return new yY(this._app,t)}openBinary(e){return null!=this.decoder||(this.decoder=new TextDecoder("utf-8")),new yY(this._app,JSON.parse(this.decoder.decode(e)))}constructor(e){super(e,"template"),this.decoder=null;}}class yq extends uI{load(e,t){"string"==typeof e&&(e={load:e,original:e}),rR.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(s,i)=>{s?t("Error loading text resource: "+e.original+" ["+s+"]"):t(null,i);});}openBinary(e){return null!=this.decoder||(this.decoder=new TextDecoder("utf-8")),this.decoder.decode(e)}constructor(e){super(e,"text"),this.decoder=null;}}let yK={repeat:0,clamp:1,mirror:2},yZ={nearest:0,linear:1,nearest_mip_nearest:2,linear_mip_nearest:4,nearest_mip_linear:3,linear_mip_linear:5},yQ=/^data\.frames\.(\d+)$/;class yJ extends uI{load(e,t){"string"==typeof e&&(e={load:e,original:e});let s=this,i=this._loader.getHandler("texture");".json"===M.getExtension(e.original)?rR.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(i,n)=>{if(i)t(i);else {let i=e.original.replace(".json",".png");s._loader.load(i,"texture",(e,s)=>{e?t(e):t(null,{data:n,texture:s});});}}):i.load(e,t);}open(e,t,s){let i=new d0;if(t.texture&&t.data)i.texture=t.texture,i.__data=t.data;else {let n=this._loader.getHandler("texture").open(e,t,s);if(!n)return null;i.texture=n;}return i}patch(e,t){if(!e.resource)return;e.resource.__data&&(void 0!==e.resource.__data.minfilter&&(e.data.minfilter=e.resource.__data.minfilter),void 0!==e.resource.__data.magfilter&&(e.data.magfilter=e.resource.__data.magfilter),void 0!==e.resource.__data.addressu&&(e.data.addressu=e.resource.__data.addressu),void 0!==e.resource.__data.addressv&&(e.data.addressv=e.resource.__data.addressv),void 0!==e.resource.__data.mipmaps&&(e.data.mipmaps=e.resource.__data.mipmaps),void 0!==e.resource.__data.anisotropy&&(e.data.anisotropy=e.resource.__data.anisotropy),void 0!==e.resource.__data.rgbm&&(e.data.rgbm=!!e.resource.__data.rgbm),e.data.frames=e.resource.__data.frames,delete e.resource.__data);let s=e.resource.texture;if(s&&(s.name=e.name,e.data.hasOwnProperty("minfilter")&&s.minFilter!==yZ[e.data.minfilter]&&(s.minFilter=yZ[e.data.minfilter]),e.data.hasOwnProperty("magfilter")&&s.magFilter!==yZ[e.data.magfilter]&&(s.magFilter=yZ[e.data.magfilter]),e.data.hasOwnProperty("addressu")&&s.addressU!==yK[e.data.addressu]&&(s.addressU=yK[e.data.addressu]),e.data.hasOwnProperty("addressv")&&s.addressV!==yK[e.data.addressv]&&(s.addressV=yK[e.data.addressv]),e.data.hasOwnProperty("mipmaps")&&s.mipmaps!==e.data.mipmaps&&(s.mipmaps=e.data.mipmaps),e.data.hasOwnProperty("anisotropy")&&s.anisotropy!==e.data.anisotropy&&(s.anisotropy=e.data.anisotropy),e.data.hasOwnProperty("rgbm"))){let t=e.data.rgbm?tE:tb;s.type!==t&&(s.type=t);}e.resource.texture=s;let i={};for(let t in e.data.frames){let s=e.data.frames[t];i[t]={rect:new em(s.rect),pivot:new ef(s.pivot),border:new em(s.border)};}e.resource.frames=i,e.off("change",this._onAssetChange,this),e.on("change",this._onAssetChange,this);}_onAssetChange(e,t,s){let i;if("data"===t||"data.frames"===t){let t={};for(let e in s.frames)i=s.frames[e],t[e]={rect:new em(i.rect),pivot:new ef(i.pivot),border:new em(i.border)};e.resource.frames=t;}else {let n=t.match(yQ);if(n){let t=n[1];s?(e.resource.frames[t]?((i=e.resource.frames[t]).rect.set(s.rect[0],s.rect[1],s.rect[2],s.rect[3]),i.pivot.set(s.pivot[0],s.pivot[1]),i.border.set(s.border[0],s.border[1],s.border[2],s.border[3])):e.resource.frames[t]={rect:new em(s.rect),pivot:new ef(s.pivot),border:new em(s.border)},e.resource.fire("set:frame",t,e.resource.frames[t])):e.resource.frames[t]&&(delete e.resource.frames[t],e.resource.fire("remove:frame",t));}}}constructor(e){super(e,"textureatlas"),this._loader=e.loader;}}function y$(){let e,t,s;let i={cTFETC1:0,cTFETC2:1,cTFBC1:2,cTFBC3:3,cTFPVRTC1_4_RGB:8,cTFPVRTC1_4_RGBA:9,cTFASTC_4x4:10,cTFATC_RGB:11,cTFATC_RGBA_INTERPOLATED_ALPHA:12,cTFRGBA32:13,cTFRGB565:14,cTFRGBA4444:16},n={astc:i.cTFASTC_4x4,dxt:i.cTFBC1,etc1:i.cTFETC1,etc2:i.cTFETC1,pvr:i.cTFPVRTC1_4_RGB,atc:i.cTFATC_RGB,none:i.cTFRGB565},r={astc:i.cTFASTC_4x4,dxt:i.cTFBC3,etc1:i.cTFRGBA4444,etc2:i.cTFETC2,pvr:i.cTFPVRTC1_4_RGBA,atc:i.cTFATC_RGBA_INTERPOLATED_ALPHA,none:i.cTFRGBA4444},a={ETC1:21,ETC2_RGB:22,ETC2_RGBA:23,DXT1:8,DXT5:10,PVRTC_4BPP_RGB_1:26,PVRTC_4BPP_RGBA_1:27,ASTC_4x4:28,ATC_RGB:29,ATC_RGBA:30,R8_G8_B8_A8:7,R5_G6_B5:3,R4_G4_B4_A4:5},o=(e,t)=>{switch(e){case i.cTFETC1:return t.formats.etc2?a.ETC2_RGB:a.ETC1;case i.cTFETC2:return a.ETC2_RGBA;case i.cTFBC1:return a.DXT1;case i.cTFBC3:return a.DXT5;case i.cTFPVRTC1_4_RGB:return a.PVRTC_4BPP_RGB_1;case i.cTFPVRTC1_4_RGBA:return a.PVRTC_4BPP_RGBA_1;case i.cTFASTC_4x4:return a.ASTC_4x4;case i.cTFATC_RGB:return a.ATC_RGB;case i.cTFATC_RGBA_INTERPOLATED_ALPHA:return a.ATC_RGBA;case i.cTFRGBA32:return a.R8_G8_B8_A8;case i.cTFRGB565:return a.R5_G6_B5;case i.cTFRGBA4444:return a.R4_G4_B4_A4}},l=e=>{for(let t=0;t<e.length;t+=4){let s=e[t+3],i=e[t+1];e[t+0]=s,e[t+2]=function(e,t){let s=2/255*e-1,i=2/255*t-1;return Math.max(0,Math.min(255,Math.floor((Math.sqrt(1-Math.min(1,s*s+i*i))+1)*127.5)))}(s,i),e[t+3]=255;}return e},h=e=>{let t=new Uint16Array(e.length/4);for(let s=0;s<e.length;s+=4){let i=e[s+0],n=e[s+1],r=e[s+2];t[s/4]=(248&i)<<8|(252&n)<<3|r>>3;}return t},d=(e,t)=>(e&e-1)==0&&(t&t-1)==0,c=()=>"undefined"!=typeof performance?performance.now():0,u=(e,i,n)=>{if(n){if(e.formats.astc)return "astc"}else if(i){if(e.formats.etc2)return "etc2"}else {if(e.formats.etc2)return "etc2";if(e.formats.etc1)return "etc1"}return (t=>{for(let s=0;s<t.length;++s){let i=t[s];if(e.formats[i])return i}return "none"})(i?s:t)},p=(e,t,s)=>{switch(s){case i.cTFETC1:case i.cTFETC2:return  true;case i.cTFBC1:case i.cTFBC3:return (3&e)==0&&(3&t)==0;case i.cTFPVRTC1_4_RGB:case i.cTFPVRTC1_4_RGBA:return d(e,t);case i.cTFASTC_4x4:case i.cTFATC_RGB:case i.cTFATC_RGBA_INTERPOLATED_ALPHA:return  true}return  false},f=(t,s,a)=>{let d,f;if(!e.KTX2File)throw Error("Basis transcoder module does not include support for KTX2.");let m=c(),_=new e.KTX2File(new Uint8Array(s)),g=_.getWidth(),v=_.getHeight(),y=_.getLevels(),S=!!_.getHasAlpha(),x=_.isUASTC&&_.isUASTC();if(!g||!v||!y)throw _.close(),_.delete(),Error("Invalid image dimensions url="+t+" width="+g+" height="+v+" levels="+y);let T=u(a.deviceDetails,S,x),b=!!a.isGGGR&&"pvr"===T;if(b?d=i.cTFRGBA32:p(g,v,d=S?r[T]:n[T])||(d=S?i.cTFRGBA32:i.cTFRGB565),!_.startTranscoding())throw _.close(),_.delete(),Error("Failed to start transcoding url="+t);let E=[];for(let e=0;e<y;++e){let s=new Uint8Array(_.getImageTranscodedSizeInBytes(e,0,0,d));if(!_.transcodeImage(s,e,0,0,d,0,-1,-1))throw _.close(),_.delete(),Error("Failed to transcode image url="+t);let n=d===i.cTFRGB565||d===i.cTFRGBA4444;E.push(n?new Uint16Array(s.buffer):s);}if(_.close(),_.delete(),b)for(f=0,d=i.cTFRGB565;f<E.length;++f)E[f]=h(l(E[f]));return {format:o(d,a.deviceDetails),width:g,height:v,levels:E,cubemap:false,transcodeTime:c()-m,url:t,unswizzledGGGR:b}},m=(t,s,a)=>{let d,f;let m=c(),_=new e.BasisFile(new Uint8Array(s)),g=_.getImageWidth(0,0),v=_.getImageHeight(0,0),y=_.getNumImages(),S=_.getNumLevels(0),x=!!_.getHasAlpha(),T=_.isUASTC&&_.isUASTC();if(!g||!v||!y||!S)throw _.close(),_.delete(),Error("Invalid image dimensions url="+t+" width="+g+" height="+v+" images="+y+" levels="+S);let b=u(a.deviceDetails,x,T),E=!!a.isGGGR&&"pvr"===b;if(E?d=i.cTFRGBA32:p(g,v,d=x?r[b]:n[b])||(d=x?i.cTFRGBA32:i.cTFRGB565),!_.startTranscoding())throw _.close(),_.delete(),Error("Failed to start transcoding url="+t);let A=[];for(let e=0;e<S;++e){let s=_.getImageTranscodedSizeInBytes(0,e,d),n=new Uint8Array(s);if(!_.transcodeImage(n,0,e,d,0,0)){if(e===S-1&&s===A[e-1].buffer.byteLength)n.set(new Uint8Array(A[e-1].buffer));else throw _.close(),_.delete(),Error("Failed to transcode image url="+t)}let r=d===i.cTFRGB565||d===i.cTFRGBA4444;A.push(r?new Uint16Array(n.buffer):n);}if(_.close(),_.delete(),E)for(f=0,d=i.cTFRGB565;f<A.length;++f)A[f]=h(l(A[f]));return {format:o(d,a.deviceDetails),width:g,height:v,levels:A,cubemap:false,transcodeTime:c()-m,url:t,unswizzledGGGR:E}},_=(e,t,s)=>s.isKTX2?f(e,t,s):m(e,t,s),g=(e,t,s)=>{try{let i=_(e,t,s);i.levels=i.levels.map(e=>e.buffer),self.postMessage({url:e,data:i},i.levels);}catch(t){self.postMessage({url:e,err:t},null);}},v=(i,n)=>{self.BASIS(i.module?{instantiateWasm:(e,t)=>(WebAssembly.instantiate(i.module,e).then(e=>{t(e);}).catch(e=>{}),{})}:null).then(r=>{r.initializeBasis(),e=r,t=i.rgbPriority,s=i.rgbaPriority,n(null);});},y=[];self.onmessage=t=>{let s=t.data;switch(s.type){case "init":v(s.config,()=>{for(let e=0;e<y.length;++e)g(y[e].url,y[e].data,y[e].options);y.length=0;});break;case "transcode":e?g(s.url,s.data,s.options):y.push(s);}};}let y0=e=>({astc:!!e.extCompressedTextureASTC,atc:!!e.extCompressedTextureATC,dxt:!!e.extCompressedTextureS3TC,etc1:!!e.extCompressedTextureETC1,etc2:!!e.extCompressedTextureETC,pvr:!!e.extCompressedTexturePVRTC}),y1=(e,t)=>{let s=e=>new Blob([["/* basis */",e,"","("+y$.toString()+")()\n\n"].join("\n")],{type:"application/javascript"}),i=(i,n)=>{t(null,{workerUrl:URL.createObjectURL(s(i)),module:n,rgbPriority:e.rgbPriority,rgbaPriority:e.rgbaPriority});},n={cache:true,responseType:"text",retry:e.maxRetries>0,maxRetries:e.maxRetries};if(e.glueUrl&&e.wasmUrl&&(()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){let e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){}return  false})()){let s=null,r=null;rR.get(e.glueUrl,n,(e,n)=>{e?t(e):r?i(n,r):s=n;});let a=fetch(e.wasmUrl),o=()=>{a.then(e=>e.arrayBuffer()).then(e=>WebAssembly.compile(e)).then(e=>{s?i(s,e):r=e;}).catch(e=>{t(e,null);});};WebAssembly.compileStreaming?WebAssembly.compileStreaming(a).then(e=>{s?i(s,e):r=e;}).catch(e=>{o();}):o();}else rR.get(e.fallbackUrl,n,(e,s)=>{e?t(e,null):i(s,null);});};class y2{run(e){let t=[];e.data instanceof ArrayBuffer&&t.push(e.data),this.worker.postMessage({type:"transcode",url:e.url,format:e.format,data:e.data,options:e.options},t),this.eager&&this.queue.enqueueClient(this);}constructor(e,t,s){this.queue=e,this.worker=new Worker(t.workerUrl),this.worker.addEventListener("message",e=>{let t=e.data;this.queue.handleResponse(t.url,t.err,t.data),this.eager||this.queue.enqueueClient(this);}),this.worker.postMessage({type:"init",config:t}),this.eager=s;}}let y3=["etc2","etc1","astc","dxt","pvr","atc"],y4=["astc","dxt","etc2","pvr","atc"],y5=new class{enqueueJob(e,t,s,i){if(this.callbacks.hasOwnProperty(e))this.callbacks[e].push(s);else {this.callbacks[e]=[s];let n={url:e,data:t,options:i};this.clients.length>0?this.clients.shift().run(n):this.queue.push(n);}}enqueueClient(e){this.queue.length>0?e.run(this.queue.shift()):this.clients.push(e);}handleResponse(e,t,s){let i=this.callbacks[e];if(t)for(let e=0;e<i.length;++e)i[e](t);else {3===s.format||5===s.format?s.levels=s.levels.map(e=>new Uint16Array(e)):s.levels=s.levels.map(e=>new Uint8Array(e));for(let e=0;e<i.length;++e)i[e](null,s);}delete this.callbacks[e];}constructor(){this.callbacks={},this.queue=[],this.clients=[];}},y6=null,y8=false;function y9(e){if(!y8){if(e){if(e.lazyInit){y6=e;return}}else e=y6||{};if(!e.glueUrl||!e.wasmUrl||!e.fallbackUrl){let t=K.getConfig("BASIS");t&&(e={glueUrl:t.glueUrl,wasmUrl:t.wasmUrl,fallbackUrl:t.fallbackUrl,numWorkers:t.numWorkers});}if(e.glueUrl||e.wasmUrl||e.fallbackUrl){y8=true;let t=Math.max(1,Math.min(16,e.numWorkers||1)),s=1===e.numWorkers||!e.hasOwnProperty("eagerWorkers")||e.eagerWorkers;e.rgbPriority=e.rgbPriority||y3,e.rgbaPriority=e.rgbaPriority||y4,e.maxRetries=e.hasOwnProperty("maxRetries")?e.maxRetries:5,y1(e,(e,i)=>{if(e);else for(let e=0;e<t;++e)y5.enqueueClient(new y2(y5,i,s));});}}}let y7=null;function Se(e,t,s,i,n){return y9(),y7||(y7={formats:y0(e)}),y5.enqueueJob(t,s,i,{deviceDetails:y7,isGGGR:!!(null==n?void 0:n.isGGGR),isKTX2:!!(null==n?void 0:n.isKTX2)}),y8}class St{load(e,t,s){throw Error("not implemented")}open(e,t,s){throw Error("not implemented")}}function Ss(){return (Ss=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i]);}return e}).apply(this,arguments)}class Si extends St{load(e,t,s){let i=this.device,n=n=>{var r,a,o;Se(i,e.load,n,t,{isGGGR:((null==s?void 0:null==(o=s.file)?void 0:null==(a=o.variants)?void 0:null==(r=a.basis)?void 0:r.opt)&8)!=0})||t("Basis module not found. Asset ["+s.name+"]("+s.getFileUrl()+") basis texture variant will not be loaded.");};ub.fetchArrayBuffer(e.load,(e,s)=>{e?t(e):n(s);},s,this.maxRetries);}open(e,t,s,i){ void 0===i&&(i={});let n=i.srgb?eJ(t.format):t.format,r=new se(s,Ss({name:e,addressU:+!!t.cubemap,addressV:+!!t.cubemap,width:t.width,height:t.height,format:n,cubemap:t.cubemap,levels:t.levels},i));return r.upload(),r}constructor(e,t){super(),this.device=t,this.maxRetries=0;}}function Sn(){return (Sn=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i]);}return e}).apply(this,arguments)}class Sr extends St{load(e,t,s){var i;let n;let r=!!(null==s?void 0:null==(i=s.file)?void 0:i.contents);if(r){if(this.device.supportsImageBitmap){this._loadImageBitmapFromBlob(new Blob([s.file.contents]),t);return}e={load:URL.createObjectURL(new Blob([s.file.contents])),original:e.original};}let a=(s,i)=>{r&&URL.revokeObjectURL(e.load),t(s,i);};s&&s.options&&s.options.hasOwnProperty("crossOrigin")?n=s.options.crossOrigin:uv.test(e.load)&&(n=this.crossOrigin),this.device.supportsImageBitmap?this._loadImageBitmap(e.load,e.original,n,a):this._loadImage(e.load,e.original,n,a);}open(e,t,s,i){ void 0===i&&(i={});let n=new se(s,Sn({name:e,width:t.width,height:t.height,format:i.srgb?20:7},i));return n.setSource(t),n}_loadImage(e,t,s,i){let n;let r=new Image;s&&(r.crossOrigin=s);let a=0,o=this.maxRetries;r.onload=function(){i(null,r);},r.onerror=function(){if(!n){if(o>0&&++a<=o){let t=100*Math.pow(2,a),s=e.indexOf("?")>=0?"&":"?";n=setTimeout(()=>{r.src=e+s+"retry="+Date.now(),n=null;},t);}else i("Error loading Texture from: '"+t+"'");}},r.src=e;}_loadImageBitmap(e,t,s,i){let n={cache:true,responseType:"blob",retry:this.maxRetries>0,maxRetries:this.maxRetries};rR.get(e,n,(e,t)=>{e?i(e):this._loadImageBitmapFromBlob(t,i);});}_loadImageBitmapFromBlob(e,t){createImageBitmap(e,{premultiplyAlpha:"none",colorSpaceConversion:"none"}).then(e=>t(null,e)).catch(e=>t(e));}constructor(e,t){super(),this.crossOrigin=e.prefix?"anonymous":null,this.maxRetries=0,this.device=t;}}function Sa(){return (Sa=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i]);}return e}).apply(this,arguments)}let So={33776:8,33778:9,33779:10,36196:21,37492:22,37496:23,35840:26,35841:24,35842:27,35843:25,32849:6,32856:7,35905:19,35907:20,35898:18,34843:11,34842:12};class Sl extends St{load(e,t,s){ub.fetchArrayBuffer(e.load,t,s,this.maxRetries);}open(e,t,s,i){ void 0===i&&(i={});let n=this.parse(t);if(!n)return null;let r=i.srgb?eJ(n.format):n.format,a=new se(s,Sa({name:e,addressU:+!!n.cubemap,addressV:+!!n.cubemap,width:n.width,height:n.height,format:r,cubemap:n.cubemap,levels:n.levels},i));return a.upload(),a}parse(e){let t=new Uint32Array(e);if(0x58544bab!==t[0]||0xbb313120!==t[1]||0xa1a0a0d!==t[2])return null;let s={endianness:t[3],glType:t[4],glTypeSize:t[5],glFormat:t[6],glInternalFormat:t[7],glBaseInternalFormat:t[8],pixelWidth:t[9],pixelHeight:t[10],pixelDepth:t[11],numberOfArrayElements:t[12],numberOfFaces:t[13],numberOfMipmapLevels:t[14],bytesOfKeyValueData:t[15]};if(s.pixelDepth>1||0!==s.numberOfArrayElements)return null;let i=So[s.glInternalFormat];if(void 0===i)return null;let n=16+s.bytesOfKeyValueData/4,r=s.numberOfFaces>1,a=[];for(let l=0;l<(s.numberOfMipmapLevels||1);l++){let s=t[n++];r&&a.push([]);let h=r?a[l]:a;for(let t=0;t<(r?6:1);++t){var o;h.push((o=4*n,18===i?new Uint32Array(e,o,s/4):new Uint8Array(e,o,s))),n+=s+3>>2;}}return {format:i,width:s.pixelWidth,height:s.pixelHeight,levels:a,cubemap:r}}constructor(e){super(),this.maxRetries=0;}}function Sh(){return (Sh=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i]);}return e}).apply(this,arguments)}let Sd={KHR_DF_MODEL_UASTC:166};class Sc extends St{load(e,t,s){ub.fetchArrayBuffer(e.load,(i,n)=>{i?t(i,n):this.parse(n,e,t,s);},s,this.maxRetries);}open(e,t,s,i){ void 0===i&&(i={});let n=i.srgb?eJ(t.format):t.format,r=new se(s,Sh({name:e,addressU:+!!t.cubemap,addressV:+!!t.cubemap,width:t.width,height:t.height,format:n,cubemap:t.cubemap,levels:t.levels},i));return r.upload(),r}parse(e,t,s,i){let n=new Z(e),r=[n.readU32be(),n.readU32be(),n.readU32be()];if(0xab4b5458!==r[0]||0x203230bb!==r[1]||0xd0a1a0a!==r[2])return null;let a={vkFormat:n.readU32(),typeSize:n.readU32(),pixelWidth:n.readU32(),pixelHeight:n.readU32(),pixelDepth:n.readU32(),layerCount:n.readU32(),faceCount:n.readU32(),levelCount:n.readU32(),supercompressionScheme:n.readU32()},o={dfdByteOffset:n.readU32(),dfdByteLength:n.readU32(),kvdByteOffset:n.readU32(),kvdByteLength:n.readU32(),sgdByteOffset:n.readU64(),sgdByteLength:n.readU64()},l=[];for(let e=0;e<Math.max(1,a.levelCount);++e)l.push({byteOffset:n.readU64(),byteLength:n.readU64(),uncompressedByteLength:n.readU64()});if(n.readU32()!==o.kvdByteOffset-o.dfdByteOffset)return null;n.skip(8);let h=n.readU8();if(n.skip(o.dfdByteLength-9),n.skip(o.kvdByteLength),1===a.supercompressionScheme||h===Sd.KHR_DF_MODEL_UASTC){var d,c,u;Se(this.device,t.load,e,s,{isGGGR:((null==i?void 0:null==(u=i.file)?void 0:null==(c=u.variants)?void 0:null==(d=c.basis)?void 0:d.opt)&8)!=0,isKTX2:true})||s("Basis module not found. Asset ["+i.name+"]("+i.getFileUrl()+") basis texture variant will not be loaded.");}else s("unsupported KTX2 pixel format");}constructor(e,t){super(),this.maxRetries=0,this.device=t;}}function Su(){return (Su=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i]);}return e}).apply(this,arguments)}class Sp extends St{load(e,t,s){ub.fetchArrayBuffer(e.load,t,s,this.maxRetries);}open(e,t,s,i){let n,r;void 0===i&&(i={});let a=new Uint32Array(t,0,32),o=a[4],l=a[3],h=Math.max(a[7],1),d=4===a[20],c=a[21],u=a[22],p=65024===a[28],f=false,m=false,_=false,g=false,v=null,y=1;if(d?0x31545844===c?(v=8,f=true):0x35545844===c?(v=10,f=true):113===c?(v=12,y=2):116===c?(v=14,y=4):0x31435445===c?(v=21,f=true,m=true):0x31333250===c||0x31343250===c?(v=0x31333250===c?24:25,f=true,_=true):(0x31333450===c||0x31343450===c)&&(v=0x31333450===c?26:27,f=true,g=true):32===u&&(v=7),!v)return new se(s,{width:4,height:4,format:6,name:"dds-legacy-empty"});n=new se(s,Su({name:e,addressU:+!!p,addressV:+!!p,width:o,height:l,format:v,cubemap:p,mipmaps:h>1},i));let S=128,x=p?6:1,T=0x31545844===c?8:16;for(let e=0;e<x;e++){let s=o,i=l;for(let a=0;a<h;a++){r=f?m?Math.floor((s+3)/4)*Math.floor((i+3)/4)*8:_?Math.max(s,16)*Math.max(i,8)/4:g?Math.max(s,8)*Math.max(i,8)/2:Math.floor((s+4-1)/4)*Math.floor((i+4-1)/4)*T:s*i*4;let o=14===v?new Float32Array(t,S,r):12===v?new Uint16Array(t,S,r):new Uint8Array(t,S,r);p?(n._levels[a]||(n._levels[a]=[]),n._levels[a][e]=o):n._levels[a]=o,S+=r*y,s=Math.max(.5*s,1),i=Math.max(.5*i,1);}}return n.upload(),n}constructor(e){super(),this.maxRetries=0;}}function Sf(){return (Sf=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i]);}return e}).apply(this,arguments)}class Sm extends St{load(e,t,s){ub.fetchArrayBuffer(e.load,t,s,this.maxRetries),s.data&&!s.data.type&&(s.data.type=tA);}open(e,t,s,i){ void 0===i&&(i={});let n=this.parse(t);if(!n)return null;let r=new se(s,Sf({name:e,addressU:0,addressV:1,minFilter:0,magFilter:0,width:n.width,height:n.height,levels:n.levels,format:7,type:tA,mipmaps:false},i));return r.upload(),r}parse(e){let t=new Z(e);if(!t.readLine().startsWith("#?RADIANCE"))return null;let s={};for(;;){let e=t.readLine();if(0===e.length)break;{let t=e.split("=");2===t.length&&(s[t[0]]=t[1]);}}if(!s.hasOwnProperty("FORMAT"))return null;let i=t.readLine().split(" ");if(4!==i.length)return null;let n=parseInt(i[1],10),r=parseInt(i[3],10),a=this._readPixels(t,r,n,"-Y"===i[0]);return a?{width:r,height:n,levels:[a]}:null}_readPixels(e,t,s,i){let n,r,a,o,l,h;if(t<8||t>32767)return this._readPixelsFlat(e,t,s);let d=[0,0,0,0];if(e.readArray(d),2!==d[0]||2!==d[1]||(128&d[2])!=0)return e.skip(-4),this._readPixelsFlat(e,t,s);let c=new Uint8Array(new ArrayBuffer(t*s*4)),u=i?0:4*t*(s-1);for(r=0;r<s;++r){if(r&&e.readArray(d),(d[2]<<8)+d[3]!==t)return null;for(o=0;o<4;++o)for(n=0;n<t;)if((l=e.readU8())>128){if(n+(l-=128)>t)return null;for(a=0,h=e.readU8();a<l;++a)c[u+o+4*n++]=h;}else {if(0===l||n+l>t)return null;for(a=0;a<l;++a)c[u+o+4*n++]=e.readU8();}u+=4*t*(i?1:-1);}return c}_readPixelsFlat(e,t,s){return e.remainingBytes===t*s*4?new Uint8Array(e.arraybuffer,e.offset):null}constructor(e){super(),this.maxRetries=0;}}let S_={repeat:0,clamp:1,mirror:2},Sg={nearest:0,linear:1,nearest_mip_nearest:2,linear_mip_nearest:4,nearest_mip_linear:3,linear_mip_linear:5},Sv={default:tb,rgbm:tE,rgbe:tA,rgbp:tw,swizzleGGGR:tC},Sy=function(e){var t;let s=t9.calcMipLevelsCount(e._width,e._height);if(7!==e._format&&14!==e._format||e._volume||e._compressed||1===e._levels.length||e._levels.length===s||(t=e._cubemap?e._levels[0][0]:e._levels[0])instanceof HTMLCanvasElement||t instanceof HTMLImageElement||t instanceof HTMLVideoElement)return;let i=function(e,t,s){let i=Math.max(1,e>>1),n=Math.max(1,t>>1),r=new s.constructor(i*n*4),a=Math.floor(e/i),o=Math.floor(t/n),l=a*o;for(let t=0;t<n;++t)for(let n=0;n<i;++n)for(let h=0;h<4;++h){let d=0;for(let i=0;i<o;++i)for(let r=0;r<a;++r)d+=s[(n*a+r+(t*o+i)*e)*4+h];r[(n+t*i)*4+h]=d/l;}return r};for(let t=e._levels.length;t<s;++t){let s=Math.max(1,e._width>>t-1),n=Math.max(1,e._height>>t-1);if(e._cubemap){let r=[];for(let a=0;a<6;++a)r.push(i(s,n,e._levels[t-1][a]));e._levels.push(r);}else e._levels.push(i(s,n,e._levels[t-1]));}e._levelsUpdated=e._cubemap?[[true,true,true,true,true,true]]:[true];};class SS extends uI{set crossOrigin(e){this.imgParser.crossOrigin=e;}get crossOrigin(){return this.imgParser.crossOrigin}set maxRetries(e){for(let t in this.imgParser.maxRetries=e,this.parsers)this.parsers.hasOwnProperty(t)&&(this.parsers[t].maxRetries=e);}get maxRetries(){return this.imgParser.maxRetries}_getUrlWithoutParams(e){return e.indexOf("?")>=0?e.split("?")[0]:e}_getParser(e){let t=M.getExtension(this._getUrlWithoutParams(e)).toLowerCase().replace(".","");return this.parsers[t]||this.imgParser}_getTextureOptions(e){let t={};if(e){var s;(null==(s=e.name)?void 0:s.length)>0&&(t.name=e.name);let i=e.data;i.hasOwnProperty("minfilter")&&(t.minFilter=Sg[i.minfilter]),i.hasOwnProperty("magfilter")&&(t.magFilter=Sg[i.magfilter]),i.hasOwnProperty("addressu")&&(t.addressU=S_[i.addressu]),i.hasOwnProperty("addressv")&&(t.addressV=S_[i.addressv]),i.hasOwnProperty("mipmaps")&&(t.mipmaps=i.mipmaps),i.hasOwnProperty("anisotropy")&&(t.anisotropy=i.anisotropy),i.hasOwnProperty("flipY")&&(t.flipY=!!i.flipY),i.hasOwnProperty("srgb")&&(t.srgb=!!i.srgb),t.type=tb,i.hasOwnProperty("type")?t.type=Sv[i.type]:i.hasOwnProperty("rgbm")&&i.rgbm?t.type=tE:e.file&&(8&e.file.opt)!=0&&(t.type=tC);}return t}load(e,t,s){"string"==typeof e&&(e={load:e,original:e}),this._getParser(e.original).load(e,t,s);}open(e,t,s){if(!e)return;let i=this._getTextureOptions(s),n=this._getParser(e).open(e,t,this._device,i);return null===n?n=new se(this._device,{width:4,height:4,format:6}):(Sy(n),t.unswizzledGGGR&&(s.file.variants.basis.opt&=-9)),n}patch(e,t){let s=e.resource;if(!s)return;let i=this._getTextureOptions(e);for(let e of Object.keys(i))s[e]=i[e];}constructor(e){super(e,"texture");let t=e.assets,s=e.graphicsDevice;this._device=s,this._assets=t,this.imgParser=new Sr(t,s),this.parsers={dds:new Sp(t),ktx:new Sl(t),ktx2:new Sc(t,s),basis:new Si(t,s),hdr:new Sm(t)};}}let Sx="inline",ST="immersive-vr",Sb="immersive-ar",SE="viewer",SA="left",Sw="cpu-optimized",SC="gpu-optimized",SP="luminance-alpha",SM="unsigned-short",SI="float32";class SR{get supported(){return this._supported}get available(){return this._supported&&this._manager.active&&null!==this._manager._session.domOverlayState}get state(){return this._supported&&this._manager.active&&this._manager._session.domOverlayState?this._manager._session.domOverlayState.type:null}set root(e){this._supported&&!this._manager.active&&(this._root=e);}get root(){return this._root}constructor(e){this._supported=k.browser&&!!window.XRDOMOverlayState,this._root=null,this._manager=e;}}let SL=[],SD=[];class SO extends Y{remove(){if(!this._xrHitTestSource)return;let e=this.manager.hitTest.sources,t=e.indexOf(this);-1!==t&&e.splice(t,1),this.onStop();}onStop(){this._xrHitTestSource.cancel(),this._xrHitTestSource=null,this.fire("remove"),this.manager.hitTest.fire("remove",this);}update(e){if(this._transient){let t=e.getHitTestResultsForTransientInput(this._xrHitTestSource);for(let e=0;e<t.length;e++){let s;let i=t[e];i.results.length&&(i.inputSource&&(s=this.manager.input._getByInputSource(i.inputSource)),this.updateHitResults(i.results,s));}}else {let t=e.getHitTestResults(this._xrHitTestSource);if(!t.length)return;this.updateHitResults(t);}}updateHitResults(e,t){var s,i,n;if(this._inputSource&&this._inputSource!==t)return;let r=null!=(s=SL.pop())?s:new eu;t?r.copy(t.getOrigin()):r.copy(this.manager.camera.getPosition());let a=1/0,o=null,l=null!=(i=SL.pop())?i:new eu,h=null!=(n=SD.pop())?n:new eT;for(let t=0;t<e.length;t++){let s=e[t].getPose(this.manager._referenceSpace),i=r.distance(s.transform.position);!(i>=a)&&(a=i,o=e[t],l.copy(s.transform.position),h.copy(s.transform.orientation));}this.fire("result",l,h,t||this._inputSource,o),this.manager.hitTest.fire("result",this,l,h,t||this._inputSource,o),SL.push(r),SL.push(l),SD.push(h);}constructor(e,t,s,i=null){super(),this.manager=e,this._xrHitTestSource=t,this._transient=s,this._inputSource=i;}}SO.EVENT_REMOVE="remove",SO.EVENT_RESULT="result";class SF extends Y{_onSessionStart(){if(this.manager.session.enabledFeatures){let e=-1!==this.manager.session.enabledFeatures.indexOf("hit-test");e&&(this._available=e,this.fire("available"));}else this._checkingAvailability||(this._checkingAvailability=true,this.manager.session.requestReferenceSpace(SE).then(e=>{this.manager.session.requestHitTestSource({space:e}).then(e=>{e.cancel(),this.manager.active&&(this._available=true,this.fire("available"));}).catch(()=>{});}).catch(()=>{}));}_onSessionEnd(){if(this._available){this._available=false;for(let e=0;e<this.sources.length;e++)this.sources[e].onStop();this.sources=[],this.fire("unavailable");}}start(e){let t;if(void 0===e&&(e={}),!this._supported){null==e.callback||e.callback.call(e,Error("XR HitTest is not supported"),null);return}if(!this._available){null==e.callback||e.callback.call(e,Error("XR HitTest is not available"),null);return}e.profile||e.spaceType||(e.spaceType=SE);let s=e.offsetRay;s&&(t=new XRRay(new DOMPoint(s.origin.x,s.origin.y,s.origin.z,1),new DOMPoint(s.direction.x,s.direction.y,s.direction.z,0)));let i=e.callback;e.spaceType?this.manager.session.requestReferenceSpace(e.spaceType).then(s=>{if(!this.manager.session){let e=Error("XR Session is not started (2)");i&&i(e),this.fire("error",e);return}this.manager.session.requestHitTestSource({space:s,entityTypes:e.entityTypes||void 0,offsetRay:t}).then(t=>{this._onHitTestSource(t,false,e.inputSource,i);}).catch(e=>{i&&i(e),this.fire("error",e);});}).catch(e=>{i&&i(e),this.fire("error",e);}):this.manager.session.requestHitTestSourceForTransientInput({profile:e.profile,entityTypes:e.entityTypes||void 0,offsetRay:t}).then(t=>{this._onHitTestSource(t,true,e.inputSource,i);}).catch(e=>{i&&i(e),this.fire("error",e);});}_onHitTestSource(e,t,s,i){if(!this.manager.session){e.cancel();let t=Error("XR Session is not started (3)");i&&i(t),this.fire("error",t);return}let n=new SO(this.manager,e,t,null!=s?s:null);this.sources.push(n),i&&i(null,n),this.fire("add",n);}update(e){if(this._available)for(let t=0;t<this.sources.length;t++)this.sources[t].update(e);}get supported(){return this._supported}get available(){return this._available}constructor(e){super(),this._supported=k.browser&&!!(window.XRSession&&window.XRSession.prototype.requestHitTestSource),this._available=false,this._checkingAvailability=false,this.sources=[],this.manager=e,this._supported&&(this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this));}}SF.EVENT_AVAILABLE="available",SF.EVENT_UNAVAILABLE="unavailable",SF.EVENT_ADD="add",SF.EVENT_REMOVE="remove",SF.EVENT_RESULT="result",SF.EVENT_ERROR="error";class SN extends Y{get image(){return this._image}set width(e){this._width=e;}get width(){return this._width}get trackable(){return this._trackable}get tracking(){return this._tracking}get emulated(){return this._emulated}prepare(){return this._bitmap?{image:this._bitmap,widthInMeters:this._width}:createImageBitmap(this._image).then(e=>(this._bitmap=e,{image:this._bitmap,widthInMeters:this._width}))}destroy(){this._image=null,this._pose=null,this._bitmap&&(this._bitmap.close(),this._bitmap=null);}getPosition(){return this._pose&&this._position.copy(this._pose.transform.position),this._position}getRotation(){return this._pose&&this._rotation.copy(this._pose.transform.orientation),this._rotation}constructor(e,t){super(),this._bitmap=null,this._measuredWidth=0,this._trackable=false,this._tracking=false,this._emulated=false,this._pose=null,this._position=new eu,this._rotation=new eT,this._image=e,this._width=t;}}SN.EVENT_TRACKED="tracked",SN.EVENT_UNTRACKED="untracked";class SB extends Y{add(e,t){if(!this._supported||this._manager.active)return null;let s=new SN(e,t);return this._images.push(s),s}remove(e){if(this._manager.active)return;let t=this._images.indexOf(e);-1!==t&&(e.destroy(),this._images.splice(t,1));}_onSessionStart(){this._manager.session.getTrackedImageScores().then(e=>{this._available=true;for(let t=0;t<e.length;t++)this._images[t]._trackable="trackable"===e[t];}).catch(e=>{this._available=false,this.fire("error",e);});}_onSessionEnd(){this._available=false;for(let e=0;e<this._images.length;e++){let t=this._images[e];t._pose=null,t._measuredWidth=0,t._tracking&&(t._tracking=false,t.fire("untracked"));}}prepareImages(e){this._images.length?Promise.all(this._images.map(e=>e.prepare())).then(t=>{e(null,t);}).catch(t=>{e(t,null);}):e(null,null);}update(e){if(!this._available)return;let t=e.getImageTrackingResults(),s={};for(let i=0;i<t.length;i++){s[t[i].index]=t[i];let n=this._images[t[i].index];n._emulated="emulated"===t[i].trackingState,n._measuredWidth=t[i].measuredWidthInMeters,n._pose=e.getPose(t[i].imageSpace,this._manager._referenceSpace);}for(let e=0;e<this._images.length;e++)this._images[e]._tracking&&!s[e]?(this._images[e]._tracking=false,this._images[e].fire("untracked")):!this._images[e]._tracking&&s[e]&&(this._images[e]._tracking=true,this._images[e].fire("tracked"));}get supported(){return this._supported}get available(){return this._available}get images(){return this._images}constructor(e){super(),this._supported=k.browser&&!!window.XRImageTrackingResult,this._available=false,this._images=[],this._manager=e,this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this));}}SB.EVENT_ERROR="error";class SU{get index(){return this._index}get hand(){return this._hand}get joints(){return this._joints}get tip(){return this._tip}constructor(e,t){this._joints=[],this._tip=null,this._index=e,this._hand=t,this._hand._fingers.push(this);}}let Sk=k.browser&&window.XRHand?["thumb-tip","index-finger-tip","middle-finger-tip","ring-finger-tip","pinky-finger-tip"]:[],Sz={};for(let e=0;e<Sk.length;e++)Sz[Sk[e]]=true;class SV{update(e){this._dirtyLocal=true,this._radius=e.radius,this._localPosition.copy(e.transform.position),this._localRotation.copy(e.transform.orientation);}_updateTransforms(){this._dirtyLocal&&(this._dirtyLocal=false,this._localTransform.setTRS(this._localPosition,this._localRotation,eu.ONE));let e=this._hand._manager.camera.parent;e?this._worldTransform.mul2(e.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform);}getPosition(){return this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position}getRotation(){return this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation}get id(){return this._id}get index(){return this._index}get hand(){return this._hand}get finger(){return this._finger}get wrist(){return this._wrist}get tip(){return this._tip}get radius(){return this._radius||.005}constructor(e,t,s,i=null){this._radius=null,this._localTransform=new ex,this._worldTransform=new ex,this._localPosition=new eu,this._localRotation=new eT,this._position=new eu,this._rotation=new eT,this._dirtyLocal=true,this._index=e,this._id=t,this._hand=s,this._finger=i,this._wrist="wrist"===t,this._tip=this._finger&&!!Sz[t];}}let SG=[],SH=new eu,SW=new eu,SX=new eu;k.browser&&window.XRHand&&(SG=[["thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip"],["index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip"],["middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip"],["ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip"],["pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"]]);class SY extends Y{update(e){let t=this._inputSource._xrInputSource;for(let s=0;s<this._joints.length;s++){let i=this._joints[s],n=t.hand.get(i._id);if(n){let t;if("hidden"!==e.session.visibilityState&&(t=e.getJointPose(n,this._manager._referenceSpace)),t)i.update(t),i.wrist&&!this._tracking&&(this._tracking=true,this.fire("tracking"));else if(i.wrist){this._tracking&&(this._tracking=false,this.fire("trackinglost"));break}}}let s=this._jointsById["thumb-metacarpal"],i=this._jointsById["thumb-tip"],n=this._jointsById["index-finger-phalanx-proximal"],r=this._jointsById["index-finger-tip"],a=this._jointsById["ring-finger-phalanx-proximal"],o=this._jointsById["pinky-finger-phalanx-proximal"];if(s&&i&&n&&r&&a&&o){this._inputSource._dirtyRay=true,this._inputSource._rayLocal.origin.lerp(i._localPosition,r._localPosition,.5);let e=s,t=o;if(this._inputSource.handedness===SA){let s=e;e=t,t=s;}SH.sub2(e._localPosition,this._wrist._localPosition),SW.sub2(t._localPosition,this._wrist._localPosition),SX.cross(SH,SW).normalize(),SH.lerp(n._localPosition,a._localPosition,.5),SH.sub(this._wrist._localPosition).normalize(),this._inputSource._rayLocal.direction.lerp(SX,SH,.5).normalize();}this._fingerIsClosed(1)&&this._fingerIsClosed(2)&&this._fingerIsClosed(3)&&this._fingerIsClosed(4)?this._inputSource._squeezing||(this._inputSource._squeezing=true,this._inputSource.fire("squeezestart"),this._manager.input.fire("squeezestart",this._inputSource)):this._inputSource._squeezing&&(this._inputSource._squeezing=false,this._inputSource.fire("squeeze"),this._manager.input.fire("squeeze",this._inputSource),this._inputSource.fire("squeezeend"),this._manager.input.fire("squeezeend",this._inputSource));}_fingerIsClosed(e){let t=this._fingers[e];return SH.sub2(t.joints[0]._localPosition,t.joints[1]._localPosition).normalize(),SW.sub2(t.joints[2]._localPosition,t.joints[3]._localPosition).normalize(),-0.8>SH.dot(SW)}getJointById(e){return this._jointsById[e]||null}get fingers(){return this._fingers}get joints(){return this._joints}get tips(){return this._tips}get wrist(){return this._wrist}get tracking(){return this._tracking}constructor(e){super(),this._tracking=false,this._fingers=[],this._joints=[],this._jointsById={},this._tips=[],this._wrist=null;let t=e._xrInputSource.hand;if(this._manager=e._manager,this._inputSource=e,t.get("wrist")){let e=new SV(0,"wrist",this,null);this._wrist=e,this._joints.push(e),this._jointsById.wrist=e;}for(let e=0;e<SG.length;e++){let s=new SU(e,this);for(let i=0;i<SG[e].length;i++){let n=SG[e][i];if(!t.get(n))continue;let r=new SV(i,n,this,s);this._joints.push(r),this._jointsById[n]=r,r.tip&&(this._tips.push(r),s._tip=r),s._joints.push(r);}}}}SY.EVENT_TRACKING="tracking",SY.EVENT_TRACKINGLOST="trackinglost";let Sj=new eu,Sq=new eT,SK=0;class SZ extends Y{get id(){return this._id}get inputSource(){return this._xrInputSource}get targetRayMode(){return this._xrInputSource.targetRayMode}get handedness(){return this._xrInputSource.handedness}get profiles(){return this._xrInputSource.profiles}get grip(){return this._grip}get hand(){return this._hand}get gamepad(){return this._xrInputSource.gamepad||null}get selecting(){return this._selecting}get squeezing(){return this._squeezing}set elementInput(e){this._elementInput!==e&&(this._elementInput=e,this._elementInput||(this._elementEntity=null));}get elementInput(){return this._elementInput}get elementEntity(){return this._elementEntity}get hitTestSources(){return this._hitTestSources}update(e){if(this._hand)this._hand.update(e);else {let t=this._xrInputSource.gripSpace;if(t){let s=e.getPose(t,this._manager._referenceSpace);if(s){this._grip||(this._grip=true,this._localTransform=new ex,this._worldTransform=new ex,this._localPositionLast=new eu,this._localPosition=new eu,this._localRotation=new eT,this._linearVelocity=new eu);let e=$(),t=(e-this._velocitiesTimestamp)/1e3;this._velocitiesTimestamp=e,this._dirtyLocal=true,this._localPositionLast.copy(this._localPosition),this._localPosition.copy(s.transform.position),this._localRotation.copy(s.transform.orientation),this._velocitiesAvailable=true,this._manager.input.velocitiesSupported&&s.linearVelocity?this._linearVelocity.copy(s.linearVelocity):t>0&&(Sj.sub2(this._localPosition,this._localPositionLast).divScalar(t),this._linearVelocity.lerp(this._linearVelocity,Sj,.15));}else this._velocitiesAvailable=false;}let s=e.getPose(this._xrInputSource.targetRaySpace,this._manager._referenceSpace);s&&(this._dirtyRay=true,this._rayLocal.origin.copy(s.transform.position),this._rayLocal.direction.set(0,0,-1),Sq.copy(s.transform.orientation),Sq.transformVector(this._rayLocal.direction,this._rayLocal.direction));}}_updateTransforms(){this._dirtyLocal&&(this._dirtyLocal=false,this._localTransform.setTRS(this._localPosition,this._localRotation,eu.ONE));let e=this._manager.camera.parent;e?this._worldTransform.mul2(e.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform);}_updateRayTransforms(){let e=this._dirtyRay;if(this._dirtyRay=false,this._manager.camera.parent){let e=this._manager.camera.parent.getWorldTransform();e.getTranslation(this._position),this._rotation.setFromMat4(e),this._rotation.transformVector(this._rayLocal.origin,this._ray.origin),this._ray.origin.add(this._position),this._rotation.transformVector(this._rayLocal.direction,this._ray.direction);}else e&&(this._ray.origin.copy(this._rayLocal.origin),this._ray.direction.copy(this._rayLocal.direction));}getPosition(){return this._position?(this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position):null}getLocalPosition(){return this._localPosition}getRotation(){return this._rotation?(this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation):null}getLocalRotation(){return this._localRotation}getLinearVelocity(){return this._velocitiesAvailable?this._linearVelocity:null}getOrigin(){return this._updateRayTransforms(),this._ray.origin}getDirection(){return this._updateRayTransforms(),this._ray.direction}hitTestStart(e){ void 0===e&&(e={}),e.inputSource=this,e.profile=this._xrInputSource.profiles[0];let t=e.callback;e.callback=(e,s)=>{s&&this.onHitTestSourceAdd(s),t&&t(e,s);},this._manager.hitTest.start(e);}onHitTestSourceAdd(e){this._hitTestSources.push(e),this.fire("hittest:add",e),e.on("result",(t,s,i,n)=>{i===this&&this.fire("hittest:result",e,t,s,n);}),e.once("remove",()=>{this.onHitTestSourceRemove(e),this.fire("hittest:remove",e);});}onHitTestSourceRemove(e){let t=this._hitTestSources.indexOf(e);-1!==t&&this._hitTestSources.splice(t,1);}constructor(e,t){super(),this._ray=new eO,this._rayLocal=new eO,this._grip=false,this._hand=null,this._velocitiesAvailable=false,this._velocitiesTimestamp=$(),this._localTransform=null,this._worldTransform=null,this._position=new eu,this._rotation=new eT,this._localPosition=null,this._localPositionLast=null,this._localRotation=null,this._linearVelocity=null,this._dirtyLocal=true,this._dirtyRay=false,this._selecting=false,this._squeezing=false,this._elementInput=true,this._elementEntity=null,this._hitTestSources=[],this._id=++SK,this._manager=e,this._xrInputSource=t,t.hand&&(this._hand=new SY(this));}}SZ.EVENT_REMOVE="remove",SZ.EVENT_SELECT="select",SZ.EVENT_SELECTSTART="selectstart",SZ.EVENT_SELECTEND="selectend",SZ.EVENT_SQUEEZE="squeeze",SZ.EVENT_SQUEEZESTART="squeezestart",SZ.EVENT_SQUEEZEEND="squeezeend",SZ.EVENT_HITTESTADD="hittest:add",SZ.EVENT_HITTESTREMOVE="hittest:remove",SZ.EVENT_HITTESTRESULT="hittest:result";class SQ extends Y{_onSessionStart(){let e=this.manager.session;e.addEventListener("inputsourceschange",this._onInputSourcesChangeEvt),e.addEventListener("select",e=>{let t=this._getByInputSource(e.inputSource);t.update(e.frame),t.fire("select",e),this.fire("select",t,e);}),e.addEventListener("selectstart",e=>{let t=this._getByInputSource(e.inputSource);t.update(e.frame),t._selecting=true,t.fire("selectstart",e),this.fire("selectstart",t,e);}),e.addEventListener("selectend",e=>{let t=this._getByInputSource(e.inputSource);t.update(e.frame),t._selecting=false,t.fire("selectend",e),this.fire("selectend",t,e);}),e.addEventListener("squeeze",e=>{let t=this._getByInputSource(e.inputSource);t.update(e.frame),t.fire("squeeze",e),this.fire("squeeze",t,e);}),e.addEventListener("squeezestart",e=>{let t=this._getByInputSource(e.inputSource);t.update(e.frame),t._squeezing=true,t.fire("squeezestart",e),this.fire("squeezestart",t,e);}),e.addEventListener("squeezeend",e=>{let t=this._getByInputSource(e.inputSource);t.update(e.frame),t._squeezing=false,t.fire("squeezeend",e),this.fire("squeezeend",t,e);});let t=e.inputSources;for(let e=0;e<t.length;e++)this._addInputSource(t[e]);}_onSessionEnd(){let e=this._inputSources.length;for(;e--;){let t=this._inputSources[e];this._inputSources.splice(e,1),t.fire("remove"),this.fire("remove",t);}this.manager.session.removeEventListener("inputsourceschange",this._onInputSourcesChangeEvt);}_onInputSourcesChange(e){for(let t=0;t<e.removed.length;t++)this._removeInputSource(e.removed[t]);for(let t=0;t<e.added.length;t++)this._addInputSource(e.added[t]);}_getByInputSource(e){for(let t=0;t<this._inputSources.length;t++)if(this._inputSources[t].inputSource===e)return this._inputSources[t];return null}_addInputSource(e){if(this._getByInputSource(e))return;let t=new SZ(this.manager,e);this._inputSources.push(t),this.fire("add",t);}_removeInputSource(e){for(let t=0;t<this._inputSources.length;t++){if(this._inputSources[t].inputSource!==e)continue;let s=this._inputSources[t];this._inputSources.splice(t,1);let i=s.hitTestSources.length;for(;i--;)s.hitTestSources[i].remove();s.fire("remove"),this.fire("remove",s);return}}update(e){for(let t=0;t<this._inputSources.length;t++)this._inputSources[t].update(e);}get inputSources(){return this._inputSources}constructor(e){var t,s;super(),this._inputSources=[],this.velocitiesSupported=false,this.manager=e,this.velocitiesSupported=!!(k.browser&&(null==(s=window.XRPose)?void 0:null==(t=s.prototype)?void 0:t.hasOwnProperty("linearVelocity"))),this._onInputSourcesChangeEvt=e=>{this._onInputSourcesChange(e);},this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this);}}SQ.EVENT_ADD="add",SQ.EVENT_REMOVE="remove",SQ.EVENT_SELECT="select",SQ.EVENT_SELECTSTART="selectstart",SQ.EVENT_SELECTEND="selectend",SQ.EVENT_SQUEEZE="squeeze",SQ.EVENT_SQUEEZESTART="squeezestart",SQ.EVENT_SQUEEZEEND="squeezeend";let SJ=new eu,S$=new eu,S0=new ex,S1=new ex;class S2 extends Y{_onSessionStart(){this._manager.session.requestLightProbe&&(this._supported=true);}_onSessionEnd(){this._supported=false,this._available=false,this._lightProbeRequested=false,this._lightProbe=null;}start(){let e;if(this._manager.session||(e=Error("XR session is not running")),e||this._manager.type===Sb||(e=Error("XR session type is not AR")),e||this._supported||(e=Error("light-estimation is not supported")),(!e&&this._lightProbe||this._lightProbeRequested)&&(e=Error("light estimation is already requested")),e){this.fire("error",e);return}this._lightProbeRequested=true,this._manager.session.requestLightProbe().then(e=>{let t=this._lightProbeRequested;this._lightProbeRequested=false,this._manager.active?t&&(this._lightProbe=e):this.fire("error",Error("XR session is not active"));}).catch(e=>{this._lightProbeRequested=false,this.fire("error",e);});}end(){this._lightProbeRequested=false,this._lightProbe=null,this._available=false;}update(e){if(!this._lightProbe)return;let t=e.getLightEstimate(this._lightProbe);if(!t)return;this._available||(this._available=true,this.fire("available"));let s=t.primaryLightIntensity;this._intensity=Math.max(1,Math.max(s.x,Math.max(s.y,s.z))),SJ.copy(s).mulScalar(1/this._intensity),this._color.set(SJ.x,SJ.y,SJ.z),SJ.set(0,0,0),S$.copy(t.primaryLightDirection),S0.setLookAt(S$,SJ,eu.UP),S1.setFromAxisAngle(eu.RIGHT,90),S0.mul(S1),this._rotation.setFromMat4(S0),this._sphericalHarmonics.set(t.sphericalHarmonicsCoefficients);}get supported(){return this._supported}get available(){return this._available}get intensity(){return this._available?this._intensity:null}get color(){return this._available?this._color:null}get rotation(){return this._available?this._rotation:null}get sphericalHarmonics(){return this._available?this._sphericalHarmonics:null}constructor(e){super(),this._supported=false,this._available=false,this._lightProbeRequested=false,this._lightProbe=null,this._intensity=0,this._rotation=new eT,this._color=new en,this._sphericalHarmonics=new Float32Array(27),this._manager=e,this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this);}}S2.EVENT_AVAILABLE="available",S2.EVENT_ERROR="error";let S3=0;class S4 extends Y{destroy(){this._xrPlane&&(this._xrPlane=null,this.fire("remove"));}update(e){let t=this._planeDetection._manager,s=e.getPose(this._xrPlane.planeSpace,t._referenceSpace);s&&(this._position.copy(s.transform.position),this._rotation.copy(s.transform.orientation)),this._lastChangedTime!==this._xrPlane.lastChangedTime&&(this._lastChangedTime=this._xrPlane.lastChangedTime,this.fire("change"));}getPosition(){return this._position}getRotation(){return this._rotation}get id(){return this._id}get orientation(){return this._orientation}get points(){return this._xrPlane.polygon}get label(){return this._xrPlane.semanticLabel||""}constructor(e,t){super(),this._position=new eu,this._rotation=new eT,this._id=++S3,this._planeDetection=e,this._xrPlane=t,this._lastChangedTime=t.lastChangedTime,this._orientation=t.orientation;}}S4.EVENT_REMOVE="remove",S4.EVENT_CHANGE="change";class S5 extends Y{_onSessionStart(){this._manager.session.enabledFeatures&&-1!==this._manager.session.enabledFeatures.indexOf("plane-detection")&&(this._available=true,this.fire("available"));}_onSessionEnd(){for(let e=0;e<this._planes.length;e++)this._planes[e].destroy(),this.fire("remove",this._planes[e]);this._planesIndex.clear(),this._planes.length=0,this._available&&(this._available=false,this.fire("unavailable"));}update(e){if(!this._available){if(this._manager.session.enabledFeatures||!e.detectedPlanes.size)return;this._available=true,this.fire("available");}let t=e.detectedPlanes;for(let[e,s]of this._planesIndex)!t.has(e)&&(this._planesIndex.delete(e),this._planes.splice(this._planes.indexOf(s),1),s.destroy(),this.fire("remove",s));for(let s of t){let t=this._planesIndex.get(s);t?t.update(e):(t=new S4(this,s),this._planesIndex.set(s,t),this._planes.push(t),t.update(e),this.fire("add",t));}}get supported(){return this._supported}get available(){return this._available}get planes(){return this._planes}constructor(e){super(),this._supported=k.browser&&!!window.XRPlane,this._available=false,this._planesIndex=new Map,this._planes=[],this._manager=e,this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this));}}S5.EVENT_AVAILABLE="available",S5.EVENT_UNAVAILABLE="unavailable",S5.EVENT_ADD="add",S5.EVENT_REMOVE="remove";class S6 extends Y{destroy(){if(!this._xrAnchor)return;let e=this._xrAnchor;this._xrAnchor.delete(),this._xrAnchor=null,this.fire("destroy",e,this);}update(e){if(!this._xrAnchor)return;let t=e.getPose(this._xrAnchor.anchorSpace,this._anchors.manager._referenceSpace);if(t){if(this._position.equals(t.transform.position)&&this._rotation.equals(t.transform.orientation))return;this._position.copy(t.transform.position),this._rotation.copy(t.transform.orientation),this.fire("change");}}getPosition(){return this._position}getRotation(){return this._rotation}persist(e){if(!this._anchors.persistence){null==e||e(Error("Persistent Anchors are not supported"),null);return}if(this._uuid){null==e||e(null,this._uuid);return}if(this._uuidRequests){e&&this._uuidRequests.push(e);return}this._uuidRequests=[],this._xrAnchor.requestPersistentHandle().then(t=>{for(let s of(this._uuid=t,this._anchors._indexByUuid.set(this._uuid,this),null==e||e(null,t),this._uuidRequests))s(null,t);this._uuidRequests=null,this.fire("persist",t);}).catch(t=>{for(let s of(null==e||e(t,null),this._uuidRequests))s(t,null);this._uuidRequests=null;});}forget(e){if(!this._uuid){null==e||e(Error("Anchor is not persistent"));return}this._anchors.forget(this._uuid,t=>{this._uuid=null,null==e||e(t),this.fire("forget");});}get uuid(){return this._uuid}get persistent(){return !!this._uuid}constructor(e,t,s=null){super(),this._position=new eu,this._rotation=new eT,this._uuid=null,this._uuidRequests=null,this._anchors=e,this._xrAnchor=t,this._uuid=s;}}S6.EVENT_DESTROY="destroy",S6.EVENT_CHANGE="change",S6.EVENT_PERSIST="persist",S6.EVENT_FORGET="forget";class S8 extends Y{_onSessionStart(){let e=-1!==this.manager.session.enabledFeatures.indexOf("anchors");e&&(this._available=e,this.fire("available"));}_onSessionEnd(){if(!this._available)return;this._available=false;for(let e=0;e<this._creationQueue.length;e++)this._creationQueue[e].callback&&this._creationQueue[e].callback(Error("session ended"),null);this._creationQueue.length=0,this._index.clear(),this._indexByUuid.clear();let e=this._list.length;for(;e--;)this._list[e].destroy();this._list.length=0,this.fire("unavailable");}_createAnchor(e,t){ void 0===t&&(t=null);let s=new S6(this,e,t);return this._index.set(e,s),t&&this._indexByUuid.set(t,s),this._list.push(s),s.once("destroy",this._onAnchorDestroy,this),s}_onAnchorDestroy(e,t){this._index.delete(e),t.uuid&&this._indexByUuid.delete(t.uuid);let s=this._list.indexOf(t);-1!==s&&this._list.splice(s,1),this.fire("destroy",t);}create(e,t,s){if(!this._available){null==s||s(Error("Anchors API is not available"),null);return}if(window.XRHitTestResult&&e instanceof XRHitTestResult){if(s=t,!this._supported){null==s||s(Error("Anchors API is not supported"),null);return}if(!e.createAnchor){null==s||s(Error("Creating Anchor from Hit Test is not supported"),null);return}e.createAnchor().then(e=>{let t=this._createAnchor(e);null==s||s(null,t),this.fire("add",t);}).catch(e=>{null==s||s(e,null),this.fire("error",e);});}else this._creationQueue.push({transform:new XRRigidTransform(e,t),callback:s});}restore(e,t){if(!this._available){null==t||t(Error("Anchors API is not available"),null);return}if(!this._persistence){null==t||t(Error("Anchor Persistence is not supported"),null);return}if(!this.manager.active){null==t||t(Error("WebXR session is not active"),null);return}this.manager.session.restorePersistentAnchor(e).then(s=>{let i=this._createAnchor(s,e);null==t||t(null,i),this.fire("add",i);}).catch(e=>{null==t||t(e,null),this.fire("error",e);});}forget(e,t){if(!this._available){null==t||t(Error("Anchors API is not available"));return}if(!this._persistence){null==t||t(Error("Anchor Persistence is not supported"));return}if(!this.manager.active){null==t||t(Error("WebXR session is not active"));return}this.manager.session.deletePersistentAnchor(e).then(()=>{null==t||t(null);}).catch(e=>{null==t||t(e),this.fire("error",e);});}update(e){if(!this._available){this.manager.session.enabledFeatures||this._checkingAvailability||(this._checkingAvailability=true,e.createAnchor(new XRRigidTransform,this.manager._referenceSpace).then(e=>{e.delete(),this.manager.active&&(this._available=true,this.fire("available"));}).catch(()=>{}));return}if(this._creationQueue.length){for(let t=0;t<this._creationQueue.length;t++){let s=this._creationQueue[t];e.createAnchor(s.transform,this.manager._referenceSpace).then(e=>{s.callback&&this._callbacksAnchors.set(e,s.callback);}).catch(e=>{s.callback&&s.callback(e,null),this.fire("error",e);});}this._creationQueue.length=0;}for(let[t,s]of this._index)!e.trackedAnchors.has(t)&&(this._index.delete(t),s.destroy());for(let t=0;t<this._list.length;t++)this._list[t].update(e);for(let t of e.trackedAnchors){if(this._index.has(t))continue;try{t.anchorSpace;}catch(e){continue}let s=this._createAnchor(t);s.update(e);let i=this._callbacksAnchors.get(t);i&&(this._callbacksAnchors.delete(t),i(null,s)),this.fire("add",s);}}get supported(){return this._supported}get available(){return this._available}get persistence(){return this._persistence}get uuids(){return this._available&&this._persistence&&this.manager.active?this.manager.session.persistentAnchors:null}get list(){return this._list}constructor(e){var t,s;super(),this._supported=k.browser&&!!window.XRAnchor,this._available=false,this._checkingAvailability=false,this._persistence=k.browser&&!!(null==(s=window)?void 0:null==(t=s.XRSession)?void 0:t.prototype.restorePersistentAnchor),this._creationQueue=[],this._index=new Map,this._indexByUuid=new Map,this._list=[],this._callbacksAnchors=new Map,this.manager=e,this._supported&&(this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this));}}S8.EVENT_AVAILABLE="available",S8.EVENT_UNAVAILABLE="unavailable",S8.EVENT_ERROR="error",S8.EVENT_ADD="add",S8.EVENT_DESTROY="destroy";class S9 extends Y{get xrMesh(){return this._xrMesh}get label(){return this._xrMesh.semanticLabel||""}get vertices(){return this._xrMesh.vertices}get indices(){return this._xrMesh.indices}destroy(){this._xrMesh&&(this._xrMesh=null,this.fire("remove"));}update(e){let t=this._meshDetection._manager,s=e.getPose(this._xrMesh.meshSpace,t._referenceSpace);s&&(this._position.copy(s.transform.position),this._rotation.copy(s.transform.orientation)),this._lastChanged!==this._xrMesh.lastChangedTime&&(this._lastChanged=this._xrMesh.lastChangedTime,this.fire("change"));}getPosition(){return this._position}getRotation(){return this._rotation}constructor(e,t){super(),this._lastChanged=0,this._position=new eu,this._rotation=new eT,this._meshDetection=e,this._xrMesh=t,this._lastChanged=this._xrMesh.lastChangedTime;}}S9.EVENT_REMOVE="remove",S9.EVENT_CHANGE="change";class S7 extends Y{update(e){if(!this._available){if(this._manager.session.enabledFeatures||!e.detectedMeshes.size)return;this._available=true,this.fire("available");}for(let t of e.detectedMeshes){let s=this._index.get(t);s?s.update(e):(s=new S9(this,t),this._index.set(t,s),this._list.push(s),s.update(e),this.fire("add",s));}for(let t of this._index.values())!e.detectedMeshes.has(t.xrMesh)&&this._removeMesh(t);}_removeMesh(e){this._index.delete(e.xrMesh),this._list.splice(this._list.indexOf(e),1),e.destroy(),this.fire("remove",e);}_onSessionStart(){if(this._manager.session.enabledFeatures){let e=-1!==this._manager.session.enabledFeatures.indexOf("mesh-detection");e&&(this._available=e,this.fire("available"));}}_onSessionEnd(){if(this._available){for(let e of(this._available=false,this._index.values()))this._removeMesh(e);this.fire("unavailable");}}get supported(){return this._supported}get available(){return this._available}get meshes(){return this._list}constructor(e){super(),this._supported=k.browser&&!!window.XRMesh,this._available=false,this._index=new Map,this._list=[],this._manager=e,this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this));}}S7.EVENT_AVAILABLE="available",S7.EVENT_UNAVAILABLE="unavailable",S7.EVENT_ADD="add",S7.EVENT_REMOVE="remove";class xe extends Y{get textureColor(){return this._textureColor}get textureDepth(){return this._textureDepth}get depthUvMatrix(){return this._depthMatrix}get depthValueToMeters(){var e;return (null==(e=this._depthInfo)?void 0:e.rawValueToMeters)||0}get eye(){return this._xrView.eye}get viewport(){return this._viewport}get projMat(){return this._projMat}get projViewOffMat(){return this._projViewOffMat}get viewOffMat(){return this._viewOffMat}get viewInvOffMat(){return this._viewInvOffMat}get viewMat3(){return this._viewMat3}get positionData(){return this._positionData}update(e,t){this._xrView=t,this._manager.views.availableColor&&(this._xrCamera=this._xrView.camera);let s=e.session.renderState.baseLayer.getViewport(this._xrView);this._viewport.x=s.x,this._viewport.y=s.y,this._viewport.z=s.width,this._viewport.w=s.height,this._projMat.set(this._xrView.projectionMatrix),this._viewMat.set(this._xrView.transform.inverse.matrix),this._viewInvMat.set(this._xrView.transform.matrix),this._updateTextureColor(),this._updateDepth(e);}_updateTextureColor(){if(!this._manager.views.availableColor||!this._xrCamera||!this._textureColor)return;let e=this._manager.webglBinding;if(!e)return;let t=e.getCameraImage(this._xrCamera);if(!t)return;let s=this._manager.app.graphicsDevice,i=s.gl;if(this._frameBufferSource){let e=i.COLOR_ATTACHMENT0,n=this._xrCamera.width,r=this._xrCamera.height;s.setFramebuffer(this._frameBufferSource),i.framebufferTexture2D(i.FRAMEBUFFER,e,i.TEXTURE_2D,t,0),s.setFramebuffer(this._frameBuffer),i.framebufferTexture2D(i.FRAMEBUFFER,e,i.TEXTURE_2D,this._textureColor.impl._glTexture,0),i.bindFramebuffer(i.READ_FRAMEBUFFER,this._frameBufferSource),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,this._frameBuffer),i.blitFramebuffer(0,r,n,0,0,0,n,r,i.COLOR_BUFFER_BIT,i.NEAREST);}else this._frameBufferSource=i.createFramebuffer(),this._frameBuffer=i.createFramebuffer();}_updateDepth(e){var t,s;if(!this._manager.views.availableDepth||!this._textureDepth)return;let i=this._manager.views.depthGpuOptimized,n=i?this._manager.webglBinding:e;if(!n){this._depthInfo=null;return}let r=n.getDepthInformation(this._xrView);if(!r){this._depthInfo=null;return}let a=!this._depthInfo!=!r;this._depthInfo=r;let o=(null==(t=this._depthInfo)?void 0:t.width)||4,l=(null==(s=this._depthInfo)?void 0:s.height)||4,h=false;if((this._textureDepth.width!==o||this._textureDepth.height!==l)&&(this._textureDepth._width=o,this._textureDepth._height=l,a=true,h=true),a&&(this._depthInfo?this._depthMatrix.data.set(this._depthInfo.normDepthBufferFromNormView.matrix):this._depthMatrix.setIdentity()),this._depthInfo){if(i){if(this._depthInfo.texture){let e=this._manager.app.graphicsDevice.gl;switch(this._textureDepth.impl._glTexture=this._depthInfo.texture,"texture-array"===this._depthInfo.textureType?this._textureDepth.impl._glTarget=e.TEXTURE_2D_ARRAY:this._textureDepth.impl._glTarget=e.TEXTURE_2D,this._manager.views.depthPixelFormat){case 15:this._textureDepth.impl._glInternalFormat=e.R32F,this._textureDepth.impl._glPixelType=e.FLOAT,this._textureDepth.impl._glFormat=e.RED;break;case 16:this._textureDepth.impl._glInternalFormat=e.DEPTH_COMPONENT16,this._textureDepth.impl._glPixelType=e.UNSIGNED_SHORT,this._textureDepth.impl._glFormat=e.DEPTH_COMPONENT;}this._textureDepth.impl._glCreated=true;}}else this._textureDepth._levels[0]=new Uint8Array(this._depthInfo.data),this._textureDepth.upload();}else this._textureDepth._levels[0]=this._emptyDepthBuffer,this._textureDepth.upload();h&&this.fire("depth:resize",o,l);}updateTransforms(e){e?(this._viewInvOffMat.mul2(e,this._viewInvMat),this.viewOffMat.copy(this._viewInvOffMat).invert()):(this._viewInvOffMat.copy(this._viewInvMat),this.viewOffMat.copy(this._viewMat)),this._viewMat3.setFromMat4(this._viewOffMat),this._projViewOffMat.mul2(this._projMat,this._viewOffMat),this._positionData[0]=this._viewInvOffMat.data[12],this._positionData[1]=this._viewInvOffMat.data[13],this._positionData[2]=this._viewInvOffMat.data[14];}_onDeviceLost(){this._frameBufferSource=null,this._frameBuffer=null,this._depthInfo=null;}getDepth(e,t){var s,i;return this._manager.views.depthGpuOptimized?null:null!=(i=null==(s=this._depthInfo)?void 0:s.getDepthInMeters(e,t))?i:null}destroy(){if(this._depthInfo=null,this._textureColor&&(this._textureColor.destroy(),this._textureColor=null),this._textureDepth&&(this._textureDepth.destroy(),this._textureDepth=null),this._frameBufferSource){let e=this._manager.app.graphicsDevice.gl;e.deleteFramebuffer(this._frameBufferSource),this._frameBufferSource=null,e.deleteFramebuffer(this._frameBuffer),this._frameBuffer=null;}}constructor(e,t,s){super(),this._positionData=new Float32Array(3),this._viewport=new em,this._projMat=new ex,this._projViewOffMat=new ex,this._viewMat=new ex,this._viewOffMat=new ex,this._viewMat3=new ep,this._viewInvMat=new ex,this._viewInvOffMat=new ex,this._xrCamera=null,this._textureColor=null,this._textureDepth=null,this._depthInfo=null,this._emptyDepthBuffer=new Uint8Array(32),this._depthMatrix=new ex,this._manager=e,this._xrView=t;let i=this._manager.app.graphicsDevice;if(this._manager.views.supportedColor&&(this._xrCamera=this._xrView.camera,this._manager.views.availableColor&&this._xrCamera&&(this._textureColor=new se(i,{format:6,mipmaps:false,addressU:1,addressV:1,minFilter:1,magFilter:1,width:this._xrCamera.width,height:this._xrCamera.height,name:"XrView-"+this._xrView.eye+"-Color"}))),this._manager.views.supportedDepth&&this._manager.views.availableDepth){let e=+!this._manager.views.depthGpuOptimized;this._textureDepth=new se(i,{format:this._manager.views.depthPixelFormat,arrayLength:1===s?0:s,mipmaps:false,addressU:1,addressV:1,minFilter:e,magFilter:e,width:4,height:4,name:"XrView-"+this._xrView.eye+"-Depth"});for(let e=0;e<this._textureDepth._levels.length;e++)this._textureDepth._levels[e]=this._emptyDepthBuffer;this._textureDepth.upload();}(this._textureColor||this._textureDepth)&&i.on("devicelost",this._onDeviceLost,this);}}xe.EVENT_DEPTHRESIZE="depth:resize";class xt extends Y{get list(){return this._list}get supportedColor(){return this._supportedColor}get supportedDepth(){return this._supportedDepth}get availableColor(){return this._availableColor}get availableDepth(){return this._availableDepth}get depthUsage(){return this._depthUsage}get depthGpuOptimized(){return this._depthUsage===SC}get depthFormat(){return this._depthFormat}get depthPixelFormat(){var e;return null!=(e=this._depthFormats[this._depthFormat])?e:null}update(e,t){for(let e=0;e<t.length;e++)this._indexTmp.set(t[e].eye,t[e]);for(let[s,i]of this._indexTmp){let n=this._index.get(s);n?n.update(e,i):(n=new xe(this._manager,i,t.length),this._index.set(s,n),this._list.push(n),n.update(e,i),this.fire("add",n));}for(let[e,t]of this._index){if(this._indexTmp.has(e))continue;t.destroy(),this._index.delete(e);let s=this._list.indexOf(t);-1!==s&&this._list.splice(s,1),this.fire("remove",t);}this._indexTmp.clear();}get(e){return this._index.get(e)||null}_onSessionStart(){if(this._manager.type===Sb&&this._manager.session.enabledFeatures&&(this._availableColor=-1!==this._manager.session.enabledFeatures.indexOf("camera-access"),this._availableDepth=-1!==this._manager.session.enabledFeatures.indexOf("depth-sensing"),this._availableDepth)){let e=this._manager.session;this._depthUsage=e.depthUsage,this._depthFormat=e.depthDataFormat;}}_onSessionEnd(){for(let e of this._index.values())e.destroy();this._index.clear(),this._availableColor=false,this._availableDepth=false,this._depthUsage="",this._depthFormat="",this._list.length=0;}constructor(e){super(),this._index=new Map,this._indexTmp=new Map,this._list=[],this._supportedColor=k.browser&&!!window.XRCamera&&!!window.XRWebGLBinding,this._supportedDepth=k.browser&&!!window.XRDepthInformation,this._availableColor=false,this._availableDepth=false,this._depthUsage="",this._depthFormat="",this._depthFormats={[SP]:2,[SM]:16,[SI]:15},this._manager=e,this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this);}}xt.EVENT_ADD="add",xt.EVENT_REMOVE="remove";class xs extends Y{destroy(){}start(e,t,s,i){var n,r;let a=i;if("object"==typeof i&&(a=i.callback),!this._available[t]){a&&a(Error("XR is not available"));return}if(this._session){a&&a(Error("XR session is already started"));return}this._camera=e,this._camera.camera.xr=this,this._type=t,this._spaceType=s,this._framebufferScaleFactor=null!=(r=null==i?void 0:i.framebufferScaleFactor)?r:1,this._setClipPlanes(e.nearClip,e.farClip);let o={requiredFeatures:[s],optionalFeatures:[]},l=null==(n=this.app.graphicsDevice)?void 0:n.isWebGL2;if(t===Sb){if(o.optionalFeatures.push("light-estimation"),o.optionalFeatures.push("hit-test"),i&&(i.imageTracking&&this.imageTracking.supported&&o.optionalFeatures.push("image-tracking"),i.planeDetection&&o.optionalFeatures.push("plane-detection"),i.meshDetection&&o.optionalFeatures.push("mesh-detection")),this.domOverlay.supported&&this.domOverlay.root&&(o.optionalFeatures.push("dom-overlay"),o.domOverlay={root:this.domOverlay.root}),i&&i.anchors&&this.anchors.supported&&o.optionalFeatures.push("anchors"),i&&i.depthSensing&&this.views.supportedDepth){o.optionalFeatures.push("depth-sensing");let e=[],t=[];if(e.push(SC,Sw),t.push(SI,SP,SM),i.depthSensing.usagePreference){let t=e.indexOf(i.depthSensing.usagePreference);-1!==t&&e.splice(t,1),e.unshift(i.depthSensing.usagePreference);}if(i.depthSensing.dataFormatPreference){let e=t.indexOf(i.depthSensing.dataFormatPreference);-1!==e&&t.splice(e,1),t.unshift(i.depthSensing.dataFormatPreference);}o.depthSensing={usagePreference:e,dataFormatPreference:t};}l&&i&&i.cameraColor&&this.views.supportedColor&&o.optionalFeatures.push("camera-access");}o.optionalFeatures.push("hand-tracking"),i&&i.optionalFeatures&&(o.optionalFeatures=o.optionalFeatures.concat(i.optionalFeatures)),this.imageTracking.supported&&this.imageTracking.images.length?this.imageTracking.prepareImages((e,i)=>{if(e){a&&a(e),this.fire("error",e);return}null!==i&&(o.trackedImages=i),this._onStartOptionsReady(t,s,o,a);}):this._onStartOptionsReady(t,s,o,a);}_onStartOptionsReady(e,t,s,i){navigator.xr.requestSession(e,s).then(e=>{this._onSessionStart(e,t,i);}).catch(e=>{this._camera.camera.xr=null,this._camera=null,this._type=null,this._spaceType=null,i&&i(e),this.fire("error",e);});}end(e){if(!this._session){e&&e(Error("XR Session is not initialized"));return}this.webglBinding=null,e&&this.once("end",e),this._session.end();}isAvailable(e){return this._available[e]}_deviceAvailabilityCheck(){for(let e in this._available)this._sessionSupportCheck(e);}initiateRoomCapture(e){if(!this._session){e(Error("Session is not active"));return}if(!this._session.initiateRoomCapture){e(Error("Session does not support manual room capture"));return}this._session.initiateRoomCapture().then(()=>{e&&e(null);}).catch(t=>{e&&e(t);});}updateTargetFrameRate(e,t){var s;if(!(null==(s=this._session)?void 0:s.updateTargetFrameRate)){null==t||t(Error("unable to update frameRate"));return}this._session.updateTargetFrameRate(e).then(()=>{null==t||t();}).catch(e=>{null==t||t(e);});}_sessionSupportCheck(e){navigator.xr.isSessionSupported(e).then(t=>{this._available[e]!==t&&(this._available[e]=t,this.fire("available",e,t),this.fire("available:"+e,t));}).catch(e=>{this.fire("error",e);});}_onSessionStart(e,t,s){let i=false;this._session=e;let n=()=>{this.fire("visibility:change",e.visibilityState);},r=()=>{this._setClipPlanes(this._camera.nearClip,this._camera.farClip);},a=()=>{this._camera&&(this._camera.off("set_nearClip",r),this._camera.off("set_farClip",r),this._camera.camera.xr=null,this._camera=null),e.removeEventListener("end",a),e.removeEventListener("visibilitychange",n),i||this.fire("end"),this._session=null,this._referenceSpace=null,this._width=0,this._height=0,this._type=null,this._spaceType=null,this.app.systems&&this.app.tick();};e.addEventListener("end",a),e.addEventListener("visibilitychange",n),this._camera.on("set_nearClip",r),this._camera.on("set_farClip",r),this._createBaseLayer(),this.session.supportedFrameRates?this._supportedFrameRates=Array.from(this.session.supportedFrameRates):this._supportedFrameRates=null,this._session.addEventListener("frameratechange",()=>{var e;this.fire("frameratechange",null==(e=this._session)?void 0:e.frameRate);}),e.requestReferenceSpace(t).then(e=>{this._referenceSpace=e,this.app.tick(),s&&s(null),this.fire("start");}).catch(t=>{i=true,e.end(),s&&s(t),this.fire("error",t);});}_setClipPlanes(e,t){if(this._depthNear!==e||this._depthFar!==t)this._depthNear=e,this._depthFar=t,this._session&&this._session.updateRenderState({depthNear:this._depthNear,depthFar:this._depthFar});}_createBaseLayer(){let e=this.app.graphicsDevice,t=e.maxPixelRatio/window.devicePixelRatio*this._framebufferScaleFactor;if(this._baseLayer=new XRWebGLLayer(this._session,e.gl,{alpha:true,depth:true,stencil:true,framebufferScaleFactor:t,antialias:false}),(null==e?void 0:e.isWebGL2)&&window.XRWebGLBinding)try{this.webglBinding=new XRWebGLBinding(this._session,e.gl);}catch(e){this.fire("error",e);}this._session.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar});}_onDeviceLost(){this._session&&(this.webglBinding&&(this.webglBinding=null),this._baseLayer=null,this._session.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar}));}_onDeviceRestored(){this._session&&setTimeout(()=>{this.app.graphicsDevice.gl.makeXRCompatible().then(()=>{this._createBaseLayer();}).catch(e=>{this.fire("error",e);});},0);}update(e){if(!this._session)return  false;let t=e.session.renderState.baseLayer.framebufferWidth,s=e.session.renderState.baseLayer.framebufferHeight;(this._width!==t||this._height!==s)&&(this._width=t,this._height=s,this.app.graphicsDevice.setResolution(t,s));let i=e.getViewerPose(this._referenceSpace);if(!i)return  false;let n=this.views.list.length;this.views.update(e,i.views);let r=i.transform.position,a=i.transform.orientation;if(this._localPosition.set(r.x,r.y,r.z),this._localRotation.set(a.x,a.y,a.z,a.w),0===n&&this.views.list.length>0){let e=new ex,t=this.views.list[0];e.copy(t.projMat);let s=e.data,i=2*Math.atan(1/s[5])*180/Math.PI,n=s[5]/s[0],r=s[14]/(s[10]+1),a=s[14]/(s[10]-1);this._camera.camera.setXrProperties({aspectRatio:n,farClip:r,fov:i,horizontalFov:false,nearClip:a});}return this._camera.camera._node.setLocalPosition(this._localPosition),this._camera.camera._node.setLocalRotation(this._localRotation),this.input.update(e),this._type===Sb&&(this.hitTest.supported&&this.hitTest.update(e),this.lightEstimation.supported&&this.lightEstimation.update(e),this.imageTracking.supported&&this.imageTracking.update(e),this.anchors.supported&&this.anchors.update(e),this.planeDetection.supported&&this.planeDetection.update(e),this.meshDetection.supported&&this.meshDetection.update(e)),this.fire("update",e),true}get supported(){return this._supported}get active(){return !!this._session}get type(){return this._type}get spaceType(){return this._spaceType}get session(){return this._session}get frameRate(){var e,t;return null!=(t=null==(e=this._session)?void 0:e.frameRate)?t:null}get supportedFrameRates(){return this._supportedFrameRates}get framebufferScaleFactor(){return this._framebufferScaleFactor}set fixedFoveation(e){var t,s;(null!=(s=null==(t=this._baseLayer)?void 0:t.fixedFoveation)?s:null)!==null&&(this.app.graphicsDevice.samples,this._baseLayer.fixedFoveation=e);}get fixedFoveation(){var e,t;return null!=(t=null==(e=this._baseLayer)?void 0:e.fixedFoveation)?t:null}get camera(){return this._camera?this._camera.entity:null}get visibilityState(){return this._session?this._session.visibilityState:null}constructor(e){super(),this._supported=k.browser&&!!navigator.xr,this._available={},this._type=null,this._spaceType=null,this._session=null,this._baseLayer=null,this.webglBinding=null,this._referenceSpace=null,this._camera=null,this._localPosition=new eu,this._localRotation=new eT,this._depthNear=.1,this._depthFar=1e3,this._supportedFrameRates=null,this._width=0,this._height=0,this._framebufferScaleFactor=1,this.app=e,this._available[Sx]=false,this._available[ST]=false,this._available[Sb]=false,this.views=new xt(this),this.domOverlay=new SR(this),this.hitTest=new SF(this),this.imageTracking=new SB(this),this.planeDetection=new S5(this),this.meshDetection=new S7(this),this.input=new SQ(this),this.lightEstimation=new S2(this),this.anchors=new S8(this),this.views=new xt(this),this._supported&&(navigator.xr.addEventListener("devicechange",()=>{this._deviceAvailabilityCheck();}),this._deviceAvailabilityCheck(),this.app.graphicsDevice.on("devicelost",this._onDeviceLost,this),this.app.graphicsDevice.on("devicerestored",this._onDeviceRestored,this));}}xs.EVENT_AVAILABLE="available",xs.EVENT_START="start",xs.EVENT_END="end",xs.EVENT_UPDATE="update",xs.EVENT_ERROR="error";class xi{destroy(){this.texture.destroy();}clear(e){let{width:t,height:s}=this.canvas;this.ctx.clearRect(0,0,t,s),this.ctx.fillStyle=e,this.ctx.fillRect(0,0,t,s);}constructor(e,t,s,i){this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=s,this.texture=new se(e,{name:i,format:20,width:t,height:s,mipmaps:true,minFilter:5,magFilter:1,addressU:1,addressV:1,levels:[this.canvas]}),this.ctx=this.canvas.getContext("2d",{alpha:true});}}let xn=[],xr=[[],[],[]];class xa extends nK{destroy(){this.viewBindGroups.forEach(e=>{e.defaultUniformBuffer.destroy(),e.destroy();}),this.viewBindGroups.length=0;}update(e,t,s,i){this.camera=e,this.scene=t,this.layers=s,this.mapping=i;}execute(){let e=this.device,{renderer:t,camera:s,scene:i,layers:n,mapping:r,renderTarget:a}=this,o=i.layers.layerList,l=i.layers.subLayerEnabled,h=i.layers.subLayerList;for(let d=0;d<o.length;d++){let c=o[d];if(!(n&&0>n.indexOf(c))&&c.enabled&&l[d]&&c.camerasSet.has(s.camera)){let n=h[d];c._clearDepthBuffer&&t.clear(s.camera,false,true,false);let o=c.meshInstances;for(let e=0;e<o.length;e++){let t=o[e];t.pick&&t.transparent===n&&(xn.push(t),r.set(t.id,t));}xn.length>0&&(i.clusteredLightingEnabled&&t.worldClustersAllocator.empty.activate(),t.setCameraUniforms(s.camera,a),e.supportsUniformBuffers&&t.setupViewUniformBuffers(this.viewBindGroups,t.viewUniformFormat,t.viewBindGroupFormat,1),t.renderForward(s.camera,a,xn,xr,3,t=>{e.setBlendState(sh.NOBLEND);}),xn.length=0);}}}constructor(e,t){super(e),this.viewBindGroups=[],this.renderer=t;}}let xo=new Set,xl=new em,xh=new eu,xd=new eu,xc=new eO,xu=new eO,xp=new eO;xc.end=new eu,xu.end=new eu,xp.end=new eu;let xf=new eu,xm=new eu,x_=new eu,xg=new eu,xv=new eu,xy=new eu,xS=new eu,xx=new eu,xT=new eu,xb=new eu,xE=new eu,xA=new eu,xw=new eu,xC=new eu,xP=new eu,xM=new eu,xI=new eu,xR=new eu,xL=new eu,xD=new eu,xO=new em;function xF(e,t,s){return xE.cross(e,t).dot(s)}class xN{stopPropagation(){this._stopPropagation=true,this.event&&(this.event.stopImmediatePropagation(),this.event.stopPropagation());}constructor(e,t,s){this.event=e,this.element=t,this.camera=s,this._stopPropagation=false;}}class xB extends xN{constructor(e,t,s,i,n,r,a){super(e,t,s),this.x=i,this.y=n,this.ctrlKey=e.ctrlKey||false,this.altKey=e.altKey||false,this.shiftKey=e.shiftKey||false,this.metaKey=e.metaKey||false,this.button=e.button,ru.isPointerLocked()?(this.dx=e.movementX||e.webkitMovementX||e.mozMovementX||0,this.dy=e.movementY||e.webkitMovementY||e.mozMovementY||0):(this.dx=i-r,this.dy=n-a),this.wheelDelta=0,"wheel"===e.type&&(e.deltaY>0?this.wheelDelta=1:e.deltaY<0&&(this.wheelDelta=-1));}}class xU extends xN{constructor(e,t,s,i,n,r){super(e,t,s),this.touches=e.touches,this.changedTouches=e.changedTouches,this.x=i,this.y=n,this.touch=r;}}class xk extends xN{constructor(e,t,s,i){super(e,t,s),this.inputSource=i;}}class xz{set enabled(e){this._enabled=e;}get enabled(){return this._enabled}set app(e){this._app=e;}get app(){return this._app||n}attach(e){this._attached&&(this._attached=false,this.detach()),this._target=e,this._attached=true;let t=!!k.passiveEvents&&{passive:true};this._useMouse&&(window.addEventListener("mouseup",this._upHandler,t),window.addEventListener("mousedown",this._downHandler,t),window.addEventListener("mousemove",this._moveHandler,t),window.addEventListener("wheel",this._wheelHandler,t)),this._useTouch&&k.touch&&(this._target.addEventListener("touchstart",this._touchstartHandler,t),this._target.addEventListener("touchend",this._touchendHandler,false),this._target.addEventListener("touchmove",this._touchmoveHandler,false),this._target.addEventListener("touchcancel",this._touchcancelHandler,false)),this.attachSelectEvents();}attachSelectEvents(){!this._selectEventsAttached&&this._useXr&&this.app&&this.app.xr&&this.app.xr.supported&&(this._clickedEntities||(this._clickedEntities={}),this._selectEventsAttached=true,this.app.xr.on("start",this._onXrStart,this));}detach(){if(!this._attached)return;this._attached=false;let e=!!k.passiveEvents&&{passive:true};this._useMouse&&(window.removeEventListener("mouseup",this._upHandler,e),window.removeEventListener("mousedown",this._downHandler,e),window.removeEventListener("mousemove",this._moveHandler,e),window.removeEventListener("wheel",this._wheelHandler,e)),this._useTouch&&(this._target.removeEventListener("touchstart",this._touchstartHandler,e),this._target.removeEventListener("touchend",this._touchendHandler,false),this._target.removeEventListener("touchmove",this._touchmoveHandler,false),this._target.removeEventListener("touchcancel",this._touchcancelHandler,false)),this._selectEventsAttached&&(this._selectEventsAttached=false,this.app.xr.off("start",this._onXrStart,this),this.app.xr.off("end",this._onXrEnd,this),this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this)),this._target=null;}addElement(e){ -1===this._elements.indexOf(e)&&this._elements.push(e);}removeElement(e){let t=this._elements.indexOf(e);-1!==t&&this._elements.splice(t,1);}_handleUp(e){this._enabled&&!ru.isPointerLocked()&&(this._calcMouseCoords(e),this._onElementMouseEvent("mouseup",e));}_handleDown(e){this._enabled&&!ru.isPointerLocked()&&(this._calcMouseCoords(e),this._onElementMouseEvent("mousedown",e));}_handleMove(e){this._enabled&&(this._calcMouseCoords(e),this._onElementMouseEvent("mousemove",e),this._lastX=g,this._lastY=v);}_handleWheel(e){this._enabled&&(this._calcMouseCoords(e),this._onElementMouseEvent("mousewheel",e));}_determineTouchedElements(e){let t={},s=this.app.systems.camera.cameras;for(let i=s.length-1;i>=0;i--){let n=s[i],r=0,a=e.changedTouches.length;for(let s=0;s<a;s++){if(t[e.changedTouches[s].identifier]){r++;continue}let i=rw(e.changedTouches[s]),a=this._getTargetElementByCoords(n,i.x,i.y);a&&(r++,t[e.changedTouches[s].identifier]={element:a,camera:n,x:i.x,y:i.y});}if(r===a)break}return t}_handleTouchStart(e){if(!this._enabled)return;let t=this._determineTouchedElements(e);for(let s=0,i=e.changedTouches.length;s<i;s++){let i=e.changedTouches[s],n=t[i.identifier],r=this._touchedElements[i.identifier];n&&(!r||n.element!==r.element)&&(this._fireEvent(e.type,new xU(e,n.element,n.camera,n.x,n.y,i)),this._touchesForWhichTouchLeaveHasFired[i.identifier]=false);}for(let e in t)this._touchedElements[e]=t[e];}_handleTouchEnd(e){if(!this._enabled)return;let t=this.app.systems.camera.cameras;for(let e in this._clickedEntities)delete this._clickedEntities[e];for(let s=0,i=e.changedTouches.length;s<i;s++){let i=e.changedTouches[s],n=this._touchedElements[i.identifier];if(!n)continue;let r=n.element,a=n.camera,o=n.x,l=n.y;delete this._touchedElements[i.identifier],delete this._touchesForWhichTouchLeaveHasFired[i.identifier];let h=rw(i);for(let s=t.length-1;s>=0;s--)this._getTargetElementByCoords(t[s],h.x,h.y)!==r||this._clickedEntities[r.entity.getGuid()]||(this._fireEvent("click",new xU(e,r,a,o,l,i)),this._clickedEntities[r.entity.getGuid()]=Date.now());this._fireEvent(e.type,new xU(e,r,a,o,l,i));}}_handleTouchMove(e){if(e.preventDefault(),!this._enabled)return;let t=this._determineTouchedElements(e);for(let s=0,i=e.changedTouches.length;s<i;s++){let i=e.changedTouches[s],n=t[i.identifier],r=this._touchedElements[i.identifier];if(r){let t=rw(i);n&&n.element===r.element||this._touchesForWhichTouchLeaveHasFired[i.identifier]||(this._fireEvent("touchleave",new xU(e,r.element,r.camera,t.x,t.y,i)),this._touchesForWhichTouchLeaveHasFired[i.identifier]=true),this._fireEvent("touchmove",new xU(e,r.element,r.camera,t.x,t.y,i));}}}_onElementMouseEvent(e,t){let s,i=null,n=this._hoveredElement;this._hoveredElement=null;let r=this.app.systems.camera.cameras;for(let e=r.length-1;e>=0&&(s=r[e],!(i=this._getTargetElementByCoords(s,g,v)));e--);if(this._hoveredElement=i,("mousemove"===e||"mouseup"===e)&&this._pressedElement?this._fireEvent(e,new xB(t,this._pressedElement,s,g,v,this._lastX,this._lastY)):i&&(this._fireEvent(e,new xB(t,i,s,g,v,this._lastX,this._lastY)),"mousedown"===e&&(this._pressedElement=i)),n!==this._hoveredElement&&(n&&this._fireEvent("mouseleave",new xB(t,n,s,g,v,this._lastX,this._lastY)),this._hoveredElement&&this._fireEvent("mouseenter",new xB(t,this._hoveredElement,s,g,v,this._lastX,this._lastY))),"mouseup"===e&&this._pressedElement){if(this._pressedElement===this._hoveredElement){let e=this._hoveredElement.entity.getGuid(),i=!this._clickedEntities;if(this._clickedEntities){let t=this._clickedEntities[e]||0;i=Date.now()-t>300,delete this._clickedEntities[e];}i&&this._fireEvent("click",new xB(t,this._hoveredElement,s,g,v,this._lastX,this._lastY));}this._pressedElement=null;}}_onXrStart(){this.app.xr.on("end",this._onXrEnd,this),this.app.xr.on("update",this._onXrUpdate,this),this.app.xr.input.on("selectstart",this._onSelectStart,this),this.app.xr.input.on("selectend",this._onSelectEnd,this),this.app.xr.input.on("remove",this._onXrInputRemove,this);}_onXrEnd(){this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this);}_onXrUpdate(){if(!this._enabled)return;let e=this.app.xr.input.inputSources;for(let t=0;t<e.length;t++)this._onElementSelectEvent("selectmove",e[t],null);}_onXrInputRemove(e){let t=this._selectedElements[e.id];t&&(e._elementEntity=null,this._fireEvent("selectleave",new xk(null,t,null,e))),delete this._selectedElements[e.id],delete this._selectedPressedElements[e.id];}_onSelectStart(e,t){this._enabled&&this._onElementSelectEvent("selectstart",e,t);}_onSelectEnd(e,t){this._enabled&&this._onElementSelectEvent("selectend",e,t);}_onElementSelectEvent(e,t,s){let i,n,r;let a=this._selectedElements[t.id],o=this.app.systems.camera.cameras;if(t.elementInput){xp.set(t.getOrigin(),t.getDirection());for(let e=o.length-1;e>=0&&(r=o[e],!(i=this._getTargetElementByRay(xp,r)));e--);}t._elementEntity=i||null,i?(this._selectedElements[t.id]=i,n=i):delete this._selectedElements[t.id],a!==n&&(a&&this._fireEvent("selectleave",new xk(s,a,r,t)),n&&this._fireEvent("selectenter",new xk(s,n,r,t)));let l=this._selectedPressedElements[t.id];"selectmove"===e&&l&&this._fireEvent("selectmove",new xk(s,l,r,t)),"selectstart"===e&&(this._selectedPressedElements[t.id]=n,n&&this._fireEvent("selectstart",new xk(s,n,r,t))),!t.elementInput&&l&&(delete this._selectedPressedElements[t.id],a&&this._fireEvent("selectend",new xk(s,l,r,t))),"selectend"===e&&t.elementInput&&(delete this._selectedPressedElements[t.id],l&&this._fireEvent("selectend",new xk(s,l,r,t)),l&&l===a&&this._fireEvent("click",new xk(s,l,r,t)));}_fireEvent(e,t){let s=t.element;for(;s.fire(e,t),!t._stopPropagation&&s.entity.parent&&(s=s.entity.parent.element););}_calcMouseCoords(e){let t=this._target.getBoundingClientRect(),s=Math.floor(t.left),i=Math.floor(t.top);g=e.clientX-s,v=e.clientY-i;}_sortElements(e,t){let s=this.app.scene.layers.sortTransparentLayers(e.layers,t.layers);return 0!==s?s:e.screen&&!t.screen?-1:!e.screen&&t.screen?1:e.screen||t.screen?e.screen.screen.screenSpace&&!t.screen.screen.screenSpace?-1:t.screen.screen.screenSpace&&!e.screen.screen.screenSpace?1:t.drawOrder-e.drawOrder:0}_getTargetElementByCoords(e,t,s){let i=this._calculateRayScreen(t,s,e,xc)?xc:null,n=this._calculateRay3d(t,s,e,xu)?xu:null;return this._getTargetElement(e,i,n)}_getTargetElementByRay(e,t){xc.origin.copy(e.origin),xc.direction.copy(e.direction),xc.end.copy(xc.direction).mulScalar(2*t.farClip).add(xc.origin);let s=t.worldToScreen(xc.origin,xh),i=this._calculateRayScreen(s.x,s.y,t,xu)?xu:null;return this._getTargetElement(t,i,xc)}_getTargetElement(e,t,s){let i=null,n=1/0;this._elements.sort(this._sortHandler);for(let r=0,a=this._elements.length;r<a;r++){let a=this._elements[r];if(a.layers.some(t=>e.layersSet.has(t))){if(a.screen&&a.screen.screen.screenSpace){if(!t)continue;if(this._checkElement(t,a,true)>=0){i=a;break}}else {if(!s)continue;let e=this._checkElement(s,a,false);if(e>=0&&(e<n&&(i=a,n=e),a.screen)){i=a;break}}}}return i}_calculateRayScreen(e,t,s,i){let n=this.app.graphicsDevice.width,r=this.app.graphicsDevice.height,a=s.rect.z*n,o=s.rect.w*r,l=s.rect.x*n,h=(1-s.rect.y)*r,d=h-o,c=e*n/this._target.clientWidth,u=t*r/this._target.clientHeight;return c>=l&&c<=l+a&&u<=h&&u>=d&&(c=n*(c-l)/a,u=r*(u-d)/o,u=r-u,i.origin.set(c,u,1),i.direction.set(0,0,-1),i.end.copy(i.direction).mulScalar(2).add(i.origin),true)}_calculateRay3d(e,t,s,i){let n=this._target.clientWidth,r=this._target.clientHeight,a=s.rect.z*n,o=s.rect.w*r,l=s.rect.x*n,h=(1-s.rect.y)*r,d=h-o,c=e,u=t;return e>=l&&e<=l+a&&t<=h&&u>=d&&(c=n*(c-l)/a,u=r*(u-d)/o,s.screenToWorld(c,u,s.nearClip,xh),s.screenToWorld(c,u,s.farClip,xd),i.origin.copy(xh),i.direction.set(0,0,-1),i.end.copy(xd),true)}_checkElement(e,t,s){let i;if(t.maskedBy&&0>this._checkElement(e,t.maskedBy.element,s))return -1;i=s?xz.calculateScaleToScreen(t):xz.calculateScaleToWorld(t);let n=xz.buildHitCorners(t,s?t.screenCorners:t.worldCorners,i);return function(e,t,s){let i,n;xf.sub2(t,e),xm.sub2(s[0],e),x_.sub2(s[1],e),xg.sub2(s[2],e),xy.cross(xg,xf);let r=xm.dot(xy);if(r>=0){if((i=-x_.dot(xy))<0||(n=xF(xf,x_,xm))<0)return -1;let e=1/(i+r+n);xS.copy(s[0]).mulScalar(i*e),xx.copy(s[1]).mulScalar(r*e),xT.copy(s[2]).mulScalar(n*e),xb.copy(xS).add(xx).add(xT);}else {if(xv.sub2(s[3],e),(i=xv.dot(xy))<0||(n=xF(xf,xm,xv))<0)return -1;let t=1/(i+(r=-r)+n);xS.copy(s[0]).mulScalar(i*t),xx.copy(s[3]).mulScalar(r*t),xT.copy(s[2]).mulScalar(n*t),xb.copy(xS).add(xx).add(xT);}return 1e-8>xf.sub2(s[0],s[2]).lengthSq()||1e-8>xf.sub2(s[1],s[3]).lengthSq()?-1:xb.sub(e).lengthSq()}(e.origin,e.end,n)}static buildHitCorners(e,t,s){let i=t;if(e.entity&&e.entity.button){let t=e.entity.button.hitPadding||xO;xw.copy(e.entity.up),xC.copy(xw).mulScalar(-1),xM.copy(e.entity.right),xP.copy(xM).mulScalar(-1),xw.mulScalar(t.w*s.y),xC.mulScalar(t.y*s.y),xM.mulScalar(t.z*s.x),xP.mulScalar(t.x*s.x),xI.copy(i[0]).add(xC).add(xP),xR.copy(i[1]).add(xC).add(xM),xL.copy(i[2]).add(xw).add(xM),xD.copy(i[3]).add(xw).add(xP),i=[xI,xR,xL,xD];}if(s.x<0){let e=i[2].x,t=i[0].x;i[0].x=e,i[1].x=t,i[2].x=t,i[3].x=e;}if(s.y<0){let e=i[2].y,t=i[0].y;i[0].y=e,i[1].y=e,i[2].y=t,i[3].y=t;}if(s.z<0){let e=i[2].x,t=i[2].y,s=i[2].z;i[2].x=i[0].x,i[2].y=i[0].y,i[2].z=i[0].z,i[0].x=e,i[0].y=t,i[0].z=s;}return i}static calculateScaleToScreen(e){let t=e.entity,s=e.screen.screen.scale;for(xA.set(s,s,s);t&&!t.screen;)xA.mul(t.getLocalScale()),t=t.parent;return xA}static calculateScaleToWorld(e){let t=e.entity;for(xA.set(1,1,1);t;)xA.mul(t.getLocalScale()),t=t.parent;return xA}constructor(e,t){this._app=null,this._attached=false,this._target=null,this._enabled=true,this._lastX=0,this._lastY=0,this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._touchstartHandler=this._handleTouchStart.bind(this),this._touchendHandler=this._handleTouchEnd.bind(this),this._touchcancelHandler=this._touchendHandler,this._touchmoveHandler=this._handleTouchMove.bind(this),this._sortHandler=this._sortElements.bind(this),this._elements=[],this._hoveredElement=null,this._pressedElement=null,this._touchedElements={},this._touchesForWhichTouchLeaveHasFired={},this._selectedElements={},this._selectedPressedElements={},this._useMouse=!t||false!==t.useMouse,this._useTouch=!t||false!==t.useTouch,this._useXr=!t||false!==t.useXr,this._selectEventsAttached=false,k.touch&&(this._clickedEntities={}),this.attach(e);}}ef.prototype.scale=ef.prototype.mulScalar,eu.prototype.scale=eu.prototype.mulScalar,em.prototype.scale=em.prototype.mulScalar;let xV=new em;["ambientPrefilteredCube.frag","ambientPrefilteredCubeLod.frag","dpAtlasQuad.frag","genParaboloid.frag","prefilterCubemap.frag","reflectionDpAtlas.frag","reflectionPrefilteredCube.frag","reflectionPrefilteredCubeLod.frag"].forEach(e=>{Object.defineProperty(am,e,{get:function(){return null},set:function(){}});}),Object.defineProperties(sR.prototype,{_glFrameBuffer:{get:function(){return this.impl._glFrameBuffer},set:function(e){}}}),Object.defineProperty(sA,"defaultInstancingFormat",{get:function(){return null}}),Object.defineProperties(se.prototype,{rgbm:{get:function(){return this.type===tE},set:function(e){this.type=e?tE:tb;}},swizzleGGGR:{get:function(){return this.type===tC},set:function(e){this.type=e?tC:tb;}},_glTexture:{get:function(){return this.impl._glTexture}}}),Object.defineProperty(sM.prototype,"boneLimit",{get:function(){return 1024}}),Object.defineProperty(sM.prototype,"webgl2",{get:function(){return this.isWebGL2}}),Object.defineProperty(sM.prototype,"textureFloatHighPrecision",{get:function(){return  true}}),Object.defineProperty(sM.prototype,"extBlendMinmax",{get:function(){return  true}}),Object.defineProperty(sM.prototype,"extTextureHalfFloat",{get:function(){return  true}}),Object.defineProperty(sM.prototype,"extTextureLod",{get:function(){return  true}}),Object.defineProperty(sM.prototype,"textureHalfFloatFilterable",{get:function(){return  true}}),Object.defineProperty(sM.prototype,"supportsMrt",{get:function(){return  true}}),Object.defineProperty(sM.prototype,"supportsVolumeTextures",{get:function(){return  true}}),Object.defineProperty(sM.prototype,"supportsInstancing",{get:function(){return  true}}),Object.defineProperty(sM.prototype,"textureHalfFloatUpdatable",{get:function(){return  true}}),Object.defineProperty(sM.prototype,"extTextureFloat",{get:function(){return  true}}),Object.defineProperty(sM.prototype,"extStandardDerivatives",{get:function(){return  true}}),sh.DEFAULT=Object.freeze(new sh);let xG=new sh,xH=new su;function xW(e,t,s){Object.defineProperty(e.prototype,t,{set:function(e){},get:function(){}});}function xX(e,t){Object.defineProperty(cP.prototype,t,{get:function(){return this[e]},set:function(t){this[e]=t;}});}function xY(e){Object.defineProperty(cP.prototype,e,{get:function(){return  true},set:function(e){}});}function xj(e,t){"pass"!==e&&Object.defineProperty(ch.prototype,e,{get:function(){return this.litOptions[t||e]},set:function(s){this.litOptions[t||e]=s;}});}sM.prototype.setBlendFunction=function(e,t){let s=this.blendState;xG.copy(s),xG.setColorBlend(s.colorOp,e,t),xG.setAlphaBlend(s.alphaOp,e,t),this.setBlendState(xG);},sM.prototype.setBlendFunctionSeparate=function(e,t,s,i){let n=this.blendState;xG.copy(n),xG.setColorBlend(n.colorOp,e,t),xG.setAlphaBlend(n.alphaOp,s,i),this.setBlendState(xG);},sM.prototype.setBlendEquation=function(e){let t=this.blendState;xG.copy(t),xG.setColorBlend(e,t.colorSrcFactor,t.colorDstFactor),xG.setAlphaBlend(e,t.alphaSrcFactor,t.alphaDstFactor),this.setBlendState(xG);},sM.prototype.setBlendEquationSeparate=function(e,t){let s=this.blendState;xG.copy(s),xG.setColorBlend(e,s.colorSrcFactor,s.colorDstFactor),xG.setAlphaBlend(t,s.alphaSrcFactor,s.alphaDstFactor),this.setBlendState(xG);},sM.prototype.setColorWrite=function(e,t,s,i){let n=this.blendState;xG.copy(n),xG.setColorWrite(e,t,s,i),this.setBlendState(xG);},sM.prototype.getBlending=function(){return this.blendState.blend},sM.prototype.setBlending=function(e){xG.copy(this.blendState),xG.blend=e,this.setBlendState(xG);},sM.prototype.setDepthWrite=function(e){xH.copy(this.depthState),xH.write=e,this.setDepthState(xH);},sM.prototype.setDepthFunc=function(e){xH.copy(this.depthState),xH.func=e,this.setDepthState(xH);},sM.prototype.setDepthTest=function(e){xH.copy(this.depthState),xH.test=e,this.setDepthState(xH);},sM.prototype.getCullMode=function(){return this.cullMode},Object.defineProperty(dK.prototype,"defaultMaterial",{get:function(){return aW(n.graphicsDevice)}}),Object.defineProperty(dK.prototype,"fogColor",{set:function(e){this.fog.color=e;},get:function(){return this.fog.color}}),Object.defineProperty(dK.prototype,"fogEnd",{set:function(e){this.fog.end=e;},get:function(){return this.fog.end}}),Object.defineProperty(dK.prototype,"fogStart",{set:function(e){this.fog.start=e;},get:function(){return this.fog.start}}),Object.defineProperty(dK.prototype,"fogDensity",{set:function(e){this.fog.density=e;},get:function(){return this.fog.density}}),Object.defineProperty(dK.prototype,"toneMapping",{set:function(e){},get:function(){}}),Object.defineProperty(dK.prototype,"gammaCorrection",{set:function(e){},get:function(){}}),Object.defineProperty(dK.prototype,"rendering",{set:function(e){},get:function(){}}),Object.defineProperty(l5.prototype,"_meshInstances",{get:function(){return null}}),Object.defineProperty(dK.prototype,"drawCalls",{get:function(){return null}}),["128","64","32","16","8","4"].forEach((e,t)=>{Object.defineProperty(dK.prototype,"skyboxPrefiltered"+e,{get:function(){return this._prefilteredCubemaps[t]},set:function(e){this._prefilteredCubemaps[t]=e,this.updateShaders=true;}});}),Object.defineProperty(dK.prototype,"models",{get:function(){return this._models||(this._models=[]),this._models}}),xW(l2,"renderTarget"),xW(l2,"onPreCull"),xW(l2,"onPreRender"),xW(l2,"onPreRenderOpaque"),xW(l2,"onPreRenderTransparent"),xW(l2,"onPostCull"),xW(l2,"onPostRender"),xW(l2,"onPostRenderOpaque"),xW(l2,"onPostRenderTransparent"),xW(l2,"onDrawCall"),xW(l2,"layerReference"),xW(_2,"onPreCull"),xW(_2,"onPostCull"),xW(_2,"onPreRender"),xW(_2,"onPostRender"),xW(_2,"onPreRenderLayer"),xW(_2,"onPostRenderLayer"),lZ.prototype.renderComposition=function(e){n.renderComposition(e);},a0.prototype.syncAabb=function(){},hd.prototype.getTarget=function(e){return this.targets[e]},oE.prototype.getChildren=function(){return this.children},oE.prototype.getName=function(){return this.name},oE.prototype.getPath=function(){return this.path},oE.prototype.getRoot=function(){return this.root},oE.prototype.getParent=function(){return this.parent},oE.prototype.setName=function(e){this.name=e;},Object.defineProperty(o8.prototype,"shader",{set:function(e){},get:function(){return null}}),Object.defineProperty(o8.prototype,"blend",{set:function(e){this.blendState.blend=e;},get:function(){return this.blendState.blend}}),Object.defineProperty(cP.prototype,"shininess",{get:function(){return 100*this.gloss},set:function(e){this.gloss=.01*e;}}),Object.defineProperty(cP.prototype,"useGammaTonemap",{get:function(){return this.useTonemap},set:function(e){this.useTonemap=e;}}),xY("sheenTint"),xY("diffuseTint"),xY("emissiveTint"),xY("ambientTint"),xX("specularTint","specularMapTint"),xX("aoVertexColor","aoMapVertexColor"),xX("diffuseVertexColor","diffuseMapVertexColor"),xX("specularVertexColor","specularMapVertexColor"),xX("emissiveVertexColor","emissiveMapVertexColor"),xX("metalnessVertexColor","metalnessMapVertexColor"),xX("glossVertexColor","glossMapVertexColor"),xX("opacityVertexColor","opacityMapVertexColor"),xX("lightVertexColor","lightMapVertexColor"),xX("sheenGloss","sheenGlossiess"),xX("clearCoatGloss","clearCostGlossiness"),xj("refraction","useRefraction");let xq=Object.getOwnPropertyNames(new d7);for(let e in xq)xj(xq[e]);uA.prototype.getAssetById=function(e){return this.get(e)},Object.defineProperty(SZ.prototype,"ray",{get:function(){return this._rayLocal}}),Object.defineProperty(SZ.prototype,"position",{get:function(){return this._localPosition}}),Object.defineProperty(SZ.prototype,"rotation",{get:function(){return this._localRotation}}),Object.defineProperty(xz.prototype,"wheel",{get:function(){return -2*this.wheelDelta}}),Object.defineProperty(rc.prototype,"wheel",{get:function(){return -2*this.wheelDelta}}),uY.prototype.isFullscreen=function(){return !!document.fullscreenElement},uY.prototype.enableFullscreen=function(e,t,s){e=e||this.graphicsDevice.canvas;let i=function(){t(),document.removeEventListener("fullscreenchange",i);},n=function(){s(),document.removeEventListener("fullscreenerror",n);};t&&document.addEventListener("fullscreenchange",i,false),s&&document.addEventListener("fullscreenerror",n,false),e.requestFullscreen?e.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT):s();},uY.prototype.disableFullscreen=function(e){let t=function(){e(),document.removeEventListener("fullscreenchange",t);};e&&document.addEventListener("fullscreenchange",t,false),document.exitFullscreen();},uY.prototype.getSceneUrl=function(e){let t=this.scenes.find(e);return t?t.url:null},uY.prototype.loadScene=function(e,t){this.scenes.loadScene(e,t);},uY.prototype.loadSceneHierarchy=function(e,t){this.scenes.loadSceneHierarchy(e,t);},uY.prototype.loadSceneSettings=function(e,t){this.scenes.loadSceneSettings(e,t);},mz.prototype.setVisible=function(e){this.enabled=e;},Object.defineProperty(_e.prototype,"bodyType",{get:function(){return this.type},set:function(e){this.type=e;}}),_e.prototype.syncBodyToEntity=function(){this._updateDynamic();},_o.prototype.setGravity=function(){1==arguments.length?this.gravity.copy(arguments[0]):this.gravity.set(arguments[0],arguments[1],arguments[2]);};class xK{begin(e){if(!this.enabled)return;this._frameIndex<this._frameTimings.length&&this._frameTimings.splice(this._frameIndex);let t=this._prevTimings;this._prevTimings=this._timings,this._timings=this._frameTimings,this._frameTimings=t,this._frameIndex=0,this.mark(e);}mark(e){if(!this.enabled)return;let t=$();if(this._frameIndex>0){let e=this._frameTimings[this._frameIndex-1];e[1]=t-e[1];}else if(this._timings.length>0){let e=this._timings[this._timings.length-1];e[1]=t-e[1];}if(this._frameIndex>=this._frameTimings.length)this._frameTimings.push([e,t]);else {let s=this._frameTimings[this._frameIndex];s[0]=e,s[1]=t;}this._frameIndex++;}get timings(){return this._timings.slice(0,-1).map(e=>e[1])}constructor(e){this._frameIndex=0,this._frameTimings=[],this._timings=[],this._prevTimings=[],this.unitsName="ms",this.decimalPlaces=1,this.enabled=true,e.on("frameupdate",this.begin.bind(this,"update")),e.on("framerender",this.mark.bind(this,"render")),e.on("frameend",this.mark.bind(this,"other"));}}class xZ{get timings(){return this._timings[0]=this.device.gpuProfiler._frameTime,this._timings}constructor(e){this.device=e,e.gpuProfiler.enabled=true,this.enabled=true,this.unitsName="ms",this.decimalPlaces=1,this._timings=[];}}class xQ{get timings(){return this.values}constructor(e,t,s,i,n){this.app=e,this.values=[],this.statNames=t,this.statNames.length>3&&(this.statNames.length=3),this.unitsName=i,this.decimalPlaces=s,this.multiplier=n||1;let r=(e,t)=>e.split(".").reduce((e,t)=>e?e[t]:null,t||this);e.on("frameupdate",e=>{for(let e=0;e<this.statNames.length;e++)this.values[e]=r(this.statNames[e],this.app.stats)*this.multiplier;});}}class xJ{destroy(){this.app.off("frameupdate",this.update,this);}loseContext(){this.timer&&"function"==typeof this.timer.loseContext&&this.timer.loseContext();}update(e){let t=this.timer.timings,s=t.reduce((e,t)=>e+t,0);if(this.avgTotal+=s,this.avgTimer+=e,this.avgCount++,this.avgTimer>this.textRefreshRate&&(this.timingText=(this.avgTotal/this.avgCount).toFixed(this.timer.decimalPlaces),this.avgTimer=0,this.avgTotal=0,this.avgCount=0),this.enabled){let e=0,s=1.5*this.watermark;for(let i=0;i<t.length;++i)e+=Math.floor(t[i]/s*255),this.sample[i]=e;this.sample[3]=this.watermark/s*255,this.texture.lock().set(this.sample,(this.cursor+this.yOffset*this.texture.width)*4),this.texture.unlock(),this.cursor++,this.cursor===this.texture.width&&(this.cursor=0);}}render(e,t,s,i,n){e.quad(t+i,s,-i,n,this.enabled?this.cursor:0,this.enabled?.5+this.yOffset:this.texture.height-1,-i,0,this.texture,0);}constructor(e,t,s,i,n){this.app=t,this.name=e,this.device=t.graphicsDevice,this.timer=n,this.watermark=s,this.enabled=false,this.textRefreshRate=i,this.avgTotal=0,this.avgTimer=0,this.avgCount=0,this.timingText="",this.texture=null,this.yOffset=0,this.cursor=0,this.sample=new Uint8ClampedArray(4),this.sample.set([0,0,0,255]),this.counter=0,this.app.on("frameupdate",this.update,this);}}class x${destroy(){this.texture.destroy(),this.texture=null;}render(e,t,s,i){let n=this.placements.get(t);return n?(e.quad(s+n.l-1,i-n.d+1,n.w+2,n.h+2,n.x-1,this.texture.height-n.y-n.h-1,void 0,void 0,this.texture,1),n.w):0}constructor(e,t){let s=e=>{e.font='10px "Lucida Console", Monaco, monospace',e.textAlign="left",e.textBaseline="alphabetic";},i=e=>"."===e||1===e.length&&e.charCodeAt(0)>=48&&57>=e.charCodeAt(0),n=document.createElement("canvas"),r=n.getContext("2d",{alpha:true});s(r);let a=new Map,o=5,l=5;t.forEach(e=>{let t=r.measureText(e),s=Math.ceil(-t.actualBoundingBoxLeft),i=Math.ceil(t.actualBoundingBoxRight),n=Math.ceil(t.actualBoundingBoxAscent),h=Math.ceil(t.actualBoundingBoxDescent),d=s+i;o+d+5>=512&&(o=5,l+=16),a.set(e,{l:s,r:i,a:n,d:h,w:d,h:n+h,x:o,y:l}),o+=d+5;}),n.width=512,n.height=ei.nextPowerOfTwo(l+16+5),s(r),r.fillStyle="rgb(0, 0, 0)",r.fillRect(0,0,n.width,n.height),a.forEach((e,t)=>{r.fillStyle=i(t)?"rgb(255, 255, 255)":"rgb(170, 170, 170)",r.fillText(t,e.x-e.l,e.y+e.a);}),this.placements=a;let h=r.getImageData(0,0,n.width,n.height).data;for(let e=0;e<h.length;e+=4)h[e+3]=h[e+0],h[e+0]=255,h[e+1]=255,h[e+2]=255;this.texture=new se(e,{name:"mini-stats-word-atlas",width:n.width,height:n.height,mipmaps:false,minFilter:0,magFilter:0,levels:[h]});}}class x0{quad(e,t,s,i,n,r,a,o,l,h){ void 0===h&&(h=0);let d=this.targetSize.width,c=this.targetSize.height,u=e/d,p=t/c,f=(e+s)/d,m=(t+i)/c,_=l.width,g=l.height,v=n/_,y=r/g,S=(n+(null!=a?a:s))/_,x=(r+(null!=o?o:i))/g;this.data.set([u,p,h,v,y,0,0,f,p,h,S,y,1,0,f,m,h,S,x,1,1,u,m,h,v,x,0,1],28*this.quads),this.quads++,this.prim.count+=6;}startFrame(){this.quads=0,this.prim.count=0,this.targetSize.width=this.device.canvas.scrollWidth,this.targetSize.height=this.device.canvas.scrollHeight;}render(e,t,s,i,n,r){this.buffer.setData(this.data.buffer),this.uniforms.clr.set(n,0),this.material.setParameter("clr",this.uniforms.clr),this.material.setParameter("graphTex",s),this.material.setParameter("wordsTex",i),e.drawMeshInstance(this.meshInstance,t);}constructor(e,t=512){let s=new sA(e,[{semantic:e2,components:3,type:6},{semantic:e7,components:4,type:6}]),i=new Uint16Array(6*t);for(let e=0;e<t;++e)i[6*e+0]=4*e,i[6*e+1]=4*e+1,i[6*e+2]=4*e+2,i[6*e+3]=4*e,i[6*e+4]=4*e+2,i[6*e+5]=4*e+3;this.device=e,this.buffer=new sy(e,s,4*t,{usage:2}),this.data=new Float32Array(this.buffer.numBytes/4),this.indexBuffer=new nY(e,1,6*t,0,i),this.prim={type:4,indexed:true,base:0,count:0},this.quads=0,this.mesh=new aG(e),this.mesh.vertexBuffer=this.buffer,this.mesh.indexBuffer[0]=this.indexBuffer,this.mesh.primitive=[this.prim];let n=new h9({uniqueName:"MiniStats",vertexGLSL:"\n	attribute vec3 vertex_position;\n	attribute vec4 vertex_texCoord0;\n	varying vec4 uv0;\n	varying float wordFlag;\n	void main(void) {\n		gl_Position = vec4(vertex_position.xy * 2.0 - 1.0, 0.5, 1.0);\n		uv0 = vertex_texCoord0;\n		wordFlag = vertex_position.z;\n	}\n",fragmentGLSL:"\n	varying vec4 uv0;\n	varying float wordFlag;\n	uniform vec4 clr;\n	uniform sampler2D graphTex;\n	uniform sampler2D wordsTex;\n	void main (void) {\n		vec4 graphSample = texture2D(graphTex, uv0.xy);\n		vec4 graph;\n		if (uv0.w < graphSample.r)\n			graph = vec4(0.7, 0.2, 0.2, 1.0);\n		else if (uv0.w < graphSample.g)\n			graph = vec4(0.2, 0.7, 0.2, 1.0);\n		else if (uv0.w < graphSample.b)\n			graph = vec4(0.2, 0.2, 0.7, 1.0);\n		else\n			graph = vec4(0.0, 0.0, 0.0, 1.0 - 0.25 * sin(uv0.w * 3.14159));\n		vec4 words = texture2D(wordsTex, vec2(uv0.x, 1.0 - uv0.y));\n		gl_FragColor = mix(graph, words, wordFlag) * clr;\n	}\n",vertexWGSL:"\n    attribute vertex_position: vec3f;         // unnormalized xy, word flag\n    attribute vertex_texCoord0: vec4f;        // unnormalized texture space uv, normalized uv\n\n    varying uv0: vec4f;\n    varying wordFlag: f32;\n\n    @vertex fn vertexMain(input : VertexInput) -> VertexOutput {\n        var output : VertexOutput;\n        output.position = vec4(input.vertex_position.xy * 2.0 - 1.0, 0.5, 1.0);\n        output.uv0 = input.vertex_texCoord0;\n        output.wordFlag = input.vertex_position.z;\n        return output;\n    }\n",fragmentWGSL:"\n    varying uv0: vec4f;\n    varying wordFlag: f32;\n\n    uniform clr: vec4f;\n\n    var graphTex : texture_2d<f32>;\n    var graphTex_sampler : sampler;\n\n    var wordsTex : texture_2d<f32>;\n    var wordsTex_sampler : sampler;\n\n    @fragment fn fragmentMain(input : FragmentInput) -> FragmentOutput {\n        var uv0: vec4f = input.uv0;\n        var graphSample: vec4f = textureSample(graphTex, graphTex_sampler, uv0.xy);\n\n        var graph: vec4f;\n        if (uv0.w < graphSample.r) {\n            graph = vec4f(0.7, 0.2, 0.2, 1.0);\n        } else if (uv0.w < graphSample.g) {\n            graph = vec4f(0.2, 0.7, 0.2, 1.0);\n        } else if (uv0.w < graphSample.b) {\n            graph = vec4f(0.2, 0.2, 0.7, 1.0);\n        } else {\n            graph = vec4f(0.0, 0.0, 0.0, 1.0 - 0.25 * sin(uv0.w * 3.14159));\n        }\n\n        var words: vec4f = textureSample(wordsTex, wordsTex_sampler, vec2f(uv0.x, 1.0 - uv0.y));\n\n        var output: FragmentOutput;\n        output.color = mix(graph, words, input.wordFlag) * uniform.clr;\n        return output;\n    }\n",attributes:{vertex_position:e2,vertex_texCoord0:e7}});this.material=n,n.cull=0,n.depthState=su.NODEPTH,n.blendState=new sh(true,0,6,8,0,1,1),n.update(),this.meshInstance=new a0(this.mesh,n,new oE("MiniStatsMesh")),this.uniforms={clr:new Float32Array(4)},this.targetSize={width:e.width,height:e.height};}}class x1{destroy(){this.device.off("resizecanvas",this.updateDiv,this),this.device.off("losecontext",this.loseContext,this),this.app.off("postrender",this.postRender,this),this.graphs.forEach(e=>e.destroy()),this.wordAtlas.destroy(),this.texture.destroy();}static getDefaultOptions(){return {sizes:[{width:100,height:16,spacing:0,graphs:false},{width:128,height:32,spacing:2,graphs:true},{width:256,height:64,spacing:2,graphs:true}],startSizeIndex:0,textRefreshRate:500,cpu:{enabled:true,watermark:33},gpu:{enabled:true,watermark:33},stats:[{name:"Frame",stats:["frame.ms"],decimalPlaces:1,unitsName:"ms",watermark:33},{name:"DrawCalls",stats:["drawCalls.total"],watermark:1e3}]}}set activeSizeIndex(e){this._activeSizeIndex=e,this.gspacing=this.sizes[e].spacing,this.resize(this.sizes[e].width,this.sizes[e].height,this.sizes[e].graphs);}get activeSizeIndex(){return this._activeSizeIndex}set opacity(e){this.clr[3]=e;}get opacity(){return this.clr[3]}get overallHeight(){let e=this.graphs,t=this.gspacing;return this.height*e.length+t*(e.length-1)}set enabled(e){if(e!==this._enabled){this._enabled=e;for(let t=0;t<this.graphs.length;++t)this.graphs[t].enabled=e,this.graphs[t].timer.enabled=e;}}get enabled(){return this._enabled}initGraphs(e,t,s){if(this.graphs=[],s.cpu.enabled){let t=new xK(e),i=new xJ("CPU",e,s.cpu.watermark,s.textRefreshRate,t);this.graphs.push(i);}if(s.gpu.enabled){let i=new xZ(t),n=new xJ("GPU",e,s.gpu.watermark,s.textRefreshRate,i);this.graphs.push(n);}s.stats&&s.stats.forEach(t=>{let i=new xQ(e,t.stats,t.decimalPlaces,t.unitsName,t.multiplier),n=new xJ(t.name,e,t.watermark,s.textRefreshRate,i);this.graphs.push(n);});let i=s.sizes.reduce((e,t)=>t.width>e?t.width:e,0);this.texture=new se(t,{name:"mini-stats-graph-texture",width:ei.nextPowerOfTwo(i),height:ei.nextPowerOfTwo(this.graphs.length),mipmaps:false,minFilter:0,magFilter:0,addressU:0,addressV:0}),this.graphs.forEach((e,t)=>{e.texture=this.texture,e.yOffset=t;});}render(){let e=this.graphs,t=this.wordAtlas,s=this.render2d,i=this.width,n=this.height,r=this.gspacing;s.startFrame();for(let a=0;a<e.length;++a){let o=e[a],l=a*(n+r);o.render(s,0,l,i,n);let h=1;l+=n-13,h+=t.render(s,o.name,h,l)+10;let d=o.timingText;for(let e=0;e<d.length;++e)h+=t.render(s,d[e],h,l);o.timer.unitsName&&(h+=3,t.render(s,o.timer.unitsName,h,l));}s.render(this.app,this.drawLayer,this.texture,this.wordAtlas.texture,this.clr,n);}resize(e,t,s){let i=this.graphs;for(let e=0;e<i.length;++e)i[e].enabled=s;this.width=e,this.height=t,this.updateDiv();}updateDiv(){let e=this.device.canvas.getBoundingClientRect();this.div.style.left=""+e.left+"px",this.div.style.bottom=""+(window.innerHeight-e.bottom)+"px",this.div.style.width=""+this.width+"px",this.div.style.height=""+this.overallHeight+"px";}loseContext(){this.graphs.forEach(e=>e.loseContext());}postRender(){this._enabled&&this.render();}constructor(e,t){let s=e.graphicsDevice;t=t||x1.getDefaultOptions(),this.initGraphs(e,s,t);let i=new Set(["","ms","0","1","2","3","4","5","6","7","8","9","."].concat(this.graphs.map(e=>e.name)).concat(t.stats?t.stats.map(e=>e.unitsName):[]).filter(e=>!!e));this.wordAtlas=new x$(s,i),this.sizes=t.sizes,this._activeSizeIndex=t.startSizeIndex;let n=document.createElement("div");n.setAttribute("id","mini-stats"),n.style.cssText="position:fixed;bottom:0;left:0;background:transparent;",document.body.appendChild(n),n.addEventListener("mouseenter",e=>{this.opacity=1;}),n.addEventListener("mouseleave",e=>{this.opacity=.7;}),n.addEventListener("click",e=>{e.preventDefault(),this._enabled&&(this.activeSizeIndex=(this.activeSizeIndex+1)%this.sizes.length,this.resize(this.sizes[this.activeSizeIndex].width,this.sizes[this.activeSizeIndex].height,this.sizes[this.activeSizeIndex].graphs));}),s.on("resizecanvas",this.updateDiv,this),s.on("losecontext",this.loseContext,this),e.on("postrender",this.postRender,this),this.app=e,this.drawLayer=e.scene.layers.getLayerById(4),this.device=s,this.render2d=new x0(s),this.div=n,this.width=0,this.height=0,this.gspacing=2,this.clr=[1,1,1,.5],this._enabled=true,this.activeSizeIndex=this._activeSizeIndex;}}let x2=new Float32Array(2),x3=new en;class x4{textureToCanvas(e,t){ void 0===t&&(t={});let s=e.getSource();if("undefined"!=typeof HTMLImageElement&&s instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&s instanceof HTMLCanvasElement||"undefined"!=typeof OffscreenCanvas&&s instanceof OffscreenCanvas||"undefined"!=typeof ImageBitmap&&s instanceof ImageBitmap){let{width:e,height:i}=this.calcTextureSize(s.width,s.height,t.maxTextureSize),n=document.createElement("canvas");n.width=e,n.height=i;let r=n.getContext("2d");if(null===r)return Promise.resolve(void 0);if(r.drawImage(s,0,0,n.width,n.height),t.color){let{r:s,g:n,b:a}=t.color,o=r.getImageData(0,0,e,i),l=o.data;for(let e=0;e<l.length;e+=4)l[e+0]=l[e+0]*s,l[e+1]=l[e+1]*n,l[e+2]=l[e+2]*a;r.putImageData(o,0,0);}return Promise.resolve(n)}let i=e.device,{width:n,height:r}=this.calcTextureSize(e.width,e.height,t.maxTextureSize),a=new se(i,{name:"ExtractedTexture",width:n,height:r,format:eK(e.format)?7:e.format,cubemap:false,mipmaps:false,minFilter:1,magFilter:1,addressU:1,addressV:1}),o=new sR({colorBuffer:a,depth:false}),l=ab(i,"\n	attribute vec2 vertex_position;\n	varying vec2 uv0;\n	void main(void) {\n		gl_Position = vec4(vertex_position, 0.5, 1.0);\n		uv0 = vertex_position.xy * 0.5 + 0.5;\n	}","\n	varying vec2 uv0;\n	uniform sampler2D blitTexture;\n	void main(void) {\n		gl_FragColor = texture2D(blitTexture, uv0);\n	}","ShaderCoreExporterBlit");return i.scope.resolve("blitTexture").setValue(e),i.setBlendState(sh.NOBLEND),aD(i,o,l),a.read(0,0,n,r,{renderTarget:o,immediate:true}).then(e=>{a.destroy(),o.destroy();let t=new Uint8ClampedArray(n*r*4);t.set(e);let s=new ImageData(t,n,r),i=document.createElement("canvas");i.width=n,i.height=r;let l=i.getContext("2d");return l?(l.putImageData(s,0,0),Promise.resolve(i)):Promise.resolve(void 0)})}calcTextureSize(e,t,s){if(s){let i=Math.min(s/Math.max(e,t),1);e=Math.round(e*i),t=Math.round(t*i);}return {width:e,height:t}}constructor(){}}var x5=Uint8Array,x6=Uint16Array,x8=Int32Array,x9=new x5([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),x7=new x5([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Te=new x5([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Tt=function(e,t){for(var s=new x6(31),i=0;i<31;++i)s[i]=t+=1<<e[i-1];for(var n=new x8(s[30]),i=1;i<30;++i)for(var r=s[i];r<s[i+1];++r)n[r]=r-s[i]<<5|i;return {b:s,r:n}},Ts=Tt(x9,2),Ti=Ts.b,Tn=Ts.r;Ti[28]=258,Tn[258]=28;for(var Tr=Tt(x7,0).r,Ta=new x6(32768),To=0;To<32768;++To){var Tl=(43690&To)>>1|(21845&To)<<1;Tl=(61680&(Tl=(52428&Tl)>>2|(13107&Tl)<<2))>>4|(3855&Tl)<<4,Ta[To]=((65280&Tl)>>8|(255&Tl)<<8)>>1;}for(var Th=function(e,t,s){for(var i,n=e.length,r=0,a=new x6(t);r<n;++r)e[r]&&++a[e[r]-1];var o=new x6(t);for(r=1;r<t;++r)o[r]=o[r-1]+a[r-1]<<1;if(s){i=new x6(1<<t);var l=15-t;for(r=0;r<n;++r)if(e[r])for(var h=r<<4|e[r],d=t-e[r],c=o[e[r]-1]++<<d,u=c|(1<<d)-1;c<=u;++c)i[Ta[c]>>l]=h;}else for(r=0,i=new x6(n);r<n;++r)e[r]&&(i[r]=Ta[o[e[r]-1]++]>>15-e[r]);return i},Td=new x5(288),To=0;To<144;++To)Td[To]=8;for(var To=144;To<256;++To)Td[To]=9;for(var To=256;To<280;++To)Td[To]=7;for(var To=280;To<288;++To)Td[To]=8;for(var Tc=new x5(32),To=0;To<32;++To)Tc[To]=5;var Tu=Th(Td,9,0);Th(Td,9,1);var Tp=Th(Tc,5,0);Th(Tc,5,1);var Tf=function(e){return (e+7)/8|0},Tm=function(e,t,s){return (null==s||s>e.length)&&(s=e.length),new x5(e.subarray(t,s))},T_=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Tg=function(e,t,s){var i=Error(t||T_[e]);if(i.code=e,Error.captureStackTrace&&Error.captureStackTrace(i,Tg),!s)throw i;return i},Tv=function(e,t,s){s<<=7&t;var i=t/8|0;e[i]|=s,e[i+1]|=s>>8;},Ty=function(e,t,s){s<<=7&t;var i=t/8|0;e[i]|=s,e[i+1]|=s>>8,e[i+2]|=s>>16;},TS=function(e,t){for(var s=[],i=0;i<e.length;++i)e[i]&&s.push({s:i,f:e[i]});var n=s.length,r=s.slice();if(!n)return {t:TC,l:0};if(1==n){var a=new x5(s[0].s+1);return a[s[0].s]=1,{t:a,l:1}}s.sort(function(e,t){return e.f-t.f}),s.push({s:-1,f:25001});var o=s[0],l=s[1],h=0,d=1,c=2;for(s[0]={s:-1,f:o.f+l.f,l:o,r:l};d!=n-1;)o=s[s[h].f<s[c].f?h++:c++],l=s[h!=d&&s[h].f<s[c].f?h++:c++],s[d++]={s:-1,f:o.f+l.f,l:o,r:l};for(var u=r[0].s,i=1;i<n;++i)r[i].s>u&&(u=r[i].s);var p=new x6(u+1),f=Tx(s[d-1],p,0);if(f>t){var i=0,m=0,_=f-t,g=1<<_;for(r.sort(function(e,t){return p[t.s]-p[e.s]||e.f-t.f});i<n;++i){var v=r[i].s;if(p[v]>t)m+=g-(1<<f-p[v]),p[v]=t;else break}for(m>>=_;m>0;){var y=r[i].s;p[y]<t?m-=1<<t-p[y]++-1:++i;}for(;i>=0&&m;--i){var S=r[i].s;p[S]==t&&(--p[S],++m);}f=t;}return {t:new x5(p),l:f}},Tx=function(e,t,s){return -1==e.s?Math.max(Tx(e.l,t,s+1),Tx(e.r,t,s+1)):t[e.s]=s},TT=function(e){for(var t=e.length;t&&!e[--t];);for(var s=new x6(++t),i=0,n=e[0],r=1,a=function(e){s[i++]=e;},o=1;o<=t;++o)if(e[o]==n&&o!=t)++r;else {if(!n&&r>2){for(;r>138;r-=138)a(32754);r>2&&(a(r>10?r-11<<5|28690:r-3<<5|12305),r=0);}else if(r>3){for(a(n),--r;r>6;r-=6)a(8304);r>2&&(a(r-3<<5|8208),r=0);}for(;r--;)a(n);r=1,n=e[o];}return {c:s.subarray(0,i),n:t}},Tb=function(e,t){for(var s=0,i=0;i<t.length;++i)s+=e[i]*t[i];return s},TE=function(e,t,s){var i=s.length,n=Tf(t+2);e[n]=255&i,e[n+1]=i>>8,e[n+2]=255^e[n],e[n+3]=255^e[n+1];for(var r=0;r<i;++r)e[n+r+4]=s[r];return (n+4+i)*8},TA=function(e,t,s,i,n,r,a,o,l,h,d){Tv(t,d++,s),++n[256];for(var c,u,p,f,m=TS(n,15),_=m.t,g=m.l,v=TS(r,15),y=v.t,S=v.l,x=TT(_),T=x.c,b=x.n,E=TT(y),A=E.c,w=E.n,C=new x6(19),P=0;P<T.length;++P)++C[31&T[P]];for(var P=0;P<A.length;++P)++C[31&A[P]];for(var M=TS(C,7),I=M.t,R=M.l,L=19;L>4&&!I[Te[L-1]];--L);var D=h+5<<3,O=Tb(n,Td)+Tb(r,Tc)+a,F=Tb(n,_)+Tb(r,y)+a+14+3*L+Tb(C,I)+2*C[16]+3*C[17]+7*C[18];if(l>=0&&D<=O&&D<=F)return TE(t,d,e.subarray(l,l+h));if(Tv(t,d,1+(F<O)),d+=2,F<O){c=Th(_,g,0),u=_,p=Th(y,S,0),f=y;var N=Th(I,R,0);Tv(t,d,b-257),Tv(t,d+5,w-1),Tv(t,d+10,L-4),d+=14;for(var P=0;P<L;++P)Tv(t,d+3*P,I[Te[P]]);d+=3*L;for(var B=[T,A],U=0;U<2;++U)for(var k=B[U],P=0;P<k.length;++P){var z=31&k[P];Tv(t,d,N[z]),d+=I[z],z>15&&(Tv(t,d,k[P]>>5&127),d+=k[P]>>12);}}else c=Tu,u=Td,p=Tp,f=Tc;for(var P=0;P<o;++P){var V=i[P];if(V>255){var z=V>>18&31;Ty(t,d,c[z+257]),d+=u[z+257],z>7&&(Tv(t,d,V>>23&31),d+=x9[z]);var G=31&V;Ty(t,d,p[G]),d+=f[G],G>3&&(Ty(t,d,V>>5&8191),d+=x7[G]);}else Ty(t,d,c[V]),d+=u[V];}return Ty(t,d,c[256]),d+u[256]},Tw=new x8([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),TC=new x5(0),TP=function(e,t,s,i,n,r){var a=r.z||e.length,o=new x5(i+a+5*(1+Math.ceil(a/7e3))+n),l=o.subarray(i,o.length-n),h=r.l,d=7&(r.r||0);if(t){d&&(l[0]=r.r>>3);for(var c=Tw[t-1],u=c>>13,p=8191&c,f=(1<<s)-1,m=r.p||new x6(32768),_=r.h||new x6(f+1),g=Math.ceil(s/3),v=2*g,y=function(t){return (e[t]^e[t+1]<<g^e[t+2]<<v)&f},S=new x8(25e3),x=new x6(288),T=new x6(32),b=0,E=0,A=r.i||0,w=0,C=r.w||0,P=0;A+2<a;++A){var M=y(A),I=32767&A,R=_[M];if(m[I]=R,_[M]=I,C<=A){var L=a-A;if((b>7e3||w>24576)&&(L>423||!h)){d=TA(e,l,0,S,x,T,E,w,P,A-P,d),w=b=E=0,P=A;for(var D=0;D<286;++D)x[D]=0;for(var D=0;D<30;++D)T[D]=0;}var O=2,F=0,N=p,B=I-R&32767;if(L>2&&M==y(A-B))for(var U=Math.min(u,L)-1,k=Math.min(32767,A),z=Math.min(258,L);B<=k&&--N&&I!=R;){if(e[A+O]==e[A+O-B]){for(var V=0;V<z&&e[A+V]==e[A+V-B];++V);if(V>O){if(O=V,F=B,V>U)break;for(var G=Math.min(B,V-2),H=0,D=0;D<G;++D){var W=A-B+D&32767,X=m[W],Y=W-X&32767;Y>H&&(H=Y,R=W);}}}R=m[I=R],B+=I-R&32767;}if(F){S[w++]=0x10000000|Tn[O]<<18|Tr[F];var j=31&Tn[O],q=31&Tr[F];E+=x9[j]+x7[q],++x[257+j],++T[q],C=A+O,++b;}else S[w++]=e[A],++x[e[A]];}}for(A=Math.max(A,C);A<a;++A)S[w++]=e[A],++x[e[A]];d=TA(e,l,h,S,x,T,E,w,P,A-P,d),h||(r.r=7&d|l[d/8|0]<<3,d-=7,r.h=_,r.p=m,r.i=A,r.w=C);}else {for(var A=r.w||0;A<a+h;A+=65535){var K=A+65535;K>=a&&(l[d/8|0]=h,K=a),d=TE(l,d+1,e.subarray(A,K));}r.i=a;}return Tm(o,0,i+Tf(d)+n)},TM=function(){for(var e=new Int32Array(256),t=0;t<256;++t){for(var s=t,i=9;--i;)s=(1&s&&-306674912)^s>>>1;e[t]=s;}return e}(),TI=function(){var e=-1;return {p:function(t){for(var s=e,i=0;i<t.length;++i)s=TM[255&s^t[i]]^s>>>8;e=s;},d:function(){return ~e}}},TR=function(e,t,s,i,n){if(!n&&(n={l:1},t.dictionary)){var r=t.dictionary.subarray(-32768),a=new x5(r.length+e.length);a.set(r),a.set(e,r.length),e=a,n.w=r.length;}return TP(e,null==t.level?6:t.level,null==t.mem?n.l?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(e.length)))):20:12+t.mem,s,i,n)},TL=function(e,t){var s={};for(var i in e)s[i]=e[i];for(var i in t)s[i]=t[i];return s},TD=function(e,t,s){for(;s;++t)e[t]=s,s>>>=8;},TO=function(e,t,s,i){for(var n in e){var r=e[n],a=t+n,o=i;Array.isArray(r)&&(o=TL(i,r[1]),r=r[0]),r instanceof x5?s[a]=[r,o]:(s[a+="/"]=[new x5(0),o],TO(r,a,s,i));}},TF="undefined"!=typeof TextEncoder&&new TextEncoder,TN="undefined"!=typeof TextDecoder&&new TextDecoder;try{TN.decode(TC,{stream:!0});}catch(e){}function TB(e,t){if(TF)return TF.encode(e);for(var s,i=e.length,n=new x5(e.length+(e.length>>1)),r=0,a=function(e){n[r++]=e;},s=0;s<i;++s){if(r+5>n.length){var o=new x5(r+8+(i-s<<1));o.set(n),n=o;}var l=e.charCodeAt(s);l<128||t?a(l):(l<2048?a(192|l>>6):(l>55295&&l<57344?(a(240|(l=65536+(1047552&l)|1023&e.charCodeAt(++s))>>18),a(128|l>>12&63)):a(224|l>>12),a(128|l>>6&63)),a(128|63&l));}return Tm(n,0,r)}var TU=function(e){var t=0;if(e)for(var s in e){var i=e[s].length;i>65535&&Tg(9),t+=i+4;}return t},Tk=function(e,t,s,i,n,r,a,o){var l=i.length,h=s.extra,d=o&&o.length,c=TU(h);TD(e,t,null!=a?0x2014b50:0x4034b50),t+=4,null!=a&&(e[t++]=20,e[t++]=s.os),e[t]=20,t+=2,e[t++]=s.flag<<1|(r<0&&8),e[t++]=n&&8,e[t++]=255&s.compression,e[t++]=s.compression>>8;var u=new Date(null==s.mtime?Date.now():s.mtime),p=u.getFullYear()-1980;if((p<0||p>119)&&Tg(10),TD(e,t,p<<25|u.getMonth()+1<<21|u.getDate()<<16|u.getHours()<<11|u.getMinutes()<<5|u.getSeconds()>>1),t+=4,-1!=r&&(TD(e,t,s.crc),TD(e,t+4,r<0?-r-2:r),TD(e,t+8,s.size)),TD(e,t+12,l),TD(e,t+14,c),t+=16,null!=a&&(TD(e,t,d),TD(e,t+6,s.attrs),TD(e,t+10,a),t+=14),e.set(i,t),t+=l,c)for(var f in h){var m=h[f],_=m.length;TD(e,t,+f),TD(e,t+2,_),e.set(m,t+4),t+=4+_;}return d&&(e.set(o,t),t+=d),t},Tz=function(e,t,s,i,n){TD(e,t,0x6054b50),TD(e,t+8,s),TD(e,t+10,s),TD(e,t+12,i),TD(e,t+16,n);};let TV="root",TG=e=>'\ndef "Materials"\n{\n    '+e.join("\n")+"\n}\n",TH=(e,t,s,i,n,r)=>'\ndef "Mesh"\n{\n    def Mesh "Mesh"\n    {\n        int[] faceVertexCounts = ['+e+"]\n        int[] faceVertexIndices = ["+t+"]\n        normal3f[] normals = ["+s+'] (\n            interpolation = "vertex"\n        )\n        point3f[] points = ['+i+"]\n        texCoord2f[] primvars:st = ["+n+'] (\n            interpolation = "vertex"\n        )\n        texCoord2f[] primvars:st1 = ['+r+'] (\n            interpolation = "vertex"\n        )\n        uniform token subdivisionScheme = "none"\n    }\n}\n',TW=(e,t,s,i)=>'\ndef Xform "'+e+'" (\n    prepend references = '+t+"\n)\n{\n    matrix4d xformOp:transform = "+s+'\n    uniform token[] xformOpOrder = ["xformOp:transform"]\n\n    rel material:binding = '+i+"\n}\n",TX=(e,t,s)=>"                    "+e+" inputs:"+t+" = "+s,TY=e=>{switch(e){case 0:return 5121;case 1:return 5123;case 2:return 5125}return 0},Tj=e=>{switch(e){case 0:return 5120;case 1:return 5121;case 2:return 5122;case 3:return 5123;case 4:return 5124;case 5:return 5125;case 6:return 5126}return 0},Tq=e=>{switch(e){case 1:return "SCALAR";case 2:return "VEC2";case 3:return "VEC3";case 4:return "VEC4"}return 0},TK=e=>{switch(e){case e2:return "POSITION";case e3:return "NORMAL";case e4:return "TANGENT";case e8:return "COLOR_0";case e6:return "JOINTS_0";case e5:return "WEIGHTS_0";case e7:return "TEXCOORD_0";case te:return "TEXCOORD_1";case tt:return "TEXCOORD_2";case ts:return "TEXCOORD_3";case ti:return "TEXCOORD_4";case tn:return "TEXCOORD_5";case tr:return "TEXCOORD_6";case ta:return "TEXCOORD_7"}return ""},TZ=function(e){switch(e){case 0:return 9728;case 1:return 9729;case 2:return 9984;case 4:return 9985;case 3:return 9986;case 5:return 9987}return 0},TQ=function(e){switch(e){case 1:return 33071;case 2:return 33648;case 0:return 10497}return 0},TJ=["diffuseMap","colorMap","normalMap","metalnessMap","emissiveMap"];class T$ extends x4{collectResources(e){let t={buffers:[],cameras:[],entities:[],materials:[],skins:[],textures:[],entityMeshInstances:[],bufferViewMap:new Map,compressableTexture:new Set},{materials:s,buffers:i,entityMeshInstances:n,textures:r}=t;e.forEach(e=>{t.entities.push(e);});let a=e=>{e.forEach(e=>{let a=e.material;0>s.indexOf(a)&&(t.materials.push(a),TJ.forEach(e=>{let s=a[e];s&&0>r.indexOf(s)&&("normalMap"!==e&&t.compressableTexture.add(s),r.push(s));}));let o=e.node,l=n.find(e=>e.node===o);l||(l={node:o,meshInstances:[]},n.push(l)),l.meshInstances.push(e);let h=e.mesh,d=h.vertexBuffer;0>i.indexOf(d)&&i.unshift(d);let c=h.indexBuffer[0];0>i.indexOf(c)&&i.push(c),h.skin&&0>t.skins.indexOf(h.skin)&&t.skins.push(h.skin);});};return t.entities.forEach(e=>{e.camera&&t.cameras.push(e.camera),e.render&&e.render.enabled&&a(e.render.meshInstances),e.model&&e.model.enabled&&e.model.meshInstances&&a(e.model.meshInstances);}),t}writeBufferViews(e,t){for(let s of(t.bufferViews=[],e.buffers))T$.writeBufferView(e,t,s);}static writeBufferView(e,t,s){var i,n;let r;t.buffers=null!=(i=t.buffers)?i:[],t.buffers[0]=null!=(n=t.buffers[0])?n:{byteLength:0};let a=t.buffers[0];a.byteLength=ei.roundUp(a.byteLength,4);let o=a.byteLength,l=(e,s,i,n)=>{let r={buffer:0,byteLength:s,byteOffset:i};return (34962===e||34963===e)&&(r.target=e),void 0!==n&&(r.byteStride=n),t.bufferViews.push(r)-1};if(s instanceof sy){r=s.lock();let t=s.getFormat();if(t.interleaved){let i=l(34962,r.byteLength,o,t.size);e.bufferViewMap.set(s,[i]);}else {let i=[];for(let e of t.elements){let s=l(34962,e.size*t.vertexCount,o+e.offset,e.size);i.push(s);}e.bufferViewMap.set(s,i);}}else if(s instanceof nY){let t=l(34963,(r=s.lock()).byteLength,o);e.bufferViewMap.set(s,[t]);}else {let t=l(void 0,(r=s).byteLength,o);e.bufferViewMap.set(s,[t]);}a.byteLength+=r.byteLength;}writeCameras(e,t){e.cameras.length>0&&(t.cameras=e.cameras.map(e=>{let t=e.projection,s=e.nearClip,i=e.farClip,n={};if(1===t)n.type="orthographic",n.orthographic={xmag:1,ymag:1,znear:s,zfar:i};else {let t=e.fov;n.type="perspective",n.perspective={yfov:t*Math.PI/180,znear:s,zfar:i};}return n}));}attachTexture(e,t,s,i,n,r){let a=t[n];if(a){let h=e.textures.indexOf(a);s[i]={index:h};let d=t[""+n+"Tiling"],c=t[""+n+"Offset"],u=t[""+n+"Rotation"];if(d&&!d.equals(ef.ONE)||c&&!c.equals(ef.ZERO)||0!==u){var o,l;s[i].extensions={KHR_texture_transform:{}},r.extensionsUsed=null!=(o=r.extensionsUsed)?o:[],0>r.extensionsUsed.indexOf("KHR_texture_transform")&&r.extensionsUsed.push("KHR_texture_transform"),r.extensionsRequired=null!=(l=r.extensionsRequired)?l:[],0>r.extensionsRequired.indexOf("KHR_texture_transform")&&r.extensionsRequired.push("KHR_texture_transform"),d&&!d.equals(ef.ONE)&&(s[i].extensions.KHR_texture_transform.scale=[d.x,d.y]),c&&!c.equals(ef.ZERO)&&(s[i].extensions.KHR_texture_transform.offset=[c.x,c.y-1+d.y]),0!==u&&(s[i].extensions.KHR_texture_transform.rotation=u*ei.DEG_TO_RAD);}}}writeStandardMaterial(e,t,s,i){let{diffuse:n,emissive:r,opacity:a,metalness:o,gloss:l,glossInvert:h}=t,d=s.pbrMetallicRoughness;n.equals(en.WHITE)&&1===a||(d.baseColorFactor=[n.r,n.g,n.b,a]),1!==o&&(d.metallicFactor=o);let c=h?l:1-l;1!==c&&(d.roughnessFactor=c),this.attachTexture(e,t,d,"baseColorTexture","diffuseMap",i),this.attachTexture(e,t,d,"metallicRoughnessTexture","metalnessMap",i),r.equals(en.BLACK)||(s.emissiveFactor=[r.r,r.g,r.b]);}writeMaterials(e,t){e.materials.length>0&&(t.materials=e.materials.map(s=>{let{name:i,blendType:n,cull:r,alphaTest:a}=s,o={pbrMetallicRoughness:{}};return i&&i.length>0&&(o.name=i),s instanceof cP&&this.writeStandardMaterial(e,s,o,t),2===n?o.alphaMode="BLEND":3===n&&0!==a&&(o.alphaMode="MASK",o.alphaCutoff=a),0===r&&(o.doubleSided=true),this.attachTexture(e,s,o,"normalTexture","normalMap",t),this.attachTexture(e,s,o,"occlusionTexture","aoMap",t),this.attachTexture(e,s,o,"emissiveTexture","emissiveMap",t),o}));}writeNodes(e,t){e.entities.length>0&&(t.nodes=e.entities.map(t=>{let s=t.name,i=t.getLocalPosition(),n=t.getLocalRotation(),r=t.getLocalScale(),a={};s&&s.length>0&&(a.name=s),i.equals(eu.ZERO)||(a.translation=[i.x,i.y,i.z]),n.equals(eT.IDENTITY)||(a.rotation=[n.x,n.y,n.z,n.w]),r.equals(eu.ONE)||(a.scale=[r.x,r.y,r.z]),t.camera&&t.camera.enabled&&(a.camera=e.cameras.indexOf(t.camera));let o=e.entityMeshInstances.find(e=>e.node===t);if(o){a.mesh=e.entityMeshInstances.indexOf(o);let t=o.meshInstances[0];t&&t.mesh.skin&&(a.skin=e.skins.indexOf(t.mesh.skin));}return t.children.length>0&&(a.children=[],t.children.forEach(t=>{a.children.push(e.entities.indexOf(t));})),a}));}writeMeshes(e,t,s){e.entityMeshInstances.length>0&&(t.accessors=[],t.meshes=[],e.entityMeshInstances.forEach(i=>{let n={primitives:[]};i.meshInstances.forEach(i=>{let r=T$.createPrimitive(e,t,i.mesh,s);r.material=e.materials.indexOf(i.material),n.primitives.push(r);}),t.meshes.push(n);}));}static createPrimitive(e,t,s,i){ void 0===i&&(i={});let n={attributes:{}},{vertexBuffer:r}=s,{format:a}=r,{interleaved:o,elements:l}=a,h=r.getNumVertices();l.forEach((a,l)=>{let d=TK(a.name);if(i.stripUnusedAttributes){let t=true;if(d.startsWith("TEXCOORD_")){let s=parseInt(d.split("_")[1],10);t=e.materials.some(e=>TJ.some(t=>{var i;return e[t]&&(0===s||(null==(i=e[""+t+"Tiling"])?void 0:i.uv)===s)}));}if("COLOR_0"===d&&(t=e.materials.some(e=>e.vertexColors)),"TANGENT"===d&&(t=e.materials.some(e=>e.normalMap)),("JOINTS_0"===d||"WEIGHTS_0"===d)&&(t=e.entityMeshInstances.some(e=>e.meshInstances.some(e=>e.mesh.skin))),!t)return}let c=e.bufferViewMap.get(r);c||(T$.writeBufferView(e,t,r),e.buffers.push(r),c=e.bufferViewMap.get(r));let u={bufferView:c[o?0:l],byteOffset:o?a.offset:0,componentType:Tj(a.dataType),type:Tq(a.numComponents),count:h},p=t.accessors.push(u)-1;if(n.attributes[d]=p,a.name===e2){let e=[];s.getPositions(e);let t=new eu,i=new eu;eP.computeMinMax(e,t,i),u.min=[t.x,t.y,t.z],u.max=[i.x,i.y,i.z];}});let d=s.indexBuffer[0];if(d){let s=e.bufferViewMap.get(d);s||(T$.writeBufferView(e,t,d),e.buffers.push(d),s=e.bufferViewMap.get(d));let i={bufferView:s[0],componentType:TY(d.getFormat()),count:d.getNumIndices(),type:"SCALAR"};n.indices=t.accessors.push(i)-1;}return n}writeSkins(e,t){e.skins.length>0&&(t.skins=e.skins.map(s=>{let i=new Float32Array(16*s.inverseBindPose.length);for(let e=0;e<s.inverseBindPose.length;e++){let t=s.inverseBindPose[e];i.set(t.data,16*e);}let n=i.buffer;T$.writeBufferView(e,t,n),e.buffers.push(n);let r={bufferView:e.bufferViewMap.get(n)[0],componentType:Tj(6),count:s.inverseBindPose.length,type:"MAT4"};return {inverseBindMatrices:t.accessors.push(r)-1,joints:s.boneNames.map(t=>{let s=e.entities.find(e=>e.name===t);return e.entities.indexOf(s)})}}));}convertTextures(e,t){let s={maxTextureSize:t.maxTextureSize},i=[];return e.forEach(e=>{let t=this.textureToCanvas(e,s);t.then(e=>new Promise(t=>t(e))),i.push(t);}),i}writeTextures(e,t,s,i){let n=e.textures,r=[];for(let i=0;i<t.length;i++){let a=n[i],o=t[i],l=function(e){let t=e.getContext("2d").getImageData(0,0,e.width,e.height).data;for(let e=3;e<t.length;e+=4)if(t[e]<255)return  true;return  false}(o)||!e.compressableTexture.has(a)?"image/png":"image/jpeg";r.push(this.getBlob(o,l).then(e=>{let t=new FileReader;return t.readAsArrayBuffer(e),new Promise(e=>{t.onloadend=()=>{e(t);};})}).then(t=>{let n=this.getPaddedArrayBuffer(t.result);T$.writeBufferView(e,s,n),e.buffers.push(n);let r=e.bufferViewMap.get(n);s.images[i]={mimeType:l,bufferView:r[0]},s.samplers[i]={minFilter:TZ(a.minFilter),magFilter:TZ(a.magFilter),wrapS:TQ(a.addressU),wrapT:TQ(a.addressV)},s.textures[i]={sampler:i,source:i};}));}return Promise.all(r)}getBlob(e,t){if(void 0!==e.toBlob)return new Promise(s=>{e.toBlob(s,t);});let s=1;return "image/jpeg"===t&&(s=.92),e.convertToBlob({type:t,quality:s})}getPaddedArrayBuffer(e,t){ void 0===t&&(t=0);let s=ei.roundUp(e.byteLength,4);if(s!==e.byteLength){let i=new Uint8Array(s);if(i.set(new Uint8Array(e)),0!==t)for(let n=e.byteLength;n<s;n++)i[n]=t;return i.buffer}return e}buildJson(e,t){return Promise.all(this.convertTextures(e.textures,t)).then(async s=>{let i={asset:{version:"2.0",generator:"PlayCanvas GltfExporter"},scenes:[{nodes:[0]}],images:[],samplers:[],textures:[],scene:0};return this.writeBufferViews(e,i),this.writeCameras(e,i),this.writeMeshes(e,i,t),this.writeMaterials(e,i),this.writeNodes(e,i,t),this.writeSkins(e,i),await this.writeTextures(e,s,i,t),i.images.length||delete i.images,i.samplers.length||delete i.samplers,i.textures.length||delete i.textures,i})}build(e,t){ void 0===t&&(t={});let s=this.collectResources(e);return this.buildJson(s,t).then(e=>{let t=new TextEncoder().encode(JSON.stringify(e)),i=t.length,n=4-(3&i)&3,r=e.buffers.reduce((e,t)=>ei.roundUp(e+t.byteLength,4),0),a=20+i+n;r>0&&(a+=8+r);let o=new ArrayBuffer(a),l=new DataView(o);l.setUint32(0,0x46546c67,true),l.setUint32(4,2,true),l.setUint32(8,a,true),l.setUint32(12,i+n,true),l.setUint32(16,0x4e4f534a,true);let h=20;new Uint8Array(o,20,i).set(t),h+=i;for(let e=0;e<n;e++)l.setUint8(h+e,32);return h+=n,r>0&&(l.setUint32(h,r,true),l.setUint32(h+4,5130562,true),h+=8,s.buffers.forEach(t=>{let i;let n=s.bufferViewMap.get(t)[0],r=e.bufferViews[n].byteOffset;if(t instanceof ArrayBuffer)i=new Uint8Array(t);else {let e=t.lock();i=e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e.buffer,e.byteOffset,e.byteLength);}new Uint8Array(o,h+r,i.byteLength).set(i);})),Promise.resolve(o)})}}let T0="none",T1="lighting",T2="combine";class T3 extends d9{setSourceTexture(e){this._sourceTexture=e,this.options.resizeSource=e;}execute(){this.sourceTextureId.setValue(this.sourceTexture),this.premultiplyTexture&&this.premultiplyTextureId.setValue(this.premultiplyTexture),this.sourceInvResolutionValue[0]=1/this.sourceTexture.width,this.sourceInvResolutionValue[1]=1/this.sourceTexture.height,this.sourceInvResolutionId.setValue(this.sourceInvResolutionValue),super.execute();}constructor(e,t,s={}){var i,n;super(e),this.sourceTexture=t,this.premultiplyTexture=s.premultiplyTexture;let r=null!=(i=s.boxFilter)&&i,a=(r?"Box":"")+"-"+(s.premultiplyTexture?"Premultiply":"")+"-"+(null!=(n=s.premultiplySrcChannel)?n:"")+"}";this.shader=this.createQuadShader("DownSampleShader:"+a,"\n			"+(r?"#define BOXFILTER":"")+"\n			"+(s.premultiplyTexture?"#define PREMULTIPLY":"")+"\n			uniform sampler2D sourceTexture;\n			uniform vec2 sourceInvResolution;\n			varying vec2 uv0;\n			#ifdef PREMULTIPLY\n				uniform sampler2D premultiplyTexture;\n			#endif\n			void main()\n			{\n				vec3 e = texture2D (sourceTexture, vec2 (uv0.x, uv0.y)).rgb;\n				#ifdef BOXFILTER\n					vec3 value = e;\n					#ifdef PREMULTIPLY\n						float premultiply = texture2D(premultiplyTexture, vec2 (uv0.x, uv0.y))."+s.premultiplySrcChannel+";\n						value *= vec3(premultiply);\n					#endif\n				#else\n					float x = sourceInvResolution.x;\n					float y = sourceInvResolution.y;\n					vec3 a = texture2D(sourceTexture, vec2 (uv0.x - 2.0 * x, uv0.y + 2.0 * y)).rgb;\n					vec3 b = texture2D(sourceTexture, vec2 (uv0.x,		   uv0.y + 2.0 * y)).rgb;\n					vec3 c = texture2D(sourceTexture, vec2 (uv0.x + 2.0 * x, uv0.y + 2.0 * y)).rgb;\n					vec3 d = texture2D(sourceTexture, vec2 (uv0.x - 2.0 * x, uv0.y)).rgb;\n					vec3 f = texture2D(sourceTexture, vec2 (uv0.x + 2.0 * x, uv0.y)).rgb;\n					vec3 g = texture2D(sourceTexture, vec2 (uv0.x - 2.0 * x, uv0.y - 2.0 * y)).rgb;\n					vec3 h = texture2D(sourceTexture, vec2 (uv0.x,		   uv0.y - 2.0 * y)).rgb;\n					vec3 i = texture2D(sourceTexture, vec2 (uv0.x + 2.0 * x, uv0.y - 2.0 * y)).rgb;\n					vec3 j = texture2D(sourceTexture, vec2 (uv0.x - x, uv0.y + y)).rgb;\n					vec3 k = texture2D(sourceTexture, vec2 (uv0.x + x, uv0.y + y)).rgb;\n					vec3 l = texture2D(sourceTexture, vec2 (uv0.x - x, uv0.y - y)).rgb;\n					vec3 m = texture2D(sourceTexture, vec2 (uv0.x + x, uv0.y - y)).rgb;\n					vec3 value = e * 0.125;\n					value += (a + c + g + i) * 0.03125;\n					value += (b + d + f + h) * 0.0625;\n					value += (j + k + l + m) * 0.125;\n				#endif\n				gl_FragColor = vec4(value, 1.0);\n			}"),this.sourceTextureId=e.scope.resolve("sourceTexture"),this.premultiplyTextureId=e.scope.resolve("premultiplyTexture"),this.sourceInvResolutionId=e.scope.resolve("sourceInvResolution"),this.sourceInvResolutionValue=new Float32Array(2);}}class T4 extends d9{execute(){this.sourceTextureId.setValue(this.sourceTexture),this.sourceInvResolutionValue[0]=1/this.sourceTexture.width,this.sourceInvResolutionValue[1]=1/this.sourceTexture.height,this.sourceInvResolutionId.setValue(this.sourceInvResolutionValue),super.execute();}constructor(e,t){super(e),this.sourceTexture=t,this.shader=this.createQuadShader("UpSampleShader","\n			uniform sampler2D sourceTexture;\n			uniform vec2 sourceInvResolution;\n			varying vec2 uv0;\n			void main()\n			{\n				float x = sourceInvResolution.x;\n				float y = sourceInvResolution.y;\n				vec3 a = texture2D (sourceTexture, vec2 (uv0.x - x, uv0.y + y)).rgb;\n				vec3 b = texture2D (sourceTexture, vec2 (uv0.x,	 uv0.y + y)).rgb;\n				vec3 c = texture2D (sourceTexture, vec2 (uv0.x + x, uv0.y + y)).rgb;\n				vec3 d = texture2D (sourceTexture, vec2 (uv0.x - x, uv0.y)).rgb;\n				vec3 e = texture2D (sourceTexture, vec2 (uv0.x,	 uv0.y)).rgb;\n				vec3 f = texture2D (sourceTexture, vec2 (uv0.x + x, uv0.y)).rgb;\n				vec3 g = texture2D (sourceTexture, vec2 (uv0.x - x, uv0.y - y)).rgb;\n				vec3 h = texture2D (sourceTexture, vec2 (uv0.x,	 uv0.y - y)).rgb;\n				vec3 i = texture2D (sourceTexture, vec2 (uv0.x + x, uv0.y - y)).rgb;\n				vec3 value = e * 4.0;\n				value += (b + d + f + h) * 2.0;\n				value += (a + c + g + i);\n				value *= 1.0 / 16.0;\n				gl_FragColor = vec4(value, 1.0);\n			}"),this.sourceTextureId=e.scope.resolve("sourceTexture"),this.sourceInvResolutionId=e.scope.resolve("sourceInvResolution"),this.sourceInvResolutionValue=new Float32Array(2);}}class T5 extends nK{destroy(){this.destroyRenderPasses(),this.destroyRenderTargets();}destroyRenderTargets(e){ void 0===e&&(e=0);for(let t=e;t<this.renderTargets.length;t++){let e=this.renderTargets[t];e.destroyTextureBuffers(),e.destroy();}this.renderTargets.length=0;}destroyRenderPasses(){for(let e=0;e<this.beforePasses.length;e++)this.beforePasses[e].destroy();this.beforePasses.length=0;}createRenderTarget(e){return new sR({depth:false,colorBuffer:new se(this.device,{name:"BloomTexture"+e,width:1,height:1,format:this.textureFormat,mipmaps:false,minFilter:1,magFilter:1,addressU:1,addressV:1})})}createRenderTargets(e){for(let t=0;t<e;t++){let e=0===t?this.bloomRenderTarget:this.createRenderTarget(t);this.renderTargets.push(e);}}calcMipLevels(e,t,s){return Math.floor(Math.log2(Math.min(e,t))-Math.log2(s))}createRenderPasses(e){let t=this.device,s=this._sourceTexture;for(let i=0;i<e;i++){let e=new T3(t,s),n=this.renderTargets[i];e.init(n,{resizeSource:s,scaleX:.5,scaleY:.5}),e.setClearColor(en.BLACK),this.beforePasses.push(e),s=n.colorBuffer;}s=this.renderTargets[e-1].colorBuffer;for(let i=e-2;i>=0;i--){let e=new T4(t,s),n=this.renderTargets[i];e.init(n),e.blendState=sh.ADDBLEND,this.beforePasses.push(e),s=n.colorBuffer;}}onDisable(){var e;null==(e=this.renderTargets[0])||e.resize(1,1),this.destroyRenderPasses(),this.destroyRenderTargets(1);}frameUpdate(){super.frameUpdate();let e=this.calcMipLevels(this._sourceTexture.width,this._sourceTexture.height,1),t=ei.clamp(e,1,this.blurLevel);this.renderTargets.length!==t&&(this.destroyRenderPasses(),this.destroyRenderTargets(1),this.createRenderTargets(t),this.createRenderPasses(t));}constructor(e,t,s){super(e),this.blurLevel=16,this.renderTargets=[],this._sourceTexture=t,this.textureFormat=s,this.bloomRenderTarget=this.createRenderTarget(0),this.bloomTexture=this.bloomRenderTarget.colorBuffer;}}class T6 extends d9{set debug(e){this._debug!==e&&(this._debug=e,this._shaderDirty=true);}get debug(){return this._debug}set bloomTexture(e){this._bloomTexture!==e&&(this._bloomTexture=e,this._shaderDirty=true);}get bloomTexture(){return this._bloomTexture}set cocTexture(e){this._cocTexture!==e&&(this._cocTexture=e,this._shaderDirty=true);}get cocTexture(){return this._cocTexture}set ssaoTexture(e){this._ssaoTexture!==e&&(this._ssaoTexture=e,this._shaderDirty=true);}get ssaoTexture(){return this._ssaoTexture}set taaEnabled(e){this._taaEnabled!==e&&(this._taaEnabled=e,this._shaderDirty=true);}get taaEnabled(){return this._taaEnabled}set gradingEnabled(e){this._gradingEnabled!==e&&(this._gradingEnabled=e,this._shaderDirty=true);}get gradingEnabled(){return this._gradingEnabled}set vignetteEnabled(e){this._vignetteEnabled!==e&&(this._vignetteEnabled=e,this._shaderDirty=true);}get vignetteEnabled(){return this._vignetteEnabled}set fringingEnabled(e){this._fringingEnabled!==e&&(this._fringingEnabled=e,this._shaderDirty=true);}get fringingEnabled(){return this._fringingEnabled}set toneMapping(e){this._toneMapping!==e&&(this._toneMapping=e,this._shaderDirty=true);}get toneMapping(){return this._toneMapping}set sharpness(e){this._sharpness!==e&&(this._sharpness=e,this._shaderDirty=true);}get sharpness(){return this._sharpness}get isSharpnessEnabled(){return this._sharpness>0}postInit(){this.setClearColor(en.BLACK),this.setClearDepth(1),this.setClearStencil(0);}frameUpdate(){var e,t;let s=+!(null!=(e=this.renderTarget)?e:this.device.backBuffer).isColorBufferSrgb(0);if(this._gammaCorrection!==s&&(this._gammaCorrection=s,this._shaderDirty=true),this._shaderDirty){this._shaderDirty=false;let e=rQ[this._gammaCorrection],s=""+this.toneMapping+"-"+e+"-"+(this.bloomTexture?"bloom":"nobloom")+"-"+(this.cocTexture?"dof":"nodof")+"-"+(this.blurTextureUpscale?"dofupscale":"")+"-"+(this.ssaoTexture?"ssao":"nossao")+"-"+(this.gradingEnabled?"grading":"nograding")+"-"+(this.vignetteEnabled?"vignette":"novignette")+"-"+(this.fringingEnabled?"fringing":"nofringing")+"-"+(this.taaEnabled?"taa":"notaa")+"-"+(this.isSharpnessEnabled?"cas":"nocas")+"-"+(null!=(t=this._debug)?t:"");if(this._key!==s){this._key=s;let t=new Map;t.set("TONEMAP",rJ[this.toneMapping]),t.set("GAMMA",e),this.bloomTexture&&t.set("BLOOM",true),this.cocTexture&&t.set("DOF",true),this.blurTextureUpscale&&t.set("DOF_UPSCALE",true),this.ssaoTexture&&t.set("SSAO",true),this.gradingEnabled&&t.set("GRADING",true),this.vignetteEnabled&&t.set("VIGNETTE",true),this.fringingEnabled&&t.set("FRINGING",true),this.taaEnabled&&t.set("TAA",true),this.isSharpnessEnabled&&t.set("CAS",true),this._debug&&t.set("DEBUG_COMPOSE",this._debug);let i=new Map(Object.entries(am));this.shader=this.createQuadShader("ComposeShader-"+s,'\n	#include "tonemappingPS"\n	#include "gammaPS"\n	varying vec2 uv0;\n	uniform sampler2D sceneTexture;\n	uniform vec2 sceneTextureInvRes;\n	#ifdef BLOOM\n		uniform sampler2D bloomTexture;\n		uniform float bloomIntensity;\n	#endif\n	#ifdef DOF\n		uniform sampler2D cocTexture;\n		uniform sampler2D blurTexture;\n		vec3 dofBlur(vec2 uv, out vec2 coc) {\n			coc = texture2DLod(cocTexture, uv, 0.0).rg;\n			#if DOF_UPSCALE\n				vec2 blurTexelSize = 1.0 / vec2(textureSize(blurTexture, 0));\n				vec3 bilinearBlur = vec3(0.0);\n				float totalWeight = 0.0;\n				for (int i = -1; i <= 1; i++) {\n					for (int j = -1; j <= 1; j++) {\n						vec2 offset = vec2(i, j) * blurTexelSize;\n						vec2 cocSample = texture2DLod(cocTexture, uv + offset, 0.0).rg;\n						vec3 blurSample = texture2DLod(blurTexture, uv + offset, 0.0).rgb;\n						float cocWeight = clamp(cocSample.r + cocSample.g, 0.0, 1.0);\n						bilinearBlur += blurSample * cocWeight;\n						totalWeight += cocWeight;\n					}\n				}\n				if (totalWeight > 0.0) {\n					bilinearBlur /= totalWeight;\n				}\n				return bilinearBlur;\n			#else\n				return texture2DLod(blurTexture, uv, 0.0).rgb;\n			#endif\n		}\n	#endif\n	#ifdef SSAO\n		#define SSAO_TEXTURE\n	#endif\n	#if DEBUG_COMPOSE == ssao\n		#define SSAO_TEXTURE\n	#endif\n	#ifdef SSAO_TEXTURE\n		uniform sampler2D ssaoTexture;\n	#endif\n	#ifdef GRADING\n		uniform vec3 brightnessContrastSaturation;\n		uniform vec3 tint;\n		vec3 colorGradingHDR(vec3 color, float brt, float sat, float con)\n		{\n			color *= tint;\n			color = color * brt;\n			float grey = dot(color, vec3(0.3, 0.59, 0.11));\n			grey = grey / max(1.0, max(color.r, max(color.g, color.b)));\n			color = mix(vec3(grey), color, sat);\n			return mix(vec3(0.5), color, con);\n		}\n	\n	#endif\n	#ifdef VIGNETTE\n		uniform vec4 vignetterParams;\n		float vignette(vec2 uv) {\n			float inner = vignetterParams.x;\n			float outer = vignetterParams.y;\n			float curvature = vignetterParams.z;\n			float intensity = vignetterParams.w;\n			vec2 curve = pow(abs(uv * 2.0 -1.0), vec2(1.0 / curvature));\n			float edge = pow(length(curve), curvature);\n			return 1.0 - intensity * smoothstep(inner, outer, edge);\n		}		\n	#endif\n	#ifdef FRINGING\n		uniform float fringingIntensity;\n		vec3 fringing(vec2 uv, vec3 color) {\n			vec2 centerDistance = uv - 0.5;\n			vec2 offset = fringingIntensity * pow(centerDistance, vec2(2.0, 2.0));\n			color.r = texture2D(sceneTexture, uv - offset).r;\n			color.b = texture2D(sceneTexture, uv + offset).b;\n			return color;\n		}\n	#endif\n	#ifdef CAS\n		uniform float sharpness;\n		float maxComponent(float x, float y, float z) { return max(x, max(y, z)); }\n		vec3 toSDR(vec3 c) { return c / (1.0 + maxComponent(c.r, c.g, c.b)); }\n		vec3 toHDR(vec3 c) { return c / (1.0 - maxComponent(c.r, c.g, c.b)); }\n		vec3 cas(vec3 color, vec2 uv, float sharpness) {\n			float x = sceneTextureInvRes.x;\n			float y = sceneTextureInvRes.y;\n			vec3 a = toSDR(texture2DLod(sceneTexture, uv + vec2(0.0, -y), 0.0).rgb);\n			vec3 b = toSDR(texture2DLod(sceneTexture, uv + vec2(-x, 0.0), 0.0).rgb);\n			vec3 c = toSDR(color.rgb);\n			vec3 d = toSDR(texture2DLod(sceneTexture, uv + vec2(x, 0.0), 0.0).rgb);\n			vec3 e = toSDR(texture2DLod(sceneTexture, uv + vec2(0.0, y), 0.0).rgb);\n			float min_g = min(a.g, min(b.g, min(c.g, min(d.g, e.g))));\n			float max_g = max(a.g, max(b.g, max(c.g, max(d.g, e.g))));\n			float sharpening_amount = sqrt(min(1.0 - max_g, min_g) / max_g);\n			float w = sharpening_amount * sharpness;\n			vec3 res = (w * (a + b + d + e) + c) / (4.0 * w + 1.0);\n			res = max(res, 0.0);\n			return toHDR(res);\n		}\n	#endif\n	void main() {\n		vec2 uv = uv0;\n		#ifdef TAA\n		#ifdef WEBGPU\n			uv.y = 1.0 - uv.y;\n		#endif\n		#endif\n		vec4 scene = texture2DLod(sceneTexture, uv, 0.0);\n		vec3 result = scene.rgb;\n		#ifdef CAS\n			result = cas(result, uv, sharpness);\n		#endif\n		#ifdef DOF\n			vec2 coc;\n			vec3 blur = dofBlur(uv0, coc);\n			result = mix(result, blur, coc.r + coc.g);\n		#endif\n		#ifdef SSAO_TEXTURE\n			mediump float ssao = texture2DLod(ssaoTexture, uv0, 0.0).r;\n		#endif\n		#ifdef SSAO\n			result *= ssao;\n		#endif\n		#ifdef FRINGING\n			result = fringing(uv, result);\n		#endif\n		#ifdef BLOOM\n			vec3 bloom = texture2DLod(bloomTexture, uv0, 0.0).rgb;\n			result += bloom * bloomIntensity;\n		#endif\n		#ifdef GRADING\n			result = colorGradingHDR(result, brightnessContrastSaturation.x, brightnessContrastSaturation.z, brightnessContrastSaturation.y);\n		#endif\n		result = toneMap(result);\n		#ifdef VIGNETTE\n			mediump float vig = vignette(uv);\n			result *= vig;\n		#endif\n		#ifdef DEBUG_COMPOSE\n			#ifdef BLOOM\n				#if DEBUG_COMPOSE == bloom\n					result = bloom * bloomIntensity;\n				#endif\n			#endif\n			#ifdef DOF\n				#ifdef DEBUG_COMPOSE == dofcoc\n					result = vec3(coc, 0.0);\n				#endif\n				#ifdef DEBUG_COMPOSE == dofblur\n					result = blur;\n				#endif\n			#endif\n			#if DEBUG_COMPOSE == ssao\n				result = vec3(ssao);\n			#endif\n			#if DEBUG_COMPOSE == vignette\n				result = vec3(vig);\n			#endif\n			#if DEBUG_COMPOSE == scene\n				result = scene.rgb;\n			#endif\n		#endif\n		result = gammaCorrectOutput(result);\n		gl_FragColor = vec4(result, scene.a);\n	}\n',{fragmentIncludes:i,fragmentDefines:t});}}}execute(){this.sceneTextureId.setValue(this.sceneTexture),this.sceneTextureInvResValue[0]=1/this.sceneTexture.width,this.sceneTextureInvResValue[1]=1/this.sceneTexture.height,this.sceneTextureInvResId.setValue(this.sceneTextureInvResValue),this._bloomTexture&&(this.bloomTextureId.setValue(this._bloomTexture),this.bloomIntensityId.setValue(this.bloomIntensity)),this._cocTexture&&(this.cocTextureId.setValue(this._cocTexture),this.blurTextureId.setValue(this.blurTexture)),this._ssaoTexture&&this.ssaoTextureId.setValue(this._ssaoTexture),this._gradingEnabled&&(this.bcsId.setValue([this.gradingBrightness,this.gradingContrast,this.gradingSaturation]),this.tintId.setValue([this.gradingTint.r,this.gradingTint.g,this.gradingTint.b])),this._vignetteEnabled&&this.vignetterParamsId.setValue([this.vignetteInner,this.vignetteOuter,this.vignetteCurvature,this.vignetteIntensity]),this._fringingEnabled&&this.fringingIntensityId.setValue(this.fringingIntensity/1024),this.isSharpnessEnabled&&this.sharpnessId.setValue(ei.lerp(-0.125,-0.2,this.sharpness)),super.execute();}constructor(e){super(e),this.sceneTexture=null,this.bloomIntensity=.01,this._bloomTexture=null,this._cocTexture=null,this.blurTexture=null,this.blurTextureUpscale=false,this._ssaoTexture=null,this._toneMapping=0,this._gradingEnabled=false,this.gradingSaturation=1,this.gradingContrast=1,this.gradingBrightness=1,this.gradingTint=new en(1,1,1,1),this._shaderDirty=true,this._vignetteEnabled=false,this.vignetteInner=.5,this.vignetteOuter=1,this.vignetteCurvature=.5,this.vignetteIntensity=.3,this._fringingEnabled=false,this.fringingIntensity=10,this._taaEnabled=false,this._sharpness=.5,this._gammaCorrection=1,this._key="",this._debug=null;let{scope:t}=e;this.sceneTextureId=t.resolve("sceneTexture"),this.bloomTextureId=t.resolve("bloomTexture"),this.cocTextureId=t.resolve("cocTexture"),this.ssaoTextureId=t.resolve("ssaoTexture"),this.blurTextureId=t.resolve("blurTexture"),this.bloomIntensityId=t.resolve("bloomIntensity"),this.bcsId=t.resolve("brightnessContrastSaturation"),this.tintId=t.resolve("tint"),this.vignetterParamsId=t.resolve("vignetterParams"),this.fringingIntensityId=t.resolve("fringingIntensity"),this.sceneTextureInvResId=t.resolve("sceneTextureInvRes"),this.sceneTextureInvResValue=new Float32Array(2),this.sharpnessId=t.resolve("sharpness");}}class T8 extends d9{destroy(){this.renderTarget&&(this.renderTarget.destroyTextureBuffers(),this.renderTarget.destroy(),this.renderTarget=null);}setup(){for(let e=0;e<2;++e)this.historyTextures[e]=new se(this.device,{name:"TAA-History-"+e,width:4,height:4,format:this.sourceTexture.format,mipmaps:false,minFilter:1,magFilter:1,addressU:1,addressV:1}),this.historyRenderTargets[e]=new sR({colorBuffer:this.historyTextures[e],depth:false});this.historyTexture=this.historyTextures[0],this.init(this.historyRenderTargets[0],{resizeSource:this.sourceTexture});}before(){this.sourceTextureId.setValue(this.sourceTexture),this.historyTextureId.setValue(this.historyTextures[1-this.historyIndex]),this.textureSize[0]=this.sourceTexture.width,this.textureSize[1]=this.sourceTexture.height,this.textureSizeId.setValue(this.textureSize);let e=this.cameraComponent.camera;this.viewProjPrevId.setValue(e._viewProjPrevious.data),this.viewProjInvId.setValue(e._viewProjInverse.data),this.jittersId.setValue(e._jitters);let t=e._farClip;this.cameraParams[0]=1/t,this.cameraParams[1]=t,this.cameraParams[2]=e._nearClip,this.cameraParams[3]=+(1===e.projection),this.cameraParamsId.setValue(this.cameraParams);}update(){return this.historyIndex=1-this.historyIndex,this.historyTexture=this.historyTextures[this.historyIndex],this.renderTarget=this.historyRenderTargets[this.historyIndex],this.historyTexture}constructor(e,t,s){super(e),this.historyIndex=0,this.historyTexture=null,this.historyTextures=[],this.historyRenderTargets=[],this.sourceTexture=t,this.cameraComponent=s;let i=dt.getScreenDepthChunk(e,s.shaderParams),n=am.sampleCatmullRomPS+i;this.shader=this.createQuadShader("TaaResolveShader","\n			#define QUALITY_HIGH\n		"+n+"\n	uniform sampler2D sourceTexture;\n	uniform sampler2D historyTexture;\n	uniform mat4 matrix_viewProjectionPrevious;\n	uniform mat4 matrix_viewProjectionInverse;\n	uniform vec4 jitters;\n	uniform vec2 textureSize;\n	varying vec2 uv0;\n	vec2 reproject(vec2 uv, float depth) {\n		#ifndef WEBGPU\n			depth = depth * 2.0 - 1.0;\n		#endif\n		vec4 ndc = vec4(uv * 2.0 - 1.0, depth, 1.0);\n		ndc.xy -= jitters.xy;\n		vec4 worldPosition = matrix_viewProjectionInverse * ndc;\n		worldPosition /= worldPosition.w;\n	\n		vec4 screenPrevious = matrix_viewProjectionPrevious * worldPosition;\n		return (screenPrevious.xy / screenPrevious.w) * 0.5 + 0.5;\n	}\n	vec4 colorClamp(vec2 uv, vec4 historyColor) {\n		vec3 minColor = vec3(9999.0);\n		vec3 maxColor = vec3(-9999.0);\n \n		for(float x = -1.0; x <= 1.0; ++x)\n		{\n			for(float y = -1.0; y <= 1.0; ++y)\n			{\n				vec3 color = texture2D(sourceTexture, uv + vec2(x, y) / textureSize).rgb;\n				minColor = min(minColor, color);\n				maxColor = max(maxColor, color);\n			}\n		}\n \n		vec3 clamped = clamp(historyColor.rgb, minColor, maxColor);\n		return vec4(clamped, historyColor.a);\n	}\n	void main()\n	{\n		vec2 uv = uv0;\n		#ifdef WEBGPU\n			uv.y = 1.0 - uv.y;\n		#endif\n		vec4 srcColor = texture2D(sourceTexture, uv);\n		float linearDepth = getLinearScreenDepth(uv0);\n		float depth = delinearizeDepth(linearDepth);\n		vec2 historyUv = reproject(uv0, depth);\n		#ifdef QUALITY_HIGH\n			vec4 historyColor = SampleTextureCatmullRom(TEXTURE_PASS(historyTexture), historyUv, textureSize);\n		#else\n			vec4 historyColor = texture2D(historyTexture, historyUv);\n		#endif\n		vec4 historyColorClamped = colorClamp(uv, historyColor);\n		float mixFactor = (historyUv.x < 0.0 || historyUv.x > 1.0 || historyUv.y < 0.0 || historyUv.y > 1.0) ?\n			1.0 : 0.05;\n		gl_FragColor = mix(historyColorClamped, srcColor, mixFactor);\n	}\n");let{scope:r}=e;this.sourceTextureId=r.resolve("sourceTexture"),this.textureSizeId=r.resolve("textureSize"),this.textureSize=new Float32Array(2),this.historyTextureId=r.resolve("historyTexture"),this.viewProjPrevId=r.resolve("matrix_viewProjectionPrevious"),this.viewProjInvId=r.resolve("matrix_viewProjectionInverse"),this.jittersId=r.resolve("jitters"),this.cameraParams=new Float32Array(4),this.cameraParamsId=r.resolve("camera_params"),this.setup();}}class T9 extends d9{execute(){let{paramsValue:e,focusRange:t}=this;e[0]=this.focusDistance+.001,e[1]=t,e[2]=1/t,this.paramsId.setValue(e);let s=this.cameraComponent.camera,i=s._farClip;this.cameraParams[0]=1/i,this.cameraParams[1]=i,this.cameraParams[2]=s._nearClip,this.cameraParams[3]=+(1===s.projection),this.cameraParamsId.setValue(this.cameraParams),super.execute();}constructor(e,t,s){super(e),this.cameraComponent=t;let i=dt.getScreenDepthChunk(e,t.shaderParams);this.shader=this.createQuadShader("CocShader-"+s,"\n			"+(s?"#define NEAR_BLUR":"")+"\n			"+i+"\n			varying vec2 uv0;\n			uniform vec3 params;\n			void main()\n			{\n				float depth = getLinearScreenDepth(uv0);\n				float focusDistance = params.x;\n				float focusRange = params.y;\n				float invRange = params.z;\n				float farRange = focusDistance + focusRange * 0.5;\n				\n				float cocFar = min((depth - farRange) * invRange, 1.0);\n				#ifdef NEAR_BLUR\n					float nearRange = focusDistance - focusRange * 0.5;\n					float cocNear = min((nearRange - depth) * invRange, 1.0);\n				#else\n					float cocNear = 0.0;\n				#endif\n				gl_FragColor = vec4(cocFar, cocNear, 0.0, 0.0);\n			}"),this.paramsId=e.scope.resolve("params"),this.paramsValue=new Float32Array(3),this.cameraParams=new Float32Array(4),this.cameraParamsId=e.scope.resolve("camera_params");}}class T7 extends d9{set blurRings(e){this._blurRings!==e&&(this._blurRings=e,this.shader=null);}get blurRings(){return this._blurRings}set blurRingPoints(e){this._blurRingPoints!==e&&(this._blurRingPoints=e,this.shader=null);}get blurRingPoints(){return this._blurRingPoints}createShader(){this.kernel=new Float32Array(ec.concentric(this.blurRings,this.blurRingPoints));let e=this.kernel.length>>1,t=null!==this.nearTexture;this.shader=this.createQuadShader("DofBlurShader-"+e+"-"+(t?"nearBlur":"noNearBlur"),"\n			"+(t?"#define NEAR_BLUR":"")+"\n			#if defined(NEAR_BLUR)\n				uniform sampler2D nearTexture;\n			#endif\n			uniform sampler2D farTexture;\n			uniform sampler2D cocTexture;\n			uniform float blurRadiusNear;\n			uniform float blurRadiusFar;\n			uniform vec2 kernel["+e+"];\n			varying vec2 uv0;\n			void main()\n			{\n				vec2 coc = texture2D(cocTexture, uv0).rg;\n				float cocFar = coc.r;\n				vec3 sum = vec3(0.0, 0.0, 0.0);\n				#if defined(NEAR_BLUR)\n					float cocNear = coc.g;\n					if (cocNear > 0.0001) {\n						ivec2 nearTextureSize = textureSize(nearTexture, 0);\n						vec2 step = cocNear * blurRadiusNear / vec2(nearTextureSize);\n						for (int i = 0; i < "+e+"; i++) {\n							vec2 uv = uv0 + step * kernel[i];\n							vec3 tap = texture2DLod(nearTexture, uv, 0.0).rgb;\n							sum += tap.rgb;\n						}\n						sum *= "+1/e+";\n					} else\n				#endif\n					\n					if (cocFar > 0.0001) {\n					ivec2 farTextureSize = textureSize(farTexture, 0);\n					vec2 step = cocFar * blurRadiusFar / vec2(farTextureSize);\n					float sumCoC = 0.0; \n					for (int i = 0; i < "+e+"; i++) {\n						vec2 uv = uv0 + step * kernel[i];\n						vec3 tap = texture2DLod(farTexture, uv, 0.0).rgb;\n						float cocThis = texture2DLod(cocTexture, uv, 0.0).r;\n						tap *= cocThis;\n						sumCoC += cocThis;\n						sum += tap.rgb;\n					}\n					if (sumCoC > 0.0)\n						sum /= sumCoC;\n					sum /= cocFar;\n				}\n				pcFragColor0 = vec4(sum, 1.0);\n			}");}execute(){this.shader||this.createShader(),this.nearTextureId.setValue(this.nearTexture),this.farTextureId.setValue(this.farTexture),this.cocTextureId.setValue(this.cocTexture),this.kernelId.setValue(this.kernel),this.kernelCountId.setValue(this.kernel.length>>1),this.blurRadiusNearId.setValue(this.blurRadiusNear),this.blurRadiusFarId.setValue(this.blurRadiusFar),super.execute();}constructor(e,t,s,i){super(e),this.blurRadiusNear=1,this.blurRadiusFar=1,this._blurRings=3,this._blurRingPoints=3,this.nearTexture=t,this.farTexture=s,this.cocTexture=i;let{scope:n}=e;this.kernelId=n.resolve("kernel[0]"),this.kernelCountId=n.resolve("kernelCount"),this.blurRadiusNearId=n.resolve("blurRadiusNear"),this.blurRadiusFarId=n.resolve("blurRadiusFar"),this.nearTextureId=n.resolve("nearTexture"),this.farTextureId=n.resolve("farTexture"),this.cocTextureId=n.resolve("cocTexture");}}class be extends nK{destroy(){this.destroyRenderPasses(),this.cocPass=null,this.farPass=null,this.blurPass=null,this.destroyRT(this.cocRT),this.destroyRT(this.farRt),this.destroyRT(this.blurRt),this.cocRT=null,this.farRt=null,this.blurRt=null;}destroyRenderPasses(){for(let e=0;e<this.beforePasses.length;e++)this.beforePasses[e].destroy();this.beforePasses.length=0;}destroyRT(e){e&&(e.destroyTextureBuffers(),e.destroy());}setupCocPass(e,t,s,i){this.cocRT=this.createRenderTarget("CoCTexture",i?53:52),this.cocTexture=this.cocRT.colorBuffer;let n=new T9(e,t,i);return n.init(this.cocRT,{resizeSource:s}),n.setClearColor(en.BLACK),n}setupFarPass(e,t,s){this.farRt=this.createRenderTarget("FarDofTexture",t.format);let i=new T3(e,t,{boxFilter:true,premultiplyTexture:this.cocTexture,premultiplySrcChannel:"r"});return i.init(this.farRt,{resizeSource:t,scaleX:s,scaleY:s}),i.setClearColor(en.BLACK),i}setupBlurPass(e,t,s,i){var n;let r=null==(n=this.farRt)?void 0:n.colorBuffer;this.blurRt=this.createRenderTarget("DofBlurTexture",t.format),this.blurTexture=this.blurRt.colorBuffer;let a=new T7(e,s?t:null,r,this.cocTexture);return a.init(this.blurRt,{resizeSource:t,scaleX:i,scaleY:i}),a.setClearColor(en.BLACK),a}createTexture(e,t){return new se(this.device,{name:e,width:1,height:1,format:t,mipmaps:false,minFilter:1,magFilter:1,addressU:1,addressV:1})}createRenderTarget(e,t){return new sR({colorBuffer:this.createTexture(e,t),depth:false,stencil:false})}frameUpdate(){super.frameUpdate(),this.cocPass.focusDistance=this.focusDistance,this.cocPass.focusRange=this.focusRange,this.blurPass.blurRadiusNear=this.blurRadius,this.blurPass.blurRadiusFar=this.blurRadius*(this.highQuality?1:.5),this.blurPass.blurRings=this.blurRings,this.blurPass.blurRingPoints=this.blurRingPoints;}constructor(e,t,s,i,n,r){super(e),this.focusDistance=100,this.focusRange=50,this.blurRadius=1,this.blurRings=3,this.blurRingPoints=3,this.highQuality=true,this.cocTexture=null,this.blurTexture=null,this.cocPass=null,this.farPass=null,this.blurPass=null,this.highQuality=n,this.cocPass=this.setupCocPass(e,t,s,r),this.beforePasses.push(this.cocPass);let a=n?s:i;this.farPass=this.setupFarPass(e,a,.5),this.beforePasses.push(this.farPass),this.blurPass=this.setupBlurPass(e,i,r,n?2:.5),this.beforePasses.push(this.blurPass);}}let bt=[];class bs extends nK{destroy(){var e,t;super.destroy(),null==(e=this.renderTarget)||e.destroy(),this.renderTarget=null,null==(t=this.linearDepthTexture)||t.destroy(),this.linearDepthTexture=null,this.viewBindGroups.forEach(e=>{e.defaultUniformBuffer.destroy(),e.destroy();}),this.viewBindGroups.length=0;}setupRenderTarget(e){let{device:t}=this;this.linearDepthFormat=t.textureFloatRenderable?15:7,this.linearDepthTexture=new se(t,{name:"SceneLinearDepthTexture",width:1,height:1,format:this.linearDepthFormat,mipmaps:false,minFilter:0,magFilter:0,addressU:1,addressV:1});let s=new sR({name:"PrepassRT",colorBuffer:this.linearDepthTexture,depth:true,samples:1});this.camera.shaderParams.sceneDepthMapLinear=true,this.init(s,e);}after(){this.device.scope.resolve("uSceneDepthMap").setValue(this.linearDepthTexture);}execute(){let{renderer:e,scene:t,renderTarget:s}=this,i=this.camera.camera,n=t.layers.layerList,r=t.layers.subLayerEnabled,a=t.layers.subLayerList;for(let t=0;t<n.length;t++){let l=n[t];if(1===l.id)break;if(l.enabled&&r[t]&&l.camerasSet.has(i)){let n=l.getCulledInstances(i),r=a[t]?n.transparent:n.opaque;for(let e=0;e<r.length;e++){var o;let t=r[e];(null==(o=t.material)?void 0:o.depthWrite)&&bt.push(t);}e.renderForwardLayer(i,s,null,void 0,1,this.viewBindGroups,{meshInstances:bt}),bt.length=0;}}}frameUpdate(){let e;super.frameUpdate();let{camera:t}=this;if(this.setClearDepth(t.clearDepthBuffer?1:void 0),t.clearDepthBuffer){let s=t.farClip-Number.MIN_VALUE;e=this.linearDepthClearValue,15===this.linearDepthFormat?e.r=s:ed.float2RGBA8(s,e);}this.setClearColor(e);}constructor(e,t,s,i,n){super(e),this.viewBindGroups=[],this.linearDepthClearValue=new en(0,0,0,0),this.scene=t,this.renderer=s,this.camera=i,this.setupRenderTarget(n);}}class bi extends d9{execute(){this.filterSizeId.setValue(4),this.sourceTextureId.setValue(this.sourceTexture);let{width:e,height:t}=this.sourceTexture;this.sourceInvResolutionValue[0]=1/e,this.sourceInvResolutionValue[1]=1/t,this.sourceInvResolutionId.setValue(this.sourceInvResolutionValue),super.execute();}constructor(e,t,s,i){super(e),this.sourceTexture=t;let n=dt.getScreenDepthChunk(e,s.shaderParams);this.shader=this.createQuadShader("DepthAware"+(i?"Horizontal":"Vertical")+"BlurShader",n+"\n			"+(i?"#define HORIZONTAL":"")+"\n			varying vec2 uv0;\n			uniform sampler2D sourceTexture;\n			uniform vec2 sourceInvResolution;\n			uniform int filterSize;\n			float random(const highp vec2 w) {\n				const vec3 m = vec3(0.06711056, 0.00583715, 52.9829189);\n				return fract(m.z * fract(dot(w, m.xy)));\n			}\n			mediump float bilateralWeight(in mediump float depth, in mediump float sampleDepth) {\n				mediump float diff = (sampleDepth - depth);\n				return max(0.0, 1.0 - diff * diff);\n			}\n			void tap(inout float sum, inout float totalWeight, float weight, float depth, vec2 position) {\n				mediump float color = texture2D(sourceTexture, position).r;\n				mediump float textureDepth = -getLinearScreenDepth(position);\n			\n				mediump float bilateral = bilateralWeight(depth, textureDepth);\n				bilateral *= weight;\n				sum += color * bilateral;\n				totalWeight += bilateral;\n			}\n			void main() {\n				mediump float depth = -getLinearScreenDepth(uv0);\n				mediump float totalWeight = 1.0;\n				mediump float color = texture2D(sourceTexture, uv0 ).r;\n				mediump float sum = color * totalWeight;\n				for (mediump int i = -filterSize; i <= filterSize; i++) {\n					mediump float weight = 1.0;\n					#ifdef HORIZONTAL\n						vec2 offset = vec2(i, 0) * sourceInvResolution;\n					#else\n						vec2 offset = vec2(0, i) * sourceInvResolution;\n					#endif\n					tap(sum, totalWeight, weight, depth, uv0 + offset);\n				}\n				mediump float ao = sum / totalWeight;\n				gl_FragColor.r = ao;\n			}\n		");let r=this.device.scope;this.sourceTextureId=r.resolve("sourceTexture"),this.sourceInvResolutionId=r.resolve("sourceInvResolution"),this.sourceInvResolutionValue=new Float32Array(2),this.filterSizeId=r.resolve("filterSize");}}class bn extends d9{destroy(){var e,t;if(null==(e=this.renderTarget)||e.destroyTextureBuffers(),null==(t=this.renderTarget)||t.destroy(),this.renderTarget=null,this.afterPasses.length>0){let e=this.afterPasses[0].renderTarget;null==e||e.destroyTextureBuffers(),null==e||e.destroy();}this.afterPasses.forEach(e=>e.destroy()),this.afterPasses.length=0,super.destroy();}set scale(e){this._scale=e,this.scaleX=e,this.scaleY=e;}get scale(){return this._scale}createRenderTarget(e){return new sR({depth:false,colorBuffer:new se(this.device,{name:e,width:1,height:1,format:52,mipmaps:false,minFilter:0,magFilter:0,addressU:1,addressV:1})})}execute(){let{device:e,sourceTexture:t,sampleCount:s,minAngle:i,scale:n}=this,{width:r,height:a}=this.renderTarget.colorBuffer,o=e.scope;o.resolve("uAspect").setValue(r/a),o.resolve("uInvResolution").setValue([1/r,1/a]),o.resolve("uSampleCount").setValue([s,1/s]);let l=Math.sin(i*Math.PI/180);o.resolve("uMinHorizonAngleSineSquared").setValue(l*l);let h=1/(s-.5)*62.82,d=this.radius/n,c=.1*d,u=6.282*c*2*this.intensity/s,p=.5*t.height;o.resolve("uSpiralTurns").setValue(10),o.resolve("uAngleIncCosSin").setValue([Math.cos(h),Math.sin(h)]),o.resolve("uMaxLevel").setValue(0),o.resolve("uInvRadiusSquared").setValue(1/(d*d)),o.resolve("uBias").setValue(.001),o.resolve("uPeak2").setValue(c*c),o.resolve("uIntensity").setValue(u),o.resolve("uPower").setValue(this.power),o.resolve("uProjectionScaleRadius").setValue(p*d),o.resolve("uRandomize").setValue(this.randomize?this._blueNoise.value():0),super.execute();}after(){this.ssaoTextureId.setValue(this.ssaoTexture);let e=this.sourceTexture;this.ssaoTextureSizeInvId.setValue([1/e.width,1/e.height]);}constructor(e,t,s,i){super(e),this.radius=5,this.intensity=1,this.power=1,this.sampleCount=10,this.minAngle=5,this.randomize=false,this._scale=1,this._blueNoise=new oY(19),this.sourceTexture=t,this.cameraComponent=s;let n=dt.getScreenDepthChunk(e,s.shaderParams);this.shader=this.createQuadShader("SsaoShader",n+"\n	varying vec2 uv0;\n	uniform vec2 uInvResolution;\n	uniform float uAspect;\n	#define saturate(x) clamp(x,0.0,1.0)\n	highp float getWFromProjectionMatrix(const mat4 p, const vec3 v) {\n		return -v.z;\n	}\n	highp float getViewSpaceZFromW(const mat4 p, const float w) {\n		return -w;\n	}\n	const float kLog2LodRate = 3.0;\n	float random(const highp vec2 w) {\n		const vec3 m = vec3(0.06711056, 0.00583715, 52.9829189);\n		return fract(m.z * fract(dot(w, m.xy)));\n	}\n	highp vec2 getFragCoord() {\n		return gl_FragCoord.xy;\n	}\n	highp vec3 computeViewSpacePositionFromDepth(highp vec2 uv, highp float linearDepth) {\n		return vec3((0.5 - uv) * vec2(uAspect, 1.0) * linearDepth, linearDepth);\n	}\n	highp vec3 faceNormal(highp vec3 dpdx, highp vec3 dpdy) {\n		return normalize(cross(dpdx, dpdy));\n	}\n	highp vec3 computeViewSpaceNormal(const highp vec3 position) {\n		return faceNormal(dFdx(position), dFdy(position));\n	}\n	highp vec3 computeViewSpaceNormal(const highp vec3 position, const highp vec2 uv) {\n		highp vec2 uvdx = uv + vec2(uInvResolution.x, 0.0);\n		highp vec2 uvdy = uv + vec2(0.0, uInvResolution.y);\n		highp vec3 px = computeViewSpacePositionFromDepth(uvdx, -getLinearScreenDepth(uvdx));\n		highp vec3 py = computeViewSpacePositionFromDepth(uvdy, -getLinearScreenDepth(uvdy));\n		highp vec3 dpdx = px - position;\n		highp vec3 dpdy = py - position;\n		return faceNormal(dpdx, dpdy);\n	}\n	uniform vec2 uSampleCount;\n	uniform float uSpiralTurns;\n	#define PI (3.14159)\n	mediump vec3 tapLocation(mediump float i, const mediump float noise) {\n		mediump float offset = ((2.0 * PI) * 2.4) * noise;\n		mediump float angle = ((i * uSampleCount.y) * uSpiralTurns) * (2.0 * PI) + offset;\n		mediump float radius = (i + noise + 0.5) * uSampleCount.y;\n		return vec3(cos(angle), sin(angle), radius * radius);\n	}\n	highp vec2 startPosition(const float noise) {\n		float angle = ((2.0 * PI) * 2.4) * noise;\n		return vec2(cos(angle), sin(angle));\n	}\n	uniform vec2 uAngleIncCosSin;\n	highp mat2 tapAngleStep() {\n		highp vec2 t = uAngleIncCosSin;\n		return mat2(t.x, t.y, -t.y, t.x);\n	}\n	mediump vec3 tapLocationFast(mediump float i, mediump vec2 p, const mediump float noise) {\n		mediump float radius = (i + noise + 0.5) * uSampleCount.y;\n		return vec3(p, radius * radius);\n	}\n	uniform float uMaxLevel;\n	uniform float uInvRadiusSquared;\n	uniform float uMinHorizonAngleSineSquared;\n	uniform float uBias;\n	uniform float uPeak2;\n	void computeAmbientOcclusionSAO(inout mediump float occlusion, mediump float i, mediump float ssDiskRadius,\n			const highp vec2 uv, const highp vec3 origin, const mediump vec3 normal,\n			const mediump vec2 tapPosition, const float noise) {\n		mediump vec3 tap = tapLocationFast(i, tapPosition, noise);\n		mediump float ssRadius = max(1.0, tap.z * ssDiskRadius);\n		mediump vec2 uvSamplePos = uv + vec2(ssRadius * tap.xy) * uInvResolution;\n		mediump float level = clamp(floor(log2(ssRadius)) - kLog2LodRate, 0.0, float(uMaxLevel));\n		highp float occlusionDepth = -getLinearScreenDepth(uvSamplePos);\n		highp vec3 p = computeViewSpacePositionFromDepth(uvSamplePos, occlusionDepth);\n		vec3 v = p - origin;\n		float vv = dot(v, v);\n		float vn = dot(v, normal);\n		mediump float w = max(0.0, 1.0 - vv * uInvRadiusSquared);\n		w = w * w;\n		w *= step(vv * uMinHorizonAngleSineSquared, vn * vn);\n		occlusion += w * max(0.0, vn + origin.z * uBias) / (vv + uPeak2);\n	}\n	uniform float uProjectionScaleRadius;\n	uniform float uIntensity;\n	uniform float uRandomize;\n	float scalableAmbientObscurance(highp vec2 uv, highp vec3 origin, vec3 normal) {\n		float noise = random(getFragCoord()) + uRandomize;\n		highp vec2 tapPosition = startPosition(noise);\n		highp mat2 angleStep = tapAngleStep();\n		float ssDiskRadius = -(uProjectionScaleRadius / origin.z);\n		float occlusion = 0.0;\n		for (float i = 0.0; i < uSampleCount.x; i += 1.0) {\n			computeAmbientOcclusionSAO(occlusion, i, ssDiskRadius, uv, origin, normal, tapPosition, noise);\n			tapPosition = angleStep * tapPosition;\n		}\n		return occlusion;\n	}\n	uniform float uPower;\n	void main() {\n		highp vec2 uv = uv0;\n		highp float depth = -getLinearScreenDepth(uv0);\n		highp vec3 origin = computeViewSpacePositionFromDepth(uv, depth);\n		vec3 normal = computeViewSpaceNormal(origin, uv);\n		float occlusion = 0.0;\n		if (uIntensity > 0.0) {\n			occlusion = scalableAmbientObscurance(uv, origin, normal);\n		}\n		float ao = max(0.0, 1.0 - occlusion * uIntensity);\n		ao = pow(ao, uPower);\n		gl_FragColor = vec4(ao, ao, ao, 1.0);\n	}\n");let r=this.createRenderTarget("SsaoFinalTexture");this.ssaoTexture=r.colorBuffer,this.init(r,{resizeSource:this.sourceTexture});let a=new en(0,0,0,0);if(this.setClearColor(a),i){let t=this.createRenderTarget("SsaoTempTexture"),i=new bi(e,r.colorBuffer,s,true);i.init(t,{resizeSource:r.colorBuffer}),i.setClearColor(a);let n=new bi(e,t.colorBuffer,s,false);n.init(r,{resizeSource:r.colorBuffer}),n.setClearColor(a),this.afterPasses.push(i),this.afterPasses.push(n);}this.ssaoTextureId=e.scope.resolve("ssaoTexture"),this.ssaoTextureSizeInvId=e.scope.resolve("ssaoTextureSizeInv");}}class br{constructor(){this.stencil=false,this.samples=1,this.sceneColorMap=false,this.lastGrabLayerId=2,this.lastGrabLayerIsTransparent=false,this.lastSceneLayerId=3,this.lastSceneLayerIsTransparent=true,this.taaEnabled=false,this.bloomEnabled=false,this.ssaoType=T0,this.ssaoBlurEnabled=true,this.prepassEnabled=false,this.dofEnabled=false,this.dofNearBlur=false,this.dofHighQuality=true;}}let ba=new br;class bo extends nK{destroy(){this.reset();}reset(){this.sceneTexture=null,this.sceneTextureHalf=null,this.rt&&(this.rt.destroyTextureBuffers(),this.rt.destroy(),this.rt=null),this.rtHalf&&(this.rtHalf.destroyTextureBuffers(),this.rtHalf.destroy(),this.rtHalf=null),this.beforePasses.forEach(e=>e.destroy()),this.beforePasses.length=0,this.prePass=null,this.scenePass=null,this.scenePassTransparent=null,this.colorGrabPass=null,this.composePass=null,this.bloomPass=null,this.ssaoPass=null,this.taaPass=null,this.afterPass=null,this.scenePassHalf=null,this.dofPass=null;}sanitizeOptions(e){return ((e=Object.assign({},ba,e)).taaEnabled||e.ssaoType!==T0||e.dofEnabled)&&(e.prepassEnabled=true),e}set renderTargetScale(e){this._renderTargetScale=e,this.scenePass&&(this.scenePass.scaleX=e,this.scenePass.scaleY=e);}get renderTargetScale(){return this._renderTargetScale}needsReset(e){let t,s;let i=this.options;return e.ssaoType!==i.ssaoType||e.ssaoBlurEnabled!==i.ssaoBlurEnabled||e.taaEnabled!==i.taaEnabled||e.samples!==i.samples||e.stencil!==i.stencil||e.bloomEnabled!==i.bloomEnabled||e.prepassEnabled!==i.prepassEnabled||e.sceneColorMap!==i.sceneColorMap||e.dofEnabled!==i.dofEnabled||e.dofNearBlur!==i.dofNearBlur||e.dofHighQuality!==i.dofHighQuality||(t=e.formats)!==(s=i.formats)&&(!(Array.isArray(t)&&Array.isArray(s))||t.length!==s.length||!t.every((e,t)=>e===s[t]))}update(e){e=this.sanitizeOptions(e),this.needsReset(e)&&this.reset(),this.options=e,this.sceneTexture||this.setupRenderPasses(this.options);}createRenderTarget(e,t,s,i,n){return new sR({colorBuffer:new se(this.device,{name:e,width:4,height:4,format:this.hdrFormat,mipmaps:false,minFilter:1,magFilter:1,addressU:1,addressV:1}),depth:t,stencil:s,samples:i,flipY:n})}setupRenderPasses(e){let{device:t}=this,s=this.cameraComponent,i=s.renderTarget;this.hdrFormat=t.getRenderableHdrFormat(e.formats,true,e.samples)||7,this._bloomEnabled=e.bloomEnabled&&7!==this.hdrFormat,this._sceneHalfEnabled=this._bloomEnabled||e.dofEnabled,s.shaderParams.ssaoEnabled=e.ssaoType===T1;let n=!!(null==i?void 0:i.flipY);this.rt=this.createRenderTarget("SceneColor",true,e.stencil,e.samples,n),this.sceneTexture=this.rt.colorBuffer,this._sceneHalfEnabled&&(this.rtHalf=this.createRenderTarget("SceneColorHalf",false,false,1,n),this.sceneTextureHalf=this.rtHalf.colorBuffer),this.sceneOptions={resizeSource:i,scaleX:this.renderTargetScale,scaleY:this.renderTargetScale},this.createPasses(e);let r=this.collectPasses();this.beforePasses=r.filter(e=>null!=e);}collectPasses(){return [this.prePass,this.ssaoPass,this.scenePass,this.colorGrabPass,this.scenePassTransparent,this.taaPass,this.scenePassHalf,this.bloomPass,this.dofPass,this.composePass,this.afterPass]}createPasses(e){this.setupScenePrepass(e),this.setupSsaoPass(e);let t=this.setupScenePass(e),s=this.setupTaaPass(e);this.setupSceneHalfPass(e,s),this.setupBloomPass(e,this.sceneTextureHalf),this.setupDofPass(e,this.sceneTexture,this.sceneTextureHalf),this.setupComposePass(e),this.setupAfterPass(e,t);}setupScenePrepass(e){if(e.prepassEnabled){let{app:e,device:t,cameraComponent:s}=this,{scene:i,renderer:n}=e;this.prePass=new bs(t,i,n,s,this.sceneOptions);}}setupScenePassSettings(e){e.gammaCorrection=0,e.toneMapping=6;}setupScenePass(e){let{app:t,device:s,cameraComponent:i}=this,{scene:n,renderer:r}=t,a=n.layers;this.scenePass=new lX(s,a,n,r),this.setupScenePassSettings(this.scenePass),this.scenePass.init(this.rt,this.sceneOptions);let o=e.sceneColorMap?e.lastGrabLayerId:e.lastSceneLayerId,l=e.sceneColorMap?e.lastGrabLayerIsTransparent:e.lastSceneLayerIsTransparent,h={lastAddedIndex:0,clearRenderTarget:true};return h.lastAddedIndex=this.scenePass.addLayers(a,i,h.lastAddedIndex,h.clearRenderTarget,o,l),h.clearRenderTarget=false,e.sceneColorMap&&(this.colorGrabPass=new a9(s),this.colorGrabPass.source=this.rt,this.scenePassTransparent=new lX(s,a,n,r),this.setupScenePassSettings(this.scenePassTransparent),this.scenePassTransparent.init(this.rt),h.lastAddedIndex=this.scenePassTransparent.addLayers(a,i,h.lastAddedIndex,h.clearRenderTarget,e.lastSceneLayerId,e.lastSceneLayerIsTransparent),this.scenePassTransparent.rendersAnything||(this.scenePassTransparent.destroy(),this.scenePassTransparent=null),this.scenePassTransparent&&e.prepassEnabled&&(this.scenePassTransparent.depthStencilOps.storeDepth=true)),h}setupSsaoPass(e){let{ssaoBlurEnabled:t,ssaoType:s}=e,{device:i,cameraComponent:n}=this;s!==T0&&(this.ssaoPass=new bn(i,this.sceneTexture,n,t));}setupSceneHalfPass(e,t){this._sceneHalfEnabled&&(this.scenePassHalf=new T3(this.device,this.sceneTexture,{boxFilter:true}),this.scenePassHalf.name="RenderPassSceneHalf",this.scenePassHalf.init(this.rtHalf,{resizeSource:t,scaleX:.5,scaleY:.5}),this.scenePassHalf.setClearColor(en.BLACK));}setupBloomPass(e,t){this._bloomEnabled&&(this.bloomPass=new T5(this.device,t,this.hdrFormat));}setupDofPass(e,t,s){e.dofEnabled&&(this.dofPass=new be(this.device,this.cameraComponent,t,s,e.dofHighQuality,e.dofNearBlur));}setupTaaPass(e){let t=this.sceneTexture;return e.taaEnabled&&(this.taaPass=new T8(this.device,this.sceneTexture,this.cameraComponent),t=this.taaPass.historyTexture),t}setupComposePass(e){var t,s,i,n;this.composePass=new T6(this.device),this.composePass.bloomTexture=null==(t=this.bloomPass)?void 0:t.bloomTexture,this.composePass.taaEnabled=e.taaEnabled,this.composePass.cocTexture=null==(s=this.dofPass)?void 0:s.cocTexture,this.composePass.blurTexture=null==(i=this.dofPass)?void 0:i.blurTexture,this.composePass.blurTextureUpscale=!(null==(n=this.dofPass)?void 0:n.highQuality);let r=this.cameraComponent.renderTarget;this.composePass.init(r),this.composePass.ssaoTexture=e.ssaoType===T2?this.ssaoPass.ssaoTexture:null;}setupAfterPass(e,t){let{app:s,cameraComponent:i}=this,{scene:n,renderer:r}=s,a=n.layers,o=i.renderTarget;this.afterPass=new lX(this.device,a,n,r),this.afterPass.init(o),this.afterPass.addLayers(a,i,t.lastAddedIndex,t.clearRenderTarget);}frameUpdate(){var e,t,s;super.frameUpdate();let i=null!=(s=null==(e=this.taaPass)?void 0:e.update())?s:this.rt.colorBuffer;this.composePass.sceneTexture=i,null==(t=this.scenePassHalf)||t.setSourceTexture(i);}constructor(e,t,s={}){super(e.graphicsDevice),this._renderTargetScale=1,this.rt=null,this.app=e,this.cameraComponent=t,this.options=this.sanitizeOptions(s),this.setupRenderPasses(this.options);}}let bl="local",bh="world",bd="face",bc=new eu,bu=new eu,bp=new ex,bf=new ex,bm=new eO;class b_ extends Y{static createLayer(e,t,s){ void 0===t&&(t="Gizmo");let i=new l2({name:t,clearDepthBuffer:true,opaqueSortMode:0,transparentSortMode:0});return e.scene.layers.insert(i,null!=s?s:e.scene.layers.layerList.length),i}get layer(){return this._layer}set coordSpace(e){this._coordSpace=null!=e?e:bh,this._updateRotation();}get coordSpace(){return this._coordSpace}set size(e){this._size=e,this._updateScale();}get size(){return this._size}get facing(){if(0===this._camera.projection){let e=this.root.getPosition(),t=this._camera.entity.getPosition();return bu.sub2(t,e).normalize()}return bu.copy(this._camera.entity.forward).mulScalar(-1)}_onPointerDown(e){if(!this.root.enabled||document.pointerLockElement)return;let t=this._getSelection(e.offsetX,e.offsetY);t[0]&&(e.preventDefault(),e.stopPropagation());let{canvas:s}=this._device;s.setPointerCapture(e.pointerId),this.fire(b_.EVENT_POINTERDOWN,e.offsetX,e.offsetY,t[0]);}_onPointerMove(e){if(!this.root.enabled||document.pointerLockElement)return;let t=this._getSelection(e.offsetX,e.offsetY);t[0]&&(e.preventDefault(),e.stopPropagation()),this.fire(b_.EVENT_POINTERMOVE,e.offsetX,e.offsetY,t[0]);}_onPointerUp(e){if(!this.root.enabled||document.pointerLockElement)return;let t=this._getSelection(e.offsetX,e.offsetY);t[0]&&(e.preventDefault(),e.stopPropagation());let{canvas:s}=this._device;s.releasePointerCapture(e.pointerId),this.fire(b_.EVENT_POINTERUP,e.offsetX,e.offsetY,t[0]);}_updatePosition(){bc.set(0,0,0);for(let e=0;e<this.nodes.length;e++){let t=this.nodes[e];bc.add(t.getPosition());}bc.mulScalar(1/(this.nodes.length||1)),!(1e-6>bc.distance(this.root.getPosition()))&&(this.root.setPosition(bc),this.fire(b_.EVENT_POSITIONUPDATE,bc));}_updateRotation(){bc.set(0,0,0),this._coordSpace===bl&&0!==this.nodes.length&&bc.copy(this.nodes[this.nodes.length-1].getEulerAngles()),!(1e-6>bc.distance(this.root.getEulerAngles()))&&(this.root.setEulerAngles(bc),this.fire(b_.EVENT_ROTATIONUPDATE,bc));}_updateScale(){if(0===this._camera.projection){let e=this.root.getPosition(),t=this._camera.entity.getPosition(),s=e.distance(t);this._scale=Math.tan(.5*this._camera.fov*ei.DEG_TO_RAD)*s*.3;}else this._scale=.32*this._camera.orthoHeight;this._scale=Math.max(this._scale*this._size,1e-4),!(1e-6>Math.abs(this._scale-this.root.getLocalScale().x))&&(this.root.setLocalScale(this._scale,this._scale,this._scale),this.fire(b_.EVENT_SCALEUPDATE,this._scale));}_getSelection(e,t){let s=this._camera.screenToWorld(e,t,0),i=this._camera.screenToWorld(e,t,this._camera.farClip-this._camera.nearClip),n=bc.copy(i).sub(s).normalize(),r=[];for(let e=0;e<this.intersectShapes.length;e++){let t=this.intersectShapes[e];if(t.disabled||!t.entity.enabled)continue;let i=t.entity.getWorldTransform();for(let e=0;e<t.triData.length;e++){let{tris:a,transform:o,priority:l}=t.triData[e],h=bp.copy(i).mul(o),d=bf.copy(h).invert();d.transformPoint(s,bm.origin),d.transformVector(n,bm.direction),bm.direction.normalize();for(let e=0;e<a.length;e++)a[e].intersectsRay(bm,bc)&&r.push({dist:h.transformPoint(bc).sub(s).length(),meshInstances:t.meshInstances,priority:l});}}return r.length?(r.sort((e,t)=>0!==e.priority&&0!==t.priority?t.priority-e.priority:e.dist-t.dist),r[0].meshInstances):[]}attach(e){if(void 0===e&&(e=[]),Array.isArray(e)){if(0===e.length)return;this.nodes=e;}else this.nodes=[e];this._updatePosition(),this._updateRotation(),this._updateScale(),this.fire(b_.EVENT_NODESATTACH),this.root.enabled=true,this.fire(b_.EVENT_RENDERUPDATE);}detach(){this.root.enabled=false,this.fire(b_.EVENT_RENDERUPDATE),this.fire(b_.EVENT_NODESDETACH),this.nodes=[];}destroy(){this.detach(),this._device.canvas.removeEventListener("pointerdown",this._onPointerDown),this._device.canvas.removeEventListener("pointermove",this._onPointerMove),this._device.canvas.removeEventListener("pointerup",this._onPointerUp),this.root.destroy();}constructor(e,t){super(),this._size=1,this._scale=1,this._coordSpace=bh,this.nodes=[],this.intersectShapes=[],this._camera=e,this._app=e.system.app,this._device=this._app.graphicsDevice,this._layer=t,e.layers=e.layers.concat(t.id),this.root=new uG("gizmo"),this._app.root.addChild(this.root),this.root.enabled=false,this._updateScale(),this._onPointerDown=this._onPointerDown.bind(this),this._onPointerMove=this._onPointerMove.bind(this),this._onPointerUp=this._onPointerUp.bind(this),this._device.canvas.addEventListener("pointerdown",this._onPointerDown),this._device.canvas.addEventListener("pointermove",this._onPointerMove),this._device.canvas.addEventListener("pointerup",this._onPointerUp),this._app.on("update",()=>{this._updatePosition(),this._updateRotation(),this._updateScale();}),this._app.on("destroy",()=>this.destroy());}}b_.EVENT_POINTERDOWN="pointer:down",b_.EVENT_POINTERMOVE="pointer:move",b_.EVENT_POINTERUP="pointer:up",b_.EVENT_POSITIONUPDATE="position:update",b_.EVENT_ROTATIONUPDATE="rotation:update",b_.EVENT_SCALEUPDATE="scale:update",b_.EVENT_NODESATTACH="nodes:attach",b_.EVENT_NODESDETACH="nodes:detach",b_.EVENT_RENDERUPDATE="render:update";let bg=Object.freeze(new en(1,.3,.3)),bv=Object.freeze(new en(.3,1,.3)),by=Object.freeze(new en(.3,.3,1)),bS=Object.freeze(new en(1,1,.5)),bx=Object.freeze(new en(.5,.5,.5,.5)),bT=e=>new en(e.r,e.g,e.b),bb=(e,t)=>new en(e.r,e.g,e.b,t),bE=new eu,bA=new eu,bw=new eT,bC=new eO,bP=new eL,bM=Object.keys(bE);class bI extends b_{set shading(e){for(let t in this._shading=this.root.enabled&&e,this._shapes)this._shapes[t].shading=this._shading;}get shading(){return this._shading}set snap(e){this._snap=this.root.enabled&&e;}get snap(){return this._snap}set xAxisColor(e){this._updateAxisColor("x",e);}get xAxisColor(){return this._meshColors.axis.x}set yAxisColor(e){this._updateAxisColor("y",e);}get yAxisColor(){return this._meshColors.axis.y}set zAxisColor(e){this._updateAxisColor("z",e);}get zAxisColor(){return this._meshColors.axis.z}set colorAlpha(e){for(let t in this._colorAlpha=ei.clamp(e,0,1),this._meshColors.axis.x.copy(this._colorSemi(this._meshColors.axis.x)),this._meshColors.axis.y.copy(this._colorSemi(this._meshColors.axis.y)),this._meshColors.axis.z.copy(this._colorSemi(this._meshColors.axis.z)),this._meshColors.axis.xyz.copy(this._colorSemi(this._meshColors.axis.xyz)),this._meshColors.axis.f.copy(this._colorSemi(this._meshColors.axis.f)),this._shapes)this._shapes[t].hover(!!this._hoverAxis);}get colorAlpha(){return this._colorAlpha}_colorSemi(e){return bb(e,this._colorAlpha)}_updateAxisColor(e,t){let s=bT(t),i=this._colorSemi(t);for(let t in this._guideColors[e].copy(s),this._meshColors.axis[e].copy(i),this._meshColors.hover[e].copy(s),this._shapes)this._shapes[t].hover(!!this._hoverAxis);}_getAxis(e){return e?e.node.name.split(":")[1]:""}_getIsPlane(e){return !!e&&-1!==e.node.name.indexOf("plane")}_hover(e){var t;if(this._dragging)return;this._hoverAxis=this._getAxis(e),this._hoverIsPlane=this._getIsPlane(e);let s=e&&null!=(t=this._shapeMap.get(e))?t:null;s!==this._hoverShape&&(this._hoverShape&&(this._hoverShape.hover(false),this._hoverShape=null),s&&(s.hover(true),this._hoverShape=s),this.fire(b_.EVENT_RENDERUPDATE));}_createRay(e){if(0===this._camera.projection)return bC.origin.copy(this._camera.entity.getPosition()),bC.direction.sub2(e,bC.origin).normalize(),bC;let t=this._camera.farClip-this._camera.nearClip;return bC.origin.sub2(e,bE.copy(this._camera.entity.forward).mulScalar(t)),bC.direction.copy(this._camera.entity.forward),bC}_createPlane(e,t,s){let i=bE.copy(this.facing),n=bP.normal.set(0,0,0);return t?n.copy(i):(n[e]=1,this._rootStartRot.transformVector(n,n),s&&(bA.cross(n,i).normalize(),n.cross(bA,n).normalize())),bP.setFromPointNormal(this._rootStartPos,n)}_dirFromAxis(e,t){return e===bd?t.copy(this._camera.entity.forward).mulScalar(-1):(t.set(0,0,0),t[e]=1),t}_projectToAxis(e,t){bE.set(0,0,0),bE[t]=1,e.copy(bE.mulScalar(bE.dot(e)));let s=e[t];e.set(0,0,0),e[t]=s;}_screenToPoint(e,t,s,i){ void 0===s&&(s=false),void 0===i&&(i=false);let n=this._camera.screenToWorld(e,t,1),r=this._selectedAxis,a=this._createRay(n),o=this._createPlane(r,s,i),l=new eu;return o.intersectsRay(a,l),l}_drawGuideLines(){let e=this.root.getPosition(),t=bw.copy(this.root.getRotation()),s=this._hoverAxis||this._selectedAxis,i=this._hoverIsPlane||this._selectedIsPlane;for(let n=0;n<bM.length;n++){let r=bM[n];if("xyz"===s){this._drawSpanLine(e,t,r);continue}i?r!==s&&this._drawSpanLine(e,t,r):r===s&&this._drawSpanLine(e,t,r);}}_drawSpanLine(e,t,s){bE.set(0,0,0),bE[s]=1,bE.mulScalar(this._camera.farClip-this._camera.nearClip),bA.copy(bE).mulScalar(-1),t.transformVector(bE,bE),t.transformVector(bA,bA),this._app.drawLine(bE.add(e),bA.add(e),this._guideColors[s],true);}_createTransform(){for(let e in this._shapes){let t=this._shapes[e];this.root.addChild(t.entity),this.intersectShapes.push(t);for(let e=0;e<t.meshInstances.length;e++)this._shapeMap.set(t.meshInstances[e],t);}}enableShape(e,t){this._shapes.hasOwnProperty(e)&&(this._shapes[e].disabled=!t);}isShapeEnabled(e){return !!this._shapes.hasOwnProperty(e)&&!this._shapes[e].disabled}destroy(){for(let e in super.destroy(),this._shapes)this._shapes[e].destroy();}constructor(e,t){super(e,t),this._colorAlpha=.6,this._meshColors={axis:{x:this._colorSemi(bg),y:this._colorSemi(bv),z:this._colorSemi(by),xyz:this._colorSemi(en.WHITE),f:this._colorSemi(en.WHITE)},hover:{x:bg.clone(),y:bv.clone(),z:by.clone(),xyz:en.WHITE.clone(),f:bS.clone()},disabled:bx.clone()},this._guideColors={x:bg.clone(),y:bv.clone(),z:by.clone(),f:bS.clone()},this._rootStartPos=new eu,this._rootStartRot=new eT,this._shading=false,this._shapes={},this._shapeMap=new Map,this._hoverShape=null,this._hoverAxis="",this._hoverIsPlane=false,this._noSelection=false,this._selectedAxis="",this._selectedIsPlane=false,this._selectionStartPoint=new eu,this._dragging=false,this._snap=false,this.snapIncrement=1,this._app.on("prerender",()=>{this.root.enabled&&this._drawGuideLines();}),this.on(b_.EVENT_POINTERDOWN,(e,t,s)=>{let i=this._shapeMap.get(s);if((null==i?void 0:i.disabled)||this._dragging)return;if(!s){this._noSelection=true;return}this._selectedAxis=this._getAxis(s),this._selectedIsPlane=this._getIsPlane(s),this._rootStartPos.copy(this.root.getPosition()),this._rootStartRot.copy(this.root.getRotation());let n=this._screenToPoint(e,t);this._selectionStartPoint.copy(n),this._dragging=true,this.fire(bI.EVENT_TRANSFORMSTART,n,e,t);}),this.on(b_.EVENT_POINTERMOVE,(e,t,s)=>{let i=this._shapeMap.get(s);if((null==i?void 0:i.disabled)||(this._noSelection||this._hover(s),!this._dragging))return;let n=this._screenToPoint(e,t);this.fire(bI.EVENT_TRANSFORMMOVE,n,e,t),this._hoverAxis="",this._hoverIsPlane=false;}),this.on(b_.EVENT_POINTERUP,(e,t,s)=>{this._noSelection=false,this._hover(s),this._dragging&&(this._dragging=false,this.fire(bI.EVENT_TRANSFORMEND),this._selectedAxis="",this._selectedIsPlane=false);}),this.on(b_.EVENT_NODESDETACH,()=>{this.snap=false,this._hoverAxis="",this._hoverIsPlane=false,this._hover(),this.fire(b_.EVENT_POINTERUP);});}}bI.EVENT_TRANSFORMSTART="transform:start",bI.EVENT_TRANSFORMMOVE="transform:move",bI.EVENT_TRANSFORMEND="transform:end";let bR=new eu,bL=new eu,bD=new eu;class bO{get transform(){return this._transform}get priority(){return this._priority}setTransform(e,t,s){ void 0===e&&(e=new eu),void 0===t&&(t=new eT),void 0===s&&(s=new eu),this.transform.setTRS(e,t,s);}fromGeometry(e){var t,s;if(!e||!(e instanceof dn))throw Error("No geometry provided.");let i=null!=(t=e.positions)?t:[],n=null!=(s=e.indices)?s:[];this.tris=[];for(let e=0;e<n.length;e+=3){let t=n[e],s=n[e+1],r=n[e+2];bR.set(i[3*t],i[3*t+1],i[3*t+2]),bL.set(i[3*s],i[3*s+1],i[3*s+2]),bD.set(i[3*r],i[3*r+1],i[3*r+2]);let a=new eW(bR,bL,bD);this.tris.push(a);}}constructor(e,t=0){this._priority=0,this._transform=new ex,this.tris=[],this.fromGeometry(e),this._priority=t;}}let bF=new eu(1,2,3),bN={box:dr,cone:cV,cylinder:cG,plane:cH,sphere:da,torus:cW},bB={uniqueName:"axis-shape",attributes:{vertex_position:e2,vertex_color:e8},vertexGLSL:"\n		attribute vec3 vertex_position;\n		attribute vec4 vertex_color;\n		varying vec4 vColor;\n		uniform mat4 matrix_model;\n		uniform mat4 matrix_viewProjection;\n		void main(void) {\n			gl_Position = matrix_viewProjection * matrix_model * vec4(vertex_position, 1.0);\n			gl_Position.z = clamp(gl_Position.z, -abs(gl_Position.w), abs(gl_Position.w));\n			vColor = vertex_color;\n		}\n	",fragmentGLSL:'\n		#include "gammaPS"\n		precision highp float;\n		varying vec4 vColor;\n		void main(void) {\n			gl_FragColor = vec4(gammaCorrectOutput(decodeGamma(vColor)), vColor.w);\n		}\n	'},bU=new Map,bk=new eu,bz=new eu,bV=new ex,bG=new dn;bG.positions=[],bG.normals=[];let bH=(e,t,s)=>{let i;if(!e.normals||!e.positions)return [];s&&(i=bV.copy(s).invert().transformVector(bk.copy(bF),bk).normalize()),e.colors=[];let n=[],r=e.positions.length/3;for(let s=0;s<r;s++){let r=1;if(i){let t=e.normals[3*s],n=e.normals[3*s+1],a=e.normals[3*s+2],o=bz.set(t,n,a);r=.25*i.dot(o)+.75;}n.push(r),e.colors.push(r*t.r*255,r*t.g*255,r*t.b*255,255*t.a);}return n},bW=(e,t)=>{let s=bU.get(e),i=[];for(let e=0;e<s.length;e++)i.push(s[e]*t.r*255,s[e]*t.g*255,s[e]*t.b*255,255*t.a);e.setColors32(i),e.update();};class bX{set disabled(e){for(let t=0;t<this.meshInstances.length;t++)bW(this.meshInstances[t].mesh,e?this._disabledColor:this._defaultColor);this._disabled=null!=e&&e;}get disabled(){return this._disabled}set shading(e){this._shading=null==e||e;let t=this._disabled?this._disabledColor:this._defaultColor;for(let e=0;e<this.meshInstances.length;e++){let s=this.meshInstances[e].mesh;s.getPositions(bG.positions),s.getNormals(bG.normals);let i=bH(bG,t,this._shading?this.entity.getWorldTransform():void 0);bU.set(s,i),bW(s,t);}}get shading(){return this._shading}_createRoot(e){this.entity=new uG(e+":"+this.axis),this.entity.setLocalPosition(this._position),this.entity.setLocalEulerAngles(this._rotation),this.entity.setLocalScale(this._scale);}_createMesh(e,t){ void 0===t&&(t=true);let s=bH(e,this._disabled?this._disabledColor:this._defaultColor,t?this.entity.getWorldTransform():void 0),i=aG.fromGeometry(this.device,e);return bU.set(i,s),i}_createRenderComponent(e,t){let s=new h9(bB);s.cull=this._cull,s.blendType=2,s.update();let i=[];for(let e=0;e<t.length;e++){let n=new a0(t[e],s);n.cull=false,i.push(n),this.meshInstances.push(n);}e.addComponent("render",{meshInstances:i,layers:this._layers,castShadows:false});}_addRenderMesh(e,t,s){let i=bN[t];if(!i)throw Error("Invalid primitive type.");this._createRenderComponent(e,[this._createMesh(new i,s)]);}hover(e){if(!this._disabled)for(let t=0;t<this.meshInstances.length;t++){let s=e?this._hoverColor:this._defaultColor;bW(this.meshInstances[t].mesh,s);}}destroy(){this.entity.destroy();}constructor(e,t){var s,i,n,r,a,o,l;this._layers=[],this._shading=true,this._defaultColor=en.WHITE,this._hoverColor=en.BLACK,this._disabledColor=bx,this._cull=1,this.triData=[],this.meshInstances=[],this.device=e,this.axis=null!=(s=t.axis)?s:"x",this._position=null!=(i=t.position)?i:new eu,this._rotation=null!=(n=t.rotation)?n:new eu,this._scale=null!=(r=t.scale)?r:new eu(1,1,1),this._disabled=null!=(a=t.disabled)&&a,this._layers=null!=(o=t.layers)?o:this._layers,this._shading=null!=(l=t.shading)?l:this._shading,t.defaultColor instanceof en&&(this._defaultColor=t.defaultColor),t.hoverColor instanceof en&&(this._hoverColor=t.hoverColor),t.disabledColor instanceof en&&(this._disabledColor=t.disabledColor);}}class bY extends bX{set size(e){this._size=null!=e?e:1,this._updateTransform();}get size(){return this._size}set gap(e){this._gap=null!=e?e:0,this._updateTransform();}get gap(){return this._gap}set flipped(e){!(1e-6>this._flipped.distance(e))&&(this._flipped.copy(e),this.entity.setLocalPosition(this._getPosition()));}get flipped(){return this._flipped}_getPosition(){let e=this._size/2+this._gap,t=new eu(this._flipped.x?-e:e,this._flipped.y?-e:e,this._flipped.z?-e:e);return t[this.axis]=0,t}_createPlane(){this._createRoot("plane"),this._updateTransform(),this._addRenderMesh(this.entity,"plane",this._shading);}_updateTransform(){this.entity.setLocalPosition(this._getPosition()),this.entity.setLocalEulerAngles(this._rotation),this.entity.setLocalScale(this._size,this._size,this._size);}constructor(e,t={}){super(e,t),this._cull=0,this._size=.2,this._gap=.1,this._flipped=new eu,this.triData=[new bO(new cH)],this._createPlane();}}let bj=new eu,bq=new eu,bK=new eT;class bZ extends bX{set gap(e){this._gap=null!=e?e:0,this._updateHead(),this._updateLine();}get gap(){return this._gap}set lineThickness(e){this._lineThickness=null!=e?e:1,this._updateHead(),this._updateLine();}get lineThickness(){return this._lineThickness}set lineLength(e){this._lineLength=null!=e?e:1,this._updateHead(),this._updateLine();}get lineLength(){return this._lineLength}set arrowThickness(e){this._arrowThickness=null!=e?e:1,this._updateHead();}get arrowThickness(){return this._arrowThickness}set arrowLength(e){this._arrowLength=null!=e?e:1,this._updateHead();}get arrowLength(){return this._arrowLength}set tolerance(e){this._tolerance=e,this._updateLine();}get tolerance(){return this._tolerance}set flipped(e){this._flipped!==e&&(this._flipped=e,this._rotation.equals(eu.ZERO)?bj.set(0,0,180*!!this._flipped):bj.copy(this._rotation).mulScalar(this._flipped?-1:1),this._line.enabled=!this._flipped,this.entity.setLocalEulerAngles(bj));}get flipped(){return this._flipped}_createArrow(){this._createRoot("arrow"),this._head=new uG("head:"+this.axis),this.entity.addChild(this._head),this._updateHead(),this._addRenderMesh(this._head,"cone",this._shading),this._line=new uG("line:"+this.axis),this.entity.addChild(this._line),this._updateLine(),this._addRenderMesh(this._line,"cylinder",this._shading);}_updateHead(){bj.set(0,this._gap+.5*this._arrowLength+this._lineLength,0),bK.set(0,0,0,1),bq.set(this._arrowThickness,this._arrowLength,this._arrowThickness),this.triData[0].setTransform(bj,bK,bq),this._head.setLocalPosition(0,this._gap+.5*this._arrowLength+this._lineLength,0),this._head.setLocalScale(this._arrowThickness,this._arrowLength,this._arrowThickness);}_updateLine(){bj.set(0,this._gap+.5*this._lineLength,0),bK.set(0,0,0,1),bq.set(this._lineThickness+this._tolerance,this._lineLength,this._lineThickness+this._tolerance),this.triData[1].setTransform(bj,bK,bq),this._line.setLocalPosition(0,this._gap+.5*this._lineLength,0),this._line.setLocalScale(this._lineThickness,this._lineLength,this._lineThickness);}constructor(e,t={}){super(e,t),this._gap=0,this._lineThickness=.02,this._lineLength=.5,this._arrowThickness=.12,this._arrowLength=.18,this._tolerance=.1,this._flipped=false,this.triData=[new bO(new cV),new bO(new cG,1)],this._createArrow();}}class bQ extends bX{_createCenter(){this._createRoot("sphereCenter"),this._updateTransform(),this._addRenderMesh(this.entity,"sphere",this._shading);}set size(e){this._size=null!=e?e:1,this._updateTransform();}get size(){return this._size}set tolerance(e){this._tolerance=e,this._updateTransform();}get tolerance(){return this._tolerance}_updateTransform(){this.entity.setLocalScale(this._size,this._size,this._size);}constructor(e,t={}){super(e,t),this._size=.12,this._tolerance=.05,this.triData=[new bO(new da,2)],this._createCenter();}}let bJ=new eu,b$=new eu,b0=new eu,b1=new eT;class b2 extends bX{_createTorusGeometry(){return new cW({tubeRadius:this._tubeRadius+this._tolerance,ringRadius:this._ringRadius,sectorAngle:this._sectorAngle,segments:20})}_createTorusMesh(e){let t=new cW({tubeRadius:this._tubeRadius,ringRadius:this._ringRadius,sectorAngle:e,segments:80});return this._createMesh(t,this._shading)}_createDisk(){this._createRoot("disk"),this._createRenderComponent(this.entity,[this._createTorusMesh(this._sectorAngle),this._createTorusMesh(360)]),this.drag(false);}set tubeRadius(e){this._tubeRadius=null!=e?e:.1,this._updateTransform();}get tubeRadius(){return this._tubeRadius}set ringRadius(e){this._ringRadius=null!=e?e:.1,this._updateTransform();}get ringRadius(){return this._ringRadius}set tolerance(e){this._tolerance=e,this._updateTransform();}get tolerance(){return this._tolerance}_updateTransform(){this.triData[0].fromGeometry(this._createTorusGeometry()),this.meshInstances[0].mesh=this._createTorusMesh(this._sectorAngle),this.meshInstances[1].mesh=this._createTorusMesh(360);}drag(e){this.meshInstances[0].visible=!e,this.meshInstances[1].visible=e;}hide(e){if(e){this.meshInstances[0].visible=false,this.meshInstances[1].visible=false;return}this.drag(false);}constructor(e,t={}){var s,i,n;super(e,t),this._tubeRadius=.01,this._ringRadius=.5,this._tolerance=.05,this._tubeRadius=null!=(s=t.tubeRadius)?s:this._tubeRadius,this._ringRadius=null!=(i=t.ringRadius)?i:this._ringRadius,this._sectorAngle=null!=(n=t.sectorAngle)?n:this._sectorAngle,this.triData=[new bO(this._createTorusGeometry())],this._createDisk();}}let b3=new eu,b4=new eu,b5=new eu,b6=new eu,b8=new ex,b9=new eT,b7=new eT,Ee=new en(0,0,0,.3);class Et extends bX{_createCenter(){this._createRoot("boxCenter"),this._updateTransform(),this._addRenderMesh(this.entity,"box",this._shading);}set size(e){this._size=null!=e?e:1,this._updateTransform();}get size(){return this._size}set tolerance(e){this._tolerance=e,this._updateTransform();}get tolerance(){return this._tolerance}_updateTransform(){this.entity.setLocalScale(this._size,this._size,this._size);}constructor(e,t={}){super(e,t),this._size=.12,this._tolerance=.05,this.triData=[new bO(new dr,2)],this._createCenter();}}let Es=new eu,Ei=new eu,En=new eT;class Er extends bX{set gap(e){this._gap=null!=e?e:0,this._updateLine(),this._updateBox();}get gap(){return this._gap}set lineThickness(e){this._lineThickness=null!=e?e:1,this._updateLine(),this._updateBox();}get lineThickness(){return this._lineThickness}set lineLength(e){this._lineLength=null!=e?e:1,this._updateLine(),this._updateBox();}get lineLength(){return this._lineLength}set boxSize(e){this._boxSize=null!=e?e:1,this._updateBox();}get boxSize(){return this._boxSize}set tolerance(e){this._tolerance=e,this._updateLine();}get tolerance(){return this._tolerance}set flipped(e){this._flipped!==e&&(this._flipped=e,this._rotation.equals(eu.ZERO)?Es.set(0,0,180*!!this._flipped):Es.copy(this._rotation).mulScalar(this._flipped?-1:1),this._line.enabled=!this._flipped,this.entity.setLocalEulerAngles(Es));}get flipped(){return this._flipped}_createBoxLine(){this._createRoot("boxLine"),this._box=new uG("box:"+this.axis),this.entity.addChild(this._box),this._updateBox(),this._addRenderMesh(this._box,"box",this._shading),this._line=new uG("line:"+this.axis),this.entity.addChild(this._line),this._updateLine(),this._addRenderMesh(this._line,"cylinder",this._shading);}_updateBox(){Es.set(0,this._gap+.5*this._boxSize+this._lineLength,0),En.set(0,0,0,1),Ei.set(this._boxSize,this._boxSize,this._boxSize),this.triData[0].setTransform(Es,En,Ei),this._box.setLocalPosition(0,this._gap+.5*this._boxSize+this._lineLength,0),this._box.setLocalScale(this._boxSize,this._boxSize,this._boxSize);}_updateLine(){Es.set(0,this._gap+.5*this._lineLength,0),En.set(0,0,0,1),Ei.set(this._lineThickness+this._tolerance,this._lineLength,this._lineThickness+this._tolerance),this.triData[1].setTransform(Es,En,Ei),this._line.setLocalPosition(0,this._gap+.5*this._lineLength,0),this._line.setLocalScale(this._lineThickness,this._lineLength,this._lineThickness);}constructor(e,t={}){super(e,t),this._gap=0,this._lineThickness=.02,this._lineLength=.5,this._boxSize=.12,this._tolerance=.1,this._flipped=false,this.triData=[new bO(new dr),new bO(new cG,1)],this._createBoxLine();}}let Ea=new eu,Eo=new eu,El=new eu,Eh=new eT,Ed=new eu,Ec=new eu,Eu=new eu,Ep=new ex;class Ef extends Y{set anchor(e){this._anchor.copy(e),this.dom.style.top=this._anchor.x?"0px":"auto",this.dom.style.right=this._anchor.y?"0px":"auto",this.dom.style.bottom=this._anchor.z?"0px":"auto",this.dom.style.left=this._anchor.w?"0px":"auto";}get anchor(){return this._anchor}set colorX(e){this._colorX.copy(e),this._shapes.px.children[0].setAttribute("fill",this._colorX.toString(false)),this._shapes.px.children[0].setAttribute("stroke",this._colorX.toString(false)),this._shapes.nx.children[0].setAttribute("stroke",this._colorX.toString(false)),this._shapes.xaxis.setAttribute("stroke",this._colorX.toString(false));}get colorX(){return this._colorX}set colorY(e){this._colorY.copy(e),this._shapes.py.children[0].setAttribute("fill",this._colorY.toString(false)),this._shapes.py.children[0].setAttribute("stroke",this._colorY.toString(false)),this._shapes.ny.children[0].setAttribute("stroke",this._colorY.toString(false)),this._shapes.yaxis.setAttribute("stroke",this._colorY.toString(false));}get colorY(){return this._colorY}set colorZ(e){this._colorZ.copy(e),this._shapes.pz.children[0].setAttribute("fill",this._colorZ.toString(false)),this._shapes.pz.children[0].setAttribute("stroke",this._colorZ.toString(false)),this._shapes.nz.children[0].setAttribute("stroke",this._colorZ.toString(false)),this._shapes.zaxis.setAttribute("stroke",this._colorZ.toString(false));}get colorZ(){return this._colorZ}set colorNeg(e){this._colorNeg.copy(e),this._shapes.px.children[0].setAttribute("fill",this._colorNeg.toString(false)),this._shapes.py.children[0].setAttribute("fill",this._colorNeg.toString(false)),this._shapes.pz.children[0].setAttribute("fill",this._colorNeg.toString(false));}get colorNeg(){return this._colorNeg}set radius(e){this._radius=e,this._shapes.px.children[0].setAttribute("r",""+e),this._shapes.py.children[0].setAttribute("r",""+e),this._shapes.pz.children[0].setAttribute("r",""+e),this._shapes.nx.children[0].setAttribute("r",""+e),this._shapes.ny.children[0].setAttribute("r",""+e),this._shapes.nz.children[0].setAttribute("r",""+e),this._resize();}get radius(){return this._radius}set textSize(e){this._textSize=e,this._shapes.px.children[1].setAttribute("font-size",""+e),this._shapes.py.children[1].setAttribute("font-size",""+e),this._shapes.pz.children[1].setAttribute("font-size",""+e);}get textSize(){return this._textSize}set lineThickness(e){this._lineThickness=e,this._shapes.xaxis.setAttribute("stroke-width",""+e),this._shapes.yaxis.setAttribute("stroke-width",""+e),this._shapes.zaxis.setAttribute("stroke-width",""+e),this._shapes.px.children[0].setAttribute("stroke-width",""+e),this._shapes.py.children[0].setAttribute("stroke-width",""+e),this._shapes.pz.children[0].setAttribute("stroke-width",""+e),this._shapes.nx.children[0].setAttribute("stroke-width",""+e),this._shapes.ny.children[0].setAttribute("stroke-width",""+e),this._shapes.nz.children[0].setAttribute("stroke-width",""+e),this._resize();}get lineThickness(){return this._lineThickness}set lineLength(e){this._lineLength=e,this._resize();}get lineLength(){return this._lineLength}_resize(){this._size=2*(this.lineLength+this.radius+this.lineThickness),this.dom.style.width=""+this._size+"px",this.dom.style.height=""+this._size+"px",this._svg.setAttribute("width",""+this._size),this._svg.setAttribute("height",""+this._size),this._group.setAttribute("transform","translate("+.5*this._size+", "+.5*this._size+")");}_transform(e,t,s){e.setAttribute("transform","translate("+t*this._lineLength+", "+s*this._lineLength+")");}_x2y2(e,t,s){e.setAttribute("x2",""+t*this._lineLength),e.setAttribute("y2",""+s*this._lineLength);}_line(e){let t=document.createElementNS(this._svg.namespaceURI,"line");return t.setAttribute("stroke",e),t.setAttribute("stroke-width",""+this._lineThickness),this._group.appendChild(t),t}_circle(e,t,s){ void 0===t&&(t=false);let i=document.createElementNS(this._svg.namespaceURI,"g"),n=document.createElementNS(this._svg.namespaceURI,"circle");if(n.setAttribute("fill",t?e:this._colorNeg.toString(false)),n.setAttribute("stroke",e),n.setAttribute("stroke-width",""+this._lineThickness),n.setAttribute("r",""+this._radius),n.setAttribute("cx","0"),n.setAttribute("cy","0"),n.setAttribute("pointer-events","all"),i.appendChild(n),s){let e=document.createElementNS(this._svg.namespaceURI,"text");e.setAttribute("font-size",""+this._textSize),e.setAttribute("font-family","Arial"),e.setAttribute("font-weight","bold"),e.setAttribute("text-anchor","middle"),e.setAttribute("alignment-baseline","central"),e.textContent=s,i.appendChild(e);}return i.setAttribute("cursor","pointer"),this._group.appendChild(i),i}update(e){if(!this._size)return;Ep.invert(e),Ep.getX(Ed),Ep.getY(Ec),Ep.getZ(Eu),this._transform(this._shapes.px,Ed.x,-Ed.y),this._transform(this._shapes.nx,-Ed.x,Ed.y),this._transform(this._shapes.py,Ec.x,-Ec.y),this._transform(this._shapes.ny,-Ec.x,Ec.y),this._transform(this._shapes.pz,Eu.x,-Eu.y),this._transform(this._shapes.nz,-Eu.x,Eu.y),this._x2y2(this._shapes.xaxis,Ed.x,-Ed.y),this._x2y2(this._shapes.yaxis,Ec.x,-Ec.y),this._x2y2(this._shapes.zaxis,Eu.x,-Eu.y);let t=[{n:["xaxis","px"],value:Ed.z},{n:["yaxis","py"],value:Ec.z},{n:["zaxis","pz"],value:Eu.z},{n:["nx"],value:-Ed.z},{n:["ny"],value:-Ec.z},{n:["nz"],value:-Eu.z}].sort((e,t)=>e.value-t.value),s=document.createDocumentFragment();t.forEach(e=>{e.n.forEach(e=>{s.appendChild(this._shapes[e]);});}),this._group.appendChild(s);}destroy(){this.dom.remove(),this.off();}constructor(e){super(),this._size=0,this._anchor=new em(1,1,1,1),this._colorX=bg.clone(),this._colorY=bv.clone(),this._colorZ=by.clone(),this._colorNeg=new en(.3,.3,.3),this._radius=10,this._textSize=10,this._lineThickness=2,this._lineLength=40,this.dom=document.createElement("div"),this.dom.id="view-cube-container",this.dom.style.cssText="position: absolute;margin: auto;pointer-events: none",document.body.appendChild(this.dom),this.anchor=null!=e?e:this._anchor,this._svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this._svg.id="view-cube-svg",this._group=document.createElementNS(this._svg.namespaceURI,"g"),this._svg.appendChild(this._group),this._resize();let t=this._colorX.toString(false),s=this._colorY.toString(false),i=this._colorZ.toString(false);this._shapes={nx:this._circle(t),ny:this._circle(s),nz:this._circle(i),px:this._circle(t,true,"X"),py:this._circle(s,true,"Y"),pz:this._circle(i,true,"Z"),xaxis:this._line(t),yaxis:this._line(s),zaxis:this._line(i)},this._shapes.px.children[0].addEventListener("pointerdown",()=>{this.fire(Ef.EVENT_CAMERAALIGN,eu.RIGHT);}),this._shapes.py.children[0].addEventListener("pointerdown",()=>{this.fire(Ef.EVENT_CAMERAALIGN,eu.UP);}),this._shapes.pz.children[0].addEventListener("pointerdown",()=>{this.fire(Ef.EVENT_CAMERAALIGN,eu.BACK);}),this._shapes.nx.children[0].addEventListener("pointerdown",()=>{this.fire(Ef.EVENT_CAMERAALIGN,eu.LEFT);}),this._shapes.ny.children[0].addEventListener("pointerdown",()=>{this.fire(Ef.EVENT_CAMERAALIGN,eu.DOWN);}),this._shapes.nz.children[0].addEventListener("pointerdown",()=>{this.fire(Ef.EVENT_CAMERAALIGN,eu.FORWARD);}),this.dom.appendChild(this._svg);}}Ef.EVENT_CAMERAALIGN="camera:align",e.ABSOLUTE_URL=uv,e.ACTION_GAMEPAD=ri,e.ACTION_KEYBOARD=rs,e.ACTION_MOUSE=rt,e.ADDRESS_CLAMP_TO_EDGE=1,e.ADDRESS_MIRRORED_REPEAT=2,e.ADDRESS_REPEAT=0,e.AMBIENTSRC_AMBIENTSH=r6,e.AMBIENTSRC_CONSTANT=r9,e.AMBIENTSRC_ENVALATLAS=r8,e.ANIM_BLEND_1D="1D",e.ANIM_BLEND_2D_CARTESIAN=py,e.ANIM_BLEND_2D_DIRECTIONAL=pv,e.ANIM_BLEND_DIRECT=pS,e.ANIM_CONTROL_STATES=pT,e.ANIM_EQUAL_TO=pu,e.ANIM_GREATER_THAN=pl,e.ANIM_GREATER_THAN_EQUAL_TO=pd,e.ANIM_INTERRUPTION_NEXT=pr,e.ANIM_INTERRUPTION_NEXT_PREV=po,e.ANIM_INTERRUPTION_NONE=pi,e.ANIM_INTERRUPTION_PREV=pn,e.ANIM_INTERRUPTION_PREV_NEXT=pa,e.ANIM_LAYER_ADDITIVE=pE,e.ANIM_LAYER_OVERWRITE=pb,e.ANIM_LESS_THAN=ph,e.ANIM_LESS_THAN_EQUAL_TO=pc,e.ANIM_NOT_EQUAL_TO=pp,e.ANIM_PARAMETER_BOOLEAN=p_,e.ANIM_PARAMETER_FLOAT=pm,e.ANIM_PARAMETER_INTEGER=pf,e.ANIM_PARAMETER_TRIGGER=pg,e.ANIM_STATE_ANY="ANY",e.ANIM_STATE_END="END",e.ANIM_STATE_START=px,e.ASPECT_AUTO=0,e.ASPECT_MANUAL=1,e.ASSET_ANIMATION="animation",e.ASSET_AUDIO="audio",e.ASSET_CONTAINER="container",e.ASSET_CSS="css",e.ASSET_CUBEMAP="cubemap",e.ASSET_HTML="html",e.ASSET_IMAGE="image",e.ASSET_JSON="json",e.ASSET_MATERIAL="material",e.ASSET_MODEL="model",e.ASSET_SCRIPT="script",e.ASSET_SHADER="shader",e.ASSET_TEXT="text",e.ASSET_TEXTURE="texture",e.ASSET_TEXTUREATLAS="textureatlas",e.AXIS_KEY="key",e.AXIS_MOUSE_X="mousex",e.AXIS_MOUSE_Y="mousey",e.AXIS_PAD_L_X="padlx",e.AXIS_PAD_L_Y="padly",e.AXIS_PAD_R_X="padrx",e.AXIS_PAD_R_Y="padry",e.AnimBinder=pI,e.AnimClip=ps,e.AnimClipHandler=vk,e.AnimComponent=p2,e.AnimComponentLayer=p$,e.AnimComponentSystem=p5,e.AnimController=pY,e.AnimCurve=gP,e.AnimData=gM,e.AnimEvaluator=pC,e.AnimEvents=pP,e.AnimSnapshot=pe,e.AnimStateGraph=p0,e.AnimStateGraphHandler=vz,e.AnimTarget=pR,e.AnimTrack=pM,e.Animation=d3,e.AnimationComponent=pD,e.AnimationComponentSystem=pN,e.AnimationHandler=vU,e.AppBase=uY,e.AppOptions=uK,e.Application=class extends uY{createDevice(e,t){return t.graphicsDeviceOptions||(t.graphicsDeviceOptions={}),k.browser&&navigator.xr&&(t.graphicsDeviceOptions.xrCompatible=true),t.graphicsDeviceOptions.alpha=t.graphicsDeviceOptions.alpha||false,new nB(e,t.graphicsDeviceOptions)}addComponentSystems(e){e.componentSystems=[_o,fB,mv,pN,p5,mH,m5,_5,ge,gg,_U,p7,mQ,_f,mh,ff,_P,_L,_K,mN,mT,_$,gT];}addResourceHandles(e){e.resourceHandlers=[gC,vU,vk,vz,yD,yP,SS,yq,yb,vH,yV,yO,vK,yT,vq,yG,yx,vZ,v$,vW,yJ,yX,yj,vj,y_];}constructor(e,t={}){var s;super(e);let i=new uK;i.graphicsDevice=null!=(s=t.graphicsDevice)?s:this.createDevice(e,t),this.addComponentSystems(i),this.addResourceHandles(i),i.elementInput=t.elementInput,i.keyboard=t.keyboard,i.mouse=t.mouse,i.touch=t.touch,i.gamepads=t.gamepads,i.scriptPrefix=t.scriptPrefix,i.assetPrefix=t.assetPrefix,i.scriptsOrder=t.scriptsOrder,i.soundManager=new rU,i.lightmapper=u6,i.batchManager=a6,i.xr=xs,this.init(i);}},e.Asset=ub,e.AssetListLoader=class extends Y{destroy(){this._registry.off("load",this._onLoad),this._registry.off("error",this._onError),this._waitingAssets.forEach(e=>{this._registry.off("add:"+e,this._onAddAsset);}),this.off("progress"),this.off("load");}_assetHasDependencies(e){var t;return "model"===e.type&&(null==(t=e.file)?void 0:t.url)&&e.file.url&&e.file.url.match(/.json$/g)}load(e,t){if(this._loading)return;this._loading=true,this._callback=e,this._scope=t,this._registry.on("load",this._onLoad,this),this._registry.on("error",this._onError,this);let s=false;this._assets.forEach(e=>{e.loaded||(s=true,this._assetHasDependencies(e)&&this._registry.loadFromUrl(e.file.url,e.type,(t,s)=>{if(t){this._onError(t,e);return}this._onLoad(e);}),this._loadingAssets.add(e),this._registry.add(e));}),this._loadingAssets.forEach(e=>{this._assetHasDependencies(e)||this._registry.load(e);}),s||0!==this._waitingAssets.size||this._loadingComplete();}ready(e,t){ void 0===t&&(t=this),this._loaded?e.call(t,Array.from(this._assets)):this.once("load",s=>{e.call(t,s);});}_loadingComplete(){this._loaded||(this._loaded=true,this._registry.off("load",this._onLoad,this),this._registry.off("error",this._onError,this),this._failed.length?(this._callback&&this._callback.call(this._scope,"Failed to load some assets",this._failed),this.fire("error",this._failed)):(this._callback&&this._callback.call(this._scope),this.fire("load",Array.from(this._assets))));}_onLoad(e){this._loadingAssets.has(e)&&(this.fire("progress",e),this._loadingAssets.delete(e)),0===this._loadingAssets.size&&setTimeout(()=>{this._loadingComplete();},0);}_onError(e,t){this._loadingAssets.has(t)&&(this._failed.push(t),this._loadingAssets.delete(t)),0===this._loadingAssets.size&&setTimeout(()=>{this._loadingComplete();},0);}_onAddAsset(e){this._waitingAssets.delete(e),this._assets.add(e),e.loaded||(this._loadingAssets.add(e),this._registry.load(e));}_waitForAsset(e){this._waitingAssets.add(e),this._registry.once("add:"+e,this._onAddAsset,this);}constructor(e,t){super(),this._assets=new Set,this._loadingAssets=new Set,this._waitingAssets=new Set,this._loading=false,this._loaded=false,this._failed=[],this._registry=t,e.forEach(e=>{if(e instanceof ub)e.registry||(e.registry=t),this._assets.add(e);else {let s=t.get(e);s?this._assets.add(s):this._waitForAsset(e);}});}},e.AssetReference=m0,e.AssetRegistry=uA,e.AudioHandler=vH,e.AudioListenerComponent=p6,e.AudioListenerComponentSystem=p7,e.BAKE_COLOR=0,e.BAKE_COLORDIR=1,e.BINDGROUP_MESH=1,e.BINDGROUP_MESH_UB=2,e.BINDGROUP_VIEW=0,e.BLENDEQUATION_ADD=0,e.BLENDEQUATION_MAX=4,e.BLENDEQUATION_MIN=3,e.BLENDEQUATION_REVERSE_SUBTRACT=2,e.BLENDEQUATION_SUBTRACT=1,e.BLENDMODE_CONSTANT=11,e.BLENDMODE_CONSTANT_ALPHA=11,e.BLENDMODE_CONSTANT_COLOR=11,e.BLENDMODE_DST_ALPHA=9,e.BLENDMODE_DST_COLOR=4,e.BLENDMODE_ONE=1,e.BLENDMODE_ONE_MINUS_CONSTANT=12,e.BLENDMODE_ONE_MINUS_CONSTANT_ALPHA=12,e.BLENDMODE_ONE_MINUS_CONSTANT_COLOR=12,e.BLENDMODE_ONE_MINUS_DST_ALPHA=10,e.BLENDMODE_ONE_MINUS_DST_COLOR=5,e.BLENDMODE_ONE_MINUS_SRC_ALPHA=8,e.BLENDMODE_ONE_MINUS_SRC_COLOR=3,e.BLENDMODE_SRC_ALPHA=6,e.BLENDMODE_SRC_ALPHA_SATURATE=7,e.BLENDMODE_SRC_COLOR=2,e.BLENDMODE_ZERO=0,e.BLEND_ADDITIVE=1,e.BLEND_ADDITIVEALPHA=6,e.BLEND_MAX=10,e.BLEND_MIN=9,e.BLEND_MULTIPLICATIVE=5,e.BLEND_MULTIPLICATIVE2X=7,e.BLEND_NONE=3,e.BLEND_NORMAL=2,e.BLEND_PREMULTIPLIED=4,e.BLEND_SCREEN=8,e.BLEND_SUBTRACTIVE=0,e.BLUR_BOX=0,e.BLUR_GAUSSIAN=1,e.BODYFLAG_KINEMATIC_OBJECT=2,e.BODYFLAG_NORESPONSE_OBJECT=4,e.BODYFLAG_STATIC_OBJECT=1,e.BODYGROUP_DEFAULT=1,e.BODYGROUP_DYNAMIC=1,e.BODYGROUP_ENGINE_1=8,e.BODYGROUP_ENGINE_2=32,e.BODYGROUP_ENGINE_3=64,e.BODYGROUP_KINEMATIC=4,e.BODYGROUP_NONE=0,e.BODYGROUP_STATIC=2,e.BODYGROUP_TRIGGER=16,e.BODYGROUP_USER_1=128,e.BODYGROUP_USER_2=256,e.BODYGROUP_USER_3=512,e.BODYGROUP_USER_4=1024,e.BODYGROUP_USER_5=2048,e.BODYGROUP_USER_6=4096,e.BODYGROUP_USER_7=8192,e.BODYGROUP_USER_8=16384,e.BODYMASK_ALL=65535,e.BODYMASK_NONE=0,e.BODYMASK_NOT_STATIC=65533,e.BODYMASK_NOT_STATIC_KINEMATIC=65529,e.BODYMASK_STATIC=2,e.BODYSTATE_ACTIVE_TAG=1,e.BODYSTATE_DISABLE_DEACTIVATION=4,e.BODYSTATE_DISABLE_SIMULATION=5,e.BODYSTATE_ISLAND_SLEEPING=2,e.BODYSTATE_WANTS_DEACTIVATION=3,e.BODYTYPE_DYNAMIC=fS,e.BODYTYPE_KINEMATIC=fx,e.BODYTYPE_STATIC=fy,e.BUFFERUSAGE_COPY_DST=8,e.BUFFERUSAGE_COPY_SRC=4,e.BUFFERUSAGE_INDEX=16,e.BUFFERUSAGE_INDIRECT=256,e.BUFFERUSAGE_READ=1,e.BUFFERUSAGE_STORAGE=128,e.BUFFERUSAGE_UNIFORM=64,e.BUFFERUSAGE_VERTEX=32,e.BUFFERUSAGE_WRITE=2,e.BUFFER_DYNAMIC=1,e.BUFFER_GPUDYNAMIC=3,e.BUFFER_STATIC=0,e.BUFFER_STREAM=2,e.BUTTON_TRANSITION_MODE_SPRITE_CHANGE=1,e.BUTTON_TRANSITION_MODE_TINT=0,e.Batch=aO,e.BatchGroup=aF,e.BatchManager=a6,e.BinaryHandler=vW,e.BindGroupFormat=t6,e.BindStorageBufferFormat=t3,e.BindStorageTextureFormat=t5,e.BindTextureFormat=t4,e.BindUniformBufferFormat=t2,e.BlendState=sh,e.BoundingBox=eP,e.BoundingSphere=eR,e.BoxGeometry=dr,e.Bundle=uP,e.BundleHandler=uR,e.BundleRegistry=uw,e.ButtonComponent=fd,e.ButtonComponentSystem=ff,e.CHUNKAPI_1_51="1.51",e.CHUNKAPI_1_55="1.55",e.CHUNKAPI_1_56="1.56",e.CHUNKAPI_1_57="1.57",e.CHUNKAPI_1_58="1.58",e.CHUNKAPI_1_60="1.60",e.CHUNKAPI_1_62="1.62",e.CHUNKAPI_1_65=t$,e.CHUNKAPI_1_70="1.70",e.CHUNKAPI_2_1="2.1",e.CHUNKAPI_2_3="2.3",e.CHUNKAPI_2_5="2.5",e.CHUNKAPI_2_6="2.6",e.CHUNKAPI_2_7="2.7",e.CLEARFLAG_COLOR=1,e.CLEARFLAG_DEPTH=2,e.CLEARFLAG_STENCIL=4,e.CUBEFACE_NEGX=1,e.CUBEFACE_NEGY=3,e.CUBEFACE_NEGZ=5,e.CUBEFACE_POSX=0,e.CUBEFACE_POSY=2,e.CUBEFACE_POSZ=4,e.CUBEPROJ_BOX=1,e.CUBEPROJ_NONE=0,e.CULLFACE_BACK=1,e.CULLFACE_FRONT=2,e.CULLFACE_FRONTANDBACK=3,e.CULLFACE_NONE=0,e.CURVE_LINEAR=0,e.CURVE_SMOOTHSTEP=1,e.CURVE_SPLINE=4,e.CURVE_STEP=5,e.Camera=oo,e.CameraComponent=_2,e.CameraComponentSystem=_5,e.CameraFrame=class{destroy(){this.disable();}enable(){this.renderPassCamera=this.createRenderPass(),this.cameraComponent.renderPasses=[this.renderPassCamera];}disable(){var e;let t=this.cameraComponent;null==(e=t.renderPasses)||e.forEach(e=>{e.destroy();}),t.renderPasses=[],t.rendering=null,t.jitter=0,t.shaderParams.ssaoEnabled=false,this.renderPassCamera=null;}createRenderPass(){return new bo(this.app,this.cameraComponent,this.options)}set enabled(e){this._enabled!==e&&(e?this.enable():this.disable(),this._enabled=e);}get enabled(){return this._enabled}updateOptions(){let{options:e,rendering:t,bloom:s,taa:i,ssao:n}=this;e.stencil=t.stencil,e.samples=t.samples,e.sceneColorMap=t.sceneColorMap,e.prepassEnabled=t.sceneDepthMap,e.bloomEnabled=s.intensity>0,e.taaEnabled=i.enabled,e.ssaoType=n.type,e.ssaoBlurEnabled=n.blurEnabled,e.formats=t.renderFormats.slice(),e.dofEnabled=this.dof.enabled,e.dofNearBlur=this.dof.nearBlur,e.dofHighQuality=this.dof.highQuality;}update(){if(!this._enabled)return;let e=this.cameraComponent,{options:t,renderPassCamera:s,rendering:i,bloom:n,grading:r,vignette:a,fringing:o,taa:l,ssao:h}=this;this.updateOptions(),s.update(t);let{composePass:d,bloomPass:c,ssaoPass:u,dofPass:p}=s;s.renderTargetScale=ei.clamp(i.renderTargetScale,.1,1),d.toneMapping=i.toneMapping,d.sharpness=i.sharpness,t.bloomEnabled&&c&&(d.bloomIntensity=n.intensity,c.blurLevel=n.blurLevel),t.dofEnabled&&(p.focusDistance=this.dof.focusDistance,p.focusRange=this.dof.focusRange,p.blurRadius=this.dof.blurRadius,p.blurRings=this.dof.blurRings,p.blurRingPoints=this.dof.blurRingPoints),t.ssaoType!==T0&&(u.intensity=h.intensity,u.power=h.power,u.radius=h.radius,u.sampleCount=h.samples,u.minAngle=h.minAngle,u.scale=h.scale,u.randomize=h.randomize),d.gradingEnabled=r.enabled,r.enabled&&(d.gradingSaturation=r.saturation,d.gradingBrightness=r.brightness,d.gradingContrast=r.contrast,d.gradingTint=r.tint),d.vignetteEnabled=a.intensity>0,d.vignetteEnabled&&(d.vignetteInner=a.inner,d.vignetteOuter=a.outer,d.vignetteCurvature=a.curvature,d.vignetteIntensity=a.intensity),d.fringingEnabled=o.intensity>0,d.fringingEnabled&&(d.fringingIntensity=o.intensity),e.jitter=l.enabled?l.jitter:0,d.debug=this.debug,"ssao"===d.debug&&t.ssaoType===T0&&(d.debug=null),"vignette"!==d.debug||d.vignetteEnabled||(d.debug=null);}constructor(e,t){this._enabled=true,this.rendering={renderFormats:[18,12,14],stencil:false,renderTargetScale:1,samples:1,sceneColorMap:false,sceneDepthMap:false,toneMapping:0,sharpness:0},this.ssao={type:T0,blurEnabled:true,randomize:false,intensity:.5,radius:30,samples:12,power:6,minAngle:10,scale:1},this.bloom={intensity:0,blurLevel:16},this.grading={enabled:false,brightness:1,contrast:1,saturation:1,tint:new en(1,1,1,1)},this.vignette={intensity:0,inner:.5,outer:1,curvature:.5},this.taa={enabled:false,jitter:1},this.fringing={intensity:0},this.dof={enabled:false,nearBlur:false,focusDistance:100,focusRange:10,blurRadius:3,blurRings:4,blurRingPoints:5,highQuality:true},this.debug=null,this.options=new br,this.renderPassCamera=null,this.app=e,this.cameraComponent=t,this.updateOptions(),this.enable();}},e.CameraFrameOptions=br,e.CameraShaderParams=ot,e.CanvasFont=class extends Y{createTextures(e){let t=this._normalizeCharsSet(e);if(t.length!==this.chars.length){this._renderAtlas(t);return}for(let e=0;e<t.length;e++)if(t[e]!==this.chars[e]){this._renderAtlas(t);return}}updateTextures(e){let t=this._normalizeCharsSet(e),s=[];for(let e=0;e<t.length;e++){let i=t[e];this.data.chars[i]||s.push(i);}s.length>0&&this._renderAtlas(this.chars.concat(s));}destroy(){this.atlases.forEach(e=>e.destroy()),this.chars=null,this.color=null,this.data=null,this.fontName=null,this.fontSize=null,this.glyphSize=null,this.intensity=null,this.atlases=null,this.type=null,this.fontWeight=null;}_colorToRgbString(e,t){let i=Math.round(255*e.r),n=Math.round(255*e.g),r=Math.round(255*e.b);return t?"rgba("+i+", "+n+", "+r+", "+e.a+")":"rgb("+i+", "+n+", "+r+")"}renderCharacter(e,t,s,i,n){e.fillStyle=n,e.fillText(t,s,i);}_getAtlas(e){return e>=this.atlases.length&&(this.atlases[e]=new xi(this.app.graphicsDevice,this.width,this.height,"font-atlas-"+this.fontName+"-"+e)),this.atlases[e]}_renderAtlas(e){this.chars=e;let t=this.width,s=this.height,i=this._colorToRgbString(this.color,false),n=this.color.a;this.color.a=1/255;let r=this._colorToRgbString(this.color,true);this.color.a=n;let a=0,o=this._getAtlas(a++);o.clear(r),this.data=this._createJson(this.chars,this.fontName,t,s);let l=W.getSymbols(this.chars.join("")),h=0,d=0,c={};for(let e=0;e<l.length;e++){let t=l[e];c[t]=this._getTextMetrics(t),h=Math.max(h,c[t].height),d=Math.max(d,c[t].descent);}this.glyphSize=Math.max(this.glyphSize,h);let u=this.glyphSize+2*this.padding,p=this.glyphSize+2*this.padding,f=this.glyphSize/2+this.padding,m=p-d-this.padding,_=0,g=0;for(let e=0;e<l.length;e++){let n=l[e],h=W.getCodePoint(l[e]),v=this.fontSize;o.ctx.font=this.fontWeight+" "+v.toString()+"px "+this.fontName,o.ctx.textAlign="center",o.ctx.textBaseline="alphabetic";let y=o.ctx.measureText(n).width;y>v&&(v=this.fontSize*this.fontSize/y,o.ctx.font=this.fontWeight+" "+v.toString()+"px "+this.fontName,y=this.fontSize),this.renderCharacter(o.ctx,n,_+f,g+m,i);let S=this.padding+(this.glyphSize-y)/2,x=-this.padding+c[n].descent-d,T=y;this._addChar(this.data,n,h,_,g,u,p,S,x,T,a-1,t,s),(_+=u)+u>t&&(_=0,(g+=p)+p>s&&((o=this._getAtlas(a++)).clear(r),g=0));}this.atlases.splice(a).forEach(e=>e.destroy()),this.atlases.forEach(e=>e.texture.upload()),this.fire("render");}_createJson(e,t,s,i){return {version:3,intensity:this.intensity,info:{face:t,width:s,height:i,maps:[{width:s,height:i}]},chars:{}}}_addChar(e,t,s,i,n,r,a,o,l,h,d,c,u){e.info.maps.length<d+1&&e.info.maps.push({width:c,height:u});let p=this.fontSize/32;e.chars[t]={id:s,letter:t,x:i,y:n,width:r,height:a,xadvance:h/p,xoffset:o/p,yoffset:(l+this.padding)/p,scale:p,range:1,map:d,bounds:[0,0,r/p,a/p]};}_normalizeCharsSet(e){let t=this.app.systems.element.getUnicodeConverter();t&&(e=t(e));let s={},i=W.getSymbols(e);for(let e=0;e<i.length;e++){let t=i[e];s[t]||(s[t]=t);}return Object.keys(s).sort()}_getTextMetrics(e){let t=document.createElement("span");t.id="content-span",t.innerHTML=e;let s=document.createElement("div");s.id="content-block",s.style.display="inline-block",s.style.width="1px",s.style.height="0px";let i=document.createElement("div");i.appendChild(t),i.appendChild(s),i.style.font=this.fontSize+"px "+this.fontName,document.body.appendChild(i);let n=-1,r=-1,a=-1;try{s.style["vertical-align"]="baseline",n=s.offsetTop-t.offsetTop,s.style["vertical-align"]="bottom",r=(a=s.offsetTop-t.offsetTop)-n;}finally{document.body.removeChild(i);}return {ascent:n,descent:r,height:a}}get textures(){return this.atlases.map(e=>e.texture)}constructor(e,t={}){super(),this.type="bitmap",this.app=e,this.intensity=0,this.fontWeight=t.fontWeight||"normal",this.fontSize=parseInt(t.fontSize,10),this.glyphSize=this.fontSize,this.fontName=t.fontName||"Arial",this.color=t.color||new en(1,1,1),this.padding=t.padding||0,this.width=Math.min(4096,t.width||512),this.height=Math.min(4096,t.height||512),this.atlases=[],this.chars="",this.data={};}},e.CapsuleGeometry=cz,e.ChunkUtils=dt,e.CollisionComponent=fg,e.CollisionComponentSystem=fB,e.Color=en,e.Component=u8,e.ComponentSystem=u9,e.ComponentSystemRegistry=uC,e.Compute=class{setParameter(e,t){let s=this.parameters.get(e);s||((s=new nW).scopeId=this.device.scope.resolve(e),this.parameters.set(e,s)),s.value=t;}getParameter(e){var t;return null==(t=this.parameters.get(e))?void 0:t.value}deleteParameter(e){this.parameters.delete(e);}applyParameters(){for(let[,e]of this.parameters)e.scopeId.setValue(e.value);}setupDispatch(e,t,s){this.countX=e,this.countY=t,this.countZ=s;}constructor(e,t,s="Unnamed"){this.shader=null,this.parameters=new Map,this.countX=1,this.device=e,this.shader=t,this.name=s,e.supportsCompute&&(this.impl=e.createComputeImpl(this));}},e.ConeGeometry=cV,e.ContactPoint=_n,e.ContactResult=_r,e.ContainerHandler=vj,e.ContainerResource=class{instantiateModelEntity(e){return null}instantiateRenderEntity(e){return null}getMaterialVariants(){return null}applyMaterialVariant(e,t){}applyMaterialVariantInstances(e,t){}},e.Controller=class{attach(e){this._element=e,this._keyboard&&this._keyboard.attach(e),this._mouse&&this._mouse.attach(e);}detach(){this._keyboard&&this._keyboard.detach(),this._mouse&&this._mouse.detach(),this._element=null;}disableContextMenu(){this._mouse||this._enableMouse(),this._mouse.disableContextMenu();}enableContextMenu(){this._mouse||this._enableMouse(),this._mouse.enableContextMenu();}update(e){for(let e in this._keyboard&&this._keyboard.update(),this._mouse&&this._mouse.update(),this._gamepads&&this._gamepads.update(),this._axesValues={},this._axes)this._axesValues[e]=[];}appendAction(e,t){this._actions[e]=this._actions[e]||[],this._actions[e].push(t);}registerKeys(e,t){if(this._keyboard||this._enableKeyboard(),this._actions[e])throw Error("Action: "+e+" already registered");if(void 0===t)throw Error("Invalid button");t.length||(t=[t]),this.appendAction(e,{type:rs,keys:t});}registerMouse(e,t){if(this._mouse||this._enableMouse(),void 0===t)throw Error("Invalid button");this.appendAction(e,{type:rt,button:t});}registerPadButton(e,t,s){if(void 0===s)throw Error("Invalid button");this.appendAction(e,{type:ri,button:s,pad:t});}registerAxis(e){let t=e.name;this._axes[t]||(this._axes[t]=[]);let s=this._axes[t].push(t);(e=e||{}).pad=e.pad||0;let i=function(i,n,r,a){switch(n){case "mousex":i._mouse.on("mousemove",e=>{i._axesValues[t][s]=e.dx/10;});break;case "mousey":i._mouse.on("mousemove",e=>{i._axesValues[t][s]=e.dy/10;});break;case "key":i._axes[t].push(()=>i._keyboard.isPressed(a)?r:0);break;case "padrx":i._axes[t].push(()=>i._gamepads.getAxis(e.pad,2));break;case "padry":i._axes[t].push(()=>i._gamepads.getAxis(e.pad,3));break;case "padlx":i._axes[t].push(()=>i._gamepads.getAxis(e.pad,0));break;case "padly":i._axes[t].push(()=>i._gamepads.getAxis(e.pad,1));break;default:throw Error("Unknown axis")}};i(this,e.positive,1,e.positiveKey),(e.negativeKey||e.negative!==e.positive)&&i(this,e.negative,-1,e.negativeKey);}isPressed(e){if(!this._actions[e])return  false;let t=this._actions[e].length;for(let s=0;s<t;++s){let t=this._actions[e][s];switch(t.type){case rs:if(this._keyboard){let e=t.keys.length;for(let s=0;s<e;s++)if(this._keyboard.isPressed(t.keys[s]))return  true}break;case rt:if(this._mouse&&this._mouse.isPressed(t.button))return  true;break;case ri:if(this._gamepads&&this._gamepads.isPressed(t.pad,t.button))return  true}}return  false}wasPressed(e){if(!this._actions[e])return  false;let t=this._actions[e].length;for(let s=0;s<t;++s){let t=this._actions[e][s];switch(t.type){case rs:if(this._keyboard){let e=t.keys.length;for(let s=0;s<e;s++)if(this._keyboard.wasPressed(t.keys[s]))return  true}break;case rt:if(this._mouse&&this._mouse.wasPressed(t.button))return  true;break;case ri:if(this._gamepads&&this._gamepads.wasPressed(t.pad,t.button))return  true}}return  false}getAxis(e){let t=0;if(this._axes[e]){let s=this._axes[e].length;for(let i=0;i<s;i++)if("function"==typeof this._axes[e][i]){let s=this._axes[e][i]();Math.abs(s)>Math.abs(t)&&(t=s);}else this._axesValues[e]&&Math.abs(this._axesValues[e][i])>Math.abs(t)&&(t=this._axesValues[e][i]);}return t}_enableMouse(){if(this._mouse=new ru,!this._element)throw Error("Controller must be attached to an Element");this._mouse.attach(this._element);}_enableKeyboard(){if(this._keyboard=new rh,!this._element)throw Error("Controller must be attached to an Element");this._keyboard.attach(this._element);}constructor(e,t={}){this._element=null,this._actions={},this._axes={},this._axesValues={},this._keyboard=t.keyboard||null,this._mouse=t.mouse||null,this._gamepads=t.gamepads||null,e&&this.attach(e);}},e.CssHandler=vq,e.CubemapHandler=vK,e.Curve=ea,e.CurveSet=eo,e.CylinderGeometry=cG,e.DETAILMODE_ADD="add",e.DETAILMODE_MAX="max",e.DETAILMODE_MIN="min",e.DETAILMODE_MUL="mul",e.DETAILMODE_OVERLAY="overlay",e.DETAILMODE_SCREEN="screen",e.DEVICETYPE_NULL=tH,e.DEVICETYPE_WEBGL2=tV,e.DEVICETYPE_WEBGPU=tG,e.DISPLAYFORMAT_HDR="hdr",e.DISPLAYFORMAT_LDR="ldr",e.DISPLAYFORMAT_LDR_SRGB=tW,e.DISTANCE_EXPONENTIAL=ej,e.DISTANCE_INVERSE=eY,e.DISTANCE_LINEAR=eX,e.DITHER_BAYER8=an,e.DITHER_BLUENOISE=ar,e.DITHER_IGNNOISE=aa,e.DITHER_NONE=ai,e.DefaultAnimBinder=pL,e.DepthState=su,e.DomeGeometry=dl,e.ELEMENTTYPE_GROUP=fe,e.ELEMENTTYPE_IMAGE=ft,e.ELEMENTTYPE_TEXT=fs,e.EMITTERSHAPE_BOX=0,e.EMITTERSHAPE_SPHERE=1,e.EVENT_GAMEPADCONNECTED="gamepadconnected",e.EVENT_GAMEPADDISCONNECTED="gamepaddisconnected",e.EVENT_KEYDOWN="keydown",e.EVENT_KEYUP="keyup",e.EVENT_MOUSEDOWN="mousedown",e.EVENT_MOUSEMOVE="mousemove",e.EVENT_MOUSEUP="mouseup",e.EVENT_MOUSEWHEEL="mousewheel",e.EVENT_POSTCULL=ap,e.EVENT_POSTRENDER=ah,e.EVENT_POSTRENDER_LAYER=ac,e.EVENT_PRECULL=au,e.EVENT_PRERENDER=al,e.EVENT_PRERENDER_LAYER=ad,e.EVENT_SELECT="select",e.EVENT_SELECTEND="selectend",e.EVENT_SELECTSTART="selectstart",e.EVENT_TOUCHCANCEL="touchcancel",e.EVENT_TOUCHEND="touchend",e.EVENT_TOUCHMOVE="touchmove",e.EVENT_TOUCHSTART="touchstart",e.ElementComponent=ma,e.ElementComponentSystem=mh,e.ElementDragHelper=_b,e.ElementInput=xz,e.ElementInputEvent=xN,e.ElementMouseEvent=xB,e.ElementSelectEvent=xk,e.ElementTouchEvent=xU,e.Entity=uG,e.EnvLighting=dj,e.EventHandle=X,e.EventHandler=Y,e.FILLMODE_FILL_WINDOW=ut,e.FILLMODE_KEEP_ASPECT=us,e.FILLMODE_NONE="NONE",e.FILTER_LINEAR=1,e.FILTER_LINEAR_MIPMAP_LINEAR=5,e.FILTER_LINEAR_MIPMAP_NEAREST=4,e.FILTER_NEAREST=0,e.FILTER_NEAREST_MIPMAP_LINEAR=3,e.FILTER_NEAREST_MIPMAP_NEAREST=2,e.FITMODE_CONTAIN=fn,e.FITMODE_COVER=fr,e.FITMODE_STRETCH=fi,e.FITTING_BOTH=3,e.FITTING_NONE=0,e.FITTING_SHRINK=2,e.FITTING_STRETCH=1,e.FOG_EXP="exp",e.FOG_EXP2="exp2",e.FOG_LINEAR=rW,e.FOG_NONE=rH,e.FONT_BITMAP=fW,e.FONT_MSDF=fH,e.FRESNEL_NONE=0,e.FRESNEL_SCHLICK=2,e.FUNC_ALWAYS=7,e.FUNC_EQUAL=2,e.FUNC_GREATER=4,e.FUNC_GREATEREQUAL=6,e.FUNC_LESS=1,e.FUNC_LESSEQUAL=3,e.FUNC_NEVER=0,e.FUNC_NOTEQUAL=5,e.FloatPacking=ed,e.FogParams=dq,e.FolderHandler=vZ,e.Font=vQ,e.FontHandler=v$,e.ForwardRenderer=lZ,e.Frustum=eD,e.GAMMA_NONE=0,e.GAMMA_SRGB=1,e.GIZMOAXIS_FACE=bd,e.GIZMOAXIS_X="x",e.GIZMOAXIS_XY="xy",e.GIZMOAXIS_XYZ="xyz",e.GIZMOAXIS_XZ="xz",e.GIZMOAXIS_Y="y",e.GIZMOAXIS_YZ="yz",e.GIZMOAXIS_Z="z",e.GIZMOSPACE_LOCAL=bl,e.GIZMOSPACE_WORLD=bh,e.GSplat=c3,e.GSplatComponent=gv,e.GSplatComponentSystem=gT,e.GSplatData=c0,e.GSplatHandler=y_,e.GSplatInstance=ue,e.GSplatResource=v6,e.GamePads=rA,e.Geometry=dn,e.Gizmo=b_,e.GltfExporter=T$,e.GraphNode=oE,e.GraphicsDevice=sM,e.HierarchyHandler=yx,e.HtmlHandler=yT,e.Http=rI,e.I18n=uO,e.INDEXFORMAT_UINT16=1,e.INDEXFORMAT_UINT32=2,e.INDEXFORMAT_UINT8=0,e.INTERPOLATION_CUBIC=2,e.INTERPOLATION_LINEAR=1,e.INTERPOLATION_STEP=0,e.ImageElement=fV,e.IndexBuffer=nY,e.IndexedList=j,e.JointComponent=mf,e.JointComponentSystem=mv,e.JsonHandler=yb,e.JsonStandardMaterialParser=yw,e.KEY_0=48,e.KEY_1=49,e.KEY_2=50,e.KEY_3=51,e.KEY_4=52,e.KEY_5=53,e.KEY_6=54,e.KEY_7=55,e.KEY_8=56,e.KEY_9=57,e.KEY_A=65,e.KEY_ADD=107,e.KEY_ALT=18,e.KEY_B=66,e.KEY_BACKSPACE=8,e.KEY_BACK_SLASH=220,e.KEY_C=67,e.KEY_CAPS_LOCK=20,e.KEY_CLOSE_BRACKET=221,e.KEY_COMMA=188,e.KEY_CONTEXT_MENU=93,e.KEY_CONTROL=17,e.KEY_D=68,e.KEY_DECIMAL=110,e.KEY_DELETE=46,e.KEY_DIVIDE=111,e.KEY_DOWN=40,e.KEY_E=69,e.KEY_END=35,e.KEY_ENTER=13,e.KEY_EQUAL=61,e.KEY_ESCAPE=27,e.KEY_F=70,e.KEY_F1=112,e.KEY_F10=121,e.KEY_F11=122,e.KEY_F12=123,e.KEY_F2=113,e.KEY_F3=114,e.KEY_F4=115,e.KEY_F5=116,e.KEY_F6=117,e.KEY_F7=118,e.KEY_F8=119,e.KEY_F9=120,e.KEY_G=71,e.KEY_H=72,e.KEY_HOME=36,e.KEY_I=73,e.KEY_INSERT=45,e.KEY_J=74,e.KEY_K=75,e.KEY_L=76,e.KEY_LEFT=37,e.KEY_M=77,e.KEY_META=224,e.KEY_MULTIPLY=106,e.KEY_N=78,e.KEY_NUMPAD_0=96,e.KEY_NUMPAD_1=97,e.KEY_NUMPAD_2=98,e.KEY_NUMPAD_3=99,e.KEY_NUMPAD_4=100,e.KEY_NUMPAD_5=101,e.KEY_NUMPAD_6=102,e.KEY_NUMPAD_7=103,e.KEY_NUMPAD_8=104,e.KEY_NUMPAD_9=105,e.KEY_O=79,e.KEY_OPEN_BRACKET=219,e.KEY_P=80,e.KEY_PAGE_DOWN=34,e.KEY_PAGE_UP=33,e.KEY_PAUSE=19,e.KEY_PERIOD=190,e.KEY_PRINT_SCREEN=44,e.KEY_Q=81,e.KEY_R=82,e.KEY_RETURN=13,e.KEY_RIGHT=39,e.KEY_S=83,e.KEY_SEMICOLON=59,e.KEY_SEPARATOR=108,e.KEY_SHIFT=16,e.KEY_SLASH=191,e.KEY_SPACE=32,e.KEY_SUBTRACT=109,e.KEY_T=84,e.KEY_TAB=9,e.KEY_U=85,e.KEY_UP=38,e.KEY_V=86,e.KEY_W=87,e.KEY_WINDOWS=91,e.KEY_X=88,e.KEY_Y=89,e.KEY_Z=90,e.Kernel=ec,e.Key=d1,e.Keyboard=rh,e.KeyboardEvent=rn,e.LAYERID_DEPTH=1,e.LAYERID_IMMEDIATE=3,e.LAYERID_SKYBOX=2,e.LAYERID_UI=4,e.LAYERID_WORLD=0,e.LAYER_GIZMO=1,e.LAYER_HUD=0,e.LAYER_WORLD=15,e.LIGHTFALLOFF_INVERSESQUARED=1,e.LIGHTFALLOFF_LINEAR=0,e.LIGHTSHAPE_DISK=2,e.LIGHTSHAPE_PUNCTUAL=0,e.LIGHTSHAPE_RECT=1,e.LIGHTSHAPE_SPHERE=3,e.LIGHTTYPE_COUNT=3,e.LIGHTTYPE_DIRECTIONAL=0,e.LIGHTTYPE_OMNI=1,e.LIGHTTYPE_POINT=1,e.LIGHTTYPE_SPOT=2,e.LIGHT_COLOR_DIVIDER=100,e.Layer=l2,e.LayerComposition=l5,e.LayoutCalculator=mI,e.LayoutChildComponent=my,e.LayoutChildComponentSystem=mT,e.LayoutGroupComponent=mD,e.LayoutGroupComponentSystem=mN,e.Light=hr,e.LightComponent=_9,e.LightComponentSystem=ge,e.LightingParams=ha,e.Lightmapper=u6,e.LitMaterial=class extends o8{getShaderVariant(e){cl.usedUvs=this.usedUvs.slice(),cl.shaderChunkGLSL=this.shaderChunkGLSL,cl.shaderChunkWGSL=this.shaderChunkWGSL,cl.defines=aA(this,e),ce.update(cl.litOptions,this,e.scene,e.cameraShaderParams,e.objDefs,e.pass,e.sortedLights);let t=new af(e.viewUniformFormat,e.viewBindGroupFormat,e.vertexFormat),s=ag(e.device);return s.register("lit",co),s.getProgram("lit",cl,t,this.userId)}constructor(...e){super(...e),this.usedUvs=[true],this.shaderChunkGLSL=null,this.shaderChunkWGSL=null,this.useLighting=true,this.useFog=true,this.useTonemap=true,this.useSkybox=true,this.ambientSH=null,this.pixelSnap=false,this.nineSlicedMode=null,this.twoSidedLighting=false,this.occludeDirect=false,this.occludeSpecular=1,this.occludeSpecularIntensity=1,this.opacityFadesSpecular=true,this.opacityDither=ai,this.opacityShadowDither=ai,this.shadowCatcher=false,this.ggxSpecular=false,this.fresnelModel=2,this.dynamicRefraction=false,this.hasAo=false,this.hasSpecular=false,this.hasSpecularityFactor=false,this.hasLighting=false,this.hasHeights=false,this.hasNormals=false,this.hasSheen=false,this.hasRefraction=false,this.hasIrridescence=false,this.hasMetalness=false,this.hasClearCoat=false,this.hasClearCoatNormals=false;}},e.LitOptions=d7,e.LitShaderOptions=d7,e.LocalizedAsset=fG,e.MASK_AFFECT_DYNAMIC=1,e.MASK_AFFECT_LIGHTMAPPED=2,e.MASK_BAKE=4,e.MOTION_FREE=md,e.MOTION_LIMITED=mc,e.MOTION_LOCKED=mu,e.MOUSEBUTTON_LEFT=0,e.MOUSEBUTTON_MIDDLE=1,e.MOUSEBUTTON_NONE=-1,e.MOUSEBUTTON_RIGHT=2,e.Mat3=ep,e.Mat4=ex,e.Material=o8,e.MaterialHandler=yP,e.Mesh=aG,e.MeshInstance=a0,e.MiniStats=x1,e.Model=hh,e.ModelComponent=mz,e.ModelComponentSystem=mH,e.ModelHandler=yD,e.Morph=hd,e.MorphInstance=hl,e.MorphTarget=hc,e.Mouse=ru,e.MouseEvent=rc,e.Node=d2,e.NullGraphicsDevice=nH,e.ORIENTATION_HORIZONTAL=0,e.ORIENTATION_VERTICAL=1,e.OrientedBox=class{set worldTransform(e){this._worldTransform.copy(e),this._modelTransform.copy(e).invert();}get worldTransform(){return this._worldTransform}intersectsRay(e,t){if(this._modelTransform.transformPoint(e.origin,eF.origin),this._modelTransform.transformVector(e.direction,eF.direction),t){let e=this._aabb._intersectsRay(eF,t);return eU.copy(this._modelTransform).invert().transformPoint(t,t),e}return this._aabb._fastIntersectsRay(eF)}containsPoint(e){return this._modelTransform.transformPoint(e,eN),this._aabb.containsPoint(eN)}intersectsBoundingSphere(e){return this._modelTransform.transformPoint(e.center,eB.center),eB.radius=e.radius,!!this._aabb.intersectsBoundingSphere(eB)}constructor(e=new ex,t){this.halfExtents=new eu(.5,.5,.5),t&&this.halfExtents.copy(t),this._modelTransform=e.clone().invert(),this._worldTransform=e.clone(),this._aabb=new eP(new eu,this.halfExtents);}},e.OutlineRenderer=class{destroy(){var e;this.whiteTex.destroy(),this.whiteTex=null,this.outlineCameraEntity.destroy(),this.outlineCameraEntity=null,this.rt.destroyTextureBuffers(),this.rt.destroy(),this.rt=null,this.tempRt.destroyTextureBuffers(),this.tempRt.destroy(),this.tempRt=null,this.app.scene.off("postrender",this.postRender),null==(e=this.quadRenderer)||e.destroy(),this.quadRenderer=null;}getMeshInstances(e,t){let s=[];return (t?e.findComponents("render"):e.render?[e.render]:[]).forEach(e=>{e.meshInstances&&s.push(...e.meshInstances);}),(t?e.findComponents("model"):e.model?[e.model]:[]).forEach(e=>{e.meshInstances&&s.push(...e.meshInstances);}),s}addEntity(e,t,s){ void 0===s&&(s=true);let i=this.getMeshInstances(e,s);i.forEach(e=>{if(e.material instanceof cP){let s=this.outlineShaderPass;e.material.onUpdateShader=e=>{if(e.pass===s){let t=new ch;return t.defines=e.defines,t.opacityMap=e.opacityMap,t.opacityMapUv=e.opacityMapUv,t.opacityMapChannel=e.opacityMapChannel,t.opacityMapTransform=e.opacityMapTransform,t.opacityVertexColor=e.opacityVertexColor,t.opacityVertexColorChannel=e.opacityVertexColorChannel,t.litOptions.vertexColors=e.litOptions.vertexColors,t.litOptions.alphaTest=e.litOptions.alphaTest,t.litOptions.skin=e.litOptions.skin,t.litOptions.batch=e.litOptions.batch,t.litOptions.useInstancing=e.litOptions.useInstancing,t.litOptions.useMorphPosition=e.litOptions.useMorphPosition,t.litOptions.useMorphNormal=e.litOptions.useMorphNormal,t.litOptions.useMorphTextureBasedInt=e.litOptions.useMorphTextureBasedInt,t}return e},x3.linear(t);let i=new Float32Array([x3.r,x3.g,x3.b]);e.setParameter("material_emissive",i,1<<this.outlineShaderPass),e.setParameter("texture_emissiveMap",this.whiteTex,1<<this.outlineShaderPass);}}),this.renderingLayer.addMeshInstances(i,true);}removeEntity(e,t){ void 0===t&&(t=true);let s=this.getMeshInstances(e,t);this.renderingLayer.removeMeshInstances(s),s.forEach(e=>{e.material instanceof cP&&(e.material.onUpdateShader=null,e.deleteParameter("material_emissive"));});}removeAllEntities(){this.renderingLayer.clearMeshInstances();}blendOutlines(){let e=this.app.graphicsDevice;e.scope.resolve("source").setValue(this.rt.colorBuffer),e.setDepthState(su.NODEPTH),e.setCullMode(0),e.setBlendState(this.blendState),this.quadRenderer.render();}onPostRender(){let e=this.app.graphicsDevice,t=e.scope.resolve("uOffset"),s=e.scope.resolve("source"),i=e.scope.resolve("uSrcMultiplier"),{rt:n,tempRt:r,shaderExtend:a}=this,{width:o,height:l}=n;x2[0]=1/o/2,x2[1]=0,t.setValue(x2),s.setValue(n.colorBuffer),i.setValue(0),aD(e,r,a),x2[0]=0,x2[1]=1/l/2,t.setValue(x2),s.setValue(r.colorBuffer),i.setValue(1),aD(e,n,a);}createRenderTarget(e,t,s,i){return new sR({colorBuffer:new se(this.app.graphicsDevice,{name:e,width:t,height:s,format:20,mipmaps:false,addressU:1,addressV:1,minFilter:5,magFilter:1}),depth:i,flipY:this.app.graphicsDevice.isWebGPU})}updateRenderTarget(e){var t,s,i,n;let r=null!=(i=null==(t=e.renderTarget)?void 0:t.width)?i:this.app.graphicsDevice.width,a=null!=(n=null==(s=e.renderTarget)?void 0:s.height)?n:this.app.graphicsDevice.height,o=this.outlineCameraEntity.camera;o.renderTarget&&o.renderTarget.width===r&&o.renderTarget.height===a||(this.rt.resize(r,a),this.tempRt.resize(r,a));}frameUpdate(e,t,s){let i=e.camera;this.updateRenderTarget(i);let n=this.app.scene.on("prerender:layer",(e,r,a)=>{i===e&&a===s&&r===t&&(this.blendOutlines(),n.off());});this.outlineCameraEntity.setLocalPosition(e.getPosition()),this.outlineCameraEntity.setLocalRotation(e.getRotation());let r=this.outlineCameraEntity.camera;r.projection=i.projection,r.horizontalFov=i.horizontalFov,r.fov=i.fov,r.orthoHeight=i.orthoHeight,r.nearClip=i.nearClip,r.farClip=i.farClip;}constructor(e,t,s=-1){this.app=e,this.renderingLayer=null!=t?t:e.scene.layers.getLayerByName("Immediate"),this.rt=this.createRenderTarget("OutlineTexture",1,1,true),this.outlineCameraEntity=new uG("OutlineCamera"),this.outlineCameraEntity.addComponent("camera",{layers:[this.renderingLayer.id],priority:s,clearColor:new en(0,0,0,0),renderTarget:this.rt}),this.outlineShaderPass=this.outlineCameraEntity.camera.setShaderPass("OutlineShaderPass"),this.postRender=e=>{this.outlineCameraEntity.camera===e&&this.onPostRender();},e.scene.on("postrender",this.postRender),this.app.root.addChild(this.outlineCameraEntity),this.tempRt=this.createRenderTarget("OutlineTempTexture",1,1,false),this.blendState=new sh(true,0,6,8);let i=this.app.graphicsDevice;this.shaderExtend=ab(i,am.fullscreenQuadVS,"\n	varying vec2 vUv0;\n	uniform vec2 uOffset;\n	uniform float uSrcMultiplier;\n	uniform sampler2D source;\n	void main(void)\n	{\n		vec4 pixel;\n		vec4 texel = texture2D(source, vUv0);\n		vec4 firstTexel = texel;\n		float diff = texel.a * uSrcMultiplier;\n		pixel = texture2D(source, vUv0 + uOffset * -2.0);\n		texel = max(texel, pixel);\n		diff = max(diff, length(firstTexel.rgb - pixel.rgb));\n		pixel = texture2D(source, vUv0 + uOffset * -1.0);\n		texel = max(texel, pixel);\n		diff = max(diff, length(firstTexel.rgb - pixel.rgb));\n		pixel = texture2D(source, vUv0 + uOffset * 1.0);\n		texel = max(texel, pixel);\n		diff = max(diff, length(firstTexel.rgb - pixel.rgb));\n		pixel = texture2D(source, vUv0 + uOffset * 2.0);\n		texel = max(texel, pixel);\n		diff = max(diff, length(firstTexel.rgb - pixel.rgb));\n	   gl_FragColor = vec4(texel.rgb, min(diff, 1.0));\n	}\n","OutlineExtendShader"),this.shaderBlend=ab(i,am.fullscreenQuadVS,am.outputTex2DPS,"OutlineBlendShader"),this.quadRenderer=new aI(this.shaderBlend),this.whiteTex=new se(i,{name:"OutlineWhiteTexture",width:1,height:1,format:20,mipmaps:false}),this.whiteTex.lock().set(new Uint8Array([255,255,255,255])),this.whiteTex.unlock();}},e.PAD_1=0,e.PAD_2=1,e.PAD_3=2,e.PAD_4=3,e.PAD_DOWN=13,e.PAD_FACE_1=0,e.PAD_FACE_2=1,e.PAD_FACE_3=2,e.PAD_FACE_4=3,e.PAD_LEFT=14,e.PAD_L_SHOULDER_1=4,e.PAD_L_SHOULDER_2=6,e.PAD_L_STICK_BUTTON=10,e.PAD_L_STICK_X=0,e.PAD_L_STICK_Y=1,e.PAD_RIGHT=15,e.PAD_R_SHOULDER_1=5,e.PAD_R_SHOULDER_2=7,e.PAD_R_STICK_BUTTON=11,e.PAD_R_STICK_X=2,e.PAD_R_STICK_Y=3,e.PAD_SELECT=8,e.PAD_START=9,e.PAD_UP=12,e.PAD_VENDOR=16,e.PARTICLEMODE_CPU=1,e.PARTICLEMODE_GPU=0,e.PARTICLEORIENTATION_EMITTER=2,e.PARTICLEORIENTATION_SCREEN=0,e.PARTICLEORIENTATION_WORLD=1,e.PARTICLESORT_DISTANCE=1,e.PARTICLESORT_NEWER_FIRST=2,e.PARTICLESORT_NONE=0,e.PARTICLESORT_OLDER_FIRST=3,e.PIXELFORMAT_111110F=18,e.PIXELFORMAT_A8=0,e.PIXELFORMAT_ASTC_4x4=28,e.PIXELFORMAT_ASTC_4x4_SRGB=63,e.PIXELFORMAT_ATC_RGB=29,e.PIXELFORMAT_ATC_RGBA=30,e.PIXELFORMAT_BC6F=65,e.PIXELFORMAT_BC6UF=66,e.PIXELFORMAT_BC7=67,e.PIXELFORMAT_BC7_SRGBA=68,e.PIXELFORMAT_BGRA8=31,e.PIXELFORMAT_DEPTH=16,e.PIXELFORMAT_DEPTH16=69,e.PIXELFORMAT_DEPTHSTENCIL=17,e.PIXELFORMAT_DXT1=8,e.PIXELFORMAT_DXT1_SRGB=54,e.PIXELFORMAT_DXT3=9,e.PIXELFORMAT_DXT3_SRGBA=55,e.PIXELFORMAT_DXT5=10,e.PIXELFORMAT_DXT5_SRGBA=56,e.PIXELFORMAT_ETC1=21,e.PIXELFORMAT_ETC2_RGB=22,e.PIXELFORMAT_ETC2_RGBA=23,e.PIXELFORMAT_ETC2_SRGB=61,e.PIXELFORMAT_ETC2_SRGBA=62,e.PIXELFORMAT_L8=1,e.PIXELFORMAT_L8_A8=2,e.PIXELFORMAT_LA8=2,e.PIXELFORMAT_PVRTC_2BPP_RGBA_1=25,e.PIXELFORMAT_PVRTC_2BPP_RGB_1=24,e.PIXELFORMAT_PVRTC_4BPP_RGBA_1=27,e.PIXELFORMAT_PVRTC_4BPP_RGB_1=26,e.PIXELFORMAT_R16F=50,e.PIXELFORMAT_R16I=34,e.PIXELFORMAT_R16U=35,e.PIXELFORMAT_R32F=15,e.PIXELFORMAT_R32I=36,e.PIXELFORMAT_R32U=37,e.PIXELFORMAT_R4_G4_B4_A4=5,e.PIXELFORMAT_R5_G5_B5_A1=4,e.PIXELFORMAT_R5_G6_B5=3,e.PIXELFORMAT_R8=52,e.PIXELFORMAT_R8I=32,e.PIXELFORMAT_R8U=33,e.PIXELFORMAT_R8_G8_B8=6,e.PIXELFORMAT_R8_G8_B8_A8=7,e.PIXELFORMAT_RG16F=51,e.PIXELFORMAT_RG16I=40,e.PIXELFORMAT_RG16U=41,e.PIXELFORMAT_RG32I=42,e.PIXELFORMAT_RG32U=43,e.PIXELFORMAT_RG8=53,e.PIXELFORMAT_RG8I=38,e.PIXELFORMAT_RG8U=39,e.PIXELFORMAT_RGB16F=11,e.PIXELFORMAT_RGB32F=13,e.PIXELFORMAT_RGB565=3,e.PIXELFORMAT_RGB8=6,e.PIXELFORMAT_RGBA16F=12,e.PIXELFORMAT_RGBA16I=46,e.PIXELFORMAT_RGBA16U=47,e.PIXELFORMAT_RGBA32F=14,e.PIXELFORMAT_RGBA32I=48,e.PIXELFORMAT_RGBA32U=49,e.PIXELFORMAT_RGBA4=5,e.PIXELFORMAT_RGBA5551=4,e.PIXELFORMAT_RGBA8=7,e.PIXELFORMAT_RGBA8I=44,e.PIXELFORMAT_RGBA8U=45,e.PIXELFORMAT_SBGRA8=64,e.PIXELFORMAT_SRGB=19,e.PIXELFORMAT_SRGB8=19,e.PIXELFORMAT_SRGBA=20,e.PIXELFORMAT_SRGBA8=20,e.PRIMITIVE_LINELOOP=2,e.PRIMITIVE_LINES=1,e.PRIMITIVE_LINESTRIP=3,e.PRIMITIVE_POINTS=0,e.PRIMITIVE_TRIANGLES=4,e.PRIMITIVE_TRIFAN=6,e.PRIMITIVE_TRISTRIP=5,e.PROJECTION_ORTHOGRAPHIC=1,e.PROJECTION_PERSPECTIVE=0,e.ParticleEmitter=h5,e.ParticleSystemComponent=mq,e.ParticleSystemComponentSystem=mQ,e.Picker=class{getSelection(e,t,s,i){ void 0===s&&(s=1),void 0===i&&(i=1);let n=this.device;if(n.isWebGPU)return [];t=this.renderTarget.height-(t+i);let r=this.sanitizeRect(e,t,s,i);n.setRenderTarget(this.renderTarget),n.updateBegin();let a=new Uint8Array(4*r.z*r.w);return n.readPixels(r.x,r.y,r.z,r.w,a),n.updateEnd(),this.decodePixels(a,this.mapping)}getSelectionAsync(e,t,s,i){var n;void 0===s&&(s=1),void 0===i&&(i=1),(null==(n=this.device)?void 0:n.isWebGL2)&&(t=this.renderTarget.height-(t+i));let r=this.sanitizeRect(e,t,s,i);return this.renderTarget.colorBuffer.read(r.x,r.y,r.z,r.w,{renderTarget:this.renderTarget,immediate:true}).then(e=>this.decodePixels(e,this.mapping))}sanitizeRect(e,t,s,i){let n=this.renderTarget.width,r=this.renderTarget.height;return e=ei.clamp(Math.floor(e),0,n-1),t=ei.clamp(Math.floor(t),0,r-1),s=Math.min(s=Math.floor(Math.max(s,1)),n-e),i=Math.min(i=Math.floor(Math.max(i,1)),r-t),xl.set(e,t,s,i)}decodePixels(e,t){let s=[];if(this.deviceValid){let i=e.length;for(let s=0;s<i;s+=4){let i=e[s+0],n=e[s+1],r=e[s+2],a=(e[s+3]<<24|i<<16|n<<8|r)>>>0;0xffffffff!==a&&xo.add(t.get(a));}xo.forEach(e=>{e&&s.push(e);}),xo.clear();}return s}allocateRenderTarget(){let e=new se(this.device,{format:7,width:this.width,height:this.height,mipmaps:false,minFilter:0,magFilter:0,addressU:1,addressV:1,name:"pick"});this.renderTarget=new sR({colorBuffer:e,depth:true});}releaseRenderTarget(){this.renderTarget&&(this.renderTarget.destroyTextureBuffers(),this.renderTarget.destroy(),this.renderTarget=null);}prepare(e,t,s){s instanceof l2&&(s=[s]),this.renderTarget&&this.width===this.renderTarget.width&&this.height===this.renderTarget.height||(this.releaseRenderTarget(),this.allocateRenderTarget()),this.mapping.clear();let i=this.renderPass;i.init(this.renderTarget),i.colorOps.clearValue=en.WHITE,i.colorOps.clear=true,i.depthStencilOps.clearDepth=true,i.update(e,t,s,this.mapping),i.render();}resize(e,t){this.width=Math.floor(e),this.height=Math.floor(t);}constructor(e,t,s){this.renderTarget=null,this.mapping=new Map,this.deviceValid=true,this.renderer=e.renderer,this.device=e.graphicsDevice,this.renderPass=new xa(this.device,e.renderer),this.width=0,this.height=0,this.resize(t,s),this.device.on("destroy",()=>{this.deviceValid=false;});}},e.Plane=eL,e.PlaneGeometry=cH,e.PostEffect=d8,e.PostEffectQueue=_1,e.ProgramLibrary=cX,e.QuadRender=aI,e.Quat=eT,e.REFLECTIONSRC_CUBEMAP=r3,e.REFLECTIONSRC_ENVATLAS=r1,e.REFLECTIONSRC_ENVATLASHQ=r2,e.REFLECTIONSRC_NONE=r0,e.REFLECTIONSRC_SPHEREMAP=r4,e.RENDERSTYLE_POINTS=2,e.RENDERSTYLE_SOLID=0,e.RENDERSTYLE_WIREFRAME=1,e.RESOLUTION_AUTO=ui,e.RESOLUTION_FIXED=un,e.RIGIDBODY_ACTIVE_TAG=1,e.RIGIDBODY_CF_KINEMATIC_OBJECT=2,e.RIGIDBODY_CF_NORESPONSE_OBJECT=4,e.RIGIDBODY_CF_STATIC_OBJECT=1,e.RIGIDBODY_DISABLE_DEACTIVATION=4,e.RIGIDBODY_DISABLE_SIMULATION=5,e.RIGIDBODY_ISLAND_SLEEPING=2,e.RIGIDBODY_TYPE_DYNAMIC=fS,e.RIGIDBODY_TYPE_KINEMATIC=fx,e.RIGIDBODY_TYPE_STATIC=fy,e.RIGIDBODY_WANTS_DEACTIVATION=3,e.Ray=eO,e.RaycastResult=_s,e.ReadStream=Z,e.RenderComponent=m1,e.RenderComponentSystem=m5,e.RenderHandler=gC,e.RenderPass=nK,e.RenderPassBloom=T5,e.RenderPassCameraFrame=bo,e.RenderPassColorGrab=a9,e.RenderPassCompose=T6,e.RenderPassDepthAwareBlur=bi,e.RenderPassDof=be,e.RenderPassDownsample=T3,e.RenderPassForward=lX,e.RenderPassPrepass=bs,e.RenderPassShaderQuad=d9,e.RenderPassSsao=bn,e.RenderPassTAA=T8,e.RenderPassUpsample=T4,e.RenderTarget=sR,e.ResourceHandler=uI,e.ResourceLoader=uL,e.RigidBodyComponent=_e,e.RigidBodyComponentSystem=_o,e.RotateGizmo=class extends bI{set xyzTubeRadius(e){this._setDiskProp("tubeRadius",e);}get xyzTubeRadius(){return this._shapes.x.tubeRadius}set xyzRingRadius(e){this._setDiskProp("ringRadius",e);}get xyzRingRadius(){return this._shapes.x.ringRadius}set faceTubeRadius(e){this._shapes.face.tubeRadius=e;}get faceTubeRadius(){return this._shapes.face.tubeRadius}set faceRingRadius(e){this._shapes.face.ringRadius=e;}get faceRingRadius(){return this._shapes.face.ringRadius}set ringTolerance(e){this._setDiskProp("tolerance",e),this._shapes.face.tolerance=e;}get ringTolerance(){return this._shapes.x.tolerance}_setDiskProp(e,t){this._shapes.x[e]=t,this._shapes.y[e]=t,this._shapes.z[e]=t;}_storeGuidePoints(){let e=this.root.getPosition(),t=this._selectedAxis===bd?this.faceRingRadius:this.xyzRingRadius;this._guideAngleStart.copy(this._selectionStartPoint).sub(e).normalize(),this._guideAngleStart.mulScalar(t),this._guideAngleEnd.copy(this._guideAngleStart);}_updateGuidePoints(e){let t=this._selectedAxis;t===bd?b3.copy(this.facing):(b3.set(0,0,0),b3[t]=1,this._rootStartRot.transformVector(b3,b3)),b9.setFromAxisAngle(b3,e),b9.transformVector(this._guideAngleStart,this._guideAngleEnd);}_drawGuideAngleLine(e,t,s,i){ void 0===i&&(i=this._guideColors[t]),b3.set(0,0,0),b4.copy(s).mulScalar(this._scale),this._app.drawLine(b3.add(e),b4.add(e),i,false,this._layer);}_getLookAtEulerAngles(e){return b3.set(0,0,0),b8.setLookAt(b3,e,eu.UP),b9.setFromMat4(b8),b9.getEulerAngles(b3),b3.x+=90,b3}_shapesLookAtCamera(){0===this._camera.projection?(this._shapes.face.entity.lookAt(this._camera.entity.getPosition()),this._shapes.face.entity.rotateLocal(90,0,0)):(b9.copy(this._camera.entity.getRotation()).getEulerAngles(b3),this._shapes.face.entity.setEulerAngles(b3),this._shapes.face.entity.rotateLocal(-90,0,0));let e=b3.copy(this.facing);b9.copy(this.root.getRotation()).invert().transformVector(e,e);let t=Math.atan2(e.z,e.y)*ei.RAD_TO_DEG;this._shapes.x.entity.setLocalEulerAngles(0,t-90,-90),t=Math.atan2(e.x,e.z)*ei.RAD_TO_DEG,this._shapes.y.entity.setLocalEulerAngles(0,t,0),t=Math.atan2(e.y,e.x)*ei.RAD_TO_DEG,this._shapes.z.entity.setLocalEulerAngles(90,0,t+90);}_drag(e){for(let t in this._shapes){let s=this._shapes[t];t===this._selectedAxis?s.drag(e):s.hide(e);}this.fire(bI.EVENT_RENDERUPDATE);}_storeNodeRotations(){let e=this.root.getPosition();for(let t=0;t<this.nodes.length;t++){let s=this.nodes[t];this._nodeLocalRotations.set(s,s.getLocalRotation().clone()),this._nodeRotations.set(s,s.getRotation().clone()),this._nodeOffsets.set(s,s.getPosition().clone().sub(e));}}_setNodeRotations(e,t){let s=this.root.getPosition(),i=e===bd;b9.setFromAxisAngle(this._dirFromAxis(e,b3),t);for(let e=0;e<this.nodes.length;e++){let t=this.nodes[e];if(i||this._coordSpace!==bl){let e=this._nodeRotations.get(t);if(!e)continue;let i=this._nodeOffsets.get(t);if(!i)continue;b3.copy(i),b9.transformVector(b3,b3),b7.copy(b9).mul(e),t.setEulerAngles(b7.getEulerAngles()),t.setPosition(b3.add(s));}else {let e=this._nodeLocalRotations.get(t);if(!e)continue;b7.copy(e).mul(b9),t.setLocalRotation(b7);}}this._coordSpace===bl&&this._updateRotation();}_screenToPoint(e,t){let s=this._camera.screenToWorld(e,t,1),i=this._selectedAxis,n=this._createRay(s),r=this._createPlane(i,i===bd,false),a=new eu;return r.intersectsRay(n,a),a}_calculateAngle(e,t,s){let i=this.root.getPosition(),n=this._selectedAxis,r=this._createPlane(n,n===bd,false),a=0,o=b4.copy(this.facing),l=r.normal.dot(o);return this.orbitRotation||Math.abs(l)>.9?(b3.sub2(e,i),b9.copy(this._camera.entity.getRotation()).invert().transformVector(b3,b3),a=Math.sign(l)*Math.atan2(b3.y,b3.x)*ei.RAD_TO_DEG):(b3.copy(i),b4.cross(r.normal,o).normalize().add(i),this._camera.worldToScreen(b3,b5),this._camera.worldToScreen(b4,b6),b3.sub2(b6,b5).normalize(),b4.set(t,s,0),a=b3.dot(b4)),a}constructor(e,t){super(e,t),this._shapes={z:new b2(this._device,{axis:"z",layers:[this._layer.id],shading:this._shading,rotation:new eu(90,0,90),defaultColor:this._meshColors.axis.z,hoverColor:this._meshColors.hover.z,sectorAngle:180}),x:new b2(this._device,{axis:"x",layers:[this._layer.id],shading:this._shading,rotation:new eu(0,0,-90),defaultColor:this._meshColors.axis.x,hoverColor:this._meshColors.hover.x,sectorAngle:180}),y:new b2(this._device,{axis:"y",layers:[this._layer.id],shading:this._shading,rotation:new eu(0,0,0),defaultColor:this._meshColors.axis.y,hoverColor:this._meshColors.hover.y,sectorAngle:180}),face:new b2(this._device,{axis:bd,layers:[this._layer.id],shading:this._shading,rotation:this._getLookAtEulerAngles(this._camera.entity.getPosition()),defaultColor:this._meshColors.axis.f,hoverColor:this._meshColors.hover.f,ringRadius:.55})},this._selectionStartAngle=0,this._nodeLocalRotations=new Map,this._nodeRotations=new Map,this._nodeOffsets=new Map,this._guideAngleStartColor=Ee.clone(),this._guideAngleStart=new eu,this._guideAngleEnd=new eu,this.snapIncrement=5,this.orbitRotation=false,this._createTransform(),this.on(bI.EVENT_TRANSFORMSTART,(e,t,s)=>{this._selectionStartAngle=this._calculateAngle(e,t,s),this._storeNodeRotations(),this._storeGuidePoints(),this._drag(true);}),this.on(bI.EVENT_TRANSFORMMOVE,(e,t,s)=>{let i=this._selectedAxis,n=this._calculateAngle(e,t,s)-this._selectionStartAngle;this.snap&&(n=Math.round(n/this.snapIncrement)*this.snapIncrement),this._setNodeRotations(i,n),this._updateGuidePoints(n);}),this.on(bI.EVENT_TRANSFORMEND,()=>{this._drag(false);}),this.on(bI.EVENT_NODESDETACH,()=>{this._nodeLocalRotations.clear(),this._nodeRotations.clear(),this._nodeOffsets.clear();}),this._app.on("prerender",()=>{if(this._shapesLookAtCamera(),this._dragging){let e=this.root.getPosition();this._drawGuideAngleLine(e,this._selectedAxis,this._guideAngleStart,this._guideAngleStartColor),this._drawGuideAngleLine(e,this._selectedAxis,this._guideAngleEnd);}});}},e.SAMPLETYPE_DEPTH=2,e.SAMPLETYPE_FLOAT=0,e.SAMPLETYPE_INT=3,e.SAMPLETYPE_UINT=4,e.SAMPLETYPE_UNFILTERABLE_FLOAT=1,e.SCALEMODE_BLEND=_h,e.SCALEMODE_NONE=_l,e.SCROLLBAR_VISIBILITY_SHOW_ALWAYS=0,e.SCROLLBAR_VISIBILITY_SHOW_WHEN_REQUIRED=1,e.SCROLL_MODE_BOUNCE=1,e.SCROLL_MODE_CLAMP=0,e.SCROLL_MODE_INFINITE=2,e.SEMANTIC_ATTR0=to,e.SEMANTIC_ATTR1=tl,e.SEMANTIC_ATTR10=tg,e.SEMANTIC_ATTR11=tv,e.SEMANTIC_ATTR12=ty,e.SEMANTIC_ATTR13=tS,e.SEMANTIC_ATTR14=tx,e.SEMANTIC_ATTR15=tT,e.SEMANTIC_ATTR2=th,e.SEMANTIC_ATTR3=td,e.SEMANTIC_ATTR4=tc,e.SEMANTIC_ATTR5=tu,e.SEMANTIC_ATTR6=tp,e.SEMANTIC_ATTR7=tf,e.SEMANTIC_ATTR8=tm,e.SEMANTIC_ATTR9=t_,e.SEMANTIC_BLENDINDICES=e6,e.SEMANTIC_BLENDWEIGHT=e5,e.SEMANTIC_COLOR=e8,e.SEMANTIC_NORMAL=e3,e.SEMANTIC_POSITION=e2,e.SEMANTIC_TANGENT=e4,e.SEMANTIC_TEXCOORD=e9,e.SEMANTIC_TEXCOORD0=e7,e.SEMANTIC_TEXCOORD1=te,e.SEMANTIC_TEXCOORD2=tt,e.SEMANTIC_TEXCOORD3=ts,e.SEMANTIC_TEXCOORD4=ti,e.SEMANTIC_TEXCOORD5=tn,e.SEMANTIC_TEXCOORD6=tr,e.SEMANTIC_TEXCOORD7=ta,e.SHADERDEF_BATCH=16384,e.SHADERDEF_DIRLM=128,e.SHADERDEF_INSTANCING=32,e.SHADERDEF_LM=64,e.SHADERDEF_LMAMBIENT=4096,e.SHADERDEF_MORPH_NORMAL=2048,e.SHADERDEF_MORPH_POSITION=1024,e.SHADERDEF_MORPH_TEXTURE_BASED_INT=8192,e.SHADERDEF_NOSHADOW=1,e.SHADERDEF_SCREENSPACE=256,e.SHADERDEF_SKIN=2,e.SHADERDEF_TANGENTS=512,e.SHADERDEF_UV0=4,e.SHADERDEF_UV1=8,e.SHADERDEF_VCOLOR=16,e.SHADERLANGUAGE_GLSL=tF,e.SHADERLANGUAGE_WGSL=tN,e.SHADERPASS_ALBEDO="debug_albedo",e.SHADERPASS_AO="debug_ao",e.SHADERPASS_EMISSION="debug_emission",e.SHADERPASS_FORWARD="forward",e.SHADERPASS_GLOSS="debug_gloss",e.SHADERPASS_LIGHTING="debug_lighting",e.SHADERPASS_METALNESS="debug_metalness",e.SHADERPASS_OPACITY="debug_opacity",e.SHADERPASS_SPECULARITY="debug_specularity",e.SHADERPASS_UV0="debug_uv0",e.SHADERPASS_WORLDNORMAL="debug_world_normal",e.SHADERSTAGE_COMPUTE=4,e.SHADERSTAGE_FRAGMENT=2,e.SHADERSTAGE_VERTEX=1,e.SHADERTAG_MATERIAL=1,e.SHADER_DEPTH=2,e.SHADER_FORWARD=0,e.SHADER_PICK=3,e.SHADER_PREPASS=1,e.SHADER_SHADOW=4,e.SHADOWUPDATE_NONE=0,e.SHADOWUPDATE_REALTIME=2,e.SHADOWUPDATE_THISFRAME=1,e.SHADOW_PCF1=5,e.SHADOW_PCF1_16F=7,e.SHADOW_PCF1_32F=5,e.SHADOW_PCF3=0,e.SHADOW_PCF3_16F=8,e.SHADOW_PCF3_32F=0,e.SHADOW_PCF5=4,e.SHADOW_PCF5_16F=9,e.SHADOW_PCF5_32F=4,e.SHADOW_PCSS_32F=6,e.SHADOW_VSM16=2,e.SHADOW_VSM32=3,e.SHADOW_VSM_16F=2,e.SHADOW_VSM_32F=3,e.SKYTYPE_BOX="box",e.SKYTYPE_DOME=as,e.SKYTYPE_INFINITE=at,e.SORTMODE_BACK2FRONT=3,e.SORTMODE_CUSTOM=5,e.SORTMODE_FRONT2BACK=4,e.SORTMODE_MANUAL=1,e.SORTMODE_MATERIALMESH=2,e.SORTMODE_NONE=0,e.SPECOCC_AO=1,e.SPECOCC_GLOSSDEPENDENT=2,e.SPECOCC_NONE=0,e.SPRITETYPE_ANIMATED=_z,e.SPRITETYPE_SIMPLE=_k,e.SPRITE_RENDERMODE_SIMPLE=0,e.SPRITE_RENDERMODE_SLICED=1,e.SPRITE_RENDERMODE_TILED=2,e.SSAOTYPE_COMBINE=T2,e.SSAOTYPE_LIGHTING=T1,e.SSAOTYPE_NONE=T0,e.STENCILOP_DECREMENT=5,e.STENCILOP_DECREMENTWRAP=6,e.STENCILOP_INCREMENT=3,e.STENCILOP_INCREMENTWRAP=4,e.STENCILOP_INVERT=7,e.STENCILOP_KEEP=0,e.STENCILOP_REPLACE=2,e.STENCILOP_ZERO=1,e.ScaleGizmo=class extends bI{set coordSpace(e){}get coordSpace(){return this._coordSpace}set uniform(e){this._useUniformScaling=null==e||e;}get uniform(){return this._useUniformScaling}set axisGap(e){this._setArrowProp("gap",e);}get axisGap(){return this._shapes.x.gap}set axisLineThickness(e){this._setArrowProp("lineThickness",e);}get axisLineThickness(){return this._shapes.x.lineThickness}set axisLineLength(e){this._setArrowProp("lineLength",e);}get axisLineLength(){return this._shapes.x.lineLength}set axisLineTolerance(e){this._setArrowProp("tolerance",e);}get axisLineTolerance(){return this._shapes.x.tolerance}set axisBoxSize(e){this._setArrowProp("boxSize",e);}get axisBoxSize(){return this._shapes.x.boxSize}set axisPlaneSize(e){this._setPlaneProp("size",e);}get axisPlaneSize(){return this._shapes.yz.size}set axisPlaneGap(e){this._setPlaneProp("gap",e);}get axisPlaneGap(){return this._shapes.yz.gap}set axisCenterSize(e){this._shapes.xyz.size=e;}get axisCenterSize(){return this._shapes.xyz.size}set axisCenterTolerance(e){this._shapes.xyz.tolerance=e;}get axisCenterTolerance(){return this._shapes.xyz.tolerance}_setArrowProp(e,t){this._shapes.x[e]=t,this._shapes.y[e]=t,this._shapes.z[e]=t;}_setPlaneProp(e,t){this._shapes.yz[e]=t,this._shapes.xz[e]=t,this._shapes.xy[e]=t;}_shapesLookAtCamera(){let e=this.facing,t=e.dot(this.root.right);this._shapes.x.entity.enabled=.98>Math.abs(t),this.flipShapes&&(this._shapes.x.flipped=t<0),t=e.dot(this.root.up),this._shapes.y.entity.enabled=.98>Math.abs(t),this.flipShapes&&(this._shapes.y.flipped=t<0),t=e.dot(this.root.forward),this._shapes.z.entity.enabled=.98>Math.abs(t),this.flipShapes&&(this._shapes.z.flipped=t>0),Ea.cross(e,this.root.right),this._shapes.yz.entity.enabled=.98>Ea.length(),this.flipShapes&&(this._shapes.yz.flipped=Eo.set(0,+(0>Ea.dot(this.root.forward)),+(0>Ea.dot(this.root.up)))),Ea.cross(e,this.root.forward),this._shapes.xy.entity.enabled=.98>Ea.length(),this.flipShapes&&(this._shapes.xy.flipped=Eo.set(+(0>Ea.dot(this.root.up)),+(Ea.dot(this.root.right)>0),0)),Ea.cross(e,this.root.up),this._shapes.xz.entity.enabled=.98>Ea.length(),this.flipShapes&&(this._shapes.xz.flipped=Eo.set(+(Ea.dot(this.root.forward)>0),0,+(Ea.dot(this.root.right)>0)));}_storeNodeScales(){for(let e=0;e<this.nodes.length;e++){let t=this.nodes[e];this._nodeScales.set(t,t.getLocalScale().clone());}}_setNodeScales(e){for(let t=0;t<this.nodes.length;t++){let s=this.nodes[t],i=this._nodeScales.get(s);i&&s.setLocalScale(Ea.copy(i).mul(e).max(this.lowerBoundScale));}}_screenToPoint(e,t){let s=this.root.getPosition(),i=this._camera.screenToWorld(e,t,1),n=this._selectedAxis,r=this._selectedIsPlane,a=this._useUniformScaling&&r||"xyz"===n,o=this._createRay(i),l=this._createPlane(n,a,!r),h=new eu;if(l.intersectsRay(o,h),a){switch(n){case "x":Ea.copy(this.root.up),Eo.copy(this.root.forward).mulScalar(-1);break;case "y":Ea.copy(this.root.right),Eo.copy(this.root.forward).mulScalar(-1);break;case "z":Ea.copy(this.root.up),Eo.copy(this.root.right);break;default:Ea.copy(this._camera.entity.up),Eo.copy(this._camera.entity.right);}Eo.add(Ea).normalize(),Ea.sub2(h,s);let e=Ea.length()*Ea.normalize().dot(Eo);return h.set(e,e,e),"xyz"!==n&&(h[n]=1),h}return Eh.copy(this._rootStartRot).invert().transformVector(h,h),r||this._projectToAxis(h,n),h}constructor(e,t){super(e,t),this._shapes={xyz:new Et(this._device,{axis:"xyz",layers:[this._layer.id],shading:this._shading,defaultColor:this._meshColors.axis.xyz,hoverColor:this._meshColors.hover.xyz}),yz:new bY(this._device,{axis:"x",layers:[this._layer.id],shading:this._shading,rotation:new eu(0,0,-90),defaultColor:this._meshColors.axis.x,hoverColor:this._meshColors.hover.x}),xz:new bY(this._device,{axis:"y",layers:[this._layer.id],shading:this._shading,rotation:new eu(0,0,0),defaultColor:this._meshColors.axis.y,hoverColor:this._meshColors.hover.y}),xy:new bY(this._device,{axis:"z",layers:[this._layer.id],shading:this._shading,rotation:new eu(90,0,0),defaultColor:this._meshColors.axis.z,hoverColor:this._meshColors.hover.z}),x:new Er(this._device,{axis:"x",layers:[this._layer.id],shading:this._shading,rotation:new eu(0,0,-90),defaultColor:this._meshColors.axis.x,hoverColor:this._meshColors.hover.x}),y:new Er(this._device,{axis:"y",layers:[this._layer.id],shading:this._shading,rotation:new eu(0,0,0),defaultColor:this._meshColors.axis.y,hoverColor:this._meshColors.hover.y}),z:new Er(this._device,{axis:"z",layers:[this._layer.id],shading:this._shading,rotation:new eu(90,0,0),defaultColor:this._meshColors.axis.z,hoverColor:this._meshColors.hover.z})},this._coordSpace=bl,this._nodeScales=new Map,this._useUniformScaling=false,this.snapIncrement=1,this.flipShapes=true,this.lowerBoundScale=new eu(-1/0,-1/0,-1/0),this._createTransform(),this.on(bI.EVENT_TRANSFORMSTART,()=>{this._storeNodeScales();}),this.on(bI.EVENT_TRANSFORMMOVE,e=>{let t=El.copy(e).sub(this._selectionStartPoint);this.snap&&(t.mulScalar(1/this.snapIncrement),t.round(),t.mulScalar(this.snapIncrement)),t.mulScalar(1/this._scale),this._setNodeScales(t.add(eu.ONE));}),this.on(bI.EVENT_NODESDETACH,()=>{this._nodeScales.clear();}),this._app.on("prerender",()=>{this._shapesLookAtCamera();});}},e.Scene=dK,e.SceneHandler=yO,e.SceneRegistry=uW,e.SceneRegistryItem=uH,e.SceneSettingsHandler=class extends uI{load(e,t){yS.load(e,this.maxRetries,t);}open(e,t){return t.settings}constructor(e){super(e,"scenesettings");}},e.ScopeId=s_,e.ScopeSpace=sg,e.ScreenComponent=_c,e.ScreenComponentSystem=_f,e.Script=gh,e.ScriptAttributes=ga,e.ScriptComponent=gf,e.ScriptComponentSystem=gg,e.ScriptHandler=yV,e.ScriptRegistry=uF,e.ScriptType=gu,e.ScrollViewComponent=_A,e.ScrollViewComponentSystem=_P,e.ScrollbarComponent=_M,e.ScrollbarComponentSystem=_L,e.Shader=ns,e.ShaderHandler=yG,e.ShaderMaterial=h9,e.ShaderPass=ax,e.SingleContactResult=_i,e.Skeleton=d5,e.Skin=dZ,e.SkinBatchInstance=aU,e.SkinInstance=aB,e.Sky=dc,e.SortedLoopArray=Q,e.Sound=rk,e.SoundComponent=_F,e.SoundComponentSystem=_U,e.SoundInstance=rz,e.SoundInstance3d=rV,e.SoundManager=rU,e.SoundSlot=_O,e.SphereGeometry=da,e.Sprite=d$,e.SpriteAnimationClip=_V,e.SpriteComponent=_Y,e.SpriteComponentSystem=_K,e.SpriteHandler=yX,e.StandardMaterial=cP,e.StandardMaterialOptions=ch,e.StencilParameters=sC,e.StorageBuffer=class{destroy(){let e=this.device,t=e.buffers.indexOf(this);-1!==t&&e.buffers.splice(t,1),this.adjustVramSizeTracking(e._vram,-this.byteSize),this.impl.destroy(e);}adjustVramSizeTracking(e,t){e.sb+=t;}read(e,t,s){return void 0===e&&(e=0),void 0===t&&(t=this.byteSize),void 0===s&&(s=null),this.impl.read(this.device,e,t,s)}write(e,t,s,i){ void 0===e&&(e=0),void 0===s&&(s=0),this.impl.write(this.device,e,t,s,i);}clear(e,t){ void 0===e&&(e=0),void 0===t&&(t=this.byteSize),this.impl.clear(this.device,e,t);}constructor(e,t,s=0){this.id=nZ++,this.device=e,this.byteSize=t,this.bufferUsage=s,this.impl=e.createBufferImpl(128|s),this.impl.allocate(e,t),this.device.buffers.push(this),this.adjustVramSizeTracking(e._vram,this.byteSize);}},e.TEXHINT_ASSET=2,e.TEXHINT_LIGHTMAP=3,e.TEXHINT_NONE=0,e.TEXHINT_SHADOWMAP=1,e.TEXPROPERTY_ADDRESS_U=4,e.TEXPROPERTY_ADDRESS_V=8,e.TEXPROPERTY_ADDRESS_W=16,e.TEXPROPERTY_ALL=255,e.TEXPROPERTY_ANISOTROPY=128,e.TEXPROPERTY_COMPARE_FUNC=64,e.TEXPROPERTY_COMPARE_ON_READ=32,e.TEXPROPERTY_MAG_FILTER=2,e.TEXPROPERTY_MIN_FILTER=1,e.TEXTUREDIMENSION_1D="1d",e.TEXTUREDIMENSION_2D="2d",e.TEXTUREDIMENSION_2D_ARRAY=tP,e.TEXTUREDIMENSION_3D="3d",e.TEXTUREDIMENSION_CUBE=tM,e.TEXTUREDIMENSION_CUBE_ARRAY=tI,e.TEXTURELOCK_NONE=0,e.TEXTURELOCK_READ=1,e.TEXTURELOCK_WRITE=2,e.TEXTUREPROJECTION_CUBE=tL,e.TEXTUREPROJECTION_EQUIRECT=tD,e.TEXTUREPROJECTION_NONE=tR,e.TEXTUREPROJECTION_OCTAHEDRAL=tO,e.TEXTURETYPE_DEFAULT=tb,e.TEXTURETYPE_RGBE=tA,e.TEXTURETYPE_RGBM=tE,e.TEXTURETYPE_RGBP=tw,e.TEXTURETYPE_SWIZZLEGGGR=tC,e.TONEMAP_ACES=3,e.TONEMAP_ACES2=4,e.TONEMAP_FILMIC=1,e.TONEMAP_HEJL=2,e.TONEMAP_LINEAR=0,e.TONEMAP_NEUTRAL=5,e.TONEMAP_NONE=6,e.TRACEID_BINDGROUPFORMAT_ALLOC="BindGroupFormatAlloc",e.TRACEID_BINDGROUP_ALLOC="BindGroupAlloc",e.TRACEID_COMPUTEPIPELINE_ALLOC="ComputePipelineAlloc",e.TRACEID_ELEMENT="Element",e.TRACEID_GPU_TIMINGS=E,e.TRACEID_PIPELINELAYOUT_ALLOC="PipelineLayoutAlloc",e.TRACEID_RENDERPIPELINE_ALLOC="RenderPipelineAlloc",e.TRACEID_RENDER_ACTION="RenderAction",e.TRACEID_RENDER_FRAME="RenderFrame",e.TRACEID_RENDER_FRAME_TIME="RenderFrameTime",e.TRACEID_RENDER_PASS="RenderPass",e.TRACEID_RENDER_PASS_DETAIL="RenderPassDetail",e.TRACEID_RENDER_QUEUE="RenderQueue",e.TRACEID_RENDER_TARGET_ALLOC="RenderTargetAlloc",e.TRACEID_SHADER_ALLOC="ShaderAlloc",e.TRACEID_SHADER_COMPILE="ShaderCompile",e.TRACEID_TEXTURES="Textures",e.TRACEID_TEXTURE_ALLOC="TextureAlloc",e.TRACEID_VRAM_IB="VRAM.Ib",e.TRACEID_VRAM_SB="VRAM.Sb",e.TRACEID_VRAM_TEXTURE="VRAM.Texture",e.TRACEID_VRAM_VB="VRAM.Vb",e.TYPE_FLOAT16=7,e.TYPE_FLOAT32=6,e.TYPE_INT16=2,e.TYPE_INT32=4,e.TYPE_INT8=0,e.TYPE_UINT16=3,e.TYPE_UINT32=5,e.TYPE_UINT8=1,e.Tags=J,e.Template=yY,e.TemplateHandler=yj,e.TextElement=f8,e.TextHandler=yq,e.Texture=se,e.TextureAtlas=d0,e.TextureAtlasHandler=yJ,e.TextureHandler=SS,e.TextureUtils=t9,e.TorusGeometry=cW,e.Touch=rC,e.TouchDevice=rM,e.TouchEvent=rP,e.Tracing=es,e.TransformFeedback=class{static createShader(e,t,s){return new ns(e,ne.createDefinition(e,{name:s,vertexCode:t,useTransformFeedback:true}))}destroy(){this._outputBuffer.destroy();}process(e,t){ void 0===t&&(t=true);let s=this.device,i=s.getRenderTarget();if(s.setRenderTarget(null),s.updateBegin(),s.setVertexBuffer(this._inputBuffer,0),s.setRaster(false),s.setTransformFeedbackBuffer(this._outputBuffer),s.setShader(e),s.draw({type:0,base:0,count:this._inputBuffer.numVertices,indexed:false}),s.setTransformFeedbackBuffer(null),s.setRaster(true),s.updateEnd(),s.setRenderTarget(i),t){let e=this._inputBuffer.impl.bufferId;this._inputBuffer.impl.bufferId=this._outputBuffer.impl.bufferId,this._outputBuffer.impl.bufferId=e,e=this._inputBuffer.impl.vao,this._inputBuffer.impl.vao=this._outputBuffer.impl.vao,this._outputBuffer.impl.vao=e;}}get inputBuffer(){return this._inputBuffer}get outputBuffer(){return this._outputBuffer}constructor(e,t=3){this.device=e.device;let s=this.device.gl;this._inputBuffer=e,3===t&&e.usage!==t&&(s.bindBuffer(s.ARRAY_BUFFER,e.impl.bufferId),s.bufferData(s.ARRAY_BUFFER,e.storage,s.DYNAMIC_COPY)),this._outputBuffer=new sy(e.device,e.format,e.numVertices,{usage:t,data:e.storage});}},e.TransformGizmo=bI,e.TranslateGizmo=class extends bI{set axisGap(e){this._setArrowProp("gap",e);}get axisGap(){return this._shapes.x.gap}set axisLineThickness(e){this._setArrowProp("lineThickness",e);}get axisLineThickness(){return this._shapes.x.lineThickness}set axisLineLength(e){this._setArrowProp("lineLength",e);}get axisLineLength(){return this._shapes.x.lineLength}set axisLineTolerance(e){this._setArrowProp("tolerance",e);}get axisLineTolerance(){return this._shapes.x.tolerance}set axisArrowThickness(e){this._setArrowProp("arrowThickness",e);}get axisArrowThickness(){return this._shapes.x.arrowThickness}set axisArrowLength(e){this._setArrowProp("arrowLength",e);}get axisArrowLength(){return this._shapes.x.arrowLength}set axisPlaneSize(e){this._setPlaneProp("size",e);}get axisPlaneSize(){return this._shapes.yz.size}set axisPlaneGap(e){this._setPlaneProp("gap",e);}get axisPlaneGap(){return this._shapes.yz.gap}set axisCenterSize(e){this._shapes.face.size=e;}get axisCenterSize(){return this._shapes.face.size}set axisCenterTolerance(e){this._shapes.face.tolerance=e;}get axisCenterTolerance(){return this._shapes.face.tolerance}_setArrowProp(e,t){this._shapes.x[e]=t,this._shapes.y[e]=t,this._shapes.z[e]=t;}_setPlaneProp(e,t){this._shapes.yz[e]=t,this._shapes.xz[e]=t,this._shapes.xy[e]=t;}_shapesLookAtCamera(){let e=this.facing,t=e.dot(this.root.right);this._shapes.x.entity.enabled=.98>Math.abs(t),this.flipShapes&&(this._shapes.x.flipped=t<0),t=e.dot(this.root.up),this._shapes.y.entity.enabled=.98>Math.abs(t),this.flipShapes&&(this._shapes.y.flipped=t<0),t=e.dot(this.root.forward),this._shapes.z.entity.enabled=.98>Math.abs(t),this.flipShapes&&(this._shapes.z.flipped=t>0),bJ.cross(e,this.root.right),this._shapes.yz.entity.enabled=.98>bJ.length(),this.flipShapes&&(this._shapes.yz.flipped=b$.set(0,+(0>bJ.dot(this.root.forward)),+(0>bJ.dot(this.root.up)))),bJ.cross(e,this.root.forward),this._shapes.xy.entity.enabled=.98>bJ.length(),this.flipShapes&&(this._shapes.xy.flipped=b$.set(+(0>bJ.dot(this.root.up)),+(bJ.dot(this.root.right)>0),0)),bJ.cross(e,this.root.up),this._shapes.xz.entity.enabled=.98>bJ.length(),this.flipShapes&&(this._shapes.xz.flipped=b$.set(+(bJ.dot(this.root.forward)>0),0,+(bJ.dot(this.root.right)>0)));}_storeNodePositions(){for(let e=0;e<this.nodes.length;e++){let t=this.nodes[e];this._nodeLocalPositions.set(t,t.getLocalPosition().clone()),this._nodePositions.set(t,t.getPosition().clone());}}_setNodePositions(e){for(let s=0;s<this.nodes.length;s++){let i=this.nodes[s];if(this._coordSpace===bl){var t;let s=this._nodeLocalPositions.get(i);if(!s)continue;bJ.copy(e),null==(t=i.parent)||t.getWorldTransform().getScale(b$),b$.x=1/b$.x,b$.y=1/b$.y,b$.z=1/b$.z,b1.copy(i.getLocalRotation()).transformVector(bJ,bJ),bJ.mul(b$),i.setLocalPosition(bJ.add(s));}else {let t=this._nodePositions.get(i);if(!t)continue;i.setPosition(bJ.copy(e).add(t));}}this._updatePosition();}_screenToPoint(e,t){let s=this._camera.screenToWorld(e,t,1),i=this._selectedAxis,n=this._selectedIsPlane,r=this._createRay(s),a=this._createPlane(i,i===bd,!n),o=new eu;return a.intersectsRay(r,o),b1.copy(this._rootStartRot).invert().transformVector(o,o),n||i===bd||this._projectToAxis(o,i),o}constructor(e,t){super(e,t),this._shapes={face:new bQ(this._device,{axis:bd,layers:[this._layer.id],shading:this._shading,defaultColor:this._meshColors.axis.xyz,hoverColor:this._meshColors.hover.xyz}),yz:new bY(this._device,{axis:"x",layers:[this._layer.id],shading:this._shading,rotation:new eu(0,0,-90),defaultColor:this._meshColors.axis.x,hoverColor:this._meshColors.hover.x}),xz:new bY(this._device,{axis:"y",layers:[this._layer.id],shading:this._shading,rotation:new eu(0,0,0),defaultColor:this._meshColors.axis.y,hoverColor:this._meshColors.hover.y}),xy:new bY(this._device,{axis:"z",layers:[this._layer.id],shading:this._shading,rotation:new eu(90,0,0),defaultColor:this._meshColors.axis.z,hoverColor:this._meshColors.hover.z}),x:new bZ(this._device,{axis:"x",layers:[this._layer.id],shading:this._shading,rotation:new eu(0,0,-90),defaultColor:this._meshColors.axis.x,hoverColor:this._meshColors.hover.x}),y:new bZ(this._device,{axis:"y",layers:[this._layer.id],shading:this._shading,rotation:new eu(0,0,0),defaultColor:this._meshColors.axis.y,hoverColor:this._meshColors.hover.y}),z:new bZ(this._device,{axis:"z",layers:[this._layer.id],shading:this._shading,rotation:new eu(90,0,0),defaultColor:this._meshColors.axis.z,hoverColor:this._meshColors.hover.z})},this._nodeLocalPositions=new Map,this._nodePositions=new Map,this.snapIncrement=1,this.flipShapes=true,this._createTransform(),this.on(bI.EVENT_TRANSFORMSTART,()=>{this._storeNodePositions();}),this.on(bI.EVENT_TRANSFORMMOVE,e=>{let t=b0.copy(e).sub(this._selectionStartPoint);this.snap&&(t.mulScalar(1/this.snapIncrement),t.round(),t.mulScalar(this.snapIncrement)),this._setNodePositions(t);}),this.on(bI.EVENT_NODESDETACH,()=>{this._nodeLocalPositions.clear(),this._nodePositions.clear();}),this._app.on("prerender",()=>{this._shapesLookAtCamera();});}},e.Tri=eW,e.UNIFORMTYPE_BOOL=0,e.UNIFORMTYPE_BOOLARRAY=32,e.UNIFORMTYPE_BVEC2=9,e.UNIFORMTYPE_BVEC2ARRAY=35,e.UNIFORMTYPE_BVEC3=10,e.UNIFORMTYPE_BVEC3ARRAY=38,e.UNIFORMTYPE_BVEC4=11,e.UNIFORMTYPE_BVEC4ARRAY=41,e.UNIFORMTYPE_FLOAT=2,e.UNIFORMTYPE_FLOATARRAY=17,e.UNIFORMTYPE_INT=1,e.UNIFORMTYPE_INTARRAY=30,e.UNIFORMTYPE_ITEXTURE2D=42,e.UNIFORMTYPE_ITEXTURE2D_ARRAY=48,e.UNIFORMTYPE_ITEXTURE3D=46,e.UNIFORMTYPE_ITEXTURECUBE=44,e.UNIFORMTYPE_IVEC2=6,e.UNIFORMTYPE_IVEC2ARRAY=33,e.UNIFORMTYPE_IVEC3=7,e.UNIFORMTYPE_IVEC3ARRAY=36,e.UNIFORMTYPE_IVEC4=8,e.UNIFORMTYPE_IVEC4ARRAY=39,e.UNIFORMTYPE_MAT2=12,e.UNIFORMTYPE_MAT3=13,e.UNIFORMTYPE_MAT4=14,e.UNIFORMTYPE_MAT4ARRAY=24,e.UNIFORMTYPE_TEXTURE2D=15,e.UNIFORMTYPE_TEXTURE2D_ARRAY=25,e.UNIFORMTYPE_TEXTURE2D_SHADOW=18,e.UNIFORMTYPE_TEXTURE3D=20,e.UNIFORMTYPE_TEXTURECUBE=16,e.UNIFORMTYPE_TEXTURECUBE_SHADOW=19,e.UNIFORMTYPE_UINT=26,e.UNIFORMTYPE_UINTARRAY=31,e.UNIFORMTYPE_UTEXTURE2D=43,e.UNIFORMTYPE_UTEXTURE2D_ARRAY=49,e.UNIFORMTYPE_UTEXTURE3D=47,e.UNIFORMTYPE_UTEXTURECUBE=45,e.UNIFORMTYPE_UVEC2=27,e.UNIFORMTYPE_UVEC2ARRAY=34,e.UNIFORMTYPE_UVEC3=28,e.UNIFORMTYPE_UVEC3ARRAY=37,e.UNIFORMTYPE_UVEC4=29,e.UNIFORMTYPE_UVEC4ARRAY=40,e.UNIFORMTYPE_VEC2=3,e.UNIFORMTYPE_VEC2ARRAY=21,e.UNIFORMTYPE_VEC3=4,e.UNIFORMTYPE_VEC3ARRAY=22,e.UNIFORMTYPE_VEC4=5,e.UNIFORMTYPE_VEC4ARRAY=23,e.UNIFORM_BUFFER_DEFAULT_SLOT_NAME=tY,e.UNUSED_UNIFORM_NAME=tj,e.URI=et,e.UniformBufferFormat=ir,e.UniformFormat=ii,e.UsdzExporter=class extends x4{init(){this.meshMap=new Map,this.textureMap=new Map,this.materialMap=new Map,this.materials=[],this.files={},this.nodeNames=new Set;}done(){this.meshMap=null,this.textureMap=null,this.materialMap=null,this.materials=null,this.files=null,this.nodeNames=null;}build(e,t){ void 0===t&&(t={}),this.init(),this.addFile(null,TV);let s=[];e&&e.findComponents("render").forEach(e=>{s.push(...e.meshInstances);});let i="";s.forEach(e=>{i+=this.buildMeshInstance(e);}),i+=TG(this.materials),this.addFile(null,TV,"",i);let n={maxTextureSize:t.maxTextureSize},r=Array.from(this.textureMap.keys()),a=[];for(let e=0;e<r.length;e++){let t=r[e],s=this.textureToCanvas(t,n).then(e=>e?new Promise(t=>e.toBlob(t,"image/png",1)).then(e=>e.arrayBuffer()):new Promise(e=>e(null)));a.push(s);}return Promise.all(a).then(e=>{e.forEach((e,t)=>{let s=r[t],i=this.getTextureFileIds(s);this.files[i.fileName]=new Uint8Array(e);}),this.alignFiles();let t=function(e,t){t||(t={});var s={},i=[];TO(e,"",s,t);var n=0,r=0;for(var a in s){var o=s[a],l=o[0],h=o[1],d=8*(0!=h.level),c=TB(a),u=c.length,p=h.comment,f=p&&TB(p),m=f&&f.length,_=TU(h.extra);u>65535&&Tg(11);var g=d?TR(l,h||{},0,0):l,v=g.length,y=TI();y.p(l),i.push(TL(h,{size:l.length,crc:y.d(),c:g,f:c,m:f,u:u!=a.length||f&&p.length!=m,o:n,compression:d})),n+=30+u+_+v,r+=76+2*(u+_)+(m||0)+v;}for(var S=new x5(r+22),x=n,T=r-n,b=0;b<i.length;++b){var c=i[b];Tk(S,c.o,c,c.f,c.u,c.c.length);var E=30+c.f.length+TU(c.extra);S.set(c.c,c.o+E),Tk(S,n,c,c.f,c.u,c.c.length,c.o,c.m),n+=16+E+(c.m?c.m.length:0);}return Tz(S,n,i.length,T,x),S}(this.files,{level:0});return this.done(),t})}alignFiles(){let e=0;for(let t in this.files){let s=this.files[t],i=63&(e+=34+t.length);if(4!==i){let e=new Uint8Array(64-i);this.files[t]=[s,{extra:{12345:e}}];}e=s.length;}}getFileIds(e,t,s,i){ void 0===i&&(i="usda");let n=(e?""+e+"/":"")+t+"."+i;return {name:t,fileName:n,refName:"@./"+n+"@</"+s+">"}}getTextureFileIds(e){return this.getFileIds("texture","Texture_"+e.id,"Texture","png")}addFile(e,t,s,i){ void 0===s&&(s=""),void 0===i&&(i="");let n=null;i&&(n=TB(i='#usda 1.0\n(\n    customLayerData = {\n        string creator = "PlayCanvas UsdzExporter"\n    }\n    metersPerUnit = 1\n    upAxis = "Y"\n)\n\n'+i));let r=this.getFileIds(e,t,s);return this.files[r.fileName]=n,r.refName}getMaterialRef(e){let t=this.materialMap.get(e);return t||(t=this.buildMaterial(e),this.materialMap.set(e,t)),t}getMeshRef(e){let t=this.meshMap.get(e);return t||(t=this.buildMesh(e),this.meshMap.set(e,t)),t}buildArray2(e){let t=[],s=e.length;for(let i=0;i<s;i+=2)t.push("("+e[i]+", "+(1-e[i+1])+")");return t.join(", ")}buildArray3(e){let t=[],s=e.length;for(let i=0;i<s;i+=3)t.push("("+e[i]+", "+e[i+1]+", "+e[i+2]+")");return t.join(", ")}buildMat4(e){let t=e.data,s=[];for(let e=0;e<16;e+=4)s.push("("+t[e]+", "+t[e+1]+", "+t[e+2]+", "+t[e+3]+")");return "( "+s.join(", ")+" )"}buildMaterial(e){let t="Material_"+e.id,s="/Materials/"+t,i=e=>"<"+s+e+">",n=(e,t,s,n,r,a,o,l)=>'\n                def Shader "Transform2d_'+s+'" (\n                    sdrMetadata = {\n                        string role = "math"\n                    }\n                )\n                {\n                    uniform token info:id = "UsdTransform2d"\n                    float2 inputs:in.connect = '+i("/uvReader_"+n+".outputs:result")+"\n                    float inputs:rotation = "+o+"\n                    float2 inputs:scale = ("+r.x+", "+r.y+")\n                    float2 inputs:translation = ("+a.x+", "+a.y+')\n                    float2 outputs:result\n                }\n\n                def Shader "Texture_'+e.id+"_"+s+'"\n                {\n                    uniform token info:id = "UsdUVTexture"\n                    asset inputs:file = @'+t.fileName+"@\n                    float2 inputs:st.connect = "+i("/Transform2d_"+s+".outputs:result")+'\n                    token inputs:wrapS = "repeat"\n                    token inputs:wrapT = "repeat"\n                    float4 inputs:scale = ('+l.r+", "+l.g+", "+l.b+", "+l.a+")\n                    float outputs:r\n                    float outputs:g\n                    float outputs:b\n                    float3 outputs:rgb\n                    float outputs:a\n                }\n            ",r=[],a=[],o=(t,s,o,l,h,d,c)=>{ void 0===d&&(d=false),void 0===c&&(c=false);let u=e[t];if(u){let p=this.getTextureFileIds(u);this.textureMap.set(u,p.refName);let f=e[""+t+"Channel"]||"rgb",m=i("/"+p.name+"_"+h+".outputs:"+f);r.push(TX(o,""+l+".connect",m)),d&&e.alphaTest;let _=e[""+t+"Tiling"],g=e[""+t+"Offset"],v=e[""+t+"Rotation"],y=1===e[""+t+"Uv"]?"st1":"st",S=c&&s?s:en.WHITE;a.push(n(u,p,h,y,_,g,v,S));}else if(s){let e="float"===o?""+s:"("+s.r+", "+s.g+", "+s.b+")";r.push(TX(o,l,e));}};o("diffuseMap",e.diffuse,"color3f","diffuseColor","diffuse",false,true),(e.transparent||e.alphaTest>0)&&o("opacityMap",e.opacity,"float","opacity","opacity",true),o("normalMap",null,"normal3f","normal","normal"),o("emissiveMap",e.emissive,"color3f","emissiveColor","emissive",false,true),o("aoMap",null,"float","occlusion","occlusion"),o("metalnessMap",e.metalness,"float","metallic","metallic"),o("glossMap",e.gloss,"float","roughness","roughness");let l='\n            def Material "'+t+'"\n            {\n                def Shader "PreviewSurface"\n                {\n                    uniform token info:id = "UsdPreviewSurface"\n'+r.join("\n")+"\n                    int inputs:useSpecularWorkflow = 0\n                    token outputs:surface\n                }\n\n                token outputs:surface.connect = "+i("/PreviewSurface.outputs:surface")+'\n\n                def Shader "uvReader_st"\n                {\n                    uniform token info:id = "UsdPrimvarReader_float2"\n                    token inputs:varname = "st"\n                    float2 inputs:fallback = (0.0, 0.0)\n                    float2 outputs:result\n                }\n\n                def Shader "uvReader_st1"\n                {\n                    uniform token info:id = "UsdPrimvarReader_float2"\n                    token inputs:varname = "st1"\n                    float2 inputs:fallback = (0.0, 0.0)\n                    float2 outputs:result\n                }\n\n                '+a.join("\n")+"\n            }\n        ";return this.materials.push(l),i("")}buildMesh(e){let t=[],s=[],i=[],n=[],r=[];e.getVertexStream(e2,t),e.getVertexStream(e3,i),e.getVertexStream(e7,n),e.getVertexStream(te,r),e.getIndices(s);let a=s.length||t.length,o=Array(a/3).fill(3).join(", ");if(!s.length)for(let e=0;e<a;e++)s[e]=e;let l=t.length/3;i=i.length?i:Array(3*l).fill(0),n=n.length?n:Array(2*l).fill(0),r=r.length?r:Array(2*l).fill(0),t=this.buildArray3(t),i=this.buildArray3(i);let h=TH(o,s,i,t,n=this.buildArray2(n),r=this.buildArray2(r));return this.addFile("mesh","Mesh_"+e.id,"Mesh",h)}buildMeshInstance(e){let t=this.getMeshRef(e.mesh),s=this.getMaterialRef(e.material),i=this.buildMat4(e.node.getWorldTransform()),n=e.node.name.replace(/[^a-z0-9]/gi,"_"),r=n;for(;this.nodeNames.has(r);)r=n+"_"+Math.random().toString(36).slice(2,7);return this.nodeNames.add(r),TW(r,t,i,s)}},e.VIEW_CENTER=0,e.VIEW_LEFT=1,e.VIEW_RIGHT=2,e.Vec2=ef,e.Vec3=eu,e.Vec4=em,e.VertexBuffer=sy,e.VertexFormat=sA,e.VertexIterator=re,e.ViewCube=Ef,e.WasmModule=K,e.WebglGraphicsDevice=nB,e.WebgpuGraphicsDevice=nS,e.WorldClusters=oG,e.XRDEPTHSENSINGFORMAT_F32=SI,e.XRDEPTHSENSINGFORMAT_L8A8=SP,e.XRDEPTHSENSINGFORMAT_R16U=SM,e.XRDEPTHSENSINGUSAGE_CPU=Sw,e.XRDEPTHSENSINGUSAGE_GPU=SC,e.XREYE_LEFT="left",e.XREYE_NONE="none",e.XREYE_RIGHT="right",e.XRHAND_LEFT=SA,e.XRHAND_NONE="none",e.XRHAND_RIGHT="right",e.XRPAD_A=4,e.XRPAD_B=5,e.XRPAD_SQUEEZE=1,e.XRPAD_STICK_BUTTON=3,e.XRPAD_STICK_X=2,e.XRPAD_STICK_Y=3,e.XRPAD_TOUCHPAD_BUTTON=2,e.XRPAD_TOUCHPAD_X=0,e.XRPAD_TOUCHPAD_Y=1,e.XRPAD_TRIGGER=0,e.XRSPACE_BOUNDEDFLOOR="bounded-floor",e.XRSPACE_LOCAL="local",e.XRSPACE_LOCALFLOOR="local-floor",e.XRSPACE_UNBOUNDED="unbounded",e.XRSPACE_VIEWER=SE,e.XRTARGETRAY_GAZE="gaze",e.XRTARGETRAY_POINTER="tracked-pointer",e.XRTARGETRAY_SCREEN="screen",e.XRTRACKABLE_MESH="mesh",e.XRTRACKABLE_PLANE="plane",e.XRTRACKABLE_POINT="point",e.XRTYPE_AR=Sb,e.XRTYPE_INLINE=Sx,e.XRTYPE_VR=ST,e.XrAnchor=S6,e.XrAnchors=S8,e.XrDomOverlay=SR,e.XrFinger=SU,e.XrHand=SY,e.XrHitTest=SF,e.XrHitTestSource=SO,e.XrImageTracking=SB,e.XrInput=SQ,e.XrInputSource=SZ,e.XrJoint=SV,e.XrLightEstimation=S2,e.XrManager=xs,e.XrMeshDetection=S7,e.XrPlane=S4,e.XrPlaneDetection=S5,e.XrTrackedImage=SN,e.XrView=xe,e.XrViews=xt,e.ZoneComponent=_Z,e.ZoneComponentSystem=_$,e.ambientSrcNames=r7,e.basisInitialize=y9,e.bindGroupNames=tX,e.blendNames=rG,e.calculateNormals=ds,e.calculateTangents=di,e.createBox=function(e,t){return aG.fromGeometry(e,new dr(t))},e.createCapsule=function(e,t){return aG.fromGeometry(e,new cz(t))},e.createCone=function(e,t){return aG.fromGeometry(e,new cV(t))},e.createCylinder=function(e,t){return aG.fromGeometry(e,new cG(t))},e.createGraphicsDevice=function(e,t){var s,i,r,a;void 0===t&&(t={});let o=null!=(s=t.deviceTypes)?s:[];o.includes(tV)||o.push(tV),o.includes(tH)||o.push(tH),k.browser&&navigator.xr&&(null!=(i=t).xrCompatible||(i.xrCompatible=true));let l=[];for(let s=0;s<o.length;s++){let i=o[s];i===tG&&(null==(a=window)?void 0:null==(r=a.navigator)?void 0:r.gpu)&&l.push(()=>new nS(e,t).initWebGpu(t.glslangUrl,t.twgslUrl)),i===tV&&l.push(()=>new nB(e,t)),i===tH&&l.push(()=>new nH(e,t));}return new Promise((e,t)=>{let s=0,i=()=>{s>=l.length?t(Error("Failed to create a graphics device")):Promise.resolve(l[s++]()).then(t=>{t?e(t):i();}).catch(e=>{i();});};i();})},e.createMesh=function(e,t,s){ void 0===s&&(s={});let i=new dn;return i.positions=t,i.normals=s.normals,i.tangents=s.tangents,i.colors=s.colors,i.uvs=s.uvs,i.uvs1=s.uvs1,i.blendIndices=s.blendIndices,i.blendWeights=s.blendWeights,i.indices=s.indices,aG.fromGeometry(e,i,s)},e.createPlane=function(e,t){return aG.fromGeometry(e,new cH(t))},e.createScript=yB,e.createShader=function(e,t,s,i,n){return void 0===i&&(i=false),void 0===n&&(n={}),"boolean"==typeof i?n.useTransformFeedback=i:"object"==typeof i&&(n=aT({},n,i)),new ns(e,ne.createDefinition(e,aT({},n,{name:t+"_"+s,vertexCode:am[t],fragmentCode:am[s]})))},e.createShaderFromCode=ab,e.createSphere=function(e,t){return aG.fromGeometry(e,new da(t))},e.createTorus=function(e,t){return aG.fromGeometry(e,new cW(t))},e.createURI=function(e){let t="";if((e.authority||e.scheme)&&(e.host||e.hostpath))throw Error("Can't have 'scheme' or 'authority' and 'host' or 'hostpath' option");if(e.host&&e.hostpath)throw Error("Can't have 'host' and 'hostpath' option");if(e.path&&e.hostpath)throw Error("Can't have 'path' and 'hostpath' option");return e.scheme&&(t+=""+e.scheme+":"),e.authority&&(t+="//"+e.authority),e.host&&(t+=e.host),e.path&&(t+=e.path),e.hostpath&&(t+=e.hostpath),e.query&&(t+="?"+e.query),e.fragment&&(t+="#"+e.fragment),t},e.cubemaProjectionNames=rZ,e.ditherNames=ao,e.dracoInitialize=e=>{(null==e?void 0:e.lazyInit)?_=e:gO(e);},e.drawFullscreenQuad=function(e,t,s,i,n){let r;if(n){let s=t?t.width:e.width,i=t?t.height:e.height;r=xV.set(n.x*s,n.y*i,n.z*s,n.w*i);}aD(e,t,i,r);},e.drawQuadWithShader=aD,e.extend=C,e.fresnelNames=rX,e.gammaNames=rQ,e.getPixelFormatArrayType=e1,e.getReservedScriptNames=function(){return yN},e.getTouchTargetCoords=rw,e.guid=P,e.http=rR,e.isCompressedPixelFormat=eK,e.isIntegerPixelFormat=eQ,e.isSrgbPixelFormat=eZ,e.lightFalloffNames=rq,e.lightShapeNames=rj,e.lightTypeNames=rY,e.math=ei,e.now=$,e.path=M,e.pixelFormatGammaToLinear=e$,e.pixelFormatInfo=eq,e.pixelFormatLinearToGamma=eJ,e.platform=k,e.reflectionSrcNames=r5,e.registerScript=yk,e.reprojectTexture=dz,e.requiresManualGamma=e0,e.revision=w,e.script=ua,e.semanticToLocation=tJ,e.shaderChunks=am,e.shaderChunksLightmapper=cY,e.shadowTypeInfo=rK,e.specularOcclusionNames=r$,e.spriteRenderModeNames=ae,e.string=W,e.tonemapNames=rJ,e.typedArrayIndexFormats=tZ,e.typedArrayIndexFormatsByteSize=tQ,e.typedArrayToType={Int8Array:0,Uint8Array:1,Int16Array:2,Uint16Array:3,Int32Array:4,Uint32Array:5,Float32Array:6},e.typedArrayTypes=tq,e.typedArrayTypesByteSize=tK,e.uniformTypeToName=tB,e.uniformTypeToNameMapWGSL=tk,e.uniformTypeToNameWGSL=tU,e.uniformTypeToStorage=tz,e.version=A,e.vertexTypesNames=["INT8","UINT8","INT16","UINT16","INT32","UINT32","FLOAT32","FLOAT16"];},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).pc={});
